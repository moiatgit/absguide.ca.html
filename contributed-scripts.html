

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>XXX Appendix A. Contributed Scripts &mdash; Guia Avançada de Programació Bash 10 març de 2014 documentació</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="copyright" title="Copyright" href="copyright.html"/>
    <link rel="top" title="Guia Avançada de Programació Bash 10 març de 2014 documentació" href="index.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        

        
          <a href="index.html" class="icon icon-home"> Guia Avançada de Programació Bash
        

        
        </a>

        
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Cercar..." />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

        
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
          
          
              <ul>
<li class="toctree-l1"><a class="reference internal" href="part1.html">Part 1. Introducció</a></li>
<li class="toctree-l1"><a class="reference internal" href="part2.html">Part 2. Conceptes bàsics</a></li>
<li class="toctree-l1"><a class="reference internal" href="part3.html">XXX Part 3. Beyond the Basics</a></li>
<li class="toctree-l1"><a class="reference internal" href="part4.html">XXX Part 4. Commands</a></li>
<li class="toctree-l1"><a class="reference internal" href="part5.html">XXX Part 5. Advanced Topics</a></li>
<li class="toctree-l1"><a class="reference internal" href="endnotes.html">Notes finals</a></li>
<li class="toctree-l1"><a class="reference internal" href="biblio.html">XXX  Bibliografia</a></li>
</ul>

          
        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="index.html">Guia Avançada de Programació Bash</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="index.html">Inici</a> &raquo;</li>
      
    <li>XXX  Appendix A. Contributed Scripts</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document">
            
  <div class="section" id="xxx-appendix-a-contributed-scripts">
<h1>XXX  Appendix A. Contributed Scripts<a class="headerlink" href="#xxx-appendix-a-contributed-scripts" title="Link permanent a aquest títol">¶</a></h1>
<p>These scripts, while not fitting into the text of this document, do
illustrate some interesting shell programming techniques. Some are
useful, too. Have fun analyzing and running them.</p>
<div class="section" id="exemple-1-mailformat-formatting-an-e-mail-message">
<h2>Exemple 1. <em>mailformat</em> : Formatting an e-mail message<a class="headerlink" href="#exemple-1-mailformat-formatting-an-e-mail-message" title="Link permanent a aquest títol">¶</a></h2>
<div class="highlight-sh"><div class="highlight"><pre><span class="c">#!/bin/bash</span>
<span class="c"># mail-format.sh (ver. 1.1): Format e-mail messages.</span>

<span class="c"># Gets rid of carets, tabs, and also folds excessively long lines.</span>

<span class="c"># =================================================================</span>
<span class="c">#                 Standard Check for Script Argument(s)</span>
<span class="nv">ARGS</span><span class="o">=</span>1
<span class="nv">E_BADARGS</span><span class="o">=</span>85
<span class="nv">E_NOFILE</span><span class="o">=</span>86

<span class="k">if</span> <span class="o">[</span> <span class="nv">$# </span>-ne <span class="nv">$ARGS</span> <span class="o">]</span>  <span class="c"># Correct number of arguments passed to script?</span>
<span class="k">then</span>
  <span class="nb">echo</span> <span class="s2">&quot;Usage: `basename </span><span class="nv">$0</span><span class="s2">` filename&quot;</span>
  <span class="nb">exit</span> <span class="nv">$E_BADARGS</span>
<span class="k">fi</span>

<span class="k">if</span> <span class="o">[</span> -f <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> <span class="o">]</span>       <span class="c"># Check if file exists.</span>
<span class="k">then</span>
    <span class="nv">file_name</span><span class="o">=</span><span class="nv">$1</span>
<span class="k">else</span>
    <span class="nb">echo</span> <span class="s2">&quot;File \&quot;</span><span class="nv">$1</span><span class="s2">\&quot; does not exist.&quot;</span>
    <span class="nb">exit</span> <span class="nv">$E_NOFILE</span>
<span class="k">fi</span>
<span class="c"># -----------------------------------------------------------------</span>

<span class="nv">MAXWIDTH</span><span class="o">=</span><span class="m">70</span>          <span class="c"># Width to fold excessively long lines to.</span>

<span class="c"># =================================</span>
<span class="c"># A variable can hold a sed script.</span>
<span class="c"># It&#39;s a useful technique.</span>
<span class="nv">sedscript</span><span class="o">=</span><span class="s1">&#39;s/^&gt;//</span>
<span class="s1">s/^  *&gt;//</span>
<span class="s1">s/^  *//</span>
<span class="s1">s/      *//&#39;</span>
<span class="c"># =================================</span>

<span class="c">#  Delete carets and tabs at beginning of lines,</span>
<span class="c">#+ then fold lines to $MAXWIDTH characters.</span>
sed <span class="s2">&quot;</span><span class="nv">$sedscript</span><span class="s2">&quot;</span> <span class="nv">$1fold</span> -s --width<span class="o">=</span><span class="nv">$MAXWIDTH</span>
                        <span class="c">#  -s option to &quot;fold&quot;</span>
                        <span class="c">#+ breaks lines at whitespace, if possible.</span>


<span class="c">#  This script was inspired by an article in a well-known trade journal</span>
<span class="c">#+ extolling a 164K MS Windows utility with similar functionality.</span>
<span class="c">#</span>
<span class="c">#  An nice set of text processing utilities and an efficient</span>
<span class="c">#+ scripting language provide an alternative to the bloated executables</span>
<span class="c">#+ of a clunky operating system.</span>

<span class="nb">exit</span> <span class="nv">$?</span>
</pre></div>
</div>
</div>
<div class="section" id="exemple-2-rn-a-simple-minded-file-renaming-utility">
<h2>Exemple 2. <em>rn</em> : A simple-minded file renaming utility<a class="headerlink" href="#exemple-2-rn-a-simple-minded-file-renaming-utility" title="Link permanent a aquest títol">¶</a></h2>
<p>This script is a modification of <a class="reference external" href="textproc.html#LOWERCASE">Example
16-22</a> .</p>
<div class="highlight-sh"><div class="highlight"><pre><span class="c">#! /bin/bash</span>
<span class="c"># rn.sh</span>

<span class="c"># Very simpleminded filename &quot;rename&quot; utility (based on &quot;lowercase.sh&quot;).</span>
<span class="c">#</span>
<span class="c">#  The &quot;ren&quot; utility, by Vladimir Lanin (lanin@csd2.nyu.edu),</span>
<span class="c">#+ does a much better job of this.</span>


<span class="nv">ARGS</span><span class="o">=</span>2
<span class="nv">E_BADARGS</span><span class="o">=</span>85
<span class="nv">ONE</span><span class="o">=</span><span class="m">1</span>                     <span class="c"># For getting singular/plural right (see below).</span>

<span class="k">if</span> <span class="o">[</span> <span class="nv">$# </span>-ne <span class="s2">&quot;</span><span class="nv">$ARGS</span><span class="s2">&quot;</span> <span class="o">]</span>
<span class="k">then</span>
  <span class="nb">echo</span> <span class="s2">&quot;Usage: `basename </span><span class="nv">$0</span><span class="s2">` old-pattern new-pattern&quot;</span>
  <span class="c"># As in &quot;rn gif jpg&quot;, which renames all gif files in working directory to jpg.</span>
  <span class="nb">exit</span> <span class="nv">$E_BADARGS</span>
<span class="k">fi</span>

<span class="nv">number</span><span class="o">=</span><span class="m">0</span>                  <span class="c"># Keeps track of how many files actually renamed.</span>


<span class="k">for</span> filename in *<span class="nv">$1</span>*      <span class="c">#Traverse all matching files in directory.</span>
<span class="k">do</span>
   <span class="k">if</span> <span class="o">[</span> -f <span class="s2">&quot;</span><span class="nv">$filename</span><span class="s2">&quot;</span> <span class="o">]</span>  <span class="c"># If finds match...</span>
   <span class="k">then</span>
     <span class="nv">fname</span><span class="o">=</span><span class="sb">`</span>basename <span class="nv">$filename</span><span class="sb">`</span>            <span class="c"># Strip off path.</span>
     <span class="nv">n</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$fnamesed</span> -e <span class="s2">&quot;s/</span><span class="nv">$1</span><span class="s2">/</span><span class="nv">$2</span><span class="s2">/&quot;</span><span class="sb">`</span>   <span class="c"># Substitute new for old in filename.</span>
     mv <span class="nv">$fname</span> <span class="nv">$n</span>                          <span class="c"># Rename.</span>
     <span class="nb">let</span> <span class="s2">&quot;number += 1&quot;</span>
   <span class="k">fi</span>
<span class="k">done</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$number</span><span class="s2">&quot;</span> -eq <span class="s2">&quot;</span><span class="nv">$ONE</span><span class="s2">&quot;</span> <span class="o">]</span>                <span class="c"># For correct grammar.</span>
<span class="k">then</span>
 <span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$number</span><span class="s2"> file renamed.&quot;</span>
<span class="k">else</span>
 <span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$number</span><span class="s2"> files renamed.&quot;</span>
<span class="k">fi</span>

<span class="nb">exit</span> <span class="nv">$?</span>


<span class="c"># Exercises:</span>
<span class="c"># ---------</span>
<span class="c"># What types of files will this not work on?</span>
<span class="c"># How can this be fixed?</span>
</pre></div>
</div>
</div>
<div class="section" id="exemple-3-blank-rename-renames-filenames-containing-blanks">
<h2>Exemple 3. <em>blank-rename</em> : Renames filenames containing blanks<a class="headerlink" href="#exemple-3-blank-rename-renames-filenames-containing-blanks" title="Link permanent a aquest títol">¶</a></h2>
<p>This is an even simpler-minded version of previous script.</p>
<div class="highlight-sh"><div class="highlight"><pre><span class="c">#! /bin/bash</span>
<span class="c"># blank-rename.sh</span>
<span class="c">#</span>
<span class="c"># Substitutes underscores for blanks in all the filenames in a directory.</span>

<span class="nv">ONE</span><span class="o">=</span><span class="m">1</span>                     <span class="c"># For getting singular/plural right (see below).</span>
<span class="nv">number</span><span class="o">=</span><span class="m">0</span>                  <span class="c"># Keeps track of how many files actually renamed.</span>
<span class="nv">FOUND</span><span class="o">=</span><span class="m">0</span>                   <span class="c"># Successful return value.</span>

<span class="k">for</span> filename in *         <span class="c">#Traverse all files in directory.</span>
<span class="k">do</span>
     <span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$filename</span><span class="s2">&quot;</span>grep -q <span class="s2">&quot; &quot;</span>         <span class="c">#  Check whether filename</span>
     <span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> -eq <span class="nv">$FOUND</span> <span class="o">]</span>                   <span class="c">#+ contains space(s).</span>
     <span class="k">then</span>
       <span class="nv">fname</span><span class="o">=</span><span class="nv">$filename</span>                      <span class="c"># Yes, this filename needs work.</span>
       <span class="nv">n</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$fnamesed</span> -e <span class="s2">&quot;s/ /_/g&quot;</span><span class="sb">`</span>   <span class="c"># Substitute underscore for blank.</span>
       mv <span class="s2">&quot;</span><span class="nv">$fname</span><span class="s2">&quot;</span> <span class="s2">&quot;</span><span class="nv">$n</span><span class="s2">&quot;</span>                     <span class="c"># Do the actual renaming.</span>
       <span class="nb">let</span> <span class="s2">&quot;number += 1&quot;</span>
     <span class="k">fi</span>
<span class="k">done</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$number</span><span class="s2">&quot;</span> -eq <span class="s2">&quot;</span><span class="nv">$ONE</span><span class="s2">&quot;</span> <span class="o">]</span>                 <span class="c"># For correct grammar.</span>
<span class="k">then</span>
 <span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$number</span><span class="s2"> file renamed.&quot;</span>
<span class="k">else</span>
 <span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$number</span><span class="s2"> files renamed.&quot;</span>
<span class="k">fi</span>

<span class="nb">exit </span>0
</pre></div>
</div>
</div>
<div class="section" id="exemple-4-encryptedpw-uploading-to-an-ftp-site-using-a-locally-encrypted-password">
<h2>Exemple 4. <em>encryptedpw</em> : Uploading to an ftp site, using a locally encrypted password<a class="headerlink" href="#exemple-4-encryptedpw-uploading-to-an-ftp-site-using-a-locally-encrypted-password" title="Link permanent a aquest títol">¶</a></h2>
<div class="highlight-sh"><div class="highlight"><pre><span class="c">#!/bin/bash</span>

<span class="c"># Example &quot;ex72.sh&quot; modified to use encrypted password.</span>

<span class="c">#  Note that this is still rather insecure,</span>
<span class="c">#+ since the decrypted password is sent in the clear.</span>
<span class="c">#  Use something like &quot;ssh&quot; if this is a concern.</span>

<span class="nv">E_BADARGS</span><span class="o">=</span>85

<span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> <span class="o">]</span>
<span class="k">then</span>
  <span class="nb">echo</span> <span class="s2">&quot;Usage: `basename </span><span class="nv">$0</span><span class="s2">` filename&quot;</span>
  <span class="nb">exit</span> <span class="nv">$E_BADARGS</span>
<span class="k">fi</span>

<span class="nv">Username</span><span class="o">=</span>bozo           <span class="c"># Change to suit.</span>
<span class="nv">pword</span><span class="o">=</span>/home/bozo/secret/password_encrypted.file
<span class="c"># File containing encrypted password.</span>

<span class="nv">Filename</span><span class="o">=</span><span class="sb">`</span>basename <span class="nv">$1</span><span class="sb">`</span>  <span class="c"># Strips pathname out of file name.</span>

<span class="nv">Server</span><span class="o">=</span><span class="s2">&quot;XXX&quot;</span>
<span class="nv">Directory</span><span class="o">=</span><span class="s2">&quot;YYY&quot;</span>         <span class="c"># Change above to actual server name &amp; directory.</span>


<span class="nv">Password</span><span class="o">=</span><span class="sb">`</span>cruft &lt;<span class="nv">$pword</span><span class="sb">`</span>          <span class="c"># Decrypt password.</span>
<span class="c">#  Uses the author&#39;s own &quot;cruft&quot; file encryption package,</span>
<span class="c">#+ based on the classic &quot;onetime pad&quot; algorithm,</span>
<span class="c">#+ and obtainable from:</span>
<span class="c">#+ Primary-site:   ftp://ibiblio.org/pub/Linux/utils/file</span>
<span class="c">#+                 cruft-0.2.tar.gz [16k]</span>


ftp -n <span class="nv">$Server</span> <span class="s">&lt;&lt;End-Of-Session</span>
<span class="s">user $Username $Password</span>
<span class="s">binary</span>
<span class="s">bell</span>
<span class="s">cd $Directory</span>
<span class="s">put $Filename</span>
<span class="s">bye</span>
<span class="s">End</span>-Of-Session
<span class="c"># -n option to &quot;ftp&quot; disables auto-logon.</span>
<span class="c"># Note that &quot;bell&quot; rings &#39;bell&#39; after each file transfer.</span>

<span class="nb">exit </span>0
</pre></div>
</div>
</div>
<div class="section" id="exemple-5-copy-cd-copying-a-data-cd">
<h2>Exemple 5. <em>copy-cd</em> : Copying a data CD<a class="headerlink" href="#exemple-5-copy-cd-copying-a-data-cd" title="Link permanent a aquest títol">¶</a></h2>
<div class="highlight-sh"><div class="highlight"><pre><span class="c">#!/bin/bash</span>
<span class="c"># copy-cd.sh: copying a data CD</span>

<span class="nv">CDROM</span><span class="o">=</span>/dev/cdrom                           <span class="c"># CD ROM device</span>
<span class="nv">OF</span><span class="o">=</span>/home/bozo/projects/cdimage.iso         <span class="c"># output file</span>
<span class="c">#       /xxxx/xxxxxxxx/                      Change to suit your system.</span>
<span class="nv">BLOCKSIZE</span><span class="o">=</span>2048
<span class="c"># SPEED=10                                 # If unspecified, uses max spd.</span>
<span class="c"># DEVICE=/dev/cdrom                          older version.</span>
<span class="nv">DEVICE</span><span class="o">=</span><span class="s2">&quot;1,0,0&quot;</span>

<span class="nb">echo</span><span class="p">;</span> <span class="nb">echo</span> <span class="s2">&quot;Insert source CD, but do *not* mount it.&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;Press ENTER when ready. &quot;</span>
<span class="nb">read </span>ready                                 <span class="c"># Wait for input, $ready not used.</span>

<span class="nb">echo</span><span class="p">;</span> <span class="nb">echo</span> <span class="s2">&quot;Copying the source CD to </span><span class="nv">$OF</span><span class="s2">.&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;This may take a while. Please be patient.&quot;</span>

dd <span class="k">if</span><span class="o">=</span><span class="nv">$CDROM</span> <span class="nv">of</span><span class="o">=</span><span class="nv">$OF</span> <span class="nv">bs</span><span class="o">=</span><span class="nv">$BLOCKSIZE</span>          <span class="c"># Raw device copy.</span>


<span class="nb">echo</span><span class="p">;</span> <span class="nb">echo</span> <span class="s2">&quot;Remove data CD.&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;Insert blank CDR.&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;Press ENTER when ready. &quot;</span>
<span class="nb">read </span>ready                                 <span class="c"># Wait for input, $ready not used.</span>

<span class="nb">echo</span> <span class="s2">&quot;Copying </span><span class="nv">$OF</span><span class="s2"> to CDR.&quot;</span>

<span class="c"># cdrecord -v -isosize speed=$SPEED dev=$DEVICE $OF   # Old version.</span>
wodim -v -isosize <span class="nv">dev</span><span class="o">=</span><span class="nv">$DEVICE</span> <span class="nv">$OF</span>
<span class="c"># Uses Joerg Schilling&#39;s &quot;cdrecord&quot; package (see its docs).</span>
<span class="c"># http://www.fokus.gmd.de/nthp/employees/schilling/cdrecord.html</span>
<span class="c"># Newer Linux distros may use &quot;wodim&quot; rather than &quot;cdrecord&quot; ...</span>


<span class="nb">echo</span><span class="p">;</span> <span class="nb">echo</span> <span class="s2">&quot;Done copying </span><span class="nv">$OF</span><span class="s2"> to CDR on device </span><span class="nv">$CDROM</span><span class="s2">.&quot;</span>

<span class="nb">echo</span> <span class="s2">&quot;Do you want to erase the image file (y/n)? &quot;</span>  <span class="c"># Probably a huge file.</span>
<span class="nb">read </span>answer

<span class="k">case</span> <span class="s2">&quot;</span><span class="nv">$answer</span><span class="s2">&quot;</span> in
<span class="o">[</span>yY<span class="o">])</span> rm -f <span class="nv">$OF</span>
      <span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$OF</span><span class="s2"> erased.&quot;</span>
      <span class="p">;;</span>
*<span class="o">)</span>    <span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$OF</span><span class="s2"> not erased.&quot;</span><span class="p">;;</span>
<span class="k">esac</span>

<span class="nb">echo</span>

<span class="c"># Exercise:</span>
<span class="c"># Change the above &quot;case&quot; statement to also accept &quot;yes&quot; and &quot;Yes&quot; as input.</span>

<span class="nb">exit </span>0
</pre></div>
</div>
</div>
<div class="section" id="exemple-6-collatz-series">
<h2>Exemple 6. Collatz series<a class="headerlink" href="#exemple-6-collatz-series" title="Link permanent a aquest títol">¶</a></h2>
<div class="highlight-sh"><div class="highlight"><pre><span class="c">#!/bin/bash</span>
<span class="c"># collatz.sh</span>

<span class="c">#  The notorious &quot;hailstone&quot; or Collatz series.</span>
<span class="c">#  -------------------------------------------</span>
<span class="c">#  1) Get the integer &quot;seed&quot; from the command-line.</span>
<span class="c">#  2) NUMBER &lt;-- seed</span>
<span class="c">#  3) Print NUMBER.</span>
<span class="c">#  4)  If NUMBER is even, divide by 2, or</span>
<span class="c">#  5)+ if odd, multiply by 3 and add 1.</span>
<span class="c">#  6) NUMBER &lt;-- result</span>
<span class="c">#  7) Loop back to step 3 (for specified number of iterations).</span>
<span class="c">#</span>
<span class="c">#  The theory is that every such sequence,</span>
<span class="c">#+ no matter how large the initial value,</span>
<span class="c">#+ eventually settles down to repeating &quot;4,2,1...&quot; cycles,</span>
<span class="c">#+ even after fluctuating through a wide range of values.</span>
<span class="c">#</span>
<span class="c">#  This is an instance of an &quot;iterate,&quot;</span>
<span class="c">#+ an operation that feeds its output back into its input.</span>
<span class="c">#  Sometimes the result is a &quot;chaotic&quot; series.</span>


<span class="nv">MAX_ITERATIONS</span><span class="o">=</span>200
<span class="c"># For large seed numbers (&gt;32000), try increasing MAX_ITERATIONS.</span>

<span class="nv">h</span><span class="o">=</span><span class="si">${</span><span class="nv">1</span><span class="k">:-</span><span class="nv">$$</span><span class="si">}</span>                      <span class="c">#  Seed.</span>
                                <span class="c">#  Use $PID as seed,</span>
                                <span class="c">#+ if not specified as command-line arg.</span>

<span class="nb">echo</span>
<span class="nb">echo</span> <span class="s2">&quot;C(</span><span class="nv">$h</span><span class="s2">) -*- </span><span class="nv">$MAX_ITERATIONS</span><span class="s2"> Iterations&quot;</span>
<span class="nb">echo</span>

<span class="k">for</span> <span class="o">((</span><span class="nv">i</span><span class="o">=</span>1<span class="p">;</span> i&lt;<span class="o">=</span>MAX_ITERATIONS<span class="p">;</span> i++<span class="o">))</span>
<span class="k">do</span>

<span class="c"># echo -n &quot;$h   &quot;</span>
<span class="c">#            ^^^</span>
<span class="c">#            tab</span>
<span class="c"># printf does it better ...</span>
<span class="nv">COLWIDTH</span><span class="o">=</span>%7d
<span class="nb">printf</span> <span class="nv">$COLWIDTH</span> <span class="nv">$h</span>

  <span class="nb">let</span> <span class="s2">&quot;remainder = h % 2&quot;</span>
  <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$remainder</span><span class="s2">&quot;</span> -eq <span class="m">0</span> <span class="o">]</span>   <span class="c"># Even?</span>
  <span class="k">then</span>
    <span class="nb">let</span> <span class="s2">&quot;h /= 2&quot;</span>              <span class="c"># Divide by 2.</span>
  <span class="k">else</span>
    <span class="nb">let</span> <span class="s2">&quot;h = h*3 + 1&quot;</span>         <span class="c"># Multiply by 3 and add 1.</span>
  <span class="k">fi</span>


<span class="nv">COLUMNS</span><span class="o">=</span><span class="m">10</span>                    <span class="c"># Output 10 values per line.</span>
<span class="nb">let</span> <span class="s2">&quot;line_break = i % </span><span class="nv">$COLUMNS</span><span class="s2">&quot;</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$line_break</span><span class="s2">&quot;</span> -eq <span class="m">0</span> <span class="o">]</span>
<span class="k">then</span>
  <span class="nb">echo</span>
<span class="k">fi</span>

<span class="k">done</span>

<span class="nb">echo</span>

<span class="c">#  For more information on this strange mathematical function,</span>
<span class="c">#+ see _Computers, Pattern, Chaos, and Beauty_, by Pickover, p. 185 ff.,</span>
<span class="c">#+ as listed in the bibliography.</span>

<span class="nb">exit </span>0
</pre></div>
</div>
</div>
<div class="section" id="exemple-7-days-between-days-between-two-dates">
<h2>Exemple 7. <em>days-between</em> : Days between two dates<a class="headerlink" href="#exemple-7-days-between-days-between-two-dates" title="Link permanent a aquest títol">¶</a></h2>
<div class="highlight-sh"><div class="highlight"><pre><span class="c">#!/bin/bash</span>
<span class="c"># days-between.sh:    Number of days between two dates.</span>
<span class="c"># Usage: ./days-between.sh [M]M/[D]D/YYYY [M]M/[D]D/YYYY</span>
<span class="c">#</span>
<span class="c"># Note: Script modified to account for changes in Bash, v. 2.05b +,</span>
<span class="c">#+      that closed the loophole permitting large negative</span>
<span class="c">#+      integer return values.</span>

<span class="nv">ARGS</span><span class="o">=</span><span class="m">2</span>                <span class="c"># Two command-line parameters expected.</span>
<span class="nv">E_PARAM_ERR</span><span class="o">=</span><span class="m">85</span>        <span class="c"># Param error.</span>

<span class="nv">REFYR</span><span class="o">=</span><span class="m">1600</span>            <span class="c"># Reference year.</span>
<span class="nv">CENTURY</span><span class="o">=</span>100
<span class="nv">DIY</span><span class="o">=</span>365
<span class="nv">ADJ_DIY</span><span class="o">=</span><span class="m">367</span>           <span class="c"># Adjusted for leap year + fraction.</span>
<span class="nv">MIY</span><span class="o">=</span>12
<span class="nv">DIM</span><span class="o">=</span>31
<span class="nv">LEAPCYCLE</span><span class="o">=</span>4

<span class="nv">MAXRETVAL</span><span class="o">=</span><span class="m">255</span>         <span class="c">#  Largest permissible</span>
                      <span class="c">#+ positive return value from a function.</span>

<span class="nv">diff</span><span class="o">=</span>                 <span class="c"># Declare global variable for date difference.</span>
<span class="nv">value</span><span class="o">=</span>                <span class="c"># Declare global variable for absolute value.</span>
<span class="nv">day</span><span class="o">=</span>                  <span class="c"># Declare globals for day, month, year.</span>
<span class="nv">month</span><span class="o">=</span>
<span class="nv">year</span><span class="o">=</span>


Param_Error <span class="o">()</span>        <span class="c"># Command-line parameters wrong.</span>
<span class="o">{</span>
  <span class="nb">echo</span> <span class="s2">&quot;Usage: `basename </span><span class="nv">$0</span><span class="s2">` [M]M/[D]D/YYYY [M]M/[D]D/YYYY&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot;       (date must be after 1/3/1600)&quot;</span>
  <span class="nb">exit</span> <span class="nv">$E_PARAM_ERR</span>
<span class="o">}</span>


Parse_Date <span class="o">()</span>                 <span class="c"># Parse date from command-line params.</span>
<span class="o">{</span>
  <span class="nv">month</span><span class="o">=</span><span class="si">${</span><span class="nv">1</span><span class="p">%%/**</span><span class="si">}</span>
  <span class="nv">dm</span><span class="o">=</span><span class="si">${</span><span class="nv">1</span><span class="p">%/**</span><span class="si">}</span>                 <span class="c"># Day and month.</span>
  <span class="nv">day</span><span class="o">=</span><span class="si">${</span><span class="nv">dm</span><span class="p">#*/</span><span class="si">}</span>
  <span class="nb">let</span> <span class="s2">&quot;year = `basename </span><span class="nv">$1</span><span class="s2">`&quot;</span>  <span class="c"># Not a filename, but works just the same.</span>
<span class="o">}</span>


check_date <span class="o">()</span>                 <span class="c"># Checks for invalid date(s) passed.</span>
<span class="o">{</span>
  <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$day</span><span class="s2">&quot;</span> -gt <span class="s2">&quot;</span><span class="nv">$DIM</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">|</span><span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$month</span><span class="s2">&quot;</span> -gt <span class="s2">&quot;</span><span class="nv">$MIY</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">|</span>
  <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$year</span><span class="s2">&quot;</span> -lt <span class="s2">&quot;</span><span class="nv">$REFYR</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> Param_Error
  <span class="c"># Exit script on bad value(s).</span>
  <span class="c"># Uses or-list / and-list.</span>
  <span class="c">#</span>
  <span class="c"># Exercise: Implement more rigorous date checking.</span>
<span class="o">}</span>


strip_leading_zero <span class="o">()</span> <span class="c">#  Better to strip possible leading zero(s)</span>
<span class="o">{</span>                     <span class="c">#+ from day and/or month</span>
  <span class="k">return</span> <span class="si">${</span><span class="nv">1</span><span class="p">#0</span><span class="si">}</span>       <span class="c">#+ since otherwise Bash will interpret them</span>
<span class="o">}</span>                     <span class="c">#+ as octal values (POSIX.2, sect 2.9.2.1).</span>


day_index <span class="o">()</span>          <span class="c"># Gauss&#39; Formula:</span>
<span class="o">{</span>                     <span class="c"># Days from March 1, 1600 to date passed as param.</span>
                      <span class="c">#           ^^^^^^^^^^^^^</span>
  <span class="nv">day</span><span class="o">=</span><span class="nv">$1</span>
  <span class="nv">month</span><span class="o">=</span><span class="nv">$2</span>
  <span class="nv">year</span><span class="o">=</span><span class="nv">$3</span>

  <span class="nb">let</span> <span class="s2">&quot;month = </span><span class="nv">$month</span><span class="s2"> - 2&quot;</span>
  <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$month</span><span class="s2">&quot;</span> -le <span class="m">0</span> <span class="o">]</span>
  <span class="k">then</span>
    <span class="nb">let</span> <span class="s2">&quot;month += 12&quot;</span>
    <span class="nb">let</span> <span class="s2">&quot;year -= 1&quot;</span>
  <span class="k">fi</span>

  <span class="nb">let</span> <span class="s2">&quot;year -= </span><span class="nv">$REFYR</span><span class="s2">&quot;</span>
  <span class="nb">let</span> <span class="s2">&quot;indexyr = </span><span class="nv">$year</span><span class="s2"> / </span><span class="nv">$CENTURY</span><span class="s2">&quot;</span>


  <span class="nb">let</span> <span class="s2">&quot;Days = </span><span class="nv">$DIY</span><span class="s2">*</span><span class="nv">$year</span><span class="s2"> + </span><span class="nv">$year</span><span class="s2">/</span><span class="nv">$LEAPCYCLE</span><span class="s2"> - </span><span class="nv">$indexyr</span><span class="s2"> \</span>
<span class="s2">              + </span><span class="nv">$indexyr</span><span class="s2">/</span><span class="nv">$LEAPCYCLE</span><span class="s2"> + </span><span class="nv">$ADJ_DIY</span><span class="s2">*</span><span class="nv">$month</span><span class="s2">/</span><span class="nv">$MIY</span><span class="s2"> + </span><span class="nv">$day</span><span class="s2"> - </span><span class="nv">$DIM</span><span class="s2">&quot;</span>
  <span class="c">#  For an in-depth explanation of this algorithm, see</span>
  <span class="c">#+   http://weblogs.asp.net/pgreborio/archive/2005/01/06/347968.aspx</span>


  <span class="nb">echo</span> <span class="nv">$Days</span>

<span class="o">}</span>


calculate_difference <span class="o">()</span>            <span class="c"># Difference between two day indices.</span>
<span class="o">{</span>
  <span class="nb">let</span> <span class="s2">&quot;diff = </span><span class="nv">$1</span><span class="s2"> - </span><span class="nv">$2</span><span class="s2">&quot;</span>             <span class="c"># Global variable.</span>
<span class="o">}</span>


abs <span class="o">()</span>                             <span class="c">#  Absolute value</span>
<span class="o">{</span>                                  <span class="c">#  Uses global &quot;value&quot; variable.</span>
  <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> -lt <span class="m">0</span> <span class="o">]</span>                <span class="c">#  If negative</span>
  <span class="k">then</span>                             <span class="c">#+ then</span>
    <span class="nb">let</span> <span class="s2">&quot;value = 0 - </span><span class="nv">$1</span><span class="s2">&quot;</span>           <span class="c">#+ change sign,</span>
  <span class="k">else</span>                             <span class="c">#+ else</span>
    <span class="nb">let</span> <span class="s2">&quot;value = </span><span class="nv">$1</span><span class="s2">&quot;</span>               <span class="c">#+ leave it alone.</span>
  <span class="k">fi</span>
<span class="o">}</span>



<span class="k">if</span> <span class="o">[</span> <span class="nv">$# </span>-ne <span class="s2">&quot;</span><span class="nv">$ARGS</span><span class="s2">&quot;</span> <span class="o">]</span>              <span class="c"># Require two command-line params.</span>
<span class="k">then</span>
  Param_Error
<span class="k">fi</span>

Parse_Date <span class="nv">$1</span>
check_date <span class="nv">$day</span> <span class="nv">$month</span> <span class="nv">$year</span>       <span class="c">#  See if valid date.</span>

strip_leading_zero <span class="nv">$day</span>            <span class="c">#  Remove any leading zeroes</span>
<span class="nv">day</span><span class="o">=</span><span class="nv">$?</span>                             <span class="c">#+ on day and/or month.</span>
strip_leading_zero <span class="nv">$month</span>
<span class="nv">month</span><span class="o">=</span><span class="nv">$?</span>

<span class="nb">let</span> <span class="s2">&quot;date1 = `day_index </span><span class="nv">$day</span><span class="s2"> </span><span class="nv">$month</span><span class="s2"> </span><span class="nv">$year</span><span class="s2">`&quot;</span>


Parse_Date <span class="nv">$2</span>
check_date <span class="nv">$day</span> <span class="nv">$month</span> <span class="nv">$year</span>

strip_leading_zero <span class="nv">$day</span>
<span class="nv">day</span><span class="o">=</span><span class="nv">$?</span>
strip_leading_zero <span class="nv">$month</span>
<span class="nv">month</span><span class="o">=</span><span class="nv">$?</span>

<span class="nv">date2</span><span class="o">=</span><span class="k">$(</span>day_index <span class="nv">$day</span> <span class="nv">$month</span> <span class="nv">$year</span><span class="k">)</span> <span class="c"># Command substitution.</span>


calculate_difference <span class="nv">$date1</span> <span class="nv">$date2</span>

abs <span class="nv">$diff</span>                            <span class="c"># Make sure it&#39;s positive.</span>
<span class="nv">diff</span><span class="o">=</span><span class="nv">$value</span>

<span class="nb">echo</span> <span class="nv">$diff</span>

<span class="nb">exit </span>0

<span class="c">#  Exercise:</span>
<span class="c">#  --------</span>
<span class="c">#  If given only one command-line parameter, have the script</span>
<span class="c">#+ use today&#39;s date as the second.</span>


<span class="c">#  Compare this script with</span>
<span class="c">#+ the implementation of Gauss&#39; Formula in a C program at</span>
<span class="c">#+    http://buschencrew.hypermart.net/software/datedif</span>
</pre></div>
</div>
</div>
<div class="section" id="exemple-8-making-a-dictionary">
<h2>Exemple 8. Making a <em>dictionary</em><a class="headerlink" href="#exemple-8-making-a-dictionary" title="Link permanent a aquest títol">¶</a></h2>
<div class="highlight-sh"><div class="highlight"><pre><span class="c">#!/bin/bash</span>
<span class="c"># makedict.sh  [make dictionary]</span>

<span class="c"># Modification of /usr/sbin/mkdict (/usr/sbin/cracklib-forman) script.</span>
<span class="c"># Original script copyright 1993, by Alec Muffett.</span>
<span class="c">#</span>
<span class="c">#  This modified script included in this document in a manner</span>
<span class="c">#+ consistent with the &quot;LICENSE&quot; document of the &quot;Crack&quot; package</span>
<span class="c">#+ that the original script is a part of.</span>

<span class="c">#  This script processes text files to produce a sorted list</span>
<span class="c">#+ of words found in the files.</span>
<span class="c">#  This may be useful for compiling dictionaries</span>
<span class="c">#+ and for other lexicographic purposes.</span>


<span class="nv">E_BADARGS</span><span class="o">=</span>85

<span class="k">if</span> <span class="o">[</span> ! -r <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> <span class="o">]</span>                    <span class="c">#  Need at least one</span>
<span class="k">then</span>                                <span class="c">#+ valid file argument.</span>
  <span class="nb">echo</span> <span class="s2">&quot;Usage: </span><span class="nv">$0</span><span class="s2"> files-to-process&quot;</span>
  <span class="nb">exit</span> <span class="nv">$E_BADARGS</span>
<span class="k">fi</span>


<span class="c"># SORT=&quot;sort&quot;                       #  No longer necessary to define</span>
                                    <span class="c">#+ options to sort. Changed from</span>
                                    <span class="c">#+ original script.</span>

cat <span class="nv">$*</span>                           <span class="c">#  Dump specified files to stdout.</span>
        tr A-Z a-z               <span class="c">#  Convert to lowercase.</span>
        tr <span class="s1">&#39; &#39;</span> <span class="s1">&#39;\012&#39;</span>            <span class="c">#  New: change spaces to newlines.</span>
<span class="c">#       tr -cd &#39;\012[a-z][0-9]&#39;  #  Get rid of everything</span>
                                    <span class="c">#+ non-alphanumeric (in orig. script).</span>
        tr -c <span class="s1">&#39;\012a-z&#39;</span>  <span class="s1">&#39;\012&#39;</span>  <span class="c">#  Rather than deleting non-alpha</span>
                                    <span class="c">#+ chars, change them to newlines.</span>
        sort                     <span class="c">#  $SORT options unnecessary now.</span>
        uniq                     <span class="c">#  Remove duplicates.</span>
        grep -v <span class="s1">&#39;^#&#39;</span>             <span class="c">#  Delete lines starting with #.</span>
        grep -v <span class="s1">&#39;^$&#39;</span>                <span class="c">#  Delete blank lines.</span>

<span class="nb">exit</span> <span class="nv">$?</span>
</pre></div>
</div>
</div>
<div class="section" id="exemple-9-soundex-conversion">
<h2>Exemple 9. Soundex conversion<a class="headerlink" href="#exemple-9-soundex-conversion" title="Link permanent a aquest títol">¶</a></h2>
<div class="highlight-sh"><div class="highlight"><pre><span class="c">#!/bin/bash</span>
<span class="c"># soundex.sh: Calculate &quot;soundex&quot; code for names</span>

<span class="c"># =======================================================</span>
<span class="c">#        Soundex script</span>
<span class="c">#              by</span>
<span class="c">#         Mendel Cooper</span>
<span class="c">#     thegrendel.abs@gmail.com</span>
<span class="c">#     reldate: 23 January, 2002</span>
<span class="c">#</span>
<span class="c">#   Placed in the Public Domain.</span>
<span class="c">#</span>
<span class="c"># A slightly different version of this script appeared in</span>
<span class="c">#+ Ed Schaefer&#39;s July, 2002 &quot;Shell Corner&quot; column</span>
<span class="c">#+ in &quot;Unix Review&quot; on-line,</span>
<span class="c">#+ http://www.unixreview.com/documents/uni1026336632258/</span>
<span class="c"># =======================================================</span>


<span class="nv">ARGCOUNT</span><span class="o">=</span><span class="m">1</span>                     <span class="c"># Need name as argument.</span>
<span class="nv">E_WRONGARGS</span><span class="o">=</span>90

<span class="k">if</span> <span class="o">[</span> <span class="nv">$# </span>-ne <span class="s2">&quot;</span><span class="nv">$ARGCOUNT</span><span class="s2">&quot;</span> <span class="o">]</span>
<span class="k">then</span>
  <span class="nb">echo</span> <span class="s2">&quot;Usage: `basename </span><span class="nv">$0</span><span class="s2">` name&quot;</span>
  <span class="nb">exit</span> <span class="nv">$E_WRONGARGS</span>
<span class="k">fi</span>


assign_value <span class="o">()</span>                <span class="c">#  Assigns numerical value</span>
<span class="o">{</span>                              <span class="c">#+ to letters of name.</span>

  <span class="nv">val1</span><span class="o">=</span>bfpv                    <span class="c"># &#39;b,f,p,v&#39; = 1</span>
  <span class="nv">val2</span><span class="o">=</span>cgjkqsxz                <span class="c"># &#39;c,g,j,k,q,s,x,z&#39; = 2</span>
  <span class="nv">val3</span><span class="o">=</span>dt                      <span class="c">#  etc.</span>
  <span class="nv">val4</span><span class="o">=</span>l
  <span class="nv">val5</span><span class="o">=</span>mn
  <span class="nv">val6</span><span class="o">=</span>r

<span class="c"># Exceptionally clever use of &#39;tr&#39; follows.</span>
<span class="c"># Try to figure out what is going on here.</span>

<span class="nv">value</span><span class="o">=</span><span class="k">$(</span> <span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> <span class="se">\</span>
</pre></div>
</div>
<p>tr -d wh tr $val1 1 | tr $val2 2 | tr $val3 3 tr $val4 4 | tr $val5 5 | tr $val6 6 tr -s 123456 tr -d aeiouy )</p>
<blockquote>
<div><p># Assign letter values.
# Remove duplicate numbers, except when separated by vowels.
# Ignore vowels, except as separators, so delete them last.
# Ignore &#8216;w&#8217; and &#8216;h&#8217;, even as separators, so delete them first.
#
# The above command substitution lays more pipe than a plumber &lt;g&gt;.</p>
<p>}</p>
<p>input_name=&#8221;$1&#8221;
echo
echo &#8220;Name = $input_name&#8221;</p>
<p># Change all characters of name input to lowercase.
# &#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;
name=$( echo $input_nametr A-Z a-z )
# &#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;
# Just in case argument to script is mixed case.</p>
<p># Prefix of soundex code: first letter of name.
# &#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8211;</p>
<p>char_pos=0                     # Initialize character position.
prefix0=${name:$char_pos:1}
prefix=`echo $prefix0tr a-z A-Z`</p>
<blockquote>
<div># Uppercase 1st letter of soundex.</div></blockquote>
<p>let &#8220;char_pos += 1&#8221;            # Bump character position to 2nd letter of name.
name1=${name:$char_pos}</p>
<p># ++++++++++++++++++++++++++ Exception Patch ++++++++++++++++++++++++++++++
#  Now, we run both the input name and the name shifted one char
#+ to the right through the value-assigning function.
#  If we get the same value out, that means that the first two characters
#+ of the name have the same value assigned, and that one should cancel.
#  However, we also need to test whether the first letter of the name
#+ is a vowel or &#8216;w&#8217; or &#8216;h&#8217;, because otherwise this would bollix things up.</p>
<p>char1=`echo $prefixtr A-Z a-z`    # First letter of name, lowercased.</p>
<p>assign_value $name
s1=$value
assign_value $name1
s2=$value
assign_value $char1
s3=$value
s3=9$s3                              #  If first letter of name is a vowel</p>
<blockquote>
<div><blockquote>
<div>#+ or &#8216;w&#8217; or &#8216;h&#8217;,
#+ then its &#8220;value&#8221; will be null (unset).</div></blockquote>
<p>#+ Therefore, set it to 9, an otherwise
#+ unused value, which can be tested for.</p>
</div></blockquote>
<p>if [[ &#8220;$s1&#8221; -ne &#8220;$s2&#8221; <a href="#id1"><span class="problematic" id="id2">|</span></a>&#8220;$s3&#8221; -eq 9 ]]
then</p>
<blockquote>
<div>suffix=$s2</div></blockquote>
<dl class="docutils">
<dt>else</dt>
<dd>suffix=${s2:$char_pos}</dd>
</dl>
<p>fi
# ++++++++++++++++++++++ end Exception Patch ++++++++++++++++++++++++++++++</p>
<p>padding=000                    # Use at most 3 zeroes to pad.</p>
<p>soun=$prefix$suffix$padding    # Pad with zeroes.</p>
<p>MAXLEN=4                       # Truncate to maximum of 4 chars.
soundex=${soun:0:$MAXLEN}</p>
<p>echo &#8220;Soundex = $soundex&#8221;</p>
<p>echo</p>
<p>#  The soundex code is a method of indexing and classifying names
#+ by grouping together the ones that sound alike.
#  The soundex code for a given name is the first letter of the name,
#+ followed by a calculated three-number code.
#  Similar sounding names should have almost the same soundex codes.</p>
<p>#   Examples:
#   Smith and Smythe both have a &#8220;S-530&#8221; soundex.
#   Harrison = H-625
#   Hargison = H-622
#   Harriman = H-655</p>
<p>#  This works out fairly well in practice, but there are numerous anomalies.
#
#
#  The U.S. Census and certain other governmental agencies use soundex,
#  as do genealogical researchers.
#
#  For more information,
#+ see the &#8220;National Archives and Records Administration home page&#8221;,
#+ <a class="reference external" href="http://www.nara.gov/genealogy/soundex/soundex.html">http://www.nara.gov/genealogy/soundex/soundex.html</a></p>
<p># Exercise:
# &#8212;&#8212;&#8211;
# Simplify the &#8220;Exception Patch&#8221; section of this script.</p>
<p>exit 0</p>
</div></blockquote>
</div>
<div class="section" id="exemple-10-game-of-life">
<h2>Exemple 10. <em>Game of Life</em><a class="headerlink" href="#exemple-10-game-of-life" title="Link permanent a aquest títol">¶</a></h2>
<div class="highlight-sh"><div class="highlight"><pre><span class="c">#!/bin/bash</span>
<span class="c"># life.sh: &quot;Life in the Slow Lane&quot;</span>
<span class="c"># Author: Mendel Cooper</span>
<span class="c"># License: GPL3</span>

<span class="c"># Version 0.2:   Patched by Daniel Albers</span>
<span class="c">#+               to allow non-square grids as input.</span>
<span class="c"># Version 0.2.1: Added 2-second delay between generations.</span>

<span class="c"># ##################################################################### #</span>
<span class="c"># This is the Bash script version of John Conway&#39;s &quot;Game of Life&quot;.      #</span>
<span class="c"># &quot;Life&quot; is a simple implementation of cellular automata.               #</span>
<span class="c"># --------------------------------------------------------------------- #</span>
<span class="c"># On a rectangular grid, let each &quot;cell&quot; be either &quot;living&quot; or &quot;dead.&quot;  #</span>
<span class="c"># Designate a living cell with a dot, and a dead one with a blank space.#</span>
<span class="c">#      Begin with an arbitrarily drawn dot-and-blank grid,              #</span>
<span class="c">#+     and let this be the starting generation: generation 0.           #</span>
<span class="c"># Determine each successive generation by the following rules:          #</span>
<span class="c">#   1) Each cell has 8 neighbors, the adjoining cells                   #</span>
<span class="c">#+     left, right, top, bottom, and the 4 diagonals.                   #</span>
<span class="c">#                                                                       #</span>
<span class="c">#                       123                                             #</span>
<span class="c">#                       4*5     The * is the cell under consideration.  #</span>
<span class="c">#                       678                                             #</span>
<span class="c">#                                                                       #</span>
<span class="c"># 2) A living cell with either 2 or 3 living neighbors remains alive.   #</span>
<span class="nv">SURVIVE</span><span class="o">=</span><span class="m">2</span>                                                               <span class="c">#</span>
<span class="c"># 3) A dead cell with 3 living neighbors comes alive, a &quot;birth.&quot;        #</span>
<span class="nv">BIRTH</span><span class="o">=</span><span class="m">3</span>                                                                 <span class="c">#</span>
<span class="c"># 4) All other cases result in a dead cell for the next generation.     #</span>
<span class="c"># ##################################################################### #</span>


<span class="nv">startfile</span><span class="o">=</span>gen0   <span class="c"># Read the starting generation from the file &quot;gen0&quot; ...</span>
                 <span class="c"># Default, if no other file specified when invoking script.</span>
                 <span class="c">#</span>
<span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> <span class="o">]</span>   <span class="c"># Specify another &quot;generation 0&quot; file.</span>
<span class="k">then</span>
    <span class="nv">startfile</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
<span class="k">fi</span>

<span class="c">############################################</span>
<span class="c">#  Abort script if &quot;startfile&quot; not specified</span>
<span class="c">#+ and</span>
<span class="c">#+ default file &quot;gen0&quot; not present.</span>

<span class="nv">E_NOSTARTFILE</span><span class="o">=</span>86

<span class="k">if</span> <span class="o">[</span> ! -e <span class="s2">&quot;</span><span class="nv">$startfile</span><span class="s2">&quot;</span> <span class="o">]</span>
<span class="k">then</span>
  <span class="nb">echo</span> <span class="s2">&quot;Startfile \&quot;&quot;</span><span class="nv">$startfile</span><span class="s2">&quot;\&quot; missing!&quot;</span>
  <span class="nb">exit</span> <span class="nv">$E_NOSTARTFILE</span>
<span class="k">fi</span>
<span class="c">############################################</span>


<span class="nv">ALIVE1</span><span class="o">=</span>.
<span class="nv">DEAD1</span><span class="o">=</span>_
                 <span class="c"># Represent living and dead cells in the start-up file.</span>

<span class="c">#  -----------------------------------------------------#</span>
<span class="c">#  This script uses a 10 x 10 grid (may be increased,</span>
<span class="c">#+ but a large grid will slow down execution).</span>
<span class="nv">ROWS</span><span class="o">=</span>10
<span class="nv">COLS</span><span class="o">=</span>10
<span class="c">#  Change above two variables to match desired grid size.</span>
<span class="c">#  -----------------------------------------------------#</span>

<span class="nv">GENERATIONS</span><span class="o">=</span><span class="m">10</span>          <span class="c">#  How many generations to cycle through.</span>
                        <span class="c">#  Adjust this upwards</span>
                        <span class="c">#+ if you have time on your hands.</span>

<span class="nv">NONE_ALIVE</span><span class="o">=</span><span class="m">85</span>           <span class="c">#  Exit status on premature bailout,</span>
                        <span class="c">#+ if no cells left alive.</span>
<span class="nv">DELAY</span><span class="o">=</span><span class="m">2</span>                 <span class="c">#  Pause between generations.</span>
<span class="nv">TRUE</span><span class="o">=</span>0
<span class="nv">FALSE</span><span class="o">=</span>1
<span class="nv">ALIVE</span><span class="o">=</span>0
<span class="nv">DEAD</span><span class="o">=</span>1

<span class="nv">avar</span><span class="o">=</span>                   <span class="c"># Global; holds current generation.</span>
<span class="nv">generation</span><span class="o">=</span><span class="m">0</span>            <span class="c"># Initialize generation count.</span>

<span class="c"># =================================================================</span>

<span class="nb">let</span> <span class="s2">&quot;cells = </span><span class="nv">$ROWS</span><span class="s2"> * </span><span class="nv">$COLS</span><span class="s2">&quot;</span>   <span class="c"># How many cells.</span>

<span class="c"># Arrays containing &quot;cells.&quot;</span>
<span class="nb">declare</span> -a initial
<span class="nb">declare</span> -a current

display <span class="o">()</span>
<span class="o">{</span>

<span class="nv">alive</span><span class="o">=</span><span class="m">0</span>                 <span class="c"># How many cells alive at any given time.</span>
                        <span class="c"># Initially zero.</span>

<span class="nb">declare</span> -a arr
<span class="nv">arr</span><span class="o">=(</span> <span class="sb">`</span><span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span><span class="sb">`</span> <span class="o">)</span>     <span class="c"># Convert passed arg to array.</span>

<span class="nv">element_count</span><span class="o">=</span><span class="si">${#</span><span class="nv">arr</span><span class="p">[*]</span><span class="si">}</span>

<span class="nb">local </span>i
<span class="nb">local </span>rowcheck

<span class="k">for</span> <span class="o">((</span><span class="nv">i</span><span class="o">=</span>0<span class="p">;</span> i&lt;<span class="nv">$element_count</span><span class="p">;</span> i++<span class="o">))</span>
<span class="k">do</span>

  <span class="c"># Insert newline at end of each row.</span>
  <span class="nb">let</span> <span class="s2">&quot;rowcheck = </span><span class="nv">$i</span><span class="s2"> % COLS&quot;</span>
  <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$rowcheck</span><span class="s2">&quot;</span> -eq <span class="m">0</span> <span class="o">]</span>
  <span class="k">then</span>
    <span class="nb">echo</span>                <span class="c"># Newline.</span>
    <span class="nb">echo</span> -n <span class="s2">&quot;      &quot;</span>    <span class="c"># Indent.</span>
  <span class="k">fi</span>

  <span class="nv">cell</span><span class="o">=</span><span class="si">${</span><span class="nv">arr</span><span class="p">[i]</span><span class="si">}</span>

  <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$cell</span><span class="s2">&quot;</span> <span class="o">=</span> . <span class="o">]</span>
  <span class="k">then</span>
    <span class="nb">let</span> <span class="s2">&quot;alive += 1&quot;</span>
  <span class="k">fi</span>

  <span class="nb">echo</span> -n <span class="s2">&quot;</span><span class="nv">$cell</span><span class="s2">&quot;</span>sed -e <span class="s1">&#39;s/_/ /g&#39;</span>
  <span class="c"># Print out array, changing underscores to spaces.</span>
<span class="k">done</span>

<span class="k">return</span>

<span class="o">}</span>

IsValid <span class="o">()</span>                            <span class="c"># Test if cell coordinate valid.</span>
<span class="o">{</span>

  <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>  -o -z <span class="s2">&quot;</span><span class="nv">$2</span><span class="s2">&quot;</span> <span class="o">]</span>          <span class="c"># Mandatory arguments missing?</span>
  <span class="k">then</span>
    <span class="k">return</span> <span class="nv">$FALSE</span>
  <span class="k">fi</span>

<span class="nb">local </span>row
<span class="nb">local </span><span class="nv">lower_limit</span><span class="o">=</span><span class="m">0</span>                   <span class="c"># Disallow negative coordinate.</span>
<span class="nb">local </span>upper_limit
<span class="nb">local </span>left
<span class="nb">local </span>right

<span class="nb">let</span> <span class="s2">&quot;upper_limit = </span><span class="nv">$ROWS</span><span class="s2"> * </span><span class="nv">$COLS</span><span class="s2"> - 1&quot;</span> <span class="c"># Total number of cells.</span>


<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> -lt <span class="s2">&quot;</span><span class="nv">$lower_limit</span><span class="s2">&quot;</span> -o <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> -gt <span class="s2">&quot;</span><span class="nv">$upper_limit</span><span class="s2">&quot;</span> <span class="o">]</span>
<span class="k">then</span>
  <span class="k">return</span> <span class="nv">$FALSE</span>                       <span class="c"># Out of array bounds.</span>
<span class="k">fi</span>

<span class="nv">row</span><span class="o">=</span><span class="nv">$2</span>
<span class="nb">let</span> <span class="s2">&quot;left = </span><span class="nv">$row</span><span class="s2"> * </span><span class="nv">$COLS</span><span class="s2">&quot;</span>             <span class="c"># Left limit.</span>
<span class="nb">let</span> <span class="s2">&quot;right = </span><span class="nv">$left</span><span class="s2"> + </span><span class="nv">$COLS</span><span class="s2"> - 1&quot;</span>       <span class="c"># Right limit.</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> -lt <span class="s2">&quot;</span><span class="nv">$left</span><span class="s2">&quot;</span> -o <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> -gt <span class="s2">&quot;</span><span class="nv">$right</span><span class="s2">&quot;</span> <span class="o">]</span>
<span class="k">then</span>
  <span class="k">return</span> <span class="nv">$FALSE</span>                       <span class="c"># Beyond row boundary.</span>
<span class="k">fi</span>

<span class="k">return</span> <span class="nv">$TRUE</span>                          <span class="c"># Valid coordinate.</span>

<span class="o">}</span>


IsAlive <span class="o">()</span>              <span class="c">#  Test whether cell is alive.</span>
                        <span class="c">#  Takes array, cell number, and</span>
<span class="o">{</span>                       <span class="c">#+ state of cell as arguments.</span>
  GetCount <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> <span class="nv">$2</span>      <span class="c">#  Get alive cell count in neighborhood.</span>
  <span class="nb">local </span><span class="nv">nhbd</span><span class="o">=</span><span class="nv">$?</span>

  <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$nhbd</span><span class="s2">&quot;</span> -eq <span class="s2">&quot;</span><span class="nv">$BIRTH</span><span class="s2">&quot;</span> <span class="o">]</span>  <span class="c"># Alive in any case.</span>
  <span class="k">then</span>
    <span class="k">return</span> <span class="nv">$ALIVE</span>
  <span class="k">fi</span>

  <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$3</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span> -a <span class="s2">&quot;</span><span class="nv">$nhbd</span><span class="s2">&quot;</span> -eq <span class="s2">&quot;</span><span class="nv">$SURVIVE</span><span class="s2">&quot;</span> <span class="o">]</span>
  <span class="k">then</span>                  <span class="c"># Alive only if previously alive.</span>
    <span class="k">return</span> <span class="nv">$ALIVE</span>
  <span class="k">fi</span>

  <span class="k">return</span> <span class="nv">$DEAD</span>          <span class="c"># Defaults to dead.</span>

<span class="o">}</span>


GetCount <span class="o">()</span>             <span class="c"># Count live cells in passed cell&#39;s neighborhood.</span>
                        <span class="c"># Two arguments needed:</span>
            <span class="c"># $1) variable holding array</span>
            <span class="c"># $2) cell number</span>
<span class="o">{</span>
  <span class="nb">local </span><span class="nv">cell_number</span><span class="o">=</span><span class="nv">$2</span>
  <span class="nb">local </span>array
  <span class="nb">local </span>top
  <span class="nb">local </span>center
  <span class="nb">local </span>bottom
  <span class="nb">local </span>r
  <span class="nb">local </span>row
  <span class="nb">local </span>i
  <span class="nb">local </span>t_top
  <span class="nb">local </span>t_cen
  <span class="nb">local </span>t_bot
  <span class="nb">local </span><span class="nv">count</span><span class="o">=</span>0
  <span class="nb">local </span><span class="nv">ROW_NHBD</span><span class="o">=</span>3

  <span class="nv">array</span><span class="o">=(</span> <span class="sb">`</span><span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span><span class="sb">`</span> <span class="o">)</span>

  <span class="nb">let</span> <span class="s2">&quot;top = </span><span class="nv">$cell_number</span><span class="s2"> - </span><span class="nv">$COLS</span><span class="s2"> - 1&quot;</span>    <span class="c"># Set up cell neighborhood.</span>
  <span class="nb">let</span> <span class="s2">&quot;center = </span><span class="nv">$cell_number</span><span class="s2"> - 1&quot;</span>
  <span class="nb">let</span> <span class="s2">&quot;bottom = </span><span class="nv">$cell_number</span><span class="s2"> + </span><span class="nv">$COLS</span><span class="s2"> - 1&quot;</span>
  <span class="nb">let</span> <span class="s2">&quot;r = </span><span class="nv">$cell_number</span><span class="s2"> / </span><span class="nv">$COLS</span><span class="s2">&quot;</span>

  <span class="k">for</span> <span class="o">((</span><span class="nv">i</span><span class="o">=</span>0<span class="p">;</span> i&lt;<span class="nv">$ROW_NHBD</span><span class="p">;</span> i++<span class="o">))</span>           <span class="c"># Traverse from left to right.</span>
  <span class="k">do</span>
    <span class="nb">let</span> <span class="s2">&quot;t_top = </span><span class="nv">$top</span><span class="s2"> + </span><span class="nv">$i</span><span class="s2">&quot;</span>
    <span class="nb">let</span> <span class="s2">&quot;t_cen = </span><span class="nv">$center</span><span class="s2"> + </span><span class="nv">$i</span><span class="s2">&quot;</span>
    <span class="nb">let</span> <span class="s2">&quot;t_bot = </span><span class="nv">$bottom</span><span class="s2"> + </span><span class="nv">$i</span><span class="s2">&quot;</span>


    <span class="nb">let</span> <span class="s2">&quot;row = </span><span class="nv">$r</span><span class="s2">&quot;</span>                        <span class="c"># Count center row.</span>
    IsValid <span class="nv">$t_cen</span> <span class="nv">$row</span>                   <span class="c"># Valid cell position?</span>
    <span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> -eq <span class="s2">&quot;</span><span class="nv">$TRUE</span><span class="s2">&quot;</span> <span class="o">]</span>
    <span class="k">then</span>
      <span class="k">if</span> <span class="o">[</span> <span class="si">${</span><span class="nv">array</span><span class="p">[</span><span class="nv">$t_cen</span><span class="p">]</span><span class="si">}</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="nv">$ALIVE1</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="c"># Is it alive?</span>
      <span class="k">then</span>                                <span class="c"># If yes, then ...</span>
        <span class="nb">let</span> <span class="s2">&quot;count += 1&quot;</span>                  <span class="c"># Increment count.</span>
      <span class="k">fi</span>
    <span class="k">fi</span>

    <span class="nb">let</span> <span class="s2">&quot;row = </span><span class="nv">$r</span><span class="s2"> - 1&quot;</span>                    <span class="c"># Count top row.</span>
    IsValid <span class="nv">$t_top</span> <span class="nv">$row</span>
    <span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> -eq <span class="s2">&quot;</span><span class="nv">$TRUE</span><span class="s2">&quot;</span> <span class="o">]</span>
    <span class="k">then</span>
      <span class="k">if</span> <span class="o">[</span> <span class="si">${</span><span class="nv">array</span><span class="p">[</span><span class="nv">$t_top</span><span class="p">]</span><span class="si">}</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="nv">$ALIVE1</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="c"># Redundancy here.</span>
      <span class="k">then</span>                                <span class="c"># Can it be optimized?</span>
        <span class="nb">let</span> <span class="s2">&quot;count += 1&quot;</span>
      <span class="k">fi</span>
    <span class="k">fi</span>

    <span class="nb">let</span> <span class="s2">&quot;row = </span><span class="nv">$r</span><span class="s2"> + 1&quot;</span>                    <span class="c"># Count bottom row.</span>
    IsValid <span class="nv">$t_bot</span> <span class="nv">$row</span>
    <span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> -eq <span class="s2">&quot;</span><span class="nv">$TRUE</span><span class="s2">&quot;</span> <span class="o">]</span>
    <span class="k">then</span>
      <span class="k">if</span> <span class="o">[</span> <span class="si">${</span><span class="nv">array</span><span class="p">[</span><span class="nv">$t_bot</span><span class="p">]</span><span class="si">}</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="nv">$ALIVE1</span><span class="s2">&quot;</span> <span class="o">]</span>
      <span class="k">then</span>
        <span class="nb">let</span> <span class="s2">&quot;count += 1&quot;</span>
      <span class="k">fi</span>
    <span class="k">fi</span>

  <span class="k">done</span>


  <span class="k">if</span> <span class="o">[</span> <span class="si">${</span><span class="nv">array</span><span class="p">[</span><span class="nv">$cell_number</span><span class="p">]</span><span class="si">}</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="nv">$ALIVE1</span><span class="s2">&quot;</span> <span class="o">]</span>
  <span class="k">then</span>
    <span class="nb">let</span> <span class="s2">&quot;count -= 1&quot;</span>        <span class="c">#  Make sure value of tested cell itself</span>
  <span class="k">fi</span>                        <span class="c">#+ is not counted.</span>


  <span class="k">return</span> <span class="nv">$count</span>

<span class="o">}</span>

next_gen <span class="o">()</span>               <span class="c"># Update generation array.</span>
<span class="o">{</span>

<span class="nb">local </span>array
<span class="nb">local </span><span class="nv">i</span><span class="o">=</span>0

<span class="nv">array</span><span class="o">=(</span> <span class="sb">`</span><span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span><span class="sb">`</span> <span class="o">)</span>     <span class="c"># Convert passed arg to array.</span>

<span class="k">while</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$i</span><span class="s2">&quot;</span> -lt <span class="s2">&quot;</span><span class="nv">$cells</span><span class="s2">&quot;</span> <span class="o">]</span>
<span class="k">do</span>
  IsAlive <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> <span class="nv">$i</span> <span class="si">${</span><span class="nv">array</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span><span class="si">}</span>   <span class="c"># Is the cell alive?</span>
  <span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> -eq <span class="s2">&quot;</span><span class="nv">$ALIVE</span><span class="s2">&quot;</span> <span class="o">]</span>
  <span class="k">then</span>                           <span class="c">#  If alive, then</span>
    array<span class="o">[</span><span class="nv">$i</span><span class="o">]=</span>.                  <span class="c">#+ represent the cell as a period.</span>
  <span class="k">else</span>
    array<span class="o">[</span><span class="nv">$i</span><span class="o">]=</span><span class="s2">&quot;_&quot;</span>                <span class="c">#  Otherwise underscore</span>
   <span class="k">fi</span>                            <span class="c">#+ (will later be converted to space).</span>
  <span class="nb">let</span> <span class="s2">&quot;i += 1&quot;</span>
<span class="k">done</span>


<span class="c">#    let &quot;generation += 1&quot;       # Increment generation count.</span>
<span class="c">###  Why was the above line commented out?</span>


<span class="c"># Set variable to pass as parameter to &quot;display&quot; function.</span>
<span class="nv">avar</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="si">${</span><span class="nv">array</span><span class="p">[@]</span><span class="si">}</span><span class="sb">`</span>   <span class="c"># Convert array back to string variable.</span>
display <span class="s2">&quot;</span><span class="nv">$avar</span><span class="s2">&quot;</span>           <span class="c"># Display it.</span>
<span class="nb">echo</span><span class="p">;</span> <span class="nb">echo</span>
<span class="nb">echo</span> <span class="s2">&quot;Generation </span><span class="nv">$generation</span><span class="s2">  -  </span><span class="nv">$alive</span><span class="s2"> alive&quot;</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$alive</span><span class="s2">&quot;</span> -eq <span class="m">0</span> <span class="o">]</span>
<span class="k">then</span>
  <span class="nb">echo</span>
<span class="nb">  echo</span> <span class="s2">&quot;Premature exit: no more cells alive!&quot;</span>
  <span class="nb">exit</span> <span class="nv">$NONE_ALIVE</span>        <span class="c">#  No point in continuing</span>
<span class="k">fi</span>                        <span class="c">#+ if no live cells.</span>

<span class="o">}</span>


<span class="c"># =========================================================</span>

<span class="c"># main ()</span>
<span class="c"># {</span>

<span class="c"># Load initial array with contents of startup file.</span>
<span class="nv">initial</span><span class="o">=(</span> <span class="sb">`</span>cat <span class="s2">&quot;</span><span class="nv">$startfile</span><span class="s2">&quot;</span>sed -e <span class="s1">&#39;/#/d&#39;</span> <span class="p">|</span> tr -d <span class="s1">&#39;\n&#39;</span> <span class="p">|</span><span class="se">\</span>
<span class="c"># Delete lines containing &#39;#&#39; comment character.</span>
           sed -e <span class="s1">&#39;s/\./\. /g&#39;</span> -e <span class="s1">&#39;s/_/_ /g&#39;</span><span class="sb">`</span> <span class="o">)</span>
<span class="c"># Remove linefeeds and insert space between elements.</span>

clear          <span class="c"># Clear screen.</span>

<span class="nb">echo</span> <span class="c">#         Title</span>
setterm -reverse on
<span class="nb">echo</span> <span class="s2">&quot;=======================&quot;</span>
setterm -reverse off
<span class="nb">echo</span> <span class="s2">&quot;    </span><span class="nv">$GENERATIONS</span><span class="s2"> generations&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;           of&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;\&quot;Life in the Slow Lane\&quot;&quot;</span>
setterm -reverse on
<span class="nb">echo</span> <span class="s2">&quot;=======================&quot;</span>
setterm -reverse off

sleep <span class="nv">$DELAY</span>   <span class="c"># Display &quot;splash screen&quot; for 2 seconds.</span>


<span class="c"># -------- Display first generation. --------</span>
<span class="nv">Gen0</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="si">${</span><span class="nv">initial</span><span class="p">[@]</span><span class="si">}</span><span class="sb">`</span>
display <span class="s2">&quot;</span><span class="nv">$Gen0</span><span class="s2">&quot;</span>           <span class="c"># Display only.</span>
<span class="nb">echo</span><span class="p">;</span> <span class="nb">echo</span>
<span class="nb">echo</span> <span class="s2">&quot;Generation </span><span class="nv">$generation</span><span class="s2">  -  </span><span class="nv">$alive</span><span class="s2"> alive&quot;</span>
sleep <span class="nv">$DELAY</span>
<span class="c"># -------------------------------------------</span>


<span class="nb">let</span> <span class="s2">&quot;generation += 1&quot;</span>     <span class="c"># Bump generation count.</span>
<span class="nb">echo</span>

<span class="c"># ------- Display second generation. -------</span>
<span class="nv">Cur</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="si">${</span><span class="nv">initial</span><span class="p">[@]</span><span class="si">}</span><span class="sb">`</span>
next_gen <span class="s2">&quot;</span><span class="nv">$Cur</span><span class="s2">&quot;</span>          <span class="c"># Update &amp; display.</span>
sleep <span class="nv">$DELAY</span>
<span class="c"># ------------------------------------------</span>

<span class="nb">let</span> <span class="s2">&quot;generation += 1&quot;</span>     <span class="c"># Increment generation count.</span>

<span class="c"># ------ Main loop for displaying subsequent generations ------</span>
<span class="k">while</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$generation</span><span class="s2">&quot;</span> -le <span class="s2">&quot;</span><span class="nv">$GENERATIONS</span><span class="s2">&quot;</span> <span class="o">]</span>
<span class="k">do</span>
  <span class="nv">Cur</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$avar</span><span class="s2">&quot;</span>
  next_gen <span class="s2">&quot;</span><span class="nv">$Cur</span><span class="s2">&quot;</span>
  <span class="nb">let</span> <span class="s2">&quot;generation += 1&quot;</span>
  sleep <span class="nv">$DELAY</span>
<span class="k">done</span>
<span class="c"># ==============================================================</span>

<span class="nb">echo</span>
<span class="c"># }</span>

<span class="nb">exit </span><span class="m">0</span>   <span class="c"># CEOF:EOF</span>



<span class="c"># The grid in this script has a &quot;boundary problem.&quot;</span>
<span class="c"># The the top, bottom, and sides border on a void of dead cells.</span>
<span class="c"># Exercise: Change the script to have the grid wrap around,</span>
<span class="c"># +         so that the left and right sides will &quot;touch,&quot;</span>
<span class="c"># +         as will the top and bottom.</span>
<span class="c">#</span>
<span class="c"># Exercise: Create a new &quot;gen0&quot; file to seed this script.</span>
<span class="c">#           Use a 12 x 16 grid, instead of the original 10 x 10 one.</span>
<span class="c">#           Make the necessary changes to the script,</span>
<span class="c">#+          so it will run with the altered file.</span>
<span class="c">#</span>
<span class="c"># Exercise: Modify this script so that it can determine the grid size</span>
<span class="c">#+          from the &quot;gen0&quot; file, and set any variables necessary</span>
<span class="c">#+          for the script to run.</span>
<span class="c">#           This would make unnecessary any changes to variables</span>
<span class="c">#+          in the script for an altered grid size.</span>
<span class="c">#</span>
<span class="c"># Exercise: Optimize this script.</span>
<span class="c">#           It has redundant code.</span>
</pre></div>
</div>
</div>
<div class="section" id="exemple-11-data-file-for-game-of-life">
<h2>Exemple 11. Data file for <em>Game of Life</em><a class="headerlink" href="#exemple-11-data-file-for-game-of-life" title="Link permanent a aquest títol">¶</a></h2>
<div class="highlight-sh"><div class="highlight"><pre><span class="c"># gen0</span>
<span class="c">#</span>
<span class="c"># This is an example &quot;generation 0&quot; start-up file for &quot;life.sh&quot;.</span>
<span class="c"># --------------------------------------------------------------</span>
<span class="c">#  The &quot;gen0&quot; file is a 10 x 10 grid using a period (.) for live cells,</span>
<span class="c">#+ and an underscore (_) for dead ones. We cannot simply use spaces</span>
<span class="c">#+ for dead cells in this file because of a peculiarity in Bash arrays.</span>
<span class="c">#  [Exercise for the reader: explain this.]</span>
<span class="c">#</span>
<span class="c"># Lines beginning with a &#39;#&#39; are comments, and the script ignores them.</span>
__.__..___
__.._.____
____.___..
_._______.
____._____
..__...___
____._____
___...____
__.._..___
_..___..__
</pre></div>
</div>
<p>+++</p>
<p>The following script is by Mark Moraes of the University of Toronto. See
the file ``      Moraes-COPYRIGHT     `` for permissions and
restrictions. This file is included in the combined <a class="reference external" href="mirrorsites.html#WHERE_TARBALL">HTML/source
tarball</a> of the <em>ABS Guide</em> .</p>
</div>
<div class="section" id="exemple-12-behead-removing-mail-and-news-message-headers">
<h2>Exemple 12. <em>behead</em> : Removing mail and news message headers<a class="headerlink" href="#exemple-12-behead-removing-mail-and-news-message-headers" title="Link permanent a aquest títol">¶</a></h2>
<div class="highlight-sh"><div class="highlight"><pre><span class="c">#! /bin/sh</span>
<span class="c">#  Strips off the header from a mail/News message i.e. till the first</span>
<span class="c">#+ empty line.</span>
<span class="c">#  Author: Mark Moraes, University of Toronto</span>

<span class="c"># ==&gt; These comments added by author of this document.</span>

<span class="k">if</span> <span class="o">[</span> <span class="nv">$# </span>-eq <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
<span class="c"># ==&gt; If no command-line args present, then works on file redirected to stdin.</span>
    sed -e <span class="s1">&#39;1,/^$/d&#39;</span> -e <span class="s1">&#39;/^[    ]*$/d&#39;</span>
    <span class="c"># --&gt; Delete empty lines and all lines until</span>
    <span class="c"># --&gt; first one beginning with white space.</span>
<span class="k">else</span>
<span class="c"># ==&gt; If command-line args present, then work on files named.</span>
    <span class="k">for</span> i <span class="k">do</span>
        sed -e <span class="s1">&#39;1,/^$/d&#39;</span> -e <span class="s1">&#39;/^[    ]*$/d&#39;</span> <span class="nv">$i</span>
        <span class="c"># --&gt; Ditto, as above.</span>
    <span class="k">done</span>
<span class="k">fi</span>

<span class="nb">exit</span>

<span class="c"># ==&gt; Exercise: Add error checking and other options.</span>
<span class="c"># ==&gt;</span>
<span class="c"># ==&gt; Note that the small sed script repeats, except for the arg passed.</span>
<span class="c"># ==&gt; Does it make sense to embed it in a function? Why or why not?</span>


/*
 * Copyright University of Toronto 1988, 1989.
 * Written by Mark Moraes
 *
 * Permission is granted to anyone to use this software <span class="k">for</span> any purpose on
 * any computer system, and to alter it and redistribute it freely, subject
 * to the following restrictions:
 *
 * 1. The author and the University of Toronto are not responsible
 *    <span class="k">for</span> the consequences of use of this software, no matter how awful,
 *    even <span class="k">if</span> they arise from flaws in it.
 *
 * 2. The origin of this software must not be misrepresented, either by
 *    explicit claim or by omission.  Since few users ever <span class="nb">read </span>sources,
 *    credits must appear in the documentation.
 *
 * 3. Altered versions must be plainly marked as such, and must not be
 *    misrepresented as being the original software.  Since few users
 *    ever <span class="nb">read </span>sources, credits must appear in the documentation.
 *
 * 4. This notice may not be removed or altered.
 */
</pre></div>
</div>
<ul class="simple">
<li></li>
</ul>
<p>Antek Sawicki contributed the following script, which makes very clever
use of the parameter substitution operators discussed in <a class="reference external" href="parameter-substitution.html">Section
10.2</a> .</p>
</div>
<div class="section" id="exemple-13-password-generating-random-8-character-passwords">
<h2>Exemple 13. <em>password</em> : Generating random 8-character passwords<a class="headerlink" href="#exemple-13-password-generating-random-8-character-passwords" title="Link permanent a aquest títol">¶</a></h2>
<div class="highlight-sh"><div class="highlight"><pre><span class="c">#!/bin/bash</span>
<span class="c">#</span>
<span class="c">#</span>
<span class="c">#  Random password generator for Bash 2.x +</span>
<span class="c">#+ by Antek Sawicki &lt;tenox@tenox.tc&gt;,</span>
<span class="c">#+ who generously gave usage permission to the ABS Guide author.</span>
<span class="c">#</span>
<span class="c"># ==&gt; Comments added by document author ==&gt;</span>


<span class="nv">MATRIX</span><span class="o">=</span><span class="s2">&quot;0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz&quot;</span>
<span class="c"># ==&gt; Password will consist of alphanumeric characters.</span>
<span class="nv">LENGTH</span><span class="o">=</span><span class="s2">&quot;8&quot;</span>
<span class="c"># ==&gt; May change &#39;LENGTH&#39; for longer password.</span>


<span class="k">while</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">n</span><span class="p">:=1</span><span class="si">}</span><span class="s2">&quot;</span> -le <span class="s2">&quot;</span><span class="nv">$LENGTH</span><span class="s2">&quot;</span> <span class="o">]</span>
<span class="c"># ==&gt; Recall that := is &quot;default substitution&quot; operator.</span>
<span class="c"># ==&gt; So, if &#39;n&#39; has not been initialized, set it to 1.</span>
<span class="k">do</span>
    <span class="nv">PASS</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$PASS</span><span class="si">${</span><span class="nv">MATRIX</span><span class="p">:</span><span class="k">$((</span><span class="nv">$RANDOM</span><span class="o">%</span><span class="si">${#</span><span class="nv">MATRIX</span><span class="si">}</span><span class="k">))</span><span class="p">:</span><span class="nv">1</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="c"># ==&gt; Very clever, but tricky.</span>

    <span class="c"># ==&gt; Starting from the innermost nesting...</span>
    <span class="c"># ==&gt; ${#MATRIX} returns length of array MATRIX.</span>

    <span class="c"># ==&gt; $RANDOM%${#MATRIX} returns random number between 1</span>
    <span class="c"># ==&gt; and [length of MATRIX] - 1.</span>

    <span class="c"># ==&gt; ${MATRIX:$(($RANDOM%${#MATRIX})):1}</span>
    <span class="c"># ==&gt; returns expansion of MATRIX at random position, by length 1.</span>
    <span class="c"># ==&gt; See {var:pos:len} parameter substitution in Chapter 9.</span>
    <span class="c"># ==&gt; and the associated examples.</span>

    <span class="c"># ==&gt; PASS=... simply pastes this result onto previous PASS (concatenation).</span>

    <span class="c"># ==&gt; To visualize this more clearly, uncomment the following line</span>
    <span class="c">#                 echo &quot;$PASS&quot;</span>
    <span class="c"># ==&gt; to see PASS being built up,</span>
    <span class="c"># ==&gt; one character at a time, each iteration of the loop.</span>

    <span class="nb">let </span>n+<span class="o">=</span>1
    <span class="c"># ==&gt; Increment &#39;n&#39; for next pass.</span>
<span class="k">done</span>

<span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$PASS</span><span class="s2">&quot;</span>      <span class="c"># ==&gt; Or, redirect to a file, as desired.</span>

<span class="nb">exit </span>0
</pre></div>
</div>
<ul class="simple">
<li>James R. Van Zandt contributed this script which uses named pipes and,</li>
</ul>
<p>in his words, &#8220;really exercises quoting and escaping.&#8221;</p>
</div>
<div class="section" id="exemple-14-fifo-making-daily-backups-using-named-pipes">
<h2>Exemple 14. <em>fifo</em> : Making daily backups, using named pipes<a class="headerlink" href="#exemple-14-fifo-making-daily-backups-using-named-pipes" title="Link permanent a aquest títol">¶</a></h2>
<div class="highlight-sh"><div class="highlight"><pre><span class="c">#!/bin/bash</span>
<span class="c"># ==&gt; Script by James R. Van Zandt, and used here with his permission.</span>

<span class="c"># ==&gt; Comments added by author of this document.</span>


  <span class="nv">HERE</span><span class="o">=</span><span class="sb">`</span>uname -n<span class="sb">`</span>    <span class="c"># ==&gt; hostname</span>
  <span class="nv">THERE</span><span class="o">=</span>bilbo
  <span class="nb">echo</span> <span class="s2">&quot;starting remote backup to </span><span class="nv">$THERE</span><span class="s2"> at `date +%r`&quot;</span>
  <span class="c"># ==&gt; `date +%r` returns time in 12-hour format, i.e. &quot;08:08:34 PM&quot;.</span>

  <span class="c"># make sure /pipe really is a pipe and not a plain file</span>
  rm -rf /pipe
  mkfifo /pipe       <span class="c"># ==&gt; Create a &quot;named pipe&quot;, named &quot;/pipe&quot; ...</span>

  <span class="c"># ==&gt; &#39;su xyz&#39; runs commands as user &quot;xyz&quot;.</span>
  <span class="c"># ==&gt; &#39;ssh&#39; invokes secure shell (remote login client).</span>
  su xyz -c <span class="s2">&quot;ssh </span><span class="nv">$THERE</span><span class="s2"> \&quot;cat &gt; /home/xyz/backup/</span><span class="si">${</span><span class="nv">HERE</span><span class="si">}</span><span class="s2">-daily.tar.gz\&quot; &lt; /pipe&quot;</span><span class="p">&amp;</span>
  <span class="nb">cd</span> /
  tar -czf - bin boot dev etc home info lib man root sbin share usr var &gt; /pipe
  <span class="c"># ==&gt; Uses named pipe, /pipe, to communicate between processes:</span>
  <span class="c"># ==&gt; &#39;tar/gzip&#39; writes to /pipe and &#39;ssh&#39; reads from /pipe.</span>

  <span class="c"># ==&gt; The end result is this backs up the main directories, from / on down.</span>

  <span class="c"># ==&gt;  What are the advantages of a &quot;named pipe&quot; in this situation,</span>
  <span class="c"># ==&gt;+ as opposed to an &quot;anonymous pipe&quot;, with |?</span>
  <span class="c"># ==&gt;  Will an anonymous pipe even work here?</span>

  <span class="c"># ==&gt;  Is it necessary to delete the pipe before exiting the script?</span>
  <span class="c"># ==&gt;  How could that be done?</span>


  <span class="nb">exit </span>0
</pre></div>
</div>
<ul class="simple">
<li></li>
</ul>
<p>Stéphane Chazelas used the following script to demonstrate generating
prime numbers without arrays.</p>
</div>
<div class="section" id="exemple-15-generating-prime-numbers-using-the-modulo-operator">
<h2>Exemple 15. Generating prime numbers using the modulo operator<a class="headerlink" href="#exemple-15-generating-prime-numbers-using-the-modulo-operator" title="Link permanent a aquest títol">¶</a></h2>
<div class="highlight-sh"><div class="highlight"><pre><span class="c">#!/bin/bash</span>
<span class="c"># primes.sh: Generate prime numbers, without using arrays.</span>
<span class="c"># Script contributed by Stephane Chazelas.</span>

<span class="c">#  This does *not* use the classic &quot;Sieve of Eratosthenes&quot; algorithm,</span>
<span class="c">#+ but instead the more intuitive method of testing each candidate number</span>
<span class="c">#+ for factors (divisors), using the &quot;%&quot; modulo operator.</span>


<span class="nv">LIMIT</span><span class="o">=</span><span class="m">1000</span>                    <span class="c"># Primes, 2 ... 1000.</span>

Primes<span class="o">()</span>
<span class="o">{</span>
 <span class="o">((</span> <span class="nv">n</span> <span class="o">=</span> <span class="nv">$1</span> + <span class="m">1</span> <span class="o">))</span>             <span class="c"># Bump to next integer.</span>
 <span class="nb">shift</span>                        <span class="c"># Next parameter in list.</span>
<span class="c">#  echo &quot;_n=$n i=$i_&quot;</span>

 <span class="k">if</span> <span class="o">((</span> <span class="nv">n</span> <span class="o">==</span> LIMIT <span class="o">))</span>
 <span class="k">then</span> <span class="nb">echo</span> <span class="nv">$*</span>
 <span class="k">return</span>
 <span class="k">fi</span>

 <span class="k">for</span> i<span class="p">;</span> <span class="k">do</span>                    <span class="c"># &quot;i&quot; set to &quot;@&quot;, previous values of $n.</span>
<span class="c">#   echo &quot;-n=$n i=$i-&quot;</span>
   <span class="o">((</span> i * i &gt; n <span class="o">))</span> <span class="o">&amp;&amp;</span> <span class="nb">break</span>   <span class="c"># Optimization.</span>
   <span class="o">((</span> n % i <span class="o">))</span> <span class="o">&amp;&amp;</span> <span class="k">continue</span>    <span class="c"># Sift out non-primes using modulo operator.</span>
   Primes <span class="nv">$n</span> <span class="nv">$@</span>               <span class="c"># Recursion inside loop.</span>
   <span class="k">return</span>
   <span class="k">done</span>

   Primes <span class="nv">$n</span> <span class="nv">$@</span> <span class="nv">$n</span>            <span class="c">#  Recursion outside loop.</span>
                              <span class="c">#  Successively accumulate</span>
                  <span class="c">#+ positional parameters.</span>
                              <span class="c">#  &quot;$@&quot; is the accumulating list of primes.</span>
<span class="o">}</span>

Primes 1

<span class="nb">exit</span> <span class="nv">$?</span>

<span class="c"># Pipe output of the script to &#39;fmt&#39; for prettier printing.</span>

<span class="c">#  Uncomment lines 16 and 24 to help figure out what is going on.</span>

<span class="c">#  Compare the speed of this algorithm for generating primes</span>
<span class="c">#+ with the Sieve of Eratosthenes (ex68.sh).</span>


<span class="c">#  Exercise: Rewrite this script without recursion.</span>
</pre></div>
</div>
<ul class="simple">
<li></li>
</ul>
<p>Rick Boivie&#8217;s revision of Jordi Sanfeliu&#8217;s <em>tree</em> script.</p>
</div>
<div class="section" id="exemple-16-tree-displaying-a-directory-tree">
<h2>Exemple 16. <em>tree</em> : Displaying a directory tree<a class="headerlink" href="#exemple-16-tree-displaying-a-directory-tree" title="Link permanent a aquest títol">¶</a></h2>
<div class="highlight-sh"><div class="highlight"><pre><span class="c">#!/bin/bash</span>
<span class="c"># tree.sh</span>

<span class="c">#  Written by Rick Boivie.</span>
<span class="c">#  Used with permission.</span>
<span class="c">#  This is a revised and simplified version of a script</span>
<span class="c">#+ by Jordi Sanfeliu (the original author), and patched by Ian Kjos.</span>
<span class="c">#  This script replaces the earlier version used in</span>
<span class="c">#+ previous releases of the Advanced Bash Scripting Guide.</span>
<span class="c">#  Copyright (c) 2002, by Jordi Sanfeliu, Rick Boivie, and Ian Kjos.</span>

<span class="c"># ==&gt; Comments added by the author of this document.</span>


search <span class="o">()</span> <span class="o">{</span>
<span class="k">for</span> dir in <span class="sb">`</span><span class="nb">echo</span> *<span class="sb">`</span>
<span class="c">#  ==&gt; `echo *` lists all the files in current working directory,</span>
<span class="c">#+ ==&gt; without line breaks.</span>
<span class="c">#  ==&gt; Similar effect to for dir in *</span>
<span class="c">#  ==&gt; but &quot;dir in `echo *`&quot; will not handle filenames with blanks.</span>
<span class="k">do</span>
  <span class="k">if</span> <span class="o">[</span> -d <span class="s2">&quot;</span><span class="nv">$dir</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span> <span class="c"># ==&gt; If it is a directory (-d)...</span>
  <span class="nv">zz</span><span class="o">=</span><span class="m">0</span>                    <span class="c"># ==&gt; Temp variable, keeping track of</span>
                          <span class="c">#     directory level.</span>
  <span class="k">while</span> <span class="o">[</span> <span class="nv">$zz</span> !<span class="o">=</span> <span class="nv">$1</span> <span class="o">]</span>     <span class="c"># Keep track of inner nested loop.</span>
    <span class="k">do</span>
      <span class="nb">echo</span> -n <span class="s2">&quot;&quot;</span>        <span class="c"># ==&gt; Display vertical connector symbol,</span>
                          <span class="c"># ==&gt; with 2 spaces &amp; no line feed</span>
                          <span class="c">#     in order to indent.</span>
      <span class="nv">zz</span><span class="o">=</span><span class="sb">`</span>expr <span class="nv">$zz</span> + 1<span class="sb">`</span>   <span class="c"># ==&gt; Increment zz.</span>
    <span class="k">done</span>

    <span class="k">if</span> <span class="o">[</span> -L <span class="s2">&quot;</span><span class="nv">$dir</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span> <span class="c"># ==&gt; If directory is a symbolic link...</span>
      <span class="nb">echo</span> <span class="s2">&quot;+---</span><span class="nv">$dir</span><span class="s2">&quot;</span> <span class="sb">`</span>ls -l <span class="nv">$dirsed</span> <span class="s1">&#39;s/^.*&#39;</span><span class="nv">$dir</span><span class="s1">&#39; //&#39;</span><span class="sb">`</span>
      <span class="c"># ==&gt; Display horiz. connector and list directory name, but...</span>
      <span class="c"># ==&gt; delete date/time part of long listing.</span>
    <span class="k">else</span>
      <span class="nb">echo</span> <span class="s2">&quot;+---</span><span class="nv">$dir</span><span class="s2">&quot;</span>       <span class="c"># ==&gt; Display horizontal connector symbol...</span>
      <span class="c"># ==&gt; and print directory name.</span>
      <span class="nv">numdirs</span><span class="o">=</span><span class="sb">`</span>expr <span class="nv">$numdirs</span> + 1<span class="sb">`</span> <span class="c"># ==&gt; Increment directory count.</span>
      <span class="k">if</span> <span class="nb">cd</span> <span class="s2">&quot;</span><span class="nv">$dir</span><span class="s2">&quot;</span> <span class="p">;</span> <span class="k">then</span>         <span class="c"># ==&gt; If can move to subdirectory...</span>
        search <span class="sb">`</span>expr <span class="nv">$1</span> + 1<span class="sb">`</span>      <span class="c"># with recursion ;-)</span>
        <span class="c"># ==&gt; Function calls itself.</span>
        <span class="nb">cd</span> ..
      <span class="k">fi</span>
    <span class="k">fi</span>
  <span class="k">fi</span>
<span class="k">done</span>
<span class="o">}</span>

<span class="k">if</span> <span class="o">[</span> <span class="nv">$# </span>!<span class="o">=</span> <span class="m">0</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
  <span class="nb">cd</span> <span class="nv">$1</span>   <span class="c"># Move to indicated directory.</span>
  <span class="c">#else   # stay in current directory</span>
<span class="k">fi</span>

<span class="nb">echo</span> <span class="s2">&quot;Initial directory = `pwd`&quot;</span>
<span class="nv">numdirs</span><span class="o">=</span>0

search 0
<span class="nb">echo</span> <span class="s2">&quot;Total directories = </span><span class="nv">$numdirs</span><span class="s2">&quot;</span>

<span class="nb">exit </span>0
</pre></div>
</div>
<p>Patsie&#8217;s version of a directory <em>tree</em> script.</p>
</div>
<div class="section" id="exemple-17-tree2-alternate-directory-tree-script">
<h2>Exemple 17. <em>tree2</em> : Alternate directory tree script<a class="headerlink" href="#exemple-17-tree2-alternate-directory-tree-script" title="Link permanent a aquest títol">¶</a></h2>
<div class="highlight-sh"><div class="highlight"><pre><span class="c">#!/bin/bash</span>
<span class="c"># tree2.sh</span>

<span class="c"># Lightly modified/reformatted by ABS Guide author.</span>
<span class="c"># Included in ABS Guide with permission of script author (thanks!).</span>

<span class="c">## Recursive file/dirsize checking script, by Patsie</span>
<span class="c">##</span>
<span class="c">## This script builds a list of files/directories and their size (du -akx)</span>
<span class="c">## and processes this list to a human readable tree shape</span>
<span class="c">## The &#39;du -akx&#39; is only as good as the permissions the owner has.</span>
<span class="c">## So preferably run as root* to get the best results, or use only on</span>
<span class="c">## directories for which you have read permissions. Anything you can&#39;t</span>
<span class="c">## read is not in the list.</span>

<span class="c">#* ABS Guide author advises caution when running scripts as root!</span>


<span class="c">##########  THIS IS CONFIGURABLE  ##########</span>

<span class="nv">TOP</span><span class="o">=</span><span class="m">5</span>                   <span class="c"># Top 5 biggest (sub)directories.</span>
<span class="nv">MAXRECURS</span><span class="o">=</span><span class="m">5</span>             <span class="c"># Max 5 subdirectories/recursions deep.</span>
<span class="nv">E_BL</span><span class="o">=</span><span class="m">80</span>                 <span class="c"># Blank line already returned.</span>
<span class="nv">E_DIR</span><span class="o">=</span><span class="m">81</span>                <span class="c"># Directory not specified.</span>


<span class="c">##########  DON&#39;T CHANGE ANYTHING BELOW THIS LINE  ##########</span>

<span class="nv">PID</span><span class="o">=</span><span class="nv">$$</span>                            <span class="c"># Our own process ID.</span>
<span class="nv">SELF</span><span class="o">=</span><span class="sb">`</span>basename <span class="nv">$0</span><span class="sb">`</span>                <span class="c"># Our own program name.</span>
<span class="nv">TMP</span><span class="o">=</span><span class="s2">&quot;/tmp/</span><span class="si">${</span><span class="nv">SELF</span><span class="si">}</span><span class="s2">.</span><span class="si">${</span><span class="nv">PID</span><span class="si">}</span><span class="s2">.tmp&quot;</span>     <span class="c"># Temporary &#39;du&#39; result.</span>

<span class="c"># Convert number to dotted thousand.</span>
<span class="k">function</span> dot <span class="o">{</span> <span class="nb">echo</span> <span class="s2">&quot;            </span><span class="nv">$*</span><span class="s2">&quot;</span>
               sed -e :a -e <span class="s1">&#39;s/\(.*[0-9]\)\([0-9]\{3\}\)/\1,\2/;ta&#39;</span>
               tail -c 12<span class="p">;</span> <span class="o">}</span>

<span class="c"># Usage: tree &lt;recursion&gt; &lt;indent prefix&gt; &lt;min size&gt; &lt;directory&gt;</span>
<span class="k">function</span> tree <span class="o">{</span>
  <span class="nv">recurs</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>           <span class="c"># How deep nested are we?</span>
  <span class="nv">prefix</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$2</span><span class="s2">&quot;</span>           <span class="c"># What do we display before file/dirname?</span>
  <span class="nv">minsize</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$3</span><span class="s2">&quot;</span>          <span class="c"># What is the minumum file/dirsize?</span>
  <span class="nv">dirname</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$4</span><span class="s2">&quot;</span>          <span class="c"># Which directory are we checking?</span>

<span class="c"># Get ($TOP) biggest subdirs/subfiles from TMP file.</span>
  <span class="nv">LIST</span><span class="o">=</span><span class="sb">`</span>egrep <span class="s2">&quot;[[:space:]]</span><span class="si">${</span><span class="nv">dirname</span><span class="si">}</span><span class="s2">/[^/]*</span><span class="nv">$&quot;</span><span class="s2"> &quot;</span><span class="nv">$TMP</span><span class="s2">&quot;</span>
<span class="s2">        awk &#39;{if(</span><span class="nv">$1</span><span class="s2">&gt;&#39;</span><span class="nv">$minsize</span><span class="s2">&#39;) print;}&#39;sort -nr | head -</span><span class="nv">$TOP</span><span class="s2">`</span>
<span class="s2">  [ -z &quot;</span><span class="nv">$LIST</span><span class="s2">&quot; ] &amp;&amp; return        # Empty list, then go back.</span>

<span class="s2">  cnt=0</span>
<span class="s2">  num=`echo &quot;</span><span class="nv">$LIST</span><span class="s2">&quot;wc -l`      # How many entries in the list.</span>

<span class="s2">  ## Main loop</span>
<span class="s2">  echo &quot;</span><span class="nv">$LIST</span><span class="s2">&quot;while read size name; do</span>
<span class="s2">    ((cnt+=1))                # Count entry number.</span>
<span class="s2">    bname=`basename &quot;</span><span class="nv">$name</span><span class="s2">&quot;`      # We only need a basename of the entry.</span>
<span class="s2">    [ -d &quot;</span><span class="nv">$name</span><span class="s2">&quot; ] &amp;&amp; bname=&quot;</span><span class="nv">$bname</span>/<span class="s2">&quot;</span>
<span class="s2">                                  # If it&#39;s a directory, append a slash.</span>
<span class="s2">    echo &quot;</span><span class="sb">`</span>dot <span class="nv">$size</span><span class="sb">`</span><span class="nv">$prefix</span> +-<span class="nv">$bname</span><span class="s2">&quot;</span>
<span class="s2">                                  # Display the result.</span>
<span class="s2">    #  Call ourself recursively if it&#39;s a directory</span>
<span class="s2">    #+ and we&#39;re not nested too deep (</span><span class="nv">$MAXRECURS</span><span class="s2">).</span>
<span class="s2">    #  The recursion goes up: </span><span class="k">$((</span>recurs+1<span class="k">))</span><span class="s2"></span>
<span class="s2">    #  The prefix gets a space if it&#39;s the last entry,</span>
<span class="s2">    #+ or a pipe if there are more entries.</span>
<span class="s2">    #  The minimum file/dirsize becomes</span>
<span class="s2">    #+ a tenth of his parent: </span><span class="k">$((</span>size/10<span class="k">))</span><span class="s2">.</span>
<span class="s2">    # Last argument is the full directory name to check.</span>
<span class="s2">    if [ -d &quot;</span><span class="nv">$name</span><span class="s2">&quot; -a </span><span class="nv">$recurs</span><span class="s2"> -lt </span><span class="nv">$MAXRECURS</span><span class="s2"> ]; then</span>
<span class="s2">      [ </span><span class="nv">$cnt</span><span class="s2"> -lt </span><span class="nv">$num</span><span class="s2"> ] \</span>
<span class="s2">        |(tree </span><span class="k">$((</span>recurs+1<span class="k">))</span><span class="s2"> &quot;</span><span class="nv">$prefix</span>  <span class="s2">&quot; </span><span class="k">$((</span>size/10<span class="k">))</span><span class="s2"> &quot;</span><span class="nv">$name</span><span class="s2">&quot;) \</span>
<span class="s2">        &amp;&amp; (tree </span><span class="k">$((</span>recurs+1<span class="k">))</span><span class="s2"> &quot;</span><span class="nv">$prefix</span> <span class="p">|</span><span class="s2">&quot; </span><span class="k">$((</span>size/10<span class="k">))</span><span class="s2"> &quot;</span><span class="nv">$name</span><span class="s2">&quot;)</span>
<span class="s2">    fi</span>
<span class="s2">  done</span>

<span class="s2">  [ </span><span class="nv">$?</span><span class="s2"> -eq 0 ] &amp;&amp; echo &quot;</span>           <span class="nv">$prefix</span><span class="s2">&quot;</span>
<span class="s2">  # Every time we jump back add a &#39;blank&#39; line.</span>
<span class="s2">  return </span><span class="nv">$E_BL</span><span class="s2"></span>
<span class="s2">  # We return 80 to tell we added a blank line already.</span>
<span class="s2">}</span>

<span class="s2">###                ###</span>
<span class="s2">###  main program  ###</span>
<span class="s2">###                ###</span>

<span class="s2">rootdir=&quot;</span><span class="nv">$@</span><span class="s2">&quot;</span>
<span class="s2">[ -d &quot;</span><span class="nv">$rootdir</span><span class="s2">&quot; ] |</span>
<span class="s2">  { echo &quot;</span><span class="nv">$SELF</span>: Usage: <span class="nv">$SELF</span> &lt;directory&gt;<span class="s2">&quot; &gt;&amp;2; exit </span><span class="nv">$E_DIR</span><span class="s2">; }</span>
<span class="s2">  # We should be called with a directory name.</span>

<span class="s2">echo &quot;</span>Building inventory list, please <span class="nb">wait</span> ...<span class="s2">&quot;</span>
<span class="s2">     # Show &quot;</span>please <span class="nb">wait</span><span class="s2">&quot; message.</span>
<span class="s2">du -akx &quot;</span><span class="nv">$rootdir</span><span class="s2">&quot; 1&gt;&quot;</span><span class="nv">$TMP</span><span class="s2">&quot; 2&gt;/dev/null</span>
<span class="s2">     # Build a temporary list of all files/dirs and their size.</span>
<span class="s2">size=`tail -1 &quot;</span><span class="nv">$TMP</span><span class="s2">&quot;awk &#39;{print </span><span class="nv">$1</span><span class="s2">}&#39;`</span>
<span class="s2">     # What is our rootdirectory&#39;s size?</span>
<span class="s2">echo &quot;</span><span class="sb">`</span>dot <span class="nv">$size</span><span class="sb">`</span> <span class="nv">$rootdir</span><span class="s2">&quot;</span>
<span class="s2">     # Display rootdirectory&#39;s entry.</span>
<span class="s2">tree 0 &quot;&quot; 0 &quot;</span><span class="nv">$rootdir</span><span class="s2">&quot;</span>
<span class="s2">     # Display the tree below our rootdirectory.</span>

<span class="s2">rm &quot;</span><span class="nv">$TMP</span><span class="s2">&quot; 2&gt;/dev/null</span>
<span class="s2">     # Clean up TMP file.</span>

<span class="s2">exit </span><span class="nv">$?</span><span class="s2"></span>
</pre></div>
</div>
<p>Noah Friedman permitted use of his <em>string function</em> script. It
essentially reproduces some of the <em>C</em> -library string manipulation
functions.</p>
</div>
<div class="section" id="exemple-18-string-functions-c-style-string-functions">
<h2>Exemple 18. <em>string functions</em> : C-style string functions<a class="headerlink" href="#exemple-18-string-functions-c-style-string-functions" title="Link permanent a aquest títol">¶</a></h2>
<div class="highlight-sh"><div class="highlight"><pre><span class="c">#!/bin/bash</span>

<span class="c"># string.bash --- bash emulation of string(3) library routines</span>
<span class="c"># Author: Noah Friedman &lt;friedman@prep.ai.mit.edu&gt;</span>
<span class="c"># ==&gt;     Used with his kind permission in this document.</span>
<span class="c"># Created: 1992-07-01</span>
<span class="c"># Last modified: 1993-09-29</span>
<span class="c"># Public domain</span>

<span class="c"># Conversion to bash v2 syntax done by Chet Ramey</span>

<span class="c"># Commentary:</span>
<span class="c"># Code:</span>

<span class="c">#:docstring strcat:</span>
<span class="c"># Usage: strcat s1 s2</span>
<span class="c">#</span>
<span class="c"># Strcat appends the value of variable s2 to variable s1.</span>
<span class="c">#</span>
<span class="c"># Example:</span>
<span class="c">#    a=&quot;foo&quot;</span>
<span class="c">#    b=&quot;bar&quot;</span>
<span class="c">#    strcat a b</span>
<span class="c">#    echo $a</span>
<span class="c">#    =&gt; foobar</span>
<span class="c">#</span>
<span class="c">#:end docstring:</span>

<span class="c">###;;;autoload   ==&gt; Autoloading of function commented out.</span>
<span class="k">function</span> strcat <span class="o">()</span>
<span class="o">{</span>
    <span class="nb">local </span>s1_val s2_val

    <span class="nv">s1_val</span><span class="o">=</span><span class="si">${</span><span class="p">!1</span><span class="si">}</span>                        <span class="c"># indirect variable expansion</span>
    <span class="nv">s2_val</span><span class="o">=</span><span class="si">${</span><span class="p">!2</span><span class="si">}</span>
    <span class="nb">eval</span> <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span><span class="o">=</span><span class="se">\&#39;</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">s1_val</span><span class="si">}${</span><span class="nv">s2_val</span><span class="si">}</span><span class="s2">&quot;</span><span class="se">\&#39;</span>
    <span class="c"># ==&gt; eval $1=&#39;${s1_val}${s2_val}&#39; avoids problems,</span>
    <span class="c"># ==&gt; if one of the variables contains a single quote.</span>
<span class="o">}</span>

<span class="c">#:docstring strncat:</span>
<span class="c"># Usage: strncat s1 s2 $n</span>
<span class="c">#</span>
<span class="c"># Line strcat, but strncat appends a maximum of n characters from the value</span>
<span class="c"># of variable s2.  It copies fewer if the value of variabl s2 is shorter</span>
<span class="c"># than n characters.  Echoes result on stdout.</span>
<span class="c">#</span>
<span class="c"># Example:</span>
<span class="c">#    a=foo</span>
<span class="c">#    b=barbaz</span>
<span class="c">#    strncat a b 3</span>
<span class="c">#    echo $a</span>
<span class="c">#    =&gt; foobar</span>
<span class="c">#</span>
<span class="c">#:end docstring:</span>

<span class="c">###;;;autoload</span>
<span class="k">function</span> strncat <span class="o">()</span>
<span class="o">{</span>
    <span class="nb">local </span><span class="nv">s1</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
    <span class="nb">local </span><span class="nv">s2</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$2</span><span class="s2">&quot;</span>
    <span class="nb">local</span> -i <span class="nv">n</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$3</span><span class="s2">&quot;</span>
    <span class="nb">local </span>s1_val s2_val

    <span class="nv">s1_val</span><span class="o">=</span><span class="si">${</span><span class="p">!s1</span><span class="si">}</span>                       <span class="c"># ==&gt; indirect variable expansion</span>
    <span class="nv">s2_val</span><span class="o">=</span><span class="si">${</span><span class="p">!s2</span><span class="si">}</span>

    <span class="k">if</span> <span class="o">[</span> <span class="si">${#</span><span class="nv">s2_val</span><span class="si">}</span> -gt <span class="si">${</span><span class="nv">n</span><span class="si">}</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
       <span class="nv">s2_val</span><span class="o">=</span><span class="si">${</span><span class="nv">s2_val</span><span class="p">:</span><span class="nv">0</span><span class="p">:</span><span class="nv">$n</span><span class="si">}</span>            <span class="c"># ==&gt; substring extraction</span>
    <span class="k">fi</span>

    <span class="nb">eval</span> <span class="s2">&quot;</span><span class="nv">$s1</span><span class="s2">&quot;</span><span class="o">=</span><span class="se">\&#39;</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">s1_val</span><span class="si">}${</span><span class="nv">s2_val</span><span class="si">}</span><span class="s2">&quot;</span><span class="se">\&#39;</span>
    <span class="c"># ==&gt; eval $1=&#39;${s1_val}${s2_val}&#39; avoids problems,</span>
    <span class="c"># ==&gt; if one of the variables contains a single quote.</span>
<span class="o">}</span>

<span class="c">#:docstring strcmp:</span>
<span class="c"># Usage: strcmp $s1 $s2</span>
<span class="c">#</span>
<span class="c"># Strcmp compares its arguments and returns an integer less than, equal to,</span>
<span class="c"># or greater than zero, depending on whether string s1 is lexicographically</span>
<span class="c"># less than, equal to, or greater than string s2.</span>
<span class="c">#:end docstring:</span>

<span class="c">###;;;autoload</span>
<span class="k">function</span> strcmp <span class="o">()</span>
<span class="o">{</span>
    <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="nv">$2</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="k">return</span> 0

    <span class="o">[</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">1</span><span class="si">}</span><span class="s2">&quot;</span> <span class="s1">&#39;&lt;&#39;</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">2</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]</span> &gt; /dev/null <span class="o">&amp;&amp;</span> <span class="k">return</span> -1

    <span class="k">return</span> 1
<span class="o">}</span>

<span class="c">#:docstring strncmp:</span>
<span class="c"># Usage: strncmp $s1 $s2 $n</span>
<span class="c">#</span>
<span class="c"># Like strcmp, but makes the comparison by examining a maximum of n</span>
<span class="c"># characters (n less than or equal to zero yields equality).</span>
<span class="c">#:end docstring:</span>

<span class="c">###;;;autoload</span>
<span class="k">function</span> strncmp <span class="o">()</span>
<span class="o">{</span>
    <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="si">${</span><span class="nv">3</span><span class="si">}</span><span class="s2">&quot;</span> -o <span class="s2">&quot;</span><span class="si">${</span><span class="nv">3</span><span class="si">}</span><span class="s2">&quot;</span> -le <span class="s2">&quot;0&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
       <span class="k">return</span> 0
    <span class="k">fi</span>

    <span class="k">if</span> <span class="o">[</span> <span class="si">${</span><span class="nv">3</span><span class="si">}</span> -ge <span class="si">${#</span><span class="nv">1</span><span class="si">}</span> -a <span class="si">${</span><span class="nv">3</span><span class="si">}</span> -ge <span class="si">${#</span><span class="nv">2</span><span class="si">}</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
       strcmp <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> <span class="s2">&quot;</span><span class="nv">$2</span><span class="s2">&quot;</span>
       <span class="k">return</span> <span class="nv">$?</span>
    <span class="k">else</span>
       <span class="nv">s1</span><span class="o">=</span><span class="si">${</span><span class="nv">1</span><span class="p">:</span><span class="nv">0</span><span class="p">:</span><span class="nv">$3</span><span class="si">}</span>
       <span class="nv">s2</span><span class="o">=</span><span class="si">${</span><span class="nv">2</span><span class="p">:</span><span class="nv">0</span><span class="p">:</span><span class="nv">$3</span><span class="si">}</span>
       strcmp <span class="nv">$s1</span> <span class="nv">$s2</span>
       <span class="k">return</span> <span class="nv">$?</span>
    <span class="k">fi</span>
<span class="o">}</span>

<span class="c">#:docstring strlen:</span>
<span class="c"># Usage: strlen s</span>
<span class="c">#</span>
<span class="c"># Strlen returns the number of characters in string literal s.</span>
<span class="c">#:end docstring:</span>

<span class="c">###;;;autoload</span>
<span class="k">function</span> strlen <span class="o">()</span>
<span class="o">{</span>
    <span class="nb">eval echo</span> <span class="s2">&quot;\${#</span><span class="si">${</span><span class="nv">1</span><span class="si">}</span><span class="s2">}&quot;</span>
    <span class="c"># ==&gt; Returns the length of the value of the variable</span>
    <span class="c"># ==&gt; whose name is passed as an argument.</span>
<span class="o">}</span>

<span class="c">#:docstring strspn:</span>
<span class="c"># Usage: strspn $s1 $s2</span>
<span class="c">#</span>
<span class="c"># Strspn returns the length of the maximum initial segment of string s1,</span>
<span class="c"># which consists entirely of characters from string s2.</span>
<span class="c">#:end docstring:</span>

<span class="c">###;;;autoload</span>
<span class="k">function</span> strspn <span class="o">()</span>
<span class="o">{</span>
    <span class="c"># Unsetting IFS allows whitespace to be handled as normal chars.</span>
    <span class="nb">local </span><span class="nv">IFS</span><span class="o">=</span>
    <span class="nb">local </span><span class="nv">result</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">1</span><span class="p">%%[!</span><span class="si">${</span><span class="nv">2</span><span class="si">}</span><span class="p">]*</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="nb">echo</span> <span class="si">${#</span><span class="nv">result</span><span class="si">}</span>
<span class="o">}</span>

<span class="c">#:docstring strcspn:</span>
<span class="c"># Usage: strcspn $s1 $s2</span>
<span class="c">#</span>
<span class="c"># Strcspn returns the length of the maximum initial segment of string s1,</span>
<span class="c"># which consists entirely of characters not from string s2.</span>
<span class="c">#:end docstring:</span>

<span class="c">###;;;autoload</span>
<span class="k">function</span> strcspn <span class="o">()</span>
<span class="o">{</span>
    <span class="c"># Unsetting IFS allows whitspace to be handled as normal chars.</span>
    <span class="nb">local </span><span class="nv">IFS</span><span class="o">=</span>
    <span class="nb">local </span><span class="nv">result</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">1</span><span class="p">%%[</span><span class="si">${</span><span class="nv">2</span><span class="si">}</span><span class="p">]*</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="nb">echo</span> <span class="si">${#</span><span class="nv">result</span><span class="si">}</span>
<span class="o">}</span>

<span class="c">#:docstring strstr:</span>
<span class="c"># Usage: strstr s1 s2</span>
<span class="c">#</span>
<span class="c"># Strstr echoes a substring starting at the first occurrence of string s2 in</span>
<span class="c"># string s1, or nothing if s2 does not occur in the string.  If s2 points to</span>
<span class="c"># a string of zero length, strstr echoes s1.</span>
<span class="c">#:end docstring:</span>

<span class="c">###;;;autoload</span>
<span class="k">function</span> strstr <span class="o">()</span>
<span class="o">{</span>
    <span class="c"># if s2 points to a string of zero length, strstr echoes s1</span>
    <span class="o">[</span> <span class="si">${#</span><span class="nv">2</span><span class="si">}</span> -eq <span class="m">0</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">{</span> <span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> <span class="p">;</span> <span class="k">return</span> 0<span class="p">;</span> <span class="o">}</span>

    <span class="c"># strstr echoes nothing if s2 does not occur in s1</span>
    <span class="k">case</span> <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> in
    *<span class="nv">$2</span>*<span class="o">)</span> <span class="p">;;</span>
    *<span class="o">)</span> <span class="k">return</span> 1<span class="p">;;</span>
    <span class="k">esac</span>

    <span class="c"># use the pattern matching code to strip off the match and everything</span>
    <span class="c"># following it</span>
    <span class="nv">first</span><span class="o">=</span><span class="si">${</span><span class="nv">1</span><span class="p">/</span><span class="nv">$2</span><span class="p">*/</span><span class="si">}</span>

    <span class="c"># then strip off the first unmatched portion of the string</span>
    <span class="nb">echo</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">1</span><span class="p">##</span><span class="nv">$first</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="o">}</span>

<span class="c">#:docstring strtok:</span>
<span class="c"># Usage: strtok s1 s2</span>
<span class="c">#</span>
<span class="c"># Strtok considers the string s1 to consist of a sequence of zero or more</span>
<span class="c"># text tokens separated by spans of one or more characters from the</span>
<span class="c"># separator string s2.  The first call (with a non-empty string s1</span>
<span class="c"># specified) echoes a string consisting of the first token on stdout. The</span>
<span class="c"># function keeps track of its position in the string s1 between separate</span>
<span class="c"># calls, so that subsequent calls made with the first argument an empty</span>
<span class="c"># string will work through the string immediately following that token.  In</span>
<span class="c"># this way subsequent calls will work through the string s1 until no tokens</span>
<span class="c"># remain.  The separator string s2 may be different from call to call.</span>
<span class="c"># When no token remains in s1, an empty value is echoed on stdout.</span>
<span class="c">#:end docstring:</span>

<span class="c">###;;;autoload</span>
<span class="k">function</span> strtok <span class="o">()</span>
<span class="o">{</span>
 :
<span class="o">}</span>

<span class="c">#:docstring strtrunc:</span>
<span class="c"># Usage: strtrunc $n $s1 {$s2} {$...}</span>
<span class="c">#</span>
<span class="c"># Used by many functions like strncmp to truncate arguments for comparison.</span>
<span class="c"># Echoes the first n characters of each string s1 s2 ... on stdout.</span>
<span class="c">#:end docstring:</span>

<span class="c">###;;;autoload</span>
<span class="k">function</span> strtrunc <span class="o">()</span>
<span class="o">{</span>
    <span class="nv">n</span><span class="o">=</span><span class="nv">$1</span> <span class="p">;</span> <span class="nb">shift</span>
<span class="nb">    </span><span class="k">for</span> z<span class="p">;</span> <span class="k">do</span>
        <span class="nb">echo</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">z</span><span class="p">:</span><span class="nv">0</span><span class="p">:</span><span class="nv">$n</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">done</span>
<span class="o">}</span>

<span class="c"># provide string</span>

<span class="c"># string.bash ends here</span>


<span class="c"># ========================================================================== #</span>
<span class="c"># ==&gt; Everything below here added by the document author.</span>

<span class="c"># ==&gt; Suggested use of this script is to delete everything below here,</span>
<span class="c"># ==&gt; and &quot;source&quot; this file into your own scripts.</span>

<span class="c"># strcat</span>
<span class="nv">string0</span><span class="o">=</span>one
<span class="nv">string1</span><span class="o">=</span>two
<span class="nb">echo</span>
<span class="nb">echo</span> <span class="s2">&quot;Testing \&quot;strcat\&quot; function:&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;Original \&quot;string0\&quot; = </span><span class="nv">$string0</span><span class="s2">&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;\&quot;string1\&quot; = </span><span class="nv">$string1</span><span class="s2">&quot;</span>
strcat string0 string1
<span class="nb">echo</span> <span class="s2">&quot;New \&quot;string0\&quot; = </span><span class="nv">$string0</span><span class="s2">&quot;</span>
<span class="nb">echo</span>

<span class="c"># strlen</span>
<span class="nb">echo</span>
<span class="nb">echo</span> <span class="s2">&quot;Testing \&quot;strlen\&quot; function:&quot;</span>
<span class="nv">str</span><span class="o">=</span>123456789
<span class="nb">echo</span> <span class="s2">&quot;\&quot;str\&quot; = </span><span class="nv">$str</span><span class="s2">&quot;</span>
<span class="nb">echo</span> -n <span class="s2">&quot;Length of \&quot;str\&quot; = &quot;</span>
strlen str
<span class="nb">echo</span>



<span class="c"># Exercise:</span>
<span class="c"># --------</span>
<span class="c"># Add code to test all the other string functions above.</span>


<span class="nb">exit </span>0
</pre></div>
</div>
<p>Michael Zick&#8217;s complex array example uses the
<a class="reference external" href="filearchiv.html#MD5SUMREF">md5sum</a> check sum command to encode
directory information.</p>
</div>
<div class="section" id="exemple-19-directory-information">
<h2>Exemple 19. Directory information<a class="headerlink" href="#exemple-19-directory-information" title="Link permanent a aquest títol">¶</a></h2>
<div class="highlight-sh"><div class="highlight"><pre><span class="c">#! /bin/bash</span>
<span class="c"># directory-info.sh</span>
<span class="c"># Parses and lists directory information.</span>

<span class="c"># NOTE: Change lines 273 and 353 per &quot;README&quot; file.</span>

<span class="c"># Michael Zick is the author of this script.</span>
<span class="c"># Used here with his permission.</span>

<span class="c"># Controls</span>
<span class="c"># If overridden by command arguments, they must be in the order:</span>
<span class="c">#   Arg1: &quot;Descriptor Directory&quot;</span>
<span class="c">#   Arg2: &quot;Exclude Paths&quot;</span>
<span class="c">#   Arg3: &quot;Exclude Directories&quot;</span>
<span class="c">#</span>
<span class="c"># Environment Settings override Defaults.</span>
<span class="c"># Command arguments override Environment Settings.</span>

<span class="c"># Default location for content addressed file descriptors.</span>
<span class="nv">MD5UCFS</span><span class="o">=</span><span class="si">${</span><span class="nv">1</span><span class="k">:-</span><span class="si">${</span><span class="nv">MD5UCFS</span><span class="k">:-</span><span class="s1">&#39;/tmpfs/ucfs&#39;</span><span class="si">}}</span>

<span class="c"># Directory paths never to list or enter</span>
<span class="nb">declare</span> -a <span class="se">\</span>
  <span class="nv">EXCLUDE_PATHS</span><span class="o">=</span><span class="si">${</span><span class="nv">2</span><span class="k">:-</span><span class="si">${</span><span class="nv">EXCLUDE_PATHS</span><span class="k">:-</span><span class="s1">&#39;(/proc /dev /devfs /tmpfs)&#39;</span><span class="si">}}</span>

<span class="c"># Directories never to list or enter</span>
<span class="nb">declare</span> -a <span class="se">\</span>
  <span class="nv">EXCLUDE_DIRS</span><span class="o">=</span><span class="si">${</span><span class="nv">3</span><span class="k">:-</span><span class="si">${</span><span class="nv">EXCLUDE_DIRS</span><span class="k">:-</span><span class="s1">&#39;(ucfs lost+found tmp wtmp)&#39;</span><span class="si">}}</span>

<span class="c"># Files never to list or enter</span>
<span class="nb">declare</span> -a <span class="se">\</span>
  <span class="nv">EXCLUDE_FILES</span><span class="o">=</span><span class="si">${</span><span class="nv">3</span><span class="k">:-</span><span class="si">${</span><span class="nv">EXCLUDE_FILES</span><span class="k">:-</span><span class="s1">&#39;(core &quot;Name with Spaces&quot;)&#39;</span><span class="si">}}</span>


<span class="c"># Here document used as a comment block.</span>
: <span class="s">&lt;&lt;LSfieldsDoc</span>
<span class="s"># # # # # List Filesystem Directory Information # # # # #</span>
<span class="s">#</span>
<span class="s">#   ListDirectory &quot;FileGlob&quot; &quot;Field-Array-Name&quot;</span>
<span class="s"># or</span>
<span class="s">#   ListDirectory -of &quot;FileGlob&quot; &quot;Field-Array-Filename&quot;</span>
<span class="s">#   &#39;-of&#39; meaning &#39;output to filename&#39;</span>
<span class="s"># # # # #</span>

<span class="s">String format description based on: ls (GNU fileutils) version 4.0.36</span>

<span class="s">Produces a line (or more) formatted:</span>
<span class="s">inode permissions hard-links owner group ...</span>
<span class="s">32736 -rw-------    1 mszick   mszick</span>

<span class="s">size    day month date hh:mm:ss year path</span>
<span class="s">2756608 Sun Apr 20 08:53:06 2003 /home/mszick/core</span>

<span class="s">Unless it is formatted:</span>
<span class="s">inode permissions hard-links owner group ...</span>
<span class="s">266705 crw-rw----    1    root  uucp</span>

<span class="s">major minor day month date hh:mm:ss year path</span>
<span class="s">4,  68 Sun Apr 20 09:27:33 2003 /dev/ttyS4</span>
<span class="s">NOTE: that pesky comma after the major number</span>

<span class="s">NOTE: the &#39;path&#39; may be multiple fields:</span>
<span class="s">/home/mszick/core</span>
<span class="s">/proc/982/fd/0 -&gt; /dev/null</span>
<span class="s">/proc/982/fd/1 -&gt; /home/mszick/.xsession-errors</span>
<span class="s">/proc/982/fd/13 -&gt; /tmp/tmpfZVVOCs (deleted)</span>
<span class="s">/proc/982/fd/7 -&gt; /tmp/kde-mszick/ksycoca</span>
<span class="s">/proc/982/fd/8 -&gt; socket:[11586]</span>
<span class="s">/proc/982/fd/9 -&gt; pipe:[11588]</span>

<span class="s">If that isn&#39;t enough to keep your parser guessing,</span>
<span class="s">either or both of the path components may be relative:</span>
<span class="s">../Built-Shared -&gt; Built-Static</span>
<span class="s">../linux-2.4.20.tar.bz2 -&gt; ../../../SRCS/linux-2.4.20.tar.bz2</span>

<span class="s">The first character of the 11 (10?) character permissions field:</span>
<span class="s">&#39;s&#39; Socket</span>
<span class="s">&#39;d&#39; Directory</span>
<span class="s">&#39;b&#39; Block device</span>
<span class="s">&#39;c&#39; Character device</span>
<span class="s">&#39;l&#39; Symbolic link</span>
<span class="s">NOTE: Hard links not marked - test for identical inode numbers</span>
<span class="s">on identical filesystems.</span>
<span class="s">All information about hard linked files are shared, except</span>
<span class="s">for the names and the name&#39;s location in the directory system.</span>
<span class="s">NOTE: A &quot;Hard link&quot; is known as a &quot;File Alias&quot; on some systems.</span>
<span class="s">&#39;-&#39; An undistingushed file</span>

<span class="s">Followed by three groups of letters for: User, Group, Others</span>
<span class="s">Character 1: &#39;-&#39; Not readable; &#39;r&#39; Readable</span>
<span class="s">Character 2: &#39;-&#39; Not writable; &#39;w&#39; Writable</span>
<span class="s">Character 3, User and Group: Combined execute and special</span>
<span class="s">&#39;-&#39; Not Executable, Not Special</span>
<span class="s">&#39;x&#39; Executable, Not Special</span>
<span class="s">&#39;s&#39; Executable, Special</span>
<span class="s">&#39;S&#39; Not Executable, Special</span>
<span class="s">Character 3, Others: Combined execute and sticky (tacky?)</span>
<span class="s">&#39;-&#39; Not Executable, Not Tacky</span>
<span class="s">&#39;x&#39; Executable, Not Tacky</span>
<span class="s">&#39;t&#39; Executable, Tacky</span>
<span class="s">&#39;T&#39; Not Executable, Tacky</span>

<span class="s">Followed by an access indicator</span>
<span class="s">Haven&#39;t tested this one, it may be the eleventh character</span>
<span class="s">or it may generate another field</span>
<span class="s">&#39; &#39; No alternate access</span>
<span class="s">&#39;+&#39; Alternate access</span>
<span class="s">LSfieldsDoc</span>


ListDirectory<span class="o">()</span>
<span class="o">{</span>
    <span class="nb">local</span> -a T
    <span class="nb">local</span> -i <span class="nv">of</span><span class="o">=</span><span class="m">0</span>       <span class="c"># Default return in variable</span>
<span class="c">#   OLD_IFS=$IFS        # Using BASH default &#39; \t\n&#39;</span>

    <span class="k">case</span> <span class="s2">&quot;</span><span class="nv">$#&quot;</span><span class="s2"> in</span>
<span class="s2">    3)  case &quot;</span><span class="nv">$1</span><span class="s2">&quot; in</span>
<span class="s2">        -of)    of=1 ; shift ;;</span>
<span class="s2">         * )    return 1 ;;</span>
<span class="s2">        esac ;;</span>
<span class="s2">    2)  : ;;        # Poor man&#39;s &quot;</span><span class="k">continue</span><span class="s2">&quot;</span>
<span class="s2">    *)  return 1 ;;</span>
<span class="s2">    esac</span>

<span class="s2">    # NOTE: the (ls) command is NOT quoted (&quot;</span><span class="o">)</span>
    <span class="nv">T</span><span class="o">=(</span> <span class="k">$(</span>ls --inode --ignore-backups --almost-all --directory <span class="se">\</span>
    --full-time --color<span class="o">=</span>none --time<span class="o">=</span>status --sort<span class="o">=</span>none <span class="se">\</span>
    --format<span class="o">=</span>long <span class="nv">$1</span><span class="k">)</span> <span class="o">)</span>

    <span class="k">case</span> <span class="nv">$of</span> in
    <span class="c"># Assign T back to the array whose name was passed as $2</span>
        0<span class="o">)</span> <span class="nb">eval</span> <span class="nv">$2</span><span class="o">=</span><span class="se">\(</span> <span class="se">\&quot;\$\{</span>T<span class="se">\[</span>@<span class="se">\]\}\&quot;</span> <span class="se">\)</span> <span class="p">;;</span>
    <span class="c"># Write T into filename passed as $2</span>
        1<span class="o">)</span> <span class="nb">echo</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">T</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span> &gt; <span class="s2">&quot;</span><span class="nv">$2</span><span class="s2">&quot;</span> <span class="p">;;</span>
    <span class="k">esac</span>
    <span class="k">return</span> 0
   <span class="o">}</span>

<span class="c"># # # # # Is that string a legal number? # # # # #</span>
<span class="c">#</span>
<span class="c">#   IsNumber &quot;Var&quot;</span>
<span class="c"># # # # # There has to be a better way, sigh...</span>

IsNumber<span class="o">()</span>
<span class="o">{</span>
    <span class="nb">local</span> -i int
    <span class="k">if</span> <span class="o">[</span> <span class="nv">$# </span>-eq <span class="m">0</span> <span class="o">]</span>
    <span class="k">then</span>
        <span class="k">return</span> 1
    <span class="k">else</span>
        <span class="o">(</span><span class="nb">let </span><span class="nv">int</span><span class="o">=</span><span class="nv">$1</span><span class="o">)</span>  2&gt;/dev/null
        <span class="k">return</span> <span class="nv">$?</span>   <span class="c"># Exit status of the let thread</span>
    <span class="k">fi</span>
<span class="o">}</span>

<span class="c"># # # # # Index Filesystem Directory Information # # # # #</span>
<span class="c">#</span>
<span class="c">#   IndexList &quot;Field-Array-Name&quot; &quot;Index-Array-Name&quot;</span>
<span class="c"># or</span>
<span class="c">#   IndexList -if Field-Array-Filename Index-Array-Name</span>
<span class="c">#   IndexList -of Field-Array-Name Index-Array-Filename</span>
<span class="c">#   IndexList -if -of Field-Array-Filename Index-Array-Filename</span>
<span class="c"># # # # #</span>

: <span class="s">&lt;&lt;IndexListDoc</span>
<span class="s">Walk an array of directory fields produced by ListDirectory</span>

<span class="s">Having suppressed the line breaks in an otherwise line oriented</span>
<span class="s">report, build an index to the array element which starts each line.</span>

<span class="s">Each line gets two index entries, the first element of each line</span>
<span class="s">(inode) and the element that holds the pathname of the file.</span>

<span class="s">The first index entry pair (Line-Number==0) are informational:</span>
<span class="s">Index-Array-Name[0] : Number of &quot;Lines&quot; indexed</span>
<span class="s">Index-Array-Name[1] : &quot;Current Line&quot; pointer into Index-Array-Name</span>

<span class="s">The following index pairs (if any) hold element indexes into</span>
<span class="s">the Field-Array-Name per:</span>
<span class="s">Index-Array-Name[Line-Number * 2] : The &quot;inode&quot; field element.</span>
<span class="s">NOTE: This distance may be either +11 or +12 elements.</span>
<span class="s">Index-Array-Name[(Line-Number * 2) + 1] : The &quot;pathname&quot; element.</span>
<span class="s">NOTE: This distance may be a variable number of elements.</span>
<span class="s">Next line index pair for Line-Number+1.</span>
<span class="s">IndexListDoc</span>



IndexList<span class="o">()</span>
<span class="o">{</span>
    <span class="nb">local</span> -a LIST           <span class="c"># Local of listname passed</span>
    <span class="nb">local</span> -a -i <span class="nv">INDEX</span><span class="o">=(</span> <span class="m">0</span> <span class="m">0</span> <span class="o">)</span>   <span class="c"># Local of index to return</span>
    <span class="nb">local</span> -i Lidx Lcnt
    <span class="nb">local</span> -i <span class="k">if</span><span class="o">=</span><span class="m">0</span> <span class="nv">of</span><span class="o">=</span><span class="m">0</span>      <span class="c"># Default to variable names</span>

    <span class="k">case</span> <span class="s2">&quot;</span><span class="nv">$#&quot;</span><span class="s2"> in            # Simplistic option testing</span>
<span class="s2">        0) return 1 ;;</span>
<span class="s2">        1) return 1 ;;</span>
<span class="s2">        2) : ;;         # Poor man&#39;s continue</span>
<span class="s2">        3) case &quot;</span><span class="nv">$1</span><span class="s2">&quot; in</span>
<span class="s2">            -if) if=1 ;;</span>
<span class="s2">            -of) of=1 ;;</span>
<span class="s2">             * ) return 1 ;;</span>
<span class="s2">           esac ; shift ;;</span>
<span class="s2">        4) if=1 ; of=1 ; shift ; shift ;;</span>
<span class="s2">        *) return 1</span>
<span class="s2">    esac</span>

<span class="s2">    # Make local copy of list</span>
<span class="s2">    case &quot;</span><span class="nv">$if</span><span class="s2">&quot; in</span>
<span class="s2">        0) eval LIST=\( \&quot;\$\{</span><span class="nv">$1</span><span class="s2">\[@\]\}\&quot; \) ;;</span>
<span class="s2">        1) LIST=( </span><span class="k">$(</span>cat <span class="nv">$1</span><span class="k">)</span><span class="s2"> ) ;;</span>
<span class="s2">    esac</span>

<span class="s2">    # Grok (grope?) the array</span>
<span class="s2">    Lcnt=</span><span class="si">${#</span><span class="nv">LIST</span><span class="p">[@]</span><span class="si">}</span><span class="s2"></span>
<span class="s2">    Lidx=0</span>
<span class="s2">    until (( Lidx &gt;= Lcnt ))</span>
<span class="s2">    do</span>
<span class="s2">    if IsNumber </span><span class="si">${</span><span class="nv">LIST</span><span class="p">[</span><span class="nv">$Lidx</span><span class="p">]</span><span class="si">}</span><span class="s2"></span>
<span class="s2">    then</span>
<span class="s2">        local -i inode name</span>
<span class="s2">        local ft</span>
<span class="s2">        inode=Lidx</span>
<span class="s2">        local m=</span><span class="si">${</span><span class="nv">LIST</span><span class="p">[</span><span class="nv">$Lidx</span><span class="p">+2]</span><span class="si">}</span><span class="s2">    # Hard Links field</span>
<span class="s2">        ft=</span><span class="si">${</span><span class="nv">LIST</span><span class="p">[</span><span class="nv">$Lidx</span><span class="p">+1]:</span><span class="nv">0</span><span class="p">:</span><span class="nv">1</span><span class="si">}</span><span class="s2">     # Fast-Stat</span>
<span class="s2">        case </span><span class="nv">$ft</span><span class="s2"> in</span>
<span class="s2">        b)  ((Lidx+=12)) ;;     # Block device</span>
<span class="s2">        c)  ((Lidx+=12)) ;;     # Character device</span>
<span class="s2">        *)  ((Lidx+=11)) ;;     # Anything else</span>
<span class="s2">        esac</span>
<span class="s2">        name=Lidx</span>
<span class="s2">        case </span><span class="nv">$ft</span><span class="s2"> in</span>
<span class="s2">        -)  ((Lidx+=1)) ;;      # The easy one</span>
<span class="s2">        b)  ((Lidx+=1)) ;;      # Block device</span>
<span class="s2">        c)  ((Lidx+=1)) ;;      # Character device</span>
<span class="s2">        d)  ((Lidx+=1)) ;;      # The other easy one</span>
<span class="s2">        l)  ((Lidx+=3)) ;;      # At LEAST two more fields</span>
<span class="s2">#  A little more elegance here would handle pipes,</span>
<span class="s2">#+ sockets, deleted files - later.</span>
<span class="s2">        *)  until IsNumber </span><span class="si">${</span><span class="nv">LIST</span><span class="p">[</span><span class="nv">$Lidx</span><span class="p">]</span><span class="si">}</span><span class="s2"> |((Lidx &gt;= Lcnt))</span>
<span class="s2">            do</span>
<span class="s2">                ((Lidx+=1))</span>
<span class="s2">            done</span>
<span class="s2">            ;;          # Not required</span>
<span class="s2">        esac</span>
<span class="s2">        INDEX[</span><span class="si">${#</span><span class="nv">INDEX</span><span class="p">[*]</span><span class="si">}</span><span class="s2">]=</span><span class="nv">$inode</span><span class="s2"></span>
<span class="s2">        INDEX[</span><span class="si">${#</span><span class="nv">INDEX</span><span class="p">[*]</span><span class="si">}</span><span class="s2">]=</span><span class="nv">$name</span><span class="s2"></span>
<span class="s2">        INDEX[0]=</span><span class="si">${</span><span class="nv">INDEX</span><span class="p">[0]</span><span class="si">}</span><span class="s2">+1      # One more &quot;</span>line<span class="s2">&quot; found</span>
<span class="s2"># echo &quot;</span>Line: <span class="si">${</span><span class="nv">INDEX</span><span class="p">[0]</span><span class="si">}</span> Type: <span class="nv">$ft</span> Links: <span class="nv">$m</span> Inode: <span class="se">\</span>
<span class="c"># ${LIST[$inode]} Name: ${LIST[$name]}&quot;</span>

    <span class="k">else</span>
        <span class="o">((</span>Lidx+<span class="o">=</span>1<span class="o">))</span>
    <span class="k">fi</span>
    <span class="k">done</span>
    <span class="k">case</span> <span class="s2">&quot;</span><span class="nv">$of</span><span class="s2">&quot;</span> in
        0<span class="o">)</span> <span class="nb">eval</span> <span class="nv">$2</span><span class="o">=</span><span class="se">\(</span> <span class="se">\&quot;\$\{</span>INDEX<span class="se">\[</span>@<span class="se">\]\}\&quot;</span> <span class="se">\)</span> <span class="p">;;</span>
        1<span class="o">)</span> <span class="nb">echo</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">INDEX</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span> &gt; <span class="s2">&quot;</span><span class="nv">$2</span><span class="s2">&quot;</span> <span class="p">;;</span>
    <span class="k">esac</span>
    <span class="k">return</span> <span class="m">0</span>                <span class="c"># What could go wrong?</span>
<span class="o">}</span>

<span class="c"># # # # # Content Identify File # # # # #</span>
<span class="c">#</span>
<span class="c">#   DigestFile Input-Array-Name Digest-Array-Name</span>
<span class="c"># or</span>
<span class="c">#   DigestFile -if Input-FileName Digest-Array-Name</span>
<span class="c"># # # # #</span>

<span class="c"># Here document used as a comment block.</span>
: <span class="s">&lt;&lt;DigestFilesDoc</span>

<span class="s">The key (no pun intended) to a Unified Content File System (UCFS)</span>
<span class="s">is to distinguish the files in the system based on their content.</span>
<span class="s">Distinguishing files by their name is just so 20th Century.</span>

<span class="s">The content is distinguished by computing a checksum of that content.</span>
<span class="s">This version uses the md5sum program to generate a 128 bit checksum</span>
<span class="s">representative of the file&#39;s contents.</span>
<span class="s">There is a chance that two files having different content might</span>
<span class="s">generate the same checksum using md5sum (or any checksum).  Should</span>
<span class="s">that become a problem, then the use of md5sum can be replace by a</span>
<span class="s">cyrptographic signature.  But until then...</span>

<span class="s">The md5sum program is documented as outputting three fields (and it</span>
<span class="s">does), but when read it appears as two fields (array elements).  This</span>
<span class="s">is caused by the lack of whitespace between the second and third field.</span>
<span class="s">So this function gropes the md5sum output and returns:</span>
<span class="s">    [0] 32 character checksum in hexidecimal (UCFS filename)</span>
<span class="s">    [1] Single character: &#39; &#39; text file, &#39;*&#39; binary file</span>
<span class="s">    [2] Filesystem (20th Century Style) name</span>
<span class="s">    Note: That name may be the character &#39;-&#39; indicating STDIN read.</span>

<span class="s">DigestFilesDoc</span>



DigestFile<span class="o">()</span>
<span class="o">{</span>
    <span class="nb">local </span><span class="k">if</span><span class="o">=</span><span class="m">0</span>      <span class="c"># Default, variable name</span>
    <span class="nb">local</span> -a T1 T2

    <span class="k">case</span> <span class="s2">&quot;</span><span class="nv">$#&quot;</span><span class="s2"> in</span>
<span class="s2">    3)  case &quot;</span><span class="nv">$1</span><span class="s2">&quot; in</span>
<span class="s2">        -if)    if=1 ; shift ;;</span>
<span class="s2">         * )    return 1 ;;</span>
<span class="s2">        esac ;;</span>
<span class="s2">    2)  : ;;        # Poor man&#39;s &quot;</span><span class="k">continue</span><span class="s2">&quot;</span>
<span class="s2">    *)  return 1 ;;</span>
<span class="s2">    esac</span>

<span class="s2">    case </span><span class="nv">$if</span><span class="s2"> in</span>
<span class="s2">    0) eval T1=\( \&quot;\$\{</span><span class="nv">$1</span><span class="s2">\[@\]\}\&quot; \)</span>
<span class="s2">       T2=( </span><span class="k">$(</span><span class="nb">echo</span> <span class="si">${</span><span class="nv">T1</span><span class="p">[@]</span><span class="si">}</span>md5sum -<span class="k">)</span><span class="s2"> )</span>
<span class="s2">       ;;</span>
<span class="s2">    1) T2=( </span><span class="k">$(</span>md5sum <span class="nv">$1</span><span class="k">)</span><span class="s2"> )</span>
<span class="s2">       ;;</span>
<span class="s2">    esac</span>

<span class="s2">    case </span><span class="si">${#</span><span class="nv">T2</span><span class="p">[@]</span><span class="si">}</span><span class="s2"> in</span>
<span class="s2">    0) return 1 ;;</span>
<span class="s2">    1) return 1 ;;</span>
<span class="s2">    2) case </span><span class="si">${</span><span class="nv">T2</span><span class="p">[1]:</span><span class="nv">0</span><span class="p">:</span><span class="nv">1</span><span class="si">}</span><span class="s2"> in     # SanScrit-2.0.5</span>
<span class="s2">       \*) T2[</span><span class="si">${#</span><span class="nv">T2</span><span class="p">[@]</span><span class="si">}</span><span class="s2">]=</span><span class="si">${</span><span class="nv">T2</span><span class="p">[1]:</span><span class="nv">1</span><span class="si">}</span><span class="s2"></span>
<span class="s2">           T2[1]=\*</span>
<span class="s2">           ;;</span>
<span class="s2">        *) T2[</span><span class="si">${#</span><span class="nv">T2</span><span class="p">[@]</span><span class="si">}</span><span class="s2">]=</span><span class="si">${</span><span class="nv">T2</span><span class="p">[1]</span><span class="si">}</span><span class="s2"></span>
<span class="s2">           T2[1]=&quot;</span> <span class="s2">&quot;</span>
<span class="s2">           ;;</span>
<span class="s2">       esac</span>
<span class="s2">       ;;</span>
<span class="s2">    3) : ;; # Assume it worked</span>
<span class="s2">    *) return 1 ;;</span>
<span class="s2">    esac</span>

<span class="s2">    local -i len=</span><span class="si">${#</span><span class="nv">T2</span><span class="p">[0]</span><span class="si">}</span><span class="s2"></span>
<span class="s2">    if [ </span><span class="nv">$len</span><span class="s2"> -ne 32 ] ; then return 1 ; fi</span>
<span class="s2">    eval </span><span class="nv">$2</span><span class="s2">=\( \&quot;\$\{T2\[@\]\}\&quot; \)</span>
<span class="s2">}</span>

<span class="s2"># # # # # Locate File # # # # #</span>
<span class="s2">#</span>
<span class="s2">#   LocateFile [-l] FileName Location-Array-Name</span>
<span class="s2"># or</span>
<span class="s2">#   LocateFile [-l] -of FileName Location-Array-FileName</span>
<span class="s2"># # # # #</span>

<span class="s2"># A file location is Filesystem-id and inode-number</span>

<span class="s2"># Here document used as a comment block.</span>
<span class="s2">: &lt;&lt;StatFieldsDoc</span>
<span class="s2">    Based on stat, version 2.2</span>
<span class="s2">    stat -t and stat -lt fields</span>
<span class="s2">    [0] name</span>
<span class="s2">    [1] Total size</span>
<span class="s2">        File - number of bytes</span>
<span class="s2">        Symbolic link - string length of pathname</span>
<span class="s2">    [2] Number of (512 byte) blocks allocated</span>
<span class="s2">    [3] File type and Access rights (hex)</span>
<span class="s2">    [4] User ID of owner</span>
<span class="s2">    [5] Group ID of owner</span>
<span class="s2">    [6] Device number</span>
<span class="s2">    [7] Inode number</span>
<span class="s2">    [8] Number of hard links</span>
<span class="s2">    [9] Device type (if inode device) Major</span>
<span class="s2">    [10]    Device type (if inode device) Minor</span>
<span class="s2">    [11]    Time of last access</span>
<span class="s2">        May be disabled in &#39;mount&#39; with noatime</span>
<span class="s2">        atime of files changed by exec, read, pipe, utime, mknod (mmap?)</span>
<span class="s2">        atime of directories changed by addition/deletion of files</span>
<span class="s2">    [12]    Time of last modification</span>
<span class="s2">        mtime of files changed by write, truncate, utime, mknod</span>
<span class="s2">        mtime of directories changed by addtition/deletion of files</span>
<span class="s2">    [13]    Time of last change</span>
<span class="s2">        ctime reflects time of changed inode information (owner, group</span>
<span class="s2">        permissions, link count</span>
<span class="s2">-*-*- Per:</span>
<span class="s2">    Return code: 0</span>
<span class="s2">    Size of array: 14</span>
<span class="s2">    Contents of array</span>
<span class="s2">    Element 0: /home/mszick</span>
<span class="s2">    Element 1: 4096</span>
<span class="s2">    Element 2: 8</span>
<span class="s2">    Element 3: 41e8</span>
<span class="s2">    Element 4: 500</span>
<span class="s2">    Element 5: 500</span>
<span class="s2">    Element 6: 303</span>
<span class="s2">    Element 7: 32385</span>
<span class="s2">    Element 8: 22</span>
<span class="s2">    Element 9: 0</span>
<span class="s2">    Element 10: 0</span>
<span class="s2">    Element 11: 1051221030</span>
<span class="s2">    Element 12: 1051214068</span>
<span class="s2">    Element 13: 1051214068</span>

<span class="s2">    For a link in the form of linkname -&gt; realname</span>
<span class="s2">    stat -t  linkname returns the linkname (link) information</span>
<span class="s2">    stat -lt linkname returns the realname information</span>

<span class="s2">    stat -tf and stat -ltf fields</span>
<span class="s2">    [0] name</span>
<span class="s2">    [1] ID-0?       # Maybe someday, but Linux stat structure</span>
<span class="s2">    [2] ID-0?       # does not have either LABEL nor UUID</span>
<span class="s2">                # fields, currently information must come</span>
<span class="s2">                # from file-system specific utilities</span>
<span class="s2">    These will be munged into:</span>
<span class="s2">    [1] UUID if possible</span>
<span class="s2">    [2] Volume Label if possible</span>
<span class="s2">    Note: &#39;mount -l&#39; does return the label and could return the UUID</span>

<span class="s2">    [3] Maximum length of filenames</span>
<span class="s2">    [4] Filesystem type</span>
<span class="s2">    [5] Total blocks in the filesystem</span>
<span class="s2">    [6] Free blocks</span>
<span class="s2">    [7] Free blocks for non-root user(s)</span>
<span class="s2">    [8] Block size of the filesystem</span>
<span class="s2">    [9] Total inodes</span>
<span class="s2">    [10]    Free inodes</span>

<span class="s2">-*-*- Per:</span>
<span class="s2">    Return code: 0</span>
<span class="s2">    Size of array: 11</span>
<span class="s2">    Contents of array</span>
<span class="s2">    Element 0: /home/mszick</span>
<span class="s2">    Element 1: 0</span>
<span class="s2">    Element 2: 0</span>
<span class="s2">    Element 3: 255</span>
<span class="s2">    Element 4: ef53</span>
<span class="s2">    Element 5: 2581445</span>
<span class="s2">    Element 6: 2277180</span>
<span class="s2">    Element 7: 2146050</span>
<span class="s2">    Element 8: 4096</span>
<span class="s2">    Element 9: 1311552</span>
<span class="s2">    Element 10: 1276425</span>

<span class="s2">StatFieldsDoc</span>


<span class="s2">#   LocateFile [-l] FileName Location-Array-Name</span>
<span class="s2">#   LocateFile [-l] -of FileName Location-Array-FileName</span>

<span class="s2">LocateFile()</span>
<span class="s2">{</span>
<span class="s2">    local -a LOC LOC1 LOC2</span>
<span class="s2">    local lk=&quot;&quot; of=0</span>

<span class="s2">    case &quot;</span><span class="nv">$#&quot;</span> in
    0<span class="o">)</span> <span class="k">return</span> <span class="m">1</span> <span class="p">;;</span>
    1<span class="o">)</span> <span class="k">return</span> <span class="m">1</span> <span class="p">;;</span>
    2<span class="o">)</span> : <span class="p">;;</span>
    *<span class="o">)</span> <span class="k">while</span> <span class="o">((</span> <span class="s2">&quot;</span><span class="nv">$#&quot;</span><span class="s2"> &gt; 2 ))</span>
<span class="s2">       do</span>
<span class="s2">          case &quot;</span><span class="nv">$1</span><span class="s2">&quot; in</span>
<span class="s2">           -l) lk=-1 ;;</span>
<span class="s2">          -of) of=1 ;;</span>
<span class="s2">            *) return 1 ;;</span>
<span class="s2">          esac</span>
<span class="s2">       shift</span>
<span class="s2">           done ;;</span>
<span class="s2">    esac</span>

<span class="s2"># More Sanscrit-2.0.5</span>
<span class="s2">      # LOC1=( </span><span class="k">$(</span>stat -t <span class="nv">$lk</span> <span class="nv">$1</span><span class="k">)</span><span class="s2"> )</span>
<span class="s2">      # LOC2=( </span><span class="k">$(</span>stat -tf <span class="nv">$lk</span> <span class="nv">$1</span><span class="k">)</span><span class="s2"> )</span>
<span class="s2">      # Uncomment above two lines if system has &quot;</span>stat<span class="s2">&quot; command installed.</span>
<span class="s2">    LOC=( </span><span class="si">${</span><span class="nv">LOC1</span><span class="p">[@]:</span><span class="nv">0</span><span class="p">:</span><span class="nv">1</span><span class="si">}</span><span class="s2"> </span><span class="si">${</span><span class="nv">LOC1</span><span class="p">[@]:</span><span class="nv">3</span><span class="p">:</span><span class="nv">11</span><span class="si">}</span><span class="s2"></span>
<span class="s2">          </span><span class="si">${</span><span class="nv">LOC2</span><span class="p">[@]:</span><span class="nv">1</span><span class="p">:</span><span class="nv">2</span><span class="si">}</span><span class="s2"> </span><span class="si">${</span><span class="nv">LOC2</span><span class="p">[@]:</span><span class="nv">4</span><span class="p">:</span><span class="nv">1</span><span class="si">}</span><span class="s2"> )</span>

<span class="s2">    case &quot;</span><span class="nv">$of</span><span class="s2">&quot; in</span>
<span class="s2">        0) eval </span><span class="nv">$2</span><span class="s2">=\( \&quot;\$\{LOC\[@\]\}\&quot; \) ;;</span>
<span class="s2">        1) echo &quot;</span><span class="si">${</span><span class="nv">LOC</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot; &gt; &quot;</span><span class="nv">$2</span><span class="s2">&quot; ;;</span>
<span class="s2">    esac</span>
<span class="s2">    return 0</span>
<span class="s2"># Which yields (if you are lucky, and have &quot;</span>stat<span class="s2">&quot; installed)</span>
<span class="s2"># -*-*- Location Discriptor -*-*-</span>
<span class="s2">#   Return code: 0</span>
<span class="s2">#   Size of array: 15</span>
<span class="s2">#   Contents of array</span>
<span class="s2">#   Element 0: /home/mszick     20th Century name</span>
<span class="s2">#   Element 1: 41e8         Type and Permissions</span>
<span class="s2">#   Element 2: 500          User</span>
<span class="s2">#   Element 3: 500          Group</span>
<span class="s2">#   Element 4: 303          Device</span>
<span class="s2">#   Element 5: 32385        inode</span>
<span class="s2">#   Element 6: 22           Link count</span>
<span class="s2">#   Element 7: 0            Device Major</span>
<span class="s2">#   Element 8: 0            Device Minor</span>
<span class="s2">#   Element 9: 1051224608       Last Access</span>
<span class="s2">#   Element 10: 1051214068      Last Modify</span>
<span class="s2">#   Element 11: 1051214068      Last Status</span>
<span class="s2">#   Element 12: 0           UUID (to be)</span>
<span class="s2">#   Element 13: 0           Volume Label (to be)</span>
<span class="s2">#   Element 14: ef53        Filesystem type</span>
<span class="s2">}</span>



<span class="s2"># And then there was some test code</span>

<span class="s2">ListArray() # ListArray Name</span>
<span class="s2">{</span>
<span class="s2">    local -a Ta</span>

<span class="s2">    eval Ta=\( \&quot;\$\{</span><span class="nv">$1</span><span class="s2">\[@\]\}\&quot; \)</span>
<span class="s2">    echo</span>
<span class="s2">    echo &quot;</span>-*-*- List of Array -*-*-<span class="s2">&quot;</span>
<span class="s2">    echo &quot;</span>Size of array <span class="nv">$1</span>: <span class="si">${#</span><span class="nv">Ta</span><span class="p">[*]</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="s2">    echo &quot;</span>Contents of array <span class="nv">$1</span>:<span class="s2">&quot;</span>
<span class="s2">    for (( i=0 ; i&lt;</span><span class="si">${#</span><span class="nv">Ta</span><span class="p">[*]</span><span class="si">}</span><span class="s2"> ; i++ ))</span>
<span class="s2">    do</span>
<span class="s2">        echo -e &quot;</span><span class="se">\t</span>Element <span class="nv">$i</span>: <span class="si">${</span><span class="nv">Ta</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="s2">    done</span>
<span class="s2">    return 0</span>
<span class="s2">}</span>

<span class="s2">declare -a CUR_DIR</span>
<span class="s2"># For small arrays</span>
<span class="s2">ListDirectory &quot;</span><span class="si">${</span><span class="nv">PWD</span><span class="si">}</span><span class="s2">&quot; CUR_DIR</span>
<span class="s2">ListArray CUR_DIR</span>

<span class="s2">declare -a DIR_DIG</span>
<span class="s2">DigestFile CUR_DIR DIR_DIG</span>
<span class="s2">echo &quot;</span>The new <span class="se">\&quot;</span>name<span class="se">\&quot;</span> <span class="o">(</span>checksum<span class="o">)</span> <span class="k">for</span> <span class="si">${</span><span class="nv">CUR_DIR</span><span class="p">[9]</span><span class="si">}</span> is <span class="si">${</span><span class="nv">DIR_DIG</span><span class="p">[0]</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="s2">declare -a DIR_ENT</span>
<span class="s2"># BIG_DIR # For really big arrays - use a temporary file in ramdisk</span>
<span class="s2"># BIG-DIR # ListDirectory -of &quot;</span><span class="si">${</span><span class="nv">CUR_DIR</span><span class="p">[11]</span><span class="si">}</span>/*<span class="s2">&quot; &quot;</span>/tmpfs/junk2<span class="s2">&quot;</span>
<span class="s2">ListDirectory &quot;</span><span class="si">${</span><span class="nv">CUR_DIR</span><span class="p">[11]</span><span class="si">}</span>/*<span class="s2">&quot; DIR_ENT</span>

<span class="s2">declare -a DIR_IDX</span>
<span class="s2"># BIG-DIR # IndexList -if &quot;</span>/tmpfs/junk2<span class="s2">&quot; DIR_IDX</span>
<span class="s2">IndexList DIR_ENT DIR_IDX</span>

<span class="s2">declare -a IDX_DIG</span>
<span class="s2"># BIG-DIR # DIR_ENT=( </span><span class="k">$(</span>cat /tmpfs/junk2<span class="k">)</span><span class="s2"> )</span>
<span class="s2"># BIG-DIR # DigestFile -if /tmpfs/junk2 IDX_DIG</span>
<span class="s2">DigestFile DIR_ENT IDX_DIG</span>
<span class="s2"># Small (should) be able to parallize IndexList &amp; DigestFile</span>
<span class="s2"># Large (should) be able to parallize IndexList &amp; DigestFile &amp; the assignment</span>
<span class="s2">echo &quot;</span>The <span class="se">\&quot;</span>name<span class="se">\&quot;</span> <span class="o">(</span>checksum<span class="o">)</span> <span class="k">for</span> the contents of <span class="si">${</span><span class="nv">PWD</span><span class="si">}</span> is <span class="si">${</span><span class="nv">IDX_DIG</span><span class="p">[0]</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="s2">declare -a FILE_LOC</span>
<span class="s2">LocateFile </span><span class="si">${</span><span class="nv">PWD</span><span class="si">}</span><span class="s2"> FILE_LOC</span>
<span class="s2">ListArray FILE_LOC</span>

<span class="s2">exit 0</span>
</pre></div>
</div>
<p>Stéphane Chazelas demonstrates object-oriented programming in a Bash
script.</p>
<p>Mariusz Gniazdowski contributed a <a class="reference external" href="internal.html#HASHREF">hash</a>
library for use in scripts.</p>
</div>
<div class="section" id="exemple-20-library-of-hash-functions">
<h2>Exemple 20. Library of hash functions<a class="headerlink" href="#exemple-20-library-of-hash-functions" title="Link permanent a aquest títol">¶</a></h2>
<div class="highlight-sh"><div class="highlight"><pre><span class="c"># Hash:</span>
<span class="c"># Hash function library</span>
<span class="c"># Author: Mariusz Gniazdowski &lt;mariusz.gn-at-gmail.com&gt;</span>
<span class="c"># Date: 2005-04-07</span>

<span class="c"># Functions making emulating hashes in Bash a little less painful.</span>


<span class="c">#    Limitations:</span>
<span class="c">#  * Only global variables are supported.</span>
<span class="c">#  * Each hash instance generates one global variable per value.</span>
<span class="c">#  * Variable names collisions are possible</span>
<span class="c">#+   if you define variable like __hash__hashname_key</span>
<span class="c">#  * Keys must use chars that can be part of a Bash variable name</span>
<span class="c">#+   (no dashes, periods, etc.).</span>
<span class="c">#  * The hash is created as a variable:</span>
<span class="c">#    ... hashname_keyname</span>
<span class="c">#    So if somone will create hashes like:</span>
<span class="c">#      myhash_ + mykey = myhash__mykey</span>
<span class="c">#      myhash + _mykey = myhash__mykey</span>
<span class="c">#    Then there will be a collision.</span>
<span class="c">#    (This should not pose a major problem.)</span>


<span class="nv">Hash_config_varname_prefix</span><span class="o">=</span>__hash__


<span class="c"># Emulates:  hash[key]=value</span>
<span class="c">#</span>
<span class="c"># Params:</span>
<span class="c"># 1 - hash</span>
<span class="c"># 2 - key</span>
<span class="c"># 3 - value</span>
<span class="k">function</span> hash_set <span class="o">{</span>
    <span class="nb">eval</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">Hash_config_varname_prefix</span><span class="si">}${</span><span class="nv">1</span><span class="si">}</span><span class="s2">_</span><span class="si">${</span><span class="nv">2</span><span class="si">}</span><span class="s2">=\&quot;</span><span class="si">${</span><span class="nv">3</span><span class="si">}</span><span class="s2">\&quot;&quot;</span>
<span class="o">}</span>


<span class="c"># Emulates:  value=hash[key]</span>
<span class="c">#</span>
<span class="c"># Params:</span>
<span class="c"># 1 - hash</span>
<span class="c"># 2 - key</span>
<span class="c"># 3 - value (name of global variable to set)</span>
<span class="k">function</span> hash_get_into <span class="o">{</span>
    <span class="nb">eval</span> <span class="s2">&quot;</span><span class="nv">$3</span><span class="s2">=\&quot;\$</span><span class="si">${</span><span class="nv">Hash_config_varname_prefix</span><span class="si">}${</span><span class="nv">1</span><span class="si">}</span><span class="s2">_</span><span class="si">${</span><span class="nv">2</span><span class="si">}</span><span class="s2">\&quot;&quot;</span>
<span class="o">}</span>


<span class="c"># Emulates:  echo hash[key]</span>
<span class="c">#</span>
<span class="c"># Params:</span>
<span class="c"># 1 - hash</span>
<span class="c"># 2 - key</span>
<span class="c"># 3 - echo params (like -n, for example)</span>
<span class="k">function</span> hash_echo <span class="o">{</span>
    <span class="nb">eval</span> <span class="s2">&quot;echo </span><span class="nv">$3</span><span class="s2"> \&quot;\$</span><span class="si">${</span><span class="nv">Hash_config_varname_prefix</span><span class="si">}${</span><span class="nv">1</span><span class="si">}</span><span class="s2">_</span><span class="si">${</span><span class="nv">2</span><span class="si">}</span><span class="s2">\&quot;&quot;</span>
<span class="o">}</span>


<span class="c"># Emulates:  hash1[key1]=hash2[key2]</span>
<span class="c">#</span>
<span class="c"># Params:</span>
<span class="c"># 1 - hash1</span>
<span class="c"># 2 - key1</span>
<span class="c"># 3 - hash2</span>
<span class="c"># 4 - key2</span>
<span class="k">function</span> hash_copy <span class="o">{</span>
<span class="nb">eval</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">Hash_config_varname_prefix</span><span class="si">}${</span><span class="nv">1</span><span class="si">}</span><span class="s2">_</span><span class="si">${</span><span class="nv">2</span><span class="si">}</span><span class="s2">\</span>
<span class="s2">=\&quot;\$</span><span class="si">${</span><span class="nv">Hash_config_varname_prefix</span><span class="si">}${</span><span class="nv">3</span><span class="si">}</span><span class="s2">_</span><span class="si">${</span><span class="nv">4</span><span class="si">}</span><span class="s2">\&quot;&quot;</span>
<span class="o">}</span>


<span class="c"># Emulates:  hash[keyN-1]=hash[key2]=...hash[key1]</span>
<span class="c">#</span>
<span class="c"># Copies first key to rest of keys.</span>
<span class="c">#</span>
<span class="c"># Params:</span>
<span class="c"># 1 - hash1</span>
<span class="c"># 2 - key1</span>
<span class="c"># 3 - key2</span>
<span class="c"># . . .</span>
<span class="c"># N - keyN</span>
<span class="k">function</span> hash_dup <span class="o">{</span>
  <span class="nb">local </span><span class="nv">hashName</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> <span class="nv">keyName</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$2</span><span class="s2">&quot;</span>
  <span class="nb">shift </span>2
  <span class="k">until</span> <span class="o">[</span> <span class="si">${#}</span> -le <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">do</span>
    <span class="nb">eval</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">Hash_config_varname_prefix</span><span class="si">}${</span><span class="nv">hashName</span><span class="si">}</span><span class="s2">_</span><span class="si">${</span><span class="nv">1</span><span class="si">}</span><span class="s2">\</span>
<span class="s2">=\&quot;\$</span><span class="si">${</span><span class="nv">Hash_config_varname_prefix</span><span class="si">}${</span><span class="nv">hashName</span><span class="si">}</span><span class="s2">_</span><span class="si">${</span><span class="nv">keyName</span><span class="si">}</span><span class="s2">\&quot;&quot;</span>
  <span class="nb">shift</span><span class="p">;</span>
  <span class="k">done</span><span class="p">;</span>
<span class="o">}</span>


<span class="c"># Emulates:  unset hash[key]</span>
<span class="c">#</span>
<span class="c"># Params:</span>
<span class="c"># 1 - hash</span>
<span class="c"># 2 - key</span>
<span class="k">function</span> hash_unset <span class="o">{</span>
    <span class="nb">eval</span> <span class="s2">&quot;unset </span><span class="si">${</span><span class="nv">Hash_config_varname_prefix</span><span class="si">}${</span><span class="nv">1</span><span class="si">}</span><span class="s2">_</span><span class="si">${</span><span class="nv">2</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="o">}</span>


<span class="c"># Emulates something similar to:  ref=&amp;hash[key]</span>
<span class="c">#</span>
<span class="c"># The reference is name of the variable in which value is held.</span>
<span class="c">#</span>
<span class="c"># Params:</span>
<span class="c"># 1 - hash</span>
<span class="c"># 2 - key</span>
<span class="c"># 3 - ref - Name of global variable to set.</span>
<span class="k">function</span> hash_get_ref_into <span class="o">{</span>
    <span class="nb">eval</span> <span class="s2">&quot;</span><span class="nv">$3</span><span class="s2">=\&quot;</span><span class="si">${</span><span class="nv">Hash_config_varname_prefix</span><span class="si">}${</span><span class="nv">1</span><span class="si">}</span><span class="s2">_</span><span class="si">${</span><span class="nv">2</span><span class="si">}</span><span class="s2">\&quot;&quot;</span>
<span class="o">}</span>


<span class="c"># Emulates something similar to:  echo &amp;hash[key]</span>
<span class="c">#</span>
<span class="c"># That reference is name of variable in which value is held.</span>
<span class="c">#</span>
<span class="c"># Params:</span>
<span class="c"># 1 - hash</span>
<span class="c"># 2 - key</span>
<span class="c"># 3 - echo params (like -n for example)</span>
<span class="k">function</span> hash_echo_ref <span class="o">{</span>
    <span class="nb">eval</span> <span class="s2">&quot;echo </span><span class="nv">$3</span><span class="s2"> \&quot;</span><span class="si">${</span><span class="nv">Hash_config_varname_prefix</span><span class="si">}${</span><span class="nv">1</span><span class="si">}</span><span class="s2">_</span><span class="si">${</span><span class="nv">2</span><span class="si">}</span><span class="s2">\&quot;&quot;</span>
<span class="o">}</span>



<span class="c"># Emulates something similar to:  $$hash[key](param1, param2, ...)</span>
<span class="c">#</span>
<span class="c"># Params:</span>
<span class="c"># 1 - hash</span>
<span class="c"># 2 - key</span>
<span class="c"># 3,4, ... - Function parameters</span>
<span class="k">function</span> hash_call <span class="o">{</span>
  <span class="nb">local hash </span>key
  <span class="nb">hash</span><span class="o">=</span><span class="nv">$1</span>
  <span class="nv">key</span><span class="o">=</span><span class="nv">$2</span>
  <span class="nb">shift </span>2
  <span class="nb">eval</span> <span class="s2">&quot;eval \&quot;\$</span><span class="si">${</span><span class="nv">Hash_config_varname_prefix</span><span class="si">}${</span><span class="nv">hash</span><span class="si">}</span><span class="s2">_</span><span class="si">${</span><span class="nv">key</span><span class="si">}</span><span class="s2"> \\\&quot;\\\$@\\\&quot;\&quot;&quot;</span>
<span class="o">}</span>


<span class="c"># Emulates something similar to:  isset(hash[key]) or hash[key]==NULL</span>
<span class="c">#</span>
<span class="c"># Params:</span>
<span class="c"># 1 - hash</span>
<span class="c"># 2 - key</span>
<span class="c"># Returns:</span>
<span class="c"># 0 - there is such key</span>
<span class="c"># 1 - there is no such key</span>
<span class="k">function</span> hash_is_set <span class="o">{</span>
  <span class="nb">eval</span> <span class="s2">&quot;if [[ \&quot;\${</span><span class="si">${</span><span class="nv">Hash_config_varname_prefix</span><span class="si">}${</span><span class="nv">1</span><span class="si">}</span><span class="s2">_</span><span class="si">${</span><span class="nv">2</span><span class="si">}</span><span class="s2">-a}\&quot; = \&quot;a\&quot; &amp;&amp;</span>
<span class="s2">  \&quot;\${</span><span class="si">${</span><span class="nv">Hash_config_varname_prefix</span><span class="si">}${</span><span class="nv">1</span><span class="si">}</span><span class="s2">_</span><span class="si">${</span><span class="nv">2</span><span class="si">}</span><span class="s2">-b}\&quot; = \&quot;b\&quot; ]]</span>
<span class="s2">    then return 1; else return 0; fi&quot;</span>
<span class="o">}</span>


<span class="c"># Emulates something similar to:</span>
<span class="c">#   foreach($hash as $key =&gt; $value) { fun($key,$value); }</span>
<span class="c">#</span>
<span class="c"># It is possible to write different variations of this function.</span>
<span class="c"># Here we use a function call to make it as &quot;generic&quot; as possible.</span>
<span class="c">#</span>
<span class="c"># Params:</span>
<span class="c"># 1 - hash</span>
<span class="c"># 2 - function name</span>
<span class="k">function</span> hash_foreach <span class="o">{</span>
  <span class="nb">local </span>keyname <span class="nv">oldIFS</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$IFS</span><span class="s2">&quot;</span>
  <span class="nv">IFS</span><span class="o">=</span><span class="s1">&#39; &#39;</span>
  <span class="k">for</span> i in <span class="k">$(</span><span class="nb">eval</span> <span class="s2">&quot;echo \${!</span><span class="si">${</span><span class="nv">Hash_config_varname_prefix</span><span class="si">}${</span><span class="nv">1</span><span class="si">}</span><span class="s2">_*}&quot;</span><span class="k">)</span><span class="p">;</span> <span class="k">do</span>
    <span class="nv">keyname</span><span class="o">=</span><span class="k">$(</span><span class="nb">eval</span> <span class="s2">&quot;echo \${i##</span><span class="si">${</span><span class="nv">Hash_config_varname_prefix</span><span class="si">}${</span><span class="nv">1</span><span class="si">}</span><span class="s2">_}&quot;</span><span class="k">)</span>
    <span class="nb">eval</span> <span class="s2">&quot;</span><span class="nv">$2</span><span class="s2"> </span><span class="nv">$keyname</span><span class="s2"> \&quot;\$</span><span class="nv">$i</span><span class="s2">\&quot;&quot;</span>
  <span class="k">done</span>
<span class="nv">IFS</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$oldIFS</span><span class="s2">&quot;</span>
<span class="o">}</span>

<span class="c">#  NOTE: In lines 103 and 116, ampersand changed.</span>
<span class="c">#  But, it doesn&#39;t matter, because these are comment lines anyhow.</span>
</pre></div>
</div>
<p>Here is an example script using the foregoing hash library.</p>
</div>
<div class="section" id="exemple-21-colorizing-text-using-hash-functions">
<h2>Exemple 21. Colorizing text using hash functions<a class="headerlink" href="#exemple-21-colorizing-text-using-hash-functions" title="Link permanent a aquest títol">¶</a></h2>
<div class="highlight-sh"><div class="highlight"><pre>   <span class="c">#!/bin/bash</span>
   <span class="c"># hash-example.sh: Colorizing text.</span>
   <span class="c"># Author: Mariusz Gniazdowski &lt;mariusz.gn-at-gmail.com&gt;</span>

   . Hash.lib      <span class="c"># Load the library of functions.</span>

   hash_set colors red          <span class="s2">&quot;\033[0;31m&quot;</span>
   hash_set colors blue         <span class="s2">&quot;\033[0;34m&quot;</span>
   hash_set colors light_blue   <span class="s2">&quot;\033[1;34m&quot;</span>
   hash_set colors light_red    <span class="s2">&quot;\033[1;31m&quot;</span>
   hash_set colors cyan         <span class="s2">&quot;\033[0;36m&quot;</span>
   hash_set colors light_green  <span class="s2">&quot;\033[1;32m&quot;</span>
   hash_set colors light_gray   <span class="s2">&quot;\033[0;37m&quot;</span>
   hash_set colors green        <span class="s2">&quot;\033[0;32m&quot;</span>
   hash_set colors yellow       <span class="s2">&quot;\033[1;33m&quot;</span>
   hash_set colors light_purple <span class="s2">&quot;\033[1;35m&quot;</span>
   hash_set colors purple       <span class="s2">&quot;\033[0;35m&quot;</span>
   hash_set colors reset_color  <span class="s2">&quot;\033[0;00m&quot;</span>


   <span class="c"># $1 - keyname</span>
   <span class="c"># $2 - value</span>
   try_colors<span class="o">()</span> <span class="o">{</span>
       <span class="nb">echo</span> -en <span class="s2">&quot;</span><span class="nv">$2</span><span class="s2">&quot;</span>
       <span class="nb">echo</span> <span class="s2">&quot;This line is </span><span class="nv">$1</span><span class="s2">.&quot;</span>
   <span class="o">}</span>
   hash_foreach colors try_colors
   hash_echo colors reset_color -en

   <span class="nb">echo</span> -e <span class="s1">&#39;\nLet us overwrite some colors with yellow.\n&#39;</span>
   <span class="c"># It&#39;s hard to read yellow text on some terminals.</span>
   hash_dup colors yellow   red light_green blue green light_gray cyan
   hash_foreach colors try_colors
   hash_echo colors reset_color -en

   <span class="nb">echo</span> -e <span class="s1">&#39;\nLet us delete them and try colors once more . . .\n&#39;</span>

   <span class="k">for</span> i in red light_green blue green light_gray cyan<span class="p">;</span> <span class="k">do</span>
       hash_unset colors <span class="nv">$i</span>
   <span class="k">done</span>
   hash_foreach colors try_colors
   hash_echo colors reset_color -en

   hash_set other txt <span class="s2">&quot;Other examples . . .&quot;</span>
   hash_echo other txt
   hash_get_into other txt text
   <span class="nb">echo</span> <span class="nv">$text</span>

   hash_set other my_fun try_colors
   hash_call other my_fun   purple <span class="s2">&quot;`hash_echo colors purple`&quot;</span>
   hash_echo colors reset_color -en

   <span class="nb">echo</span><span class="p">;</span> <span class="nb">echo</span> <span class="s2">&quot;Back to normal?&quot;</span><span class="p">;</span> <span class="nb">echo</span>

<span class="nb">   exit</span> <span class="nv">$?</span>

   <span class="c">#  On some terminals, the &quot;light&quot; colors print in bold,</span>
   <span class="c">#  and end up looking darker than the normal ones.</span>
   <span class="c">#  Why is this?</span>




An example illustrating the mechanics of hashing, but from a different
</pre></div>
</div>
<p>point of view.</p>
</div>
<div class="section" id="exemple-22-more-on-hash-functions">
<h2>Exemple 22. More on hash functions<a class="headerlink" href="#exemple-22-more-on-hash-functions" title="Link permanent a aquest títol">¶</a></h2>
<div class="highlight-sh"><div class="highlight"><pre><span class="c">#!/bin/bash</span>
<span class="c"># $Id: ha.sh,v 1.2 2005/04/21 23:24:26 oliver Exp $</span>
<span class="c"># Copyright 2005 Oliver Beckstein</span>
<span class="c"># Released under the GNU Public License</span>
<span class="c"># Author of script granted permission for inclusion in ABS Guide.</span>
<span class="c"># (Thank you!)</span>

<span class="c">#----------------------------------------------------------------</span>
<span class="c"># pseudo hash based on indirect parameter expansion</span>
<span class="c"># API: access through functions:</span>
<span class="c">#</span>
<span class="c"># create the hash:</span>
<span class="c">#</span>
<span class="c">#      newhash Lovers</span>
<span class="c">#</span>
<span class="c"># add entries (note single quotes for spaces)</span>
<span class="c">#</span>
<span class="c">#      addhash Lovers Tristan Isolde</span>
<span class="c">#      addhash Lovers &#39;Romeo Montague&#39; &#39;Juliet Capulet&#39;</span>
<span class="c">#</span>
<span class="c"># access value by key</span>
<span class="c">#</span>
<span class="c">#      gethash Lovers Tristan   ----&gt;  Isolde</span>
<span class="c">#</span>
<span class="c"># show all keys</span>
<span class="c">#</span>
<span class="c">#      keyshash Lovers         ----&gt; &#39;Tristan&#39;  &#39;Romeo Montague&#39;</span>
<span class="c">#</span>
<span class="c">#</span>
<span class="c"># Convention: instead of perls&#39; foo{bar} = boing&#39; syntax,</span>
<span class="c"># use</span>
<span class="c">#       &#39;_foo_bar=boing&#39; (two underscores, no spaces)</span>
<span class="c">#</span>
<span class="c"># 1) store key   in _NAME_keys[]</span>
<span class="c"># 2) store value in _NAME_values[] using the same integer index</span>
<span class="c"># The integer index for the last entry is _NAME_ptr</span>
<span class="c">#</span>
<span class="c"># NOTE: No error or sanity checks, just bare bones.</span>


<span class="k">function</span> _inihash <span class="o">()</span> <span class="o">{</span>
    <span class="c"># private function</span>
    <span class="c"># call at the beginning of each procedure</span>
    <span class="c"># defines: _keys _values _ptr</span>
    <span class="c">#</span>
    <span class="c"># Usage: _inihash NAME</span>
    <span class="nb">local </span><span class="nv">name</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nv">_keys</span><span class="o">=</span>_<span class="si">${</span><span class="nv">name</span><span class="si">}</span>_keys
    <span class="nv">_values</span><span class="o">=</span>_<span class="si">${</span><span class="nv">name</span><span class="si">}</span>_values
    <span class="nv">_ptr</span><span class="o">=</span>_<span class="si">${</span><span class="nv">name</span><span class="si">}</span>_ptr
<span class="o">}</span>

<span class="k">function</span> newhash <span class="o">()</span> <span class="o">{</span>
    <span class="c"># Usage: newhash NAME</span>
    <span class="c">#        NAME should not contain spaces or dots.</span>
    <span class="c">#        Actually: it must be a legal name for a Bash variable.</span>
    <span class="c"># We rely on Bash automatically recognising arrays.</span>
    <span class="nb">local </span><span class="nv">name</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nb">local </span>_keys _values _ptr
    _inihash <span class="si">${</span><span class="nv">name</span><span class="si">}</span>
    <span class="nb">eval</span> <span class="si">${</span><span class="nv">_ptr</span><span class="si">}</span><span class="o">=</span>0
<span class="o">}</span>


<span class="k">function</span> addhash <span class="o">()</span> <span class="o">{</span>
    <span class="c"># Usage: addhash NAME KEY &#39;VALUE with spaces&#39;</span>
    <span class="c">#        arguments with spaces need to be quoted with single quotes &#39;&#39;</span>
    <span class="nb">local </span><span class="nv">name</span><span class="o">=</span><span class="nv">$1</span> <span class="nv">k</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$2</span><span class="s2">&quot;</span> <span class="nv">v</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$3</span><span class="s2">&quot;</span>
    <span class="nb">local </span>_keys _values _ptr
    _inihash <span class="si">${</span><span class="nv">name</span><span class="si">}</span>

    <span class="c">#echo &quot;DEBUG(addhash): ${_ptr}=${!_ptr}&quot;</span>

    <span class="nb">eval let</span> <span class="si">${</span><span class="nv">_ptr</span><span class="si">}</span><span class="o">=</span><span class="si">${</span><span class="nv">_ptr</span><span class="si">}</span>+1
    <span class="nb">eval</span> <span class="s2">&quot;</span><span class="nv">$_keys</span><span class="s2">[</span><span class="si">${</span><span class="p">!_ptr</span><span class="si">}</span><span class="s2">]=\&quot;</span><span class="si">${</span><span class="nv">k</span><span class="si">}</span><span class="s2">\&quot;&quot;</span>
    <span class="nb">eval</span> <span class="s2">&quot;</span><span class="nv">$_values</span><span class="s2">[</span><span class="si">${</span><span class="p">!_ptr</span><span class="si">}</span><span class="s2">]=\&quot;</span><span class="si">${</span><span class="nv">v</span><span class="si">}</span><span class="s2">\&quot;&quot;</span>
<span class="o">}</span>

<span class="k">function</span> gethash <span class="o">()</span> <span class="o">{</span>
    <span class="c">#  Usage: gethash NAME KEY</span>
    <span class="c">#         Returns boing</span>
    <span class="c">#         ERR=0 if entry found, 1 otherwise</span>
    <span class="c">#  That&#39;s not a proper hash --</span>
    <span class="c">#+ we simply linearly search through the keys.</span>
    <span class="nb">local </span><span class="nv">name</span><span class="o">=</span><span class="nv">$1</span> <span class="nv">key</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$2</span><span class="s2">&quot;</span>
    <span class="nb">local </span>_keys _values _ptr
    <span class="nb">local </span>k v i found h
    _inihash <span class="si">${</span><span class="nv">name</span><span class="si">}</span>

    <span class="c"># _ptr holds the highest index in the hash</span>
    <span class="nv">found</span><span class="o">=</span>0

    <span class="k">for</span> i in <span class="k">$(</span>seq <span class="m">1</span> <span class="si">${</span><span class="p">!_ptr</span><span class="si">}</span><span class="k">)</span><span class="p">;</span> <span class="k">do</span>
    <span class="nv">h</span><span class="o">=</span><span class="s2">&quot;\${</span><span class="si">${</span><span class="nv">_keys</span><span class="si">}</span><span class="s2">[</span><span class="si">${</span><span class="nv">i</span><span class="si">}</span><span class="s2">]}&quot;</span>  <span class="c">#  Safer to do it in two steps,</span>
    <span class="nb">eval </span><span class="nv">k</span><span class="o">=</span><span class="si">${</span><span class="nv">h</span><span class="si">}</span>             <span class="c">#+ especially when quoting for spaces.</span>
    <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">k</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">key</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span> <span class="nv">found</span><span class="o">=</span>1<span class="p">;</span> <span class="nb">break</span><span class="p">;</span> <span class="k">fi</span>
    <span class="k">done</span><span class="p">;</span>

    <span class="o">[</span> <span class="si">${</span><span class="nv">found</span><span class="si">}</span> <span class="o">=</span> <span class="m">0</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="k">return</span> 1<span class="p">;</span>
    <span class="c"># else: i is the index that matches the key</span>
    <span class="nv">h</span><span class="o">=</span><span class="s2">&quot;\${</span><span class="si">${</span><span class="nv">_values</span><span class="si">}</span><span class="s2">[</span><span class="si">${</span><span class="nv">i</span><span class="si">}</span><span class="s2">]}&quot;</span>
    <span class="nb">eval echo</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">h</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">return</span> 0<span class="p">;</span>
<span class="o">}</span>

<span class="k">function</span> keyshash <span class="o">()</span> <span class="o">{</span>
    <span class="c"># Usage: keyshash NAME</span>
    <span class="c"># Returns list of all keys defined for hash name.</span>
    <span class="nb">local </span><span class="nv">name</span><span class="o">=</span><span class="nv">$1</span> <span class="nv">key</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$2</span><span class="s2">&quot;</span>
    <span class="nb">local </span>_keys _values _ptr
    <span class="nb">local </span>k i h
    _inihash <span class="si">${</span><span class="nv">name</span><span class="si">}</span>

    <span class="c"># _ptr holds the highest index in the hash</span>
    <span class="k">for</span> i in <span class="k">$(</span>seq <span class="m">1</span> <span class="si">${</span><span class="p">!_ptr</span><span class="si">}</span><span class="k">)</span><span class="p">;</span> <span class="k">do</span>
    <span class="nv">h</span><span class="o">=</span><span class="s2">&quot;\${</span><span class="si">${</span><span class="nv">_keys</span><span class="si">}</span><span class="s2">[</span><span class="si">${</span><span class="nv">i</span><span class="si">}</span><span class="s2">]}&quot;</span>   <span class="c">#  Safer to do it in two steps,</span>
    <span class="nb">eval </span><span class="nv">k</span><span class="o">=</span><span class="si">${</span><span class="nv">h</span><span class="si">}</span>              <span class="c">#+ especially when quoting for spaces.</span>
    <span class="nb">echo</span> -n <span class="s2">&quot;&#39;</span><span class="si">${</span><span class="nv">k</span><span class="si">}</span><span class="s2">&#39; &quot;</span>
    <span class="k">done</span><span class="p">;</span>
<span class="o">}</span>


<span class="c"># -----------------------------------------------------------------------</span>

<span class="c"># Now, let&#39;s test it.</span>
<span class="c"># (Per comments at the beginning of the script.)</span>
newhash Lovers
addhash Lovers Tristan Isolde
addhash Lovers <span class="s1">&#39;Romeo Montague&#39;</span> <span class="s1">&#39;Juliet Capulet&#39;</span>

<span class="c"># Output results.</span>
<span class="nb">echo</span>
gethash Lovers Tristan      <span class="c"># Isolde</span>
<span class="nb">echo</span>
keyshash Lovers             <span class="c"># &#39;Tristan&#39; &#39;Romeo Montague&#39;</span>
<span class="nb">echo</span><span class="p">;</span> <span class="nb">echo</span>


<span class="nb">exit </span>0

<span class="c"># Exercise:</span>
<span class="c"># --------</span>

<span class="c"># Add error checks to the functions.</span>
</pre></div>
</div>
<p>Now for a script that installs and mounts those cute USB keychain
solid-state &#8220;hard drives.&#8221;</p>
</div>
<div class="section" id="exemple-23-mounting-usb-keychain-storage-devices">
<h2>Exemple 23. Mounting USB keychain storage devices<a class="headerlink" href="#exemple-23-mounting-usb-keychain-storage-devices" title="Link permanent a aquest títol">¶</a></h2>
<div class="highlight-sh"><div class="highlight"><pre><span class="c">#!/bin/bash</span>
<span class="c"># ==&gt; usb.sh</span>
<span class="c"># ==&gt; Script for mounting and installing pen/keychain USB storage devices.</span>
<span class="c"># ==&gt; Runs as root at system startup (see below).</span>
<span class="c"># ==&gt;</span>
<span class="c"># ==&gt; Newer Linux distros (2004 or later) autodetect</span>
<span class="c"># ==&gt; and install USB pen drives, and therefore don&#39;t need this script.</span>
<span class="c"># ==&gt; But, it&#39;s still instructive.</span>

<span class="c">#  This code is free software covered by GNU GPL license version 2 or above.</span>
<span class="c">#  Please refer to http://www.gnu.org/ for the full license text.</span>
<span class="c">#</span>
<span class="c">#  Some code lifted from usb-mount by Michael Hamilton&#39;s usb-mount (LGPL)</span>
<span class="c">#+ see http://users.actrix.co.nz/michael/usbmount.html</span>
<span class="c">#</span>
<span class="c">#  INSTALL</span>
<span class="c">#  -------</span>
<span class="c">#  Put this in /etc/hotplug/usb/diskonkey.</span>
<span class="c">#  Then look in /etc/hotplug/usb.distmap, and copy all usb-storage entries</span>
<span class="c">#+ into /etc/hotplug/usb.usermap, substituting &quot;usb-storage&quot; for &quot;diskonkey&quot;.</span>
<span class="c">#  Otherwise this code is only run during the kernel module invocation/removal</span>
<span class="c">#+ (at least in my tests), which defeats the purpose.</span>
<span class="c">#</span>
<span class="c">#  TODO</span>
<span class="c">#  ----</span>
<span class="c">#  Handle more than one diskonkey device at one time (e.g. /dev/diskonkey1</span>
<span class="c">#+ and /mnt/diskonkey1), etc. The biggest problem here is the handling in</span>
<span class="c">#+ devlabel, which I haven&#39;t yet tried.</span>
<span class="c">#</span>
<span class="c">#  AUTHOR and SUPPORT</span>
<span class="c">#  ------------------</span>
<span class="c">#  Konstantin Riabitsev, &lt;icon linux duke edu&gt;.</span>
<span class="c">#  Send any problem reports to my email address at the moment.</span>
<span class="c">#</span>
<span class="c"># ==&gt; Comments added by ABS Guide author.</span>



<span class="nv">SYMLINKDEV</span><span class="o">=</span>/dev/diskonkey
<span class="nv">MOUNTPOINT</span><span class="o">=</span>/mnt/diskonkey
<span class="nv">DEVLABEL</span><span class="o">=</span>/sbin/devlabel
<span class="nv">DEVLABELCONFIG</span><span class="o">=</span>/etc/sysconfig/devlabel
<span class="nv">IAM</span><span class="o">=</span><span class="nv">$0</span>

<span class="c">##</span>
<span class="c"># Functions lifted near-verbatim from usb-mount code.</span>
<span class="c">#</span>
<span class="k">function</span> allAttachedScsiUsb <span class="o">{</span>
  find /proc/scsi/ -path <span class="s1">&#39;/proc/scsi/usb-storage*&#39;</span> -type f
  xargs grep -l <span class="s1">&#39;Attached: Yes&#39;</span>
<span class="o">}</span>
<span class="k">function</span> scsiDevFromScsiUsb <span class="o">{</span>
  <span class="nb">echo</span> <span class="nv">$1awk</span> -F<span class="s2">&quot;[-/]&quot;</span> <span class="s1">&#39;{ n=$(NF-1);</span>
<span class="s1">  print &quot;/dev/sd&quot; substr(&quot;abcdefghijklmnopqrstuvwxyz&quot;, n+1, 1) }&#39;</span>
<span class="o">}</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">ACTION</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;add&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">[</span> -f <span class="s2">&quot;</span><span class="si">${</span><span class="nv">DEVICE</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="c">##</span>
    <span class="c"># lifted from usbcam code.</span>
    <span class="c">#</span>
    <span class="k">if</span> <span class="o">[</span> -f /var/run/console.lock <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        <span class="nv">CONSOLEOWNER</span><span class="o">=</span><span class="sb">`</span>cat /var/run/console.lock<span class="sb">`</span>
    <span class="k">elif</span> <span class="o">[</span> -f /var/lock/console.lock <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        <span class="nv">CONSOLEOWNER</span><span class="o">=</span><span class="sb">`</span>cat /var/lock/console.lock<span class="sb">`</span>
    <span class="k">else</span>
        <span class="nv">CONSOLEOWNER</span><span class="o">=</span>
    <span class="k">fi</span>
    <span class="k">for</span> procEntry in <span class="k">$(</span>allAttachedScsiUsb<span class="k">)</span><span class="p">;</span> <span class="k">do</span>
        <span class="nv">scsiDev</span><span class="o">=</span><span class="k">$(</span>scsiDevFromScsiUsb <span class="nv">$procEntry</span><span class="k">)</span>
        <span class="c">#  Some bug with usb-storage?</span>
        <span class="c">#  Partitions are not in /proc/partitions until they are accessed</span>
        <span class="c">#+ somehow.</span>
        /sbin/fdisk -l <span class="nv">$scsiDev</span> &gt;/dev/null
        <span class="c">##</span>
        <span class="c">#  Most devices have partitioning info, so the data would be on</span>
        <span class="c">#+ /dev/sd?1. However, some stupider ones don&#39;t have any partitioning</span>
        <span class="c">#+ and use the entire device for data storage. This tries to</span>
        <span class="c">#+ guess semi-intelligently if we have a /dev/sd?1 and if not, then</span>
        <span class="c">#+ it uses the entire device and hopes for the better.</span>
        <span class="c">#</span>
        <span class="k">if</span> grep -q <span class="sb">`</span>basename <span class="nv">$scsiDev</span><span class="sb">`</span><span class="m">1</span> /proc/partitions<span class="p">;</span> <span class="k">then</span>
            <span class="nv">part</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$scsiDev</span><span class="s2">&quot;&quot;1&quot;</span>
        <span class="k">else</span>
            <span class="nv">part</span><span class="o">=</span><span class="nv">$scsiDev</span>
        <span class="k">fi</span>
        <span class="c">##</span>
        <span class="c">#  Change ownership of the partition to the console user so they can</span>
        <span class="c">#+ mount it.</span>
        <span class="c">#</span>
        <span class="k">if</span> <span class="o">[</span> ! -z <span class="s2">&quot;</span><span class="nv">$CONSOLEOWNER</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
            chown <span class="nv">$CONSOLEOWNER</span>:disk <span class="nv">$part</span>
        <span class="k">fi</span>
        <span class="c">##</span>
        <span class="c"># This checks if we already have this UUID defined with devlabel.</span>
        <span class="c"># If not, it then adds the device to the list.</span>
        <span class="c">#</span>
        <span class="nv">prodid</span><span class="o">=</span><span class="sb">`</span><span class="nv">$DEVLABEL</span> printid -d <span class="nv">$part</span><span class="sb">`</span>
        <span class="k">if</span> ! grep -q <span class="nv">$prodid</span> <span class="nv">$DEVLABELCONFIG</span><span class="p">;</span> <span class="k">then</span>
            <span class="c"># cross our fingers and hope it works</span>
            <span class="nv">$DEVLABEL</span> add -d <span class="nv">$part</span> -s <span class="nv">$SYMLINKDEV</span> 2&gt;/dev/null
        <span class="k">fi</span>
        <span class="c">##</span>
        <span class="c"># Check if the mount point exists and create if it doesn&#39;t.</span>
        <span class="c">#</span>
        <span class="k">if</span> <span class="o">[</span> ! -e <span class="nv">$MOUNTPOINT</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
            mkdir -p <span class="nv">$MOUNTPOINT</span>
        <span class="k">fi</span>
        <span class="c">##</span>
        <span class="c"># Take care of /etc/fstab so mounting is easy.</span>
        <span class="c">#</span>
        <span class="k">if</span> ! grep -q <span class="s2">&quot;^</span><span class="nv">$SYMLINKDEV</span><span class="s2">&quot;</span> /etc/fstab<span class="p">;</span> <span class="k">then</span>
            <span class="c"># Add an fstab entry</span>
            <span class="nb">echo</span> -e <span class="se">\</span>
                <span class="s2">&quot;</span><span class="nv">$SYMLINKDEV</span><span class="s2">\t\t</span><span class="nv">$MOUNTPOINT</span><span class="s2">\t\tauto\tnoauto,owner,kudzu 0 0&quot;</span> <span class="se">\</span>
                &gt;&gt; /etc/fstab
        <span class="k">fi</span>
    <span class="k">done</span>
    <span class="k">if</span> <span class="o">[</span> ! -z <span class="s2">&quot;</span><span class="nv">$REMOVER</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        <span class="c">##</span>
        <span class="c"># Make sure this script is triggered on device removal.</span>
        <span class="c">#</span>
        mkdir -p <span class="sb">`</span>dirname <span class="nv">$REMOVER</span><span class="sb">`</span>
        ln -s <span class="nv">$IAM</span> <span class="nv">$REMOVER</span>
    <span class="k">fi</span>
<span class="k">elif</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">ACTION</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;remove&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="c">##</span>
    <span class="c"># If the device is mounted, unmount it cleanly.</span>
    <span class="c">#</span>
    <span class="k">if</span> grep -q <span class="s2">&quot;</span><span class="nv">$MOUNTPOINT</span><span class="s2">&quot;</span> /etc/mtab<span class="p">;</span> <span class="k">then</span>
        <span class="c"># unmount cleanly</span>
        umount -l <span class="nv">$MOUNTPOINT</span>
    <span class="k">fi</span>
    <span class="c">##</span>
    <span class="c"># Remove it from /etc/fstab if it&#39;s there.</span>
    <span class="c">#</span>
    <span class="k">if</span> grep -q <span class="s2">&quot;^</span><span class="nv">$SYMLINKDEV</span><span class="s2">&quot;</span> /etc/fstab<span class="p">;</span> <span class="k">then</span>
        grep -v <span class="s2">&quot;^</span><span class="nv">$SYMLINKDEV</span><span class="s2">&quot;</span> /etc/fstab &gt; /etc/.fstab.new
        mv -f /etc/.fstab.new /etc/fstab
    <span class="k">fi</span>
<span class="k">fi</span>

<span class="nb">exit </span>0
</pre></div>
</div>
<p>Converting a text file to HTML format.</p>
</div>
<div class="section" id="exemple-24-converting-to-html">
<h2>Exemple 24. Converting to HTML<a class="headerlink" href="#exemple-24-converting-to-html" title="Link permanent a aquest títol">¶</a></h2>
<div class="highlight-sh"><div class="highlight"><pre><span class="c">#!/bin/bash</span>
<span class="c"># tohtml.sh [v. 0.2.01, reldate: 04/13/12, a teeny bit less buggy]</span>

<span class="c"># Convert a text file to HTML format.</span>
<span class="c"># Author: Mendel Cooper</span>
<span class="c"># License: GPL3</span>
<span class="c"># Usage: sh tohtml.sh &lt; textfile &gt; htmlfile</span>
<span class="c"># Script can easily be modified to accept source and target filenames.</span>

<span class="c">#    Assumptions:</span>
<span class="c"># 1) Paragraphs in (target) text file are separated by a blank line.</span>
<span class="c"># 2) Jpeg images (*.jpg) are located in &quot;images&quot; subdirectory.</span>
<span class="c">#    In the target file, the image names are enclosed in square brackets,</span>
<span class="c">#    for example, [image01.jpg].</span>
<span class="c"># 3) Emphasized (italic) phrases begin with a space+underscore</span>
<span class="c">#+   or the first character on the line is an underscore,</span>
<span class="c">#+   and end with an underscore+space or underscore+end-of-line.</span>


<span class="c"># Settings</span>
<span class="nv">FNTSIZE</span><span class="o">=</span><span class="m">2</span>        <span class="c"># Small-medium font size</span>
<span class="nv">IMGDIR</span><span class="o">=</span><span class="s2">&quot;images&quot;</span>  <span class="c"># Image directory</span>
<span class="c"># Headers</span>
<span class="nv">HDR01</span><span class="o">=</span><span class="s1">&#39;&lt;!DOCTYPE HTML PUBLIC &quot;-//W3C//DTD HTML 4.01 Transitional//EN&quot;&gt;&#39;</span>
<span class="nv">HDR02</span><span class="o">=</span><span class="s1">&#39;&lt;!-- Converted to HTML by ***tohtml.sh*** script --&gt;&#39;</span>
<span class="nv">HDR03</span><span class="o">=</span><span class="s1">&#39;&lt;!-- script author: M. Leo Cooper &lt;thegrendel.abs@gmail.com&gt; --&gt;&#39;</span>
<span class="nv">HDR10</span><span class="o">=</span><span class="s1">&#39;&lt;html&gt;&#39;</span>
<span class="nv">HDR11</span><span class="o">=</span><span class="s1">&#39;&lt;head&gt;&#39;</span>
<span class="nv">HDR11a</span><span class="o">=</span><span class="s1">&#39;&lt;/head&gt;&#39;</span>
<span class="nv">HDR12a</span><span class="o">=</span><span class="s1">&#39;&lt;title&gt;&#39;</span>
<span class="nv">HDR12b</span><span class="o">=</span><span class="s1">&#39;&lt;/title&gt;&#39;</span>
<span class="nv">HDR121</span><span class="o">=</span><span class="s1">&#39;&lt;META NAME=&quot;GENERATOR&quot; CONTENT=&quot;tohtml.sh script&quot;&gt;&#39;</span>
<span class="nv">HDR13</span><span class="o">=</span><span class="s1">&#39;&lt;body bgcolor=&quot;#dddddd&quot;&gt;&#39;</span>   <span class="c"># Change background color to suit.</span>
<span class="nv">HDR14a</span><span class="o">=</span><span class="s1">&#39;&lt;font size=&#39;</span>
<span class="nv">HDR14b</span><span class="o">=</span><span class="s1">&#39;&gt;&#39;</span>
<span class="c"># Footers</span>
<span class="nv">FTR10</span><span class="o">=</span><span class="s1">&#39;&lt;/body&gt;&#39;</span>
<span class="nv">FTR11</span><span class="o">=</span><span class="s1">&#39;&lt;/html&gt;&#39;</span>
<span class="c"># Tags</span>
<span class="nv">BOLD</span><span class="o">=</span><span class="s2">&quot;&lt;b&gt;&quot;</span>
<span class="nv">CENTER</span><span class="o">=</span><span class="s2">&quot;&lt;center&gt;&quot;</span>
<span class="nv">END_CENTER</span><span class="o">=</span><span class="s2">&quot;&lt;/center&gt;&quot;</span>
<span class="nv">LF</span><span class="o">=</span><span class="s2">&quot;&lt;br&gt;&quot;</span>


write_headers <span class="o">()</span>
  <span class="o">{</span>
  <span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$HDR01</span><span class="s2">&quot;</span>
  <span class="nb">echo</span>
<span class="nb">  echo</span> <span class="s2">&quot;</span><span class="nv">$HDR02</span><span class="s2">&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$HDR03</span><span class="s2">&quot;</span>
  <span class="nb">echo</span>
<span class="nb">  echo</span>
<span class="nb">  echo</span> <span class="s2">&quot;</span><span class="nv">$HDR10</span><span class="s2">&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$HDR11</span><span class="s2">&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$HDR121</span><span class="s2">&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$HDR11a</span><span class="s2">&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$HDR13</span><span class="s2">&quot;</span>
  <span class="nb">echo</span>
<span class="nb">  echo</span> -n <span class="s2">&quot;</span><span class="nv">$HDR14a</span><span class="s2">&quot;</span>
  <span class="nb">echo</span> -n <span class="s2">&quot;</span><span class="nv">$FNTSIZE</span><span class="s2">&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$HDR14b</span><span class="s2">&quot;</span>
  <span class="nb">echo</span>
<span class="nb">  echo</span> <span class="s2">&quot;</span><span class="nv">$BOLD</span><span class="s2">&quot;</span>        <span class="c"># Everything in bold (more easily readable).</span>
  <span class="o">}</span>


process_text <span class="o">()</span>
  <span class="o">{</span>
  <span class="k">while</span> <span class="nb">read </span>line     <span class="c"># Read one line at a time.</span>
  <span class="k">do</span>
    <span class="o">{</span>
    <span class="k">if</span> <span class="o">[</span> ! <span class="s2">&quot;</span><span class="nv">$line</span><span class="s2">&quot;</span> <span class="o">]</span>  <span class="c"># Blank line?</span>
    <span class="k">then</span>              <span class="c"># Then new paragraph must follow.</span>
      <span class="nb">echo</span>
<span class="nb">      echo</span> <span class="s2">&quot;</span><span class="nv">$LF</span><span class="s2">&quot;</span>      <span class="c"># Insert two &lt;br&gt; tags.</span>
      <span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$LF</span><span class="s2">&quot;</span>
      <span class="nb">echo</span>
<span class="nb">      </span><span class="k">continue</span>        <span class="c"># Skip the underscore test.</span>
    <span class="k">else</span>              <span class="c"># Otherwise . . .</span>

      <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;</span><span class="nv">$line</span><span class="s2">&quot;</span> <span class="o">=</span>~ <span class="se">\[</span>*jpg<span class="se">\]</span> <span class="o">]]</span>    <span class="c"># Is a graphic?</span>
      <span class="k">then</span>                            <span class="c"># Strip away brackets.</span>
        <span class="nv">temp</span><span class="o">=</span><span class="k">$(</span> <span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$line</span><span class="s2">&quot;</span>sed -e <span class="s1">&#39;s/\[//&#39;</span> -e <span class="s1">&#39;s/\]//&#39;</span> <span class="k">)</span>
        <span class="nv">line</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="nv">$CENTER</span><span class="s2">&quot; &lt;img src=&quot;</span><span class="se">\&quot;</span><span class="nv">$IMGDIR</span><span class="s2">&quot;/</span><span class="nv">$temp</span><span class="s2">\&quot;&gt; &quot;</span><span class="nv">$END_CENTER</span><span class="s2">&quot; &quot;</span>
                                      <span class="c"># Add image tag.</span>
                                      <span class="c"># And, center it.</span>
      <span class="k">fi</span>

    <span class="k">fi</span>


    <span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$line</span><span class="s2">&quot;</span>grep -q _
    <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$?</span><span class="s2">&quot;</span> -eq <span class="m">0</span> <span class="o">]</span>    <span class="c"># If line contains underscore ...</span>
    <span class="k">then</span>
      <span class="c"># ===================================================</span>
      <span class="c"># Convert underscored phrase to italics.</span>
      <span class="nv">temp</span><span class="o">=</span><span class="k">$(</span> <span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$line</span><span class="s2">&quot;</span>
              sed -e <span class="s1">&#39;s/ _/ &lt;i&gt;/&#39;</span> -e <span class="s1">&#39;s/_/&lt;\/i&gt; /&#39;</span>
              sed -e <span class="s1">&#39;s/^_/&lt;i&gt;/&#39;</span>  -e <span class="s1">&#39;s/_/&lt;\/i&gt;/&#39;</span> <span class="k">)</span>
      <span class="c">#  Process only underscores prefixed by space,</span>
      <span class="c">#+ or at beginning or end of line.</span>
      <span class="c">#  Do not convert underscores embedded within a word!</span>
      <span class="nv">line</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$temp</span><span class="s2">&quot;</span>
      <span class="c"># Slows script execution. Can be optimized?</span>
      <span class="c"># ===================================================</span>
    <span class="k">fi</span>



<span class="c">#   echo</span>
    <span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$line</span><span class="s2">&quot;</span>
<span class="c">#   echo</span>
<span class="c">#   Don&#39;t want extra blank lines in generated text!</span>
    <span class="o">}</span> <span class="c"># End while</span>
  <span class="k">done</span>
  <span class="o">}</span>   <span class="c"># End process_text ()</span>


write_footers <span class="o">()</span>  <span class="c"># Termination tags.</span>
  <span class="o">{</span>
  <span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$FTR10</span><span class="s2">&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$FTR11</span><span class="s2">&quot;</span>
  <span class="o">}</span>


<span class="c"># main () {</span>
<span class="c"># =========</span>
write_headers
process_text
write_footers
<span class="c"># =========</span>
<span class="c">#         }</span>

<span class="nb">exit</span> <span class="nv">$?</span>

<span class="c">#  Exercises:</span>
<span class="c">#  ---------</span>
<span class="c">#  1) Fixup: Check for closing underscore before a comma or period.</span>
<span class="c">#  2) Add a test for the presence of a closing underscore</span>
<span class="c">#+    in phrases to be italicized.</span>
</pre></div>
</div>
<p>Here is something to warm the hearts of webmasters and mistresses: a
script that saves weblogs.</p>
</div>
<div class="section" id="exemple-25-preserving-weblogs">
<h2>Exemple 25. Preserving weblogs<a class="headerlink" href="#exemple-25-preserving-weblogs" title="Link permanent a aquest títol">¶</a></h2>
<div class="highlight-sh"><div class="highlight"><pre>   <span class="c">#!/bin/bash</span>
   <span class="c"># archiveweblogs.sh v1.0</span>

   <span class="c"># Troy Engel &lt;tengel@fluid.com&gt;</span>
   <span class="c"># Slightly modified by document author.</span>
   <span class="c"># Used with permission.</span>
   <span class="c">#</span>
   <span class="c">#  This script will preserve the normally rotated and</span>
   <span class="c">#+ thrown away weblogs from a default RedHat/Apache installation.</span>
   <span class="c">#  It will save the files with a date/time stamp in the filename,</span>
   <span class="c">#+ bzipped, to a given directory.</span>
   <span class="c">#</span>
   <span class="c">#  Run this from crontab nightly at an off hour,</span>
   <span class="c">#+ as bzip2 can suck up some serious CPU on huge logs:</span>
   <span class="c">#  0 2 * * * /opt/sbin/archiveweblogs.sh</span>


   <span class="nv">PROBLEM</span><span class="o">=</span>66

   <span class="c"># Set this to your backup dir.</span>
   <span class="nv">BKP_DIR</span><span class="o">=</span>/opt/backups/weblogs

   <span class="c"># Default Apache/RedHat stuff</span>
   <span class="nv">LOG_DAYS</span><span class="o">=</span><span class="s2">&quot;4 3 2 1&quot;</span>
   <span class="nv">LOG_DIR</span><span class="o">=</span>/var/log/httpd
   <span class="nv">LOG_FILES</span><span class="o">=</span><span class="s2">&quot;access_log error_log&quot;</span>

   <span class="c"># Default RedHat program locations</span>
   <span class="nv">LS</span><span class="o">=</span>/bin/ls
   <span class="nv">MV</span><span class="o">=</span>/bin/mv
   <span class="nv">ID</span><span class="o">=</span>/usr/bin/id
   <span class="nv">CUT</span><span class="o">=</span>/bin/cut
   <span class="nv">COL</span><span class="o">=</span>/usr/bin/column
   <span class="nv">BZ2</span><span class="o">=</span>/usr/bin/bzip2

   <span class="c"># Are we root?</span>
   <span class="nv">USER</span><span class="o">=</span><span class="sb">`</span><span class="nv">$ID</span> -u<span class="sb">`</span>
   <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;X</span><span class="nv">$USER</span><span class="s2">&quot;</span> !<span class="o">=</span> <span class="s2">&quot;X0&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
     <span class="nb">echo</span> <span class="s2">&quot;PANIC: Only root can run this script!&quot;</span>
     <span class="nb">exit</span> <span class="nv">$PROBLEM</span>
   <span class="k">fi</span>

   <span class="c"># Backup dir exists/writable?</span>
   <span class="k">if</span> <span class="o">[</span> ! -x <span class="nv">$BKP_DIR</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
     <span class="nb">echo</span> <span class="s2">&quot;PANIC: </span><span class="nv">$BKP_DIR</span><span class="s2"> doesn&#39;t exist or isn&#39;t writable!&quot;</span>
     <span class="nb">exit</span> <span class="nv">$PROBLEM</span>
   <span class="k">fi</span>

   <span class="c"># Move, rename and bzip2 the logs</span>
   <span class="k">for</span> logday in <span class="nv">$LOG_DAYS</span><span class="p">;</span> <span class="k">do</span>
     <span class="k">for</span> logfile in <span class="nv">$LOG_FILES</span><span class="p">;</span> <span class="k">do</span>
       <span class="nv">MYFILE</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$LOG_DIR</span><span class="s2">/</span><span class="nv">$logfile</span><span class="s2">.</span><span class="nv">$logday</span><span class="s2">&quot;</span>
       <span class="k">if</span> <span class="o">[</span> -w <span class="nv">$MYFILE</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
         <span class="nv">DTS</span><span class="o">=</span><span class="sb">`</span><span class="nv">$LS</span> -lgo --time-style<span class="o">=</span>+%Y%m%d <span class="nv">$MYFILE$COL</span> -t <span class="p">|</span> <span class="nv">$CUT</span> -d <span class="s1">&#39; &#39;</span> -f7<span class="sb">`</span>
         <span class="nv">$MV</span> <span class="nv">$MYFILE</span> <span class="nv">$BKP_DIR</span>/<span class="nv">$logfile</span>.<span class="nv">$DTS</span>
         <span class="nv">$BZ2</span> <span class="nv">$BKP_DIR</span>/<span class="nv">$logfile</span>.<span class="nv">$DTS</span>
       <span class="k">else</span>
         <span class="c"># Only spew an error if the file exits (ergo non-writable).</span>
         <span class="k">if</span> <span class="o">[</span> -f <span class="nv">$MYFILE</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
           <span class="nb">echo</span> <span class="s2">&quot;ERROR: </span><span class="nv">$MYFILE</span><span class="s2"> not writable. Skipping.&quot;</span>
         <span class="k">fi</span>
       <span class="k">fi</span>
     <span class="k">done</span>
   <span class="k">done</span>

   <span class="nb">exit </span>0




How to keep the shell from expanding and reinterpreting text strings.
</pre></div>
</div>
</div>
<div class="section" id="exemple-26-protecting-literal-strings">
<h2>Exemple 26. Protecting literal strings<a class="headerlink" href="#exemple-26-protecting-literal-strings" title="Link permanent a aquest títol">¶</a></h2>
<div class="highlight-sh"><div class="highlight"><pre>   <span class="c">#! /bin/bash</span>
   <span class="c"># protect_literal.sh</span>

   <span class="c"># set -vx</span>

   :<span class="s">&lt;&lt;-&#39;_Protect_Literal_String_Doc&#39;</span>

<span class="s">       Copyright (c) Michael S. Zick, 2003; All Rights Reserved</span>
<span class="s">       License: Unrestricted reuse in any form, for any purpose.</span>
<span class="s">       Warranty: None</span>
<span class="s">       Revision: $ID$</span>

<span class="s">       Documentation redirected to the Bash no-operation.</span>
<span class="s">       Bash will &#39;/dev/null&#39; this block when the script is first read.</span>
<span class="s">       (Uncomment the above set command to see this action.)</span>

<span class="s">       Remove the first (Sha-Bang) line when sourcing this as a library</span>
<span class="s">       procedure.  Also comment out the example use code in the two</span>
<span class="s">       places where shown.</span>


<span class="s">       Usage:</span>
<span class="s">           _protect_literal_str &#39;Whatever string meets your ${fancy}&#39;</span>
<span class="s">           Just echos the argument to standard out, hard quotes</span>
<span class="s">           restored.</span>

<span class="s">           $(_protect_literal_str &#39;Whatever string meets your ${fancy}&#39;)</span>
<span class="s">           as the right-hand-side of an assignment statement.</span>

<span class="s">       Does:</span>
<span class="s">           As the right-hand-side of an assignment, preserves the</span>
<span class="s">           hard quotes protecting the contents of the literal during</span>
<span class="s">           assignment.</span>

<span class="s">       Notes:</span>
<span class="s">           The strange names (_*) are used to avoid trampling on</span>
<span class="s">           the user&#39;s chosen names when this is sourced as a</span>
<span class="s">           library.</span>

<span class="s">   _Protect_Literal_String_Doc</span>

   <span class="c"># The &#39;for illustration&#39; function form</span>

   _protect_literal_str<span class="o">()</span> <span class="o">{</span>

   <span class="c"># Pick an un-used, non-printing character as local IFS.</span>
   <span class="c"># Not required, but shows that we are ignoring it.</span>
       <span class="nb">local </span><span class="nv">IFS</span><span class="o">=</span><span class="s1">$&#39;\x1B&#39;</span>               <span class="c"># \ESC character</span>

   <span class="c"># Enclose the All-Elements-Of in hard quotes during assignment.</span>
       <span class="nb">local </span><span class="nv">tmp</span><span class="o">=</span><span class="s1">$&#39;\x27&#39;</span><span class="nv">$@</span><span class="s1">$&#39;\x27&#39;</span>
   <span class="c">#    local tmp=$&#39;\&#39;&#39;$@$&#39;\&#39;&#39;         # Even uglier.</span>

       <span class="nb">local </span><span class="nv">len</span><span class="o">=</span><span class="si">${#</span><span class="nv">tmp</span><span class="si">}</span>               <span class="c"># Info only.</span>
       <span class="nb">echo</span> <span class="nv">$tmp</span> is <span class="nv">$len</span> long.         <span class="c"># Output AND information.</span>
   <span class="o">}</span>

   <span class="c"># This is the short-named version.</span>
   _pls<span class="o">()</span> <span class="o">{</span>
       <span class="nb">local </span><span class="nv">IFS</span><span class="o">=</span><span class="s1">$&#39;x1B&#39;</span>                <span class="c"># \ESC character (not required)</span>
       <span class="nb">echo</span> <span class="s1">$&#39;\x27&#39;</span><span class="nv">$@</span><span class="s1">$&#39;\x27&#39;</span>           <span class="c"># Hard quoted parameter glob</span>
   <span class="o">}</span>

   <span class="c"># :&lt;&lt;-&#39;_Protect_Literal_String_Test&#39;</span>
   <span class="c"># # # Remove the above &quot;# &quot; to disable this code. # # #</span>

   <span class="c"># See how that looks when printed.</span>
   <span class="nb">echo</span>
<span class="nb">   echo</span> <span class="s2">&quot;- - Test One - -&quot;</span>
   _protect_literal_str <span class="s1">&#39;Hello $user&#39;</span>
   _protect_literal_str <span class="s1">&#39;Hello &quot;${username}&quot;&#39;</span>
   <span class="nb">echo</span>

   <span class="c"># Which yields:</span>
   <span class="c"># - - Test One - -</span>
   <span class="c"># &#39;Hello $user&#39; is 13 long.</span>
   <span class="c"># &#39;Hello &quot;${username}&quot;&#39; is 21 long.</span>

   <span class="c">#  Looks as expected, but why all of the trouble?</span>
   <span class="c">#  The difference is hidden inside the Bash internal order</span>
   <span class="c">#+ of operations.</span>
   <span class="c">#  Which shows when you use it on the RHS of an assignment.</span>

   <span class="c"># Declare an array for test values.</span>
   <span class="nb">declare</span> -a arrayZ

   <span class="c"># Assign elements with various types of quotes and escapes.</span>
   <span class="nv">arrayZ</span><span class="o">=(</span> zero <span class="s2">&quot;</span><span class="k">$(</span>_pls <span class="s1">&#39;Hello ${Me}&#39;</span><span class="k">)</span><span class="s2">&quot;</span> <span class="s1">&#39;Hello ${You}&#39;</span> <span class="s2">&quot;\&#39;Pass: </span><span class="si">${</span><span class="nv">pw</span><span class="si">}</span><span class="s2">\&#39;&quot;</span> <span class="o">)</span>

   <span class="c"># Now list that array and see what is there.</span>
   <span class="nb">echo</span> <span class="s2">&quot;- - Test Two - -&quot;</span>
   <span class="k">for</span> <span class="o">((</span> <span class="nv">i</span><span class="o">=</span><span class="m">0</span> <span class="p">;</span> i&lt;<span class="si">${#</span><span class="nv">arrayZ</span><span class="p">[*]</span><span class="si">}</span> <span class="p">;</span> i++ <span class="o">))</span>
   <span class="k">do</span>
       <span class="nb">echo  </span>Element <span class="nv">$i</span>: <span class="si">${</span><span class="nv">arrayZ</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span><span class="si">}</span> is: <span class="si">${#</span><span class="nv">arrayZ</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span><span class="si">}</span> long.
   <span class="k">done</span>
   <span class="nb">echo</span>

   <span class="c"># Which yields:</span>
   <span class="c"># - - Test Two - -</span>
   <span class="c"># Element 0: zero is: 4 long.           # Our marker element</span>
   <span class="c"># Element 1: &#39;Hello ${Me}&#39; is: 13 long. # Our &quot;$(_pls &#39;...&#39; )&quot;</span>
   <span class="c"># Element 2: Hello ${You} is: 12 long.  # Quotes are missing</span>
   <span class="c"># Element 3: \&#39;Pass: \&#39; is: 10 long.    # ${pw} expanded to nothing</span>

   <span class="c"># Now make an assignment with that result.</span>
   <span class="nb">declare</span> -a <span class="nv">array2</span><span class="o">=(</span> <span class="si">${</span><span class="nv">arrayZ</span><span class="p">[@]</span><span class="si">}</span> <span class="o">)</span>

   <span class="c"># And print what happened.</span>
   <span class="nb">echo</span> <span class="s2">&quot;- - Test Three - -&quot;</span>
   <span class="k">for</span> <span class="o">((</span> <span class="nv">i</span><span class="o">=</span><span class="m">0</span> <span class="p">;</span> i&lt;<span class="si">${#</span><span class="nv">array2</span><span class="p">[*]</span><span class="si">}</span> <span class="p">;</span> i++ <span class="o">))</span>
   <span class="k">do</span>
       <span class="nb">echo  </span>Element <span class="nv">$i</span>: <span class="si">${</span><span class="nv">array2</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span><span class="si">}</span> is: <span class="si">${#</span><span class="nv">array2</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span><span class="si">}</span> long.
   <span class="k">done</span>
   <span class="nb">echo</span>

   <span class="c"># Which yields:</span>
   <span class="c"># - - Test Three - -</span>
   <span class="c"># Element 0: zero is: 4 long.           # Our marker element.</span>
   <span class="c"># Element 1: Hello ${Me} is: 11 long.   # Intended result.</span>
   <span class="c"># Element 2: Hello is: 5 long.          # ${You} expanded to nothing.</span>
   <span class="c"># Element 3: &#39;Pass: is: 6 long.         # Split on the whitespace.</span>
   <span class="c"># Element 4: &#39; is: 1 long.              # The end quote is here now.</span>

   <span class="c">#  Our Element 1 has had its leading and trailing hard quotes stripped.</span>
   <span class="c">#  Although not shown, leading and trailing whitespace is also stripped.</span>
   <span class="c">#  Now that the string contents are set, Bash will always, internally,</span>
   <span class="c">#+ hard quote the contents as required during its operations.</span>

   <span class="c">#  Why?</span>
   <span class="c">#  Considering our &quot;$(_pls &#39;Hello ${Me}&#39;)&quot; construction:</span>
   <span class="c">#  &quot; ... &quot; -&gt; Expansion required, strip the quotes.</span>
   <span class="c">#  $( ... ) -&gt; Replace with the result of..., strip this.</span>
   <span class="c">#  _pls &#39; ... &#39; -&gt; called with literal arguments, strip the quotes.</span>
   <span class="c">#  The result returned includes hard quotes; BUT the above processing</span>
   <span class="c">#+ has already been done, so they become part of the value assigned.</span>
   <span class="c">#</span>
   <span class="c">#  Similarly, during further usage of the string variable, the ${Me}</span>
   <span class="c">#+ is part of the contents (result) and survives any operations</span>
   <span class="c">#  (Until explicitly told to evaluate the string).</span>

   <span class="c">#  Hint: See what happens when the hard quotes ($&#39;\x27&#39;) are replaced</span>
   <span class="c">#+ with soft quotes ($&#39;\x22&#39;) in the above procedures.</span>
   <span class="c">#  Interesting also is to remove the addition of any quoting.</span>

   <span class="c"># _Protect_Literal_String_Test</span>
   <span class="c"># # # Remove the above &quot;# &quot; to disable this code. # # #</span>

   <span class="nb">exit </span>0




But, what <span class="k">if</span> you *want* the shell to expand and reinterpret strings?
</pre></div>
</div>
</div>
<div class="section" id="exemple-27-unprotecting-literal-strings">
<h2>Exemple 27. Unprotecting literal strings<a class="headerlink" href="#exemple-27-unprotecting-literal-strings" title="Link permanent a aquest títol">¶</a></h2>
<div class="highlight-sh"><div class="highlight"><pre><span class="c">#! /bin/bash</span>
<span class="c"># unprotect_literal.sh</span>

<span class="c"># set -vx</span>

:<span class="s">&lt;&lt;-&#39;_UnProtect_Literal_String_Doc&#39;</span>

<span class="s">    Copyright (c) Michael S. Zick, 2003; All Rights Reserved</span>
<span class="s">    License: Unrestricted reuse in any form, for any purpose.</span>
<span class="s">    Warranty: None</span>
<span class="s">    Revision: $ID$</span>

<span class="s">    Documentation redirected to the Bash no-operation. Bash will</span>
<span class="s">    &#39;/dev/null&#39; this block when the script is first read.</span>
<span class="s">    (Uncomment the above set command to see this action.)</span>

<span class="s">    Remove the first (Sha-Bang) line when sourcing this as a library</span>
<span class="s">    procedure.  Also comment out the example use code in the two</span>
<span class="s">    places where shown.</span>


<span class="s">    Usage:</span>
<span class="s">        Complement of the &quot;$(_pls &#39;Literal String&#39;)&quot; function.</span>
<span class="s">        (See the protect_literal.sh example.)</span>

<span class="s">        StringVar=$(_upls ProtectedSringVariable)</span>

<span class="s">    Does:</span>
<span class="s">        When used on the right-hand-side of an assignment statement;</span>
<span class="s">        makes the substitions embedded in the protected string.</span>

<span class="s">    Notes:</span>
<span class="s">        The strange names (_*) are used to avoid trampling on</span>
<span class="s">        the user&#39;s chosen names when this is sourced as a</span>
<span class="s">        library.</span>


<span class="s">_UnProtect_Literal_String_Doc</span>

_upls<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local </span><span class="nv">IFS</span><span class="o">=</span><span class="s1">$&#39;x1B&#39;</span>                <span class="c"># \ESC character (not required)</span>
    <span class="nb">eval echo</span> <span class="nv">$@</span>                    <span class="c"># Substitution on the glob.</span>
<span class="o">}</span>

<span class="c"># :&lt;&lt;-&#39;_UnProtect_Literal_String_Test&#39;</span>
<span class="c"># # # Remove the above &quot;# &quot; to disable this code. # # #</span>


_pls<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local </span><span class="nv">IFS</span><span class="o">=</span><span class="s1">$&#39;x1B&#39;</span>                <span class="c"># \ESC character (not required)</span>
    <span class="nb">echo</span> <span class="s1">$&#39;\x27&#39;</span><span class="nv">$@</span><span class="s1">$&#39;\x27&#39;</span>           <span class="c"># Hard quoted parameter glob</span>
<span class="o">}</span>

<span class="c"># Declare an array for test values.</span>
<span class="nb">declare</span> -a arrayZ

<span class="c"># Assign elements with various types of quotes and escapes.</span>
<span class="nv">arrayZ</span><span class="o">=(</span> zero <span class="s2">&quot;</span><span class="k">$(</span>_pls <span class="s1">&#39;Hello ${Me}&#39;</span><span class="k">)</span><span class="s2">&quot;</span> <span class="s1">&#39;Hello ${You}&#39;</span> <span class="s2">&quot;\&#39;Pass: </span><span class="si">${</span><span class="nv">pw</span><span class="si">}</span><span class="s2">\&#39;&quot;</span> <span class="o">)</span>

<span class="c"># Now make an assignment with that result.</span>
<span class="nb">declare</span> -a <span class="nv">array2</span><span class="o">=(</span> <span class="si">${</span><span class="nv">arrayZ</span><span class="p">[@]</span><span class="si">}</span> <span class="o">)</span>

<span class="c"># Which yielded:</span>
<span class="c"># - - Test Three - -</span>
<span class="c"># Element 0: zero is: 4 long            # Our marker element.</span>
<span class="c"># Element 1: Hello ${Me} is: 11 long    # Intended result.</span>
<span class="c"># Element 2: Hello is: 5 long           # ${You} expanded to nothing.</span>
<span class="c"># Element 3: &#39;Pass: is: 6 long          # Split on the whitespace.</span>
<span class="c"># Element 4: &#39; is: 1 long               # The end quote is here now.</span>

<span class="c"># set -vx</span>

<span class="c">#  Initialize &#39;Me&#39; to something for the embedded ${Me} substitution.</span>
<span class="c">#  This needs to be done ONLY just prior to evaluating the</span>
<span class="c">#+ protected string.</span>
<span class="c">#  (This is why it was protected to begin with.)</span>

<span class="nv">Me</span><span class="o">=</span><span class="s2">&quot;to the array guy.&quot;</span>

<span class="c"># Set a string variable destination to the result.</span>
<span class="nv">newVar</span><span class="o">=</span><span class="k">$(</span>_upls <span class="si">${</span><span class="nv">array2</span><span class="p">[1]</span><span class="si">}</span><span class="k">)</span>

<span class="c"># Show what the contents are.</span>
<span class="nb">echo</span> <span class="nv">$newVar</span>

<span class="c"># Do we really need a function to do this?</span>
<span class="nv">newerVar</span><span class="o">=</span><span class="k">$(</span><span class="nb">eval echo</span> <span class="si">${</span><span class="nv">array2</span><span class="p">[1]</span><span class="si">}</span><span class="k">)</span>
<span class="nb">echo</span> <span class="nv">$newerVar</span>

<span class="c">#  I guess not, but the _upls function gives us a place to hang</span>
<span class="c">#+ the documentation on.</span>
<span class="c">#  This helps when we forget what a # construction like:</span>
<span class="c">#+ $(eval echo ... ) means.</span>

<span class="c"># What if Me isn&#39;t set when the protected string is evaluated?</span>
<span class="nb">unset </span>Me
<span class="nv">newestVar</span><span class="o">=</span><span class="k">$(</span>_upls <span class="si">${</span><span class="nv">array2</span><span class="p">[1]</span><span class="si">}</span><span class="k">)</span>
<span class="nb">echo</span> <span class="nv">$newestVar</span>

<span class="c"># Just gone, no hints, no runs, no errors.</span>

<span class="c">#  Why in the world?</span>
<span class="c">#  Setting the contents of a string variable containing character</span>
<span class="c">#+ sequences that have a meaning in Bash is a general problem in</span>
<span class="c">#+ script programming.</span>
<span class="c">#</span>
<span class="c">#  This problem is now solved in eight lines of code</span>
<span class="c">#+ (and four pages of description).</span>

<span class="c">#  Where is all this going?</span>
<span class="c">#  Dynamic content Web pages as an array of Bash strings.</span>
<span class="c">#  Content set per request by a Bash &#39;eval&#39; command</span>
<span class="c">#+ on the stored page template.</span>
<span class="c">#  Not intended to replace PHP, just an interesting thing to do.</span>
<span class="c">###</span>
<span class="c">#  Don&#39;t have a webserver application?</span>
<span class="c">#  No problem, check the example directory of the Bash source;</span>
<span class="c">#+ there is a Bash script for that also.</span>

<span class="c"># _UnProtect_Literal_String_Test</span>
<span class="c"># # # Remove the above &quot;# &quot; to disable this code. # # #</span>

<span class="nb">exit </span>0
</pre></div>
</div>
<p>This interesting script helps hunt down spammers.</p>
</div>
<div class="section" id="exemple-28-spammer-identification">
<h2>Exemple 28. Spammer Identification<a class="headerlink" href="#exemple-28-spammer-identification" title="Link permanent a aquest títol">¶</a></h2>
<div class="highlight-sh"><div class="highlight"><pre><span class="c">#!/bin/bash</span>

<span class="c"># $Id: is_spammer.bash,v 1.12.2.11 2004/10/01 21:42:33 mszick Exp $</span>
<span class="c"># Above line is RCS info.</span>

<span class="c"># The latest version of this script is available from http://www.morethan.org.</span>
<span class="c">#</span>
<span class="c"># Spammer-identification</span>
<span class="c"># by Michael S. Zick</span>
<span class="c"># Used in the ABS Guide with permission.</span>



<span class="c">#######################################################</span>
<span class="c"># Documentation</span>
<span class="c"># See also &quot;Quickstart&quot; at end of script.</span>
<span class="c">#######################################################</span>

:<span class="s">&lt;&lt;-&#39;__is_spammer_Doc_&#39;</span>

<span class="s">    Copyright (c) Michael S. Zick, 2004</span>
<span class="s">    License: Unrestricted reuse in any form, for any purpose.</span>
<span class="s">    Warranty: None -{Its a script; the user is on their own.}-</span>

<span class="s">Impatient?</span>
<span class="s">    Application code: goto &quot;# # # Hunt the Spammer&#39; program code # # #&quot;</span>
<span class="s">    Example output: &quot;:&lt;&lt;-&#39;_is_spammer_outputs_&#39;&quot;</span>
<span class="s">    How to use: Enter script name without arguments.</span>
<span class="s">                Or goto &quot;Quickstart&quot; at end of script.</span>

<span class="s">Provides</span>
<span class="s">    Given a domain name or IP(v4) address as input:</span>

<span class="s">    Does an exhaustive set of queries to find the associated</span>
<span class="s">    network resources (short of recursing into TLDs).</span>

<span class="s">    Checks the IP(v4) addresses found against Blacklist</span>
<span class="s">    nameservers.</span>

<span class="s">    If found to be a blacklisted IP(v4) address,</span>
<span class="s">    reports the blacklist text records.</span>
<span class="s">    (Usually hyper-links to the specific report.)</span>

<span class="s">Requires</span>
<span class="s">    A working Internet connection.</span>
<span class="s">    (Exercise: Add check and/or abort if not on-line when running script.)</span>
<span class="s">    Bash with arrays (2.05b+).</span>

<span class="s">    The external program &#39;dig&#39; --</span>
<span class="s">    a utility program provided with the &#39;bind&#39; set of programs.</span>
<span class="s">    Specifically, the version which is part of Bind series 9.x</span>
<span class="s">    See: http://www.isc.org</span>

<span class="s">    All usages of &#39;dig&#39; are limited to wrapper functions,</span>
<span class="s">    which may be rewritten as required.</span>
<span class="s">    See: dig_wrappers.bash for details.</span>
<span class="s">         (&quot;Additional documentation&quot; -- below)</span>

<span class="s">Usage</span>
<span class="s">    Script requires a single argument, which may be:</span>
<span class="s">    1) A domain name;</span>
<span class="s">    2) An IP(v4) address;</span>
<span class="s">    3) A filename, with one name or address per line.</span>

<span class="s">    Script accepts an optional second argument, which may be:</span>
<span class="s">    1) A Blacklist server name;</span>
<span class="s">    2) A filename, with one Blacklist server name per line.</span>

<span class="s">    If the second argument is not provided, the script uses</span>
<span class="s">    a built-in set of (free) Blacklist servers.</span>

<span class="s">    See also, the Quickstart at the end of this script (after &#39;exit&#39;).</span>

<span class="s">Return Codes</span>
<span class="s">    0 - All OK</span>
<span class="s">    1 - Script failure</span>
<span class="s">    2 - Something is Blacklisted</span>

<span class="s">Optional environment variables</span>
<span class="s">    SPAMMER_TRACE</span>
<span class="s">        If set to a writable file,</span>
<span class="s">        script will log an execution flow trace.</span>

<span class="s">    SPAMMER_DATA</span>
<span class="s">        If set to a writable file, script will dump its</span>
<span class="s">        discovered data in the form of GraphViz file.</span>
<span class="s">        See: http://www.research.att.com/sw/tools/graphviz</span>

<span class="s">    SPAMMER_LIMIT</span>
<span class="s">        Limits the depth of resource tracing.</span>

<span class="s">        Default is 2 levels.</span>

<span class="s">        A setting of 0 (zero) means &#39;unlimited&#39; . . .</span>
<span class="s">          Caution: script might recurse the whole Internet!</span>

<span class="s">        A limit of 1 or 2 is most useful when processing</span>
<span class="s">        a file of domain names and addresses.</span>
<span class="s">        A higher limit can be useful when hunting spam gangs.</span>


<span class="s">Additional documentation</span>
<span class="s">    Download the archived set of scripts</span>
<span class="s">    explaining and illustrating the function contained within this script.</span>
<span class="s">    http://bash.deta.in/mszick_clf.tar.bz2</span>


<span class="s">Study notes</span>
<span class="s">    This script uses a large number of functions.</span>
<span class="s">    Nearly all general functions have their own example script.</span>
<span class="s">    Each of the example scripts have tutorial level comments.</span>

<span class="s">Scripting project</span>
<span class="s">    Add support for IP(v6) addresses.</span>
<span class="s">    IP(v6) addresses are recognized but not processed.</span>

<span class="s">Advanced project</span>
<span class="s">    Add the reverse lookup detail to the discovered information.</span>

<span class="s">    Report the delegation chain and abuse contacts.</span>

<span class="s">    Modify the GraphViz file output to include the</span>
<span class="s">    newly discovered information.</span>

<span class="s">__is_spammer_Doc_</span>

<span class="c">#######################################################</span>




<span class="c">#### Special IFS settings used for string parsing. ####</span>

<span class="c"># Whitespace == :Space:Tab:Line Feed:Carriage Return:</span>
<span class="nv">WSP_IFS</span><span class="o">=</span><span class="s1">$&#39;\x20&#39;$&#39;\x09&#39;$&#39;\x0A&#39;$&#39;\x0D&#39;</span>

<span class="c"># No Whitespace == Line Feed:Carriage Return</span>
<span class="nv">NO_WSP</span><span class="o">=</span><span class="s1">$&#39;\x0A&#39;$&#39;\x0D&#39;</span>

<span class="c"># Field separator for dotted decimal IP addresses</span>
<span class="nv">ADR_IFS</span><span class="o">=</span><span class="si">${</span><span class="nv">NO_WSP</span><span class="si">}</span><span class="s1">&#39;.&#39;</span>

<span class="c"># Array to dotted string conversions</span>
<span class="nv">DOT_IFS</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="si">${</span><span class="nv">WSP_IFS</span><span class="si">}</span>

<span class="c"># # # Pending operations stack machine # # #</span>
<span class="c"># This set of functions described in func_stack.bash.</span>
<span class="c"># (See &quot;Additional documentation&quot; above.)</span>
<span class="c"># # #</span>

<span class="c"># Global stack of pending operations.</span>
<span class="nb">declare</span> -f -a _pending_
<span class="c"># Global sentinel for stack runners</span>
<span class="nb">declare</span> -i _p_ctrl_
<span class="c"># Global holder for currently executing function</span>
<span class="nb">declare</span> -f _pend_current_

<span class="c"># # # Debug version only - remove for regular use # # #</span>
<span class="c">#</span>
<span class="c"># The function stored in _pend_hook_ is called</span>
<span class="c"># immediately before each pending function is</span>
<span class="c"># evaluated.  Stack clean, _pend_current_ set.</span>
<span class="c">#</span>
<span class="c"># This thingy demonstrated in pend_hook.bash.</span>
<span class="nb">declare</span> -f _pend_hook_
<span class="c"># # #</span>

<span class="c"># The do nothing function</span>
pend_dummy<span class="o">()</span> <span class="o">{</span> : <span class="p">;</span> <span class="o">}</span>

<span class="c"># Clear and initialize the function stack.</span>
pend_init<span class="o">()</span> <span class="o">{</span>
    <span class="nb">unset </span>_pending_<span class="o">[</span>@<span class="o">]</span>
    pend_func pend_stop_mark
    <span class="nv">_pend_hook_</span><span class="o">=</span><span class="s1">&#39;pend_dummy&#39;</span>  <span class="c"># Debug only.</span>
<span class="o">}</span>

<span class="c"># Discard the top function on the stack.</span>
pend_pop<span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">[</span> <span class="si">${#</span><span class="nv">_pending_</span><span class="p">[@]</span><span class="si">}</span> -gt <span class="m">0</span> <span class="o">]</span>
    <span class="k">then</span>
        <span class="nb">local</span> -i _top_
        <span class="nv">_top_</span><span class="o">=</span><span class="si">${#</span><span class="nv">_pending_</span><span class="p">[@]</span><span class="si">}</span>-1
        <span class="nb">unset </span>_pending_<span class="o">[</span><span class="nv">$_top_</span><span class="o">]</span>
    <span class="k">fi</span>
<span class="o">}</span>

<span class="c"># pend_func function_name [$(printf &#39;%q\n&#39; arguments)]</span>
pend_func<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local </span><span class="nv">IFS</span><span class="o">=</span><span class="si">${</span><span class="nv">NO_WSP</span><span class="si">}</span>
    <span class="nb">set</span> -f
    _pending_<span class="o">[</span><span class="si">${#</span><span class="nv">_pending_</span><span class="p">[@]</span><span class="si">}</span><span class="o">]=</span><span class="nv">$@</span>
    <span class="nb">set</span> +f
<span class="o">}</span>

<span class="c"># The function which stops the release:</span>
pend_stop_mark<span class="o">()</span> <span class="o">{</span>
    <span class="nv">_p_ctrl_</span><span class="o">=</span>0
<span class="o">}</span>

pend_mark<span class="o">()</span> <span class="o">{</span>
    pend_func pend_stop_mark
<span class="o">}</span>

<span class="c"># Execute functions until &#39;pend_stop_mark&#39; . . .</span>
pend_release<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local</span> -i _top_             <span class="c"># Declare _top_ as integer.</span>
    <span class="nv">_p_ctrl_</span><span class="o">=</span><span class="si">${#</span><span class="nv">_pending_</span><span class="p">[@]</span><span class="si">}</span>
    <span class="k">while</span> <span class="o">[</span> <span class="si">${</span><span class="nv">_p_ctrl_</span><span class="si">}</span> -gt <span class="m">0</span> <span class="o">]</span>
    <span class="k">do</span>
       <span class="nv">_top_</span><span class="o">=</span><span class="si">${#</span><span class="nv">_pending_</span><span class="p">[@]</span><span class="si">}</span>-1
       <span class="nv">_pend_current_</span><span class="o">=</span><span class="si">${</span><span class="nv">_pending_</span><span class="p">[</span><span class="nv">$_top_</span><span class="p">]</span><span class="si">}</span>
       <span class="nb">unset </span>_pending_<span class="o">[</span><span class="nv">$_top_</span><span class="o">]</span>
       <span class="nv">$_pend_hook_</span>            <span class="c"># Debug only.</span>
       <span class="nb">eval</span> <span class="nv">$_pend_current_</span>
    <span class="k">done</span>
<span class="o">}</span>

<span class="c"># Drop functions until &#39;pend_stop_mark&#39; . . .</span>
pend_drop<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local</span> -i _top_
    <span class="nb">local </span><span class="nv">_pd_ctrl_</span><span class="o">=</span><span class="si">${#</span><span class="nv">_pending_</span><span class="p">[@]</span><span class="si">}</span>
    <span class="k">while</span> <span class="o">[</span> <span class="si">${</span><span class="nv">_pd_ctrl_</span><span class="si">}</span> -gt <span class="m">0</span> <span class="o">]</span>
    <span class="k">do</span>
       <span class="nv">_top_</span><span class="o">=</span><span class="nv">$_pd_ctrl_</span>-1
       <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">_pending_</span><span class="p">[</span><span class="nv">$_top_</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">==</span> <span class="s1">&#39;pend_stop_mark&#39;</span> <span class="o">]</span>
       <span class="k">then</span>
           <span class="nb">unset </span>_pending_<span class="o">[</span><span class="nv">$_top_</span><span class="o">]</span>
           <span class="nb">break</span>
<span class="nb">       </span><span class="k">else</span>
           <span class="nb">unset </span>_pending_<span class="o">[</span><span class="nv">$_top_</span><span class="o">]</span>
           <span class="nv">_pd_ctrl_</span><span class="o">=</span><span class="nv">$_top_</span>
       <span class="k">fi</span>
    <span class="k">done</span>
    <span class="k">if</span> <span class="o">[</span> <span class="si">${#</span><span class="nv">_pending_</span><span class="p">[@]</span><span class="si">}</span> -eq <span class="m">0</span> <span class="o">]</span>
    <span class="k">then</span>
        pend_func pend_stop_mark
    <span class="k">fi</span>
<span class="o">}</span>

<span class="c">#### Array editors ####</span>

<span class="c"># This function described in edit_exact.bash.</span>
<span class="c"># (See &quot;Additional documentation,&quot; above.)</span>
<span class="c"># edit_exact &lt;excludes_array_name&gt; &lt;target_array_name&gt;</span>
edit_exact<span class="o">()</span> <span class="o">{</span>
    <span class="o">[</span> <span class="nv">$# </span>-eq <span class="m">2</span> <span class="o">]</span> <span class="p">|</span>
    <span class="o">[</span> <span class="nv">$# </span>-eq <span class="m">3</span> <span class="o">]</span> <span class="p">|</span><span class="k">return</span> 1
    <span class="nb">local</span> -a _ee_Excludes
    <span class="nb">local</span> -a _ee_Target
    <span class="nb">local </span>_ee_x
    <span class="nb">local </span>_ee_t
    <span class="nb">local </span><span class="nv">IFS</span><span class="o">=</span><span class="si">${</span><span class="nv">NO_WSP</span><span class="si">}</span>
    <span class="nb">set</span> -f
    <span class="nb">eval </span><span class="nv">_ee_Excludes</span><span class="o">=</span><span class="se">\(</span> <span class="se">\$\{</span><span class="nv">$1</span><span class="se">\[</span>@<span class="se">\]\}</span> <span class="se">\)</span>
    <span class="nb">eval </span><span class="nv">_ee_Target</span><span class="o">=</span><span class="se">\(</span> <span class="se">\$\{</span><span class="nv">$2</span><span class="se">\[</span>@<span class="se">\]\}</span> <span class="se">\)</span>
    <span class="nb">local </span><span class="nv">_ee_len</span><span class="o">=</span><span class="si">${#</span><span class="nv">_ee_Target</span><span class="p">[@]</span><span class="si">}</span>     <span class="c"># Original length.</span>
    <span class="nb">local </span><span class="nv">_ee_cnt</span><span class="o">=</span><span class="si">${#</span><span class="nv">_ee_Excludes</span><span class="p">[@]</span><span class="si">}</span>   <span class="c"># Exclude list length.</span>
    <span class="o">[</span> <span class="si">${</span><span class="nv">_ee_len</span><span class="si">}</span> -ne <span class="m">0</span> <span class="o">]</span> <span class="p">|</span><span class="k">return</span> <span class="m">0</span>    <span class="c"># Can&#39;t edit zero length.</span>
    <span class="o">[</span> <span class="si">${</span><span class="nv">_ee_cnt</span><span class="si">}</span> -ne <span class="m">0</span> <span class="o">]</span> <span class="p">|</span><span class="k">return</span> <span class="m">0</span>    <span class="c"># Can&#39;t edit zero length.</span>
    <span class="k">for</span> <span class="o">((</span> <span class="nv">x</span> <span class="o">=</span> 0<span class="p">;</span> x &lt; <span class="si">${</span><span class="nv">_ee_cnt</span><span class="si">}</span> <span class="p">;</span> x++ <span class="o">))</span>
    <span class="k">do</span>
        <span class="nv">_ee_x</span><span class="o">=</span><span class="si">${</span><span class="nv">_ee_Excludes</span><span class="p">[</span><span class="nv">$x</span><span class="p">]</span><span class="si">}</span>
        <span class="k">for</span> <span class="o">((</span> <span class="nv">n</span> <span class="o">=</span> <span class="m">0</span> <span class="p">;</span> n &lt; <span class="si">${</span><span class="nv">_ee_len</span><span class="si">}</span> <span class="p">;</span> n++ <span class="o">))</span>
        <span class="k">do</span>
            <span class="nv">_ee_t</span><span class="o">=</span><span class="si">${</span><span class="nv">_ee_Target</span><span class="p">[</span><span class="nv">$n</span><span class="p">]</span><span class="si">}</span>
            <span class="k">if</span> <span class="o">[</span> x<span class="s2">&quot;</span><span class="si">${</span><span class="nv">_ee_t</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">==</span> x<span class="s2">&quot;</span><span class="si">${</span><span class="nv">_ee_x</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]</span>
            <span class="k">then</span>
                <span class="nb">unset </span>_ee_Target<span class="o">[</span><span class="nv">$n</span><span class="o">]</span>     <span class="c"># Discard match.</span>
                <span class="o">[</span> <span class="nv">$# </span>-eq <span class="m">2</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">break</span>    <span class="c"># If 2 arguments, then done.</span>
            <span class="k">fi</span>
        <span class="k">done</span>
    <span class="k">done</span>
    <span class="nb">eval</span> <span class="nv">$2</span><span class="o">=</span><span class="se">\(</span> <span class="se">\$\{</span>_ee_Target<span class="se">\[</span>@<span class="se">\]\}</span> <span class="se">\)</span>
    <span class="nb">set</span> +f
    <span class="k">return</span> 0
<span class="o">}</span>

<span class="c"># This function described in edit_by_glob.bash.</span>
<span class="c"># edit_by_glob &lt;excludes_array_name&gt; &lt;target_array_name&gt;</span>
edit_by_glob<span class="o">()</span> <span class="o">{</span>
    <span class="o">[</span> <span class="nv">$# </span>-eq <span class="m">2</span> <span class="o">]</span> <span class="p">|</span>
    <span class="o">[</span> <span class="nv">$# </span>-eq <span class="m">3</span> <span class="o">]</span> <span class="p">|</span><span class="k">return</span> 1
    <span class="nb">local</span> -a _ebg_Excludes
    <span class="nb">local</span> -a _ebg_Target
    <span class="nb">local </span>_ebg_x
    <span class="nb">local </span>_ebg_t
    <span class="nb">local </span><span class="nv">IFS</span><span class="o">=</span><span class="si">${</span><span class="nv">NO_WSP</span><span class="si">}</span>
    <span class="nb">set</span> -f
    <span class="nb">eval </span><span class="nv">_ebg_Excludes</span><span class="o">=</span><span class="se">\(</span> <span class="se">\$\{</span><span class="nv">$1</span><span class="se">\[</span>@<span class="se">\]\}</span> <span class="se">\)</span>
    <span class="nb">eval </span><span class="nv">_ebg_Target</span><span class="o">=</span><span class="se">\(</span> <span class="se">\$\{</span><span class="nv">$2</span><span class="se">\[</span>@<span class="se">\]\}</span> <span class="se">\)</span>
    <span class="nb">local </span><span class="nv">_ebg_len</span><span class="o">=</span><span class="si">${#</span><span class="nv">_ebg_Target</span><span class="p">[@]</span><span class="si">}</span>
    <span class="nb">local </span><span class="nv">_ebg_cnt</span><span class="o">=</span><span class="si">${#</span><span class="nv">_ebg_Excludes</span><span class="p">[@]</span><span class="si">}</span>
    <span class="o">[</span> <span class="si">${</span><span class="nv">_ebg_len</span><span class="si">}</span> -ne <span class="m">0</span> <span class="o">]</span> <span class="p">|</span><span class="k">return</span> 0
    <span class="o">[</span> <span class="si">${</span><span class="nv">_ebg_cnt</span><span class="si">}</span> -ne <span class="m">0</span> <span class="o">]</span> <span class="p">|</span><span class="k">return</span> 0
    <span class="k">for</span> <span class="o">((</span> <span class="nv">x</span> <span class="o">=</span> 0<span class="p">;</span> x &lt; <span class="si">${</span><span class="nv">_ebg_cnt</span><span class="si">}</span> <span class="p">;</span> x++ <span class="o">))</span>
    <span class="k">do</span>
        <span class="nv">_ebg_x</span><span class="o">=</span><span class="si">${</span><span class="nv">_ebg_Excludes</span><span class="p">[</span><span class="nv">$x</span><span class="p">]</span><span class="si">}</span>
        <span class="k">for</span> <span class="o">((</span> <span class="nv">n</span> <span class="o">=</span> <span class="m">0</span> <span class="p">;</span> n &lt; <span class="si">${</span><span class="nv">_ebg_len</span><span class="si">}</span> <span class="p">;</span> n++ <span class="o">))</span>
        <span class="k">do</span>
            <span class="o">[</span> <span class="nv">$# </span>-eq <span class="m">3</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nv">_ebg_x</span><span class="o">=</span><span class="si">${</span><span class="nv">_ebg_x</span><span class="si">}</span><span class="s1">&#39;*&#39;</span>  <span class="c">#  Do prefix edit</span>
            <span class="k">if</span> <span class="o">[</span> <span class="si">${</span><span class="nv">_ebg_Target</span><span class="p">[</span><span class="nv">$n</span><span class="p">]:=</span><span class="si">}</span> <span class="o">]</span>          <span class="c">#+ if defined &amp; set.</span>
            <span class="k">then</span>
                <span class="nv">_ebg_t</span><span class="o">=</span><span class="si">${</span><span class="nv">_ebg_Target</span><span class="p">[</span><span class="nv">$n</span><span class="p">]/#</span><span class="si">${</span><span class="nv">_ebg_x</span><span class="si">}</span><span class="p">/</span><span class="si">}</span>
                <span class="o">[</span> <span class="si">${#</span><span class="nv">_ebg_t</span><span class="si">}</span> -eq <span class="m">0</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">unset </span>_ebg_Target<span class="o">[</span><span class="nv">$n</span><span class="o">]</span>
            <span class="k">fi</span>
        <span class="k">done</span>
    <span class="k">done</span>
    <span class="nb">eval</span> <span class="nv">$2</span><span class="o">=</span><span class="se">\(</span> <span class="se">\$\{</span>_ebg_Target<span class="se">\[</span>@<span class="se">\]\}</span> <span class="se">\)</span>
    <span class="nb">set</span> +f
    <span class="k">return</span> 0
<span class="o">}</span>

<span class="c"># This function described in unique_lines.bash.</span>
<span class="c"># unique_lines &lt;in_name&gt; &lt;out_name&gt;</span>
unique_lines<span class="o">()</span> <span class="o">{</span>
    <span class="o">[</span> <span class="nv">$# </span>-eq <span class="m">2</span> <span class="o">]</span> <span class="p">|</span><span class="k">return</span> 1
    <span class="nb">local</span> -a _ul_in
    <span class="nb">local</span> -a _ul_out
    <span class="nb">local</span> -i _ul_cnt
    <span class="nb">local</span> -i _ul_pos
    <span class="nb">local </span>_ul_tmp
    <span class="nb">local </span><span class="nv">IFS</span><span class="o">=</span><span class="si">${</span><span class="nv">NO_WSP</span><span class="si">}</span>
    <span class="nb">set</span> -f
    <span class="nb">eval </span><span class="nv">_ul_in</span><span class="o">=</span><span class="se">\(</span> <span class="se">\$\{</span><span class="nv">$1</span><span class="se">\[</span>@<span class="se">\]\}</span> <span class="se">\)</span>
    <span class="nv">_ul_cnt</span><span class="o">=</span><span class="si">${#</span><span class="nv">_ul_in</span><span class="p">[@]</span><span class="si">}</span>
    <span class="k">for</span> <span class="o">((</span> <span class="nv">_ul_pos</span> <span class="o">=</span> <span class="m">0</span> <span class="p">;</span> _ul_pos &lt; <span class="si">${</span><span class="nv">_ul_cnt</span><span class="si">}</span> <span class="p">;</span> _ul_pos++ <span class="o">))</span>
    <span class="k">do</span>
        <span class="k">if</span> <span class="o">[</span> <span class="si">${</span><span class="nv">_ul_in</span><span class="p">[</span><span class="si">${</span><span class="nv">_ul_pos</span><span class="si">}</span><span class="p">]:=</span><span class="si">}</span> <span class="o">]</span>      <span class="c"># If defined &amp; not empty</span>
        <span class="k">then</span>
            <span class="nv">_ul_tmp</span><span class="o">=</span><span class="si">${</span><span class="nv">_ul_in</span><span class="p">[</span><span class="si">${</span><span class="nv">_ul_pos</span><span class="si">}</span><span class="p">]</span><span class="si">}</span>
            _ul_out<span class="o">[</span><span class="si">${#</span><span class="nv">_ul_out</span><span class="p">[@]</span><span class="si">}</span><span class="o">]=</span><span class="si">${</span><span class="nv">_ul_tmp</span><span class="si">}</span>
            <span class="k">for</span> <span class="o">((</span> <span class="nv">zap</span> <span class="o">=</span> _ul_pos <span class="p">;</span> zap &lt; <span class="si">${</span><span class="nv">_ul_cnt</span><span class="si">}</span> <span class="p">;</span> zap++ <span class="o">))</span>
            <span class="k">do</span>
                <span class="o">[</span> <span class="si">${</span><span class="nv">_ul_in</span><span class="p">[</span><span class="si">${</span><span class="nv">zap</span><span class="si">}</span><span class="p">]:=</span><span class="si">}</span> <span class="o">]</span> <span class="o">&amp;&amp;</span>
                <span class="o">[</span> <span class="s1">&#39;x&#39;</span><span class="si">${</span><span class="nv">_ul_in</span><span class="p">[</span><span class="si">${</span><span class="nv">zap</span><span class="si">}</span><span class="p">]</span><span class="si">}</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span><span class="si">${</span><span class="nv">_ul_tmp</span><span class="si">}</span> <span class="o">]</span> <span class="o">&amp;&amp;</span>
                    <span class="nb">unset </span>_ul_in<span class="o">[</span><span class="si">${</span><span class="nv">zap</span><span class="si">}</span><span class="o">]</span>
            <span class="k">done</span>
        <span class="k">fi</span>
    <span class="k">done</span>
    <span class="nb">eval</span> <span class="nv">$2</span><span class="o">=</span><span class="se">\(</span> <span class="se">\$\{</span>_ul_out<span class="se">\[</span>@<span class="se">\]\}</span> <span class="se">\)</span>
    <span class="nb">set</span> +f
    <span class="k">return</span> 0
<span class="o">}</span>

<span class="c"># This function described in char_convert.bash.</span>
<span class="c"># to_lower &lt;string&gt;</span>
to_lower<span class="o">()</span> <span class="o">{</span>
    <span class="o">[</span> <span class="nv">$# </span>-eq <span class="m">1</span> <span class="o">]</span> <span class="p">|</span><span class="k">return</span> 1
    <span class="nb">local </span>_tl_out
    <span class="nv">_tl_out</span><span class="o">=</span><span class="si">${</span><span class="nv">1</span><span class="p">//A/a</span><span class="si">}</span>
    <span class="nv">_tl_out</span><span class="o">=</span><span class="si">${</span><span class="nv">_tl_out</span><span class="p">//B/b</span><span class="si">}</span>
    <span class="nv">_tl_out</span><span class="o">=</span><span class="si">${</span><span class="nv">_tl_out</span><span class="p">//C/c</span><span class="si">}</span>
    <span class="nv">_tl_out</span><span class="o">=</span><span class="si">${</span><span class="nv">_tl_out</span><span class="p">//D/d</span><span class="si">}</span>
    <span class="nv">_tl_out</span><span class="o">=</span><span class="si">${</span><span class="nv">_tl_out</span><span class="p">//E/e</span><span class="si">}</span>
    <span class="nv">_tl_out</span><span class="o">=</span><span class="si">${</span><span class="nv">_tl_out</span><span class="p">//F/f</span><span class="si">}</span>
    <span class="nv">_tl_out</span><span class="o">=</span><span class="si">${</span><span class="nv">_tl_out</span><span class="p">//G/g</span><span class="si">}</span>
    <span class="nv">_tl_out</span><span class="o">=</span><span class="si">${</span><span class="nv">_tl_out</span><span class="p">//H/h</span><span class="si">}</span>
    <span class="nv">_tl_out</span><span class="o">=</span><span class="si">${</span><span class="nv">_tl_out</span><span class="p">//I/i</span><span class="si">}</span>
    <span class="nv">_tl_out</span><span class="o">=</span><span class="si">${</span><span class="nv">_tl_out</span><span class="p">//J/j</span><span class="si">}</span>
    <span class="nv">_tl_out</span><span class="o">=</span><span class="si">${</span><span class="nv">_tl_out</span><span class="p">//K/k</span><span class="si">}</span>
    <span class="nv">_tl_out</span><span class="o">=</span><span class="si">${</span><span class="nv">_tl_out</span><span class="p">//L/l</span><span class="si">}</span>
    <span class="nv">_tl_out</span><span class="o">=</span><span class="si">${</span><span class="nv">_tl_out</span><span class="p">//M/m</span><span class="si">}</span>
    <span class="nv">_tl_out</span><span class="o">=</span><span class="si">${</span><span class="nv">_tl_out</span><span class="p">//N/n</span><span class="si">}</span>
    <span class="nv">_tl_out</span><span class="o">=</span><span class="si">${</span><span class="nv">_tl_out</span><span class="p">//O/o</span><span class="si">}</span>
    <span class="nv">_tl_out</span><span class="o">=</span><span class="si">${</span><span class="nv">_tl_out</span><span class="p">//P/p</span><span class="si">}</span>
    <span class="nv">_tl_out</span><span class="o">=</span><span class="si">${</span><span class="nv">_tl_out</span><span class="p">//Q/q</span><span class="si">}</span>
    <span class="nv">_tl_out</span><span class="o">=</span><span class="si">${</span><span class="nv">_tl_out</span><span class="p">//R/r</span><span class="si">}</span>
    <span class="nv">_tl_out</span><span class="o">=</span><span class="si">${</span><span class="nv">_tl_out</span><span class="p">//S/s</span><span class="si">}</span>
    <span class="nv">_tl_out</span><span class="o">=</span><span class="si">${</span><span class="nv">_tl_out</span><span class="p">//T/t</span><span class="si">}</span>
    <span class="nv">_tl_out</span><span class="o">=</span><span class="si">${</span><span class="nv">_tl_out</span><span class="p">//U/u</span><span class="si">}</span>
    <span class="nv">_tl_out</span><span class="o">=</span><span class="si">${</span><span class="nv">_tl_out</span><span class="p">//V/v</span><span class="si">}</span>
    <span class="nv">_tl_out</span><span class="o">=</span><span class="si">${</span><span class="nv">_tl_out</span><span class="p">//W/w</span><span class="si">}</span>
    <span class="nv">_tl_out</span><span class="o">=</span><span class="si">${</span><span class="nv">_tl_out</span><span class="p">//X/x</span><span class="si">}</span>
    <span class="nv">_tl_out</span><span class="o">=</span><span class="si">${</span><span class="nv">_tl_out</span><span class="p">//Y/y</span><span class="si">}</span>
    <span class="nv">_tl_out</span><span class="o">=</span><span class="si">${</span><span class="nv">_tl_out</span><span class="p">//Z/z</span><span class="si">}</span>
    <span class="nb">echo</span> <span class="si">${</span><span class="nv">_tl_out</span><span class="si">}</span>
    <span class="k">return</span> 0
<span class="o">}</span>

<span class="c">#### Application helper functions ####</span>

<span class="c"># Not everybody uses dots as separators (APNIC, for example).</span>
<span class="c"># This function described in to_dot.bash</span>
<span class="c"># to_dot &lt;string&gt;</span>
to_dot<span class="o">()</span> <span class="o">{</span>
    <span class="o">[</span> <span class="nv">$# </span>-eq <span class="m">1</span> <span class="o">]</span> <span class="p">|</span><span class="k">return</span> 1
    <span class="nb">echo</span> <span class="si">${</span><span class="nv">1</span><span class="p">//[#|@|%]/.</span><span class="si">}</span>
    <span class="k">return</span> 0
<span class="o">}</span>

<span class="c"># This function described in is_number.bash.</span>
<span class="c"># is_number &lt;input&gt;</span>
is_number<span class="o">()</span> <span class="o">{</span>
    <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$#&quot;</span><span class="s2"> -eq 1 ]    |return 1  # is blank?</span>
<span class="s2">    [ x&quot;</span><span class="nv">$1</span><span class="s2">&quot; == &#39;x0&#39; ] &amp;&amp; return 0  # is zero?</span>
<span class="s2">    local -i tst</span>
<span class="s2">    let tst=</span><span class="nv">$1</span><span class="s2"> 2&gt;/dev/null         # else is numeric!</span>
<span class="s2">    return </span><span class="nv">$?</span><span class="s2"></span>
<span class="s2">}</span>

<span class="s2"># This function described in is_address.bash.</span>
<span class="s2"># is_address &lt;input&gt;</span>
<span class="s2">is_address() {</span>
<span class="s2">    [ </span><span class="nv">$# </span><span class="s2">-eq 1 ] |return 1    # Blank ==&gt; false</span>
<span class="s2">    local -a _ia_input</span>
<span class="s2">    local IFS=</span><span class="si">${</span><span class="nv">ADR_IFS</span><span class="si">}</span><span class="s2"></span>
<span class="s2">    _ia_input=( </span><span class="nv">$1</span><span class="s2"> )</span>
<span class="s2">    if  [ </span><span class="si">${#</span><span class="nv">_ia_input</span><span class="p">[@]</span><span class="si">}</span><span class="s2"> -eq 4 ]  &amp;&amp;</span>
<span class="s2">        is_number </span><span class="si">${</span><span class="nv">_ia_input</span><span class="p">[0]</span><span class="si">}</span><span class="s2">   &amp;&amp;</span>
<span class="s2">        is_number </span><span class="si">${</span><span class="nv">_ia_input</span><span class="p">[1]</span><span class="si">}</span><span class="s2">   &amp;&amp;</span>
<span class="s2">        is_number </span><span class="si">${</span><span class="nv">_ia_input</span><span class="p">[2]</span><span class="si">}</span><span class="s2">   &amp;&amp;</span>
<span class="s2">        is_number </span><span class="si">${</span><span class="nv">_ia_input</span><span class="p">[3]</span><span class="si">}</span><span class="s2">   &amp;&amp;</span>
<span class="s2">        [ </span><span class="si">${</span><span class="nv">_ia_input</span><span class="p">[0]</span><span class="si">}</span><span class="s2"> -lt 256 ] &amp;&amp;</span>
<span class="s2">        [ </span><span class="si">${</span><span class="nv">_ia_input</span><span class="p">[1]</span><span class="si">}</span><span class="s2"> -lt 256 ] &amp;&amp;</span>
<span class="s2">        [ </span><span class="si">${</span><span class="nv">_ia_input</span><span class="p">[2]</span><span class="si">}</span><span class="s2"> -lt 256 ] &amp;&amp;</span>
<span class="s2">        [ </span><span class="si">${</span><span class="nv">_ia_input</span><span class="p">[3]</span><span class="si">}</span><span class="s2"> -lt 256 ]</span>
<span class="s2">    then</span>
<span class="s2">        return 0</span>
<span class="s2">    else</span>
<span class="s2">        return 1</span>
<span class="s2">    fi</span>
<span class="s2">}</span>

<span class="s2">#  This function described in split_ip.bash.</span>
<span class="s2">#  split_ip &lt;IP_address&gt;</span>
<span class="s2">#+ &lt;array_name_norm&gt; [&lt;array_name_rev&gt;]</span>
<span class="s2">split_ip() {</span>
<span class="s2">    [ </span><span class="nv">$# </span><span class="s2">-eq 3 ] |             #  Either three</span>
<span class="s2">    [ </span><span class="nv">$# </span><span class="s2">-eq 2 ] |return 1     #+ or two arguments</span>
<span class="s2">    local -a _si_input</span>
<span class="s2">    local IFS=</span><span class="si">${</span><span class="nv">ADR_IFS</span><span class="si">}</span><span class="s2"></span>
<span class="s2">    _si_input=( </span><span class="nv">$1</span><span class="s2"> )</span>
<span class="s2">    IFS=</span><span class="si">${</span><span class="nv">WSP_IFS</span><span class="si">}</span><span class="s2"></span>
<span class="s2">    eval </span><span class="nv">$2</span><span class="s2">=\(\ \$\{_si_input\[@\]\}\ \)</span>
<span class="s2">    if [ </span><span class="nv">$# </span><span class="s2">-eq 3 ]</span>
<span class="s2">    then</span>
<span class="s2">        # Build query order array.</span>
<span class="s2">        local -a _dns_ip</span>
<span class="s2">        _dns_ip[0]=</span><span class="si">${</span><span class="nv">_si_input</span><span class="p">[3]</span><span class="si">}</span><span class="s2"></span>
<span class="s2">        _dns_ip[1]=</span><span class="si">${</span><span class="nv">_si_input</span><span class="p">[2]</span><span class="si">}</span><span class="s2"></span>
<span class="s2">        _dns_ip[2]=</span><span class="si">${</span><span class="nv">_si_input</span><span class="p">[1]</span><span class="si">}</span><span class="s2"></span>
<span class="s2">        _dns_ip[3]=</span><span class="si">${</span><span class="nv">_si_input</span><span class="p">[0]</span><span class="si">}</span><span class="s2"></span>
<span class="s2">        eval </span><span class="nv">$3</span><span class="s2">=\(\ \$\{_dns_ip\[@\]\}\ \)</span>
<span class="s2">    fi</span>
<span class="s2">    return 0</span>
<span class="s2">}</span>

<span class="s2"># This function described in dot_array.bash.</span>
<span class="s2"># dot_array &lt;array_name&gt;</span>
<span class="s2">dot_array() {</span>
<span class="s2">    [ </span><span class="nv">$# </span><span class="s2">-eq 1 ] |return 1     # Single argument required.</span>
<span class="s2">    local -a _da_input</span>
<span class="s2">    eval _da_input=\(\ \$\{</span><span class="nv">$1</span><span class="s2">\[@\]\}\ \)</span>
<span class="s2">    local IFS=</span><span class="si">${</span><span class="nv">DOT_IFS</span><span class="si">}</span><span class="s2"></span>
<span class="s2">    local _da_output=</span><span class="si">${</span><span class="nv">_da_input</span><span class="p">[@]</span><span class="si">}</span><span class="s2"></span>
<span class="s2">    IFS=</span><span class="si">${</span><span class="nv">WSP_IFS</span><span class="si">}</span><span class="s2"></span>
<span class="s2">    echo </span><span class="si">${</span><span class="nv">_da_output</span><span class="si">}</span><span class="s2"></span>
<span class="s2">    return 0</span>
<span class="s2">}</span>

<span class="s2"># This function described in file_to_array.bash</span>
<span class="s2"># file_to_array &lt;file_name&gt; &lt;line_array_name&gt;</span>
<span class="s2">file_to_array() {</span>
<span class="s2">    [ </span><span class="nv">$# </span><span class="s2">-eq 2 ] |return 1  # Two arguments required.</span>
<span class="s2">    local IFS=</span><span class="si">${</span><span class="nv">NO_WSP</span><span class="si">}</span><span class="s2"></span>
<span class="s2">    local -a _fta_tmp_</span>
<span class="s2">    _fta_tmp_=( </span><span class="k">$(</span>cat <span class="nv">$1</span><span class="k">)</span><span class="s2"> )</span>
<span class="s2">    eval </span><span class="nv">$2</span><span class="s2">=\( \$\{_fta_tmp_\[@\]\} \)</span>
<span class="s2">    return 0</span>
<span class="s2">}</span>

<span class="s2">#  Columnized print of an array of multi-field strings.</span>
<span class="s2">#  col_print &lt;array_name&gt; &lt;min_space&gt; &lt;</span>
<span class="s2">#+ tab_stop [tab_stops]&gt;</span>
<span class="s2">col_print() {</span>
<span class="s2">    [ </span><span class="nv">$# </span><span class="s2">-gt 2 ] |return 0</span>
<span class="s2">    local -a _cp_inp</span>
<span class="s2">    local -a _cp_spc</span>
<span class="s2">    local -a _cp_line</span>
<span class="s2">    local _cp_min</span>
<span class="s2">    local _cp_mcnt</span>
<span class="s2">    local _cp_pos</span>
<span class="s2">    local _cp_cnt</span>
<span class="s2">    local _cp_tab</span>
<span class="s2">    local -i _cp</span>
<span class="s2">    local -i _cpf</span>
<span class="s2">    local _cp_fld</span>
<span class="s2">    # WARNING: FOLLOWING LINE NOT BLANK -- IT IS QUOTED SPACES.</span>
<span class="s2">    local _cp_max=&#39;                                                            &#39;</span>
<span class="s2">    set -f</span>
<span class="s2">    local IFS=</span><span class="si">${</span><span class="nv">NO_WSP</span><span class="si">}</span><span class="s2"></span>
<span class="s2">    eval _cp_inp=\(\ \$\{</span><span class="nv">$1</span><span class="s2">\[@\]\}\ \)</span>
<span class="s2">    [ </span><span class="si">${#</span><span class="nv">_cp_inp</span><span class="p">[@]</span><span class="si">}</span><span class="s2"> -gt 0 ] |return 0 # Empty is easy.</span>
<span class="s2">    _cp_mcnt=</span><span class="nv">$2</span><span class="s2"></span>
<span class="s2">    _cp_min=</span><span class="si">${</span><span class="nv">_cp_max</span><span class="p">:</span><span class="nv">1</span><span class="p">:</span><span class="si">${</span><span class="nv">_cp_mcnt</span><span class="si">}}</span><span class="s2"></span>
<span class="s2">    shift</span>
<span class="s2">    shift</span>
<span class="s2">    _cp_cnt=</span><span class="nv">$#</span><span class="s2"></span>
<span class="s2">    for (( _cp = 0 ; _cp &lt; _cp_cnt ; _cp++ ))</span>
<span class="s2">    do</span>
<span class="s2">        _cp_spc[</span><span class="si">${#</span><span class="nv">_cp_spc</span><span class="p">[@]</span><span class="si">}</span><span class="s2">]=&quot;</span><span class="si">${</span><span class="nv">_cp_max</span><span class="p">:</span><span class="nv">2</span><span class="p">:</span><span class="nv">$1</span><span class="si">}</span><span class="s2">&quot; #&quot;</span>
        <span class="nb">shift</span>
<span class="nb">    </span><span class="k">done</span>
    <span class="nv">_cp_cnt</span><span class="o">=</span><span class="si">${#</span><span class="nv">_cp_inp</span><span class="p">[@]</span><span class="si">}</span>
    <span class="k">for</span> <span class="o">((</span> <span class="nv">_cp</span> <span class="o">=</span> <span class="m">0</span> <span class="p">;</span> _cp &lt; _cp_cnt <span class="p">;</span> _cp++ <span class="o">))</span>
    <span class="k">do</span>
        <span class="nv">_cp_pos</span><span class="o">=</span>1
        <span class="nv">IFS</span><span class="o">=</span><span class="si">${</span><span class="nv">NO_WSP</span><span class="si">}</span><span class="s1">$&#39;\x20&#39;</span>
        <span class="nv">_cp_line</span><span class="o">=(</span> <span class="si">${</span><span class="nv">_cp_inp</span><span class="p">[</span><span class="si">${</span><span class="nv">_cp</span><span class="si">}</span><span class="p">]</span><span class="si">}</span> <span class="o">)</span>
        <span class="nv">IFS</span><span class="o">=</span><span class="si">${</span><span class="nv">NO_WSP</span><span class="si">}</span>
        <span class="k">for</span> <span class="o">((</span> <span class="nv">_cpf</span> <span class="o">=</span> <span class="m">0</span> <span class="p">;</span> _cpf &lt; <span class="si">${#</span><span class="nv">_cp_line</span><span class="p">[@]</span><span class="si">}</span> <span class="p">;</span> _cpf++ <span class="o">))</span>
        <span class="k">do</span>
            <span class="nv">_cp_tab</span><span class="o">=</span><span class="si">${</span><span class="nv">_cp_spc</span><span class="p">[</span><span class="si">${</span><span class="nv">_cpf</span><span class="si">}</span><span class="p">]:</span><span class="si">${</span><span class="nv">_cp_pos</span><span class="si">}}</span>
            <span class="k">if</span> <span class="o">[</span> <span class="si">${#</span><span class="nv">_cp_tab</span><span class="si">}</span> -lt <span class="si">${</span><span class="nv">_cp_mcnt</span><span class="si">}</span> <span class="o">]</span>
            <span class="k">then</span>
                <span class="nv">_cp_tab</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">_cp_min</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">fi</span>
            <span class="nb">echo</span> -n <span class="s2">&quot;</span><span class="si">${</span><span class="nv">_cp_tab</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="o">((</span> <span class="nv">_cp_pos</span> <span class="o">=</span> <span class="si">${</span><span class="nv">_cp_pos</span><span class="si">}</span> + <span class="si">${#</span><span class="nv">_cp_tab</span><span class="si">}</span> <span class="o">))</span>
            <span class="nv">_cp_fld</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">_cp_line</span><span class="p">[</span><span class="si">${</span><span class="nv">_cpf</span><span class="si">}</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="nb">echo</span> -n <span class="si">${</span><span class="nv">_cp_fld</span><span class="si">}</span>
            <span class="o">((</span> <span class="nv">_cp_pos</span> <span class="o">=</span> <span class="si">${</span><span class="nv">_cp_pos</span><span class="si">}</span> + <span class="si">${#</span><span class="nv">_cp_fld</span><span class="si">}</span> <span class="o">))</span>
        <span class="k">done</span>
        <span class="nb">echo</span>
<span class="nb">    </span><span class="k">done</span>
    <span class="nb">set</span> +f
    <span class="k">return</span> 0
<span class="o">}</span>

<span class="c"># # # # &#39;Hunt the Spammer&#39; data flow # # # #</span>

<span class="c"># Application return code</span>
<span class="nb">declare</span> -i _hs_RC

<span class="c"># Original input, from which IP addresses are removed</span>
<span class="c"># After which, domain names to check</span>
<span class="nb">declare</span> -a uc_name

<span class="c"># Original input IP addresses are moved here</span>
<span class="c"># After which, IP addresses to check</span>
<span class="nb">declare</span> -a uc_address

<span class="c"># Names against which address expansion run</span>
<span class="c"># Ready for name detail lookup</span>
<span class="nb">declare</span> -a chk_name

<span class="c"># Addresses against which name expansion run</span>
<span class="c"># Ready for address detail lookup</span>
<span class="nb">declare</span> -a chk_address

<span class="c">#  Recursion is depth-first-by-name.</span>
<span class="c">#  The expand_input_address maintains this list</span>
<span class="c">#+ to prohibit looking up addresses twice during</span>
<span class="c">#+ domain name recursion.</span>
<span class="nb">declare</span> -a been_there_addr
<span class="nv">been_there_addr</span><span class="o">=(</span> <span class="s1">&#39;127.0.0.1&#39;</span> <span class="o">)</span> <span class="c"># Whitelist localhost</span>

<span class="c"># Names which we have checked (or given up on)</span>
<span class="nb">declare</span> -a known_name

<span class="c"># Addresses which we have checked (or given up on)</span>
<span class="nb">declare</span> -a known_address

<span class="c">#  List of zero or more Blacklist servers to check.</span>
<span class="c">#  Each &#39;known_address&#39; will be checked against each server,</span>
<span class="c">#+ with negative replies and failures suppressed.</span>
<span class="nb">declare</span> -a list_server

<span class="c"># Indirection limit - set to zero == no limit</span>
<span class="nv">indirect</span><span class="o">=</span><span class="si">${</span><span class="nv">SPAMMER_LIMIT</span><span class="p">:=2</span><span class="si">}</span>

<span class="c"># # # # &#39;Hunt the Spammer&#39; information output data # # # #</span>

<span class="c"># Any domain name may have multiple IP addresses.</span>
<span class="c"># Any IP address may have multiple domain names.</span>
<span class="c"># Therefore, track unique address-name pairs.</span>
<span class="nb">declare</span> -a known_pair
<span class="nb">declare</span> -a reverse_pair

<span class="c">#  In addition to the data flow variables; known_address</span>
<span class="c">#+ known_name and list_server, the following are output to the</span>
<span class="c">#+ external graphics interface file.</span>

<span class="c"># Authority chain, parent -&gt; SOA fields.</span>
<span class="nb">declare</span> -a auth_chain

<span class="c"># Reference chain, parent name -&gt; child name</span>
<span class="nb">declare</span> -a ref_chain

<span class="c"># DNS chain - domain name -&gt; address</span>
<span class="nb">declare</span> -a name_address

<span class="c"># Name and service pairs - domain name -&gt; service</span>
<span class="nb">declare</span> -a name_srvc

<span class="c"># Name and resource pairs - domain name -&gt; Resource Record</span>
<span class="nb">declare</span> -a name_resource

<span class="c"># Parent and Child pairs - parent name -&gt; child name</span>
<span class="c"># This MAY NOT be the same as the ref_chain followed!</span>
<span class="nb">declare</span> -a parent_child

<span class="c"># Address and Blacklist hit pairs - address-&gt;server</span>
<span class="nb">declare</span> -a address_hits

<span class="c"># Dump interface file data</span>
<span class="nb">declare</span> -f _dot_dump
<span class="nv">_dot_dump</span><span class="o">=</span>pend_dummy   <span class="c"># Initially a no-op</span>

<span class="c">#  Data dump is enabled by setting the environment variable SPAMMER_DATA</span>
<span class="c">#+ to the name of a writable file.</span>
<span class="nb">declare </span>_dot_file

<span class="c"># Helper function for the dump-to-dot-file function</span>
<span class="c"># dump_to_dot &lt;array_name&gt; &lt;prefix&gt;</span>
dump_to_dot<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local</span> -a _dda_tmp
    <span class="nb">local</span> -i _dda_cnt
    <span class="nb">local </span><span class="nv">_dda_form</span><span class="o">=</span><span class="s1">&#39;    &#39;</span><span class="si">${</span><span class="nv">2</span><span class="si">}</span><span class="s1">&#39;%04u %s\n&#39;</span>
    <span class="nb">local </span><span class="nv">IFS</span><span class="o">=</span><span class="si">${</span><span class="nv">NO_WSP</span><span class="si">}</span>
    <span class="nb">eval </span><span class="nv">_dda_tmp</span><span class="o">=</span><span class="se">\(\ \$\{</span><span class="nv">$1</span><span class="se">\[</span>@<span class="se">\]\}\ \)</span>
    <span class="nv">_dda_cnt</span><span class="o">=</span><span class="si">${#</span><span class="nv">_dda_tmp</span><span class="p">[@]</span><span class="si">}</span>
    <span class="k">if</span> <span class="o">[</span> <span class="si">${</span><span class="nv">_dda_cnt</span><span class="si">}</span> -gt <span class="m">0</span> <span class="o">]</span>
    <span class="k">then</span>
        <span class="k">for</span> <span class="o">((</span> <span class="nv">_dda</span> <span class="o">=</span> <span class="m">0</span> <span class="p">;</span> _dda &lt; _dda_cnt <span class="p">;</span> _dda++ <span class="o">))</span>
        <span class="k">do</span>
            <span class="nb">printf</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">_dda_form</span><span class="si">}</span><span class="s2">&quot;</span> <span class="se">\</span>
                   <span class="s2">&quot;</span><span class="si">${</span><span class="nv">_dda</span><span class="si">}</span><span class="s2">&quot;</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">_dda_tmp</span><span class="p">[</span><span class="si">${</span><span class="nv">_dda</span><span class="si">}</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> &gt;&gt;<span class="si">${</span><span class="nv">_dot_file</span><span class="si">}</span>
        <span class="k">done</span>
    <span class="k">fi</span>
<span class="o">}</span>

<span class="c"># Which will also set _dot_dump to this function . . .</span>
dump_dot<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local</span> -i _dd_cnt
    <span class="nb">echo</span> <span class="s1">&#39;# Data vintage: &#39;</span><span class="k">$(</span>date -R<span class="k">)</span> &gt;<span class="si">${</span><span class="nv">_dot_file</span><span class="si">}</span>
    <span class="nb">echo</span> <span class="s1">&#39;# ABS Guide: is_spammer.bash; v2, 2004-msz&#39;</span> &gt;&gt;<span class="si">${</span><span class="nv">_dot_file</span><span class="si">}</span>
    <span class="nb">echo</span> &gt;&gt;<span class="si">${</span><span class="nv">_dot_file</span><span class="si">}</span>
    <span class="nb">echo</span> <span class="s1">&#39;digraph G {&#39;</span> &gt;&gt;<span class="si">${</span><span class="nv">_dot_file</span><span class="si">}</span>

    <span class="k">if</span> <span class="o">[</span> <span class="si">${#</span><span class="nv">known_name</span><span class="p">[@]</span><span class="si">}</span> -gt <span class="m">0</span> <span class="o">]</span>
    <span class="k">then</span>
        <span class="nb">echo</span> &gt;&gt;<span class="si">${</span><span class="nv">_dot_file</span><span class="si">}</span>
        <span class="nb">echo</span> <span class="s1">&#39;# Known domain name nodes&#39;</span> &gt;&gt;<span class="si">${</span><span class="nv">_dot_file</span><span class="si">}</span>
        <span class="nv">_dd_cnt</span><span class="o">=</span><span class="si">${#</span><span class="nv">known_name</span><span class="p">[@]</span><span class="si">}</span>
        <span class="k">for</span> <span class="o">((</span> <span class="nv">_dd</span> <span class="o">=</span> <span class="m">0</span> <span class="p">;</span> _dd &lt; _dd_cnt <span class="p">;</span> _dd++ <span class="o">))</span>
        <span class="k">do</span>
            <span class="nb">printf</span> <span class="s1">&#39;    N%04u [label=&quot;%s&quot;] ;\n&#39;</span> <span class="se">\</span>
                   <span class="s2">&quot;</span><span class="si">${</span><span class="nv">_dd</span><span class="si">}</span><span class="s2">&quot;</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">known_name</span><span class="p">[</span><span class="si">${</span><span class="nv">_dd</span><span class="si">}</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> &gt;&gt;<span class="si">${</span><span class="nv">_dot_file</span><span class="si">}</span>
        <span class="k">done</span>
    <span class="k">fi</span>

    <span class="k">if</span> <span class="o">[</span> <span class="si">${#</span><span class="nv">known_address</span><span class="p">[@]</span><span class="si">}</span> -gt <span class="m">0</span> <span class="o">]</span>
    <span class="k">then</span>
        <span class="nb">echo</span> &gt;&gt;<span class="si">${</span><span class="nv">_dot_file</span><span class="si">}</span>
        <span class="nb">echo</span> <span class="s1">&#39;# Known address nodes&#39;</span> &gt;&gt;<span class="si">${</span><span class="nv">_dot_file</span><span class="si">}</span>
        <span class="nv">_dd_cnt</span><span class="o">=</span><span class="si">${#</span><span class="nv">known_address</span><span class="p">[@]</span><span class="si">}</span>
        <span class="k">for</span> <span class="o">((</span> <span class="nv">_dd</span> <span class="o">=</span> <span class="m">0</span> <span class="p">;</span> _dd &lt; _dd_cnt <span class="p">;</span> _dd++ <span class="o">))</span>
        <span class="k">do</span>
            <span class="nb">printf</span> <span class="s1">&#39;    A%04u [label=&quot;%s&quot;] ;\n&#39;</span> <span class="se">\</span>
                   <span class="s2">&quot;</span><span class="si">${</span><span class="nv">_dd</span><span class="si">}</span><span class="s2">&quot;</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">known_address</span><span class="p">[</span><span class="si">${</span><span class="nv">_dd</span><span class="si">}</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> &gt;&gt;<span class="si">${</span><span class="nv">_dot_file</span><span class="si">}</span>
        <span class="k">done</span>
    <span class="k">fi</span>

    <span class="nb">echo</span>                                   &gt;&gt;<span class="si">${</span><span class="nv">_dot_file</span><span class="si">}</span>
    <span class="nb">echo</span> <span class="s1">&#39;/*&#39;</span>                              &gt;&gt;<span class="si">${</span><span class="nv">_dot_file</span><span class="si">}</span>
    <span class="nb">echo</span> <span class="s1">&#39; * Known relationships :: User conversion to&#39;</span>  &gt;&gt;<span class="si">${</span><span class="nv">_dot_file</span><span class="si">}</span>
    <span class="nb">echo</span> <span class="s1">&#39; * graphic form by hand or program required.&#39;</span>  &gt;&gt;<span class="si">${</span><span class="nv">_dot_file</span><span class="si">}</span>
    <span class="nb">echo</span> <span class="s1">&#39; *&#39;</span>                              &gt;&gt;<span class="si">${</span><span class="nv">_dot_file</span><span class="si">}</span>

    <span class="k">if</span> <span class="o">[</span> <span class="si">${#</span><span class="nv">auth_chain</span><span class="p">[@]</span><span class="si">}</span> -gt <span class="m">0</span> <span class="o">]</span>
    <span class="k">then</span>
      <span class="nb">echo</span> &gt;&gt;<span class="si">${</span><span class="nv">_dot_file</span><span class="si">}</span>
      <span class="nb">echo</span> <span class="s1">&#39;# Authority ref. edges followed &amp; field source.&#39;</span> &gt;&gt;<span class="si">${</span><span class="nv">_dot_file</span><span class="si">}</span>
        dump_to_dot auth_chain AC
    <span class="k">fi</span>

    <span class="k">if</span> <span class="o">[</span> <span class="si">${#</span><span class="nv">ref_chain</span><span class="p">[@]</span><span class="si">}</span> -gt <span class="m">0</span> <span class="o">]</span>
    <span class="k">then</span>
        <span class="nb">echo</span> &gt;&gt;<span class="si">${</span><span class="nv">_dot_file</span><span class="si">}</span>
        <span class="nb">echo</span> <span class="s1">&#39;# Name ref. edges followed and field source.&#39;</span> &gt;&gt;<span class="si">${</span><span class="nv">_dot_file</span><span class="si">}</span>
        dump_to_dot ref_chain RC
    <span class="k">fi</span>

    <span class="k">if</span> <span class="o">[</span> <span class="si">${#</span><span class="nv">name_address</span><span class="p">[@]</span><span class="si">}</span> -gt <span class="m">0</span> <span class="o">]</span>
    <span class="k">then</span>
        <span class="nb">echo</span> &gt;&gt;<span class="si">${</span><span class="nv">_dot_file</span><span class="si">}</span>
        <span class="nb">echo</span> <span class="s1">&#39;# Known name-&gt;address edges&#39;</span> &gt;&gt;<span class="si">${</span><span class="nv">_dot_file</span><span class="si">}</span>
        dump_to_dot name_address NA
    <span class="k">fi</span>

    <span class="k">if</span> <span class="o">[</span> <span class="si">${#</span><span class="nv">name_srvc</span><span class="p">[@]</span><span class="si">}</span> -gt <span class="m">0</span> <span class="o">]</span>
    <span class="k">then</span>
        <span class="nb">echo</span> &gt;&gt;<span class="si">${</span><span class="nv">_dot_file</span><span class="si">}</span>
        <span class="nb">echo</span> <span class="s1">&#39;# Known name-&gt;service edges&#39;</span> &gt;&gt;<span class="si">${</span><span class="nv">_dot_file</span><span class="si">}</span>
        dump_to_dot name_srvc NS
    <span class="k">fi</span>

    <span class="k">if</span> <span class="o">[</span> <span class="si">${#</span><span class="nv">name_resource</span><span class="p">[@]</span><span class="si">}</span> -gt <span class="m">0</span> <span class="o">]</span>
    <span class="k">then</span>
        <span class="nb">echo</span> &gt;&gt;<span class="si">${</span><span class="nv">_dot_file</span><span class="si">}</span>
        <span class="nb">echo</span> <span class="s1">&#39;# Known name-&gt;resource edges&#39;</span> &gt;&gt;<span class="si">${</span><span class="nv">_dot_file</span><span class="si">}</span>
        dump_to_dot name_resource NR
    <span class="k">fi</span>

    <span class="k">if</span> <span class="o">[</span> <span class="si">${#</span><span class="nv">parent_child</span><span class="p">[@]</span><span class="si">}</span> -gt <span class="m">0</span> <span class="o">]</span>
    <span class="k">then</span>
        <span class="nb">echo</span> &gt;&gt;<span class="si">${</span><span class="nv">_dot_file</span><span class="si">}</span>
        <span class="nb">echo</span> <span class="s1">&#39;# Known parent-&gt;child edges&#39;</span> &gt;&gt;<span class="si">${</span><span class="nv">_dot_file</span><span class="si">}</span>
        dump_to_dot parent_child PC
    <span class="k">fi</span>

    <span class="k">if</span> <span class="o">[</span> <span class="si">${#</span><span class="nv">list_server</span><span class="p">[@]</span><span class="si">}</span> -gt <span class="m">0</span> <span class="o">]</span>
    <span class="k">then</span>
        <span class="nb">echo</span> &gt;&gt;<span class="si">${</span><span class="nv">_dot_file</span><span class="si">}</span>
        <span class="nb">echo</span> <span class="s1">&#39;# Known Blacklist nodes&#39;</span> &gt;&gt;<span class="si">${</span><span class="nv">_dot_file</span><span class="si">}</span>
        <span class="nv">_dd_cnt</span><span class="o">=</span><span class="si">${#</span><span class="nv">list_server</span><span class="p">[@]</span><span class="si">}</span>
        <span class="k">for</span> <span class="o">((</span> <span class="nv">_dd</span> <span class="o">=</span> <span class="m">0</span> <span class="p">;</span> _dd &lt; _dd_cnt <span class="p">;</span> _dd++ <span class="o">))</span>
        <span class="k">do</span>
            <span class="nb">printf</span> <span class="s1">&#39;    LS%04u [label=&quot;%s&quot;] ;\n&#39;</span> <span class="se">\</span>
                   <span class="s2">&quot;</span><span class="si">${</span><span class="nv">_dd</span><span class="si">}</span><span class="s2">&quot;</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">list_server</span><span class="p">[</span><span class="si">${</span><span class="nv">_dd</span><span class="si">}</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> &gt;&gt;<span class="si">${</span><span class="nv">_dot_file</span><span class="si">}</span>
        <span class="k">done</span>
    <span class="k">fi</span>

    unique_lines address_hits address_hits
    <span class="k">if</span> <span class="o">[</span> <span class="si">${#</span><span class="nv">address_hits</span><span class="p">[@]</span><span class="si">}</span> -gt <span class="m">0</span> <span class="o">]</span>
    <span class="k">then</span>
      <span class="nb">echo</span> &gt;&gt;<span class="si">${</span><span class="nv">_dot_file</span><span class="si">}</span>
      <span class="nb">echo</span> <span class="s1">&#39;# Known address-&gt;Blacklist_hit edges&#39;</span> &gt;&gt;<span class="si">${</span><span class="nv">_dot_file</span><span class="si">}</span>
      <span class="nb">echo</span> <span class="s1">&#39;# CAUTION: dig warnings can trigger false hits.&#39;</span> &gt;&gt;<span class="si">${</span><span class="nv">_dot_file</span><span class="si">}</span>
       dump_to_dot address_hits AH
    <span class="k">fi</span>
    <span class="nb">echo</span>          &gt;&gt;<span class="si">${</span><span class="nv">_dot_file</span><span class="si">}</span>
    <span class="nb">echo</span> <span class="s1">&#39; *&#39;</span>     &gt;&gt;<span class="si">${</span><span class="nv">_dot_file</span><span class="si">}</span>
    <span class="nb">echo</span> <span class="s1">&#39; * That is a lot of relationships. Happy graphing.&#39;</span> &gt;&gt;<span class="si">${</span><span class="nv">_dot_file</span><span class="si">}</span>
    <span class="nb">echo</span> <span class="s1">&#39; */&#39;</span>    &gt;&gt;<span class="si">${</span><span class="nv">_dot_file</span><span class="si">}</span>
    <span class="nb">echo</span> <span class="s1">&#39;}&#39;</span>      &gt;&gt;<span class="si">${</span><span class="nv">_dot_file</span><span class="si">}</span>
    <span class="k">return</span> 0
<span class="o">}</span>

<span class="c"># # # # &#39;Hunt the Spammer&#39; execution flow # # # #</span>

<span class="c">#  Execution trace is enabled by setting the</span>
<span class="c">#+ environment variable SPAMMER_TRACE to the name of a writable file.</span>
<span class="nb">declare</span> -a _trace_log
<span class="nb">declare </span>_log_file

<span class="c"># Function to fill the trace log</span>
trace_logger<span class="o">()</span> <span class="o">{</span>
    _trace_log<span class="o">[</span><span class="si">${#</span><span class="nv">_trace_log</span><span class="p">[@]</span><span class="si">}</span><span class="o">]=</span><span class="si">${</span><span class="nv">_pend_current_</span><span class="si">}</span>
<span class="o">}</span>

<span class="c"># Dump trace log to file function variable.</span>
<span class="nb">declare</span> -f _log_dump
<span class="nv">_log_dump</span><span class="o">=</span>pend_dummy   <span class="c"># Initially a no-op.</span>

<span class="c"># Dump the trace log to a file.</span>
dump_log<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local</span> -i _dl_cnt
    <span class="nv">_dl_cnt</span><span class="o">=</span><span class="si">${#</span><span class="nv">_trace_log</span><span class="p">[@]</span><span class="si">}</span>
    <span class="k">for</span> <span class="o">((</span> <span class="nv">_dl</span> <span class="o">=</span> <span class="m">0</span> <span class="p">;</span> _dl &lt; _dl_cnt <span class="p">;</span> _dl++ <span class="o">))</span>
    <span class="k">do</span>
        <span class="nb">echo</span> <span class="si">${</span><span class="nv">_trace_log</span><span class="p">[</span><span class="si">${</span><span class="nv">_dl</span><span class="si">}</span><span class="p">]</span><span class="si">}</span> &gt;&gt; <span class="si">${</span><span class="nv">_log_file</span><span class="si">}</span>
    <span class="k">done</span>
    <span class="nv">_dl_cnt</span><span class="o">=</span><span class="si">${#</span><span class="nv">_pending_</span><span class="p">[@]</span><span class="si">}</span>
    <span class="k">if</span> <span class="o">[</span> <span class="si">${</span><span class="nv">_dl_cnt</span><span class="si">}</span> -gt <span class="m">0</span> <span class="o">]</span>
    <span class="k">then</span>
        <span class="nv">_dl_cnt</span><span class="o">=</span><span class="si">${</span><span class="nv">_dl_cnt</span><span class="si">}</span>-1
        <span class="nb">echo</span> <span class="s1">&#39;# # # Operations stack not empty # # #&#39;</span> &gt;&gt; <span class="si">${</span><span class="nv">_log_file</span><span class="si">}</span>
        <span class="k">for</span> <span class="o">((</span> <span class="nv">_dl</span> <span class="o">=</span> <span class="si">${</span><span class="nv">_dl_cnt</span><span class="si">}</span> <span class="p">;</span> _dl &gt;<span class="o">=</span> <span class="m">0</span> <span class="p">;</span> _dl-- <span class="o">))</span>
        <span class="k">do</span>
            <span class="nb">echo</span> <span class="si">${</span><span class="nv">_pending_</span><span class="p">[</span><span class="si">${</span><span class="nv">_dl</span><span class="si">}</span><span class="p">]</span><span class="si">}</span> &gt;&gt; <span class="si">${</span><span class="nv">_log_file</span><span class="si">}</span>
        <span class="k">done</span>
    <span class="k">fi</span>
<span class="o">}</span>

<span class="c"># # # Utility program &#39;dig&#39; wrappers # # #</span>
<span class="c">#</span>
<span class="c">#  These wrappers are derived from the</span>
<span class="c">#+ examples shown in dig_wrappers.bash.</span>
<span class="c">#</span>
<span class="c">#  The major difference is these return</span>
<span class="c">#+ their results as a list in an array.</span>
<span class="c">#</span>
<span class="c">#  See dig_wrappers.bash for details and</span>
<span class="c">#+ use that script to develop any changes.</span>
<span class="c">#</span>
<span class="c"># # #</span>

<span class="c"># Short form answer: &#39;dig&#39; parses answer.</span>

<span class="c"># Forward lookup :: Name -&gt; Address</span>
<span class="c"># short_fwd &lt;domain_name&gt; &lt;array_name&gt;</span>
short_fwd<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local</span> -a _sf_reply
    <span class="nb">local</span> -i _sf_rc
    <span class="nb">local</span> -i _sf_cnt
    <span class="nv">IFS</span><span class="o">=</span><span class="si">${</span><span class="nv">NO_WSP</span><span class="si">}</span>
<span class="nb">echo</span> -n <span class="s1">&#39;.&#39;</span>
<span class="c"># echo &#39;sfwd: &#39;${1}</span>
  <span class="nv">_sf_reply</span><span class="o">=(</span> <span class="k">$(</span>dig +short <span class="si">${</span><span class="nv">1</span><span class="si">}</span> -c in -t a 2&gt;/dev/null<span class="k">)</span> <span class="o">)</span>
  <span class="nv">_sf_rc</span><span class="o">=</span><span class="nv">$?</span>
  <span class="k">if</span> <span class="o">[</span> <span class="si">${</span><span class="nv">_sf_rc</span><span class="si">}</span> -ne <span class="m">0</span> <span class="o">]</span>
  <span class="k">then</span>
    _trace_log<span class="o">[</span><span class="si">${#</span><span class="nv">_trace_log</span><span class="p">[@]</span><span class="si">}</span><span class="o">]=</span><span class="s1">&#39;## Lookup error &#39;</span><span class="si">${</span><span class="nv">_sf_rc</span><span class="si">}</span><span class="s1">&#39; on &#39;</span><span class="si">${</span><span class="nv">1</span><span class="si">}</span><span class="s1">&#39; ##&#39;</span>
<span class="c"># [ ${_sf_rc} -ne 9 ] &amp;&amp; pend_drop</span>
        <span class="k">return</span> <span class="si">${</span><span class="nv">_sf_rc</span><span class="si">}</span>
    <span class="k">else</span>
        <span class="c"># Some versions of &#39;dig&#39; return warnings on stdout.</span>
        <span class="nv">_sf_cnt</span><span class="o">=</span><span class="si">${#</span><span class="nv">_sf_reply</span><span class="p">[@]</span><span class="si">}</span>
        <span class="k">for</span> <span class="o">((</span> <span class="nv">_sf</span> <span class="o">=</span> <span class="m">0</span> <span class="p">;</span> _sf &lt; <span class="si">${</span><span class="nv">_sf_cnt</span><span class="si">}</span> <span class="p">;</span> _sf++ <span class="o">))</span>
        <span class="k">do</span>
            <span class="o">[</span> <span class="s1">&#39;x&#39;</span><span class="si">${</span><span class="nv">_sf_reply</span><span class="p">[</span><span class="si">${</span><span class="nv">_sf</span><span class="si">}</span><span class="p">]:</span><span class="nv">0</span><span class="p">:</span><span class="nv">2</span><span class="si">}</span> <span class="o">==</span> <span class="s1">&#39;x;;&#39;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span>
                <span class="nb">unset </span>_sf_reply<span class="o">[</span><span class="si">${</span><span class="nv">_sf</span><span class="si">}</span><span class="o">]</span>
        <span class="k">done</span>
        <span class="nb">eval</span> <span class="nv">$2</span><span class="o">=</span><span class="se">\(</span> <span class="se">\$\{</span>_sf_reply<span class="se">\[</span>@<span class="se">\]\}</span> <span class="se">\)</span>
    <span class="k">fi</span>
    <span class="k">return</span> 0
<span class="o">}</span>

<span class="c"># Reverse lookup :: Address -&gt; Name</span>
<span class="c"># short_rev &lt;ip_address&gt; &lt;array_name&gt;</span>
short_rev<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local</span> -a _sr_reply
    <span class="nb">local</span> -i _sr_rc
    <span class="nb">local</span> -i _sr_cnt
    <span class="nv">IFS</span><span class="o">=</span><span class="si">${</span><span class="nv">NO_WSP</span><span class="si">}</span>
<span class="nb">echo</span> -n <span class="s1">&#39;.&#39;</span>
<span class="c"># echo &#39;srev: &#39;${1}</span>
  <span class="nv">_sr_reply</span><span class="o">=(</span> <span class="k">$(</span>dig +short -x <span class="si">${</span><span class="nv">1</span><span class="si">}</span> 2&gt;/dev/null<span class="k">)</span> <span class="o">)</span>
  <span class="nv">_sr_rc</span><span class="o">=</span><span class="nv">$?</span>
  <span class="k">if</span> <span class="o">[</span> <span class="si">${</span><span class="nv">_sr_rc</span><span class="si">}</span> -ne <span class="m">0</span> <span class="o">]</span>
  <span class="k">then</span>
    _trace_log<span class="o">[</span><span class="si">${#</span><span class="nv">_trace_log</span><span class="p">[@]</span><span class="si">}</span><span class="o">]=</span><span class="s1">&#39;## Lookup error &#39;</span><span class="si">${</span><span class="nv">_sr_rc</span><span class="si">}</span><span class="s1">&#39; on &#39;</span><span class="si">${</span><span class="nv">1</span><span class="si">}</span><span class="s1">&#39; ##&#39;</span>
<span class="c"># [ ${_sr_rc} -ne 9 ] &amp;&amp; pend_drop</span>
        <span class="k">return</span> <span class="si">${</span><span class="nv">_sr_rc</span><span class="si">}</span>
    <span class="k">else</span>
        <span class="c"># Some versions of &#39;dig&#39; return warnings on stdout.</span>
        <span class="nv">_sr_cnt</span><span class="o">=</span><span class="si">${#</span><span class="nv">_sr_reply</span><span class="p">[@]</span><span class="si">}</span>
        <span class="k">for</span> <span class="o">((</span> <span class="nv">_sr</span> <span class="o">=</span> <span class="m">0</span> <span class="p">;</span> _sr &lt; <span class="si">${</span><span class="nv">_sr_cnt</span><span class="si">}</span> <span class="p">;</span> _sr++ <span class="o">))</span>
        <span class="k">do</span>
            <span class="o">[</span> <span class="s1">&#39;x&#39;</span><span class="si">${</span><span class="nv">_sr_reply</span><span class="p">[</span><span class="si">${</span><span class="nv">_sr</span><span class="si">}</span><span class="p">]:</span><span class="nv">0</span><span class="p">:</span><span class="nv">2</span><span class="si">}</span> <span class="o">==</span> <span class="s1">&#39;x;;&#39;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span>
                <span class="nb">unset </span>_sr_reply<span class="o">[</span><span class="si">${</span><span class="nv">_sr</span><span class="si">}</span><span class="o">]</span>
        <span class="k">done</span>
        <span class="nb">eval</span> <span class="nv">$2</span><span class="o">=</span><span class="se">\(</span> <span class="se">\$\{</span>_sr_reply<span class="se">\[</span>@<span class="se">\]\}</span> <span class="se">\)</span>
    <span class="k">fi</span>
    <span class="k">return</span> 0
<span class="o">}</span>

<span class="c"># Special format lookup used to query blacklist servers.</span>
<span class="c"># short_text &lt;ip_address&gt; &lt;array_name&gt;</span>
short_text<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local</span> -a _st_reply
    <span class="nb">local</span> -i _st_rc
    <span class="nb">local</span> -i _st_cnt
    <span class="nv">IFS</span><span class="o">=</span><span class="si">${</span><span class="nv">NO_WSP</span><span class="si">}</span>
<span class="c"># echo &#39;stxt: &#39;${1}</span>
  <span class="nv">_st_reply</span><span class="o">=(</span> <span class="k">$(</span>dig +short <span class="si">${</span><span class="nv">1</span><span class="si">}</span> -c in -t txt 2&gt;/dev/null<span class="k">)</span> <span class="o">)</span>
  <span class="nv">_st_rc</span><span class="o">=</span><span class="nv">$?</span>
  <span class="k">if</span> <span class="o">[</span> <span class="si">${</span><span class="nv">_st_rc</span><span class="si">}</span> -ne <span class="m">0</span> <span class="o">]</span>
  <span class="k">then</span>
    _trace_log<span class="o">[</span><span class="si">${#</span><span class="nv">_trace_log</span><span class="p">[@]</span><span class="si">}</span><span class="o">]=</span><span class="s1">&#39;##Text lookup error &#39;</span><span class="si">${</span><span class="nv">_st_rc</span><span class="si">}</span><span class="s1">&#39; on &#39;</span><span class="si">${</span><span class="nv">1</span><span class="si">}</span><span class="s1">&#39;##&#39;</span>
<span class="c"># [ ${_st_rc} -ne 9 ] &amp;&amp; pend_drop</span>
        <span class="k">return</span> <span class="si">${</span><span class="nv">_st_rc</span><span class="si">}</span>
    <span class="k">else</span>
        <span class="c"># Some versions of &#39;dig&#39; return warnings on stdout.</span>
        <span class="nv">_st_cnt</span><span class="o">=</span><span class="si">${#</span><span class="nv">_st_reply</span><span class="p">[@]</span><span class="si">}</span>
        <span class="k">for</span> <span class="o">((</span> <span class="nv">_st</span> <span class="o">=</span> <span class="m">0</span> <span class="p">;</span> _st &lt; <span class="si">${#</span><span class="nv">_st_cnt</span><span class="si">}</span> <span class="p">;</span> _st++ <span class="o">))</span>
        <span class="k">do</span>
            <span class="o">[</span> <span class="s1">&#39;x&#39;</span><span class="si">${</span><span class="nv">_st_reply</span><span class="p">[</span><span class="si">${</span><span class="nv">_st</span><span class="si">}</span><span class="p">]:</span><span class="nv">0</span><span class="p">:</span><span class="nv">2</span><span class="si">}</span> <span class="o">==</span> <span class="s1">&#39;x;;&#39;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span>
                <span class="nb">unset </span>_st_reply<span class="o">[</span><span class="si">${</span><span class="nv">_st</span><span class="si">}</span><span class="o">]</span>
        <span class="k">done</span>
        <span class="nb">eval</span> <span class="nv">$2</span><span class="o">=</span><span class="se">\(</span> <span class="se">\$\{</span>_st_reply<span class="se">\[</span>@<span class="se">\]\}</span> <span class="se">\)</span>
    <span class="k">fi</span>
    <span class="k">return</span> 0
<span class="o">}</span>

<span class="c"># The long forms, a.k.a., the parse it yourself versions</span>

<span class="c"># RFC 2782   Service lookups</span>
<span class="c"># dig +noall +nofail +answer _ldap._tcp.openldap.org -t srv</span>
<span class="c"># _&lt;service&gt;._&lt;protocol&gt;.&lt;domain_name&gt;</span>
<span class="c"># _ldap._tcp.openldap.org. 3600   IN     SRV    0 0 389 ldap.openldap.org.</span>
<span class="c"># domain TTL Class SRV Priority Weight Port Target</span>

<span class="c"># Forward lookup :: Name -&gt; poor man&#39;s zone transfer</span>
<span class="c"># long_fwd &lt;domain_name&gt; &lt;array_name&gt;</span>
long_fwd<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local</span> -a _lf_reply
    <span class="nb">local</span> -i _lf_rc
    <span class="nb">local</span> -i _lf_cnt
    <span class="nv">IFS</span><span class="o">=</span><span class="si">${</span><span class="nv">NO_WSP</span><span class="si">}</span>
<span class="nb">echo</span> -n <span class="s1">&#39;:&#39;</span>
<span class="c"># echo &#39;lfwd: &#39;${1}</span>
  <span class="nv">_lf_reply</span><span class="o">=(</span> <span class="k">$(</span>
     dig +noall +nofail +answer +authority +additional <span class="se">\</span>
         <span class="si">${</span><span class="nv">1</span><span class="si">}</span> -t soa <span class="si">${</span><span class="nv">1</span><span class="si">}</span> -t mx <span class="si">${</span><span class="nv">1</span><span class="si">}</span> -t any 2&gt;/dev/null<span class="k">)</span> <span class="o">)</span>
  <span class="nv">_lf_rc</span><span class="o">=</span><span class="nv">$?</span>
  <span class="k">if</span> <span class="o">[</span> <span class="si">${</span><span class="nv">_lf_rc</span><span class="si">}</span> -ne <span class="m">0</span> <span class="o">]</span>
  <span class="k">then</span>
    _trace_log<span class="o">[</span><span class="si">${#</span><span class="nv">_trace_log</span><span class="p">[@]</span><span class="si">}</span><span class="o">]=</span><span class="s1">&#39;# Zone lookup err &#39;</span><span class="si">${</span><span class="nv">_lf_rc</span><span class="si">}</span><span class="s1">&#39; on &#39;</span><span class="si">${</span><span class="nv">1</span><span class="si">}</span><span class="s1">&#39; #&#39;</span>
<span class="c"># [ ${_lf_rc} -ne 9 ] &amp;&amp; pend_drop</span>
        <span class="k">return</span> <span class="si">${</span><span class="nv">_lf_rc</span><span class="si">}</span>
    <span class="k">else</span>
        <span class="c"># Some versions of &#39;dig&#39; return warnings on stdout.</span>
        <span class="nv">_lf_cnt</span><span class="o">=</span><span class="si">${#</span><span class="nv">_lf_reply</span><span class="p">[@]</span><span class="si">}</span>
        <span class="k">for</span> <span class="o">((</span> <span class="nv">_lf</span> <span class="o">=</span> <span class="m">0</span> <span class="p">;</span> _lf &lt; <span class="si">${</span><span class="nv">_lf_cnt</span><span class="si">}</span> <span class="p">;</span> _lf++ <span class="o">))</span>
        <span class="k">do</span>
            <span class="o">[</span> <span class="s1">&#39;x&#39;</span><span class="si">${</span><span class="nv">_lf_reply</span><span class="p">[</span><span class="si">${</span><span class="nv">_lf</span><span class="si">}</span><span class="p">]:</span><span class="nv">0</span><span class="p">:</span><span class="nv">2</span><span class="si">}</span> <span class="o">==</span> <span class="s1">&#39;x;;&#39;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span>
                <span class="nb">unset </span>_lf_reply<span class="o">[</span><span class="si">${</span><span class="nv">_lf</span><span class="si">}</span><span class="o">]</span>
        <span class="k">done</span>
        <span class="nb">eval</span> <span class="nv">$2</span><span class="o">=</span><span class="se">\(</span> <span class="se">\$\{</span>_lf_reply<span class="se">\[</span>@<span class="se">\]\}</span> <span class="se">\)</span>
    <span class="k">fi</span>
    <span class="k">return</span> 0
<span class="o">}</span>
<span class="c">#  The reverse lookup domain name corresponding to the IPv6 address:</span>
<span class="c">#      4321:0:1:2:3:4:567:89ab</span>
<span class="c">#  would be (nibble, I.E: Hexdigit) reversed:</span>
<span class="c">#  b.a.9.8.7.6.5.0.4.0.0.0.3.0.0.0.2.0.0.0.1.0.0.0.0.0.0.0.1.2.3.4.IP6.ARPA.</span>

<span class="c"># Reverse lookup :: Address -&gt; poor man&#39;s delegation chain</span>
<span class="c"># long_rev &lt;rev_ip_address&gt; &lt;array_name&gt;</span>
long_rev<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local</span> -a _lr_reply
    <span class="nb">local</span> -i _lr_rc
    <span class="nb">local</span> -i _lr_cnt
    <span class="nb">local </span>_lr_dns
    <span class="nv">_lr_dns</span><span class="o">=</span><span class="si">${</span><span class="nv">1</span><span class="si">}</span><span class="s1">&#39;.in-addr.arpa.&#39;</span>
    <span class="nv">IFS</span><span class="o">=</span><span class="si">${</span><span class="nv">NO_WSP</span><span class="si">}</span>
<span class="nb">echo</span> -n <span class="s1">&#39;:&#39;</span>
<span class="c"># echo &#39;lrev: &#39;${1}</span>
  <span class="nv">_lr_reply</span><span class="o">=(</span> <span class="k">$(</span>
       dig +noall +nofail +answer +authority +additional <span class="se">\</span>
           <span class="si">${</span><span class="nv">_lr_dns</span><span class="si">}</span> -t soa <span class="si">${</span><span class="nv">_lr_dns</span><span class="si">}</span> -t any 2&gt;/dev/null<span class="k">)</span> <span class="o">)</span>
  <span class="nv">_lr_rc</span><span class="o">=</span><span class="nv">$?</span>
  <span class="k">if</span> <span class="o">[</span> <span class="si">${</span><span class="nv">_lr_rc</span><span class="si">}</span> -ne <span class="m">0</span> <span class="o">]</span>
  <span class="k">then</span>
    _trace_log<span class="o">[</span><span class="si">${#</span><span class="nv">_trace_log</span><span class="p">[@]</span><span class="si">}</span><span class="o">]=</span><span class="s1">&#39;# Deleg lkp error &#39;</span><span class="si">${</span><span class="nv">_lr_rc</span><span class="si">}</span><span class="s1">&#39; on &#39;</span><span class="si">${</span><span class="nv">1</span><span class="si">}</span><span class="s1">&#39; #&#39;</span>
<span class="c"># [ ${_lr_rc} -ne 9 ] &amp;&amp; pend_drop</span>
        <span class="k">return</span> <span class="si">${</span><span class="nv">_lr_rc</span><span class="si">}</span>
    <span class="k">else</span>
        <span class="c"># Some versions of &#39;dig&#39; return warnings on stdout.</span>
        <span class="nv">_lr_cnt</span><span class="o">=</span><span class="si">${#</span><span class="nv">_lr_reply</span><span class="p">[@]</span><span class="si">}</span>
        <span class="k">for</span> <span class="o">((</span> <span class="nv">_lr</span> <span class="o">=</span> <span class="m">0</span> <span class="p">;</span> _lr &lt; <span class="si">${</span><span class="nv">_lr_cnt</span><span class="si">}</span> <span class="p">;</span> _lr++ <span class="o">))</span>
        <span class="k">do</span>
            <span class="o">[</span> <span class="s1">&#39;x&#39;</span><span class="si">${</span><span class="nv">_lr_reply</span><span class="p">[</span><span class="si">${</span><span class="nv">_lr</span><span class="si">}</span><span class="p">]:</span><span class="nv">0</span><span class="p">:</span><span class="nv">2</span><span class="si">}</span> <span class="o">==</span> <span class="s1">&#39;x;;&#39;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span>
                <span class="nb">unset </span>_lr_reply<span class="o">[</span><span class="si">${</span><span class="nv">_lr</span><span class="si">}</span><span class="o">]</span>
        <span class="k">done</span>
        <span class="nb">eval</span> <span class="nv">$2</span><span class="o">=</span><span class="se">\(</span> <span class="se">\$\{</span>_lr_reply<span class="se">\[</span>@<span class="se">\]\}</span> <span class="se">\)</span>
    <span class="k">fi</span>
    <span class="k">return</span> 0
<span class="o">}</span>

<span class="c"># # # Application specific functions # # #</span>

<span class="c"># Mung a possible name; suppresses root and TLDs.</span>
<span class="c"># name_fixup &lt;string&gt;</span>
name_fixup<span class="o">(){</span>
    <span class="nb">local</span> -a _nf_tmp
    <span class="nb">local</span> -i _nf_end
    <span class="nb">local </span>_nf_str
    <span class="nb">local </span>IFS
    <span class="nv">_nf_str</span><span class="o">=</span><span class="k">$(</span>to_lower <span class="si">${</span><span class="nv">1</span><span class="si">}</span><span class="k">)</span>
    <span class="nv">_nf_str</span><span class="o">=</span><span class="k">$(</span>to_dot <span class="si">${</span><span class="nv">_nf_str</span><span class="si">}</span><span class="k">)</span>
    <span class="nv">_nf_end</span><span class="o">=</span><span class="si">${#</span><span class="nv">_nf_str</span><span class="si">}</span>-1
    <span class="o">[</span> <span class="si">${</span><span class="nv">_nf_str</span><span class="p">:</span><span class="si">${</span><span class="nv">_nf_end</span><span class="si">}}</span> !<span class="o">=</span> <span class="s1">&#39;.&#39;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span>
        <span class="nv">_nf_str</span><span class="o">=</span><span class="si">${</span><span class="nv">_nf_str</span><span class="si">}</span><span class="s1">&#39;.&#39;</span>
    <span class="nv">IFS</span><span class="o">=</span><span class="si">${</span><span class="nv">ADR_IFS</span><span class="si">}</span>
    <span class="nv">_nf_tmp</span><span class="o">=(</span> <span class="si">${</span><span class="nv">_nf_str</span><span class="si">}</span> <span class="o">)</span>
    <span class="nv">IFS</span><span class="o">=</span><span class="si">${</span><span class="nv">WSP_IFS</span><span class="si">}</span>
    <span class="nv">_nf_end</span><span class="o">=</span><span class="si">${#</span><span class="nv">_nf_tmp</span><span class="p">[@]</span><span class="si">}</span>
    <span class="k">case</span> <span class="si">${</span><span class="nv">_nf_end</span><span class="si">}</span> in
    0<span class="o">)</span> <span class="c"># No dots, only dots.</span>
        <span class="nb">echo</span>
<span class="nb">        </span><span class="k">return</span> 1
    <span class="p">;;</span>
    1<span class="o">)</span> <span class="c"># Only a TLD.</span>
        <span class="nb">echo</span>
<span class="nb">        </span><span class="k">return</span> 1
    <span class="p">;;</span>
    2<span class="o">)</span> <span class="c"># Maybe okay.</span>
       <span class="nb">echo</span> <span class="si">${</span><span class="nv">_nf_str</span><span class="si">}</span>
       <span class="k">return</span> 0
       <span class="c"># Needs a lookup table?</span>
       <span class="k">if</span> <span class="o">[</span> <span class="si">${#</span><span class="nv">_nf_tmp</span><span class="p">[1]</span><span class="si">}</span> -eq <span class="m">2</span> <span class="o">]</span>
       <span class="k">then</span> <span class="c"># Country coded TLD.</span>
           <span class="nb">echo</span>
<span class="nb">           </span><span class="k">return</span> 1
       <span class="k">else</span>
           <span class="nb">echo</span> <span class="si">${</span><span class="nv">_nf_str</span><span class="si">}</span>
           <span class="k">return</span> 0
       <span class="k">fi</span>
    <span class="p">;;</span>
    <span class="k">esac</span>
    <span class="nb">echo</span> <span class="si">${</span><span class="nv">_nf_str</span><span class="si">}</span>
    <span class="k">return</span> 0
<span class="o">}</span>

<span class="c"># Grope and mung original input(s).</span>
split_input<span class="o">()</span> <span class="o">{</span>
    <span class="o">[</span> <span class="si">${#</span><span class="nv">uc_name</span><span class="p">[@]</span><span class="si">}</span> -gt <span class="m">0</span> <span class="o">]</span> <span class="p">|</span><span class="k">return</span> 0
    <span class="nb">local</span> -i _si_cnt
    <span class="nb">local</span> -i _si_len
    <span class="nb">local </span>_si_str
    unique_lines uc_name uc_name
    <span class="nv">_si_cnt</span><span class="o">=</span><span class="si">${#</span><span class="nv">uc_name</span><span class="p">[@]</span><span class="si">}</span>
    <span class="k">for</span> <span class="o">((</span> <span class="nv">_si</span> <span class="o">=</span> <span class="m">0</span> <span class="p">;</span> _si &lt; _si_cnt <span class="p">;</span> _si++ <span class="o">))</span>
    <span class="k">do</span>
        <span class="nv">_si_str</span><span class="o">=</span><span class="si">${</span><span class="nv">uc_name</span><span class="p">[</span><span class="nv">$_si</span><span class="p">]</span><span class="si">}</span>
        <span class="k">if</span> is_address <span class="si">${</span><span class="nv">_si_str</span><span class="si">}</span>
        <span class="k">then</span>
            uc_address<span class="o">[</span><span class="si">${#</span><span class="nv">uc_address</span><span class="p">[@]</span><span class="si">}</span><span class="o">]=</span><span class="si">${</span><span class="nv">_si_str</span><span class="si">}</span>
            <span class="nb">unset </span>uc_name<span class="o">[</span><span class="nv">$_si</span><span class="o">]</span>
        <span class="k">else</span>
            <span class="k">if</span> ! uc_name<span class="o">[</span><span class="nv">$_si</span><span class="o">]=</span><span class="k">$(</span>name_fixup <span class="si">${</span><span class="nv">_si_str</span><span class="si">}</span><span class="k">)</span>
            <span class="k">then</span>
                <span class="nb">unset </span>ucname<span class="o">[</span><span class="nv">$_si</span><span class="o">]</span>
            <span class="k">fi</span>
        <span class="k">fi</span>
    <span class="k">done</span>
  <span class="nv">uc_name</span><span class="o">=(</span> <span class="si">${</span><span class="nv">uc_name</span><span class="p">[@]</span><span class="si">}</span> <span class="o">)</span>
  <span class="nv">_si_cnt</span><span class="o">=</span><span class="si">${#</span><span class="nv">uc_name</span><span class="p">[@]</span><span class="si">}</span>
  _trace_log<span class="o">[</span><span class="si">${#</span><span class="nv">_trace_log</span><span class="p">[@]</span><span class="si">}</span><span class="o">]=</span><span class="s1">&#39;#Input &#39;</span><span class="si">${</span><span class="nv">_si_cnt</span><span class="si">}</span><span class="s1">&#39; unchkd name input(s).#&#39;</span>
  <span class="nv">_si_cnt</span><span class="o">=</span><span class="si">${#</span><span class="nv">uc_address</span><span class="p">[@]</span><span class="si">}</span>
  _trace_log<span class="o">[</span><span class="si">${#</span><span class="nv">_trace_log</span><span class="p">[@]</span><span class="si">}</span><span class="o">]=</span><span class="s1">&#39;#Input &#39;</span><span class="si">${</span><span class="nv">_si_cnt</span><span class="si">}</span><span class="s1">&#39; unchkd addr input(s).#&#39;</span>
    <span class="k">return</span> 0
<span class="o">}</span>

<span class="c"># # # Discovery functions -- recursively interlocked by external data # # #</span>
<span class="c"># # # The leading &#39;if list is empty; return 0&#39; in each is required. # # #</span>

<span class="c"># Recursion limiter</span>
<span class="c"># limit_chk() &lt;next_level&gt;</span>
limit_chk<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local</span> -i _lc_lmt
    <span class="c"># Check indirection limit.</span>
    <span class="k">if</span> <span class="o">[</span> <span class="si">${</span><span class="nv">indirect</span><span class="si">}</span> -eq <span class="m">0</span> <span class="o">]</span> <span class="p">|</span><span class="o">[</span> <span class="nv">$# </span>-eq <span class="m">0</span> <span class="o">]</span>
    <span class="k">then</span>
        <span class="c"># The &#39;do-forever&#39; choice</span>
        <span class="nb">echo </span><span class="m">1</span>                 <span class="c"># Any value will do.</span>
        <span class="k">return</span> <span class="m">0</span>               <span class="c"># OK to continue.</span>
    <span class="k">else</span>
        <span class="c"># Limiting is in effect.</span>
        <span class="k">if</span> <span class="o">[</span> <span class="si">${</span><span class="nv">indirect</span><span class="si">}</span> -lt <span class="si">${</span><span class="nv">1</span><span class="si">}</span> <span class="o">]</span>
        <span class="k">then</span>
            <span class="nb">echo</span> <span class="si">${</span><span class="nv">1</span><span class="si">}</span>          <span class="c"># Whatever.</span>
            <span class="k">return</span> <span class="m">1</span>           <span class="c"># Stop here.</span>
        <span class="k">else</span>
            <span class="nv">_lc_lmt</span><span class="o">=</span><span class="si">${</span><span class="nv">1</span><span class="si">}</span>+1     <span class="c"># Bump the given limit.</span>
            <span class="nb">echo</span> <span class="si">${</span><span class="nv">_lc_lmt</span><span class="si">}</span>    <span class="c"># Echo it.</span>
            <span class="k">return</span> <span class="m">0</span>           <span class="c"># OK to continue.</span>
        <span class="k">fi</span>
    <span class="k">fi</span>
<span class="o">}</span>

<span class="c"># For each name in uc_name:</span>
<span class="c">#     Move name to chk_name.</span>
<span class="c">#     Add addresses to uc_address.</span>
<span class="c">#     Pend expand_input_address.</span>
<span class="c">#     Repeat until nothing new found.</span>
<span class="c"># expand_input_name &lt;indirection_limit&gt;</span>
expand_input_name<span class="o">()</span> <span class="o">{</span>
    <span class="o">[</span> <span class="si">${#</span><span class="nv">uc_name</span><span class="p">[@]</span><span class="si">}</span> -gt <span class="m">0</span> <span class="o">]</span> <span class="p">|</span><span class="k">return</span> 0
    <span class="nb">local</span> -a _ein_addr
    <span class="nb">local</span> -a _ein_new
    <span class="nb">local</span> -i _ucn_cnt
    <span class="nb">local</span> -i _ein_cnt
    <span class="nb">local </span>_ein_tst
    <span class="nv">_ucn_cnt</span><span class="o">=</span><span class="si">${#</span><span class="nv">uc_name</span><span class="p">[@]</span><span class="si">}</span>

    <span class="k">if</span>  ! <span class="nv">_ein_cnt</span><span class="o">=</span><span class="k">$(</span>limit_chk <span class="si">${</span><span class="nv">1</span><span class="si">}</span><span class="k">)</span>
    <span class="k">then</span>
        <span class="k">return</span> 0
    <span class="k">fi</span>

    <span class="k">for</span> <span class="o">((</span> <span class="nv">_ein</span> <span class="o">=</span> <span class="m">0</span> <span class="p">;</span> _ein &lt; _ucn_cnt <span class="p">;</span> _ein++ <span class="o">))</span>
    <span class="k">do</span>
        <span class="k">if</span> short_fwd <span class="si">${</span><span class="nv">uc_name</span><span class="p">[</span><span class="si">${</span><span class="nv">_ein</span><span class="si">}</span><span class="p">]</span><span class="si">}</span> _ein_new
        <span class="k">then</span>
          <span class="k">for</span> <span class="o">((</span> <span class="nv">_ein_cnt</span> <span class="o">=</span> <span class="m">0</span> <span class="p">;</span> _ein_cnt &lt; <span class="si">${#</span><span class="nv">_ein_new</span><span class="p">[@]</span><span class="si">}</span><span class="p">;</span> _ein_cnt++ <span class="o">))</span>
          <span class="k">do</span>
              <span class="nv">_ein_tst</span><span class="o">=</span><span class="si">${</span><span class="nv">_ein_new</span><span class="p">[</span><span class="si">${</span><span class="nv">_ein_cnt</span><span class="si">}</span><span class="p">]</span><span class="si">}</span>
              <span class="k">if</span> is_address <span class="si">${</span><span class="nv">_ein_tst</span><span class="si">}</span>
              <span class="k">then</span>
                  _ein_addr<span class="o">[</span><span class="si">${#</span><span class="nv">_ein_addr</span><span class="p">[@]</span><span class="si">}</span><span class="o">]=</span><span class="si">${</span><span class="nv">_ein_tst</span><span class="si">}</span>
              <span class="k">fi</span>
    <span class="k">done</span>
        <span class="k">fi</span>
    <span class="k">done</span>
    unique_lines _ein_addr _ein_addr     <span class="c"># Scrub duplicates.</span>
    edit_exact chk_address _ein_addr     <span class="c"># Scrub pending detail.</span>
    edit_exact known_address _ein_addr   <span class="c"># Scrub already detailed.</span>
 <span class="k">if</span> <span class="o">[</span> <span class="si">${#</span><span class="nv">_ein_addr</span><span class="p">[@]</span><span class="si">}</span> -gt <span class="m">0</span> <span class="o">]</span>        <span class="c"># Anything new?</span>
 <span class="k">then</span>
   <span class="nv">uc_address</span><span class="o">=(</span> <span class="si">${</span><span class="nv">uc_address</span><span class="p">[@]</span><span class="si">}</span> <span class="si">${</span><span class="nv">_ein_addr</span><span class="p">[@]</span><span class="si">}</span> <span class="o">)</span>
   pend_func expand_input_address <span class="si">${</span><span class="nv">1</span><span class="si">}</span>
   _trace_log<span class="o">[</span><span class="si">${#</span><span class="nv">_trace_log</span><span class="p">[@]</span><span class="si">}</span><span class="o">]=</span><span class="s1">&#39;#Add &#39;</span><span class="si">${#</span><span class="nv">_ein_addr</span><span class="p">[@]</span><span class="si">}</span><span class="s1">&#39; unchkd addr inp.#&#39;</span>
    <span class="k">fi</span>
    edit_exact chk_name uc_name          <span class="c"># Scrub pending detail.</span>
    edit_exact known_name uc_name        <span class="c"># Scrub already detailed.</span>
    <span class="k">if</span> <span class="o">[</span> <span class="si">${#</span><span class="nv">uc_name</span><span class="p">[@]</span><span class="si">}</span> -gt <span class="m">0</span> <span class="o">]</span>
    <span class="k">then</span>
        <span class="nv">chk_name</span><span class="o">=(</span> <span class="si">${</span><span class="nv">chk_name</span><span class="p">[@]</span><span class="si">}</span> <span class="si">${</span><span class="nv">uc_name</span><span class="p">[@]</span><span class="si">}</span>  <span class="o">)</span>
        pend_func detail_each_name <span class="si">${</span><span class="nv">1</span><span class="si">}</span>
    <span class="k">fi</span>
    <span class="nb">unset </span>uc_name<span class="o">[</span>@<span class="o">]</span>
    <span class="k">return</span> 0
<span class="o">}</span>

<span class="c"># For each address in uc_address:</span>
<span class="c">#     Move address to chk_address.</span>
<span class="c">#     Add names to uc_name.</span>
<span class="c">#     Pend expand_input_name.</span>
<span class="c">#     Repeat until nothing new found.</span>
<span class="c"># expand_input_address &lt;indirection_limit&gt;</span>
expand_input_address<span class="o">()</span> <span class="o">{</span>
    <span class="o">[</span> <span class="si">${#</span><span class="nv">uc_address</span><span class="p">[@]</span><span class="si">}</span> -gt <span class="m">0</span> <span class="o">]</span> <span class="p">|</span><span class="k">return</span> 0
    <span class="nb">local</span> -a _eia_addr
    <span class="nb">local</span> -a _eia_name
    <span class="nb">local</span> -a _eia_new
    <span class="nb">local</span> -i _uca_cnt
    <span class="nb">local</span> -i _eia_cnt
    <span class="nb">local </span>_eia_tst
    unique_lines uc_address _eia_addr
    <span class="nb">unset </span>uc_address<span class="o">[</span>@<span class="o">]</span>
    edit_exact been_there_addr _eia_addr
    <span class="nv">_uca_cnt</span><span class="o">=</span><span class="si">${#</span><span class="nv">_eia_addr</span><span class="p">[@]</span><span class="si">}</span>
    <span class="o">[</span> <span class="si">${</span><span class="nv">_uca_cnt</span><span class="si">}</span> -gt <span class="m">0</span> <span class="o">]</span> <span class="o">&amp;&amp;</span>
        <span class="nv">been_there_addr</span><span class="o">=(</span> <span class="si">${</span><span class="nv">been_there_addr</span><span class="p">[@]</span><span class="si">}</span> <span class="si">${</span><span class="nv">_eia_addr</span><span class="p">[@]</span><span class="si">}</span> <span class="o">)</span>

    <span class="k">for</span> <span class="o">((</span> <span class="nv">_eia</span> <span class="o">=</span> <span class="m">0</span> <span class="p">;</span> _eia &lt; _uca_cnt <span class="p">;</span> _eia++ <span class="o">))</span>
     <span class="k">do</span>
       <span class="k">if</span> short_rev <span class="si">${</span><span class="nv">_eia_addr</span><span class="p">[</span><span class="si">${</span><span class="nv">_eia</span><span class="si">}</span><span class="p">]</span><span class="si">}</span> _eia_new
       <span class="k">then</span>
         <span class="k">for</span> <span class="o">((</span> <span class="nv">_eia_cnt</span> <span class="o">=</span> <span class="m">0</span> <span class="p">;</span> _eia_cnt &lt; <span class="si">${#</span><span class="nv">_eia_new</span><span class="p">[@]</span><span class="si">}</span> <span class="p">;</span> _eia_cnt++ <span class="o">))</span>
         <span class="k">do</span>
           <span class="nv">_eia_tst</span><span class="o">=</span><span class="si">${</span><span class="nv">_eia_new</span><span class="p">[</span><span class="si">${</span><span class="nv">_eia_cnt</span><span class="si">}</span><span class="p">]</span><span class="si">}</span>
           <span class="k">if</span> <span class="nv">_eia_tst</span><span class="o">=</span><span class="k">$(</span>name_fixup <span class="si">${</span><span class="nv">_eia_tst</span><span class="si">}</span><span class="k">)</span>
           <span class="k">then</span>
             _eia_name<span class="o">[</span><span class="si">${#</span><span class="nv">_eia_name</span><span class="p">[@]</span><span class="si">}</span><span class="o">]=</span><span class="si">${</span><span class="nv">_eia_tst</span><span class="si">}</span>
       <span class="k">fi</span>
     <span class="k">done</span>
           <span class="k">fi</span>
    <span class="k">done</span>
    unique_lines _eia_name _eia_name     <span class="c"># Scrub duplicates.</span>
    edit_exact chk_name _eia_name        <span class="c"># Scrub pending detail.</span>
    edit_exact known_name _eia_name      <span class="c"># Scrub already detailed.</span>
 <span class="k">if</span> <span class="o">[</span> <span class="si">${#</span><span class="nv">_eia_name</span><span class="p">[@]</span><span class="si">}</span> -gt <span class="m">0</span> <span class="o">]</span>        <span class="c"># Anything new?</span>
 <span class="k">then</span>
   <span class="nv">uc_name</span><span class="o">=(</span> <span class="si">${</span><span class="nv">uc_name</span><span class="p">[@]</span><span class="si">}</span> <span class="si">${</span><span class="nv">_eia_name</span><span class="p">[@]</span><span class="si">}</span> <span class="o">)</span>
   pend_func expand_input_name <span class="si">${</span><span class="nv">1</span><span class="si">}</span>
   _trace_log<span class="o">[</span><span class="si">${#</span><span class="nv">_trace_log</span><span class="p">[@]</span><span class="si">}</span><span class="o">]=</span><span class="s1">&#39;#Add &#39;</span><span class="si">${#</span><span class="nv">_eia_name</span><span class="p">[@]</span><span class="si">}</span><span class="s1">&#39; unchkd name inp.#&#39;</span>
    <span class="k">fi</span>
    edit_exact chk_address _eia_addr     <span class="c"># Scrub pending detail.</span>
    edit_exact known_address _eia_addr   <span class="c"># Scrub already detailed.</span>
    <span class="k">if</span> <span class="o">[</span> <span class="si">${#</span><span class="nv">_eia_addr</span><span class="p">[@]</span><span class="si">}</span> -gt <span class="m">0</span> <span class="o">]</span>        <span class="c"># Anything new?</span>
    <span class="k">then</span>
        <span class="nv">chk_address</span><span class="o">=(</span> <span class="si">${</span><span class="nv">chk_address</span><span class="p">[@]</span><span class="si">}</span> <span class="si">${</span><span class="nv">_eia_addr</span><span class="p">[@]</span><span class="si">}</span> <span class="o">)</span>
        pend_func detail_each_address <span class="si">${</span><span class="nv">1</span><span class="si">}</span>
    <span class="k">fi</span>
    <span class="k">return</span> 0
<span class="o">}</span>

<span class="c"># The parse-it-yourself zone reply.</span>
<span class="c"># The input is the chk_name list.</span>
<span class="c"># detail_each_name &lt;indirection_limit&gt;</span>
detail_each_name<span class="o">()</span> <span class="o">{</span>
    <span class="o">[</span> <span class="si">${#</span><span class="nv">chk_name</span><span class="p">[@]</span><span class="si">}</span> -gt <span class="m">0</span> <span class="o">]</span> <span class="p">|</span><span class="k">return</span> 0
    <span class="nb">local</span> -a _den_chk       <span class="c"># Names to check</span>
    <span class="nb">local</span> -a _den_name      <span class="c"># Names found here</span>
    <span class="nb">local</span> -a _den_address   <span class="c"># Addresses found here</span>
    <span class="nb">local</span> -a _den_pair      <span class="c"># Pairs found here</span>
    <span class="nb">local</span> -a _den_rev       <span class="c"># Reverse pairs found here</span>
    <span class="nb">local</span> -a _den_tmp       <span class="c"># Line being parsed</span>
    <span class="nb">local</span> -a _den_auth      <span class="c"># SOA contact being parsed</span>
    <span class="nb">local</span> -a _den_new       <span class="c"># The zone reply</span>
    <span class="nb">local</span> -a _den_pc        <span class="c"># Parent-Child gets big fast</span>
    <span class="nb">local</span> -a _den_ref       <span class="c"># So does reference chain</span>
    <span class="nb">local</span> -a _den_nr        <span class="c"># Name-Resource can be big</span>
    <span class="nb">local</span> -a _den_na        <span class="c"># Name-Address</span>
    <span class="nb">local</span> -a _den_ns        <span class="c"># Name-Service</span>
    <span class="nb">local</span> -a _den_achn      <span class="c"># Chain of Authority</span>
    <span class="nb">local</span> -i _den_cnt       <span class="c"># Count of names to detail</span>
    <span class="nb">local</span> -i _den_lmt       <span class="c"># Indirection limit</span>
    <span class="nb">local </span>_den_who          <span class="c"># Named being processed</span>
    <span class="nb">local </span>_den_rec          <span class="c"># Record type being processed</span>
    <span class="nb">local </span>_den_cont         <span class="c"># Contact domain</span>
    <span class="nb">local </span>_den_str          <span class="c"># Fixed up name string</span>
    <span class="nb">local </span>_den_str2         <span class="c"># Fixed up reverse</span>
    <span class="nb">local </span><span class="nv">IFS</span><span class="o">=</span><span class="si">${</span><span class="nv">WSP_IFS</span><span class="si">}</span>

    <span class="c"># Local, unique copy of names to check</span>
    unique_lines chk_name _den_chk
    <span class="nb">unset </span>chk_name<span class="o">[</span>@<span class="o">]</span>       <span class="c"># Done with globals.</span>

    <span class="c"># Less any names already known</span>
    edit_exact known_name _den_chk
    <span class="nv">_den_cnt</span><span class="o">=</span><span class="si">${#</span><span class="nv">_den_chk</span><span class="p">[@]</span><span class="si">}</span>

    <span class="c"># If anything left, add to known_name.</span>
    <span class="o">[</span> <span class="si">${</span><span class="nv">_den_cnt</span><span class="si">}</span> -gt <span class="m">0</span> <span class="o">]</span> <span class="o">&amp;&amp;</span>
        <span class="nv">known_name</span><span class="o">=(</span> <span class="si">${</span><span class="nv">known_name</span><span class="p">[@]</span><span class="si">}</span> <span class="si">${</span><span class="nv">_den_chk</span><span class="p">[@]</span><span class="si">}</span> <span class="o">)</span>

    <span class="c"># for the list of (previously) unknown names . . .</span>
    <span class="k">for</span> <span class="o">((</span> <span class="nv">_den</span> <span class="o">=</span> <span class="m">0</span> <span class="p">;</span> _den &lt; _den_cnt <span class="p">;</span> _den++ <span class="o">))</span>
    <span class="k">do</span>
        <span class="nv">_den_who</span><span class="o">=</span><span class="si">${</span><span class="nv">_den_chk</span><span class="p">[</span><span class="si">${</span><span class="nv">_den</span><span class="si">}</span><span class="p">]</span><span class="si">}</span>
        <span class="k">if</span> long_fwd <span class="si">${</span><span class="nv">_den_who</span><span class="si">}</span> _den_new
        <span class="k">then</span>
            unique_lines _den_new _den_new
            <span class="k">if</span> <span class="o">[</span> <span class="si">${#</span><span class="nv">_den_new</span><span class="p">[@]</span><span class="si">}</span> -eq <span class="m">0</span> <span class="o">]</span>
            <span class="k">then</span>
                _den_pair<span class="o">[</span><span class="si">${#</span><span class="nv">_den_pair</span><span class="p">[@]</span><span class="si">}</span><span class="o">]=</span><span class="s1">&#39;0.0.0.0 &#39;</span><span class="si">${</span><span class="nv">_den_who</span><span class="si">}</span>
            <span class="k">fi</span>

            <span class="c"># Parse each line in the reply.</span>
            <span class="k">for</span> <span class="o">((</span> <span class="nv">_line</span> <span class="o">=</span> <span class="m">0</span> <span class="p">;</span> _line &lt; <span class="si">${#</span><span class="nv">_den_new</span><span class="p">[@]</span><span class="si">}</span> <span class="p">;</span> _line++ <span class="o">))</span>
            <span class="k">do</span>
                <span class="nv">IFS</span><span class="o">=</span><span class="si">${</span><span class="nv">NO_WSP</span><span class="si">}</span><span class="s1">$&#39;\x09&#39;$&#39;\x20&#39;</span>
                <span class="nv">_den_tmp</span><span class="o">=(</span> <span class="si">${</span><span class="nv">_den_new</span><span class="p">[</span><span class="si">${</span><span class="nv">_line</span><span class="si">}</span><span class="p">]</span><span class="si">}</span> <span class="o">)</span>
                <span class="nv">IFS</span><span class="o">=</span><span class="si">${</span><span class="nv">WSP_IFS</span><span class="si">}</span>
              <span class="c"># If usable record and not a warning message . . .</span>
              <span class="k">if</span> <span class="o">[</span> <span class="si">${#</span><span class="nv">_den_tmp</span><span class="p">[@]</span><span class="si">}</span> -gt <span class="m">4</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">[</span> <span class="s1">&#39;x&#39;</span><span class="si">${</span><span class="nv">_den_tmp</span><span class="p">[0]</span><span class="si">}</span> !<span class="o">=</span> <span class="s1">&#39;x;;&#39;</span> <span class="o">]</span>
              <span class="k">then</span>
                    <span class="nv">_den_rec</span><span class="o">=</span><span class="si">${</span><span class="nv">_den_tmp</span><span class="p">[3]</span><span class="si">}</span>
                    _den_nr<span class="o">[</span><span class="si">${#</span><span class="nv">_den_nr</span><span class="p">[@]</span><span class="si">}</span><span class="o">]=</span><span class="si">${</span><span class="nv">_den_who</span><span class="si">}</span><span class="s1">&#39; &#39;</span><span class="si">${</span><span class="nv">_den_rec</span><span class="si">}</span>
                    <span class="c"># Begin at RFC1033 (+++)</span>
                    <span class="k">case</span> <span class="si">${</span><span class="nv">_den_rec</span><span class="si">}</span> in

<span class="c">#&lt;name&gt; [&lt;ttl&gt;]  [&lt;class&gt;] SOA &lt;origin&gt; &lt;person&gt;</span>
                    SOA<span class="o">)</span> <span class="c"># Start Of Authority</span>
    <span class="k">if</span> <span class="nv">_den_str</span><span class="o">=</span><span class="k">$(</span>name_fixup <span class="si">${</span><span class="nv">_den_tmp</span><span class="p">[0]</span><span class="si">}</span><span class="k">)</span>
    <span class="k">then</span>
      _den_name<span class="o">[</span><span class="si">${#</span><span class="nv">_den_name</span><span class="p">[@]</span><span class="si">}</span><span class="o">]=</span><span class="si">${</span><span class="nv">_den_str</span><span class="si">}</span>
      _den_achn<span class="o">[</span><span class="si">${#</span><span class="nv">_den_achn</span><span class="p">[@]</span><span class="si">}</span><span class="o">]=</span><span class="si">${</span><span class="nv">_den_who</span><span class="si">}</span><span class="s1">&#39; &#39;</span><span class="si">${</span><span class="nv">_den_str</span><span class="si">}</span><span class="s1">&#39; SOA&#39;</span>
      <span class="c"># SOA origin -- domain name of master zone record</span>
      <span class="k">if</span> <span class="nv">_den_str2</span><span class="o">=</span><span class="k">$(</span>name_fixup <span class="si">${</span><span class="nv">_den_tmp</span><span class="p">[4]</span><span class="si">}</span><span class="k">)</span>
      <span class="k">then</span>
        _den_name<span class="o">[</span><span class="si">${#</span><span class="nv">_den_name</span><span class="p">[@]</span><span class="si">}</span><span class="o">]=</span><span class="si">${</span><span class="nv">_den_str2</span><span class="si">}</span>
        _den_achn<span class="o">[</span><span class="si">${#</span><span class="nv">_den_achn</span><span class="p">[@]</span><span class="si">}</span><span class="o">]=</span><span class="si">${</span><span class="nv">_den_who</span><span class="si">}</span><span class="s1">&#39; &#39;</span><span class="si">${</span><span class="nv">_den_str2</span><span class="si">}</span><span class="s1">&#39; SOA.O&#39;</span>
      <span class="k">fi</span>
      <span class="c"># Responsible party e-mail address (possibly bogus).</span>
      <span class="c"># Possibility of first.last@domain.name ignored.</span>
      <span class="nb">set</span> -f
      <span class="k">if</span> <span class="nv">_den_str2</span><span class="o">=</span><span class="k">$(</span>name_fixup <span class="si">${</span><span class="nv">_den_tmp</span><span class="p">[5]</span><span class="si">}</span><span class="k">)</span>
      <span class="k">then</span>
        <span class="nv">IFS</span><span class="o">=</span><span class="si">${</span><span class="nv">ADR_IFS</span><span class="si">}</span>
        <span class="nv">_den_auth</span><span class="o">=(</span> <span class="si">${</span><span class="nv">_den_str2</span><span class="si">}</span> <span class="o">)</span>
        <span class="nv">IFS</span><span class="o">=</span><span class="si">${</span><span class="nv">WSP_IFS</span><span class="si">}</span>
        <span class="k">if</span> <span class="o">[</span> <span class="si">${#</span><span class="nv">_den_auth</span><span class="p">[@]</span><span class="si">}</span> -gt <span class="m">2</span> <span class="o">]</span>
        <span class="k">then</span>
          <span class="nv">_den_cont</span><span class="o">=</span><span class="si">${</span><span class="nv">_den_auth</span><span class="p">[1]</span><span class="si">}</span>
          <span class="k">for</span> <span class="o">((</span> <span class="nv">_auth</span> <span class="o">=</span> <span class="m">2</span> <span class="p">;</span> _auth &lt; <span class="si">${#</span><span class="nv">_den_auth</span><span class="p">[@]</span><span class="si">}</span> <span class="p">;</span> _auth++ <span class="o">))</span>
          <span class="k">do</span>
            <span class="nv">_den_cont</span><span class="o">=</span><span class="si">${</span><span class="nv">_den_cont</span><span class="si">}</span><span class="s1">&#39;.&#39;</span><span class="si">${</span><span class="nv">_den_auth</span><span class="p">[</span><span class="si">${</span><span class="nv">_auth</span><span class="si">}</span><span class="p">]</span><span class="si">}</span>
          <span class="k">done</span>
          _den_name<span class="o">[</span><span class="si">${#</span><span class="nv">_den_name</span><span class="p">[@]</span><span class="si">}</span><span class="o">]=</span><span class="si">${</span><span class="nv">_den_cont</span><span class="si">}</span><span class="s1">&#39;.&#39;</span>
          _den_achn<span class="o">[</span><span class="si">${#</span><span class="nv">_den_achn</span><span class="p">[@]</span><span class="si">}</span><span class="o">]=</span><span class="si">${</span><span class="nv">_den_who</span><span class="si">}</span><span class="s1">&#39; &#39;</span><span class="si">${</span><span class="nv">_den_cont</span><span class="si">}</span><span class="s1">&#39;. SOA.C&#39;</span>
                                <span class="k">fi</span>
        <span class="k">fi</span>
        <span class="nb">set</span> +f
                        <span class="k">fi</span>
                    <span class="p">;;</span>


      A<span class="o">)</span> <span class="c"># IP(v4) Address Record</span>
      <span class="k">if</span> <span class="nv">_den_str</span><span class="o">=</span><span class="k">$(</span>name_fixup <span class="si">${</span><span class="nv">_den_tmp</span><span class="p">[0]</span><span class="si">}</span><span class="k">)</span>
      <span class="k">then</span>
        _den_name<span class="o">[</span><span class="si">${#</span><span class="nv">_den_name</span><span class="p">[@]</span><span class="si">}</span><span class="o">]=</span><span class="si">${</span><span class="nv">_den_str</span><span class="si">}</span>
        _den_pair<span class="o">[</span><span class="si">${#</span><span class="nv">_den_pair</span><span class="p">[@]</span><span class="si">}</span><span class="o">]=</span><span class="si">${</span><span class="nv">_den_tmp</span><span class="p">[4]</span><span class="si">}</span><span class="s1">&#39; &#39;</span><span class="si">${</span><span class="nv">_den_str</span><span class="si">}</span>
        _den_na<span class="o">[</span><span class="si">${#</span><span class="nv">_den_na</span><span class="p">[@]</span><span class="si">}</span><span class="o">]=</span><span class="si">${</span><span class="nv">_den_str</span><span class="si">}</span><span class="s1">&#39; &#39;</span><span class="si">${</span><span class="nv">_den_tmp</span><span class="p">[4]</span><span class="si">}</span>
        _den_ref<span class="o">[</span><span class="si">${#</span><span class="nv">_den_ref</span><span class="p">[@]</span><span class="si">}</span><span class="o">]=</span><span class="si">${</span><span class="nv">_den_who</span><span class="si">}</span><span class="s1">&#39; &#39;</span><span class="si">${</span><span class="nv">_den_str</span><span class="si">}</span><span class="s1">&#39; A&#39;</span>
      <span class="k">else</span>
        _den_pair<span class="o">[</span><span class="si">${#</span><span class="nv">_den_pair</span><span class="p">[@]</span><span class="si">}</span><span class="o">]=</span><span class="si">${</span><span class="nv">_den_tmp</span><span class="p">[4]</span><span class="si">}</span><span class="s1">&#39; unknown.domain&#39;</span>
        _den_na<span class="o">[</span><span class="si">${#</span><span class="nv">_den_na</span><span class="p">[@]</span><span class="si">}</span><span class="o">]=</span><span class="s1">&#39;unknown.domain &#39;</span><span class="si">${</span><span class="nv">_den_tmp</span><span class="p">[4]</span><span class="si">}</span>
        _den_ref<span class="o">[</span><span class="si">${#</span><span class="nv">_den_ref</span><span class="p">[@]</span><span class="si">}</span><span class="o">]=</span><span class="si">${</span><span class="nv">_den_who</span><span class="si">}</span><span class="s1">&#39; unknown.domain A&#39;</span>
      <span class="k">fi</span>
      _den_address<span class="o">[</span><span class="si">${#</span><span class="nv">_den_address</span><span class="p">[@]</span><span class="si">}</span><span class="o">]=</span><span class="si">${</span><span class="nv">_den_tmp</span><span class="p">[4]</span><span class="si">}</span>
      _den_pc<span class="o">[</span><span class="si">${#</span><span class="nv">_den_pc</span><span class="p">[@]</span><span class="si">}</span><span class="o">]=</span><span class="si">${</span><span class="nv">_den_who</span><span class="si">}</span><span class="s1">&#39; &#39;</span><span class="si">${</span><span class="nv">_den_tmp</span><span class="p">[4]</span><span class="si">}</span>
             <span class="p">;;</span>

             NS<span class="o">)</span> <span class="c"># Name Server Record</span>
             <span class="c"># Domain name being serviced (may be other than current)</span>
               <span class="k">if</span> <span class="nv">_den_str</span><span class="o">=</span><span class="k">$(</span>name_fixup <span class="si">${</span><span class="nv">_den_tmp</span><span class="p">[0]</span><span class="si">}</span><span class="k">)</span>
                 <span class="k">then</span>
                   _den_name<span class="o">[</span><span class="si">${#</span><span class="nv">_den_name</span><span class="p">[@]</span><span class="si">}</span><span class="o">]=</span><span class="si">${</span><span class="nv">_den_str</span><span class="si">}</span>
                   _den_ref<span class="o">[</span><span class="si">${#</span><span class="nv">_den_ref</span><span class="p">[@]</span><span class="si">}</span><span class="o">]=</span><span class="si">${</span><span class="nv">_den_who</span><span class="si">}</span><span class="s1">&#39; &#39;</span><span class="si">${</span><span class="nv">_den_str</span><span class="si">}</span><span class="s1">&#39; NS&#39;</span>

             <span class="c"># Domain name of service provider</span>
             <span class="k">if</span> <span class="nv">_den_str2</span><span class="o">=</span><span class="k">$(</span>name_fixup <span class="si">${</span><span class="nv">_den_tmp</span><span class="p">[4]</span><span class="si">}</span><span class="k">)</span>
             <span class="k">then</span>
               _den_name<span class="o">[</span><span class="si">${#</span><span class="nv">_den_name</span><span class="p">[@]</span><span class="si">}</span><span class="o">]=</span><span class="si">${</span><span class="nv">_den_str2</span><span class="si">}</span>
               _den_ref<span class="o">[</span><span class="si">${#</span><span class="nv">_den_ref</span><span class="p">[@]</span><span class="si">}</span><span class="o">]=</span><span class="si">${</span><span class="nv">_den_who</span><span class="si">}</span><span class="s1">&#39; &#39;</span><span class="si">${</span><span class="nv">_den_str2</span><span class="si">}</span><span class="s1">&#39; NSH&#39;</span>
               _den_ns<span class="o">[</span><span class="si">${#</span><span class="nv">_den_ns</span><span class="p">[@]</span><span class="si">}</span><span class="o">]=</span><span class="si">${</span><span class="nv">_den_str2</span><span class="si">}</span><span class="s1">&#39; NS&#39;</span>
               _den_pc<span class="o">[</span><span class="si">${#</span><span class="nv">_den_pc</span><span class="p">[@]</span><span class="si">}</span><span class="o">]=</span><span class="si">${</span><span class="nv">_den_str</span><span class="si">}</span><span class="s1">&#39; &#39;</span><span class="si">${</span><span class="nv">_den_str2</span><span class="si">}</span>
              <span class="k">fi</span>
               <span class="k">fi</span>
                    <span class="p">;;</span>

             MX<span class="o">)</span> <span class="c"># Mail Server Record</span>
                 <span class="c"># Domain name being serviced (wildcards not handled here)</span>
             <span class="k">if</span> <span class="nv">_den_str</span><span class="o">=</span><span class="k">$(</span>name_fixup <span class="si">${</span><span class="nv">_den_tmp</span><span class="p">[0]</span><span class="si">}</span><span class="k">)</span>
             <span class="k">then</span>
               _den_name<span class="o">[</span><span class="si">${#</span><span class="nv">_den_name</span><span class="p">[@]</span><span class="si">}</span><span class="o">]=</span><span class="si">${</span><span class="nv">_den_str</span><span class="si">}</span>
               _den_ref<span class="o">[</span><span class="si">${#</span><span class="nv">_den_ref</span><span class="p">[@]</span><span class="si">}</span><span class="o">]=</span><span class="si">${</span><span class="nv">_den_who</span><span class="si">}</span><span class="s1">&#39; &#39;</span><span class="si">${</span><span class="nv">_den_str</span><span class="si">}</span><span class="s1">&#39; MX&#39;</span>
             <span class="k">fi</span>
             <span class="c"># Domain name of service provider</span>
             <span class="k">if</span> <span class="nv">_den_str</span><span class="o">=</span><span class="k">$(</span>name_fixup <span class="si">${</span><span class="nv">_den_tmp</span><span class="p">[5]</span><span class="si">}</span><span class="k">)</span>
             <span class="k">then</span>
               _den_name<span class="o">[</span><span class="si">${#</span><span class="nv">_den_name</span><span class="p">[@]</span><span class="si">}</span><span class="o">]=</span><span class="si">${</span><span class="nv">_den_str</span><span class="si">}</span>
               _den_ref<span class="o">[</span><span class="si">${#</span><span class="nv">_den_ref</span><span class="p">[@]</span><span class="si">}</span><span class="o">]=</span><span class="si">${</span><span class="nv">_den_who</span><span class="si">}</span><span class="s1">&#39; &#39;</span><span class="si">${</span><span class="nv">_den_str</span><span class="si">}</span><span class="s1">&#39; MXH&#39;</span>
               _den_ns<span class="o">[</span><span class="si">${#</span><span class="nv">_den_ns</span><span class="p">[@]</span><span class="si">}</span><span class="o">]=</span><span class="si">${</span><span class="nv">_den_str</span><span class="si">}</span><span class="s1">&#39; MX&#39;</span>
               _den_pc<span class="o">[</span><span class="si">${#</span><span class="nv">_den_pc</span><span class="p">[@]</span><span class="si">}</span><span class="o">]=</span><span class="si">${</span><span class="nv">_den_who</span><span class="si">}</span><span class="s1">&#39; &#39;</span><span class="si">${</span><span class="nv">_den_str</span><span class="si">}</span>
             <span class="k">fi</span>
                    <span class="p">;;</span>

             PTR<span class="o">)</span> <span class="c"># Reverse address record</span>
                  <span class="c"># Special name</span>
             <span class="k">if</span> <span class="nv">_den_str</span><span class="o">=</span><span class="k">$(</span>name_fixup <span class="si">${</span><span class="nv">_den_tmp</span><span class="p">[0]</span><span class="si">}</span><span class="k">)</span>
             <span class="k">then</span>
               _den_ref<span class="o">[</span><span class="si">${#</span><span class="nv">_den_ref</span><span class="p">[@]</span><span class="si">}</span><span class="o">]=</span><span class="si">${</span><span class="nv">_den_who</span><span class="si">}</span><span class="s1">&#39; &#39;</span><span class="si">${</span><span class="nv">_den_str</span><span class="si">}</span><span class="s1">&#39; PTR&#39;</span>
               <span class="c"># Host name (not a CNAME)</span>
               <span class="k">if</span> <span class="nv">_den_str2</span><span class="o">=</span><span class="k">$(</span>name_fixup <span class="si">${</span><span class="nv">_den_tmp</span><span class="p">[4]</span><span class="si">}</span><span class="k">)</span>
               <span class="k">then</span>
                 _den_rev<span class="o">[</span><span class="si">${#</span><span class="nv">_den_rev</span><span class="p">[@]</span><span class="si">}</span><span class="o">]=</span><span class="si">${</span><span class="nv">_den_str</span><span class="si">}</span><span class="s1">&#39; &#39;</span><span class="si">${</span><span class="nv">_den_str2</span><span class="si">}</span>
                 _den_ref<span class="o">[</span><span class="si">${#</span><span class="nv">_den_ref</span><span class="p">[@]</span><span class="si">}</span><span class="o">]=</span><span class="si">${</span><span class="nv">_den_who</span><span class="si">}</span><span class="s1">&#39; &#39;</span><span class="si">${</span><span class="nv">_den_str2</span><span class="si">}</span><span class="s1">&#39; PTRH&#39;</span>
                 _den_pc<span class="o">[</span><span class="si">${#</span><span class="nv">_den_pc</span><span class="p">[@]</span><span class="si">}</span><span class="o">]=</span><span class="si">${</span><span class="nv">_den_who</span><span class="si">}</span><span class="s1">&#39; &#39;</span><span class="si">${</span><span class="nv">_den_str</span><span class="si">}</span>
               <span class="k">fi</span>
             <span class="k">fi</span>
                    <span class="p">;;</span>

             AAAA<span class="o">)</span> <span class="c"># IP(v6) Address Record</span>
             <span class="k">if</span> <span class="nv">_den_str</span><span class="o">=</span><span class="k">$(</span>name_fixup <span class="si">${</span><span class="nv">_den_tmp</span><span class="p">[0]</span><span class="si">}</span><span class="k">)</span>
             <span class="k">then</span>
               _den_name<span class="o">[</span><span class="si">${#</span><span class="nv">_den_name</span><span class="p">[@]</span><span class="si">}</span><span class="o">]=</span><span class="si">${</span><span class="nv">_den_str</span><span class="si">}</span>
               _den_pair<span class="o">[</span><span class="si">${#</span><span class="nv">_den_pair</span><span class="p">[@]</span><span class="si">}</span><span class="o">]=</span><span class="si">${</span><span class="nv">_den_tmp</span><span class="p">[4]</span><span class="si">}</span><span class="s1">&#39; &#39;</span><span class="si">${</span><span class="nv">_den_str</span><span class="si">}</span>
               _den_na<span class="o">[</span><span class="si">${#</span><span class="nv">_den_na</span><span class="p">[@]</span><span class="si">}</span><span class="o">]=</span><span class="si">${</span><span class="nv">_den_str</span><span class="si">}</span><span class="s1">&#39; &#39;</span><span class="si">${</span><span class="nv">_den_tmp</span><span class="p">[4]</span><span class="si">}</span>
               _den_ref<span class="o">[</span><span class="si">${#</span><span class="nv">_den_ref</span><span class="p">[@]</span><span class="si">}</span><span class="o">]=</span><span class="si">${</span><span class="nv">_den_who</span><span class="si">}</span><span class="s1">&#39; &#39;</span><span class="si">${</span><span class="nv">_den_str</span><span class="si">}</span><span class="s1">&#39; AAAA&#39;</span>
               <span class="k">else</span>
                 _den_pair<span class="o">[</span><span class="si">${#</span><span class="nv">_den_pair</span><span class="p">[@]</span><span class="si">}</span><span class="o">]=</span><span class="si">${</span><span class="nv">_den_tmp</span><span class="p">[4]</span><span class="si">}</span><span class="s1">&#39; unknown.domain&#39;</span>
                 _den_na<span class="o">[</span><span class="si">${#</span><span class="nv">_den_na</span><span class="p">[@]</span><span class="si">}</span><span class="o">]=</span><span class="s1">&#39;unknown.domain &#39;</span><span class="si">${</span><span class="nv">_den_tmp</span><span class="p">[4]</span><span class="si">}</span>
                 _den_ref<span class="o">[</span><span class="si">${#</span><span class="nv">_den_ref</span><span class="p">[@]</span><span class="si">}</span><span class="o">]=</span><span class="si">${</span><span class="nv">_den_who</span><span class="si">}</span><span class="s1">&#39; unknown.domain&#39;</span>
               <span class="k">fi</span>
               <span class="c"># No processing for IPv6 addresses</span>
               _den_pc<span class="o">[</span><span class="si">${#</span><span class="nv">_den_pc</span><span class="p">[@]</span><span class="si">}</span><span class="o">]=</span><span class="si">${</span><span class="nv">_den_who</span><span class="si">}</span><span class="s1">&#39; &#39;</span><span class="si">${</span><span class="nv">_den_tmp</span><span class="p">[4]</span><span class="si">}</span>
                    <span class="p">;;</span>

             CNAME<span class="o">)</span> <span class="c"># Alias name record</span>
                    <span class="c"># Nickname</span>
             <span class="k">if</span> <span class="nv">_den_str</span><span class="o">=</span><span class="k">$(</span>name_fixup <span class="si">${</span><span class="nv">_den_tmp</span><span class="p">[0]</span><span class="si">}</span><span class="k">)</span>
             <span class="k">then</span>
               _den_name<span class="o">[</span><span class="si">${#</span><span class="nv">_den_name</span><span class="p">[@]</span><span class="si">}</span><span class="o">]=</span><span class="si">${</span><span class="nv">_den_str</span><span class="si">}</span>
               _den_ref<span class="o">[</span><span class="si">${#</span><span class="nv">_den_ref</span><span class="p">[@]</span><span class="si">}</span><span class="o">]=</span><span class="si">${</span><span class="nv">_den_who</span><span class="si">}</span><span class="s1">&#39; &#39;</span><span class="si">${</span><span class="nv">_den_str</span><span class="si">}</span><span class="s1">&#39; CNAME&#39;</span>
               _den_pc<span class="o">[</span><span class="si">${#</span><span class="nv">_den_pc</span><span class="p">[@]</span><span class="si">}</span><span class="o">]=</span><span class="si">${</span><span class="nv">_den_who</span><span class="si">}</span><span class="s1">&#39; &#39;</span><span class="si">${</span><span class="nv">_den_str</span><span class="si">}</span>
             <span class="k">fi</span>
                    <span class="c"># Hostname</span>
             <span class="k">if</span> <span class="nv">_den_str</span><span class="o">=</span><span class="k">$(</span>name_fixup <span class="si">${</span><span class="nv">_den_tmp</span><span class="p">[4]</span><span class="si">}</span><span class="k">)</span>
             <span class="k">then</span>
               _den_name<span class="o">[</span><span class="si">${#</span><span class="nv">_den_name</span><span class="p">[@]</span><span class="si">}</span><span class="o">]=</span><span class="si">${</span><span class="nv">_den_str</span><span class="si">}</span>
               _den_ref<span class="o">[</span><span class="si">${#</span><span class="nv">_den_ref</span><span class="p">[@]</span><span class="si">}</span><span class="o">]=</span><span class="si">${</span><span class="nv">_den_who</span><span class="si">}</span><span class="s1">&#39; &#39;</span><span class="si">${</span><span class="nv">_den_str</span><span class="si">}</span><span class="s1">&#39; CHOST&#39;</span>
               _den_pc<span class="o">[</span><span class="si">${#</span><span class="nv">_den_pc</span><span class="p">[@]</span><span class="si">}</span><span class="o">]=</span><span class="si">${</span><span class="nv">_den_who</span><span class="si">}</span><span class="s1">&#39; &#39;</span><span class="si">${</span><span class="nv">_den_str</span><span class="si">}</span>
             <span class="k">fi</span>
                    <span class="p">;;</span>
<span class="c">#            TXT)</span>
<span class="c">#            ;;</span>
                    <span class="k">esac</span>
                <span class="k">fi</span>
            <span class="k">done</span>
        <span class="k">else</span> <span class="c"># Lookup error == &#39;A&#39; record &#39;unknown address&#39;</span>
            _den_pair<span class="o">[</span><span class="si">${#</span><span class="nv">_den_pair</span><span class="p">[@]</span><span class="si">}</span><span class="o">]=</span><span class="s1">&#39;0.0.0.0 &#39;</span><span class="si">${</span><span class="nv">_den_who</span><span class="si">}</span>
        <span class="k">fi</span>
    <span class="k">done</span>

    <span class="c"># Control dot array growth.</span>
    unique_lines _den_achn _den_achn      <span class="c"># Works best, all the same.</span>
    edit_exact auth_chain _den_achn       <span class="c"># Works best, unique items.</span>
    <span class="k">if</span> <span class="o">[</span> <span class="si">${#</span><span class="nv">_den_achn</span><span class="p">[@]</span><span class="si">}</span> -gt <span class="m">0</span> <span class="o">]</span>
    <span class="k">then</span>
        <span class="nv">IFS</span><span class="o">=</span><span class="si">${</span><span class="nv">NO_WSP</span><span class="si">}</span>
        <span class="nv">auth_chain</span><span class="o">=(</span> <span class="si">${</span><span class="nv">auth_chain</span><span class="p">[@]</span><span class="si">}</span> <span class="si">${</span><span class="nv">_den_achn</span><span class="p">[@]</span><span class="si">}</span> <span class="o">)</span>
        <span class="nv">IFS</span><span class="o">=</span><span class="si">${</span><span class="nv">WSP_IFS</span><span class="si">}</span>
    <span class="k">fi</span>

    unique_lines _den_ref _den_ref      <span class="c"># Works best, all the same.</span>
    edit_exact ref_chain _den_ref       <span class="c"># Works best, unique items.</span>
    <span class="k">if</span> <span class="o">[</span> <span class="si">${#</span><span class="nv">_den_ref</span><span class="p">[@]</span><span class="si">}</span> -gt <span class="m">0</span> <span class="o">]</span>
    <span class="k">then</span>
        <span class="nv">IFS</span><span class="o">=</span><span class="si">${</span><span class="nv">NO_WSP</span><span class="si">}</span>
        <span class="nv">ref_chain</span><span class="o">=(</span> <span class="si">${</span><span class="nv">ref_chain</span><span class="p">[@]</span><span class="si">}</span> <span class="si">${</span><span class="nv">_den_ref</span><span class="p">[@]</span><span class="si">}</span> <span class="o">)</span>
        <span class="nv">IFS</span><span class="o">=</span><span class="si">${</span><span class="nv">WSP_IFS</span><span class="si">}</span>
    <span class="k">fi</span>

    unique_lines _den_na _den_na
    edit_exact name_address _den_na
    <span class="k">if</span> <span class="o">[</span> <span class="si">${#</span><span class="nv">_den_na</span><span class="p">[@]</span><span class="si">}</span> -gt <span class="m">0</span> <span class="o">]</span>
    <span class="k">then</span>
        <span class="nv">IFS</span><span class="o">=</span><span class="si">${</span><span class="nv">NO_WSP</span><span class="si">}</span>
        <span class="nv">name_address</span><span class="o">=(</span> <span class="si">${</span><span class="nv">name_address</span><span class="p">[@]</span><span class="si">}</span> <span class="si">${</span><span class="nv">_den_na</span><span class="p">[@]</span><span class="si">}</span> <span class="o">)</span>
        <span class="nv">IFS</span><span class="o">=</span><span class="si">${</span><span class="nv">WSP_IFS</span><span class="si">}</span>
    <span class="k">fi</span>

    unique_lines _den_ns _den_ns
    edit_exact name_srvc _den_ns
    <span class="k">if</span> <span class="o">[</span> <span class="si">${#</span><span class="nv">_den_ns</span><span class="p">[@]</span><span class="si">}</span> -gt <span class="m">0</span> <span class="o">]</span>
    <span class="k">then</span>
        <span class="nv">IFS</span><span class="o">=</span><span class="si">${</span><span class="nv">NO_WSP</span><span class="si">}</span>
        <span class="nv">name_srvc</span><span class="o">=(</span> <span class="si">${</span><span class="nv">name_srvc</span><span class="p">[@]</span><span class="si">}</span> <span class="si">${</span><span class="nv">_den_ns</span><span class="p">[@]</span><span class="si">}</span> <span class="o">)</span>
        <span class="nv">IFS</span><span class="o">=</span><span class="si">${</span><span class="nv">WSP_IFS</span><span class="si">}</span>
    <span class="k">fi</span>

    unique_lines _den_nr _den_nr
    edit_exact name_resource _den_nr
    <span class="k">if</span> <span class="o">[</span> <span class="si">${#</span><span class="nv">_den_nr</span><span class="p">[@]</span><span class="si">}</span> -gt <span class="m">0</span> <span class="o">]</span>
    <span class="k">then</span>
        <span class="nv">IFS</span><span class="o">=</span><span class="si">${</span><span class="nv">NO_WSP</span><span class="si">}</span>
        <span class="nv">name_resource</span><span class="o">=(</span> <span class="si">${</span><span class="nv">name_resource</span><span class="p">[@]</span><span class="si">}</span> <span class="si">${</span><span class="nv">_den_nr</span><span class="p">[@]</span><span class="si">}</span> <span class="o">)</span>
        <span class="nv">IFS</span><span class="o">=</span><span class="si">${</span><span class="nv">WSP_IFS</span><span class="si">}</span>
    <span class="k">fi</span>

    unique_lines _den_pc _den_pc
    edit_exact parent_child _den_pc
    <span class="k">if</span> <span class="o">[</span> <span class="si">${#</span><span class="nv">_den_pc</span><span class="p">[@]</span><span class="si">}</span> -gt <span class="m">0</span> <span class="o">]</span>
    <span class="k">then</span>
        <span class="nv">IFS</span><span class="o">=</span><span class="si">${</span><span class="nv">NO_WSP</span><span class="si">}</span>
        <span class="nv">parent_child</span><span class="o">=(</span> <span class="si">${</span><span class="nv">parent_child</span><span class="p">[@]</span><span class="si">}</span> <span class="si">${</span><span class="nv">_den_pc</span><span class="p">[@]</span><span class="si">}</span> <span class="o">)</span>
        <span class="nv">IFS</span><span class="o">=</span><span class="si">${</span><span class="nv">WSP_IFS</span><span class="si">}</span>
    <span class="k">fi</span>

    <span class="c"># Update list known_pair (Address and Name).</span>
    unique_lines _den_pair _den_pair
    edit_exact known_pair _den_pair
    <span class="k">if</span> <span class="o">[</span> <span class="si">${#</span><span class="nv">_den_pair</span><span class="p">[@]</span><span class="si">}</span> -gt <span class="m">0</span> <span class="o">]</span>  <span class="c"># Anything new?</span>
    <span class="k">then</span>
        <span class="nv">IFS</span><span class="o">=</span><span class="si">${</span><span class="nv">NO_WSP</span><span class="si">}</span>
        <span class="nv">known_pair</span><span class="o">=(</span> <span class="si">${</span><span class="nv">known_pair</span><span class="p">[@]</span><span class="si">}</span> <span class="si">${</span><span class="nv">_den_pair</span><span class="p">[@]</span><span class="si">}</span> <span class="o">)</span>
        <span class="nv">IFS</span><span class="o">=</span><span class="si">${</span><span class="nv">WSP_IFS</span><span class="si">}</span>
    <span class="k">fi</span>

    <span class="c"># Update list of reverse pairs.</span>
    unique_lines _den_rev _den_rev
    edit_exact reverse_pair _den_rev
    <span class="k">if</span> <span class="o">[</span> <span class="si">${#</span><span class="nv">_den_rev</span><span class="p">[@]</span><span class="si">}</span> -gt <span class="m">0</span> <span class="o">]</span>   <span class="c"># Anything new?</span>
    <span class="k">then</span>
        <span class="nv">IFS</span><span class="o">=</span><span class="si">${</span><span class="nv">NO_WSP</span><span class="si">}</span>
        <span class="nv">reverse_pair</span><span class="o">=(</span> <span class="si">${</span><span class="nv">reverse_pair</span><span class="p">[@]</span><span class="si">}</span> <span class="si">${</span><span class="nv">_den_rev</span><span class="p">[@]</span><span class="si">}</span> <span class="o">)</span>
        <span class="nv">IFS</span><span class="o">=</span><span class="si">${</span><span class="nv">WSP_IFS</span><span class="si">}</span>
    <span class="k">fi</span>

    <span class="c"># Check indirection limit -- give up if reached.</span>
    <span class="k">if</span> ! <span class="nv">_den_lmt</span><span class="o">=</span><span class="k">$(</span>limit_chk <span class="si">${</span><span class="nv">1</span><span class="si">}</span><span class="k">)</span>
    <span class="k">then</span>
        <span class="k">return</span> 0
    <span class="k">fi</span>

<span class="c"># Execution engine is LIFO. Order of pend operations is important.</span>
<span class="c"># Did we define any new addresses?</span>
unique_lines _den_address _den_address    <span class="c"># Scrub duplicates.</span>
edit_exact known_address _den_address     <span class="c"># Scrub already processed.</span>
edit_exact un_address _den_address        <span class="c"># Scrub already waiting.</span>
<span class="k">if</span> <span class="o">[</span> <span class="si">${#</span><span class="nv">_den_address</span><span class="p">[@]</span><span class="si">}</span> -gt <span class="m">0</span> <span class="o">]</span>          <span class="c"># Anything new?</span>
<span class="k">then</span>
  <span class="nv">uc_address</span><span class="o">=(</span> <span class="si">${</span><span class="nv">uc_address</span><span class="p">[@]</span><span class="si">}</span> <span class="si">${</span><span class="nv">_den_address</span><span class="p">[@]</span><span class="si">}</span> <span class="o">)</span>
  pend_func expand_input_address <span class="si">${</span><span class="nv">_den_lmt</span><span class="si">}</span>
  _trace_log<span class="o">[</span><span class="si">${#</span><span class="nv">_trace_log</span><span class="p">[@]</span><span class="si">}</span><span class="o">]=</span><span class="s1">&#39;# Add &#39;</span><span class="si">${#</span><span class="nv">_den_address</span><span class="p">[@]</span><span class="si">}</span><span class="s1">&#39; unchkd addr. #&#39;</span>
    <span class="k">fi</span>

<span class="c"># Did we find any new names?</span>
unique_lines _den_name _den_name          <span class="c"># Scrub duplicates.</span>
edit_exact known_name _den_name           <span class="c"># Scrub already processed.</span>
edit_exact uc_name _den_name              <span class="c"># Scrub already waiting.</span>
<span class="k">if</span> <span class="o">[</span> <span class="si">${#</span><span class="nv">_den_name</span><span class="p">[@]</span><span class="si">}</span> -gt <span class="m">0</span> <span class="o">]</span>             <span class="c"># Anything new?</span>
<span class="k">then</span>
  <span class="nv">uc_name</span><span class="o">=(</span> <span class="si">${</span><span class="nv">uc_name</span><span class="p">[@]</span><span class="si">}</span> <span class="si">${</span><span class="nv">_den_name</span><span class="p">[@]</span><span class="si">}</span> <span class="o">)</span>
  pend_func expand_input_name <span class="si">${</span><span class="nv">_den_lmt</span><span class="si">}</span>
  _trace_log<span class="o">[</span><span class="si">${#</span><span class="nv">_trace_log</span><span class="p">[@]</span><span class="si">}</span><span class="o">]=</span><span class="s1">&#39;#Added &#39;</span><span class="si">${#</span><span class="nv">_den_name</span><span class="p">[@]</span><span class="si">}</span><span class="s1">&#39; unchkd name#&#39;</span>
    <span class="k">fi</span>
    <span class="k">return</span> 0
<span class="o">}</span>

<span class="c"># The parse-it-yourself delegation reply</span>
<span class="c"># Input is the chk_address list.</span>
<span class="c"># detail_each_address &lt;indirection_limit&gt;</span>
detail_each_address<span class="o">()</span> <span class="o">{</span>
    <span class="o">[</span> <span class="si">${#</span><span class="nv">chk_address</span><span class="p">[@]</span><span class="si">}</span> -gt <span class="m">0</span> <span class="o">]</span> <span class="p">|</span><span class="k">return</span> 0
    unique_lines chk_address chk_address
    edit_exact known_address chk_address
    <span class="k">if</span> <span class="o">[</span> <span class="si">${#</span><span class="nv">chk_address</span><span class="p">[@]</span><span class="si">}</span> -gt <span class="m">0</span> <span class="o">]</span>
    <span class="k">then</span>
        <span class="nv">known_address</span><span class="o">=(</span> <span class="si">${</span><span class="nv">known_address</span><span class="p">[@]</span><span class="si">}</span> <span class="si">${</span><span class="nv">chk_address</span><span class="p">[@]</span><span class="si">}</span> <span class="o">)</span>
        <span class="nb">unset </span>chk_address<span class="o">[</span>@<span class="o">]</span>
    <span class="k">fi</span>
    <span class="k">return</span> 0
<span class="o">}</span>

<span class="c"># # # Application specific output functions # # #</span>

<span class="c"># Pretty print the known pairs.</span>
report_pairs<span class="o">()</span> <span class="o">{</span>
    <span class="nb">echo</span>
<span class="nb">    echo</span> <span class="s1">&#39;Known network pairs.&#39;</span>
    col_print known_pair <span class="m">2</span> <span class="m">5</span> 30

    <span class="k">if</span> <span class="o">[</span> <span class="si">${#</span><span class="nv">auth_chain</span><span class="p">[@]</span><span class="si">}</span> -gt <span class="m">0</span> <span class="o">]</span>
    <span class="k">then</span>
        <span class="nb">echo</span>
<span class="nb">        echo</span> <span class="s1">&#39;Known chain of authority.&#39;</span>
        col_print auth_chain <span class="m">2</span> <span class="m">5</span> <span class="m">30</span> 55
    <span class="k">fi</span>

    <span class="k">if</span> <span class="o">[</span> <span class="si">${#</span><span class="nv">reverse_pair</span><span class="p">[@]</span><span class="si">}</span> -gt <span class="m">0</span> <span class="o">]</span>
    <span class="k">then</span>
        <span class="nb">echo</span>
<span class="nb">        echo</span> <span class="s1">&#39;Known reverse pairs.&#39;</span>
        col_print reverse_pair <span class="m">2</span> <span class="m">5</span> 55
    <span class="k">fi</span>
    <span class="k">return</span> 0
<span class="o">}</span>

<span class="c"># Check an address against the list of blacklist servers.</span>
<span class="c"># A good place to capture for GraphViz: address-&gt;status(server(reports))</span>
<span class="c"># check_lists &lt;ip_address&gt;</span>
check_lists<span class="o">()</span> <span class="o">{</span>
    <span class="o">[</span> <span class="nv">$# </span>-eq <span class="m">1</span> <span class="o">]</span> <span class="p">|</span><span class="k">return</span> 1
    <span class="nb">local</span> -a _cl_fwd_addr
    <span class="nb">local</span> -a _cl_rev_addr
    <span class="nb">local</span> -a _cl_reply
    <span class="nb">local</span> -i _cl_rc
    <span class="nb">local</span> -i _ls_cnt
    <span class="nb">local </span>_cl_dns_addr
    <span class="nb">local </span>_cl_lkup

    split_ip <span class="si">${</span><span class="nv">1</span><span class="si">}</span> _cl_fwd_addr _cl_rev_addr
    <span class="nv">_cl_dns_addr</span><span class="o">=</span><span class="k">$(</span>dot_array _cl_rev_addr<span class="k">)</span><span class="s1">&#39;.&#39;</span>
    <span class="nv">_ls_cnt</span><span class="o">=</span><span class="si">${#</span><span class="nv">list_server</span><span class="p">[@]</span><span class="si">}</span>
    <span class="nb">echo</span> <span class="s1">&#39;    Checking address &#39;</span><span class="si">${</span><span class="nv">1</span><span class="si">}</span>
    <span class="k">for</span> <span class="o">((</span> <span class="nv">_cl</span> <span class="o">=</span> <span class="m">0</span> <span class="p">;</span> _cl &lt; _ls_cnt <span class="p">;</span> _cl++ <span class="o">))</span>
    <span class="k">do</span>
      <span class="nv">_cl_lkup</span><span class="o">=</span><span class="si">${</span><span class="nv">_cl_dns_addr</span><span class="si">}${</span><span class="nv">list_server</span><span class="p">[</span><span class="si">${</span><span class="nv">_cl</span><span class="si">}</span><span class="p">]</span><span class="si">}</span>
      <span class="k">if</span> short_text <span class="si">${</span><span class="nv">_cl_lkup</span><span class="si">}</span> _cl_reply
      <span class="k">then</span>
        <span class="k">if</span> <span class="o">[</span> <span class="si">${#</span><span class="nv">_cl_reply</span><span class="p">[@]</span><span class="si">}</span> -gt <span class="m">0</span> <span class="o">]</span>
        <span class="k">then</span>
          <span class="nb">echo</span> <span class="s1">&#39;        Records from &#39;</span><span class="si">${</span><span class="nv">list_server</span><span class="p">[</span><span class="si">${</span><span class="nv">_cl</span><span class="si">}</span><span class="p">]</span><span class="si">}</span>
          address_hits<span class="o">[</span><span class="si">${#</span><span class="nv">address_hits</span><span class="p">[@]</span><span class="si">}</span><span class="o">]=</span><span class="si">${</span><span class="nv">1</span><span class="si">}</span><span class="s1">&#39; &#39;</span><span class="si">${</span><span class="nv">list_server</span><span class="p">[</span><span class="si">${</span><span class="nv">_cl</span><span class="si">}</span><span class="p">]</span><span class="si">}</span>
          <span class="nv">_hs_RC</span><span class="o">=</span>2
          <span class="k">for</span> <span class="o">((</span> <span class="nv">_clr</span> <span class="o">=</span> <span class="m">0</span> <span class="p">;</span> _clr &lt; <span class="si">${#</span><span class="nv">_cl_reply</span><span class="p">[@]</span><span class="si">}</span> <span class="p">;</span> _clr++ <span class="o">))</span>
          <span class="k">do</span>
            <span class="nb">echo</span> <span class="s1">&#39;            &#39;</span><span class="si">${</span><span class="nv">_cl_reply</span><span class="p">[</span><span class="si">${</span><span class="nv">_clr</span><span class="si">}</span><span class="p">]</span><span class="si">}</span>
          <span class="k">done</span>
        <span class="k">fi</span>
      <span class="k">fi</span>
    <span class="k">done</span>
    <span class="k">return</span> 0
<span class="o">}</span>

<span class="c"># # # The usual application glue # # #</span>

<span class="c"># Who did it?</span>
credits<span class="o">()</span> <span class="o">{</span>
   <span class="nb">echo</span>
<span class="nb">   echo</span> <span class="s1">&#39;Advanced Bash Scripting Guide: is_spammer.bash, v2, 2004-msz&#39;</span>
<span class="o">}</span>

<span class="c"># How to use it?</span>
<span class="c"># (See also, &quot;Quickstart&quot; at end of script.)</span>
usage<span class="o">()</span> <span class="o">{</span>
    cat <span class="s">&lt;&lt;-&#39;_usage_statement_&#39;</span>
<span class="s">    The script is_spammer.bash requires either one or two arguments.</span>

<span class="s">    arg 1) May be one of:</span>
<span class="s">        a) A domain name</span>
<span class="s">        b) An IPv4 address</span>
<span class="s">        c) The name of a file with any mix of names</span>
<span class="s">           and addresses, one per line.</span>

<span class="s">    arg 2) May be one of:</span>
<span class="s">        a) A Blacklist server domain name</span>
<span class="s">        b) The name of a file with Blacklist server</span>
<span class="s">           domain names, one per line.</span>
<span class="s">        c) If not present, a default list of (free)</span>
<span class="s">           Blacklist servers is used.</span>
<span class="s">        d) If a filename of an empty, readable, file</span>
<span class="s">           is given,</span>
<span class="s">           Blacklist server lookup is disabled.</span>

<span class="s">    All script output is written to stdout.</span>

<span class="s">    Return codes: 0 -&gt; All OK, 1 -&gt; Script failure,</span>
<span class="s">                  2 -&gt; Something is Blacklisted.</span>

<span class="s">    Requires the external program &#39;dig&#39; from the &#39;bind-9&#39;</span>
<span class="s">    set of DNS programs.  See: http://www.isc.org</span>

<span class="s">    The domain name lookup depth limit defaults to 2 levels.</span>
<span class="s">    Set the environment variable SPAMMER_LIMIT to change.</span>
<span class="s">    SPAMMER_LIMIT=0 means &#39;unlimited&#39;</span>

<span class="s">    Limit may also be set on the command-line.</span>
<span class="s">    If arg#1 is an integer, the limit is set to that value</span>
<span class="s">    and then the above argument rules are applied.</span>

<span class="s">    Setting the environment variable &#39;SPAMMER_DATA&#39; to a filename</span>
<span class="s">    will cause the script to write a GraphViz graphic file.</span>

<span class="s">    For the development version;</span>
<span class="s">    Setting the environment variable &#39;SPAMMER_TRACE&#39; to a filename</span>
<span class="s">    will cause the execution engine to log a function call trace.</span>

<span class="s">_usage_statement_</span>
<span class="o">}</span>

<span class="c"># The default list of Blacklist servers:</span>
<span class="c"># Many choices, see: http://www.spews.org/lists.html</span>

<span class="nb">declare</span> -a default_servers
<span class="c"># See: http://www.spamhaus.org (Conservative, well maintained)</span>
default_servers<span class="o">[</span>0<span class="o">]=</span><span class="s1">&#39;sbl-xbl.spamhaus.org&#39;</span>
<span class="c"># See: http://ordb.org (Open mail relays)</span>
default_servers<span class="o">[</span>1<span class="o">]=</span><span class="s1">&#39;relays.ordb.org&#39;</span>
<span class="c"># See: http://www.spamcop.net/ (You can report spammers here)</span>
default_servers<span class="o">[</span>2<span class="o">]=</span><span class="s1">&#39;bl.spamcop.net&#39;</span>
<span class="c"># See: http://www.spews.org (An &#39;early detect&#39; system)</span>
default_servers<span class="o">[</span>3<span class="o">]=</span><span class="s1">&#39;l2.spews.dnsbl.sorbs.net&#39;</span>
<span class="c"># See: http://www.dnsbl.us.sorbs.net/using.shtml</span>
default_servers<span class="o">[</span>4<span class="o">]=</span><span class="s1">&#39;dnsbl.sorbs.net&#39;</span>
<span class="c"># See: http://dsbl.org/usage (Various mail relay lists)</span>
default_servers<span class="o">[</span>5<span class="o">]=</span><span class="s1">&#39;list.dsbl.org&#39;</span>
default_servers<span class="o">[</span>6<span class="o">]=</span><span class="s1">&#39;multihop.dsbl.org&#39;</span>
default_servers<span class="o">[</span>7<span class="o">]=</span><span class="s1">&#39;unconfirmed.dsbl.org&#39;</span>

<span class="c"># User input argument #1</span>
setup_input<span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">[</span> -e <span class="si">${</span><span class="nv">1</span><span class="si">}</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">[</span> -r <span class="si">${</span><span class="nv">1</span><span class="si">}</span> <span class="o">]</span>  <span class="c"># Name of readable file</span>
    <span class="k">then</span>
        file_to_array <span class="si">${</span><span class="nv">1</span><span class="si">}</span> uc_name
        <span class="nb">echo</span> <span class="s1">&#39;Using filename &gt;&#39;</span><span class="si">${</span><span class="nv">1</span><span class="si">}</span><span class="s1">&#39;&lt; as input.&#39;</span>
    <span class="k">else</span>
        <span class="k">if</span> is_address <span class="si">${</span><span class="nv">1</span><span class="si">}</span>          <span class="c"># IP address?</span>
        <span class="k">then</span>
            <span class="nv">uc_address</span><span class="o">=(</span> <span class="si">${</span><span class="nv">1</span><span class="si">}</span> <span class="o">)</span>
            <span class="nb">echo</span> <span class="s1">&#39;Starting with address &gt;&#39;</span><span class="si">${</span><span class="nv">1</span><span class="si">}</span><span class="s1">&#39;&lt;&#39;</span>
        <span class="k">else</span>                       <span class="c"># Must be a name.</span>
            <span class="nv">uc_name</span><span class="o">=(</span> <span class="si">${</span><span class="nv">1</span><span class="si">}</span> <span class="o">)</span>
            <span class="nb">echo</span> <span class="s1">&#39;Starting with domain name &gt;&#39;</span><span class="si">${</span><span class="nv">1</span><span class="si">}</span><span class="s1">&#39;&lt;&#39;</span>
        <span class="k">fi</span>
    <span class="k">fi</span>
    <span class="k">return</span> 0
<span class="o">}</span>

<span class="c"># User input argument #2</span>
setup_servers<span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">[</span> -e <span class="si">${</span><span class="nv">1</span><span class="si">}</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">[</span> -r <span class="si">${</span><span class="nv">1</span><span class="si">}</span> <span class="o">]</span>  <span class="c"># Name of a readable file</span>
    <span class="k">then</span>
        file_to_array <span class="si">${</span><span class="nv">1</span><span class="si">}</span> list_server
        <span class="nb">echo</span> <span class="s1">&#39;Using filename &gt;&#39;</span><span class="si">${</span><span class="nv">1</span><span class="si">}</span><span class="s1">&#39;&lt; as blacklist server list.&#39;</span>
    <span class="k">else</span>
        <span class="nv">list_server</span><span class="o">=(</span> <span class="si">${</span><span class="nv">1</span><span class="si">}</span> <span class="o">)</span>
        <span class="nb">echo</span> <span class="s1">&#39;Using blacklist server &gt;&#39;</span><span class="si">${</span><span class="nv">1</span><span class="si">}</span><span class="s1">&#39;&lt;&#39;</span>
    <span class="k">fi</span>
    <span class="k">return</span> 0
<span class="o">}</span>

<span class="c"># User environment variable SPAMMER_TRACE</span>
live_log_die<span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">[</span> <span class="si">${</span><span class="nv">SPAMMER_TRACE</span><span class="p">:=</span><span class="si">}</span> <span class="o">]</span>    <span class="c"># Wants trace log?</span>
    <span class="k">then</span>
        <span class="k">if</span> <span class="o">[</span> ! -e <span class="si">${</span><span class="nv">SPAMMER_TRACE</span><span class="si">}</span> <span class="o">]</span>
        <span class="k">then</span>
            <span class="k">if</span> ! touch <span class="si">${</span><span class="nv">SPAMMER_TRACE</span><span class="si">}</span> 2&gt;/dev/null
            <span class="k">then</span>
                pend_func <span class="nb">echo</span> <span class="k">$(</span><span class="nb">printf</span> <span class="s1">&#39;%q\n&#39;</span> <span class="se">\</span>
                <span class="s1">&#39;Unable to create log file &gt;&#39;</span><span class="si">${</span><span class="nv">SPAMMER_TRACE</span><span class="si">}</span><span class="s1">&#39;&lt;&#39;</span><span class="k">)</span>
                pend_release
                <span class="nb">exit </span>1
            <span class="k">fi</span>
            <span class="nv">_log_file</span><span class="o">=</span><span class="si">${</span><span class="nv">SPAMMER_TRACE</span><span class="si">}</span>
            <span class="nv">_pend_hook_</span><span class="o">=</span>trace_logger
            <span class="nv">_log_dump</span><span class="o">=</span>dump_log
        <span class="k">else</span>
            <span class="k">if</span> <span class="o">[</span> ! -w <span class="si">${</span><span class="nv">SPAMMER_TRACE</span><span class="si">}</span> <span class="o">]</span>
            <span class="k">then</span>
                pend_func <span class="nb">echo</span> <span class="k">$(</span><span class="nb">printf</span> <span class="s1">&#39;%q\n&#39;</span> <span class="se">\</span>
                <span class="s1">&#39;Unable to write log file &gt;&#39;</span><span class="si">${</span><span class="nv">SPAMMER_TRACE</span><span class="si">}</span><span class="s1">&#39;&lt;&#39;</span><span class="k">)</span>
                pend_release
                <span class="nb">exit </span>1
            <span class="k">fi</span>
            <span class="nv">_log_file</span><span class="o">=</span><span class="si">${</span><span class="nv">SPAMMER_TRACE</span><span class="si">}</span>
            <span class="nb">echo</span> <span class="s1">&#39;&#39;</span> &gt; <span class="si">${</span><span class="nv">_log_file</span><span class="si">}</span>
            <span class="nv">_pend_hook_</span><span class="o">=</span>trace_logger
            <span class="nv">_log_dump</span><span class="o">=</span>dump_log
        <span class="k">fi</span>
    <span class="k">fi</span>
    <span class="k">return</span> 0
<span class="o">}</span>

<span class="c"># User environment variable SPAMMER_DATA</span>
data_capture<span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">[</span> <span class="si">${</span><span class="nv">SPAMMER_DATA</span><span class="p">:=</span><span class="si">}</span> <span class="o">]</span>    <span class="c"># Wants a data dump?</span>
    <span class="k">then</span>
        <span class="k">if</span> <span class="o">[</span> ! -e <span class="si">${</span><span class="nv">SPAMMER_DATA</span><span class="si">}</span> <span class="o">]</span>
        <span class="k">then</span>
            <span class="k">if</span> ! touch <span class="si">${</span><span class="nv">SPAMMER_DATA</span><span class="si">}</span> 2&gt;/dev/null
            <span class="k">then</span>
                pend_func <span class="nb">echo</span> <span class="k">$(</span><span class="nb">printf</span> <span class="s1">&#39;%q]n&#39;</span> <span class="se">\</span>
                <span class="s1">&#39;Unable to create data output file &gt;&#39;</span><span class="si">${</span><span class="nv">SPAMMER_DATA</span><span class="si">}</span><span class="s1">&#39;&lt;&#39;</span><span class="k">)</span>
                pend_release
                <span class="nb">exit </span>1
            <span class="k">fi</span>
            <span class="nv">_dot_file</span><span class="o">=</span><span class="si">${</span><span class="nv">SPAMMER_DATA</span><span class="si">}</span>
            <span class="nv">_dot_dump</span><span class="o">=</span>dump_dot
        <span class="k">else</span>
            <span class="k">if</span> <span class="o">[</span> ! -w <span class="si">${</span><span class="nv">SPAMMER_DATA</span><span class="si">}</span> <span class="o">]</span>
            <span class="k">then</span>
                pend_func <span class="nb">echo</span> <span class="k">$(</span><span class="nb">printf</span> <span class="s1">&#39;%q\n&#39;</span> <span class="se">\</span>
                <span class="s1">&#39;Unable to write data output file &gt;&#39;</span><span class="si">${</span><span class="nv">SPAMMER_DATA</span><span class="si">}</span><span class="s1">&#39;&lt;&#39;</span><span class="k">)</span>
                pend_release
                <span class="nb">exit </span>1
            <span class="k">fi</span>
            <span class="nv">_dot_file</span><span class="o">=</span><span class="si">${</span><span class="nv">SPAMMER_DATA</span><span class="si">}</span>
            <span class="nv">_dot_dump</span><span class="o">=</span>dump_dot
        <span class="k">fi</span>
    <span class="k">fi</span>
    <span class="k">return</span> 0
<span class="o">}</span>

<span class="c"># Grope user specified arguments.</span>
do_user_args<span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">[</span> <span class="nv">$# </span>-gt <span class="m">0</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> is_number <span class="nv">$1</span>
    <span class="k">then</span>
        <span class="nv">indirect</span><span class="o">=</span><span class="nv">$1</span>
        <span class="nb">shift</span>
<span class="nb">    </span><span class="k">fi</span>

    <span class="k">case</span> <span class="nv">$# </span>in                     <span class="c"># Did user treat us well?</span>
        1<span class="o">)</span>
            <span class="k">if</span> ! setup_input <span class="nv">$1</span>    <span class="c"># Needs error checking.</span>
            <span class="k">then</span>
                pend_release
                <span class="nv">$_log_dump</span>
                <span class="nb">exit </span>1
            <span class="k">fi</span>
            <span class="nv">list_server</span><span class="o">=(</span> <span class="si">${</span><span class="nv">default_servers</span><span class="p">[@]</span><span class="si">}</span> <span class="o">)</span>
            <span class="nv">_list_cnt</span><span class="o">=</span><span class="si">${#</span><span class="nv">list_server</span><span class="p">[@]</span><span class="si">}</span>
            <span class="nb">echo</span> <span class="s1">&#39;Using default blacklist server list.&#39;</span>
            <span class="nb">echo</span> <span class="s1">&#39;Search depth limit: &#39;</span><span class="si">${</span><span class="nv">indirect</span><span class="si">}</span>
            <span class="p">;;</span>
        2<span class="o">)</span>
            <span class="k">if</span> ! setup_input <span class="nv">$1</span>    <span class="c"># Needs error checking.</span>
            <span class="k">then</span>
                pend_release
                <span class="nv">$_log_dump</span>
                <span class="nb">exit </span>1
            <span class="k">fi</span>
            <span class="k">if</span> ! setup_servers <span class="nv">$2</span>  <span class="c"># Needs error checking.</span>
            <span class="k">then</span>
                pend_release
                <span class="nv">$_log_dump</span>
                <span class="nb">exit </span>1
            <span class="k">fi</span>
            <span class="nb">echo</span> <span class="s1">&#39;Search depth limit: &#39;</span><span class="si">${</span><span class="nv">indirect</span><span class="si">}</span>
            <span class="p">;;</span>
        *<span class="o">)</span>
            pend_func usage
            pend_release
            <span class="nv">$_log_dump</span>
            <span class="nb">exit </span>1
            <span class="p">;;</span>
    <span class="k">esac</span>
    <span class="k">return</span> 0
<span class="o">}</span>

<span class="c"># A general purpose debug tool.</span>
<span class="c"># list_array &lt;array_name&gt;</span>
list_array<span class="o">()</span> <span class="o">{</span>
    <span class="o">[</span> <span class="nv">$# </span>-eq <span class="m">1</span> <span class="o">]</span> <span class="p">|</span><span class="k">return</span> <span class="m">1</span>  <span class="c"># One argument required.</span>

    <span class="nb">local</span> -a _la_lines
    <span class="nb">set</span> -f
    <span class="nb">local </span><span class="nv">IFS</span><span class="o">=</span><span class="si">${</span><span class="nv">NO_WSP</span><span class="si">}</span>
    <span class="nb">eval </span><span class="nv">_la_lines</span><span class="o">=</span><span class="se">\(\ \$\{</span><span class="nv">$1</span><span class="se">\[</span>@<span class="se">\]\}\ \)</span>
    <span class="nb">echo</span>
<span class="nb">    echo</span> <span class="s2">&quot;Element count &quot;</span><span class="si">${#</span><span class="nv">_la_lines</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot; array &quot;</span><span class="si">${</span><span class="nv">1</span><span class="si">}</span>
    <span class="nb">local </span><span class="nv">_ln_cnt</span><span class="o">=</span><span class="si">${#</span><span class="nv">_la_lines</span><span class="p">[@]</span><span class="si">}</span>

    <span class="k">for</span> <span class="o">((</span> <span class="nv">_i</span> <span class="o">=</span> 0<span class="p">;</span> _i &lt; <span class="si">${</span><span class="nv">_ln_cnt</span><span class="si">}</span><span class="p">;</span> _i++ <span class="o">))</span>
    <span class="k">do</span>
        <span class="nb">echo</span> <span class="s1">&#39;Element &#39;</span><span class="nv">$_i</span><span class="s1">&#39; &gt;&#39;</span><span class="si">${</span><span class="nv">_la_lines</span><span class="p">[</span><span class="nv">$_i</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;&lt;&#39;</span>
    <span class="k">done</span>
    <span class="nb">set</span> +f
    <span class="k">return</span> 0
<span class="o">}</span>

<span class="c"># # # &#39;Hunt the Spammer&#39; program code # # #</span>
pend_init                               <span class="c"># Ready stack engine.</span>
pend_func credits                       <span class="c"># Last thing to print.</span>

<span class="c"># # # Deal with user # # #</span>
live_log_die                            <span class="c"># Setup debug trace log.</span>
data_capture                            <span class="c"># Setup data capture file.</span>
<span class="nb">echo</span>
do_user_args <span class="nv">$@</span>

<span class="c"># # # Haven&#39;t exited yet - There is some hope # # #</span>
<span class="c"># Discovery group - Execution engine is LIFO - pend</span>
<span class="c"># in reverse order of execution.</span>
<span class="nv">_hs_RC</span><span class="o">=</span><span class="m">0</span>                                <span class="c"># Hunt the Spammer return code</span>
pend_mark
    pend_func report_pairs              <span class="c"># Report name-address pairs.</span>

    <span class="c"># The two detail_* are mutually recursive functions.</span>
    <span class="c"># They also pend expand_* functions as required.</span>
    <span class="c"># These two (the last of ???) exit the recursion.</span>
    pend_func detail_each_address       <span class="c"># Get all resources of addresses.</span>
    pend_func detail_each_name          <span class="c"># Get all resources of names.</span>

    <span class="c">#  The two expand_* are mutually recursive functions,</span>
    <span class="c">#+ which pend additional detail_* functions as required.</span>
    pend_func expand_input_address <span class="m">1</span>    <span class="c"># Expand input names by address.</span>
    pend_func expand_input_name <span class="m">1</span>       <span class="c"># #xpand input addresses by name.</span>

    <span class="c"># Start with a unique set of names and addresses.</span>
    pend_func unique_lines uc_address uc_address
    pend_func unique_lines uc_name uc_name

    <span class="c"># Separate mixed input of names and addresses.</span>
    pend_func split_input
pend_release

<span class="c"># # # Pairs reported -- Unique list of IP addresses found</span>
<span class="nb">echo</span>
<span class="nv">_ip_cnt</span><span class="o">=</span><span class="si">${#</span><span class="nv">known_address</span><span class="p">[@]</span><span class="si">}</span>
<span class="k">if</span> <span class="o">[</span> <span class="si">${#</span><span class="nv">list_server</span><span class="p">[@]</span><span class="si">}</span> -eq <span class="m">0</span> <span class="o">]</span>
<span class="k">then</span>
    <span class="nb">echo</span> <span class="s1">&#39;Blacklist server list empty, none checked.&#39;</span>
<span class="k">else</span>
    <span class="k">if</span> <span class="o">[</span> <span class="si">${</span><span class="nv">_ip_cnt</span><span class="si">}</span> -eq <span class="m">0</span> <span class="o">]</span>
    <span class="k">then</span>
        <span class="nb">echo</span> <span class="s1">&#39;Known address list empty, none checked.&#39;</span>
    <span class="k">else</span>
        <span class="nv">_ip_cnt</span><span class="o">=</span><span class="si">${</span><span class="nv">_ip_cnt</span><span class="si">}</span>-1   <span class="c"># Start at top.</span>
        <span class="nb">echo</span> <span class="s1">&#39;Checking Blacklist servers.&#39;</span>
        <span class="k">for</span> <span class="o">((</span> <span class="nv">_ip</span> <span class="o">=</span> _ip_cnt <span class="p">;</span> _ip &gt;<span class="o">=</span> <span class="m">0</span> <span class="p">;</span> _ip-- <span class="o">))</span>
        <span class="k">do</span>
          pend_func check_lists <span class="k">$(</span> <span class="nb">printf</span> <span class="s1">&#39;%q\n&#39;</span> <span class="si">${</span><span class="nv">known_address</span><span class="p">[</span><span class="nv">$_ip</span><span class="p">]</span><span class="si">}</span> <span class="k">)</span>
        <span class="k">done</span>
    <span class="k">fi</span>
<span class="k">fi</span>
pend_release
<span class="nv">$_dot_dump</span>                   <span class="c"># Graphics file dump</span>
<span class="nv">$_log_dump</span>                   <span class="c"># Execution trace</span>
<span class="nb">echo</span>


<span class="c">##############################</span>
<span class="c"># Example output from script #</span>
<span class="c">##############################</span>
:<span class="s">&lt;&lt;-&#39;_is_spammer_outputs_&#39;</span>

<span class="s">./is_spammer.bash 0 web4.alojamentos7.com</span>

<span class="s">Starting with domain name &gt;web4.alojamentos7.com&lt;</span>
<span class="s">Using default blacklist server list.</span>
<span class="s">Search depth limit: 0</span>
<span class="s">.:....::::...:::...:::.......::..::...:::.......::</span>
<span class="s">Known network pairs.</span>
<span class="s">    66.98.208.97             web4.alojamentos7.com.</span>
<span class="s">    66.98.208.97             ns1.alojamentos7.com.</span>
<span class="s">    69.56.202.147            ns2.alojamentos.ws.</span>
<span class="s">    66.98.208.97             alojamentos7.com.</span>
<span class="s">    66.98.208.97             web.alojamentos7.com.</span>
<span class="s">    69.56.202.146            ns1.alojamentos.ws.</span>
<span class="s">    69.56.202.146            alojamentos.ws.</span>
<span class="s">    66.235.180.113           ns1.alojamentos.org.</span>
<span class="s">    66.235.181.192           ns2.alojamentos.org.</span>
<span class="s">    66.235.180.113           alojamentos.org.</span>
<span class="s">    66.235.180.113           web6.alojamentos.org.</span>
<span class="s">    216.234.234.30           ns1.theplanet.com.</span>
<span class="s">    12.96.160.115            ns2.theplanet.com.</span>
<span class="s">    216.185.111.52           mail1.theplanet.com.</span>
<span class="s">    69.56.141.4              spooling.theplanet.com.</span>
<span class="s">    216.185.111.40           theplanet.com.</span>
<span class="s">    216.185.111.40           www.theplanet.com.</span>
<span class="s">    216.185.111.52           mail.theplanet.com.</span>

<span class="s">Checking Blacklist servers.</span>
<span class="s">  Checking address 66.98.208.97</span>
<span class="s">      Records from dnsbl.sorbs.net</span>
<span class="s">  &quot;Spam Received See: http://www.dnsbl.sorbs.net/lookup.shtml?66.98.208.97&quot;</span>
<span class="s">    Checking address 69.56.202.147</span>
<span class="s">    Checking address 69.56.202.146</span>
<span class="s">    Checking address 66.235.180.113</span>
<span class="s">    Checking address 66.235.181.192</span>
<span class="s">    Checking address 216.185.111.40</span>
<span class="s">    Checking address 216.234.234.30</span>
<span class="s">    Checking address 12.96.160.115</span>
<span class="s">    Checking address 216.185.111.52</span>
<span class="s">    Checking address 69.56.141.4</span>

<span class="s">Advanced Bash Scripting Guide: is_spammer.bash, v2, 2004-msz</span>

<span class="s">_is_spammer_outputs_</span>

<span class="nb">exit</span> <span class="si">${</span><span class="nv">_hs_RC</span><span class="si">}</span>

<span class="c">####################################################</span>
<span class="c">#  The script ignores everything from here on down #</span>
<span class="c">#+ because of the &#39;exit&#39; command, just above.      #</span>
<span class="c">####################################################</span>



<span class="nv">Quickstart</span>
<span class="o">==========</span>

 Prerequisites

  Bash version 2.05b or 3.00 <span class="o">(</span>bash --version<span class="o">)</span>
  A version of Bash which supports arrays. Array
  support is included by default Bash configurations.

  <span class="s1">&#39;dig,&#39;</span> version 9.x.x <span class="o">(</span>dig <span class="nv">$HOSTNAME</span>, see first line of output<span class="o">)</span>
  A version of dig which supports the +short options.
  See: dig_wrappers.bash <span class="k">for</span> details.


 Optional Prerequisites

  <span class="s1">&#39;named,&#39;</span> a <span class="nb">local </span>DNS caching program. Any flavor will <span class="k">do</span>.
  Do twice: dig <span class="nv">$HOSTNAME</span>
  Check near bottom of output <span class="k">for</span>: SERVER: 127.0.0.1#53
  That means you have one running.


 Optional Graphics Support

  <span class="s1">&#39;date,&#39;</span> a standard *nix thing. <span class="o">(</span>date -R<span class="o">)</span>

  dot Program to convert graphic description file to a
  diagram. <span class="o">(</span>dot -V<span class="o">)</span>
  A part of the Graph-Viz <span class="nb">set </span>of programs.
  See: <span class="o">[</span>http://www.research.att.com/sw/tools/graphviz<span class="o">||</span>GraphViz<span class="o">]</span>

  <span class="s1">&#39;dotty,&#39;</span> a visual editor <span class="k">for</span> graphic description files.
  Also a part of the Graph-Viz <span class="nb">set </span>of programs.




 Quick Start

In the same directory as the is_spammer.bash script<span class="p">;</span>
Do: ./is_spammer.bash

 Usage Details

1. Blacklist server choices.

  <span class="o">(</span>a<span class="o">)</span> To use default, built-in list: Do nothing.

  <span class="o">(</span>b<span class="o">)</span> To use your own list:

    i. Create a file with a single Blacklist server
       domain name per line.

    ii. Provide that filename as the last argument to
        the script.

  <span class="o">(</span>c<span class="o">)</span> To use a single Blacklist server: Last argument
      to the script.

  <span class="o">(</span>d<span class="o">)</span> To disable Blacklist lookups:

    i. Create an empty file <span class="o">(</span>touch spammer.nul<span class="o">)</span>
       Your choice of filename.

    ii. Provide the filename of that empty file as the
        last argument to the script.

2. Search depth limit.

  <span class="o">(</span>a<span class="o">)</span> To use the default value of 2: Do nothing.

  <span class="o">(</span>b<span class="o">)</span> To <span class="nb">set </span>a different limit:
      A limit of <span class="m">0</span> means: no limit.

    i. <span class="nb">export </span><span class="nv">SPAMMER_LIMIT</span><span class="o">=</span>1
       or whatever limit you want.

    ii. OR provide the desired limit as the first
       argument to the script.

3. Optional execution trace log.

  <span class="o">(</span>a<span class="o">)</span> To use the default setting of no log output: Do nothing.

  <span class="o">(</span>b<span class="o">)</span> To write an execution trace log:
      <span class="nb">export </span><span class="nv">SPAMMER_TRACE</span><span class="o">=</span>spammer.log
      or whatever filename you want.

4. Optional graphic description file.

  <span class="o">(</span>a<span class="o">)</span> To use the default setting of no graphic file: Do nothing.

  <span class="o">(</span>b<span class="o">)</span> To write a Graph-Viz graphic description file:
      <span class="nb">export </span><span class="nv">SPAMMER_DATA</span><span class="o">=</span>spammer.dot
      or whatever filename you want.

5. Where to start the search.

  <span class="o">(</span>a<span class="o">)</span> Starting with a single domain name:

    i. Without a <span class="nb">command</span>-line search limit: First
       argument to script.

    ii. With a <span class="nb">command</span>-line search limit: Second
        argument to script.

  <span class="o">(</span>b<span class="o">)</span> Starting with a single IP address:

    i. Without a <span class="nb">command</span>-line search limit: First
       argument to script.

    ii. With a <span class="nb">command</span>-line search limit: Second
        argument to script.

  <span class="o">(</span>c<span class="o">)</span> Starting with <span class="o">(</span>mixed<span class="o">)</span> multiple name<span class="o">(</span>s<span class="o">)</span> and/or address<span class="o">(</span>es<span class="o">)</span>:
      Create a file with one name or address per line.
      Your choice of filename.

    i. Without a <span class="nb">command</span>-line search limit: Filename as
       first argument to script.

    ii. With a <span class="nb">command</span>-line search limit: Filename as
        second argument to script.

6. What to <span class="k">do</span> with the display output.

  <span class="o">(</span>a<span class="o">)</span> To view display output on screen: Do nothing.

  <span class="o">(</span>b<span class="o">)</span> To save display output to a file: Redirect stdout to a filename.

  <span class="o">(</span>c<span class="o">)</span> To discard display output: Redirect stdout to /dev/null.

7. Temporary end of decision making.
   press RETURN
   <span class="nb">wait</span> <span class="o">(</span>optionally, watch the dots and colons<span class="o">)</span>.

8. Optionally check the <span class="k">return</span> code.

  <span class="o">(</span>a<span class="o">)</span> Return code 0: All OK

  <span class="o">(</span>b<span class="o">)</span> Return code 1: Script setup failure

  <span class="o">(</span>c<span class="o">)</span> Return code 2: Something was blacklisted.

9. Where is my graph <span class="o">(</span>diagram<span class="o">)</span>?

The script does not directly produce a graph <span class="o">(</span>diagram<span class="o">)</span>.
It only produces a graphic description file. You can
process the graphic descriptor file that was output
with the <span class="s1">&#39;dot&#39;</span> program.

Until you edit that descriptor file, to describe the
relationships you want shown, all that you will get is
a bunch of labeled name and address nodes.

All of the script<span class="s1">&#39;s discovered relationships are within</span>
<span class="s1">a comment block in the graphic descriptor file, each</span>
<span class="s1">with a descriptive heading.</span>

<span class="s1">The editing required to draw a line between a pair of</span>
<span class="s1">nodes from the information in the descriptor file may</span>
<span class="s1">be done with a text editor.</span>

<span class="s1">Given these lines somewhere in the descriptor file:</span>

<span class="s1"># Known domain name nodes</span>

<span class="s1">N0000 [label=&quot;guardproof.info.&quot;] ;</span>

<span class="s1">N0002 [label=&quot;third.guardproof.info.&quot;] ;</span>



<span class="s1"># Known address nodes</span>

<span class="s1">A0000 [label=&quot;61.141.32.197&quot;] ;</span>



<span class="s1">/*</span>

<span class="s1"># Known name-&gt;address edges</span>

<span class="s1">NA0000 third.guardproof.info. 61.141.32.197</span>



<span class="s1"># Known parent-&gt;child edges</span>

<span class="s1">PC0000 guardproof.info. third.guardproof.info.</span>

<span class="s1"> */</span>

<span class="s1">Turn that into the following lines by substituting node</span>
<span class="s1">identifiers into the relationships:</span>

<span class="s1"># Known domain name nodes</span>

<span class="s1">N0000 [label=&quot;guardproof.info.&quot;] ;</span>

<span class="s1">N0002 [label=&quot;third.guardproof.info.&quot;] ;</span>



<span class="s1"># Known address nodes</span>

<span class="s1">A0000 [label=&quot;61.141.32.197&quot;] ;</span>



<span class="s1"># PC0000 guardproof.info. third.guardproof.info.</span>

<span class="s1">N0000-&gt;N0002 ;</span>



<span class="s1"># NA0000 third.guardproof.info. 61.141.32.197</span>

<span class="s1">N0002-&gt;A0000 ;</span>



<span class="s1">/*</span>

<span class="s1"># Known name-&gt;address edges</span>

<span class="s1">NA0000 third.guardproof.info. 61.141.32.197</span>



<span class="s1"># Known parent-&gt;child edges</span>

<span class="s1">PC0000 guardproof.info. third.guardproof.info.</span>

<span class="s1"> */</span>

<span class="s1">Process that with the &#39;</span>dot<span class="s1">&#39; program, and you have your</span>
<span class="s1">first network diagram.</span>

<span class="s1">In addition to the conventional graphic edges, the</span>
<span class="s1">descriptor file includes similar format pair-data that</span>
<span class="s1">describes services, zone records (sub-graphs?),</span>
<span class="s1">blacklisted addresses, and other things which might be</span>
<span class="s1">interesting to include in your graph. This additional</span>
<span class="s1">information could be displayed as different node</span>
<span class="s1">shapes, colors, line sizes, etc.</span>

<span class="s1">The descriptor file can also be read and edited by a</span>
<span class="s1">Bash script (of course). You should be able to find</span>
<span class="s1">most of the functions required within the</span>
<span class="s1">&quot;is_spammer.bash&quot; script.</span>

<span class="s1"># End Quickstart.</span>



<span class="s1">Additional Note</span>
<span class="s1">========== ====</span>

<span class="s1">Michael Zick points out that there is a &quot;makeviz.bash&quot; interactive</span>
<span class="s1">Web site at rediris.es. Can&#39;</span>t give the full URL, since this is not
a publically accessible site.
</pre></div>
</div>
<p>Another anti-spam script.</p>
</div>
<div class="section" id="exemple-29-spammer-hunt">
<h2>Exemple 29. Spammer Hunt<a class="headerlink" href="#exemple-29-spammer-hunt" title="Link permanent a aquest títol">¶</a></h2>
<div class="highlight-sh"><div class="highlight"><pre>   #!/bin/bash
   # whx.sh: &quot;whois&quot; spammer lookup
   # Author: Walter Dnes
   # Slight revisions (first section) by ABS Guide author.
   # Used in ABS Guide with permission.

   # Needs version 3.x or greater of Bash to run (because of =~ operator).
   # Commented by script author and ABS Guide author.



   E_BADARGS=85        # Missing command-line arg.
   E_NOHOST=86         # Host not found.
   E_TIMEOUT=87        # Host lookup timed out.
   E_UNDEF=88          # Some other (undefined) error.

   HOSTWAIT=10         # Specify up to 10 seconds for host query reply.
                       # The actual wait may be a bit longer.
   OUTFILE=whois.txt   # Output file.
   PORT=4321


   if [ -z &quot;$1&quot; ]      # Check for (required) command-line arg.
   then
     echo &quot;Usage: $0 domain name or IP address&quot;
     exit $E_BADARGS
   fi


   if [[ &quot;$1&quot; =~ [a-zA-Z][a-zA-Z]$ ]]  #  Ends in two alpha chars?
   then                                  #  It&#39;s a domain name &amp;&amp;
                                         #+ must do host lookup.
     IPADDR=$(host -W $HOSTWAIT $1awk &#39;{print $4}&#39;)
                                         #  Doing host lookup
                                         #+ to get IP address.
                         #  Extract final field.
   else
     IPADDR=&quot;$1&quot;                         #  Command-line arg was IP address.
   fi

   echo; echo &quot;IP Address is: &quot;$IPADDR&quot;&quot;; echo

   if [ -e &quot;$OUTFILE&quot; ]
   then
     rm -f &quot;$OUTFILE&quot;
     echo &quot;Stale output file \&quot;$OUTFILE\&quot; removed.&quot;; echo
   fi


   #  Sanity checks.
   #  (This section needs more work.)
   #  ===============================
   if [ -z &quot;$IPADDR&quot; ]
   # No response.
   then
     echo &quot;Host not found!&quot;
     exit $E_NOHOST    # Bail out.
   fi

   if [[ &quot;$IPADDR&quot; =~ ^[;;] ]]
   #  ;; Connection timed out; no servers could be reached.
   then
     echo &quot;Host lookup timed out!&quot;
     exit $E_TIMEOUT   # Bail out.
   fi

   if [[ &quot;$IPADDR&quot; =~ [(NXDOMAIN)]$ ]]
   #  Host xxxxxxxxx.xxx not found: 3(NXDOMAIN)
   then
     echo &quot;Host not found!&quot;
     exit $E_NOHOST    # Bail out.
   fi

   if [[ &quot;$IPADDR&quot; =~ [(SERVFAIL)]$ ]]
   #  Host xxxxxxxxx.xxx not found: 2(SERVFAIL)
   then
     echo &quot;Host not found!&quot;
     exit $E_NOHOST    # Bail out.
   fi




   # ======================== Main body of script ========================

   AFRINICquery() {
   #  Define the function that queries AFRINIC. Echo a notification to the
   #+ screen, and then run the actual query, redirecting output to $OUTFILE.

     echo &quot;Searching for $IPADDR in whois.afrinic.net&quot;
     whois -h whois.afrinic.net &quot;$IPADDR&quot; &gt; $OUTFILE

   #  Check for presence of reference to an rwhois.
   #  Warn about non-functional rwhois.infosat.net server
   #+ and attempt rwhois query.
     if grep -e &quot;^remarks: .*rwhois\.[^ ]\+&quot; &quot;$OUTFILE&quot;
     then
       echo &quot; &quot; &gt;&gt; $OUTFILE
       echo &quot;***&quot; &gt;&gt; $OUTFILE
       echo &quot;***&quot; &gt;&gt; $OUTFILE
       echo &quot;Warning: rwhois.infosat.net was not working \
         as of 2005/02/02&quot; &gt;&gt; $OUTFILE
       echo &quot;         when this script was written.&quot; &gt;&gt; $OUTFILE
       echo &quot;***&quot; &gt;&gt; $OUTFILE
       echo &quot;***&quot; &gt;&gt; $OUTFILE
       echo &quot; &quot; &gt;&gt; $OUTFILE
       RWHOIS=`grep &quot;^remarks: .*rwhois\.[^ ]\+&quot; &quot;$OUTFILE&quot;tail -n 1 |\
       sed &quot;s/\(^.*\)\(rwhois\..*\)\(:4.*\)/\2/&quot;`
       whois -h ${RWHOIS}:${PORT} &quot;$IPADDR&quot; &gt;&gt; $OUTFILE
     fi
   }

   APNICquery() {
     echo &quot;Searching for $IPADDR in whois.apnic.net&quot;
     whois -h whois.apnic.net &quot;$IPADDR&quot; &gt; $OUTFILE

   #  Just  about  every  country has its own internet registrar.
   #  I don&#39;t normally bother consulting them, because the regional registry
   #+ usually supplies sufficient information.
   #  There are a few exceptions, where the regional registry simply
   #+ refers to the national registry for direct data.
   #  These are Japan and South Korea in APNIC, and Brasil in LACNIC.
   #  The following if statement checks $OUTFILE (whois.txt) for the presence
   #+ of &quot;KR&quot; (South Korea) or &quot;JP&quot; (Japan) in the country field.
   #  If either is found, the query is re-run against the appropriate
   #+ national registry.

     if grep -E &quot;^country:[ ]+KR$&quot; &quot;$OUTFILE&quot;
     then
       echo &quot;Searching for $IPADDR in whois.krnic.net&quot;
       whois -h whois.krnic.net &quot;$IPADDR&quot; &gt;&gt; $OUTFILE
     elif grep -E &quot;^country:[ ]+JP$&quot; &quot;$OUTFILE&quot;
     then
       echo &quot;Searching for $IPADDR in whois.nic.ad.jp&quot;
       whois -h whois.nic.ad.jp &quot;$IPADDR&quot;/e &gt;&gt; $OUTFILE
     fi
   }

   ARINquery() {
     echo &quot;Searching for $IPADDR in whois.arin.net&quot;
     whois -h whois.arin.net &quot;$IPADDR&quot; &gt; $OUTFILE

   #  Several large internet providers listed by ARIN have their own
   #+ internal whois service, referred to as &quot;rwhois&quot;.
   #  A large block of IP addresses is listed with the provider
   #+ under the ARIN registry.
   #  To get the IP addresses of 2nd-level ISPs or other large customers,
   #+ one has to refer to the rwhois server on port 4321.
   #  I originally started with a bunch of &quot;if&quot; statements checking for
   #+ the larger providers.
   #  This approach is unwieldy, and there&#39;s always another rwhois server
   #+ that I didn&#39;t know about.
   #  A more elegant approach is to check $OUTFILE for a reference
   #+ to a whois server, parse that server name out of the comment section,
   #+ and re-run the query against the appropriate rwhois server.
   #  The parsing looks a bit ugly, with a long continued line inside
   #+ backticks.
   #  But it only has to be done once, and will work as new servers are added.
   #@   ABS Guide author comment: it isn&#39;t all that ugly, and is, in fact,
   #@+  an instructive use of Regular Expressions.

     if grep -E &quot;^Comment: .*rwhois.[^ ]+&quot; &quot;$OUTFILE&quot;
     then
       RWHOIS=`grep -e &quot;^Comment:.*rwhois\.[^ ]\+&quot; &quot;$OUTFILE&quot;tail -n 1 |\
       sed &quot;s/^\(.*\)\(rwhois\.[^ ]\+\)\(.*$\)/\2/&quot;`
       echo &quot;Searching for $IPADDR in ${RWHOIS}&quot;
       whois -h ${RWHOIS}:${PORT} &quot;$IPADDR&quot; &gt;&gt; $OUTFILE
     fi
   }

   LACNICquery() {
     echo &quot;Searching for $IPADDR in whois.lacnic.net&quot;
     whois -h whois.lacnic.net &quot;$IPADDR&quot; &gt; $OUTFILE

   #  The  following if statement checks $OUTFILE (whois.txt) for
   #+ the presence of &quot;BR&quot; (Brasil) in the country field.
   #  If it is found, the query is re-run against whois.registro.br.

     if grep -E &quot;^country:[ ]+BR$&quot; &quot;$OUTFILE&quot;
     then
       echo &quot;Searching for $IPADDR in whois.registro.br&quot;
       whois -h whois.registro.br &quot;$IPADDR&quot; &gt;&gt; $OUTFILE
     fi
   }

   RIPEquery() {
     echo &quot;Searching for $IPADDR in whois.ripe.net&quot;
     whois -h whois.ripe.net &quot;$IPADDR&quot; &gt; $OUTFILE
   }

   #  Initialize a few variables.
   #  * slash8 is the most significant octet
   #  * slash16 consists of the two most significant octets
   #  * octet2 is the second most significant octet




   slash8=`echo $IPADDRcut -d. -f 1`
     if [ -z &quot;$slash8&quot; ]  # Yet another sanity check.
     then
       echo &quot;Undefined error!&quot;
       exit $E_UNDEF
     fi
   slash16=`echo $IPADDRcut -d. -f 1-2`
   #                             ^ Period specified as &#39;cut&quot; delimiter.
     if [ -z &quot;$slash16&quot; ]
     then
       echo &quot;Undefined error!&quot;
       exit $E_UNDEF
     fi
   octet2=`echo $slash16cut -d. -f 2`
     if [ -z &quot;$octet2&quot; ]
     then
       echo &quot;Undefined error!&quot;
       exit $E_UNDEF
     fi


   #  Check for various odds and ends of reserved space.
   #  There is no point in querying for those addresses.

   if [ $slash8 == 0 ]; then
     echo $IPADDR is &#39;&quot;This Network&quot;&#39; space\; Not querying
   elif [ $slash8 == 10 ]; then
     echo $IPADDR is RFC1918 space\; Not querying
   elif [ $slash8 == 14 ]; then
     echo $IPADDR is &#39;&quot;Public Data Network&quot;&#39; space\; Not querying
   elif [ $slash8 == 127 ]; then
     echo $IPADDR is loopback space\; Not querying
   elif [ $slash16 == 169.254 ]; then
     echo $IPADDR is link-local space\; Not querying
   elif [ $slash8 == 172 ] &amp;&amp; [ $octet2 -ge 16 ] &amp;&amp; [ $octet2 -le 31 ];then
     echo $IPADDR is RFC1918 space\; Not querying
   elif [ $slash16 == 192.168 ]; then
     echo $IPADDR is RFC1918 space\; Not querying
   elif [ $slash8 -ge 224 ]; then
     echo $IPADDR is either Multicast or reserved space\; Not querying
   elif [ $slash8 -ge 200 ] &amp;&amp; [ $slash8 -le 201 ]; then LACNICquery &quot;$IPADDR&quot;
   elif [ $slash8 -ge 202 ] &amp;&amp; [ $slash8 -le 203 ]; then APNICquery &quot;$IPADDR&quot;
   elif [ $slash8 -ge 210 ] &amp;&amp; [ $slash8 -le 211 ]; then APNICquery &quot;$IPADDR&quot;
   elif [ $slash8 -ge 218 ] &amp;&amp; [ $slash8 -le 223 ]; then APNICquery &quot;$IPADDR&quot;

   #  If we got this far without making a decision, query ARIN.
   #  If a reference is found in $OUTFILE to APNIC, AFRINIC, LACNIC, or RIPE,
   #+ query the appropriate whois server.

   else
     ARINquery &quot;$IPADDR&quot;
     if grep &quot;whois.afrinic.net&quot; &quot;$OUTFILE&quot;; then
       AFRINICquery &quot;$IPADDR&quot;
     elif grep -E &quot;^OrgID:[ ]+RIPE$&quot; &quot;$OUTFILE&quot;; then
       RIPEquery &quot;$IPADDR&quot;
     elif grep -E &quot;^OrgID:[ ]+APNIC$&quot; &quot;$OUTFILE&quot;; then
       APNICquery &quot;$IPADDR&quot;
     elif grep -E &quot;^OrgID:[ ]+LACNIC$&quot; &quot;$OUTFILE&quot;; then
       LACNICquery &quot;$IPADDR&quot;
     fi
   fi

   #@  ---------------------------------------------------------------
   #   Try also:
   #   wget http://logi.cc/nw/whois.php3?ACTION=doQuery&amp;DOMAIN=$IPADDR
   #@  ---------------------------------------------------------------

   #  We&#39;ve  now  finished  the querying.
   #  Echo a copy of the final result to the screen.

   cat $OUTFILE
   # Or &quot;less $OUTFILE&quot; . . .


   exit 0

   #@  ABS Guide author comments:
   #@  Nothing fancy here, but still a very useful tool for hunting spammers.
   #@  Sure, the script can be cleaned up some, and it&#39;s still a bit buggy,
   #@+ (exercise for reader), but all the same, it&#39;s a nice piece of coding
   #@+ by Walter Dnes.
   #@  Thank you!




&quot;Little Monster&#39;s&quot; front end to `wget &lt;communications.html#WGETREF&gt;`__
</pre></div>
</div>
<p>.</p>
</div>
<div class="section" id="exemple-30-making-wget-easier-to-use">
<h2>Exemple 30. Making <em>wget</em> easier to use<a class="headerlink" href="#exemple-30-making-wget-easier-to-use" title="Link permanent a aquest títol">¶</a></h2>
<div class="highlight-sh"><div class="highlight"><pre><span class="c">#!/bin/bash</span>
<span class="c"># wgetter2.bash</span>

<span class="c"># Author: Little Monster [monster@monstruum.co.uk]</span>
<span class="c"># ==&gt; Used in ABS Guide with permission of script author.</span>
<span class="c"># ==&gt; This script still needs debugging and fixups (exercise for reader).</span>
<span class="c"># ==&gt; It could also use some additional editing in the comments.</span>


<span class="c">#  This is wgetter2 --</span>
<span class="c">#+ a Bash script to make wget a bit more friendly, and save typing.</span>

<span class="c">#  Carefully crafted by Little Monster.</span>
<span class="c">#  More or less complete on 02/02/2005.</span>
<span class="c">#  If you think this script can be improved,</span>
<span class="c">#+ email me at: monster@monstruum.co.uk</span>
<span class="c"># ==&gt; and cc: to the author of the ABS Guide, please.</span>
<span class="c">#  This script is licenced under the GPL.</span>
<span class="c">#  You are free to copy, alter and re-use it,</span>
<span class="c">#+ but please don&#39;t try to claim you wrote it.</span>
<span class="c">#  Log your changes here instead.</span>

<span class="c"># =======================================================================</span>
<span class="c"># changelog:</span>

<span class="c"># 07/02/2005.  Fixups by Little Monster.</span>
<span class="c"># 02/02/2005.  Minor additions by Little Monster.</span>
<span class="c">#              (See after # +++++++++++ )</span>
<span class="c"># 29/01/2005.  Minor stylistic edits and cleanups by author of ABS Guide.</span>
<span class="c">#              Added exit error codes.</span>
<span class="c"># 22/11/2004.  Finished initial version of second version of wgetter:</span>
<span class="c">#              wgetter2 is born.</span>
<span class="c"># 01/12/2004.  Changed &#39;runn&#39; function so it can be run 2 ways --</span>
<span class="c">#              either ask for a file name or have one input on the CL.</span>
<span class="c"># 01/12/2004.  Made sensible handling of no URL&#39;s given.</span>
<span class="c"># 01/12/2004.  Made loop of main options, so you don&#39;t</span>
<span class="c">#              have to keep calling wgetter 2 all the time.</span>
<span class="c">#              Runs as a session instead.</span>
<span class="c"># 01/12/2004.  Added looping to &#39;runn&#39; function.</span>
<span class="c">#              Simplified and improved.</span>
<span class="c"># 01/12/2004.  Added state to recursion setting.</span>
<span class="c">#              Enables re-use of previous value.</span>
<span class="c"># 05/12/2004.  Modified the file detection routine in the &#39;runn&#39; function</span>
<span class="c">#              so it&#39;s not fooled by empty values, and is cleaner.</span>
<span class="c"># 01/02/2004.  Added cookie finding routine from later version (which</span>
<span class="c">#              isn&#39;t ready yet), so as not to have hard-coded paths.</span>
<span class="c"># =======================================================================</span>

<span class="c"># Error codes for abnormal exit.</span>
<span class="nv">E_USAGE</span><span class="o">=</span><span class="m">67</span>        <span class="c"># Usage message, then quit.</span>
<span class="nv">E_NO_OPTS</span><span class="o">=</span><span class="m">68</span>      <span class="c"># No command-line args entered.</span>
<span class="nv">E_NO_URLS</span><span class="o">=</span><span class="m">69</span>      <span class="c"># No URLs passed to script.</span>
<span class="nv">E_NO_SAVEFILE</span><span class="o">=</span><span class="m">70</span>  <span class="c"># No save filename passed to script.</span>
<span class="nv">E_USER_EXIT</span><span class="o">=</span><span class="m">71</span>    <span class="c"># User decides to quit.</span>


<span class="c">#  Basic default wget command we want to use.</span>
<span class="c">#  This is the place to change it, if required.</span>
<span class="c">#  NB: if using a proxy, set http_proxy = yourproxy in .wgetrc.</span>
<span class="c">#  Otherwise delete --proxy=on, below.</span>
<span class="c"># ====================================================================</span>
<span class="nv">CommandA</span><span class="o">=</span><span class="s2">&quot;wget -nc -c -t 5 --progress=bar --random-wait --proxy=on -r&quot;</span>
<span class="c"># ====================================================================</span>



<span class="c"># --------------------------------------------------------------------</span>
<span class="c"># Set some other variables and explain them.</span>

<span class="nv">pattern</span><span class="o">=</span><span class="s2">&quot; -A .jpg,.JPG,.jpeg,.JPEG,.gif,.GIF,.htm,.html,.shtml,.php&quot;</span>
                    <span class="c"># wget&#39;s option to only get certain types of file.</span>
                    <span class="c"># comment out if not using</span>
<span class="nv">today</span><span class="o">=</span><span class="sb">`</span>date +%F<span class="sb">`</span>    <span class="c"># Used for a filename.</span>
<span class="nv">home</span><span class="o">=</span><span class="nv">$HOME</span>          <span class="c"># Set HOME to an internal variable.</span>
                    <span class="c"># In case some other path is used, change it here.</span>
<span class="nv">depthDefault</span><span class="o">=</span><span class="m">3</span>      <span class="c"># Set a sensible default recursion.</span>
<span class="nv">Depth</span><span class="o">=</span><span class="nv">$depthDefault</span> <span class="c"># Otherwise user feedback doesn&#39;t tie in properly.</span>
<span class="nv">RefA</span><span class="o">=</span><span class="s2">&quot;&quot;</span>             <span class="c"># Set blank referring page.</span>
<span class="nv">Flag</span><span class="o">=</span><span class="s2">&quot;&quot;</span>             <span class="c">#  Default to not saving anything,</span>
                    <span class="c">#+ or whatever else might be wanted in future.</span>
<span class="nv">lister</span><span class="o">=</span><span class="s2">&quot;&quot;</span>           <span class="c"># Used for passing a list of urls directly to wget.</span>
<span class="nv">Woptions</span><span class="o">=</span><span class="s2">&quot;&quot;</span>         <span class="c"># Used for passing wget some options for itself.</span>
<span class="nv">inFile</span><span class="o">=</span><span class="s2">&quot;&quot;</span>           <span class="c"># Used for the run function.</span>
<span class="nv">newFile</span><span class="o">=</span><span class="s2">&quot;&quot;</span>          <span class="c"># Used for the run function.</span>
<span class="nv">savePath</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$home</span><span class="s2">/w-save&quot;</span>
<span class="nv">Config</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$home</span><span class="s2">/.wgetter2rc&quot;</span>
                    <span class="c">#  This is where some variables can be stored,</span>
                    <span class="c">#+ if permanently changed from within the script.</span>
<span class="nv">Cookie_List</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$home</span><span class="s2">/.cookielist&quot;</span>
                    <span class="c"># So we know where the cookies are kept . . .</span>
<span class="nv">cFlag</span><span class="o">=</span><span class="s2">&quot;&quot;</span>            <span class="c"># Part of the cookie file selection routine.</span>

<span class="c"># Define the options available. Easy to change letters here if needed.</span>
<span class="c"># These are the optional options; you don&#39;t just wait to be asked.</span>

<span class="nv">save</span><span class="o">=</span>s   <span class="c"># Save command instead of executing it.</span>
<span class="nv">cook</span><span class="o">=</span>c   <span class="c"># Change cookie file for this session.</span>
<span class="nb">help</span><span class="o">=</span>h   <span class="c"># Usage guide.</span>
<span class="nv">list</span><span class="o">=</span>l   <span class="c"># Pass wget the -i option and URL list.</span>
<span class="nv">runn</span><span class="o">=</span>r   <span class="c"># Run saved commands as an argument to the option.</span>
<span class="nv">inpu</span><span class="o">=</span>i   <span class="c"># Run saved commands interactively.</span>
<span class="nv">wopt</span><span class="o">=</span>w   <span class="c"># Allow to enter options to pass directly to wget.</span>
<span class="c"># --------------------------------------------------------------------</span>


<span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>   <span class="c"># Make sure we get something for wget to eat.</span>
   <span class="nb">echo</span> <span class="s2">&quot;You must at least enter a URL or option!&quot;</span>
   <span class="nb">echo</span> <span class="s2">&quot;-</span><span class="nv">$help</span><span class="s2"> for usage.&quot;</span>
   <span class="nb">exit</span> <span class="nv">$E_NO_OPTS</span>
<span class="k">fi</span>



<span class="c"># +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span>
<span class="c"># added added added added added added added added added added added added</span>

<span class="k">if</span> <span class="o">[</span> ! -e <span class="s2">&quot;</span><span class="nv">$Config</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>   <span class="c"># See if configuration file exists.</span>
   <span class="nb">echo</span> <span class="s2">&quot;Creating configuration file, </span><span class="nv">$Config</span><span class="s2">&quot;</span>
   <span class="nb">echo</span> <span class="s2">&quot;# This is the configuration file for wgetter2&quot;</span> &gt; <span class="s2">&quot;</span><span class="nv">$Config</span><span class="s2">&quot;</span>
   <span class="nb">echo</span> <span class="s2">&quot;# Your customised settings will be saved in this file&quot;</span> &gt;&gt; <span class="s2">&quot;</span><span class="nv">$Config</span><span class="s2">&quot;</span>
<span class="k">else</span>
   <span class="nb">source</span> <span class="nv">$Config</span>             <span class="c"># Import variables we set outside the script.</span>
<span class="k">fi</span>

<span class="k">if</span> <span class="o">[</span> ! -e <span class="s2">&quot;</span><span class="nv">$Cookie_List</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
   <span class="c"># Set up a list of cookie files, if there isn&#39;t one.</span>
   <span class="nb">echo</span> <span class="s2">&quot;Hunting for cookies . . .&quot;</span>
   find -name cookies.txt &gt;&gt; <span class="nv">$Cookie_List</span> <span class="c"># Create the list of cookie files.</span>
<span class="k">fi</span> <span class="c">#  Isolate this in its own &#39;if&#39; statement,</span>
   <span class="c">#+ in case we got interrupted while searching.</span>

<span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$cFlag</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span> <span class="c"># If we haven&#39;t already done this . . .</span>
   <span class="nb">echo</span>                  <span class="c"># Make a nice space after the command prompt.</span>
   <span class="nb">echo</span> <span class="s2">&quot;Looks like you haven&#39;t set up your source of cookies yet.&quot;</span>
   <span class="nv">n</span><span class="o">=</span><span class="m">0</span>                   <span class="c">#  Make sure the counter</span>
                         <span class="c">#+ doesn&#39;t contain random values.</span>
   <span class="k">while</span> <span class="nb">read</span><span class="p">;</span> <span class="k">do</span>
      Cookies<span class="o">[</span><span class="nv">$n</span><span class="o">]=</span><span class="nv">$REPLY</span> <span class="c"># Put the cookie files we found into an array.</span>
      <span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$n</span><span class="s2">) </span><span class="si">${</span><span class="nv">Cookies</span><span class="p">[</span><span class="nv">$n</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>  <span class="c"># Create a menu.</span>
      <span class="nv">n</span><span class="o">=</span><span class="k">$((</span> n <span class="o">+</span> <span class="m">1</span> <span class="k">))</span>     <span class="c"># Increment the counter.</span>
   <span class="k">done</span> &lt; <span class="nv">$Cookie_List</span>   <span class="c"># Feed the read statement.</span>
   <span class="nb">echo</span> <span class="s2">&quot;Enter the number of the cookie file you want to use.&quot;</span>
   <span class="nb">echo</span> <span class="s2">&quot;If you won&#39;t be using cookies, just press RETURN.&quot;</span>
   <span class="nb">echo</span>
<span class="nb">   echo</span> <span class="s2">&quot;I won&#39;t be asking this again. Edit </span><span class="nv">$Config</span><span class="s2">&quot;</span>
   <span class="nb">echo</span> <span class="s2">&quot;If you decide to change at a later date&quot;</span>
   <span class="nb">echo</span> <span class="s2">&quot;or use the -</span><span class="si">${</span><span class="nv">cook</span><span class="si">}</span><span class="s2"> option for per session changes.&quot;</span>
   <span class="nb">read</span>
<span class="nb">   </span><span class="k">if</span> <span class="o">[</span> ! -z <span class="nv">$REPLY</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>   <span class="c"># User didn&#39;t just press return.</span>
      <span class="nv">Cookie</span><span class="o">=</span><span class="s2">&quot; --load-cookies </span><span class="si">${</span><span class="nv">Cookies</span><span class="p">[</span><span class="nv">$REPLY</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
      <span class="c"># Set the variable here as well as in the config file.</span>

      <span class="nb">echo</span> <span class="s2">&quot;Cookie=\&quot; --load-cookies </span><span class="si">${</span><span class="nv">Cookies</span><span class="p">[</span><span class="nv">$REPLY</span><span class="p">]</span><span class="si">}</span><span class="s2">\&quot;&quot;</span> &gt;&gt; <span class="nv">$Config</span>
   <span class="k">fi</span>
   <span class="nb">echo</span> <span class="s2">&quot;cFlag=1&quot;</span> &gt;&gt; <span class="nv">$Config</span>  <span class="c"># So we know not to ask again.</span>
<span class="k">fi</span>

<span class="c"># end added section end added section end added section end added section</span>
<span class="c"># +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span>



<span class="c"># Another variable.</span>
<span class="c"># This one may or may not be subject to variation.</span>
<span class="c"># A bit like the small print.</span>
<span class="nv">CookiesON</span><span class="o">=</span><span class="nv">$Cookie</span>
<span class="c"># echo &quot;cookie file is $CookiesON&quot; # For debugging.</span>
<span class="c"># echo &quot;home is ${home}&quot;           # For debugging.</span>
                                   <span class="c"># Got caught with this one!</span>


wopts<span class="o">()</span>
<span class="o">{</span>
<span class="nb">echo</span> <span class="s2">&quot;Enter options to pass to wget.&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;It is assumed you know what you&#39;re doing.&quot;</span>
<span class="nb">echo</span>
<span class="nb">echo</span> <span class="s2">&quot;You can pass their arguments here too.&quot;</span>
<span class="c"># That is to say, everything passed here is passed to wget.</span>

<span class="nb">read </span>Wopts
<span class="c"># Read in the options to be passed to wget.</span>

<span class="nv">Woptions</span><span class="o">=</span><span class="s2">&quot; </span><span class="nv">$Wopts</span><span class="s2">&quot;</span>
<span class="c">#         ^  Why the leading space?</span>
<span class="c"># Assign to another variable.</span>
<span class="c"># Just for fun, or something . . .</span>

<span class="nb">echo</span> <span class="s2">&quot;passing options </span><span class="si">${</span><span class="nv">Wopts</span><span class="si">}</span><span class="s2"> to wget&quot;</span>
<span class="c"># Mainly for debugging.</span>
<span class="c"># Is cute.</span>

<span class="k">return</span>
<span class="o">}</span>


save_func<span class="o">()</span>
<span class="o">{</span>
<span class="nb">echo</span> <span class="s2">&quot;Settings will be saved.&quot;</span>
<span class="k">if</span> <span class="o">[</span> ! -d <span class="nv">$savePath</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>  <span class="c">#  See if directory exists.</span>
   mkdir <span class="nv">$savePath</span>           <span class="c">#  Create the directory to save things in</span>
                             <span class="c">#+ if it isn&#39;t already there.</span>
<span class="k">fi</span>

<span class="nv">Flag</span><span class="o">=</span>S
<span class="c"># Tell the final bit of code what to do.</span>
<span class="c"># Set a flag since stuff is done in main.</span>

<span class="k">return</span>
<span class="o">}</span>


usage<span class="o">()</span> <span class="c"># Tell them how it works.</span>
<span class="o">{</span>
    <span class="nb">echo</span> <span class="s2">&quot;Welcome to wgetter.  This is a front end to wget.&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;It will always run wget with these options:&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$CommandA</span><span class="s2">&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;and the pattern to match: </span><span class="nv">$pattern</span><span class="s2"> \</span>
<span class="s2">(which you can change at the top of this script).&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;It will also ask you for recursion depth, \</span>
<span class="s2">and if you want to use a referring page.&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;Wgetter accepts the following options:&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;-</span><span class="nv">$help</span><span class="s2"> : Display this help.&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;-</span><span class="nv">$save</span><span class="s2"> : Save the command to a file </span><span class="nv">$savePath</span><span class="s2">/wget-(</span><span class="nv">$today</span><span class="s2">) \</span>
<span class="s2">instead of running it.&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;-</span><span class="nv">$runn</span><span class="s2"> : Run saved wget commands instead of starting a new one -&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;Enter filename as argument to this option.&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;-</span><span class="nv">$inpu</span><span class="s2"> : Run saved wget commands interactively --&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;The script will ask you for the filename.&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;-</span><span class="nv">$cook</span><span class="s2"> : Change the cookies file for this session.&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;-</span><span class="nv">$list</span><span class="s2"> : Tell wget to use URL&#39;s from a list instead of \</span>
<span class="s2">from the command-line.&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;-</span><span class="nv">$wopt</span><span class="s2"> : Pass any other options direct to wget.&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;See the wget man page for additional options \</span>
<span class="s2">you can pass to wget.&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;&quot;</span>

    <span class="nb">exit</span> <span class="nv">$E_USAGE</span>  <span class="c"># End here. Don&#39;t process anything else.</span>
<span class="o">}</span>



list_func<span class="o">()</span> <span class="c">#  Gives the user the option to use the -i option to wget,</span>
            <span class="c">#+ and a list of URLs.</span>
<span class="o">{</span>
<span class="k">while</span> <span class="o">[</span> <span class="m">1</span> <span class="o">]</span><span class="p">;</span> <span class="k">do</span>
   <span class="nb">echo</span> <span class="s2">&quot;Enter the name of the file containing URL&#39;s (press q to change</span>
<span class="s2">your mind).&quot;</span>
   <span class="nb">read </span>urlfile
   <span class="k">if</span> <span class="o">[</span> ! -e <span class="s2">&quot;</span><span class="nv">$urlfile</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$urlfile</span><span class="s2">&quot;</span> !<span class="o">=</span> q <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
       <span class="c"># Look for a file, or the quit option.</span>
       <span class="nb">echo</span> <span class="s2">&quot;That file does not exist!&quot;</span>
   <span class="k">elif</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$urlfile</span><span class="s2">&quot;</span> <span class="o">=</span> q <span class="o">]</span><span class="p">;</span> <span class="k">then</span> <span class="c"># Check quit option.</span>
       <span class="nb">echo</span> <span class="s2">&quot;Not using a url list.&quot;</span>
       <span class="k">return</span>
   <span class="k">else</span>
      <span class="nb">echo</span> <span class="s2">&quot;using </span><span class="nv">$urlfile</span><span class="s2">.&quot;</span>
      <span class="nb">echo</span> <span class="s2">&quot;If you gave url&#39;s on the command-line, I&#39;ll use those first.&quot;</span>
                            <span class="c"># Report wget standard behaviour to the user.</span>
      <span class="nv">lister</span><span class="o">=</span><span class="s2">&quot; -i </span><span class="nv">$urlfile</span><span class="s2">&quot;</span> <span class="c"># This is what we want to pass to wget.</span>
      <span class="k">return</span>
   <span class="k">fi</span>
<span class="k">done</span>
<span class="o">}</span>


cookie_func<span class="o">()</span> <span class="c"># Give the user the option to use a different cookie file.</span>
<span class="o">{</span>
<span class="k">while</span> <span class="o">[</span> <span class="m">1</span> <span class="o">]</span><span class="p">;</span> <span class="k">do</span>
   <span class="nb">echo</span> <span class="s2">&quot;Change the cookies file. Press return if you don&#39;t want to change</span>
<span class="s2">it.&quot;</span>
   <span class="nb">read </span>Cookies
   <span class="c"># NB: this is not the same as Cookie, earlier.</span>
   <span class="c"># There is an &#39;s&#39; on the end.</span>
   <span class="c"># Bit like chocolate chips.</span>
   <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$Cookies</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>                 <span class="c"># Escape clause for wusses.</span>
      <span class="k">return</span>
   <span class="k">elif</span> <span class="o">[</span> ! -e <span class="s2">&quot;</span><span class="nv">$Cookies</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
      <span class="nb">echo</span> <span class="s2">&quot;File does not exist.  Try again.&quot;</span> <span class="c"># Keep em going . . .</span>
   <span class="k">else</span>
       <span class="nv">CookiesON</span><span class="o">=</span><span class="s2">&quot; --load-cookies </span><span class="nv">$Cookies</span><span class="s2">&quot;</span>   <span class="c"># File is good -- use it!</span>
       <span class="k">return</span>
   <span class="k">fi</span>
<span class="k">done</span>
<span class="o">}</span>



run_func<span class="o">()</span>
<span class="o">{</span>
<span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$OPTARG</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
<span class="c"># Test to see if we used the in-line option or the query one.</span>
   <span class="k">if</span> <span class="o">[</span> ! -d <span class="s2">&quot;</span><span class="nv">$savePath</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>      <span class="c"># If directory doesn&#39;t exist . . .</span>
      <span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$savePath</span><span class="s2"> does not appear to exist.&quot;</span>
      <span class="nb">echo</span> <span class="s2">&quot;Please supply path and filename of saved wget commands:&quot;</span>
      <span class="nb">read </span>newFile
         <span class="k">until</span> <span class="o">[</span> -f <span class="s2">&quot;</span><span class="nv">$newFile</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">do</span>  <span class="c"># Keep going till we get something.</span>
            <span class="nb">echo</span> <span class="s2">&quot;Sorry, that file does not exist.  Please try again.&quot;</span>
            <span class="c"># Try really hard to get something.</span>
            <span class="nb">read </span>newFile
         <span class="k">done</span>


<span class="c"># -----------------------------------------------------------------------</span>
<span class="c">#       if [ -z ( grep wget ${newfile} ) ]; then</span>
        <span class="c"># Assume they haven&#39;t got the right file and bail out.</span>
<span class="c">#       echo &quot;Sorry, that file does not contain wget commands.  Aborting.&quot;</span>
<span class="c">#       exit</span>
<span class="c">#       fi</span>
<span class="c">#</span>
<span class="c"># This is bogus code.</span>
<span class="c"># It doesn&#39;t actually work.</span>
<span class="c"># If anyone wants to fix it, feel free!</span>
<span class="c"># -----------------------------------------------------------------------</span>


      <span class="nv">filePath</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">newFile</span><span class="si">}</span><span class="s2">&quot;</span>
   <span class="k">else</span>
   <span class="nb">echo</span> <span class="s2">&quot;Save path is </span><span class="nv">$savePath</span><span class="s2">&quot;</span>
     <span class="nb">echo</span> <span class="s2">&quot;Please enter name of the file which you want to use.&quot;</span>
     <span class="nb">echo</span> <span class="s2">&quot;You have a choice of:&quot;</span>
     ls <span class="nv">$savePath</span>                                    <span class="c"># Give them a choice.</span>
     <span class="nb">read </span>inFile
       <span class="k">until</span> <span class="o">[</span> -f <span class="s2">&quot;</span><span class="nv">$savePath</span><span class="s2">/</span><span class="nv">$inFile</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">do</span>         <span class="c">#  Keep going till</span>
                                                    <span class="c">#+ we get something.</span>
          <span class="k">if</span> <span class="o">[</span> ! -f <span class="s2">&quot;</span><span class="si">${</span><span class="nv">savePath</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">inFile</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span> <span class="c"># If file doesn&#39;t exist.</span>
             <span class="nb">echo</span> <span class="s2">&quot;Sorry, that file does not exist.  Please choose from:&quot;</span>
             ls <span class="nv">$savePath</span>                           <span class="c"># If a mistake is made.</span>
             <span class="nb">read </span>inFile
          <span class="k">fi</span>
         <span class="k">done</span>
      <span class="nv">filePath</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">savePath</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">inFile</span><span class="si">}</span><span class="s2">&quot;</span>  <span class="c"># Make one variable . . .</span>
   <span class="k">fi</span>
<span class="k">else</span> <span class="nv">filePath</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">savePath</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">OPTARG</span><span class="si">}</span><span class="s2">&quot;</span>   <span class="c"># Which can be many things . . .</span>
<span class="k">fi</span>

<span class="k">if</span> <span class="o">[</span> ! -f <span class="s2">&quot;</span><span class="nv">$filePath</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>           <span class="c"># If a bogus file got through.</span>
   <span class="nb">echo</span> <span class="s2">&quot;You did not specify a suitable file.&quot;</span>
   <span class="nb">echo</span> <span class="s2">&quot;Run this script with the -</span><span class="si">${</span><span class="nv">save</span><span class="si">}</span><span class="s2"> option first.&quot;</span>
   <span class="nb">echo</span> <span class="s2">&quot;Aborting.&quot;</span>
   <span class="nb">exit</span> <span class="nv">$E_NO_SAVEFILE</span>
<span class="k">fi</span>
<span class="nb">echo</span> <span class="s2">&quot;Using: </span><span class="nv">$filePath</span><span class="s2">&quot;</span>
<span class="k">while</span> <span class="nb">read</span><span class="p">;</span> <span class="k">do</span>
    <span class="nb">eval</span> <span class="nv">$REPLY</span>
    <span class="nb">echo</span> <span class="s2">&quot;Completed: </span><span class="nv">$REPLY</span><span class="s2">&quot;</span>
<span class="k">done</span> &lt; <span class="nv">$filePath</span>  <span class="c"># Feed the actual file we are using into a &#39;while&#39; loop.</span>

<span class="nb">exit</span>
<span class="o">}</span>



<span class="c"># Fish out any options we are using for the script.</span>
<span class="c"># This is based on the demo in &quot;Learning The Bash Shell&quot; (O&#39;Reilly).</span>
<span class="k">while</span> <span class="nb">getopts</span> <span class="s2">&quot;:</span><span class="nv">$save$cook$help$list$runn</span><span class="s2">:</span><span class="nv">$inpu$wopt</span><span class="s2">&quot;</span> opt
<span class="k">do</span>
  <span class="k">case</span> <span class="nv">$opt</span> in
     <span class="nv">$save</span><span class="o">)</span> save_func<span class="p">;;</span>   <span class="c">#  Save some wgetter sessions for later.</span>
     <span class="nv">$cook</span><span class="o">)</span> cookie_func<span class="p">;;</span> <span class="c">#  Change cookie file.</span>
     <span class="nv">$help</span><span class="o">)</span> usage<span class="p">;;</span>       <span class="c">#  Get help.</span>
     <span class="nv">$list</span><span class="o">)</span> list_func<span class="p">;;</span>   <span class="c">#  Allow wget to use a list of URLs.</span>
     <span class="nv">$runn</span><span class="o">)</span> run_func<span class="p">;;</span>    <span class="c">#  Useful if you are calling wgetter from,</span>
                          <span class="c">#+ for example, a cron script.</span>
     <span class="nv">$inpu</span><span class="o">)</span> run_func<span class="p">;;</span>    <span class="c">#  When you don&#39;t know what your files are named.</span>
     <span class="nv">$wopt</span><span class="o">)</span> wopts<span class="p">;;</span>       <span class="c">#  Pass options directly to wget.</span>
        <span class="se">\?</span><span class="o">)</span> <span class="nb">echo</span> <span class="s2">&quot;Not a valid option.&quot;</span>
            <span class="nb">echo</span> <span class="s2">&quot;Use -</span><span class="si">${</span><span class="nv">wopt</span><span class="si">}</span><span class="s2"> to pass options directly to wget,&quot;</span>
            <span class="nb">echo</span> <span class="s2">&quot;or -</span><span class="si">${</span><span class="nv">help</span><span class="si">}</span><span class="s2"> for help&quot;</span><span class="p">;;</span>      <span class="c"># Catch anything else.</span>
  <span class="k">esac</span>
<span class="k">done</span>
<span class="nb">shift</span> <span class="k">$((</span>OPTIND <span class="o">-</span> <span class="m">1</span><span class="k">))</span>     <span class="c"># Do funky magic stuff with $#.</span>


<span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$lister</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
                          <span class="c">#  We should be left with at least one URL</span>
                          <span class="c">#+ on the command-line, unless a list is</span>
              <span class="c">#+ being used -- catch empty CL&#39;s.</span>
   <span class="nb">echo</span> <span class="s2">&quot;No URL&#39;s given! You must enter them on the same line as wgetter2.&quot;</span>
   <span class="nb">echo</span> <span class="s2">&quot;E.g.,  wgetter2 http://somesite http://anothersite.&quot;</span>
   <span class="nb">echo</span> <span class="s2">&quot;Use </span><span class="nv">$help</span><span class="s2"> option for more information.&quot;</span>
   <span class="nb">exit</span> <span class="nv">$E_NO_URLS</span>        <span class="c"># Bail out, with appropriate error code.</span>
<span class="k">fi</span>

<span class="nv">URLS</span><span class="o">=</span><span class="s2">&quot; </span><span class="nv">$@</span><span class="s2">&quot;</span>
<span class="c"># Use this so that URL list can be changed if we stay in the option loop.</span>

<span class="k">while</span> <span class="o">[</span> <span class="m">1</span> <span class="o">]</span><span class="p">;</span> <span class="k">do</span>
   <span class="c"># This is where we ask for the most used options.</span>
   <span class="c"># (Mostly unchanged from version 1 of wgetter)</span>
   <span class="k">if</span> <span class="o">[</span> -z <span class="nv">$curDepth</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
      <span class="nv">Current</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
   <span class="k">else</span> <span class="nv">Current</span><span class="o">=</span><span class="s2">&quot; Current value is </span><span class="nv">$curDepth</span><span class="s2">&quot;</span>
   <span class="k">fi</span>
       <span class="nb">echo</span> <span class="s2">&quot;How deep should I go? \</span>
<span class="s2">(integer: Default is </span><span class="nv">$depthDefault</span><span class="s2">.</span><span class="nv">$Current</span><span class="s2">)&quot;</span>
       <span class="nb">read </span>Depth   <span class="c"># Recursion -- how far should we go?</span>
       <span class="nv">inputB</span><span class="o">=</span><span class="s2">&quot;&quot;</span>    <span class="c"># Reset this to blank on each pass of the loop.</span>
       <span class="nb">echo</span> <span class="s2">&quot;Enter the name of the referring page (default is none).&quot;</span>
       <span class="nb">read </span>inputB  <span class="c"># Need this for some sites.</span>

       <span class="nb">echo</span> <span class="s2">&quot;Do you want to have the output logged to the terminal&quot;</span>
       <span class="nb">echo</span> <span class="s2">&quot;(y/n, default is yes)?&quot;</span>
       <span class="nb">read </span>noHide  <span class="c"># Otherwise wget will just log it to a file.</span>

       <span class="k">case</span> <span class="nv">$noHide</span> in    <span class="c"># Now you see me, now you don&#39;t.</span>
          y<span class="p">|</span>Y <span class="o">)</span> <span class="nv">hide</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">;;</span>
          n<span class="p">|</span>N <span class="o">)</span> <span class="nv">hide</span><span class="o">=</span><span class="s2">&quot; -b&quot;</span><span class="p">;;</span>
            * <span class="o">)</span> <span class="nv">hide</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">;;</span>
       <span class="k">esac</span>

       <span class="k">if</span> <span class="o">[</span> -z <span class="si">${</span><span class="nv">Depth</span><span class="si">}</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
       <span class="c">#  User accepted either default or current depth,</span>
       <span class="c">#+ in which case Depth is now empty.</span>
          <span class="k">if</span> <span class="o">[</span> -z <span class="si">${</span><span class="nv">curDepth</span><span class="si">}</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
          <span class="c">#  See if a depth was set on a previous iteration.</span>
             <span class="nv">Depth</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$depthDefault</span><span class="s2">&quot;</span>
             <span class="c">#  Set the default recursion depth if nothing</span>
             <span class="c">#+ else to use.</span>
          <span class="k">else</span> <span class="nv">Depth</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$curDepth</span><span class="s2">&quot;</span> <span class="c">#  Otherwise, set the one we used before.</span>
          <span class="k">fi</span>
       <span class="k">fi</span>
   <span class="nv">Recurse</span><span class="o">=</span><span class="s2">&quot; -l </span><span class="nv">$Depth</span><span class="s2">&quot;</span>          <span class="c"># Set how deep we want to go.</span>
   <span class="nv">curDepth</span><span class="o">=</span><span class="nv">$Depth</span>               <span class="c"># Remember setting for next time.</span>

       <span class="k">if</span> <span class="o">[</span> ! -z <span class="nv">$inputB</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
          <span class="nv">RefA</span><span class="o">=</span><span class="s2">&quot; --referer=</span><span class="nv">$inputB</span><span class="s2">&quot;</span>   <span class="c"># Option to use referring page.</span>
       <span class="k">fi</span>

   <span class="nv">WGETTER</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">CommandA</span><span class="si">}${</span><span class="nv">pattern</span><span class="si">}${</span><span class="nv">hide</span><span class="si">}${</span><span class="nv">RefA</span><span class="si">}${</span><span class="nv">Recurse</span><span class="si">}</span><span class="s2">\</span>
<span class="si">${</span><span class="nv">CookiesON</span><span class="si">}${</span><span class="nv">lister</span><span class="si">}${</span><span class="nv">Woptions</span><span class="si">}${</span><span class="nv">URLS</span><span class="si">}</span><span class="s2">&quot;</span>
   <span class="c">#  Just string the whole lot together . . .</span>
   <span class="c">#  NB: no embedded spaces.</span>
   <span class="c">#  They are in the individual elements so that if any are empty,</span>
   <span class="c">#+ we don&#39;t get an extra space.</span>

   <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="si">${</span><span class="nv">CookiesON</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$cFlag</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;1&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
       <span class="nb">echo</span> <span class="s2">&quot;Warning -- can&#39;t find cookie file&quot;</span>
       <span class="c">#  This should be changed,</span>
       <span class="c">#+ in case the user has opted to not use cookies.</span>
   <span class="k">fi</span>

   <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$Flag</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;S&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
      <span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$WGETTER</span><span class="s2">&quot;</span> &gt;&gt; <span class="nv">$savePath</span>/wget-<span class="si">${</span><span class="nv">today</span><span class="si">}</span>
      <span class="c">#  Create a unique filename for today, or append to it if it exists.</span>
      <span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$inputB</span><span class="s2">&quot;</span> &gt;&gt; <span class="nv">$savePath</span>/site-list-<span class="si">${</span><span class="nv">today</span><span class="si">}</span>
      <span class="c">#  Make a list, so it&#39;s easy to refer back to,</span>
      <span class="c">#+ since the whole command is a bit confusing to look at.</span>
      <span class="nb">echo</span> <span class="s2">&quot;Command saved to the file </span><span class="nv">$savePath</span><span class="s2">/wget-</span><span class="si">${</span><span class="nv">today</span><span class="si">}</span><span class="s2">&quot;</span>
           <span class="c"># Tell the user.</span>
      <span class="nb">echo</span> <span class="s2">&quot;Referring page URL saved to the file</span><span class="nv">$ </span><span class="s2">\</span>
<span class="s2">savePath/site-list-</span><span class="si">${</span><span class="nv">today</span><span class="si">}</span><span class="s2">&quot;</span>
           <span class="c"># Tell the user.</span>
      <span class="nv">Saver</span><span class="o">=</span><span class="s2">&quot; with save option&quot;</span>
      <span class="c"># Stick this somewhere, so it appears in the loop if set.</span>
   <span class="k">else</span>
       <span class="nb">echo</span> <span class="s2">&quot;*****************&quot;</span>
       <span class="nb">echo</span> <span class="s2">&quot;*****Getting*****&quot;</span>
       <span class="nb">echo</span> <span class="s2">&quot;*****************&quot;</span>
       <span class="nb">echo</span> <span class="s2">&quot;&quot;</span>
       <span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$WGETTER</span><span class="s2">&quot;</span>
       <span class="nb">echo</span> <span class="s2">&quot;&quot;</span>
       <span class="nb">echo</span> <span class="s2">&quot;*****************&quot;</span>
       <span class="nb">eval</span> <span class="s2">&quot;</span><span class="nv">$WGETTER</span><span class="s2">&quot;</span>
   <span class="k">fi</span>

       <span class="nb">echo</span> <span class="s2">&quot;&quot;</span>
       <span class="nb">echo</span> <span class="s2">&quot;Starting over</span><span class="nv">$Saver</span><span class="s2">.&quot;</span>
       <span class="nb">echo</span> <span class="s2">&quot;If you want to stop, press q.&quot;</span>
       <span class="nb">echo</span> <span class="s2">&quot;Otherwise, enter some URL&#39;s:&quot;</span>
       <span class="c"># Let them go again. Tell about save option being set.</span>

       <span class="nb">read</span>
<span class="nb">       </span><span class="k">case</span> <span class="nv">$REPLY</span> in
       <span class="c"># Need to change this to a &#39;trap&#39; clause.</span>
          q<span class="p">|</span>Q <span class="o">)</span> <span class="nb">exit</span> <span class="nv">$E_USER_EXIT</span><span class="p">;;</span>  <span class="c"># Exercise for the reader?</span>
            * <span class="o">)</span> <span class="nv">URLS</span><span class="o">=</span><span class="s2">&quot; </span><span class="nv">$REPLY</span><span class="s2">&quot;</span><span class="p">;;</span>
       <span class="k">esac</span>

       <span class="nb">echo</span> <span class="s2">&quot;&quot;</span>
<span class="k">done</span>


<span class="nb">exit </span>0
</pre></div>
</div>
</div>
<div class="section" id="exemple-31-a-podcasting-script">
<h2>Exemple 31. A <em>podcasting</em> script<a class="headerlink" href="#exemple-31-a-podcasting-script" title="Link permanent a aquest títol">¶</a></h2>
<div class="highlight-sh"><div class="highlight"><pre>#!/bin/bash

#  bashpodder.sh:
#  By Linc 10/1/2004
#  Find the latest script at
#+ http://linc.homeunix.org:8080/scripts/bashpodder
#  Last revision 12/14/2004 - Many Contributors!
#  If you use this and have made improvements or have comments
#+ drop me an email at linc dot fessenden at gmail dot com
#  I&#39;d appreciate it!

# ==&gt;  ABS Guide extra comments.

# ==&gt;  Author of this script has kindly granted permission
# ==&gt;+ for inclusion in ABS Guide.


# ==&gt; ################################################################
#
# ==&gt; What is &quot;podcasting&quot;?

# ==&gt; It&#39;s broadcasting &quot;radio shows&quot; over the Internet.
# ==&gt; These shows can be played on iPods and other music file players.

# ==&gt; This script makes it possible.
# ==&gt; See documentation at the script author&#39;s site, above.

# ==&gt; ################################################################


# Make script crontab friendly:
cd $(dirname $0)
# ==&gt; Change to directory where this script lives.

# datadir is the directory you want podcasts saved to:
datadir=$(date +%Y-%m-%d)
# ==&gt; Will create a date-labeled directory, named: YYYY-MM-DD

# Check for and create datadir if necessary:
if test ! -d $datadir
        then
        mkdir $datadir
fi

# Delete any temp file:
rm -f temp.log

#  Read the bp.conf file and wget any url not already
#+ in the podcast.log file:
while read podcast
  do # ==&gt; Main action follows.
  file=$(wget -q $podcast -O -tr &#39;\r&#39; &#39;\n&#39; | tr \&#39; \&quot; | \
sed -n &#39;s/.*url=&quot;\([^&quot;]*\)&quot;.*/\1/p&#39;)
  for url in $file
                do
                echo $url &gt;&gt; temp.log
                if ! grep &quot;$url&quot; podcast.log &gt; /dev/null
                        then
                        wget -q -P $datadir &quot;$url&quot;
                fi
                done
    done &lt; bp.conf

# Move dynamically created log file to permanent log file:
cat podcast.log &gt;&gt; temp.log
sort temp.loguniq &gt; podcast.log
rm temp.log
# Create an m3u playlist:
ls $datadirgrep -v m3u &gt; $datadir/podcast.m3u


exit 0

#################################################
For a different scripting approach to Podcasting,
see Phil Salkie&#39;s article,
&quot;Internet Radio to Podcast with Shell Tools&quot;
in the September, 2005 issue of LINUX JOURNAL,
http://www.linuxjournal.com/article/8171
#################################################
</pre></div>
</div>
</div>
<div class="section" id="exemple-32-nightly-backup-to-a-firewire-hd">
<h2>Exemple 32. Nightly backup to a firewire HD<a class="headerlink" href="#exemple-32-nightly-backup-to-a-firewire-hd" title="Link permanent a aquest títol">¶</a></h2>
<div class="highlight-sh"><div class="highlight"><pre><span class="c">#!/bin/bash</span>
<span class="c"># nightly-backup.sh</span>
<span class="c"># http://www.richardneill.org/source.php#nightly-backup-rsync</span>
<span class="c"># Copyright (c) 2005 Richard Neill &lt;backup@richardneill.org&gt;.</span>
<span class="c"># This is Free Software licensed under the GNU GPL.</span>
<span class="c"># ==&gt; Included in ABS Guide with script author&#39;s kind permission.</span>
<span class="c"># ==&gt; (Thanks!)</span>

<span class="c">#  This does a backup from the host computer to a locally connected</span>
<span class="c">#+ firewire HDD using rsync and ssh.</span>
<span class="c">#  (Script should work with USB-connected device (see lines 40-43).</span>
<span class="c">#  It then rotates the backups.</span>
<span class="c">#  Run it via cron every night at 5am.</span>
<span class="c">#  This only backs up the home directory.</span>
<span class="c">#  If ownerships (other than the user&#39;s) should be preserved,</span>
<span class="c">#+ then run the rsync process as root (and re-instate the -o).</span>
<span class="c">#  We save every day for 7 days, then every week for 4 weeks,</span>
<span class="c">#+ then every month for 3 months.</span>

<span class="c">#  See: http://www.mikerubel.org/computers/rsync_snapshots/</span>
<span class="c">#+ for more explanation of the theory.</span>
<span class="c">#  Save as: $HOME/bin/nightly-backup_firewire-hdd.sh</span>

<span class="c">#  Known bugs:</span>
<span class="c">#  ----------</span>
<span class="c">#  i)  Ideally, we want to exclude ~/.tmp and the browser caches.</span>

<span class="c">#  ii) If the user is sitting at the computer at 5am,</span>
<span class="c">#+     and files are modified while the rsync is occurring,</span>
<span class="c">#+     then the BACKUP_JUSTINCASE branch gets triggered.</span>
<span class="c">#      To some extent, this is a</span>
<span class="c">#+     feature, but it also causes a &quot;disk-space leak&quot;.</span>





<span class="c">##### BEGIN CONFIGURATION SECTION ############################################</span>
<span class="nv">LOCAL_USER</span><span class="o">=</span>rjn                <span class="c"># User whose home directory should be backed up.</span>
<span class="nv">MOUNT_POINT</span><span class="o">=</span>/backup           <span class="c"># Mountpoint of backup drive.</span>
                              <span class="c"># NO trailing slash!</span>
                              <span class="c"># This must be unique (eg using a udev symlink)</span>
<span class="c"># MOUNT_POINT=/media/disk     # For USB-connected device.</span>
<span class="nv">SOURCE_DIR</span><span class="o">=</span>/home/<span class="nv">$LOCAL_USER</span>  <span class="c"># NO trailing slash - it DOES matter to rsync.</span>
<span class="nv">BACKUP_DEST_DIR</span><span class="o">=</span><span class="nv">$MOUNT_POINT</span>/backup/<span class="sb">`</span>hostname -s<span class="sb">`</span>.<span class="si">${</span><span class="nv">LOCAL_USER</span><span class="si">}</span>.nightly_backup
<span class="nv">DRY_RUN</span><span class="o">=</span><span class="nb">false</span>                 <span class="c">#If true, invoke rsync with -n, to do a dry run.</span>
                              <span class="c"># Comment out or set to false for normal use.</span>
<span class="nv">VERBOSE</span><span class="o">=</span><span class="nb">false</span>                 <span class="c"># If true, make rsync verbose.</span>
                              <span class="c"># Comment out or set to false otherwise.</span>
<span class="nv">COMPRESS</span><span class="o">=</span><span class="nb">false</span>                <span class="c"># If true, compress.</span>
                              <span class="c"># Good for internet, bad on LAN.</span>
                              <span class="c"># Comment out or set to false otherwise.</span>

<span class="c">### Exit Codes ###</span>
<span class="nv">E_VARS_NOT_SET</span><span class="o">=</span>64
<span class="nv">E_COMMANDLINE</span><span class="o">=</span>65
<span class="nv">E_MOUNT_FAIL</span><span class="o">=</span>70
<span class="nv">E_NOSOURCEDIR</span><span class="o">=</span>71
<span class="nv">E_UNMOUNTED</span><span class="o">=</span>72
<span class="nv">E_BACKUP</span><span class="o">=</span>73
<span class="c">##### END CONFIGURATION SECTION ##############################################</span>


<span class="c"># Check that all the important variables have been set:</span>
<span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$LOCAL_USER</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">|</span>
   <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$SOURCE_DIR</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">|</span>
   <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$MOUNT_POINT</span><span class="s2">&quot;</span> <span class="o">]</span>  <span class="p">|</span>
   <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$BACKUP_DEST_DIR</span><span class="s2">&quot;</span> <span class="o">]</span>
<span class="k">then</span>
   <span class="nb">echo</span> <span class="s1">&#39;One of the variables is not set! Edit the file: $0. BACKUP FAILED.&#39;</span>
   <span class="nb">exit</span> <span class="nv">$E_VARS_NOT_SET</span>
<span class="k">fi</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$#&quot;</span><span class="s2"> != 0 ]  # If command-line param(s) . . .</span>
<span class="s2">then              # Here document(ation).</span>
<span class="s2">  cat &lt;&lt;-ENDOFTEXT</span>
<span class="s2">    Automatic Nightly backup run from cron.</span>
<span class="s2">    Read the source for more details: </span><span class="nv">$0</span><span class="s2"></span>
<span class="s2">    The backup directory is </span><span class="nv">$BACKUP_DEST_DIR</span><span class="s2"> .</span>
<span class="s2">    It will be created if necessary; initialisation is no longer required.</span>

<span class="s2">    WARNING: Contents of </span><span class="nv">$BACKUP_DEST_DIR</span><span class="s2"> are rotated.</span>
<span class="s2">    Directories named &#39;backup.\$i&#39; will eventually be DELETED.</span>
<span class="s2">    We keep backups from every day for 7 days (1-8),</span>
<span class="s2">    then every week for 4 weeks (9-12),</span>
<span class="s2">    then every month for 3 months (13-15).</span>

<span class="s2">    You may wish to add this to your crontab using &#39;crontab -e&#39;</span>
<span class="s2">    #  Back up files: </span><span class="nv">$SOURCE_DIR</span><span class="s2"> to </span><span class="nv">$BACKUP_DEST_DIR</span><span class="s2"></span>
<span class="s2">    #+ every night at 3:15 am</span>
<span class="s2">         15 03 * * * /home/</span><span class="nv">$LOCAL_USER</span><span class="s2">/bin/nightly-backup_firewire-hdd.sh</span>

<span class="s2">    Don&#39;t forget to verify the backups are working,</span>
<span class="s2">    especially if you don&#39;t read cron&#39;s mail!&quot;</span>
    ENDOFTEXT
   <span class="nb">exit</span> <span class="nv">$E_COMMANDLINE</span>
<span class="k">fi</span>


<span class="c"># Parse the options.</span>
<span class="c"># ==================</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$DRY_RUN</span><span class="s2">&quot;</span> <span class="o">==</span> <span class="s2">&quot;true&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
  <span class="nv">DRY_RUN</span><span class="o">=</span><span class="s2">&quot;-n&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot;WARNING:&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot;THIS IS A &#39;DRY RUN&#39;!&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot;No data will actually be transferred!&quot;</span>
<span class="k">else</span>
  <span class="nv">DRY_RUN</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
<span class="k">fi</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$VERBOSE</span><span class="s2">&quot;</span> <span class="o">==</span> <span class="s2">&quot;true&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
  <span class="nv">VERBOSE</span><span class="o">=</span><span class="s2">&quot;-v&quot;</span>
<span class="k">else</span>
  <span class="nv">VERBOSE</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
<span class="k">fi</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$COMPRESS</span><span class="s2">&quot;</span> <span class="o">==</span> <span class="s2">&quot;true&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
  <span class="nv">COMPRESS</span><span class="o">=</span><span class="s2">&quot;-z&quot;</span>
<span class="k">else</span>
  <span class="nv">COMPRESS</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
<span class="k">fi</span>


<span class="c">#  Every week (actually of 8 days) and every month,</span>
<span class="c">#+ extra backups are preserved.</span>
<span class="nv">DAY_OF_MONTH</span><span class="o">=</span><span class="sb">`</span>date +%d<span class="sb">`</span>            <span class="c"># Day of month (01..31).</span>
<span class="k">if</span> <span class="o">[</span> <span class="nv">$DAY_OF_MONTH</span> <span class="o">=</span> <span class="m">01</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>    <span class="c"># First of month.</span>
  <span class="nv">MONTHSTART</span><span class="o">=</span><span class="nb">true</span>
<span class="k">elif</span> <span class="o">[</span> <span class="nv">$DAY_OF_MONTH</span> <span class="o">=</span> <span class="m">08</span> <span class="se">\</span>
    -o <span class="nv">$DAY_OF_MONTH</span> <span class="o">=</span> <span class="m">16</span> <span class="se">\</span>
    -o <span class="nv">$DAY_OF_MONTH</span> <span class="o">=</span> <span class="m">24</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="c"># Day 8,16,24  (use 8, not 7 to better handle 31-day months)</span>
      <span class="nv">WEEKSTART</span><span class="o">=</span><span class="nb">true</span>
<span class="k">fi</span>



<span class="c">#  Check that the HDD is mounted.</span>
<span class="c">#  At least, check that *something* is mounted here!</span>
<span class="c">#  We can use something unique to the device, rather than just guessing</span>
<span class="c">#+ the scsi-id by having an appropriate udev rule in</span>
<span class="c">#+ /etc/udev/rules.d/10-rules.local</span>
<span class="c">#+ and by putting a relevant entry in /etc/fstab.</span>
<span class="c">#  Eg: this udev rule:</span>
<span class="c"># BUS=&quot;scsi&quot;, KERNEL=&quot;sd*&quot;, SYSFS{vendor}=&quot;WDC WD16&quot;,</span>
<span class="c"># SYSFS{model}=&quot;00JB-00GVA0     &quot;, NAME=&quot;%k&quot;, SYMLINK=&quot;lacie_1394d%n&quot;</span>

<span class="k">if</span> mountgrep <span class="nv">$MOUNT_POINT</span> &gt;/dev/null<span class="p">;</span> <span class="k">then</span>
  <span class="nb">echo</span> <span class="s2">&quot;Mount point </span><span class="nv">$MOUNT_POINT</span><span class="s2"> is indeed mounted. OK&quot;</span>
<span class="k">else</span>
  <span class="nb">echo</span> -n <span class="s2">&quot;Attempting to mount </span><span class="nv">$MOUNT_POINT</span><span class="s2">...&quot;</span>
           <span class="c"># If it isn&#39;t mounted, try to mount it.</span>
  sudo mount <span class="nv">$MOUNT_POINT</span> 2&gt;/dev/null

  <span class="k">if</span> mountgrep <span class="nv">$MOUNT_POINT</span> &gt;/dev/null<span class="p">;</span> <span class="k">then</span>
    <span class="nv">UNMOUNT_LATER</span><span class="o">=</span>TRUE
    <span class="nb">echo</span> <span class="s2">&quot;OK&quot;</span>
    <span class="c">#  Note: Ensure that this is also unmounted</span>
    <span class="c">#+ if we exit prematurely with failure.</span>
  <span class="k">else</span>
    <span class="nb">echo</span> <span class="s2">&quot;FAILED&quot;</span>
    <span class="nb">echo</span> -e <span class="s2">&quot;Nothing is mounted at </span><span class="nv">$MOUNT_POINT</span><span class="s2">. BACKUP FAILED!&quot;</span>
    <span class="nb">exit</span> <span class="nv">$E_MOUNT_FAIL</span>
  <span class="k">fi</span>
<span class="k">fi</span>


<span class="c"># Check that source dir exists and is readable.</span>
<span class="k">if</span> <span class="o">[</span> ! -r  <span class="nv">$SOURCE_DIR</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
  <span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$SOURCE_DIR</span><span class="s2"> does not exist, or cannot be read. BACKUP FAILED.&quot;</span>
  <span class="nb">exit</span> <span class="nv">$E_NOSOURCEDIR</span>
<span class="k">fi</span>


<span class="c"># Check that the backup directory structure is as it should be.</span>
<span class="c"># If not, create it.</span>
<span class="c"># Create the subdirectories.</span>
<span class="c"># Note that backup.0 will be created as needed by rsync.</span>

<span class="k">for</span> <span class="o">((</span><span class="nv">i</span><span class="o">=</span>1<span class="p">;</span>i&lt;<span class="o">=</span>15<span class="p">;</span>i++<span class="o">))</span><span class="p">;</span> <span class="k">do</span>
  <span class="k">if</span> <span class="o">[</span> ! -d <span class="nv">$BACKUP_DEST_DIR</span>/backup.<span class="nv">$i</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="k">if</span> /bin/mkdir -p <span class="nv">$BACKUP_DEST_DIR</span>/backup.<span class="nv">$i</span> <span class="p">;</span> <span class="k">then</span>
    <span class="c">#  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^  No [ ] test brackets. Why?</span>
      <span class="nb">echo</span> <span class="s2">&quot;Warning: directory </span><span class="nv">$BACKUP_DEST_DIR</span><span class="s2">/backup.</span><span class="nv">$i</span><span class="s2"> is missing,&quot;</span>
      <span class="nb">echo</span> <span class="s2">&quot;or was not initialised. (Re-)creating it.&quot;</span>
    <span class="k">else</span>
      <span class="nb">echo</span> <span class="s2">&quot;ERROR: directory </span><span class="nv">$BACKUP_DEST_DIR</span><span class="s2">/backup.</span><span class="nv">$i</span><span class="s2">&quot;</span>
      <span class="nb">echo</span> <span class="s2">&quot;is missing and could not be created.&quot;</span>
    <span class="k">if</span>  <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$UNMOUNT_LATER</span><span class="s2">&quot;</span> <span class="o">==</span> <span class="s2">&quot;TRUE&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        <span class="c"># Before we exit, unmount the mount point if necessary.</span>
        <span class="nb">cd</span>
<span class="nb">    </span>sudo umount <span class="nv">$MOUNT_POINT</span> <span class="o">&amp;&amp;</span>
    <span class="nb">echo</span> <span class="s2">&quot;Unmounted </span><span class="nv">$MOUNT_POINT</span><span class="s2"> again. Giving up.&quot;</span>
    <span class="k">fi</span>
      <span class="nb">exit</span> <span class="nv">$E_UNMOUNTED</span>
  <span class="k">fi</span>
<span class="k">fi</span>
<span class="k">done</span>


<span class="c">#  Set the permission to 700 for security</span>
<span class="c">#+ on an otherwise permissive multi-user system.</span>
<span class="k">if</span> ! /bin/chmod <span class="m">700</span> <span class="nv">$BACKUP_DEST_DIR</span> <span class="p">;</span> <span class="k">then</span>
  <span class="nb">echo</span> <span class="s2">&quot;ERROR: Could not set permissions on </span><span class="nv">$BACKUP_DEST_DIR</span><span class="s2"> to 700.&quot;</span>

  <span class="k">if</span>  <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$UNMOUNT_LATER</span><span class="s2">&quot;</span> <span class="o">==</span> <span class="s2">&quot;TRUE&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
  <span class="c"># Before we exit, unmount the mount point if necessary.</span>
     <span class="nb">cd</span> <span class="p">;</span> sudo umount <span class="nv">$MOUNT_POINT</span> <span class="se">\</span>
     <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">&quot;Unmounted </span><span class="nv">$MOUNT_POINT</span><span class="s2"> again. Giving up.&quot;</span>
  <span class="k">fi</span>

  <span class="nb">exit</span> <span class="nv">$E_UNMOUNTED</span>
<span class="k">fi</span>

<span class="c"># Create the symlink: current -&gt; backup.1 if required.</span>
<span class="c"># A failure here is not critical.</span>
<span class="nb">cd</span> <span class="nv">$BACKUP_DEST_DIR</span>
<span class="k">if</span> <span class="o">[</span> ! -h current <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
  <span class="k">if</span> ! /bin/ln -s backup.1 current <span class="p">;</span> <span class="k">then</span>
    <span class="nb">echo</span> <span class="s2">&quot;WARNING: could not create symlink current -&gt; backup.1&quot;</span>
  <span class="k">fi</span>
<span class="k">fi</span>


<span class="c"># Now, do the rsync.</span>
<span class="nb">echo</span> <span class="s2">&quot;Now doing backup with rsync...&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;Source dir: </span><span class="nv">$SOURCE_DIR</span><span class="s2">&quot;</span>
<span class="nb">echo</span> -e <span class="s2">&quot;Backup destination dir: </span><span class="nv">$BACKUP_DEST_DIR</span><span class="s2">\n&quot;</span>


/usr/bin/rsync <span class="nv">$DRY_RUN</span> <span class="nv">$VERBOSE</span> -a -S --delete --modify-window<span class="o">=</span><span class="m">60</span> <span class="se">\</span>
--link-dest<span class="o">=</span>../backup.1 <span class="nv">$SOURCE_DIR</span> <span class="nv">$BACKUP_DEST_DIR</span>/backup.0/

<span class="c">#  Only warn, rather than exit if the rsync failed,</span>
<span class="c">#+ since it may only be a minor problem.</span>
<span class="c">#  E.g., if one file is not readable, rsync will fail.</span>
<span class="c">#  This shouldn&#39;t prevent the rotation.</span>
<span class="c">#  Not using, e.g., `date +%a`  since these directories</span>
<span class="c">#+ are just full of links and don&#39;t consume *that much* space.</span>

<span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> !<span class="o">=</span> <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
  <span class="nv">BACKUP_JUSTINCASE</span><span class="o">=</span>backup.<span class="sb">`</span>date +%F_%T<span class="sb">`</span>.justincase
  <span class="nb">echo</span> <span class="s2">&quot;WARNING: the rsync process did not entirely succeed.&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot;Something might be wrong.&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot;Saving an extra copy at: </span><span class="nv">$BACKUP_JUSTINCASE</span><span class="s2">&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot;WARNING: if this occurs regularly, a LOT of space will be consumed,&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot;even though these are just hard-links!&quot;</span>
<span class="k">fi</span>

<span class="c"># Save a readme in the backup parent directory.</span>
<span class="c"># Save another one in the recent subdirectory.</span>
<span class="nb">echo</span> <span class="s2">&quot;Backup of </span><span class="nv">$SOURCE_DIR</span><span class="s2"> on `hostname` was last run on \</span>
<span class="s2">`date`&quot;</span> &gt; <span class="nv">$BACKUP_DEST_DIR</span>/README.txt
<span class="nb">echo</span> <span class="s2">&quot;This backup of </span><span class="nv">$SOURCE_DIR</span><span class="s2"> on `hostname` was created on \</span>
<span class="s2">`date`&quot;</span> &gt; <span class="nv">$BACKUP_DEST_DIR</span>/backup.0/README.txt

<span class="c"># If we are not in a dry run, rotate the backups.</span>
<span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$DRY_RUN</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span>

  <span class="c">#  Check how full the backup disk is.</span>
  <span class="c">#  Warn if 90%. if 98% or more, we&#39;ll probably fail, so give up.</span>
  <span class="c">#  (Note: df can output to more than one line.)</span>
  <span class="c">#  We test this here, rather than before</span>
  <span class="c">#+ so that rsync may possibly have a chance.</span>
  <span class="nv">DISK_FULL_PERCENT</span><span class="o">=</span><span class="sb">`</span>/bin/df <span class="nv">$BACKUP_DEST_DIR</span>
  tr <span class="s2">&quot;\n&quot;</span> <span class="s1">&#39; &#39;</span>awk <span class="s1">&#39;{print $12}&#39;</span> <span class="p">|</span> grep -oE <span class="o">[</span>0-9<span class="o">]</span>+ <span class="sb">`</span>
  <span class="nb">echo</span> <span class="s2">&quot;Disk space check on backup partition \</span>
<span class="s2">  </span><span class="nv">$MOUNT_POINT</span><span class="s2"> </span><span class="nv">$DISK_FULL_PERCENT</span><span class="s2">% full.&quot;</span>
  <span class="k">if</span> <span class="o">[</span> <span class="nv">$DISK_FULL_PERCENT</span> -gt <span class="m">90</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nb">echo</span> <span class="s2">&quot;Warning: Disk is greater than 90% full.&quot;</span>
  <span class="k">fi</span>
  <span class="k">if</span> <span class="o">[</span> <span class="nv">$DISK_FULL_PERCENT</span> -gt <span class="m">98</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nb">echo</span> <span class="s2">&quot;Error: Disk is full! Giving up.&quot;</span>
      <span class="k">if</span>  <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$UNMOUNT_LATER</span><span class="s2">&quot;</span> <span class="o">==</span> <span class="s2">&quot;TRUE&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        <span class="c"># Before we exit, unmount the mount point if necessary.</span>
        <span class="nb">cd</span><span class="p">;</span> sudo umount <span class="nv">$MOUNT_POINT</span> <span class="o">&amp;&amp;</span>
        <span class="nb">echo</span> <span class="s2">&quot;Unmounted </span><span class="nv">$MOUNT_POINT</span><span class="s2"> again. Giving up.&quot;</span>
      <span class="k">fi</span>
    <span class="nb">exit</span> <span class="nv">$E_UNMOUNTED</span>
  <span class="k">fi</span>


 <span class="c"># Create an extra backup.</span>
 <span class="c"># If this copy fails, give up.</span>
 <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;</span><span class="nv">$BACKUP_JUSTINCASE</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
   <span class="k">if</span> ! /bin/cp -al <span class="nv">$BACKUP_DEST_DIR</span>/backup.0 <span class="se">\</span>
      <span class="nv">$BACKUP_DEST_DIR</span>/<span class="nv">$BACKUP_JUSTINCASE</span>
   <span class="k">then</span>
     <span class="nb">echo</span> <span class="s2">&quot;ERROR: Failed to create extra copy \</span>
<span class="s2">     </span><span class="nv">$BACKUP_DEST_DIR</span><span class="s2">/</span><span class="nv">$BACKUP_JUSTINCASE</span><span class="s2">&quot;</span>
     <span class="k">if</span>  <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$UNMOUNT_LATER</span><span class="s2">&quot;</span> <span class="o">==</span> <span class="s2">&quot;TRUE&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
       <span class="c"># Before we exit, unmount the mount point if necessary.</span>
       <span class="nb">cd</span> <span class="p">;</span>sudo umount <span class="nv">$MOUNT_POINT</span> <span class="o">&amp;&amp;</span>
       <span class="nb">echo</span> <span class="s2">&quot;Unmounted </span><span class="nv">$MOUNT_POINT</span><span class="s2"> again. Giving up.&quot;</span>
     <span class="k">fi</span>
     <span class="nb">exit</span> <span class="nv">$E_UNMOUNTED</span>
   <span class="k">fi</span>
 <span class="k">fi</span>


 <span class="c"># At start of month, rotate the oldest 8.</span>
 <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$MONTHSTART</span><span class="s2">&quot;</span> <span class="o">==</span> <span class="s2">&quot;true&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
   <span class="nb">echo</span> -e <span class="s2">&quot;\nStart of month. \</span>
<span class="s2">   Removing oldest backup: </span><span class="nv">$BACKUP_DEST_DIR</span><span class="s2">/backup.15&quot;</span>  <span class="o">&amp;&amp;</span>
   /bin/rm -rf  <span class="nv">$BACKUP_DEST_DIR</span>/backup.15  <span class="o">&amp;&amp;</span>
   <span class="nb">echo</span> <span class="s2">&quot;Rotating monthly,weekly backups: \</span>
<span class="s2">   </span><span class="nv">$BACKUP_DEST_DIR</span><span class="s2">/backup.[8-14] -&gt; </span><span class="nv">$BACKUP_DEST_DIR</span><span class="s2">/backup.[9-15]&quot;</span>  <span class="o">&amp;&amp;</span>
     /bin/mv <span class="nv">$BACKUP_DEST_DIR</span>/backup.14 <span class="nv">$BACKUP_DEST_DIR</span>/backup.15  <span class="o">&amp;&amp;</span>
     /bin/mv <span class="nv">$BACKUP_DEST_DIR</span>/backup.13 <span class="nv">$BACKUP_DEST_DIR</span>/backup.14  <span class="o">&amp;&amp;</span>
     /bin/mv <span class="nv">$BACKUP_DEST_DIR</span>/backup.12 <span class="nv">$BACKUP_DEST_DIR</span>/backup.13  <span class="o">&amp;&amp;</span>
     /bin/mv <span class="nv">$BACKUP_DEST_DIR</span>/backup.11 <span class="nv">$BACKUP_DEST_DIR</span>/backup.12  <span class="o">&amp;&amp;</span>
     /bin/mv <span class="nv">$BACKUP_DEST_DIR</span>/backup.10 <span class="nv">$BACKUP_DEST_DIR</span>/backup.11  <span class="o">&amp;&amp;</span>
     /bin/mv <span class="nv">$BACKUP_DEST_DIR</span>/backup.9 <span class="nv">$BACKUP_DEST_DIR</span>/backup.10  <span class="o">&amp;&amp;</span>
     /bin/mv <span class="nv">$BACKUP_DEST_DIR</span>/backup.8 <span class="nv">$BACKUP_DEST_DIR</span>/backup.9

 <span class="c"># At start of week, rotate the second-oldest 4.</span>
 <span class="k">elif</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$WEEKSTART</span><span class="s2">&quot;</span> <span class="o">==</span> <span class="s2">&quot;true&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
   <span class="nb">echo</span> -e <span class="s2">&quot;\nStart of week. \</span>
<span class="s2">   Removing oldest weekly backup: </span><span class="nv">$BACKUP_DEST_DIR</span><span class="s2">/backup.12&quot;</span>  <span class="o">&amp;&amp;</span>
   /bin/rm -rf  <span class="nv">$BACKUP_DEST_DIR</span>/backup.12  <span class="o">&amp;&amp;</span>

   <span class="nb">echo</span> <span class="s2">&quot;Rotating weekly backups: \</span>
<span class="s2">   </span><span class="nv">$BACKUP_DEST_DIR</span><span class="s2">/backup.[8-11] -&gt; </span><span class="nv">$BACKUP_DEST_DIR</span><span class="s2">/backup.[9-12]&quot;</span>  <span class="o">&amp;&amp;</span>
     /bin/mv <span class="nv">$BACKUP_DEST_DIR</span>/backup.11 <span class="nv">$BACKUP_DEST_DIR</span>/backup.12  <span class="o">&amp;&amp;</span>
     /bin/mv <span class="nv">$BACKUP_DEST_DIR</span>/backup.10 <span class="nv">$BACKUP_DEST_DIR</span>/backup.11  <span class="o">&amp;&amp;</span>
     /bin/mv <span class="nv">$BACKUP_DEST_DIR</span>/backup.9 <span class="nv">$BACKUP_DEST_DIR</span>/backup.10  <span class="o">&amp;&amp;</span>
     /bin/mv <span class="nv">$BACKUP_DEST_DIR</span>/backup.8 <span class="nv">$BACKUP_DEST_DIR</span>/backup.9

 <span class="k">else</span>
   <span class="nb">echo</span> -e <span class="s2">&quot;\nRemoving oldest daily backup: </span><span class="nv">$BACKUP_DEST_DIR</span><span class="s2">/backup.8&quot;</span>  <span class="o">&amp;&amp;</span>
     /bin/rm -rf  <span class="nv">$BACKUP_DEST_DIR</span>/backup.8

 <span class="k">fi</span>  <span class="o">&amp;&amp;</span>

 <span class="c"># Every day, rotate the newest 8.</span>
 <span class="nb">echo</span> <span class="s2">&quot;Rotating daily backups: \</span>
<span class="s2"> </span><span class="nv">$BACKUP_DEST_DIR</span><span class="s2">/backup.[1-7] -&gt; </span><span class="nv">$BACKUP_DEST_DIR</span><span class="s2">/backup.[2-8]&quot;</span>  <span class="o">&amp;&amp;</span>
     /bin/mv <span class="nv">$BACKUP_DEST_DIR</span>/backup.7 <span class="nv">$BACKUP_DEST_DIR</span>/backup.8  <span class="o">&amp;&amp;</span>
     /bin/mv <span class="nv">$BACKUP_DEST_DIR</span>/backup.6 <span class="nv">$BACKUP_DEST_DIR</span>/backup.7  <span class="o">&amp;&amp;</span>
     /bin/mv <span class="nv">$BACKUP_DEST_DIR</span>/backup.5 <span class="nv">$BACKUP_DEST_DIR</span>/backup.6  <span class="o">&amp;&amp;</span>
     /bin/mv <span class="nv">$BACKUP_DEST_DIR</span>/backup.4 <span class="nv">$BACKUP_DEST_DIR</span>/backup.5  <span class="o">&amp;&amp;</span>
     /bin/mv <span class="nv">$BACKUP_DEST_DIR</span>/backup.3 <span class="nv">$BACKUP_DEST_DIR</span>/backup.4  <span class="o">&amp;&amp;</span>
     /bin/mv <span class="nv">$BACKUP_DEST_DIR</span>/backup.2 <span class="nv">$BACKUP_DEST_DIR</span>/backup.3  <span class="o">&amp;&amp;</span>
     /bin/mv <span class="nv">$BACKUP_DEST_DIR</span>/backup.1 <span class="nv">$BACKUP_DEST_DIR</span>/backup.2  <span class="o">&amp;&amp;</span>
     /bin/mv <span class="nv">$BACKUP_DEST_DIR</span>/backup.0 <span class="nv">$BACKUP_DEST_DIR</span>/backup.1  <span class="o">&amp;&amp;</span>

 <span class="nv">SUCCESS</span><span class="o">=</span><span class="nb">true</span>


<span class="k">if</span>  <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$UNMOUNT_LATER</span><span class="s2">&quot;</span> <span class="o">==</span> <span class="s2">&quot;TRUE&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
  <span class="c"># Unmount the mount point if it wasn&#39;t mounted to begin with.</span>
  <span class="nb">cd</span> <span class="p">;</span> sudo umount <span class="nv">$MOUNT_POINT</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">&quot;Unmounted </span><span class="nv">$MOUNT_POINT</span><span class="s2"> again.&quot;</span>
<span class="k">fi</span>


<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$SUCCESS</span><span class="s2">&quot;</span> <span class="o">==</span> <span class="s2">&quot;true&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
  <span class="nb">echo</span> <span class="s1">&#39;SUCCESS!&#39;</span>
  <span class="nb">exit </span>0
<span class="k">fi</span>

<span class="c"># Should have already exited if backup worked.</span>
<span class="nb">echo</span> <span class="s1">&#39;BACKUP FAILED! Is this just a dry run? Is the disk full?) &#39;</span>
<span class="nb">exit</span> <span class="nv">$E_BACKUP</span>
</pre></div>
</div>
</div>
<div class="section" id="exemple-33-an-expanded-cd-command">
<h2>Exemple 33. An expanded <em>cd</em> command<a class="headerlink" href="#exemple-33-an-expanded-cd-command" title="Link permanent a aquest títol">¶</a></h2>
<div class="highlight-sh"><div class="highlight"><pre>###########################################################################
#
#       cdll
#       by Phil Braham
#
#       ############################################
#       Latest version of this script available from
#       http://freshmeat.net/projects/cd/
#       ############################################
#
#       .cd_new
#
#       An enhancement of the Unix cd command
#
#       There are unlimited stack entries and special entries. The stack
#       entries keep the last cd_maxhistory
#       directories that have been used. The special entries can be
#       assigned to commonly used directories.
#
#       The special entries may be pre-assigned by setting the environment
#       variables CDSn or by using the -u or -U command.
#
#       The following is a suggestion for the .profile file:
#
#               . cdll              #  Set up the cd command
#       alias cd=&#39;cd_new&#39;           #  Replace the cd command
#               cd -U               #  Upload pre-assigned entries for
#                                   #+ the stack and special entries
#               cd -D               #  Set non-default mode
#               alias @=&quot;cd_new @&quot;  #  Allow @ to be used to get history
#
#       For help type:
#
#               cd -h or
#               cd -H
#
#
###########################################################################
#
#       Version 1.2.1
#
#       Written by Phil Braham - Realtime Software Pty Ltd
#       (realtime@mpx.com.au)
#       Please send any suggestions or enhancements to the author (also at
#       phil@braham.net)
#
############################################################################

cd_hm ()
{
        ${PRINTF} &quot;%s&quot; &quot;cd [dir] [0-9] [@[s|h] [-g [&lt;dir&gt;]] [-d] \
[-D] [-r&lt;n&gt;] [dir|0-9] [-R&lt;n&gt;] [&lt;dir&gt;|0-9]
   [-s&lt;n&gt;] [-S&lt;n&gt;] [-u] [-U] [-f] [-F] [-h] [-H] [-v]
    &lt;dir&gt; Go to directory
    0-n         Go to previous directory (0 is previous, 1 is last but 1 etc)
                n is up to max history (default is 50)
    @           List history and special entries
    @h          List history entries
    @s          List special entries
    -g [&lt;dir&gt;]  Go to literal name (bypass special names)
                This is to allow access to dirs called &#39;0&#39;,&#39;1&#39;,&#39;-h&#39; etc
    -d          Change default action - verbose. (See note)
    -D          Change default action - silent. (See note)
    -s&lt;n&gt; Go to the special entry &lt;n&gt;*
    -S&lt;n&gt; Go to the special entry &lt;n&gt;
                and replace it with the current dir*
    -r&lt;n&gt; [&lt;dir&gt;] Go to directory &lt;dir&gt;
                              and then put it on special entry &lt;n&gt;*
    -R&lt;n&gt; [&lt;dir&gt;] Go to directory &lt;dir&gt;
                              and put current dir on special entry &lt;n&gt;*
    -a&lt;n&gt;       Alternative suggested directory. See note below.
    -f [&lt;file&gt;] File entries to &lt;file&gt;.
    -u [&lt;file&gt;] Update entries from &lt;file&gt;.
                If no filename supplied then default file
                (${CDPath}${2:-&quot;$CDFile&quot;}) is used
                -F and -U are silent versions
    -v          Print version number
    -h          Help
    -H          Detailed help

    *The special entries (0 - 9) are held until log off, replaced by another
     entry or updated with the -u command

    Alternative suggested directories:
    If a directory is not found then CD will suggest any
    possibilities. These are directories starting with the same letters
    and if any are found they are listed prefixed with -a&lt;n&gt;
    where &lt;n&gt; is a number.
    It&#39;s possible to go to the directory by entering cd -a&lt;n&gt;
    on the command line.

    The directory for -r&lt;n&gt; or -R&lt;n&gt; may be a number.
    For example:
        $ cd -r3 4  Go to history entry 4 and put it on special entry 3
        $ cd -R3 4  Put current dir on the special entry 3
                    and go to history entry 4
        $ cd -s3    Go to special entry 3

    Note that commands R,r,S and s may be used without a number
    and refer to 0:
        $ cd -s     Go to special entry 0
        $ cd -S     Go to special entry 0 and make special
                    entry 0 current dir
        $ cd -r 1   Go to history entry 1 and put it on special entry 0
        $ cd -r     Go to history entry 0 and put it on special entry 0
    &quot;
        if ${TEST} &quot;$CD_MODE&quot; = &quot;PREV&quot;
        then
                ${PRINTF} &quot;$cd_mnset&quot;
        else
                ${PRINTF} &quot;$cd_mset&quot;
        fi
}

cd_Hm ()
{
        cd_hm
        ${PRINTF} &quot;%s&quot; &quot;
        The previous directories (0-$cd_maxhistory) are stored in the
        environment variables CD[0] - CD[$cd_maxhistory]
        Similarly the special directories S0 - $cd_maxspecial are in
        the environment variable CDS[0] - CDS[$cd_maxspecial]
        and may be accessed from the command line

        The default pathname for the -f and -u commands is $CDPath
        The default filename for the -f and -u commands is $CDFile

        Set the following environment variables:
            CDL_PROMPTLEN  - Set to the length of prompt you require.
                Prompt string is set to the right characters of the
                current directory.
                If not set then prompt is left unchanged
            CDL_PROMPT_PRE - Set to the string to prefix the prompt.
                Default is:
                    non-root:  \&quot;\\[\\e[01;34m\\]\&quot;  (sets colour to blue).
                    root:      \&quot;\\[\\e[01;31m\\]\&quot;  (sets colour to red).
            CDL_PROMPT_POST    - Set to the string to suffix the prompt.
                Default is:
                    non-root:  \&quot;\\[\\e[00m\\]$\&quot;
                                (resets colour and displays $).
                    root:      \&quot;\\[\\e[00m\\]#\&quot;
                                (resets colour and displays #).
            CDPath - Set the default path for the -f &amp; -u options.
                     Default is home directory
            CDFile - Set the default filename for the -f &amp; -u options.
                     Default is cdfile

&quot;
    cd_version

}

cd_version ()
{
 printf &quot;Version: ${VERSION_MAJOR}.${VERSION_MINOR} Date: ${VERSION_DATE}\n&quot;
}

#
# Truncate right.
#
# params:
#   p1 - string
#   p2 - length to truncate to
#
# returns string in tcd
#
cd_right_trunc ()
{
    local tlen=${2}
    local plen=${#1}
    local str=&quot;${1}&quot;
    local diff
    local filler=&quot;&lt;--&quot;
    if ${TEST} ${plen} -le ${tlen}
    then
        tcd=&quot;${str}&quot;
    else
        let diff=${plen}-${tlen}
        elen=3
        if ${TEST} ${diff} -le 2
        then
            let elen=${diff}
        fi
        tlen=-${tlen}
        let tlen=${tlen}+${elen}
        tcd=${filler:0:elen}${str:tlen}
    fi
}

#
# Three versions of do history:
#    cd_dohistory  - packs history and specials side by side
#    cd_dohistoryH - Shows only hstory
#    cd_dohistoryS - Shows only specials
#
cd_dohistory ()
{
    cd_getrc
        ${PRINTF} &quot;History:\n&quot;
    local -i count=${cd_histcount}
    while ${TEST} ${count} -ge 0
    do
        cd_right_trunc &quot;${CD[count]}&quot; ${cd_lchar}
            ${PRINTF} &quot;%2d %-${cd_lchar}.${cd_lchar}s &quot; ${count} &quot;${tcd}&quot;

        cd_right_trunc &quot;${CDS[count]}&quot; ${cd_rchar}
            ${PRINTF} &quot;S%d %-${cd_rchar}.${cd_rchar}s\n&quot; ${count} &quot;${tcd}&quot;
        count=${count}-1
    done
}

cd_dohistoryH ()
{
    cd_getrc
        ${PRINTF} &quot;History:\n&quot;
        local -i count=${cd_maxhistory}
        while ${TEST} ${count} -ge 0
        do
          ${PRINTF} &quot;${count} %-${cd_flchar}.${cd_flchar}s\n&quot; ${CD[$count]}
          count=${count}-1
        done
}

cd_dohistoryS ()
{
    cd_getrc
        ${PRINTF} &quot;Specials:\n&quot;
        local -i count=${cd_maxspecial}
        while ${TEST} ${count} -ge 0
        do
          ${PRINTF} &quot;S${count} %-${cd_flchar}.${cd_flchar}s\n&quot; ${CDS[$count]}
          count=${count}-1
        done
}

cd_getrc ()
{
    cd_flchar=$(stty -aawk -F \;
    &#39;/rows/ { print $2 $3 }&#39;awk -F \  &#39;{ print $4 }&#39;)
    if ${TEST} ${cd_flchar} -ne 0
    then
        cd_lchar=${cd_flchar}/2-5
        cd_rchar=${cd_flchar}/2-5
            cd_flchar=${cd_flchar}-5
    else
            cd_flchar=${FLCHAR:=75}
        # cd_flchar is used for for the @s &amp; @h history
            cd_lchar=${LCHAR:=35}
            cd_rchar=${RCHAR:=35}
    fi
}

cd_doselection ()
{
        local -i nm=0
        cd_doflag=&quot;TRUE&quot;
        if ${TEST} &quot;${CD_MODE}&quot; = &quot;PREV&quot;
        then
                if ${TEST} -z &quot;$cd_npwd&quot;
                then
                        cd_npwd=0
                fi
        fi
        tm=$(echo &quot;${cd_npwd}&quot;cut -b 1)
    if ${TEST} &quot;${tm}&quot; = &quot;-&quot;
    then
        pm=$(echo &quot;${cd_npwd}&quot;cut -b 2)
        nm=$(echo &quot;${cd_npwd}&quot;cut -d $pm -f2)
        case &quot;${pm}&quot; in
             a) cd_npwd=${cd_sugg[$nm]} ;;
             s) cd_npwd=&quot;${CDS[$nm]}&quot; ;;
             S) cd_npwd=&quot;${CDS[$nm]}&quot; ; CDS[$nm]=`pwd` ;;
             r) cd_npwd=&quot;$2&quot; ; cd_specDir=$nm ; cd_doselection &quot;$1&quot; &quot;$2&quot;;;
             R) cd_npwd=&quot;$2&quot; ; CDS[$nm]=`pwd` ; cd_doselection &quot;$1&quot; &quot;$2&quot;;;
        esac
    fi

    if ${TEST} &quot;${cd_npwd}&quot; != &quot;.&quot; -a &quot;${cd_npwd}&quot; \
!= &quot;..&quot; -a &quot;${cd_npwd}&quot; -le ${cd_maxhistory} &gt;&gt;/dev/null 2&gt;&amp;1
    then
      cd_npwd=${CD[$cd_npwd]}
     else
       case &quot;$cd_npwd&quot; in
                @)  cd_dohistory ; cd_doflag=&quot;FALSE&quot; ;;
               @h) cd_dohistoryH ; cd_doflag=&quot;FALSE&quot; ;;
               @s) cd_dohistoryS ; cd_doflag=&quot;FALSE&quot; ;;
               -h) cd_hm ; cd_doflag=&quot;FALSE&quot; ;;
               -H) cd_Hm ; cd_doflag=&quot;FALSE&quot; ;;
               -f) cd_fsave &quot;SHOW&quot; $2 ; cd_doflag=&quot;FALSE&quot; ;;
               -u) cd_upload &quot;SHOW&quot; $2 ; cd_doflag=&quot;FALSE&quot; ;;
               -F) cd_fsave &quot;NOSHOW&quot; $2 ; cd_doflag=&quot;FALSE&quot; ;;
               -U) cd_upload &quot;NOSHOW&quot; $2 ; cd_doflag=&quot;FALSE&quot; ;;
               -g) cd_npwd=&quot;$2&quot; ;;
               -d) cd_chdefm 1; cd_doflag=&quot;FALSE&quot; ;;
               -D) cd_chdefm 0; cd_doflag=&quot;FALSE&quot; ;;
               -r) cd_npwd=&quot;$2&quot; ; cd_specDir=0 ; cd_doselection &quot;$1&quot; &quot;$2&quot;;;
               -R) cd_npwd=&quot;$2&quot; ; CDS[0]=`pwd` ; cd_doselection &quot;$1&quot; &quot;$2&quot;;;
               -s) cd_npwd=&quot;${CDS[0]}&quot; ;;
               -S) cd_npwd=&quot;${CDS[0]}&quot;  ; CDS[0]=`pwd` ;;
               -v) cd_version ; cd_doflag=&quot;FALSE&quot;;;
       esac
    fi
}

cd_chdefm ()
{
        if ${TEST} &quot;${CD_MODE}&quot; = &quot;PREV&quot;
        then
                CD_MODE=&quot;&quot;
                if ${TEST} $1 -eq 1
                then
                        ${PRINTF} &quot;${cd_mset}&quot;
                fi
        else
                CD_MODE=&quot;PREV&quot;
                if ${TEST} $1 -eq 1
                then
                        ${PRINTF} &quot;${cd_mnset}&quot;
                fi
        fi
}

cd_fsave ()
{
        local sfile=${CDPath}${2:-&quot;$CDFile&quot;}
        if ${TEST} &quot;$1&quot; = &quot;SHOW&quot;
        then
                ${PRINTF} &quot;Saved to %s\n&quot; $sfile
        fi
        ${RM} -f ${sfile}
        local -i count=0
        while ${TEST} ${count} -le ${cd_maxhistory}
        do
                echo &quot;CD[$count]=\&quot;${CD[$count]}\&quot;&quot; &gt;&gt; ${sfile}
                count=${count}+1
        done
        count=0
        while ${TEST} ${count} -le ${cd_maxspecial}
        do
                echo &quot;CDS[$count]=\&quot;${CDS[$count]}\&quot;&quot; &gt;&gt; ${sfile}
                count=${count}+1
        done
}

cd_upload ()
{
        local sfile=${CDPath}${2:-&quot;$CDFile&quot;}
        if ${TEST} &quot;${1}&quot; = &quot;SHOW&quot;
        then
                ${PRINTF} &quot;Loading from %s\n&quot; ${sfile}
        fi
        . ${sfile}
}

cd_new ()
{
    local -i count
    local -i choose=0

        cd_npwd=&quot;${1}&quot;
        cd_specDir=-1
        cd_doselection &quot;${1}&quot; &quot;${2}&quot;

        if ${TEST} ${cd_doflag} = &quot;TRUE&quot;
        then
                if ${TEST} &quot;${CD[0]}&quot; != &quot;`pwd`&quot;
                then
                        count=$cd_maxhistory
                        while ${TEST} $count -gt 0
                        do
                                CD[$count]=${CD[$count-1]}
                                count=${count}-1
                        done
                        CD[0]=`pwd`
                fi
                command cd &quot;${cd_npwd}&quot; 2&gt;/dev/null
        if ${TEST} $? -eq 1
        then
            ${PRINTF} &quot;Unknown dir: %s\n&quot; &quot;${cd_npwd}&quot;
            local -i ftflag=0
            for i in &quot;${cd_npwd}&quot;*
            do
                if ${TEST} -d &quot;${i}&quot;
                then
                    if ${TEST} ${ftflag} -eq 0
                    then
                        ${PRINTF} &quot;Suggest:\n&quot;
                        ftflag=1
                fi
                    ${PRINTF} &quot;\t-a${choose} %s\n&quot; &quot;$i&quot;
                                        cd_sugg[$choose]=&quot;${i}&quot;
                    choose=${choose}+1
        fi
            done
        fi
        fi

        if ${TEST} ${cd_specDir} -ne -1
        then
                CDS[${cd_specDir}]=`pwd`
        fi

        if ${TEST} ! -z &quot;${CDL_PROMPTLEN}&quot;
        then
        cd_right_trunc &quot;${PWD}&quot; ${CDL_PROMPTLEN}
            cd_rp=${CDL_PROMPT_PRE}${tcd}${CDL_PROMPT_POST}
                export PS1=&quot;$(echo -ne ${cd_rp})&quot;
        fi
}
#########################################################################
#                                                                       #
#                        Initialisation here                            #
#                                                                       #
#########################################################################
#
VERSION_MAJOR=&quot;1&quot;
VERSION_MINOR=&quot;2.1&quot;
VERSION_DATE=&quot;24-MAY-2003&quot;
#
alias cd=cd_new
#
# Set up commands
RM=/bin/rm
TEST=test
PRINTF=printf              # Use builtin printf

#########################################################################
#                                                                       #
# Change this to modify the default pre- and post prompt strings.       #
# These only come into effect if CDL_PROMPTLEN is set.                  #
#                                                                       #
#########################################################################
if ${TEST} ${EUID} -eq 0
then
#   CDL_PROMPT_PRE=${CDL_PROMPT_PRE:=&quot;$HOSTNAME@&quot;}
    CDL_PROMPT_PRE=${CDL_PROMPT_PRE:=&quot;\\[\\e[01;31m\\]&quot;}  # Root is in red
    CDL_PROMPT_POST=${CDL_PROMPT_POST:=&quot;\\[\\e[00m\\]#&quot;}
else
    CDL_PROMPT_PRE=${CDL_PROMPT_PRE:=&quot;\\[\\e[01;34m\\]&quot;}  # Users in blue
    CDL_PROMPT_POST=${CDL_PROMPT_POST:=&quot;\\[\\e[00m\\]$&quot;}
fi
#########################################################################
#
# cd_maxhistory defines the max number of history entries allowed.
typeset -i cd_maxhistory=50

#########################################################################
#
# cd_maxspecial defines the number of special entries.
typeset -i cd_maxspecial=9
#
#
#########################################################################
#
#  cd_histcount defines the number of entries displayed in
#+ the history command.
typeset -i cd_histcount=9
#
#########################################################################
export CDPath=${HOME}/
#  Change these to use a different                                      #
#+ default path and filename                                            #
export CDFile=${CDFILE:=cdfile}           # for the -u and -f commands  #
#
#########################################################################
                                                                        #
typeset -i cd_lchar cd_rchar cd_flchar
                        #  This is the number of chars to allow for the #
cd_flchar=${FLCHAR:=75} #+ cd_flchar is used for for the @s &amp; @h history#

typeset -ax CD CDS
#
cd_mset=&quot;\n\tDefault mode is now set - entering cd with no parameters \
has the default action\n\tUse cd -d or -D for cd to go to \
previous directory with no parameters\n&quot;
cd_mnset=&quot;\n\tNon-default mode is now set - entering cd with no \
parameters is the same as entering cd 0\n\tUse cd -d or \
-D to change default cd action\n&quot;

# ==================================================================== #



: &lt;&lt;DOCUMENTATION

Written by Phil Braham. Realtime Software Pty Ltd.
Released under GNU license. Free to use. Please pass any modifications
or comments to the author Phil Braham:

realtime@mpx.com.au
=======================================================================

cdll is a replacement for cd and incorporates similar functionality to
the bash pushd and popd commands but is independent of them.

This version of cdll has been tested on Linux using Bash. It will work
on most Linux versions but will probably not work on other shells without
modification.

Introduction
============

cdll allows easy moving about between directories. When changing to a new
directory the current one is automatically put onto a stack. By default
50 entries are kept, but this is configurable. Special directories can be
kept for easy access - by default up to 10, but this is configurable. The
most recent stack entries and the special entries can be easily viewed.

The directory stack and special entries can be saved to, and loaded from,
a file. This allows them to be set up on login, saved before logging out
or changed when moving project to project.

In addition, cdll provides a flexible command prompt facility that allows,
for example, a directory name in colour that is truncated from the left
if it gets too long.


Setting up cdll
===============

Copy cdll to either your local home directory or a central directory
such as /usr/bin (this will require root access).

Copy the file cdfile to your home directory. It will require read and
write access. This a default file that contains a directory stack and
special entries.

To replace the cd command you must add commands to your login script.
The login script is one or more of:

    /etc/profile
    ~/.bash_profile
    ~/.bash_login
    ~/.profile
    ~/.bashrc
    /etc/bash.bashrc.local

To setup your login, ~/.bashrc is recommended, for global (and root) setup
add the commands to /etc/bash.bashrc.local

To set up on login, add the command:
    . &lt;dir&gt;/cdll
For example if cdll is in your local home directory:
    . ~/cdll
If in /usr/bin then:
    . /usr/bin/cdll

If you want to use this instead of the buitin cd command then add:
    alias cd=&#39;cd_new&#39;
We would also recommend the following commands:
    alias @=&#39;cd_new @&#39;
    cd -U
    cd -D

If you want to use cdll&#39;s prompt facilty then add the following:
    CDL_PROMPTLEN=nn
Where nn is a number described below. Initially 99 would be suitable
number.

Thus the script looks something like this:

    ######################################################################
    # CD Setup
    ######################################################################
    CDL_PROMPTLEN=21        # Allow a prompt length of up to 21 characters
    . /usr/bin/cdll         # Initialise cdll
    alias cd=&#39;cd_new&#39;       # Replace the built in cd command
    alias @=&#39;cd_new @&#39;      # Allow @ at the prompt to display history
    cd -U                   # Upload directories
    cd -D                   # Set default action to non-posix
    ######################################################################

The full meaning of these commands will become clear later.

There are a couple of caveats. If another program changes the directory
without calling cdll, then the directory won&#39;t be put on the stack and
also if the prompt facility is used then this will not be updated. Two
programs that can do this are pushd and popd. To update the prompt and
stack simply enter:

    cd .

Note that if the previous entry on the stack is the current directory
then the stack is not updated.

Usage
=====
cd [dir] [0-9] [@[s|h] [-g &lt;dir&gt;] [-d] [-D] [-r&lt;n&gt;]
   [dir|0-9] [-R&lt;n&gt;] [&lt;dir&gt;|0-9] [-s&lt;n&gt;] [-S&lt;n&gt;]
   [-u] [-U] [-f] [-F] [-h] [-H] [-v]

    &lt;dir&gt;       Go to directory
    0-n         Goto previous directory (0 is previous,
                1 is last but 1, etc.)
                n is up to max history (default is 50)
    @           List history and special entries (Usually available as $ @)
    @h          List history entries
    @s          List special entries
    -g [&lt;dir&gt;]  Go to literal name (bypass special names)
                This is to allow access to dirs called &#39;0&#39;,&#39;1&#39;,&#39;-h&#39; etc
    -d          Change default action - verbose. (See note)
    -D          Change default action - silent. (See note)
    -s&lt;n&gt;       Go to the special entry &lt;n&gt;
    -S&lt;n&gt;       Go to the special entry &lt;n&gt;
                      and replace it with the current dir
    -r&lt;n&gt; [&lt;dir&gt;] Go to directory &lt;dir&gt;
                              and then put it on special entry &lt;n&gt;
    -R&lt;n&gt; [&lt;dir&gt;] Go to directory &lt;dir&gt;
                              and put current dir on special entry &lt;n&gt;
    -a&lt;n&gt;       Alternative suggested directory. See note below.
    -f [&lt;file&gt;] File entries to &lt;file&gt;.
    -u [&lt;file&gt;] Update entries from &lt;file&gt;.
                If no filename supplied then default file (~/cdfile) is used
                -F and -U are silent versions
    -v          Print version number
    -h          Help
    -H          Detailed help



Examples
========

These examples assume non-default mode is set (that is, cd with no
parameters will go to the most recent stack directory), that aliases
have been set up for cd and @ as described above and that cd&#39;s prompt
facility is active and the prompt length is 21 characters.

    /home/phil$ @
    # List the entries with the @
    History:
    # Output of the @ command
    .....
    # Skipped these entries for brevity
    1 /home/phil/ummdev               S1 /home/phil/perl
    # Most recent two history entries
    0 /home/phil/perl/eg              S0 /home/phil/umm/ummdev
    # and two special entries are shown

    /home/phil$ cd /home/phil/utils/Cdll
    # Now change directories
    /home/phil/utils/Cdll$ @
    # Prompt reflects the directory.
    History:
    # New history
    .....
    1 /home/phil/perl/eg              S1 /home/phil/perl
    # History entry 0 has moved to 1
    0 /home/phil                      S0 /home/phil/umm/ummdev
    # and the most recent has entered

To go to a history entry:

    /home/phil/utils/Cdll$ cd 1
    # Go to history entry 1.
    /home/phil/perl/eg$
    # Current directory is now what was 1

To go to a special entry:

    /home/phil/perl/eg$ cd -s1
    # Go to special entry 1
    /home/phil/umm/ummdev$
    # Current directory is S1

To go to a directory called, for example, 1:

    /home/phil$ cd -g 1
    # -g ignores the special meaning of 1
    /home/phil/1$

To put current directory on the special list as S1:
    cd -r1 .        #  OR
    cd -R1 .        #  These have the same effect if the directory is
                    #+ . (the current directory)

To go to a directory and add it as a special
  The directory for -r&lt;n&gt; or -R&lt;n&gt; may be a number.
  For example:
        $ cd -r3 4  Go to history entry 4 and put it on special entry 3
        $ cd -R3 4  Put current dir on the special entry 3 and go to
                    history entry 4
        $ cd -s3    Go to special entry 3

    Note that commands R,r,S and s may be used without a number and
    refer to 0:
        $ cd -s     Go to special entry 0
        $ cd -S     Go to special entry 0 and make special entry 0
                    current dir
        $ cd -r 1   Go to history entry 1 and put it on special entry 0
        $ cd -r     Go to history entry 0 and put it on special entry 0


    Alternative suggested directories:

    If a directory is not found, then CD will suggest any
    possibilities. These are directories starting with the same letters
    and if any are found they are listed prefixed with -a&lt;n&gt;
    where &lt;n&gt; is a number. It&#39;s possible to go to the directory
    by entering cd -a&lt;n&gt; on the command line.

        Use cd -d or -D to change default cd action. cd -H will show
        current action.

        The history entries (0-n) are stored in the environment variables
        CD[0] - CD[n]
        Similarly the special directories S0 - 9 are in the environment
        variable CDS[0] - CDS[9]
        and may be accessed from the command line, for example:

            ls -l ${CDS[3]}
            cat ${CD[8]}/file.txt

        The default pathname for the -f and -u commands is ~
        The default filename for the -f and -u commands is cdfile


Configuration
=============

    The following environment variables can be set:

        CDL_PROMPTLEN  - Set to the length of prompt you require.
            Prompt string is set to the right characters of the current
            directory. If not set, then prompt is left unchanged. Note
            that this is the number of characters that the directory is
            shortened to, not the total characters in the prompt.

            CDL_PROMPT_PRE - Set to the string to prefix the prompt.
                Default is:
                    non-root:  &quot;\\[\\e[01;34m\\]&quot;  (sets colour to blue).
                    root:      &quot;\\[\\e[01;31m\\]&quot;  (sets colour to red).

            CDL_PROMPT_POST    - Set to the string to suffix the prompt.
                Default is:
                    non-root:  &quot;\\[\\e[00m\\]$&quot;
                               (resets colour and displays $).
                    root:      &quot;\\[\\e[00m\\]#&quot;
                               (resets colour and displays #).

        Note:
            CDL_PROMPT_PRE &amp; _POST only t

        CDPath - Set the default path for the -f &amp; -u options.
                 Default is home directory
        CDFile - Set the default filename for the -f &amp; -u options.
                 Default is cdfile


    There are three variables defined in the file cdll which control the
    number of entries stored or displayed. They are in the section labeled
    &#39;Initialisation here&#39; towards the end of the file.

        cd_maxhistory       - The number of history entries stored.
                              Default is 50.
        cd_maxspecial       - The number of special entries allowed.
                              Default is 9.
        cd_histcount        - The number of history and special entries
                              displayed. Default is 9.

    Note that cd_maxspecial should be &gt;= cd_histcount to avoid displaying
    special entries that can&#39;t be set.


Version: 1.2.1 Date: 24-MAY-2003

DOCUMENTATION
</pre></div>
</div>
</div>
<div class="section" id="exemple-34-a-soundcard-setup-script">
<h2>Exemple 34. A soundcard setup script<a class="headerlink" href="#exemple-34-a-soundcard-setup-script" title="Link permanent a aquest títol">¶</a></h2>
<div class="highlight-sh"><div class="highlight"><pre><span class="c">#!/bin/bash</span>
<span class="c"># soundcard-on.sh</span>

<span class="c">#  Script author: Mkarcher</span>
<span class="c">#  http://www.thinkwiki.org/wiki  ...</span>
<span class="c">#  /Script_for_configuring_the_CS4239_sound_chip_in_PnP_mode</span>
<span class="c">#  ABS Guide author made minor changes and added comments.</span>
<span class="c">#  Couldn&#39;t contact script author to ask for permission to use, but ...</span>
<span class="c">#+ the script was released under the FDL,</span>
<span class="c">#+ so its use here should be both legal and ethical.</span>

<span class="c">#  Sound-via-pnp-script for Thinkpad 600E</span>
<span class="c">#+ and possibly other computers with onboard CS4239/CS4610</span>
<span class="c">#+ that do not work with the PCI driver</span>
<span class="c">#+ and are not recognized by the PnP code of snd-cs4236.</span>
<span class="c">#  Also for some 770-series Thinkpads, such as the 770x.</span>
<span class="c">#  Run as root user, of course.</span>
<span class="c">#</span>
<span class="c">#  These are old and very obsolete laptop computers,</span>
<span class="c">#+ but this particular script is very instructive,</span>
<span class="c">#+ as it shows how to set up and hack device files.</span>



<span class="c">#  Search for sound card pnp device:</span>

<span class="k">for</span> dev in /sys/bus/pnp/devices/*
<span class="k">do</span>
  grep CSC0100 <span class="nv">$dev</span>/id &gt; /dev/null <span class="o">&amp;&amp;</span> <span class="nv">WSSDEV</span><span class="o">=</span><span class="nv">$dev</span>
  grep CSC0110 <span class="nv">$dev</span>/id &gt; /dev/null <span class="o">&amp;&amp;</span> <span class="nv">CTLDEV</span><span class="o">=</span><span class="nv">$dev</span>
<span class="k">done</span>
<span class="c"># On 770x:</span>
<span class="c"># WSSDEV = /sys/bus/pnp/devices/00:07</span>
<span class="c"># CTLDEV = /sys/bus/pnp/devices/00:06</span>
<span class="c"># These are symbolic links to /sys/devices/pnp0/ ...</span>


<span class="c">#  Activate devices:</span>
<span class="c">#  Thinkpad boots with devices disabled unless &quot;fast boot&quot; is turned off</span>
<span class="c">#+ (in BIOS).</span>

<span class="nb">echo </span>activate &gt; <span class="nv">$WSSDEV</span>/resources
<span class="nb">echo </span>activate &gt; <span class="nv">$CTLDEV</span>/resources


<span class="c"># Parse resource settings.</span>

<span class="o">{</span> <span class="nb">read</span> <span class="c"># Discard &quot;state = active&quot; (see below).</span>
  <span class="nb">read </span>bla port1
  <span class="nb">read </span>bla port2
  <span class="nb">read </span>bla port3
  <span class="nb">read </span>bla irq
  <span class="nb">read </span>bla dma1
  <span class="nb">read </span>bla dma2
 <span class="c"># The &quot;bla&#39;s&quot; are labels in the first field: &quot;io,&quot; &quot;state,&quot; etc.</span>
 <span class="c"># These are discarded.</span>

 <span class="c">#  Hack: with PnPBIOS: ports are: port1: WSS, port2:</span>
 <span class="c">#+ OPL, port3: sb (unneeded)</span>
 <span class="c">#       with ACPI-PnP:ports are: port1: OPL, port2: sb, port3: WSS</span>
 <span class="c">#  (ACPI bios seems to be wrong here, the PnP-card-code in snd-cs4236.c</span>
 <span class="c">#+  uses the PnPBIOS port order)</span>
 <span class="c">#  Detect port order using the fixed OPL port as reference.</span>
  <span class="k">if</span> <span class="o">[</span> <span class="si">${</span><span class="nv">port2</span><span class="p">%%-*</span><span class="si">}</span> <span class="o">=</span> 0x388 <span class="o">]</span>
 <span class="c">#            ^^^^  Strip out everything following hyphen in port address.</span>
 <span class="c">#                  So, if port1 is 0x530-0x537</span>
 <span class="c">#+                 we&#39;re left with 0x530 -- the start address of the port.</span>
 <span class="k">then</span>
   <span class="c"># PnPBIOS: usual order</span>
   <span class="nv">port</span><span class="o">=</span><span class="si">${</span><span class="nv">port1</span><span class="p">%%-*</span><span class="si">}</span>
   <span class="nv">oplport</span><span class="o">=</span><span class="si">${</span><span class="nv">port2</span><span class="p">%%-*</span><span class="si">}</span>
 <span class="k">else</span>
   <span class="c"># ACPI: mixed-up order</span>
   <span class="nv">port</span><span class="o">=</span><span class="si">${</span><span class="nv">port3</span><span class="p">%%-*</span><span class="si">}</span>
   <span class="nv">oplport</span><span class="o">=</span><span class="si">${</span><span class="nv">port1</span><span class="p">%%-*</span><span class="si">}</span>
 <span class="k">fi</span>
 <span class="o">}</span> &lt; <span class="nv">$WSSDEV</span>/resources
<span class="c"># To see what&#39;s going on here:</span>
<span class="c"># ---------------------------</span>
<span class="c">#   cat /sys/devices/pnp0/00:07/resources</span>
<span class="c">#</span>
<span class="c">#   state = active</span>
<span class="c">#   io 0x530-0x537</span>
<span class="c">#   io 0x388-0x38b</span>
<span class="c">#   io 0x220-0x233</span>
<span class="c">#   irq 5</span>
<span class="c">#   dma 1</span>
<span class="c">#   dma 0</span>
<span class="c">#   ^^^   &quot;bla&quot; labels in first field (discarded).</span>


<span class="o">{</span> <span class="nb">read</span> <span class="c"># Discard first line, as above.</span>
  <span class="nb">read </span>bla port1
  <span class="nv">cport</span><span class="o">=</span><span class="si">${</span><span class="nv">port1</span><span class="p">%%-*</span><span class="si">}</span>
  <span class="c">#            ^^^^</span>
  <span class="c"># Just want _start_ address of port.</span>
<span class="o">}</span> &lt; <span class="nv">$CTLDEV</span>/resources


<span class="c"># Load the module:</span>

modprobe --ignore-install snd-cs4236 <span class="nv">port</span><span class="o">=</span><span class="nv">$port</span> <span class="nv">cport</span><span class="o">=</span><span class="nv">$cport</span><span class="se">\</span>
<span class="nv">fm_port</span><span class="o">=</span><span class="nv">$oplport</span> <span class="nv">irq</span><span class="o">=</span><span class="nv">$irq</span> <span class="nv">dma1</span><span class="o">=</span><span class="nv">$dma1</span> <span class="nv">dma2</span><span class="o">=</span><span class="nv">$dma2</span> <span class="nv">isapnp</span><span class="o">=</span><span class="m">0</span> <span class="nv">index</span><span class="o">=</span>0
<span class="c"># See the modprobe manpage.</span>

<span class="nb">exit</span> <span class="nv">$?</span>
</pre></div>
</div>
</div>
<div class="section" id="exemple-35-locating-split-paragraphs-in-a-text-file">
<h2>Exemple 35. Locating split paragraphs in a text file<a class="headerlink" href="#exemple-35-locating-split-paragraphs-in-a-text-file" title="Link permanent a aquest títol">¶</a></h2>
<div class="highlight-sh"><div class="highlight"><pre><span class="c">#!/bin/bash</span>
<span class="c"># find-splitpara.sh</span>
<span class="c">#  Finds split paragraphs in a text file,</span>
<span class="c">#+ and tags the line numbers.</span>


<span class="nv">ARGCOUNT</span><span class="o">=</span><span class="m">1</span>       <span class="c"># Expect one arg.</span>
<span class="nv">OFF</span><span class="o">=</span><span class="m">0</span>            <span class="c"># Flag states.</span>
<span class="nv">ON</span><span class="o">=</span>1
<span class="nv">E_WRONGARGS</span><span class="o">=</span>85

<span class="nv">file</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>        <span class="c"># Target filename.</span>
<span class="nv">lineno</span><span class="o">=</span><span class="m">1</span>         <span class="c"># Line number. Start at 1.</span>
<span class="nv">Flag</span><span class="o">=</span><span class="nv">$OFF</span>        <span class="c"># Blank line flag.</span>

<span class="k">if</span> <span class="o">[</span> <span class="nv">$# </span>-ne <span class="s2">&quot;</span><span class="nv">$ARGCOUNT</span><span class="s2">&quot;</span> <span class="o">]</span>
<span class="k">then</span>
  <span class="nb">echo</span> <span class="s2">&quot;Usage: `basename </span><span class="nv">$0</span><span class="s2">` FILENAME&quot;</span>
  <span class="nb">exit</span> <span class="nv">$E_WRONGARGS</span>
<span class="k">fi</span>

file_read <span class="o">()</span>     <span class="c"># Scan file for pattern, then print line.</span>
<span class="o">{</span>
<span class="k">while</span> <span class="nb">read </span>line
<span class="k">do</span>

  <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;</span><span class="nv">$line</span><span class="s2">&quot;</span> <span class="o">=</span>~ ^<span class="o">[</span>a-z<span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nv">$Flag</span> -eq <span class="nv">$ON</span> <span class="o">]]</span>
     <span class="k">then</span>  <span class="c"># Line begins with lowercase character, following blank line.</span>
     <span class="nb">echo</span> -n <span class="s2">&quot;</span><span class="nv">$lineno</span><span class="s2">::   &quot;</span>
     <span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$line</span><span class="s2">&quot;</span>
  <span class="k">fi</span>


  <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;</span><span class="nv">$line</span><span class="s2">&quot;</span> <span class="o">=</span>~ ^<span class="nv">$ </span><span class="o">]]</span>
     <span class="k">then</span>       <span class="c">#  If blank line,</span>
     <span class="nv">Flag</span><span class="o">=</span><span class="nv">$ON</span>   <span class="c">#+ set flag.</span>
  <span class="k">else</span>
     <span class="nv">Flag</span><span class="o">=</span><span class="nv">$OFF</span>
  <span class="k">fi</span>

  <span class="o">((</span>lineno++<span class="o">))</span>

<span class="k">done</span>
<span class="o">}</span> &lt; <span class="nv">$file</span>  <span class="c"># Redirect file into function&#39;s stdin.</span>

file_read


<span class="nb">exit</span> <span class="nv">$?</span>


<span class="c"># ----------------------------------------------------------------</span>
This is line one of an example paragraph, bla, bla, bla.
This is line two, and line three should follow on next line, but

there is a blank line separating the two parts of the paragraph.
<span class="c"># ----------------------------------------------------------------</span>

Running this script on a file containing the above paragraph
yields:

4::   there is a blank line separating the two parts of the paragraph.


There will be additional output <span class="k">for</span> all the other split paragraphs
in the target file.
</pre></div>
</div>
</div>
<div class="section" id="exemple-36-insertion-sort">
<h2>Exemple 36. Insertion sort<a class="headerlink" href="#exemple-36-insertion-sort" title="Link permanent a aquest títol">¶</a></h2>
<div class="highlight-sh"><div class="highlight"><pre><span class="c">#!/bin/bash</span>
<span class="c"># insertion-sort.bash: Insertion sort implementation in Bash</span>
<span class="c">#                      Heavy use of Bash array features:</span>
<span class="c">#+                     (string) slicing, merging, etc</span>
<span class="c"># URL: http://www.lugmen.org.ar/~jjo/jjotip/insertion-sort.bash.d</span>
<span class="c">#+          /insertion-sort.bash.sh</span>
<span class="c">#</span>
<span class="c"># Author: JuanJo Ciarlante &lt;jjo@irrigacion.gov.ar&gt;</span>
<span class="c"># Lightly reformatted by ABS Guide author.</span>
<span class="c"># License: GPLv2</span>
<span class="c"># Used in ABS Guide with author&#39;s permission (thanks!).</span>
<span class="c">#</span>
<span class="c"># Test with:   ./insertion-sort.bash -t</span>
<span class="c"># Or:          bash insertion-sort.bash -t</span>
<span class="c"># The following *doesn&#39;t* work:</span>
<span class="c">#              sh insertion-sort.bash -t</span>
<span class="c">#  Why not? Hint: which Bash-specific features are disabled</span>
<span class="c">#+ when running a script by &#39;sh script.sh&#39;?</span>
<span class="c">#</span>
: <span class="si">${</span><span class="nv">DEBUG</span><span class="p">:=0</span><span class="si">}</span>  <span class="c"># Debug, override with:  DEBUG=1 ./scriptname . . .</span>
<span class="c"># Parameter substitution -- set DEBUG to 0 if not previously set.</span>

<span class="c"># Global array: &quot;list&quot;</span>
<span class="nb">typeset</span> -a list
<span class="c"># Load whitespace-separated numbers from stdin.</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;-t&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
<span class="nv">DEBUG</span><span class="o">=</span>1
        <span class="nb">read</span> -a list &lt; &lt;<span class="o">(</span> od -Ad -w24 -t u2 /dev/urandom <span class="o">)</span> <span class="c"># Random list.</span>
<span class="c">#                    ^ ^  process substition</span>
<span class="k">else</span>
        <span class="nb">read</span> -a list
<span class="k">fi</span>
<span class="nv">numelem</span><span class="o">=</span><span class="si">${#</span><span class="nv">list</span><span class="p">[*]</span><span class="si">}</span>

<span class="c">#  Shows the list, marking the element whose index is $1</span>
<span class="c">#+ by surrounding it with the two chars passed as $2.</span>
<span class="c">#  Whole line prefixed with $3.</span>
showlist<span class="o">()</span>
  <span class="o">{</span>
  <span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$3</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">list</span><span class="p">[@]:</span><span class="nv">0</span><span class="p">:</span><span class="nv">$1</span><span class="si">}</span> <span class="si">${</span><span class="nv">2</span><span class="p">:</span><span class="nv">0</span><span class="p">:</span><span class="nv">1</span><span class="si">}${</span><span class="nv">list</span><span class="p">[</span><span class="nv">$1</span><span class="p">]</span><span class="si">}${</span><span class="nv">2</span><span class="p">:</span><span class="nv">1</span><span class="p">:</span><span class="nv">1</span><span class="si">}</span> <span class="si">${</span><span class="nv">list</span><span class="p">[@]:</span><span class="nv">$1</span><span class="p">+1</span><span class="si">}</span><span class="p">;</span>
  <span class="o">}</span>

<span class="c"># Loop _pivot_ -- from second element to end of list.</span>
<span class="k">for</span><span class="o">((</span> <span class="nv">i</span><span class="o">=</span>1<span class="p">;</span> i&lt;numelem<span class="p">;</span> i++ <span class="o">))</span> <span class="k">do</span>
        <span class="o">((</span>DEBUG<span class="o">))&amp;&amp;</span>showlist i <span class="s2">&quot;[]&quot;</span> <span class="s2">&quot; &quot;</span>
        <span class="c"># From current _pivot_, back to first element.</span>
        <span class="k">for</span><span class="o">((</span> <span class="nv">j</span><span class="o">=</span>i<span class="p">;</span> j<span class="p">;</span> j-- <span class="o">))</span> <span class="k">do</span>
                <span class="c"># Search for the 1st elem. less than current &quot;pivot&quot; . . .</span>
                <span class="o">[[</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">list</span><span class="p">[j-1]</span><span class="si">}</span><span class="s2">&quot;</span> -le <span class="s2">&quot;</span><span class="si">${</span><span class="nv">list</span><span class="p">[i]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nb">break</span>
<span class="nb">        </span><span class="k">done</span>
    <span class="o">((</span> <span class="nv">i</span><span class="o">==</span>j <span class="o">))</span> <span class="o">&amp;&amp;</span> <span class="k">continue</span> <span class="c">## No insertion was needed for this element.</span>
    <span class="c"># . . . Move list[i] (pivot) to the left of list[j]:</span>
        <span class="nv">list</span><span class="o">=(</span><span class="si">${</span><span class="nv">list</span><span class="p">[@]:</span><span class="nv">0</span><span class="p">:</span><span class="nv">j</span><span class="si">}</span> <span class="si">${</span><span class="nv">list</span><span class="p">[i]</span><span class="si">}</span> <span class="si">${</span><span class="nv">list</span><span class="p">[j]</span><span class="si">}</span><span class="se">\</span>
    <span class="c">#         {0,j-1}        {i}       {j}</span>
              <span class="si">${</span><span class="nv">list</span><span class="p">[@]:</span><span class="nv">j</span><span class="p">+1:</span><span class="nv">i</span><span class="p">-(j+1)</span><span class="si">}</span> <span class="si">${</span><span class="nv">list</span><span class="p">[@]:</span><span class="nv">i</span><span class="p">+1</span><span class="si">}</span><span class="o">)</span>
    <span class="c">#         {j+1,i-1}              {i+1,last}</span>
    <span class="o">((</span>DEBUG<span class="o">))&amp;&amp;</span>showlist j <span class="s2">&quot;&lt;&gt;&quot;</span> <span class="s2">&quot;*&quot;</span>
<span class="k">done</span>


<span class="nb">echo</span>
<span class="nb">echo</span>  <span class="s2">&quot;------&quot;</span>
<span class="nb">echo</span> <span class="s1">$&#39;Result:\n&#39;</span><span class="si">${</span><span class="nv">list</span><span class="p">[@]</span><span class="si">}</span>

<span class="nb">exit</span> <span class="nv">$?</span>
</pre></div>
</div>
</div>
<div class="section" id="exemple-37-standard-deviation">
<h2>Exemple 37. Standard Deviation<a class="headerlink" href="#exemple-37-standard-deviation" title="Link permanent a aquest títol">¶</a></h2>
<div class="highlight-sh"><div class="highlight"><pre><span class="c">#!/bin/bash</span>
<span class="c"># sd.sh: Standard Deviation</span>

<span class="c">#  The Standard Deviation indicates how consistent a set of data is.</span>
<span class="c">#  It shows to what extent the individual data points deviate from the</span>
<span class="c">#+ arithmetic mean, i.e., how much they &quot;bounce around&quot; (or cluster).</span>
<span class="c">#  It is essentially the average deviation-distance of the</span>
<span class="c">#+ data points from the mean.</span>

<span class="c"># =========================================================== #</span>
<span class="c">#    To calculate the Standard Deviation:</span>
<span class="c">#</span>
<span class="c"># 1  Find the arithmetic mean (average) of all the data points.</span>
<span class="c"># 2  Subtract each data point from the arithmetic mean,</span>
<span class="c">#    and square that difference.</span>
<span class="c"># 3  Add all of the individual difference-squares in # 2.</span>
<span class="c"># 4  Divide the sum in # 3 by the number of data points.</span>
<span class="c">#    This is known as the &quot;variance.&quot;</span>
<span class="c"># 5  The square root of # 4 gives the Standard Deviation.</span>
<span class="c"># =========================================================== #</span>

<span class="nv">count</span><span class="o">=</span><span class="m">0</span>         <span class="c"># Number of data points; global.</span>
<span class="nv">SC</span><span class="o">=</span><span class="m">9</span>            <span class="c"># Scale to be used by bc. Nine decimal places.</span>
<span class="nv">E_DATAFILE</span><span class="o">=</span><span class="m">90</span>   <span class="c"># Data file error.</span>

<span class="c"># ----------------- Set data file ---------------------</span>
<span class="k">if</span> <span class="o">[</span> ! -z <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> <span class="o">]</span>  <span class="c"># Specify filename as cmd-line arg?</span>
<span class="k">then</span>
  <span class="nv">datafile</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> <span class="c">#  ASCII text file,</span>
<span class="k">else</span>            <span class="c">#+ one (numerical) data point per line!</span>
  <span class="nv">datafile</span><span class="o">=</span>sample.dat
<span class="k">fi</span>              <span class="c">#  See example data file, below.</span>

<span class="k">if</span> <span class="o">[</span> ! -e <span class="s2">&quot;</span><span class="nv">$datafile</span><span class="s2">&quot;</span> <span class="o">]</span>
<span class="k">then</span>
  <span class="nb">echo</span> <span class="s2">&quot;\&quot;&quot;</span><span class="nv">$datafile</span><span class="s2">&quot;\&quot; does not exist!&quot;</span>
  <span class="nb">exit</span> <span class="nv">$E_DATAFILE</span>
<span class="k">fi</span>
<span class="c"># -----------------------------------------------------</span>


arith_mean <span class="o">()</span>
<span class="o">{</span>
  <span class="nb">local </span><span class="nv">rt</span><span class="o">=</span><span class="m">0</span>         <span class="c"># Running total.</span>
  <span class="nb">local </span><span class="nv">am</span><span class="o">=</span><span class="m">0</span>         <span class="c"># Arithmetic mean.</span>
  <span class="nb">local </span><span class="nv">ct</span><span class="o">=</span><span class="m">0</span>         <span class="c"># Number of data points.</span>

  <span class="k">while</span> <span class="nb">read </span>value   <span class="c"># Read one data point at a time.</span>
  <span class="k">do</span>
    <span class="nv">rt</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&quot;scale=</span><span class="nv">$SC</span><span class="s2">; </span><span class="nv">$rt</span><span class="s2"> + </span><span class="nv">$value</span><span class="s2">&quot;</span>bc<span class="k">)</span>
    <span class="o">((</span> ct++ <span class="o">))</span>
  <span class="k">done</span>

  <span class="nv">am</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&quot;scale=</span><span class="nv">$SC</span><span class="s2">; </span><span class="nv">$rt</span><span class="s2"> / </span><span class="nv">$ct</span><span class="s2">&quot;</span>bc<span class="k">)</span>

  <span class="nb">echo</span> <span class="nv">$am</span><span class="p">;</span> <span class="k">return</span> <span class="nv">$ct</span>   <span class="c"># This function &quot;returns&quot; TWO values!</span>
  <span class="c">#  Caution: This little trick will not work if $ct &gt; 255!</span>
  <span class="c">#  To handle a larger number of data points,</span>
  <span class="c">#+ simply comment out the &quot;return $ct&quot; above.</span>
<span class="o">}</span> &lt;<span class="s2">&quot;</span><span class="nv">$datafile</span><span class="s2">&quot;</span>   <span class="c"># Feed in data file.</span>

sd <span class="o">()</span>
<span class="o">{</span>
  <span class="nv">mean1</span><span class="o">=</span><span class="nv">$1</span>  <span class="c"># Arithmetic mean (passed to function).</span>
  <span class="nv">n</span><span class="o">=</span><span class="nv">$2</span>      <span class="c"># How many data points.</span>
  <span class="nv">sum2</span><span class="o">=</span><span class="m">0</span>    <span class="c"># Sum of squared differences (&quot;variance&quot;).</span>
  <span class="nv">avg2</span><span class="o">=</span><span class="m">0</span>    <span class="c"># Average of $sum2.</span>
  <span class="nv">sdev</span><span class="o">=</span><span class="m">0</span>    <span class="c"># Standard Deviation.</span>

  <span class="k">while</span> <span class="nb">read </span>value   <span class="c"># Read one line at a time.</span>
  <span class="k">do</span>
    <span class="nv">diff</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&quot;scale=</span><span class="nv">$SC</span><span class="s2">; </span><span class="nv">$mean1</span><span class="s2"> - </span><span class="nv">$value</span><span class="s2">&quot;</span>bc<span class="k">)</span>
    <span class="c"># Difference between arith. mean and data point.</span>
    <span class="nv">dif2</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&quot;scale=</span><span class="nv">$SC</span><span class="s2">; </span><span class="nv">$diff</span><span class="s2"> * </span><span class="nv">$diff</span><span class="s2">&quot;</span>bc<span class="k">)</span> <span class="c"># Squared.</span>
    <span class="nv">sum2</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&quot;scale=</span><span class="nv">$SC</span><span class="s2">; </span><span class="nv">$sum2</span><span class="s2"> + </span><span class="nv">$dif2</span><span class="s2">&quot;</span>bc<span class="k">)</span> <span class="c"># Sum of squares.</span>
  <span class="k">done</span>

    <span class="nv">avg2</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&quot;scale=</span><span class="nv">$SC</span><span class="s2">; </span><span class="nv">$sum2</span><span class="s2"> / </span><span class="nv">$n</span><span class="s2">&quot;</span>bc<span class="k">)</span>  <span class="c"># Avg. of sum of squares.</span>
    <span class="nv">sdev</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&quot;scale=</span><span class="nv">$SC</span><span class="s2">; sqrt(</span><span class="nv">$avg2</span><span class="s2">)&quot;</span>bc<span class="k">)</span> <span class="c"># Square root =</span>
    <span class="nb">echo</span> <span class="nv">$sdev</span>                                 <span class="c"># Standard Deviation.</span>

<span class="o">}</span> &lt;<span class="s2">&quot;</span><span class="nv">$datafile</span><span class="s2">&quot;</span>   <span class="c"># Rewinds data file.</span>


<span class="c"># ======================================================= #</span>
<span class="nv">mean</span><span class="o">=</span><span class="k">$(</span>arith_mean<span class="k">)</span><span class="p">;</span> <span class="nv">count</span><span class="o">=</span><span class="nv">$?</span>   <span class="c"># Two returns from function!</span>
<span class="nv">std_dev</span><span class="o">=</span><span class="k">$(</span>sd <span class="nv">$mean</span> <span class="nv">$count</span><span class="k">)</span>

<span class="nb">echo</span>
<span class="nb">echo</span> <span class="s2">&quot;Number of data points in \&quot;&quot;</span><span class="nv">$datafile</span><span class="s2">&quot;\&quot; = </span><span class="nv">$count</span><span class="s2">&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;Arithmetic mean (average) = </span><span class="nv">$mean</span><span class="s2">&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;Standard Deviation = </span><span class="nv">$std_dev</span><span class="s2">&quot;</span>
<span class="nb">echo</span>
<span class="c"># ======================================================= #</span>

<span class="nb">exit</span>

<span class="c">#  This script could stand some drastic streamlining,</span>
<span class="c">#+ but not at the cost of reduced legibility, please.</span>


<span class="c"># ++++++++++++++++++++++++++++++++++++++++ #</span>
<span class="c"># A sample data file (sample1.dat):</span>

<span class="c"># 18.35</span>
<span class="c"># 19.0</span>
<span class="c"># 18.88</span>
<span class="c"># 18.91</span>
<span class="c"># 18.64</span>


<span class="c"># $ sh sd.sh sample1.dat</span>

<span class="c"># Number of data points in &quot;sample1.dat&quot; = 5</span>
<span class="c"># Arithmetic mean (average) = 18.756000000</span>
<span class="c"># Standard Deviation = .235338054</span>
<span class="c"># ++++++++++++++++++++++++++++++++++++++++ #</span>
</pre></div>
</div>
</div>
<div class="section" id="exemple-38-a-pad-file-generator-for-shareware-authors">
<h2>Exemple 38. A <em>pad</em> file generator for shareware authors<a class="headerlink" href="#exemple-38-a-pad-file-generator-for-shareware-authors" title="Link permanent a aquest títol">¶</a></h2>
<div class="highlight-sh"><div class="highlight"><pre><span class="c">#!/bin/bash</span>
<span class="c"># pad.sh</span>

<span class="c">#######################################################</span>
<span class="c">#               PAD (xml) file creator</span>
<span class="c">#+ Written by Mendel Cooper &lt;thegrendel.abs@gmail.com&gt;.</span>
<span class="c">#+ Released to the Public Domain.</span>
<span class="c">#</span>
<span class="c">#  Generates a &quot;PAD&quot; descriptor file for shareware</span>
<span class="c">#+ packages, according to the specifications</span>
<span class="c">#+ of the ASP.</span>
<span class="c">#  http://www.asp-shareware.org/pad</span>
<span class="c">#######################################################</span>


<span class="c"># Accepts (optional) save filename as a command-line argument.</span>
<span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> <span class="o">]</span>
<span class="k">then</span>
  <span class="nv">savefile</span><span class="o">=</span><span class="nv">$1</span>
<span class="k">else</span>
  <span class="nv">savefile</span><span class="o">=</span>save_file.xml               <span class="c"># Default save_file name.</span>
<span class="k">fi</span>


<span class="c"># ===== PAD file headers =====</span>
<span class="nv">HDR1</span><span class="o">=</span><span class="s2">&quot;&lt;?xml version=\&quot;1.0\&quot; encoding=\&quot;Windows-1252\&quot; ?&gt;&quot;</span>
<span class="nv">HDR2</span><span class="o">=</span><span class="s2">&quot;&lt;XML_DIZ_INFO&gt;&quot;</span>
<span class="nv">HDR3</span><span class="o">=</span><span class="s2">&quot;&lt;MASTER_PAD_VERSION_INFO&gt;&quot;</span>
<span class="nv">HDR4</span><span class="o">=</span><span class="s2">&quot;\t&lt;MASTER_PAD_VERSION&gt;1.15&lt;/MASTER_PAD_VERSION&gt;&quot;</span>
<span class="nv">HDR5</span><span class="o">=</span><span class="s2">&quot;\t&lt;MASTER_PAD_INFO&gt;Portable Application Description, or PAD</span>
<span class="s2">for short, is a data set that is used by shareware authors to</span>
<span class="s2">disseminate information to anyone interested in their software products.</span>
<span class="s2">To find out more go to http://www.asp-shareware.org/pad&lt;/MASTER_PAD_INFO&gt;&quot;</span>
<span class="nv">HDR6</span><span class="o">=</span><span class="s2">&quot;&lt;/MASTER_PAD_VERSION_INFO&gt;&quot;</span>
<span class="c"># ============================</span>


fill_in <span class="o">()</span>
<span class="o">{</span>
  <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$2</span><span class="s2">&quot;</span> <span class="o">]</span>
  <span class="k">then</span>
    <span class="nb">echo</span> -n <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">? &quot;</span>     <span class="c"># Get user input.</span>
  <span class="k">else</span>
    <span class="nb">echo</span> -n <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2"> </span><span class="nv">$2</span><span class="s2">? &quot;</span>  <span class="c"># Additional query?</span>
  <span class="k">fi</span>

  <span class="nb">read </span>var             <span class="c"># May paste to fill in field.</span>
                       <span class="c"># This shows how flexible &quot;read&quot; can be.</span>

  <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$var</span><span class="s2">&quot;</span> <span class="o">]</span>
  <span class="k">then</span>
    <span class="nb">echo</span> -e <span class="s2">&quot;\t\t&lt;</span><span class="nv">$1</span><span class="s2"> /&gt;&quot;</span> &gt;&gt;<span class="nv">$savefile</span>    <span class="c"># Indent with 2 tabs.</span>
    <span class="k">return</span>
  <span class="k">else</span>
    <span class="nb">echo</span> -e <span class="s2">&quot;\t\t&lt;</span><span class="nv">$1</span><span class="s2">&gt;</span><span class="nv">$var</span><span class="s2">&lt;/</span><span class="nv">$1</span><span class="s2">&gt;&quot;</span> &gt;&gt;<span class="nv">$savefile</span>
    <span class="k">return</span> <span class="si">${#</span><span class="nv">var</span><span class="si">}</span>     <span class="c"># Return length of input string.</span>
  <span class="k">fi</span>
<span class="o">}</span>

check_field_length <span class="o">()</span>  <span class="c"># Check length of program description fields.</span>
<span class="o">{</span>
  <span class="c"># $1 = maximum field length</span>
  <span class="c"># $2 = actual field length</span>
  <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$2</span><span class="s2">&quot;</span> -gt <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> <span class="o">]</span>
  <span class="k">then</span>
    <span class="nb">echo</span> <span class="s2">&quot;Warning: Maximum field length of </span><span class="nv">$1</span><span class="s2"> characters exceeded!&quot;</span>
  <span class="k">fi</span>
<span class="o">}</span>

clear                  <span class="c"># Clear screen.</span>
<span class="nb">echo</span> <span class="s2">&quot;PAD File Creator&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;--- ---- -------&quot;</span>
<span class="nb">echo</span>

<span class="c"># Write File Headers to file.</span>
<span class="nb">echo</span> <span class="nv">$HDR1</span> &gt;<span class="nv">$savefile</span>
<span class="nb">echo</span> <span class="nv">$HDR2</span> &gt;&gt;<span class="nv">$savefile</span>
<span class="nb">echo</span> <span class="nv">$HDR3</span> &gt;&gt;<span class="nv">$savefile</span>
<span class="nb">echo</span> -e <span class="nv">$HDR4</span> &gt;&gt;<span class="nv">$savefile</span>
<span class="nb">echo</span> -e <span class="nv">$HDR5</span> &gt;&gt;<span class="nv">$savefile</span>
<span class="nb">echo</span> <span class="nv">$HDR6</span> &gt;&gt;<span class="nv">$savefile</span>


<span class="c"># Company_Info</span>
<span class="nb">echo</span> <span class="s2">&quot;COMPANY INFO&quot;</span>
<span class="nv">CO_HDR</span><span class="o">=</span><span class="s2">&quot;Company_Info&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;&lt;</span><span class="nv">$CO_HDR</span><span class="s2">&gt;&quot;</span> &gt;&gt;<span class="nv">$savefile</span>

fill_in Company_Name
fill_in Address_1
fill_in Address_2
fill_in City_Town
fill_in State_Province
fill_in Zip_Postal_Code
fill_in Country

<span class="c"># If applicable:</span>
<span class="c"># fill_in ASP_Member &quot;[Y/N]&quot;</span>
<span class="c"># fill_in ASP_Member_Number</span>
<span class="c"># fill_in ESC_Member &quot;[Y/N]&quot;</span>

fill_in Company_WebSite_URL

clear   <span class="c"># Clear screen between sections.</span>

   <span class="c"># Contact_Info</span>
<span class="nb">echo</span> <span class="s2">&quot;CONTACT INFO&quot;</span>
<span class="nv">CONTACT_HDR</span><span class="o">=</span><span class="s2">&quot;Contact_Info&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;&lt;</span><span class="nv">$CONTACT_HDR</span><span class="s2">&gt;&quot;</span> &gt;&gt;<span class="nv">$savefile</span>
fill_in Author_First_Name
fill_in Author_Last_Name
fill_in Author_Email
fill_in Contact_First_Name
fill_in Contact_Last_Name
fill_in Contact_Email
<span class="nb">echo</span> -e <span class="s2">&quot;\t&lt;/</span><span class="nv">$CONTACT_HDR</span><span class="s2">&gt;&quot;</span> &gt;&gt;<span class="nv">$savefile</span>
   <span class="c"># END Contact_Info</span>

clear

   <span class="c"># Support_Info</span>
<span class="nb">echo</span> <span class="s2">&quot;SUPPORT INFO&quot;</span>
<span class="nv">SUPPORT_HDR</span><span class="o">=</span><span class="s2">&quot;Support_Info&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;&lt;</span><span class="nv">$SUPPORT_HDR</span><span class="s2">&gt;&quot;</span> &gt;&gt;<span class="nv">$savefile</span>
fill_in Sales_Email
fill_in Support_Email
fill_in General_Email
fill_in Sales_Phone
fill_in Support_Phone
fill_in General_Phone
fill_in Fax_Phone
<span class="nb">echo</span> -e <span class="s2">&quot;\t&lt;/</span><span class="nv">$SUPPORT_HDR</span><span class="s2">&gt;&quot;</span> &gt;&gt;<span class="nv">$savefile</span>
   <span class="c"># END Support_Info</span>

<span class="nb">echo</span> <span class="s2">&quot;&lt;/</span><span class="nv">$CO_HDR</span><span class="s2">&gt;&quot;</span> &gt;&gt;<span class="nv">$savefile</span>
<span class="c"># END Company_Info</span>

clear

<span class="c"># Program_Info</span>
<span class="nb">echo</span> <span class="s2">&quot;PROGRAM INFO&quot;</span>
<span class="nv">PROGRAM_HDR</span><span class="o">=</span><span class="s2">&quot;Program_Info&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;&lt;</span><span class="nv">$PROGRAM_HDR</span><span class="s2">&gt;&quot;</span> &gt;&gt;<span class="nv">$savefile</span>
fill_in Program_Name
fill_in Program_Version
fill_in Program_Release_Month
fill_in Program_Release_Day
fill_in Program_Release_Year
fill_in Program_Cost_Dollars
fill_in Program_Cost_Other
fill_in Program_Type <span class="s2">&quot;[Shareware/Freeware/GPL]&quot;</span>
fill_in Program_Release_Status <span class="s2">&quot;[Beta, Major Upgrade, etc.]&quot;</span>
fill_in Program_Install_Support
fill_in Program_OS_Support <span class="s2">&quot;[Win9x/Win2k/Linux/etc.]&quot;</span>
fill_in Program_Language <span class="s2">&quot;[English/Spanish/etc.]&quot;</span>

<span class="nb">echo</span><span class="p">;</span> <span class="nb">echo</span>

  <span class="c"># File_Info</span>
<span class="nb">echo</span> <span class="s2">&quot;FILE INFO&quot;</span>
<span class="nv">FILEINFO_HDR</span><span class="o">=</span><span class="s2">&quot;File_Info&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;&lt;</span><span class="nv">$FILEINFO_HDR</span><span class="s2">&gt;&quot;</span> &gt;&gt;<span class="nv">$savefile</span>
fill_in Filename_Versioned
fill_in Filename_Previous
fill_in Filename_Generic
fill_in Filename_Long
fill_in File_Size_Bytes
fill_in File_Size_K
fill_in File_Size_MB
<span class="nb">echo</span> -e <span class="s2">&quot;\t&lt;/</span><span class="nv">$FILEINFO_HDR</span><span class="s2">&gt;&quot;</span> &gt;&gt;<span class="nv">$savefile</span>
  <span class="c"># END File_Info</span>

clear

  <span class="c"># Expire_Info</span>
<span class="nb">echo</span> <span class="s2">&quot;EXPIRE INFO&quot;</span>
<span class="nv">EXPIRE_HDR</span><span class="o">=</span><span class="s2">&quot;Expire_Info&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;&lt;</span><span class="nv">$EXPIRE_HDR</span><span class="s2">&gt;&quot;</span> &gt;&gt;<span class="nv">$savefile</span>
fill_in Has_Expire_Info <span class="s2">&quot;Y/N&quot;</span>
fill_in Expire_Count
fill_in Expire_Based_On
fill_in Expire_Other_Info
fill_in Expire_Month
fill_in Expire_Day
fill_in Expire_Year
<span class="nb">echo</span> -e <span class="s2">&quot;\t&lt;/</span><span class="nv">$EXPIRE_HDR</span><span class="s2">&gt;&quot;</span> &gt;&gt;<span class="nv">$savefile</span>
  <span class="c"># END Expire_Info</span>

clear

  <span class="c"># More Program_Info</span>
<span class="nb">echo</span> <span class="s2">&quot;ADDITIONAL PROGRAM INFO&quot;</span>
fill_in Program_Change_Info
fill_in Program_Specific_Category
fill_in Program_Categories
fill_in Includes_JAVA_VM <span class="s2">&quot;[Y/N]&quot;</span>
fill_in Includes_VB_Runtime <span class="s2">&quot;[Y/N]&quot;</span>
fill_in Includes_DirectX <span class="s2">&quot;[Y/N]&quot;</span>
  <span class="c"># END More Program_Info</span>

<span class="nb">echo</span> <span class="s2">&quot;&lt;/</span><span class="nv">$PROGRAM_HDR</span><span class="s2">&gt;&quot;</span> &gt;&gt;<span class="nv">$savefile</span>
<span class="c"># END Program_Info</span>

clear

<span class="c"># Program Description</span>
<span class="nb">echo</span> <span class="s2">&quot;PROGRAM DESCRIPTIONS&quot;</span>
<span class="nv">PROGDESC_HDR</span><span class="o">=</span><span class="s2">&quot;Program_Descriptions&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;&lt;</span><span class="nv">$PROGDESC_HDR</span><span class="s2">&gt;&quot;</span> &gt;&gt;<span class="nv">$savefile</span>

<span class="nv">LANG</span><span class="o">=</span><span class="s2">&quot;English&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;&lt;</span><span class="nv">$LANG</span><span class="s2">&gt;&quot;</span> &gt;&gt;<span class="nv">$savefile</span>

fill_in Keywords <span class="s2">&quot;[comma + space separated]&quot;</span>
<span class="nb">echo</span>
<span class="nb">echo</span> <span class="s2">&quot;45, 80, 250, 450, 2000 word program descriptions&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;(may cut and paste into field)&quot;</span>
<span class="c">#  It would be highly appropriate to compose the following</span>
<span class="c">#+ &quot;Char_Desc&quot; fields with a text editor,</span>
<span class="c">#+ then cut-and-paste the text into the answer fields.</span>
<span class="nb">echo</span>
<span class="nb">echo</span> <span class="s2">&quot;              |---------------45 characters---------------|&quot;</span>
fill_in Char_Desc_45
check_field_length <span class="m">45</span> <span class="s2">&quot;</span><span class="nv">$?</span><span class="s2">&quot;</span>
<span class="nb">echo</span>
fill_in Char_Desc_80
check_field_length <span class="m">80</span> <span class="s2">&quot;</span><span class="nv">$?</span><span class="s2">&quot;</span>

fill_in Char_Desc_250
check_field_length <span class="m">250</span> <span class="s2">&quot;</span><span class="nv">$?</span><span class="s2">&quot;</span>

fill_in Char_Desc_450
fill_in Char_Desc_2000

<span class="nb">echo</span> <span class="s2">&quot;&lt;/</span><span class="nv">$LANG</span><span class="s2">&gt;&quot;</span> &gt;&gt;<span class="nv">$savefile</span>
<span class="nb">echo</span> <span class="s2">&quot;&lt;/</span><span class="nv">$PROGDESC_HDR</span><span class="s2">&gt;&quot;</span> &gt;&gt;<span class="nv">$savefile</span>
<span class="c"># END Program Description</span>

clear
<span class="nb">echo</span> <span class="s2">&quot;Done.&quot;</span><span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="nb">echo</span>
<span class="nb">echo</span> <span class="s2">&quot;Save file is:  \&quot;&quot;</span><span class="nv">$savefile</span><span class="s2">&quot;\&quot;&quot;</span>

<span class="nb">exit </span>0
</pre></div>
</div>
</div>
<div class="section" id="exemple-39-a-man-page-editor">
<h2>Exemple 39. A <em>man page</em> editor<a class="headerlink" href="#exemple-39-a-man-page-editor" title="Link permanent a aquest títol">¶</a></h2>
<div class="highlight-sh"><div class="highlight"><pre><span class="c">#!/bin/bash</span>
<span class="c"># maned.sh</span>
<span class="c"># A rudimentary man page editor</span>

<span class="c"># Version: 0.1 (Alpha, probably buggy)</span>
<span class="c"># Author: Mendel Cooper &lt;thegrendel.abs@gmail.com&gt;</span>
<span class="c"># Reldate: 16 June 2008</span>
<span class="c"># License: GPL3</span>


<span class="nv">savefile</span><span class="o">=</span>      <span class="c"># Global, used in multiple functions.</span>
<span class="nv">E_NOINPUT</span><span class="o">=</span><span class="m">90</span>   <span class="c"># User input missing (error). May or may not be critical.</span>

<span class="c"># =========== Markup Tags ============ #</span>
<span class="nv">TopHeader</span><span class="o">=</span><span class="s2">&quot;.TH&quot;</span>
<span class="nv">NameHeader</span><span class="o">=</span><span class="s2">&quot;.SH NAME&quot;</span>
<span class="nv">SyntaxHeader</span><span class="o">=</span><span class="s2">&quot;.SH SYNTAX&quot;</span>
<span class="nv">SynopsisHeader</span><span class="o">=</span><span class="s2">&quot;.SH SYNOPSIS&quot;</span>
<span class="nv">InstallationHeader</span><span class="o">=</span><span class="s2">&quot;.SH INSTALLATION&quot;</span>
<span class="nv">DescHeader</span><span class="o">=</span><span class="s2">&quot;.SH DESCRIPTION&quot;</span>
<span class="nv">OptHeader</span><span class="o">=</span><span class="s2">&quot;.SH OPTIONS&quot;</span>
<span class="nv">FilesHeader</span><span class="o">=</span><span class="s2">&quot;.SH FILES&quot;</span>
<span class="nv">EnvHeader</span><span class="o">=</span><span class="s2">&quot;.SH ENVIRONMENT&quot;</span>
<span class="nv">AuthHeader</span><span class="o">=</span><span class="s2">&quot;.SH AUTHOR&quot;</span>
<span class="nv">BugsHeader</span><span class="o">=</span><span class="s2">&quot;.SH BUGS&quot;</span>
<span class="nv">SeeAlsoHeader</span><span class="o">=</span><span class="s2">&quot;.SH SEE ALSO&quot;</span>
<span class="nv">BOLD</span><span class="o">=</span><span class="s2">&quot;.B&quot;</span>
<span class="c"># Add more tags, as needed.</span>
<span class="c"># See groff docs for markup meanings.</span>
<span class="c"># ==================================== #</span>

start <span class="o">()</span>
<span class="o">{</span>
clear                  <span class="c"># Clear screen.</span>
<span class="nb">echo</span> <span class="s2">&quot;ManEd&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;-----&quot;</span>
<span class="nb">echo</span>
<span class="nb">echo</span> <span class="s2">&quot;Simple man page creator&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;Author: Mendel Cooper&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;License: GPL3&quot;</span>
<span class="nb">echo</span><span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="nb">echo</span>
<span class="o">}</span>

progname <span class="o">()</span>
<span class="o">{</span>
  <span class="nb">echo</span> -n <span class="s2">&quot;Program name? &quot;</span>
  <span class="nb">read </span>name

  <span class="nb">echo</span> -n <span class="s2">&quot;Manpage section? [Hit RETURN for default (\&quot;1\&quot;) ]  &quot;</span>
  <span class="nb">read </span>section
  <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$section</span><span class="s2">&quot;</span> <span class="o">]</span>
  <span class="k">then</span>
    <span class="nv">section</span><span class="o">=</span><span class="m">1</span>   <span class="c"># Most man pages are in section 1.</span>
  <span class="k">fi</span>

  <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;</span><span class="nv">$name</span><span class="s2">&quot;</span> <span class="o">]</span>
  <span class="k">then</span>
    <span class="nv">savefile</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="nv">$name</span><span class="s2">&quot;.&quot;</span><span class="nv">$section</span><span class="s2">&quot;&quot;</span>       <span class="c">#  Filename suffix = section.</span>
    <span class="nb">echo</span> -n <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2"> &quot;</span> &gt;&gt;<span class="nv">$savefile</span>
    <span class="nv">name1</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$name</span><span class="s2">&quot;</span>tr a-z A-Z<span class="k">)</span>  <span class="c">#  Change to uppercase,</span>
                                        <span class="c">#+ per man page convention.</span>
    <span class="nb">echo</span> -n <span class="s2">&quot;</span><span class="nv">$name1</span><span class="s2">&quot;</span> &gt;&gt;<span class="nv">$savefile</span>
  <span class="k">else</span>
    <span class="nb">echo</span> <span class="s2">&quot;Error! No input.&quot;</span>             <span class="c"># Mandatory input.</span>
    <span class="nb">exit</span> <span class="nv">$E_NOINPUT</span>                     <span class="c"># Critical!</span>
    <span class="c">#  Exercise: The script-abort if no filename input is a bit clumsy.</span>
    <span class="c">#            Rewrite this section so a default filename is used</span>
    <span class="c">#+           if no input.</span>
  <span class="k">fi</span>

  <span class="nb">echo</span> -n <span class="s2">&quot;  \&quot;</span><span class="nv">$section</span><span class="s2">\&quot;&quot;</span>&gt;&gt;<span class="nv">$savefile</span>   <span class="c"># Append, always append.</span>

  <span class="nb">echo</span> -n <span class="s2">&quot;Version? &quot;</span>
  <span class="nb">read </span>ver
  <span class="nb">echo</span> -n <span class="s2">&quot; \&quot;Version </span><span class="nv">$ver</span><span class="s2"> \&quot;&quot;</span>&gt;&gt;<span class="nv">$savefile</span>
  <span class="nb">echo</span> &gt;&gt;<span class="nv">$savefile</span>

  <span class="nb">echo</span> -n <span class="s2">&quot;Short description [0 - 5 words]? &quot;</span>
  <span class="nb">read </span>sdesc
  <span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$NameHeader</span><span class="s2">&quot;</span>&gt;&gt;<span class="nv">$savefile</span>
  <span class="nb">echo</span> <span class="s2">&quot;&quot;</span><span class="nv">$BOLD</span><span class="s2">&quot; &quot;</span><span class="nv">$name</span><span class="s2">&quot;&quot;</span>&gt;&gt;<span class="nv">$savefile</span>
  <span class="nb">echo</span> <span class="s2">&quot;\- &quot;</span><span class="nv">$sdesc</span><span class="s2">&quot;&quot;</span>&gt;&gt;<span class="nv">$savefile</span>

<span class="o">}</span>

fill_in <span class="o">()</span>
<span class="o">{</span> <span class="c"># This function more or less copied from &quot;pad.sh&quot; script.</span>
  <span class="nb">echo</span> -n <span class="s2">&quot;</span><span class="nv">$2</span><span class="s2">? &quot;</span>       <span class="c"># Get user input.</span>
  <span class="nb">read </span>var             <span class="c"># May paste (a single line only!) to fill in field.</span>

  <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;</span><span class="nv">$var</span><span class="s2">&quot;</span> <span class="o">]</span>
  <span class="k">then</span>
    <span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2"> &quot;</span> &gt;&gt;<span class="nv">$savefile</span>
    <span class="nb">echo</span> -n <span class="s2">&quot;</span><span class="nv">$var</span><span class="s2">&quot;</span> &gt;&gt;<span class="nv">$savefile</span>
  <span class="k">else</span>                 <span class="c"># Don&#39;t append empty field to file.</span>
    <span class="k">return</span> <span class="nv">$E_NOINPUT</span>  <span class="c"># Not critical here.</span>
  <span class="k">fi</span>

  <span class="nb">echo</span> &gt;&gt;<span class="nv">$savefile</span>

<span class="o">}</span>


end <span class="o">()</span>
<span class="o">{</span>
clear
<span class="nb">echo</span> -n <span class="s2">&quot;Would you like to view the saved man page (y/n)? &quot;</span>
<span class="nb">read </span>ans
<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$ans</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;n&quot;</span> -o <span class="s2">&quot;</span><span class="nv">$ans</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;N&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span> <span class="nb">exit</span><span class="p">;</span> <span class="k">fi</span>
<span class="nb">exec </span>less <span class="s2">&quot;</span><span class="nv">$savefile</span><span class="s2">&quot;</span>  <span class="c">#  Exit script and hand off control to &quot;less&quot; ...</span>
                       <span class="c">#+ ... which formats for viewing man page source.</span>
<span class="o">}</span>


<span class="c"># ---------------------------------------- #</span>
start
progname <span class="s2">&quot;</span><span class="nv">$TopHeader</span><span class="s2">&quot;</span>
fill_in <span class="s2">&quot;</span><span class="nv">$SynopsisHeader</span><span class="s2">&quot;</span> <span class="s2">&quot;Synopsis&quot;</span>
fill_in <span class="s2">&quot;</span><span class="nv">$DescHeader</span><span class="s2">&quot;</span> <span class="s2">&quot;Long description&quot;</span>
<span class="c"># May paste in *single line* of text.</span>
fill_in <span class="s2">&quot;</span><span class="nv">$OptHeader</span><span class="s2">&quot;</span> <span class="s2">&quot;Options&quot;</span>
fill_in <span class="s2">&quot;</span><span class="nv">$FilesHeader</span><span class="s2">&quot;</span> <span class="s2">&quot;Files&quot;</span>
fill_in <span class="s2">&quot;</span><span class="nv">$AuthHeader</span><span class="s2">&quot;</span> <span class="s2">&quot;Author&quot;</span>
fill_in <span class="s2">&quot;</span><span class="nv">$BugsHeader</span><span class="s2">&quot;</span> <span class="s2">&quot;Bugs&quot;</span>
fill_in <span class="s2">&quot;</span><span class="nv">$SeeAlsoHeader</span><span class="s2">&quot;</span> <span class="s2">&quot;See also&quot;</span>
<span class="c"># fill_in &quot;$OtherHeader&quot; ... as necessary.</span>
end    <span class="c"># ... exit not needed.</span>
<span class="c"># ---------------------------------------- #</span>

<span class="c">#  Note that the generated man page will usually</span>
<span class="c">#+ require manual fine-tuning with a text editor.</span>
<span class="c">#  However, it&#39;s a distinct improvement upon</span>
<span class="c">#+ writing man source from scratch</span>
<span class="c">#+ or even editing a blank man page template.</span>

<span class="c">#  The main deficiency of the script is that it permits</span>
<span class="c">#+ pasting only a single text line into the input fields.</span>
<span class="c">#  This may be a long, cobbled-together line, which groff</span>
<span class="c">#  will automatically wrap and hyphenate.</span>
<span class="c">#  However, if you want multiple (newline-separated) paragraphs,</span>
<span class="c">#+ these must be inserted by manual text editing on the</span>
<span class="c">#+ script-generated man page.</span>
<span class="c">#  Exercise (difficult): Fix this!</span>

<span class="c">#  This script is not nearly as elaborate as the</span>
<span class="c">#+ full-featured &quot;manedit&quot; package</span>
<span class="c">#+ http://freshmeat.net/projects/manedit/</span>
<span class="c">#+ but it&#39;s much easier to use.</span>
</pre></div>
</div>
</div>
<div class="section" id="exemple-40-petals-around-the-rose">
<h2>Exemple 40. Petals Around the Rose<a class="headerlink" href="#exemple-40-petals-around-the-rose" title="Link permanent a aquest títol">¶</a></h2>
<div class="highlight-sh"><div class="highlight"><pre><span class="c">#!/bin/bash -i</span>
<span class="c"># petals.sh</span>

<span class="c">#########################################################################</span>
<span class="c"># Petals Around the Rose                                                #</span>
<span class="c">#                                                                       #</span>
<span class="c"># Version 0.1 Created by Serghey Rodin                                  #</span>
<span class="c"># Version 0.2 Modded by ABS Guide Author                                #</span>
<span class="c">#                                                                       #</span>
<span class="c"># License: GPL3                                                         #</span>
<span class="c"># Used in ABS Guide with permission.                                    #</span>
<span class="c"># ##################################################################### #</span>

<span class="nv">hits</span><span class="o">=</span><span class="m">0</span>      <span class="c"># Correct guesses.</span>
<span class="nv">WIN</span><span class="o">=</span><span class="m">6</span>       <span class="c"># Mastered the game.</span>
<span class="nv">ALMOST</span><span class="o">=</span><span class="m">5</span>    <span class="c"># One short of mastery.</span>
<span class="nv">EXIT</span><span class="o">=</span><span class="nb">exit</span>   <span class="c"># Give up early?</span>

<span class="nv">RANDOM</span><span class="o">=</span><span class="nv">$$</span>   <span class="c"># Seeds the random number generator from PID of script.</span>


<span class="c"># Bones (ASCII graphics for dice)</span>
bone1<span class="o">[</span>1<span class="o">]=</span><span class="s2">&quot;        |&quot;</span>
bone1<span class="o">[</span>2<span class="o">]=</span><span class="s2">&quot;      o |&quot;</span>
bone1<span class="o">[</span>3<span class="o">]=</span><span class="s2">&quot;      o |&quot;</span>
bone1<span class="o">[</span>4<span class="o">]=</span><span class="s2">&quot;o     o |&quot;</span>
bone1<span class="o">[</span>5<span class="o">]=</span><span class="s2">&quot;o     o |&quot;</span>
bone1<span class="o">[</span>6<span class="o">]=</span><span class="s2">&quot;o     o |&quot;</span>
bone2<span class="o">[</span>1<span class="o">]=</span><span class="s2">&quot;   o    |&quot;</span>
bone2<span class="o">[</span>2<span class="o">]=</span><span class="s2">&quot;        |&quot;</span>
bone2<span class="o">[</span>3<span class="o">]=</span><span class="s2">&quot;   o    |&quot;</span>
bone2<span class="o">[</span>4<span class="o">]=</span><span class="s2">&quot;        |&quot;</span>
bone2<span class="o">[</span>5<span class="o">]=</span><span class="s2">&quot;   o    |&quot;</span>
bone2<span class="o">[</span>6<span class="o">]=</span><span class="s2">&quot;o     o |&quot;</span>
bone3<span class="o">[</span>1<span class="o">]=</span><span class="s2">&quot;        |&quot;</span>
bone3<span class="o">[</span>2<span class="o">]=</span><span class="s2">&quot;o       |&quot;</span>
bone3<span class="o">[</span>3<span class="o">]=</span><span class="s2">&quot;o       |&quot;</span>
bone3<span class="o">[</span>4<span class="o">]=</span><span class="s2">&quot;o     o |&quot;</span>
bone3<span class="o">[</span>5<span class="o">]=</span><span class="s2">&quot;o     o |&quot;</span>
bone3<span class="o">[</span>6<span class="o">]=</span><span class="s2">&quot;o     o |&quot;</span>
<span class="nv">bone</span><span class="o">=</span><span class="s2">&quot;+---------+&quot;</span>



<span class="c"># Functions</span>

instructions <span class="o">()</span> <span class="o">{</span>

  clear
  <span class="nb">echo</span> -n <span class="s2">&quot;Do you need instructions? (y/n) &quot;</span><span class="p">;</span> <span class="nb">read </span>ans
  <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$ans</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;y&quot;</span> -o <span class="s2">&quot;</span><span class="nv">$ans</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;Y&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    clear
    <span class="nb">echo</span> -e <span class="s1">&#39;\E[34;47m&#39;</span>  <span class="c"># Blue type.</span>

<span class="c">#  &quot;cat document&quot;</span>
    cat <span class="s">&lt;&lt;INSTRUCTIONSZZZ</span>
<span class="s">The name of the game is Petals Around the Rose,</span>
<span class="s">and that name is significant.</span>
<span class="s">Five dice will roll and you must guess the &quot;answer&quot; for each roll.</span>
<span class="s">It will be zero or an even number.</span>
<span class="s">After your guess, you will be told the answer for the roll, but . . .</span>
<span class="s">that&#39;s ALL the information you will get.</span>

<span class="s">Six consecutive correct guesses admits you to the</span>
<span class="s">Fellowship of the Rose.</span>
<span class="s">INSTRUCTIONSZZZ</span>

    <span class="nb">echo</span> -e <span class="s2">&quot;\033[0m&quot;</span>    <span class="c"># Turn off blue.</span>
    <span class="k">else</span> clear
  <span class="k">fi</span>

<span class="o">}</span>


fortune <span class="o">()</span>
<span class="o">{</span>
  <span class="nv">RANGE</span><span class="o">=</span>7
  <span class="nv">FLOOR</span><span class="o">=</span>0
  <span class="nv">number</span><span class="o">=</span>0
  <span class="k">while</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$number</span><span class="s2">&quot;</span> -le <span class="nv">$FLOOR</span> <span class="o">]</span>
  <span class="k">do</span>
    <span class="nv">number</span><span class="o">=</span><span class="nv">$RANDOM</span>
    <span class="nb">let</span> <span class="s2">&quot;number %= </span><span class="nv">$RANGE</span><span class="s2">&quot;</span>   <span class="c"># 1 - 6.</span>
  <span class="k">done</span>

  <span class="k">return</span> <span class="nv">$number</span>
<span class="o">}</span>



throw <span class="o">()</span> <span class="o">{</span> <span class="c"># Calculate each individual die.</span>
  fortune<span class="p">;</span> <span class="nv">B1</span><span class="o">=</span><span class="nv">$?</span>
  fortune<span class="p">;</span> <span class="nv">B2</span><span class="o">=</span><span class="nv">$?</span>
  fortune<span class="p">;</span> <span class="nv">B3</span><span class="o">=</span><span class="nv">$?</span>
  fortune<span class="p">;</span> <span class="nv">B4</span><span class="o">=</span><span class="nv">$?</span>
  fortune<span class="p">;</span> <span class="nv">B5</span><span class="o">=</span><span class="nv">$?</span>

  calc <span class="o">()</span> <span class="o">{</span> <span class="c"># Function embedded within a function!</span>
    <span class="k">case</span> <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> in
       <span class="m">3</span>   <span class="o">)</span> <span class="nv">rose</span><span class="o">=</span>2<span class="p">;;</span>
       <span class="m">5</span>   <span class="o">)</span> <span class="nv">rose</span><span class="o">=</span>4<span class="p">;;</span>
       *   <span class="o">)</span> <span class="nv">rose</span><span class="o">=</span>0<span class="p">;;</span>
    <span class="k">esac</span>    <span class="c"># Simplified algorithm.</span>
            <span class="c"># Doesn&#39;t really get to the heart of the matter.</span>
    <span class="k">return</span> <span class="nv">$rose</span>
  <span class="o">}</span>

  <span class="nv">answer</span><span class="o">=</span>0
  calc <span class="s2">&quot;</span><span class="nv">$B1</span><span class="s2">&quot;</span><span class="p">;</span> <span class="nv">answer</span><span class="o">=</span><span class="k">$(</span>expr <span class="nv">$answer</span> + <span class="k">$(</span><span class="nb">echo</span> <span class="nv">$?</span><span class="k">))</span>
  calc <span class="s2">&quot;</span><span class="nv">$B2</span><span class="s2">&quot;</span><span class="p">;</span> <span class="nv">answer</span><span class="o">=</span><span class="k">$(</span>expr <span class="nv">$answer</span> + <span class="k">$(</span><span class="nb">echo</span> <span class="nv">$?</span><span class="k">))</span>
  calc <span class="s2">&quot;</span><span class="nv">$B3</span><span class="s2">&quot;</span><span class="p">;</span> <span class="nv">answer</span><span class="o">=</span><span class="k">$(</span>expr <span class="nv">$answer</span> + <span class="k">$(</span><span class="nb">echo</span> <span class="nv">$?</span><span class="k">))</span>
  calc <span class="s2">&quot;</span><span class="nv">$B4</span><span class="s2">&quot;</span><span class="p">;</span> <span class="nv">answer</span><span class="o">=</span><span class="k">$(</span>expr <span class="nv">$answer</span> + <span class="k">$(</span><span class="nb">echo</span> <span class="nv">$?</span><span class="k">))</span>
  calc <span class="s2">&quot;</span><span class="nv">$B5</span><span class="s2">&quot;</span><span class="p">;</span> <span class="nv">answer</span><span class="o">=</span><span class="k">$(</span>expr <span class="nv">$answer</span> + <span class="k">$(</span><span class="nb">echo</span> <span class="nv">$?</span><span class="k">))</span>
<span class="o">}</span>



game <span class="o">()</span>
<span class="o">{</span> <span class="c"># Generate graphic display of dice throw.</span>
  throw
    <span class="nb">echo</span> -e <span class="s2">&quot;\033[1m&quot;</span>    <span class="c"># Bold.</span>
  <span class="nb">echo</span> -e <span class="s2">&quot;\n&quot;</span>
  <span class="nb">echo</span> -e <span class="s2">&quot;</span><span class="nv">$bone</span><span class="s2">\t</span><span class="nv">$bone</span><span class="s2">\t</span><span class="nv">$bone</span><span class="s2">\t</span><span class="nv">$bone</span><span class="s2">\t</span><span class="nv">$bone</span><span class="s2">&quot;</span>
  <span class="nb">echo</span> -e <span class="se">\</span>
 <span class="s2">&quot;</span><span class="si">${</span><span class="nv">bone1</span><span class="p">[</span><span class="nv">$B1</span><span class="p">]</span><span class="si">}</span><span class="s2">\t</span><span class="si">${</span><span class="nv">bone1</span><span class="p">[</span><span class="nv">$B2</span><span class="p">]</span><span class="si">}</span><span class="s2">\t</span><span class="si">${</span><span class="nv">bone1</span><span class="p">[</span><span class="nv">$B3</span><span class="p">]</span><span class="si">}</span><span class="s2">\t</span><span class="si">${</span><span class="nv">bone1</span><span class="p">[</span><span class="nv">$B4</span><span class="p">]</span><span class="si">}</span><span class="s2">\t</span><span class="si">${</span><span class="nv">bone1</span><span class="p">[</span><span class="nv">$B5</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
  <span class="nb">echo</span> -e <span class="se">\</span>
 <span class="s2">&quot;</span><span class="si">${</span><span class="nv">bone2</span><span class="p">[</span><span class="nv">$B1</span><span class="p">]</span><span class="si">}</span><span class="s2">\t</span><span class="si">${</span><span class="nv">bone2</span><span class="p">[</span><span class="nv">$B2</span><span class="p">]</span><span class="si">}</span><span class="s2">\t</span><span class="si">${</span><span class="nv">bone2</span><span class="p">[</span><span class="nv">$B3</span><span class="p">]</span><span class="si">}</span><span class="s2">\t</span><span class="si">${</span><span class="nv">bone2</span><span class="p">[</span><span class="nv">$B4</span><span class="p">]</span><span class="si">}</span><span class="s2">\t</span><span class="si">${</span><span class="nv">bone2</span><span class="p">[</span><span class="nv">$B5</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
  <span class="nb">echo</span> -e <span class="se">\</span>
 <span class="s2">&quot;</span><span class="si">${</span><span class="nv">bone3</span><span class="p">[</span><span class="nv">$B1</span><span class="p">]</span><span class="si">}</span><span class="s2">\t</span><span class="si">${</span><span class="nv">bone3</span><span class="p">[</span><span class="nv">$B2</span><span class="p">]</span><span class="si">}</span><span class="s2">\t</span><span class="si">${</span><span class="nv">bone3</span><span class="p">[</span><span class="nv">$B3</span><span class="p">]</span><span class="si">}</span><span class="s2">\t</span><span class="si">${</span><span class="nv">bone3</span><span class="p">[</span><span class="nv">$B4</span><span class="p">]</span><span class="si">}</span><span class="s2">\t</span><span class="si">${</span><span class="nv">bone3</span><span class="p">[</span><span class="nv">$B5</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
  <span class="nb">echo</span> -e <span class="s2">&quot;</span><span class="nv">$bone</span><span class="s2">\t</span><span class="nv">$bone</span><span class="s2">\t</span><span class="nv">$bone</span><span class="s2">\t</span><span class="nv">$bone</span><span class="s2">\t</span><span class="nv">$bone</span><span class="s2">&quot;</span>
  <span class="nb">echo</span> -e <span class="s2">&quot;\n\n\t\t&quot;</span>
    <span class="nb">echo</span> -e <span class="s2">&quot;\033[0m&quot;</span>    <span class="c"># Turn off bold.</span>
  <span class="nb">echo</span> -n <span class="s2">&quot;There are how many petals around the rose? &quot;</span>
<span class="o">}</span>



<span class="c"># ============================================================== #</span>

instructions

<span class="k">while</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$petal</span><span class="s2">&quot;</span> !<span class="o">=</span> <span class="s2">&quot;</span><span class="nv">$EXIT</span><span class="s2">&quot;</span> <span class="o">]</span>    <span class="c"># Main loop.</span>
<span class="k">do</span>
  game
  <span class="nb">read </span>petal
  <span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$petal</span><span class="s2">&quot;</span>grep <span class="o">[</span>0-9<span class="o">]</span> &gt;/dev/null  <span class="c"># Filter response for digit.</span>
                                         <span class="c"># Otherwise just roll dice again.</span>
  <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$?</span><span class="s2">&quot;</span> -eq <span class="m">0</span> <span class="o">]</span>   <span class="c"># If-loop #1.</span>
  <span class="k">then</span>
    <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$petal</span><span class="s2">&quot;</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="nv">$answer</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>    <span class="c"># If-loop #2.</span>
        <span class="nb">echo</span> -e <span class="s2">&quot;\nCorrect. There are </span><span class="nv">$petal</span><span class="s2"> petals around the rose.\n&quot;</span>
        <span class="o">((</span> hits++ <span class="o">))</span>

        <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$hits</span><span class="s2">&quot;</span> -eq <span class="s2">&quot;</span><span class="nv">$WIN</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>   <span class="c"># If-loop #3.</span>
          <span class="nb">echo</span> -e <span class="s1">&#39;\E[31;47m&#39;</span>  <span class="c"># Red type.</span>
          <span class="nb">echo</span> -e <span class="s2">&quot;\033[1m&quot;</span>    <span class="c"># Bold.</span>
          <span class="nb">echo</span> <span class="s2">&quot;You have unraveled the mystery of the Rose Petals!&quot;</span>
          <span class="nb">echo</span> <span class="s2">&quot;Welcome to the Fellowship of the Rose!!!&quot;</span>
          <span class="nb">echo</span> <span class="s2">&quot;(You are herewith sworn to secrecy.)&quot;</span><span class="p">;</span> <span class="nb">echo</span>
<span class="nb">          echo</span> -e <span class="s2">&quot;\033[0m&quot;</span>    <span class="c"># Turn off red &amp; bold.</span>
          <span class="nb">break</span>                <span class="c"># Exit!</span>
        <span class="k">else</span> <span class="nb">echo</span> <span class="s2">&quot;You have </span><span class="nv">$hits</span><span class="s2"> correct so far.&quot;</span><span class="p">;</span> <span class="nb">echo</span>

<span class="nb">        </span><span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$hits</span><span class="s2">&quot;</span> -eq <span class="s2">&quot;</span><span class="nv">$ALMOST</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
          <span class="nb">echo</span> <span class="s2">&quot;Just one more gets you to the heart of the mystery!&quot;</span><span class="p">;</span> <span class="nb">echo</span>
<span class="nb">        </span><span class="k">fi</span>

      <span class="k">fi</span>                                  <span class="c"># Close if-loop #3.</span>

    <span class="k">else</span>
      <span class="nb">echo</span> -e <span class="s2">&quot;\nWrong. There are </span><span class="nv">$answer</span><span class="s2"> petals around the rose.\n&quot;</span>
      <span class="nv">hits</span><span class="o">=</span><span class="m">0</span>   <span class="c"># Reset number of correct guesses.</span>
    <span class="k">fi</span>                                    <span class="c"># Close if-loop #2.</span>

    <span class="nb">echo</span> -n <span class="s2">&quot;Hit ENTER for the next roll, or type \&quot;exit\&quot; to end. &quot;</span>
    <span class="nb">read</span>
<span class="nb">    </span><span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$REPLY</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="nv">$EXIT</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span> <span class="nb">exit</span>
<span class="nb">    </span><span class="k">fi</span>

  <span class="k">fi</span>                  <span class="c"># Close if-loop #1.</span>

  clear
<span class="k">done</span>                  <span class="c"># End of main (while) loop.</span>

<span class="c">###</span>

<span class="nb">exit</span> <span class="nv">$?</span>

<span class="c"># Resources:</span>
<span class="c"># ---------</span>
<span class="c"># 1) http://en.wikipedia.org/wiki/Petals_Around_the_Rose</span>
<span class="c">#    (Wikipedia entry.)</span>
<span class="c"># 2) http://www.borrett.id.au/computing/petals-bg.htm</span>
<span class="c">#    (How Bill Gates coped with the Petals Around the Rose challenge.)</span>
</pre></div>
</div>
</div>
<div class="section" id="exemple-41-quacky-a-perquackey-type-word-game">
<h2>Exemple 41. Quacky: a Perquackey-type word game<a class="headerlink" href="#exemple-41-quacky-a-perquackey-type-word-game" title="Link permanent a aquest títol">¶</a></h2>
<div class="highlight-sh"><div class="highlight"><pre><span class="c">#!/bin/bash</span>
<span class="c"># qky.sh</span>

<span class="c">##############################################################</span>
<span class="c"># QUACKEY: a somewhat simplified version of Perquackey [TM]. #</span>
<span class="c">#                                                            #</span>
<span class="c"># Author: Mendel Cooper  &lt;thegrendel.abs@gmail.com&gt;          #</span>
<span class="c"># version 0.1.02      03 May, 2008                           #</span>
<span class="c"># License: GPL3                                              #</span>
<span class="c">##############################################################</span>

<span class="nv">WLIST</span><span class="o">=</span>/usr/share/dict/word.lst
<span class="c">#                     ^^^^^^^^  Word list file found here.</span>
<span class="c">#  ASCII word list, one word per line, UNIX format.</span>
<span class="c">#  A suggested list is the script author&#39;s &quot;yawl&quot; word list package.</span>
<span class="c">#  http://bash.deta.in/yawl-0.3.2.tar.gz</span>
<span class="c">#    or</span>
<span class="c">#  http://ibiblio.org/pub/Linux/libs/yawl-0.3.2.tar.gz</span>

<span class="nv">NONCONS</span><span class="o">=</span><span class="m">0</span>     <span class="c"># Word not constructable from letter set.</span>
<span class="nv">CONS</span><span class="o">=</span><span class="m">1</span>        <span class="c"># Constructable.</span>
<span class="nv">SUCCESS</span><span class="o">=</span>0
<span class="nv">NG</span><span class="o">=</span>1
<span class="nv">FAILURE</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
<span class="nv">NULL</span><span class="o">=</span><span class="m">0</span>        <span class="c"># Zero out value of letter (if found).</span>
<span class="nv">MINWLEN</span><span class="o">=</span><span class="m">3</span>     <span class="c"># Minimum word length.</span>
<span class="nv">MAXCAT</span><span class="o">=</span><span class="m">5</span>      <span class="c"># Maximum number of words in a given category.</span>
<span class="nv">PENALTY</span><span class="o">=</span><span class="m">200</span>   <span class="c"># General-purpose penalty for unacceptable words.</span>
<span class="nv">total</span><span class="o">=</span>
<span class="nv">E_DUP</span><span class="o">=</span><span class="m">70</span>      <span class="c"># Duplicate word error.</span>

<span class="nv">TIMEOUT</span><span class="o">=</span><span class="m">10</span>    <span class="c"># Time for word input.</span>

<span class="nv">NVLET</span><span class="o">=</span><span class="m">10</span>      <span class="c"># 10 letters for non-vulnerable.</span>
<span class="nv">VULET</span><span class="o">=</span><span class="m">13</span>      <span class="c"># 13 letters for vulnerable (not yet implemented!).</span>

<span class="nb">declare</span> -a Words
<span class="nb">declare</span> -a Status
<span class="nb">declare</span> -a <span class="nv">Score</span><span class="o">=(</span> <span class="m">0</span> <span class="m">0</span> <span class="m">0</span> <span class="m">0</span> <span class="m">0</span> <span class="m">0</span> <span class="m">0</span> <span class="m">0</span> <span class="m">0</span> <span class="m">0</span> <span class="m">0</span> <span class="o">)</span>


<span class="nv">letters</span><span class="o">=(</span> a n s r t m l k p r b c i d s i d z e w u e t f
e y e r e f e g t g h h i t r s c i t i d i j a t a o l a
m n a n o v n w o s e l n o s p a q e e r a b r s a o d s
t g t i t l u e u v n e o x y m r k <span class="o">)</span>
<span class="c">#  Letter distribution table shamelessly borrowed from &quot;Wordy&quot; game,</span>
<span class="c">#+ ca. 1992, written by a certain fine fellow named Mendel Cooper.</span>

<span class="nb">declare</span> -a LS

<span class="nv">numelements</span><span class="o">=</span><span class="si">${#</span><span class="nv">letters</span><span class="p">[@]</span><span class="si">}</span>
<span class="nv">randseed</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>

instructions <span class="o">()</span>
<span class="o">{</span>
  clear
  <span class="nb">echo</span> <span class="s2">&quot;Welcome to QUACKEY, the anagramming word construction game.&quot;</span><span class="p">;</span> <span class="nb">echo</span>
<span class="nb">  echo</span> -n <span class="s2">&quot;Do you need instructions? (y/n) &quot;</span><span class="p">;</span> <span class="nb">read </span>ans

   <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$ans</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;y&quot;</span> -o <span class="s2">&quot;</span><span class="nv">$ans</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;Y&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
     clear
     <span class="nb">echo</span> -e <span class="s1">&#39;\E[31;47m&#39;</span>  <span class="c"># Red foreground. &#39;\E[34;47m&#39; for blue.</span>
     cat <span class="s">&lt;&lt;INSTRUCTION1</span>

<span class="s">QUACKEY is a variant of Perquackey [TM].</span>
<span class="s">The rules are the same, but the scoring is simplified</span>
<span class="s">and plurals of previously played words are allowed.</span>
<span class="s">&quot;Vulnerable&quot; play is not yet implemented,</span>
<span class="s">but it is otherwise feature-complete.</span>

<span class="s">As the game begins, the player gets 10 letters.</span>
<span class="s">The object is to construct valid dictionary words</span>
<span class="s">of at least 3-letter length from the letterset.</span>
<span class="s">Each word-length category</span>
<span class="s">-- 3-letter, 4-letter, 5-letter, ... --</span>
<span class="s">fills up with the fifth word entered,</span>
<span class="s">and no further words in that category are accepted.</span>

<span class="s">The penalty for too-short (two-letter), duplicate, unconstructable,</span>
<span class="s">and invalid (not in dictionary) words is -200. The same penalty applies</span>
<span class="s">to attempts to enter a word in a filled-up category.</span>

<span class="s">INSTRUCTION1</span>

  <span class="nb">echo</span> -n <span class="s2">&quot;Hit ENTER for next page of instructions. &quot;</span><span class="p">;</span> <span class="nb">read </span>az1

     cat <span class="s">&lt;&lt;INSTRUCTION2</span>

<span class="s">The scoring mostly corresponds to classic Perquackey:</span>
<span class="s">The first 3-letter word scores    60, plus   10 for each additional one.</span>
<span class="s">The first 4-letter word scores   120, plus   20 for each additional one.</span>
<span class="s">The first 5-letter word scores   200, plus   50 for each additional one.</span>
<span class="s">The first 6-letter word scores   300, plus  100 for each additional one.</span>
<span class="s">The first 7-letter word scores   500, plus  150 for each additional one.</span>
<span class="s">The first 8-letter word scores   750, plus  250 for each additional one.</span>
<span class="s">The first 9-letter word scores  1000, plus  500 for each additional one.</span>
<span class="s">The first 10-letter word scores 2000, plus 2000 for each additional one.</span>

<span class="s">Category completion bonuses are:</span>
<span class="s">3-letter words   100</span>
<span class="s">4-letter words   200</span>
<span class="s">5-letter words   400</span>
<span class="s">6-letter words   800</span>
<span class="s">7-letter words  2000</span>
<span class="s">8-letter words 10000</span>
<span class="s">This is a simplification of the absurdly baroque Perquackey bonus</span>
<span class="s">scoring system.</span>

<span class="s">INSTRUCTION2</span>

  <span class="nb">echo</span> -n <span class="s2">&quot;Hit ENTER for final page of instructions. &quot;</span><span class="p">;</span> <span class="nb">read </span>az1

     cat <span class="s">&lt;&lt;INSTRUCTION3</span>


<span class="s">Hitting just ENTER for a word entry ends the game.</span>

<span class="s">Individual word entry is timed to a maximum of 10 seconds.</span>
<span class="s">*** Timing out on an entry ends the game. ***</span>
<span class="s">Aside from that, the game is untimed.</span>

<span class="s">--------------------------------------------------</span>
<span class="s">Game statistics are automatically saved to a file.</span>
<span class="s">--------------------------------------------------</span>

<span class="s">For competitive (&quot;duplicate&quot;) play, a previous letterset</span>
<span class="s">may be duplicated by repeating the script&#39;s random seed,</span>
<span class="s">command-line parameter \$1.</span>
<span class="s">For example, &quot;qky 7633&quot; specifies the letterset</span>
<span class="s">c a d i f r h u s k ...</span>
<span class="s">INSTRUCTION3</span>

  <span class="nb">echo</span><span class="p">;</span> <span class="nb">echo</span> -n <span class="s2">&quot;Hit ENTER to begin game. &quot;</span><span class="p">;</span> <span class="nb">read </span>az1

       <span class="nb">echo</span> -e <span class="s2">&quot;\033[0m&quot;</span>    <span class="c"># Turn off red.</span>
     <span class="k">else</span> clear
  <span class="k">fi</span>

  clear

<span class="o">}</span>



seed_random <span class="o">()</span>
<span class="o">{</span>                         <span class="c">#  Seed random number generator.</span>
  <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;</span><span class="nv">$randseed</span><span class="s2">&quot;</span> <span class="o">]</span>   <span class="c">#  Can specify random seed.</span>
  <span class="k">then</span>                    <span class="c">#+ for play in competitive mode.</span>
<span class="c">#   RANDOM=&quot;$randseed&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;RANDOM seed set to &quot;</span><span class="nv">$randseed</span><span class="s2">&quot;&quot;</span>
  <span class="k">else</span>
    <span class="nv">randseed</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$$</span><span class="s2">&quot;</span>         <span class="c"># Or get random seed from process ID.</span>
    <span class="nb">echo</span> <span class="s2">&quot;RANDOM seed not specified, set to Process ID of script (</span><span class="nv">$$</span><span class="s2">).&quot;</span>
  <span class="k">fi</span>

  <span class="nv">RANDOM</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$randseed</span><span class="s2">&quot;</span>

  <span class="nb">echo</span>
<span class="o">}</span>


get_letset <span class="o">()</span>
<span class="o">{</span>
  <span class="nv">element</span><span class="o">=</span>0
  <span class="nb">echo</span> -n <span class="s2">&quot;Letterset:&quot;</span>

  <span class="k">for</span> lset in <span class="k">$(</span>seq <span class="nv">$NVLET</span><span class="k">)</span>
  <span class="k">do</span>  <span class="c"># Pick random letters to fill out letterset.</span>
    LS<span class="o">[</span>element<span class="o">]=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">letters</span><span class="p">[</span><span class="k">$((</span>RANDOM%numelements<span class="k">))</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="o">((</span>element++<span class="o">))</span>
  <span class="k">done</span>

  <span class="nb">echo</span>
<span class="nb">  echo</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">LS</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="o">}</span>


add_word <span class="o">()</span>
<span class="o">{</span>
  <span class="nv">wrd</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
  <span class="nb">local </span><span class="nv">idx</span><span class="o">=</span>0

  Status<span class="o">[</span>0<span class="o">]=</span><span class="s2">&quot;&quot;</span>
  Status<span class="o">[</span>3<span class="o">]=</span><span class="s2">&quot;&quot;</span>
  Status<span class="o">[</span>4<span class="o">]=</span><span class="s2">&quot;&quot;</span>

  <span class="k">while</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">Words</span><span class="p">[idx]</span><span class="si">}</span><span class="s2">&quot;</span> !<span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="o">]</span>
  <span class="k">do</span>
    <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">Words</span><span class="p">[idx]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="nv">$wrd</span><span class="s2">&quot;</span> <span class="o">]</span>
    <span class="k">then</span>
      Status<span class="o">[</span>3<span class="o">]=</span><span class="s2">&quot;Duplicate-word-PENALTY&quot;</span>
      <span class="nb">let</span> <span class="s2">&quot;Score[0]= 0 - </span><span class="nv">$PENALTY</span><span class="s2">&quot;</span>
      <span class="nb">let</span> <span class="s2">&quot;Score[1]-=</span><span class="nv">$PENALTY</span><span class="s2">&quot;</span>
      <span class="k">return</span> <span class="nv">$E_DUP</span>
    <span class="k">fi</span>

    <span class="o">((</span>idx++<span class="o">))</span>
  <span class="k">done</span>

  Words<span class="o">[</span>idx<span class="o">]=</span><span class="s2">&quot;</span><span class="nv">$wrd</span><span class="s2">&quot;</span>
  get_score

<span class="o">}</span>

get_score<span class="o">()</span>
<span class="o">{</span>
  <span class="nb">local </span><span class="nv">wlen</span><span class="o">=</span>0
  <span class="nb">local </span><span class="nv">score</span><span class="o">=</span>0
  <span class="nb">local </span><span class="nv">bonus</span><span class="o">=</span>0
  <span class="nb">local </span><span class="nv">first_word</span><span class="o">=</span>0
  <span class="nb">local </span><span class="nv">add_word</span><span class="o">=</span>0
  <span class="nb">local </span><span class="nv">numwords</span><span class="o">=</span>0

  <span class="nv">wlen</span><span class="o">=</span><span class="si">${#</span><span class="nv">wrd</span><span class="si">}</span>
  <span class="nv">numwords</span><span class="o">=</span><span class="si">${</span><span class="nv">Score</span><span class="p">[wlen]</span><span class="si">}</span>
  Score<span class="o">[</span>2<span class="o">]=</span>0
  Status<span class="o">[</span>4<span class="o">]=</span><span class="s2">&quot;&quot;</span>   <span class="c"># Initialize &quot;bonus&quot; to 0.</span>

  <span class="k">case</span> <span class="s2">&quot;</span><span class="nv">$wlen</span><span class="s2">&quot;</span> in
    3<span class="o">)</span> <span class="nv">first_word</span><span class="o">=</span>60
       <span class="nv">add_word</span><span class="o">=</span>10<span class="p">;;</span>
    4<span class="o">)</span> <span class="nv">first_word</span><span class="o">=</span>120
       <span class="nv">add_word</span><span class="o">=</span>20<span class="p">;;</span>
    5<span class="o">)</span> <span class="nv">first_word</span><span class="o">=</span>200
       <span class="nv">add_word</span><span class="o">=</span>50<span class="p">;;</span>
    6<span class="o">)</span> <span class="nv">first_word</span><span class="o">=</span>300
       <span class="nv">add_word</span><span class="o">=</span>100<span class="p">;;</span>
    7<span class="o">)</span> <span class="nv">first_word</span><span class="o">=</span>500
       <span class="nv">add_word</span><span class="o">=</span>150<span class="p">;;</span>
    8<span class="o">)</span> <span class="nv">first_word</span><span class="o">=</span>750
       <span class="nv">add_word</span><span class="o">=</span>250<span class="p">;;</span>
    9<span class="o">)</span> <span class="nv">first_word</span><span class="o">=</span>1000
       <span class="nv">add_word</span><span class="o">=</span>500<span class="p">;;</span>
   10<span class="o">)</span> <span class="nv">first_word</span><span class="o">=</span>2000
       <span class="nv">add_word</span><span class="o">=</span>2000<span class="p">;;</span>   <span class="c"># This category modified from original rules!</span>
      <span class="k">esac</span>

  <span class="o">((</span>Score<span class="o">[</span>wlen<span class="o">]</span>++<span class="o">))</span>
  <span class="k">if</span> <span class="o">[</span> <span class="si">${</span><span class="nv">Score</span><span class="p">[wlen]</span><span class="si">}</span> -eq <span class="nv">$MAXCAT</span> <span class="o">]</span>
  <span class="k">then</span>   <span class="c"># Category completion bonus scoring simplified!</span>
    <span class="k">case</span> <span class="nv">$wlen</span> in
      <span class="m">3</span> <span class="o">)</span> <span class="nv">bonus</span><span class="o">=</span>100<span class="p">;;</span>
      <span class="m">4</span> <span class="o">)</span> <span class="nv">bonus</span><span class="o">=</span>200<span class="p">;;</span>
      <span class="m">5</span> <span class="o">)</span> <span class="nv">bonus</span><span class="o">=</span>400<span class="p">;;</span>
      <span class="m">6</span> <span class="o">)</span> <span class="nv">bonus</span><span class="o">=</span>800<span class="p">;;</span>
      <span class="m">7</span> <span class="o">)</span> <span class="nv">bonus</span><span class="o">=</span>2000<span class="p">;;</span>
      <span class="m">8</span> <span class="o">)</span> <span class="nv">bonus</span><span class="o">=</span>10000<span class="p">;;</span>
    <span class="k">esac</span>  <span class="c"># Needn&#39;t worry about 9&#39;s and 10&#39;s.</span>
    Status<span class="o">[</span>4<span class="o">]=</span><span class="s2">&quot;Category-</span><span class="nv">$wlen</span><span class="s2">-completion***BONUS***&quot;</span>
    Score<span class="o">[</span>2<span class="o">]=</span><span class="nv">$bonus</span>
  <span class="k">else</span>
    Status<span class="o">[</span>4<span class="o">]=</span><span class="s2">&quot;&quot;</span>   <span class="c"># Erase it.</span>
  <span class="k">fi</span>


    <span class="nb">let</span> <span class="s2">&quot;score =  </span><span class="nv">$first_word</span><span class="s2"> +   </span><span class="nv">$add_word</span><span class="s2"> * </span><span class="nv">$numwords</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$numwords</span><span class="s2">&quot;</span> -eq <span class="m">0</span> <span class="o">]</span>
    <span class="k">then</span>
      Score<span class="o">[</span>0<span class="o">]=</span><span class="nv">$score</span>
    <span class="k">else</span>
      Score<span class="o">[</span>0<span class="o">]=</span><span class="nv">$add_word</span>
    <span class="k">fi</span>   <span class="c">#  All this to distinguish last-word score</span>
         <span class="c">#+ from total running score.</span>
  <span class="nb">let</span> <span class="s2">&quot;Score[1] += </span><span class="si">${</span><span class="nv">Score</span><span class="p">[0]</span><span class="si">}</span><span class="s2">&quot;</span>
  <span class="nb">let</span> <span class="s2">&quot;Score[1] += </span><span class="si">${</span><span class="nv">Score</span><span class="p">[2]</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="o">}</span>



get_word <span class="o">()</span>
<span class="o">{</span>
  <span class="nb">local </span><span class="nv">wrd</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
  <span class="nb">read</span> -t <span class="nv">$TIMEOUT</span> wrd   <span class="c"># Timed read.</span>
  <span class="nb">echo</span> <span class="nv">$wrd</span>
<span class="o">}</span>

is_constructable <span class="o">()</span>
<span class="o">{</span> <span class="c"># This is the most complex and difficult-to-write function.</span>
  <span class="nb">local</span> -a <span class="nv">local_LS</span><span class="o">=(</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">LS</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">)</span>  <span class="c"># Local copy of letter set.</span>
  <span class="nb">local </span><span class="nv">is_found</span><span class="o">=</span>0
  <span class="nb">local </span><span class="nv">idx</span><span class="o">=</span>0
  <span class="nb">local </span>pos
  <span class="nb">local </span>strlen
  <span class="nb">local </span><span class="nv">local_word</span><span class="o">=(</span> <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> <span class="o">)</span>
  <span class="nv">strlen</span><span class="o">=</span><span class="si">${#</span><span class="nv">local_word</span><span class="si">}</span>

  <span class="k">while</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$idx</span><span class="s2">&quot;</span> -lt <span class="s2">&quot;</span><span class="nv">$strlen</span><span class="s2">&quot;</span> <span class="o">]</span>
  <span class="k">do</span>
    <span class="nv">is_found</span><span class="o">=</span><span class="k">$(</span>expr index <span class="s2">&quot;</span><span class="si">${</span><span class="nv">local_LS</span><span class="p">[*]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">local_word</span><span class="p">:</span><span class="nv">idx</span><span class="p">:</span><span class="nv">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="k">)</span>
    <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$is_found</span><span class="s2">&quot;</span> -eq <span class="s2">&quot;</span><span class="nv">$NONCONS</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="c"># Not constructable!</span>
    <span class="k">then</span>
      <span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$FAILURE</span><span class="s2">&quot;</span><span class="p">;</span> <span class="k">return</span>
    <span class="k">else</span>
      <span class="o">((</span><span class="nv">pos</span> <span class="o">=</span> <span class="o">(</span><span class="nv">$is_found</span> - 1<span class="o">)</span> / 2<span class="o">))</span>   <span class="c"># Compensate for spaces betw. letters!</span>
      local_LS<span class="o">[</span>pos<span class="o">]=</span><span class="nv">$NULL</span>             <span class="c"># Zero out used letters.</span>
      <span class="o">((</span>idx++<span class="o">))</span>                       <span class="c"># Bump index.</span>
    <span class="k">fi</span>
  <span class="k">done</span>

  <span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$SUCCESS</span><span class="s2">&quot;</span>
  <span class="k">return</span>
<span class="o">}</span>

is_valid <span class="o">()</span>
<span class="o">{</span> <span class="c"># Surprisingly easy to check if word in dictionary ...</span>
  fgrep -qw <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> <span class="s2">&quot;</span><span class="nv">$WLIST</span><span class="s2">&quot;</span>   <span class="c"># ... courtesy of &#39;grep&#39; ...</span>
  <span class="nb">echo</span> <span class="nv">$?</span>
<span class="o">}</span>

check_word <span class="o">()</span>
<span class="o">{</span>
  <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> <span class="o">]</span>
  <span class="k">then</span>
    <span class="k">return</span>
  <span class="k">fi</span>

  Status<span class="o">[</span>1<span class="o">]=</span><span class="s2">&quot;&quot;</span>
  Status<span class="o">[</span>2<span class="o">]=</span><span class="s2">&quot;&quot;</span>
  Status<span class="o">[</span>3<span class="o">]=</span><span class="s2">&quot;&quot;</span>
  Status<span class="o">[</span>4<span class="o">]=</span><span class="s2">&quot;&quot;</span>

  <span class="nv">iscons</span><span class="o">=</span><span class="k">$(</span>is_constructable <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span><span class="k">)</span>
  <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$iscons</span><span class="s2">&quot;</span> <span class="o">]</span>
  <span class="k">then</span>
    Status<span class="o">[</span>1<span class="o">]=</span><span class="s2">&quot;constructable&quot;</span>
    <span class="nv">v</span><span class="o">=</span><span class="k">$(</span>is_valid <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span><span class="k">)</span>
    <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$v</span><span class="s2">&quot;</span> -eq <span class="s2">&quot;</span><span class="nv">$SUCCESS</span><span class="s2">&quot;</span> <span class="o">]</span>
    <span class="k">then</span>
      Status<span class="o">[</span>2<span class="o">]=</span><span class="s2">&quot;valid&quot;</span>
      <span class="nv">strlen</span><span class="o">=</span><span class="si">${#</span><span class="nv">1</span><span class="si">}</span>

      <span class="k">if</span> <span class="o">[</span> <span class="si">${</span><span class="nv">Score</span><span class="p">[strlen]</span><span class="si">}</span> -eq <span class="s2">&quot;</span><span class="nv">$MAXCAT</span><span class="s2">&quot;</span> <span class="o">]</span>   <span class="c"># Category full!</span>
      <span class="k">then</span>
        Status<span class="o">[</span>3<span class="o">]=</span><span class="s2">&quot;Category-</span><span class="nv">$strlen</span><span class="s2">-overflow-PENALTY&quot;</span>
        <span class="k">return</span> <span class="nv">$NG</span>
      <span class="k">fi</span>

      <span class="k">case</span> <span class="s2">&quot;</span><span class="nv">$strlen</span><span class="s2">&quot;</span> in
        <span class="m">12</span> <span class="o">)</span>
        Status<span class="o">[</span>3<span class="o">]=</span><span class="s2">&quot;Two-letter-word-PENALTY&quot;</span>
        <span class="k">return</span> <span class="nv">$NG</span><span class="p">;;</span>
        * <span class="o">)</span>
    Status<span class="o">[</span>3<span class="o">]=</span><span class="s2">&quot;&quot;</span>
    <span class="k">return</span> <span class="nv">$SUCCESS</span><span class="p">;;</span>
      <span class="k">esac</span>
    <span class="k">else</span>
      Status<span class="o">[</span>3<span class="o">]=</span><span class="s2">&quot;Not-valid-PENALTY&quot;</span>
      <span class="k">return</span> <span class="nv">$NG</span>
    <span class="k">fi</span>
  <span class="k">else</span>
    Status<span class="o">[</span>3<span class="o">]=</span><span class="s2">&quot;Not-constructable-PENALTY&quot;</span>
      <span class="k">return</span> <span class="nv">$NG</span>
  <span class="k">fi</span>

  <span class="c">### FIXME: Streamline the above code block.</span>

<span class="o">}</span>


display_words <span class="o">()</span>
<span class="o">{</span>
  <span class="nb">local </span><span class="nv">idx</span><span class="o">=</span>0
  <span class="nb">local </span>wlen0

  clear
  <span class="nb">echo</span> <span class="s2">&quot;Letterset:   </span><span class="si">${</span><span class="nv">LS</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot;Threes:    Fours:    Fives:     Sixes:    Sevens:    Eights:&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot;------------------------------------------------------------&quot;</span>



  <span class="k">while</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">Words</span><span class="p">[idx]</span><span class="si">}</span><span class="s2">&quot;</span> !<span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="o">]</span>
  <span class="k">do</span>
   <span class="nv">wlen0</span><span class="o">=</span><span class="si">${#</span><span class="nv">Words</span><span class="p">[idx]</span><span class="si">}</span>
   <span class="k">case</span> <span class="s2">&quot;</span><span class="nv">$wlen0</span><span class="s2">&quot;</span> in
     3<span class="o">)</span> <span class="p">;;</span>
     4<span class="o">)</span> <span class="nb">echo</span> -n <span class="s2">&quot;           &quot;</span> <span class="p">;;</span>
     5<span class="o">)</span> <span class="nb">echo</span> -n <span class="s2">&quot;                     &quot;</span> <span class="p">;;</span>
     6<span class="o">)</span> <span class="nb">echo</span> -n <span class="s2">&quot;                                &quot;</span> <span class="p">;;</span>
     7<span class="o">)</span> <span class="nb">echo</span> -n <span class="s2">&quot;                                          &quot;</span> <span class="p">;;</span>
     8<span class="o">)</span> <span class="nb">echo</span> -n <span class="s2">&quot;                                                     &quot;</span> <span class="p">;;</span>
   <span class="k">esac</span>
   <span class="nb">echo</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">Words</span><span class="p">[idx]</span><span class="si">}</span><span class="s2">&quot;</span>
   <span class="o">((</span>idx++<span class="o">))</span>
  <span class="k">done</span>

  <span class="c">### FIXME: The word display is pretty crude.</span>
<span class="o">}</span>


play <span class="o">()</span>
<span class="o">{</span>
  <span class="nv">word</span><span class="o">=</span><span class="s2">&quot;Start game&quot;</span>   <span class="c"># Dummy word, to start ...</span>

  <span class="k">while</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$word</span><span class="s2">&quot;</span> <span class="o">]</span>   <span class="c">#  If player just hits return (null word),</span>
  <span class="k">do</span>                  <span class="c">#+ then game ends.</span>
    <span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$word</span><span class="s2">: &quot;</span><span class="si">${</span><span class="nv">Status</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;&quot;</span>
    <span class="nb">echo</span> -n <span class="s2">&quot;Last score: [</span><span class="si">${</span><span class="nv">Score</span><span class="p">[0]</span><span class="si">}</span><span class="s2">]   TOTAL score: [</span><span class="si">${</span><span class="nv">Score</span><span class="p">[1]</span><span class="si">}</span><span class="s2">]:     Next word: &quot;</span>
    <span class="nv">total</span><span class="o">=</span><span class="si">${</span><span class="nv">Score</span><span class="p">[1]</span><span class="si">}</span>
    <span class="nv">word</span><span class="o">=</span><span class="k">$(</span>get_word<span class="k">)</span>
    check_word <span class="s2">&quot;</span><span class="nv">$word</span><span class="s2">&quot;</span>

    <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$?</span><span class="s2">&quot;</span> -eq <span class="s2">&quot;</span><span class="nv">$SUCCESS</span><span class="s2">&quot;</span> <span class="o">]</span>
    <span class="k">then</span>
      add_word <span class="s2">&quot;</span><span class="nv">$word</span><span class="s2">&quot;</span>
    <span class="k">else</span>
      <span class="nb">let</span> <span class="s2">&quot;Score[0]= 0 - </span><span class="nv">$PENALTY</span><span class="s2">&quot;</span>
      <span class="nb">let</span> <span class="s2">&quot;Score[1]-=</span><span class="nv">$PENALTY</span><span class="s2">&quot;</span>
    <span class="k">fi</span>

  display_words
  <span class="k">done</span>   <span class="c"># Exit game.</span>

  <span class="c">### FIXME: The play () function calls too many other functions.</span>
  <span class="c">### This verges on &quot;spaghetti code&quot; !!!</span>
<span class="o">}</span>

end_of_game <span class="o">()</span>
<span class="o">{</span> <span class="c"># Save and display stats.</span>

  <span class="c">#######################Autosave##########################</span>
  <span class="nv">savefile</span><span class="o">=</span>qky.save.<span class="nv">$$</span>
  <span class="c">#                 ^^ PID of script</span>
  <span class="nb">echo</span> <span class="sb">`</span>date<span class="sb">`</span> &gt;&gt; <span class="nv">$savefile</span>
  <span class="nb">echo</span> <span class="s2">&quot;Letterset # </span><span class="nv">$randseed</span><span class="s2">  (random seed) &quot;</span>&gt;&gt; <span class="nv">$savefile</span>
  <span class="nb">echo</span> -n <span class="s2">&quot;Letterset: &quot;</span> &gt;&gt; <span class="nv">$savefile</span>
  <span class="nb">echo</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">LS</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span> &gt;&gt; <span class="nv">$savefile</span>
  <span class="nb">echo</span> <span class="s2">&quot;---------&quot;</span> &gt;&gt; <span class="nv">$savefile</span>
  <span class="nb">echo</span> <span class="s2">&quot;Words constructed:&quot;</span> &gt;&gt; <span class="nv">$savefile</span>
  <span class="nb">echo</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">Words</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span> &gt;&gt; <span class="nv">$savefile</span>
  <span class="nb">echo</span> &gt;&gt; <span class="nv">$savefile</span>
  <span class="nb">echo</span> <span class="s2">&quot;Score: </span><span class="nv">$total</span><span class="s2">&quot;</span> &gt;&gt; <span class="nv">$savefile</span>

  <span class="nb">echo</span> <span class="s2">&quot;Statistics for this round saved in \&quot;&quot;</span><span class="nv">$savefile</span><span class="s2">&quot;\&quot;&quot;</span>
  <span class="c">#########################################################</span>

  <span class="nb">echo</span> <span class="s2">&quot;Score for this round: </span><span class="nv">$total</span><span class="s2">&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot;Words:  </span><span class="si">${</span><span class="nv">Words</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="o">}</span>

<span class="c"># ---------#</span>
instructions
seed_random
get_letset
play
end_of_game
<span class="c"># ---------#</span>

<span class="nb">exit</span> <span class="nv">$?</span>

<span class="c"># TODO:</span>
<span class="c">#</span>
<span class="c"># 1) Clean up code!</span>
<span class="c"># 2) Prettify the display_words () function (maybe with widgets?).</span>
<span class="c"># 3) Improve the time-out ... maybe change to untimed entry,</span>
<span class="c">#+   but with a time limit for the overall round.</span>
<span class="c"># 4) An on-screen countdown timer would be nice.</span>
<span class="c"># 5) Implement &quot;vulnerable&quot; mode of play for compatibility with classic</span>
<span class="c">#+   version of the game.</span>
<span class="c"># 6) Improve save-to-file capability (and maybe make it optional).</span>
<span class="c"># 7) Fix bugs!!!</span>

<span class="c"># For more info, reference:</span>
<span class="c"># http://bash.deta.in/qky.README.html</span>
</pre></div>
</div>
</div>
<div class="section" id="exemple-42-nim">
<h2>Exemple 42. Nim<a class="headerlink" href="#exemple-42-nim" title="Link permanent a aquest títol">¶</a></h2>
<div class="highlight-sh"><div class="highlight"><pre><span class="c">#!/bin/bash</span>
<span class="c"># nim.sh: Game of Nim</span>

<span class="c"># Author: Mendel Cooper</span>
<span class="c"># Reldate: 15 July 2008</span>
<span class="c"># License: GPL3</span>

<span class="nv">ROWS</span><span class="o">=</span><span class="m">5</span>     <span class="c"># Five rows of pegs (or matchsticks).</span>
<span class="nv">WON</span><span class="o">=</span><span class="m">91</span>     <span class="c"># Exit codes to keep track of wins/losses.</span>
<span class="nv">LOST</span><span class="o">=</span><span class="m">92</span>    <span class="c"># Possibly useful if running in batch mode.</span>
<span class="nv">QUIT</span><span class="o">=</span>99
<span class="nv">peg_msg</span><span class="o">=</span>   <span class="c"># Peg/Pegs?</span>
<span class="nv">Rows</span><span class="o">=(</span> <span class="m">0</span> <span class="m">5</span> <span class="m">4</span> <span class="m">3</span> <span class="m">2</span> <span class="m">1</span> <span class="o">)</span>   <span class="c"># Array holding play info.</span>
<span class="c"># ${Rows[0]} holds total number of pegs, updated after each turn.</span>
<span class="c"># Other array elements hold number of pegs in corresponding row.</span>

instructions <span class="o">()</span>
<span class="o">{</span>
  clear
  tput bold
  <span class="nb">echo</span> <span class="s2">&quot;Welcome to the game of Nim.&quot;</span><span class="p">;</span> <span class="nb">echo</span>
<span class="nb">  echo</span> -n <span class="s2">&quot;Do you need instructions? (y/n) &quot;</span><span class="p">;</span> <span class="nb">read </span>ans

   <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$ans</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;y&quot;</span> -o <span class="s2">&quot;</span><span class="nv">$ans</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;Y&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
     clear
     <span class="nb">echo</span> -e <span class="s1">&#39;\E[33;41m&#39;</span>  <span class="c"># Yellow fg., over red bg.; bold.</span>
     cat <span class="s">&lt;&lt;INSTRUCTIONS</span>

<span class="s">Nim is a game with roots in the distant past.</span>
<span class="s">This particular variant starts with five rows of pegs.</span>

<span class="s">1:| | |</span>
<span class="s">2:| |</span>
<span class="s">3:|</span>
<span class="s">4:</span>
<span class="s">5:</span>

<span class="s">The number at the left identifies the row.</span>

<span class="s">The human player moves first, and alternates turns with the bot.</span>
<span class="s">A turn consists of removing at least one peg from a single row.</span>
<span class="s">It is permissable to remove ALL the pegs from a row.</span>
<span class="s">For example, in row 2, above, the player can remove 1, 2, 3, or 4 pegs.</span>
<span class="s">The player who removes the last peg loses.</span>

<span class="s">The strategy consists of trying to be the one who removes</span>
<span class="s">the next-to-last peg(s), leaving the loser with the final peg.</span>

<span class="s">To exit the game early, hit ENTER during your turn.</span>
<span class="s">INSTRUCTIONS</span>

<span class="nb">echo</span><span class="p">;</span> <span class="nb">echo</span> -n <span class="s2">&quot;Hit ENTER to begin game. &quot;</span><span class="p">;</span> <span class="nb">read </span>azx

      <span class="nb">echo</span> -e <span class="s2">&quot;\033[0m&quot;</span>    <span class="c"># Restore display.</span>
      <span class="k">else</span> tput sgr0<span class="p">;</span> clear
  <span class="k">fi</span>

clear

<span class="o">}</span>


tally_up <span class="o">()</span>
<span class="o">{</span>
  <span class="nb">let</span> <span class="s2">&quot;Rows[0] = </span><span class="si">${</span><span class="nv">Rows</span><span class="p">[1]</span><span class="si">}</span><span class="s2"> + </span><span class="si">${</span><span class="nv">Rows</span><span class="p">[2]</span><span class="si">}</span><span class="s2"> + </span><span class="si">${</span><span class="nv">Rows</span><span class="p">[3]</span><span class="si">}</span><span class="s2"> + </span><span class="si">${</span><span class="nv">Rows</span><span class="p">[4]</span><span class="si">}</span><span class="s2"> + \</span>
<span class="s2">  </span><span class="si">${</span><span class="nv">Rows</span><span class="p">[5]</span><span class="si">}</span><span class="s2">&quot;</span>    <span class="c"># Add up how many pegs remaining.</span>
<span class="o">}</span>


display <span class="o">()</span>
<span class="o">{</span>
  <span class="nv">index</span><span class="o">=</span><span class="m">1</span>   <span class="c"># Start with top row.</span>
  <span class="nb">echo</span>

<span class="nb">  </span><span class="k">while</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$index</span><span class="s2">&quot;</span> -le <span class="s2">&quot;</span><span class="nv">$ROWS</span><span class="s2">&quot;</span> <span class="o">]</span>
  <span class="k">do</span>
    <span class="nv">p</span><span class="o">=</span><span class="si">${</span><span class="nv">Rows</span><span class="p">[index]</span><span class="si">}</span>
    <span class="nb">echo</span> -n <span class="s2">&quot;</span><span class="nv">$index</span><span class="s2">:   &quot;</span>          <span class="c"># Show row number.</span>

  <span class="c"># ------------------------------------------------</span>
  <span class="c"># Two concurrent inner loops.</span>

      <span class="nv">indent</span><span class="o">=</span><span class="nv">$index</span>
      <span class="k">while</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$indent</span><span class="s2">&quot;</span> -gt <span class="m">0</span> <span class="o">]</span>
      <span class="k">do</span>
        <span class="nb">echo</span> -n <span class="s2">&quot; &quot;</span>               <span class="c"># Staggered rows.</span>
        <span class="o">((</span>indent--<span class="o">))</span>              <span class="c"># Spacing between pegs.</span>
      <span class="k">done</span>

    <span class="k">while</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$p</span><span class="s2">&quot;</span> -gt <span class="m">0</span> <span class="o">]</span>
    <span class="k">do</span>
      <span class="nb">echo</span> -n <span class="s2">&quot;&quot;</span>
      <span class="o">((</span>p--<span class="o">))</span>
    <span class="k">done</span>
  <span class="c"># -----------------------------------------------</span>

  <span class="nb">echo</span>
  <span class="o">((</span>index++<span class="o">))</span>
  <span class="k">done</span>

  tally_up

  <span class="nv">rp</span><span class="o">=</span><span class="si">${</span><span class="nv">Rows</span><span class="p">[0]</span><span class="si">}</span>

  <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$rp</span><span class="s2">&quot;</span> -eq <span class="m">1</span> <span class="o">]</span>
  <span class="k">then</span>
    <span class="nv">peg_msg</span><span class="o">=</span>peg
    <span class="nv">final_msg</span><span class="o">=</span><span class="s2">&quot;Game over.&quot;</span>
  <span class="k">else</span>             <span class="c"># Game not yet over . . .</span>
    <span class="nv">peg_msg</span><span class="o">=</span>pegs
    <span class="nv">final_msg</span><span class="o">=</span><span class="s2">&quot;&quot;</span>   <span class="c"># . . . So &quot;final message&quot; is blank.</span>
  <span class="k">fi</span>

  <span class="nb">echo</span> <span class="s2">&quot;      </span><span class="nv">$rp</span><span class="s2"> </span><span class="nv">$peg_msg</span><span class="s2"> remaining.&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot;      &quot;</span><span class="nv">$final_msg</span><span class="s2">&quot;&quot;</span>


  <span class="nb">echo</span>
<span class="o">}</span>

player_move <span class="o">()</span>
<span class="o">{</span>

  <span class="nb">echo</span> <span class="s2">&quot;Your move:&quot;</span>

  <span class="nb">echo</span> -n <span class="s2">&quot;Which row? &quot;</span>
  <span class="k">while</span> <span class="nb">read </span>idx
  <span class="k">do</span>                   <span class="c"># Validity check, etc.</span>

    <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$idx</span><span class="s2">&quot;</span> <span class="o">]</span>   <span class="c"># Hitting return quits.</span>
    <span class="k">then</span>
        <span class="nb">echo</span> <span class="s2">&quot;Premature exit.&quot;</span><span class="p">;</span> <span class="nb">echo</span>
<span class="nb">        </span>tput sgr0      <span class="c"># Restore display.</span>
        <span class="nb">exit</span> <span class="nv">$QUIT</span>
    <span class="k">fi</span>

    <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$idx</span><span class="s2">&quot;</span> -gt <span class="s2">&quot;</span><span class="nv">$ROWS</span><span class="s2">&quot;</span> -o <span class="s2">&quot;</span><span class="nv">$idx</span><span class="s2">&quot;</span> -lt <span class="m">1</span> <span class="o">]</span>   <span class="c"># Bounds check.</span>
    <span class="k">then</span>
      <span class="nb">echo</span> <span class="s2">&quot;Invalid row number!&quot;</span>
      <span class="nb">echo</span> -n <span class="s2">&quot;Which row? &quot;</span>
    <span class="k">else</span>
      <span class="nb">break</span>
<span class="nb">    </span><span class="k">fi</span>
    <span class="c"># TODO:</span>
    <span class="c"># Add check for non-numeric input.</span>
    <span class="c"># Also, script crashes on input outside of range of long double.</span>
    <span class="c"># Fix this.</span>

  <span class="k">done</span>

  <span class="nb">echo</span> -n <span class="s2">&quot;Remove how many? &quot;</span>
  <span class="k">while</span> <span class="nb">read </span>num
  <span class="k">do</span>                   <span class="c"># Validity check.</span>

  <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$num</span><span class="s2">&quot;</span> <span class="o">]</span>
  <span class="k">then</span>
    <span class="nb">echo</span> <span class="s2">&quot;Premature exit.&quot;</span><span class="p">;</span> <span class="nb">echo</span>
<span class="nb">    </span>tput sgr0          <span class="c"># Restore display.</span>
    <span class="nb">exit</span> <span class="nv">$QUIT</span>
  <span class="k">fi</span>

    <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$num</span><span class="s2">&quot;</span> -gt <span class="si">${</span><span class="nv">Rows</span><span class="p">[idx]</span><span class="si">}</span> -o <span class="s2">&quot;</span><span class="nv">$num</span><span class="s2">&quot;</span> -lt <span class="m">1</span> <span class="o">]</span>
    <span class="k">then</span>
      <span class="nb">echo</span> <span class="s2">&quot;Cannot remove </span><span class="nv">$num</span><span class="s2">!&quot;</span>
      <span class="nb">echo</span> -n <span class="s2">&quot;Remove how many? &quot;</span>
    <span class="k">else</span>
      <span class="nb">break</span>
<span class="nb">    </span><span class="k">fi</span>
  <span class="k">done</span>
  <span class="c"># TODO:</span>
  <span class="c"># Add check for non-numeric input.</span>
  <span class="c"># Also, script crashes on input outside of range of long double.</span>
  <span class="c"># Fix this.</span>

  <span class="nb">let</span> <span class="s2">&quot;Rows[idx] -= </span><span class="nv">$num</span><span class="s2">&quot;</span>

  display
  tally_up

  <span class="k">if</span> <span class="o">[</span> <span class="si">${</span><span class="nv">Rows</span><span class="p">[0]</span><span class="si">}</span> -eq <span class="m">1</span> <span class="o">]</span>
  <span class="k">then</span>
   <span class="nb">echo</span> <span class="s2">&quot;      Human wins!&quot;</span>
   <span class="nb">echo</span> <span class="s2">&quot;      Congratulations!&quot;</span>
   tput sgr0   <span class="c"># Restore display.</span>
   <span class="nb">echo</span>
<span class="nb">   exit</span> <span class="nv">$WON</span>
  <span class="k">fi</span>

  <span class="k">if</span> <span class="o">[</span> <span class="si">${</span><span class="nv">Rows</span><span class="p">[0]</span><span class="si">}</span> -eq <span class="m">0</span> <span class="o">]</span>
  <span class="k">then</span>          <span class="c"># Snatching defeat from the jaws of victory . . .</span>
    <span class="nb">echo</span> <span class="s2">&quot;      Fool!&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;      You just removed the last peg!&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;      Bot wins!&quot;</span>
    tput sgr0   <span class="c"># Restore display.</span>
    <span class="nb">echo</span>
<span class="nb">    exit</span> <span class="nv">$LOST</span>
  <span class="k">fi</span>
<span class="o">}</span>


bot_move <span class="o">()</span>
<span class="o">{</span>

  <span class="nv">row_b</span><span class="o">=</span>0
  <span class="k">while</span> <span class="o">[[</span> <span class="nv">$row_b</span> -eq <span class="m">0</span> <span class="p">|</span><span class="si">${</span><span class="nv">Rows</span><span class="p">[row_b]</span><span class="si">}</span> -eq <span class="m">0</span> <span class="o">]]</span>
  <span class="k">do</span>
    <span class="nv">row_b</span><span class="o">=</span><span class="nv">$RANDOM</span>          <span class="c"># Choose random row.</span>
    <span class="nb">let</span> <span class="s2">&quot;row_b %= </span><span class="nv">$ROWS</span><span class="s2">&quot;</span>
  <span class="k">done</span>


  <span class="nv">num_b</span><span class="o">=</span>0
  <span class="nv">r0</span><span class="o">=</span><span class="si">${</span><span class="nv">Rows</span><span class="p">[row_b]</span><span class="si">}</span>

  <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$r0</span><span class="s2">&quot;</span> -eq <span class="m">1</span> <span class="o">]</span>
  <span class="k">then</span>
    <span class="nv">num_b</span><span class="o">=</span>1
  <span class="k">else</span>
    <span class="nb">let</span> <span class="s2">&quot;num_b = </span><span class="nv">$r0</span><span class="s2"> - 1&quot;</span>
         <span class="c">#  Leave only a single peg in the row.</span>
  <span class="k">fi</span>     <span class="c">#  Not a very strong strategy,</span>
         <span class="c">#+ but probably a bit better than totally random.</span>

  <span class="nb">let</span> <span class="s2">&quot;Rows[row_b] -= </span><span class="nv">$num_b</span><span class="s2">&quot;</span>
  <span class="nb">echo</span> -n <span class="s2">&quot;Bot:  &quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot;Removing from row </span><span class="nv">$row_b</span><span class="s2"> ... &quot;</span>

  <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$num_b</span><span class="s2">&quot;</span> -eq <span class="m">1</span> <span class="o">]</span>
  <span class="k">then</span>
    <span class="nv">peg_msg</span><span class="o">=</span>peg
  <span class="k">else</span>
    <span class="nv">peg_msg</span><span class="o">=</span>pegs
  <span class="k">fi</span>

  <span class="nb">echo</span> <span class="s2">&quot;      </span><span class="nv">$num_b</span><span class="s2"> </span><span class="nv">$peg_msg</span><span class="s2">.&quot;</span>

  display
  tally_up

  <span class="k">if</span> <span class="o">[</span> <span class="si">${</span><span class="nv">Rows</span><span class="p">[0]</span><span class="si">}</span> -eq <span class="m">1</span> <span class="o">]</span>
  <span class="k">then</span>
   <span class="nb">echo</span> <span class="s2">&quot;      Bot wins!&quot;</span>
   tput sgr0   <span class="c"># Restore display.</span>
   <span class="nb">exit</span> <span class="nv">$WON</span>
  <span class="k">fi</span>

<span class="o">}</span>


<span class="c"># ================================================== #</span>
instructions     <span class="c"># If human player needs them . . .</span>
tput bold        <span class="c"># Bold characters for easier viewing.</span>
display          <span class="c"># Show game board.</span>

<span class="k">while</span> <span class="o">[</span> <span class="nb">true</span> <span class="o">]</span>   <span class="c"># Main loop.</span>
<span class="k">do</span>               <span class="c"># Alternate human and bot turns.</span>
  player_move
  bot_move
<span class="k">done</span>
<span class="c"># ================================================== #</span>

<span class="c"># Exercise:</span>
<span class="c"># --------</span>
<span class="c"># Improve the bot&#39;s strategy.</span>
<span class="c"># There is, in fact, a Nim strategy that can force a win.</span>
<span class="c"># See the Wikipedia article on Nim:  http://en.wikipedia.org/wiki/Nim</span>
<span class="c"># Recode the bot to use this strategy (rather difficult).</span>

<span class="c">#  Curiosities:</span>
<span class="c">#  -----------</span>
<span class="c">#  Nim played a prominent role in Alain Resnais&#39; 1961 New Wave film,</span>
<span class="c">#+ Last Year at Marienbad.</span>
<span class="c">#</span>
<span class="c">#  In 1978, Leo Christopherson wrote an animated version of Nim,</span>
<span class="c">#+ Android Nim, for the TRS-80 Model I.</span>
</pre></div>
</div>
</div>
<div class="section" id="exemple-43-a-command-line-stopwatch">
<h2>Exemple 43. A command-line stopwatch<a class="headerlink" href="#exemple-43-a-command-line-stopwatch" title="Link permanent a aquest títol">¶</a></h2>
<div class="highlight-sh"><div class="highlight"><pre><span class="c">#!/bin/sh</span>
<span class="c"># sw.sh</span>
<span class="c"># A command-line Stopwatch</span>

<span class="c"># Author: Pádraig Brady</span>
<span class="c">#    http://www.pixelbeat.org/scripts/sw</span>
<span class="c">#    (Minor reformatting by ABS Guide author.)</span>
<span class="c">#    Used in ABS Guide with script author&#39;s permission.</span>
<span class="c"># Notes:</span>
<span class="c">#    This script starts a few processes per lap, in addition to</span>
<span class="c">#    the shell loop processing, so the assumption is made that</span>
<span class="c">#    this takes an insignificant amount of time compared to</span>
<span class="c">#    the response time of humans (~.1s) (or the keyboard</span>
<span class="c">#    interrupt rate (~.05s)).</span>
<span class="c">#    &#39;?&#39; for splits must be entered twice if characters</span>
<span class="c">#    (erroneously) entered before it (on the same line).</span>
<span class="c">#    &#39;?&#39; since not generating a signal may be slightly delayed</span>
<span class="c">#    on heavily loaded systems.</span>
<span class="c">#    Lap timings on ubuntu may be slightly delayed due to:</span>
<span class="c">#    https://bugs.launchpad.net/bugs/62511</span>
<span class="c"># Changes:</span>
<span class="c">#    V1.0, 23 Aug 2005, Initial release</span>
<span class="c">#    V1.1, 26 Jul 2007, Allow both splits and laps from single invocation.</span>
<span class="c">#                       Only start timer after a key is pressed.</span>
<span class="c">#                       Indicate lap number</span>
<span class="c">#                       Cache programs at startup so there is less error</span>
<span class="c">#                       due to startup delays.</span>
<span class="c">#    V1.2, 01 Aug 2007, Work around `date` commands that don&#39;t have</span>
<span class="c">#                       nanoseconds.</span>
<span class="c">#                       Use stty to change interrupt keys to space for</span>
<span class="c">#                       laps etc.</span>
<span class="c">#                       Ignore other input as it causes problems.</span>
<span class="c">#    V1.3, 01 Aug 2007, Testing release.</span>
<span class="c">#    V1.4, 02 Aug 2007, Various tweaks to get working under ubuntu</span>
<span class="c">#                       and Mac OS X.</span>
<span class="c">#    V1.5, 27 Jun 2008, set LANG=C as got vague bug report about it.</span>

<span class="nb">export </span><span class="nv">LANG</span><span class="o">=</span>C

<span class="nb">ulimit</span> -c <span class="m">0</span>   <span class="c"># No coredumps from SIGQUIT.</span>
<span class="nb">trap</span> <span class="s1">&#39;&#39;</span> TSTP  <span class="c"># Ignore Ctrl-Z just in case.</span>
<span class="nv">save_tty</span><span class="o">=</span><span class="sb">`</span>stty -g<span class="sb">`</span> <span class="o">&amp;&amp;</span> <span class="nb">trap</span> <span class="s2">&quot;stty </span><span class="nv">$save_tty</span><span class="s2">&quot;</span> EXIT  <span class="c"># Restore tty on exit.</span>
stty quit <span class="s1">&#39; &#39;</span> <span class="c"># Space for laps rather than Ctrl-\.</span>
stty eof  <span class="s1">&#39;?&#39;</span> <span class="c"># ? for splits rather than Ctrl-D.</span>
stty -echo    <span class="c"># Don&#39;t echo input.</span>

cache_progs<span class="o">()</span> <span class="o">{</span>
    stty &gt; /dev/null
    date &gt; /dev/null
    grep . &lt; /dev/null
    <span class="o">(</span><span class="nb">echo</span> <span class="s2">&quot;import time&quot;</span>python<span class="o">)</span> 2&gt; /dev/null
    bc &lt; /dev/null
    sed <span class="s1">&#39;&#39;</span> &lt; /dev/null
    <span class="nb">printf</span> <span class="s1">&#39;1&#39;</span> &gt; /dev/null
    /usr/bin/time <span class="nb">false </span>2&gt; /dev/null
    cat &lt; /dev/null
<span class="o">}</span>
cache_progs   <span class="c"># To minimise startup delay.</span>

date +%s.%Ngrep -qF <span class="s1">&#39;N&#39;</span> <span class="o">&amp;&amp;</span> <span class="nv">use_python</span><span class="o">=</span><span class="m">1</span> <span class="c"># If `date` lacks nanoseconds.</span>
now<span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$use_python</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        <span class="nb">echo</span> <span class="s2">&quot;import time; print time.time()&quot;</span> 2&gt;/dev/nullpython
    <span class="k">else</span>
        <span class="nb">printf</span> <span class="s2">&quot;%.2f&quot;</span> <span class="sb">`</span>date +%s.%N<span class="sb">`</span>
    <span class="k">fi</span>
<span class="o">}</span>

fmt_seconds<span class="o">()</span> <span class="o">{</span>
    <span class="nv">seconds</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nv">mins</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$seconds</span>/60bc<span class="sb">`</span>
    <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$mins</span><span class="s2">&quot;</span> !<span class="o">=</span> <span class="s2">&quot;0&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        <span class="nv">seconds</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$seconds</span><span class="s2"> - (</span><span class="nv">$mins</span><span class="s2">*60)&quot;</span>bc<span class="sb">`</span>
        <span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$mins</span><span class="s2">:</span><span class="nv">$seconds</span><span class="s2">&quot;</span>
    <span class="k">else</span>
        <span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$seconds</span><span class="s2">&quot;</span>
    <span class="k">fi</span>
<span class="o">}</span>

total<span class="o">()</span> <span class="o">{</span>
    <span class="nv">end</span><span class="o">=</span><span class="sb">`</span>now<span class="sb">`</span>
    <span class="nv">total</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$end</span><span class="s2"> - </span><span class="nv">$start</span><span class="s2">&quot;</span>bc<span class="sb">`</span>
    fmt_seconds <span class="nv">$total</span>
<span class="o">}</span>

stop<span class="o">()</span> <span class="o">{</span>
    <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$lapped</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> lap <span class="s2">&quot;</span><span class="nv">$laptime</span><span class="s2">&quot;</span> <span class="s2">&quot;display&quot;</span>
    total
    <span class="nb">exit</span>
<span class="o">}</span>

lap<span class="o">()</span> <span class="o">{</span>
    <span class="nv">laptime</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>sed -n <span class="s1">&#39;s/.*real[^0-9.]*\(.*\)/\1/p&#39;</span><span class="sb">`</span>
    <span class="o">[</span> ! <span class="s2">&quot;</span><span class="nv">$laptime</span><span class="s2">&quot;</span> -o <span class="s2">&quot;</span><span class="nv">$laptime</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;0.00&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="k">return</span>
    <span class="c"># Signals too frequent.</span>
    <span class="nv">laptotal</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$laptime</span>+0<span class="nv">$laptotalbc</span><span class="sb">`</span>
    <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$2</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;display&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        <span class="nv">lapcount</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo </span>0<span class="nv">$lapcount</span>+1bc<span class="sb">`</span>
        <span class="nv">laptime</span><span class="o">=</span><span class="sb">`</span>fmt_seconds <span class="nv">$laptotal</span><span class="sb">`</span>
        <span class="nb">echo</span> <span class="nv">$laptime</span> <span class="s2">&quot;(</span><span class="nv">$lapcount</span><span class="s2">)&quot;</span>
        <span class="nv">lapped</span><span class="o">=</span><span class="s2">&quot;true&quot;</span>
        <span class="nv">laptotal</span><span class="o">=</span><span class="s2">&quot;0&quot;</span>
    <span class="k">fi</span>
<span class="o">}</span>

<span class="nb">echo</span> -n <span class="s2">&quot;Space for lap? for split | Ctrl-C to stop | Space to start...&quot;</span>&gt;<span class="p">&amp;</span>2

<span class="k">while</span> <span class="nb">true</span><span class="p">;</span> <span class="k">do</span>
    <span class="nb">trap true </span>INT QUIT  <span class="c"># Set signal handlers.</span>
    <span class="nv">laptime</span><span class="o">=</span><span class="sb">`</span>/usr/bin/time -p 2&gt;<span class="p">&amp;</span><span class="m">1</span> cat &gt;/dev/null<span class="sb">`</span>
    <span class="nv">ret</span><span class="o">=</span><span class="nv">$?</span>
    <span class="nb">trap</span> <span class="s1">&#39;&#39;</span> INT QUIT    <span class="c"># Ignore signals within this script.</span>
    <span class="k">if</span> <span class="o">[</span> <span class="nv">$ret</span> -eq <span class="m">1</span> -o <span class="nv">$ret</span> -eq <span class="m">2</span> -o <span class="nv">$ret</span> -eq <span class="m">130</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span> <span class="c"># SIGINT = stop</span>
        <span class="o">[</span> ! <span class="s2">&quot;</span><span class="nv">$start</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">{</span> <span class="nb">echo</span> &gt;<span class="p">&amp;</span>2<span class="p">;</span> <span class="nb">exit</span><span class="p">;</span> <span class="o">}</span>
        stop
    <span class="k">elif</span> <span class="o">[</span> <span class="nv">$ret</span> -eq <span class="m">3</span> -o <span class="nv">$ret</span> -eq <span class="m">131</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>             <span class="c"># SIGQUIT = lap</span>
        <span class="k">if</span> <span class="o">[</span> ! <span class="s2">&quot;</span><span class="nv">$start</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
            <span class="nv">start</span><span class="o">=</span><span class="sb">`</span>now<span class="sb">`</span> <span class="p">|</span><span class="nb">exit </span>1
            <span class="nb">echo</span> &gt;<span class="p">&amp;</span>2
            <span class="k">continue</span>
        <span class="k">fi</span>
        lap <span class="s2">&quot;</span><span class="nv">$laptime</span><span class="s2">&quot;</span> <span class="s2">&quot;display&quot;</span>
    <span class="k">else</span>                <span class="c"># eof = split</span>
        <span class="o">[</span> ! <span class="s2">&quot;</span><span class="nv">$start</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="k">continue</span>
        total
        lap <span class="s2">&quot;</span><span class="nv">$laptime</span><span class="s2">&quot;</span>  <span class="c"># Update laptotal.</span>
    <span class="k">fi</span>
<span class="k">done</span>

<span class="nb">exit</span> <span class="nv">$?</span>
</pre></div>
</div>
</div>
<div class="section" id="exemple-44-an-all-purpose-shell-scripting-homework-assignment-solution">
<h2>Exemple 44. An all-purpose shell scripting homework assignment solution<a class="headerlink" href="#exemple-44-an-all-purpose-shell-scripting-homework-assignment-solution" title="Link permanent a aquest títol">¶</a></h2>
<div class="highlight-sh"><div class="highlight"><pre><span class="c">#!/bin/bash</span>
<span class="c">#  homework.sh: All-purpose homework assignment solution.</span>
<span class="c">#  Author: M. Leo Cooper</span>
<span class="c">#  If you substitute your own name as author, then it is plagiarism,</span>
<span class="c">#+ possibly a lesser sin than cheating on your homework!</span>
<span class="c">#  License: Public Domain</span>

<span class="c">#  This script may be turned in to your instructor</span>
<span class="c">#+ in fulfillment of ALL shell scripting homework assignments.</span>
<span class="c">#  It&#39;s sparsely commented, but you, the student, can easily remedy that.</span>
<span class="c">#  The script author repudiates all responsibility!</span>

<span class="nv">DLA</span><span class="o">=</span>1
<span class="nv">P1</span><span class="o">=</span>2
<span class="nv">P2</span><span class="o">=</span>4
<span class="nv">P3</span><span class="o">=</span>7
<span class="nv">PP1</span><span class="o">=</span>0
<span class="nv">PP2</span><span class="o">=</span>8
<span class="nv">MAXL</span><span class="o">=</span>9
<span class="nv">E_LZY</span><span class="o">=</span>99

<span class="nb">declare</span> -a L
L<span class="o">[</span>0<span class="o">]=</span><span class="s2">&quot;3 4 0 17 29 8 13 18 19 17 20 2 19 14 17 28&quot;</span>
L<span class="o">[</span>1<span class="o">]=</span><span class="s2">&quot;8 29 12 14 18 19 29 4 12 15 7 0 19 8 2 0 11 11 24 29 17 4 6 17 4 19&quot;</span>
L<span class="o">[</span>2<span class="o">]=</span><span class="s2">&quot;29 19 7 0 19 29 8 29 7 0 21 4 29 13 4 6 11 4 2 19 4 3&quot;</span>
L<span class="o">[</span>3<span class="o">]=</span><span class="s2">&quot;19 14 29 2 14 12 15 11 4 19 4 29 19 7 8 18 29&quot;</span>
L<span class="o">[</span>4<span class="o">]=</span><span class="s2">&quot;18 2 7 14 14 11 22 14 17 10 29 0 18 18 8 6 13 12 4 13 19 26&quot;</span>
L<span class="o">[</span>5<span class="o">]=</span><span class="s2">&quot;15 11 4 0 18 4 29 0 2 2 4 15 19 29 12 24 29 7 20 12 1 11 4 29&quot;</span>
L<span class="o">[</span>6<span class="o">]=</span><span class="s2">&quot;4 23 2 20 18 4 29 14 5 29 4 6 17 4 6 8 14 20 18 29&quot;</span>
L<span class="o">[</span>7<span class="o">]=</span><span class="s2">&quot;11 0 25 8 13 4 18 18 27&quot;</span>
L<span class="o">[</span>8<span class="o">]=</span><span class="s2">&quot;0 13 3 29 6 17 0 3 4 29 12 4 29 0 2 2 14 17 3 8 13 6 11 24 26&quot;</span>
L<span class="o">[</span>9<span class="o">]=</span><span class="s2">&quot;19 7 0 13 10 29 24 14 20 26&quot;</span>

<span class="nb">declare</span> -a <span class="se">\</span>
<span class="nv">alph</span><span class="o">=(</span> A B C D E F G H I J K L M N O P Q R S T U V W X Y Z . , : <span class="s1">&#39; &#39;</span> <span class="o">)</span>


pt_lt <span class="o">()</span>
<span class="o">{</span>
  <span class="nb">echo</span> -n <span class="s2">&quot;</span><span class="si">${</span><span class="nv">alph</span><span class="p">[</span><span class="nv">$1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
  <span class="nb">echo</span> -n -e <span class="s2">&quot;\a&quot;</span>
  sleep <span class="nv">$DLA</span>
<span class="o">}</span>

b_r <span class="o">()</span>
<span class="o">{</span>
 <span class="nb">echo</span> -e <span class="s1">&#39;\E[31;48m\033[1m&#39;</span>
<span class="o">}</span>

cr <span class="o">()</span>
<span class="o">{</span>
 <span class="nb">echo</span> -e <span class="s2">&quot;\a&quot;</span>
 sleep <span class="nv">$DLA</span>
<span class="o">}</span>

restore <span class="o">()</span>
<span class="o">{</span>
  <span class="nb">echo</span> -e <span class="s1">&#39;\033[0m&#39;</span>            <span class="c"># Bold off.</span>
  tput sgr0                    <span class="c"># Normal.</span>
<span class="o">}</span>


p_l <span class="o">()</span>
<span class="o">{</span>
  <span class="k">for</span> ltr in <span class="nv">$1</span>
  <span class="k">do</span>
    pt_lt <span class="s2">&quot;</span><span class="nv">$ltr</span><span class="s2">&quot;</span>
  <span class="k">done</span>
<span class="o">}</span>

<span class="c"># ----------------------</span>
b_r

<span class="k">for</span> i in <span class="k">$(</span>seq <span class="m">0</span> <span class="nv">$MAXL</span><span class="k">)</span>
<span class="k">do</span>
  p_l <span class="s2">&quot;</span><span class="si">${</span><span class="nv">L</span><span class="p">[i]</span><span class="si">}</span><span class="s2">&quot;</span>
  <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;</span><span class="nv">$i</span><span class="s2">&quot;</span> -eq <span class="s2">&quot;</span><span class="nv">$P1</span><span class="s2">&quot;</span> <span class="p">|</span><span class="s2">&quot;</span><span class="nv">$i</span><span class="s2">&quot;</span> -eq <span class="s2">&quot;</span><span class="nv">$P2</span><span class="s2">&quot;</span> <span class="o">||</span> <span class="s2">&quot;</span><span class="nv">$i</span><span class="s2">&quot;</span> -eq <span class="s2">&quot;</span><span class="nv">$P3</span><span class="s2">&quot;</span> <span class="o">]]</span>
  <span class="k">then</span>
    cr
  <span class="k">elif</span> <span class="o">[[</span> <span class="s2">&quot;</span><span class="nv">$i</span><span class="s2">&quot;</span> -eq <span class="s2">&quot;</span><span class="nv">$PP1</span><span class="s2">&quot;</span> <span class="p">|</span><span class="s2">&quot;</span><span class="nv">$i</span><span class="s2">&quot;</span> -eq <span class="s2">&quot;</span><span class="nv">$PP2</span><span class="s2">&quot;</span> <span class="o">]]</span>
  <span class="k">then</span>
    cr<span class="p">;</span> cr
  <span class="k">fi</span>
<span class="k">done</span>

restore
<span class="c"># ----------------------</span>

<span class="nb">echo</span>

<span class="nb">exit</span> <span class="nv">$E_LZY</span>

<span class="c">#  A typical example of an obfuscated script that is difficult</span>
<span class="c">#+ to understand, and frustrating to maintain.</span>
<span class="c">#  In your career as a sysadmin, you&#39;ll run into these critters</span>
<span class="c">#+ all too often.</span>
</pre></div>
</div>
</div>
<div class="section" id="exemple-45-the-knight-s-tour">
<h2>Exemple 45. The Knight&#8217;s Tour<a class="headerlink" href="#exemple-45-the-knight-s-tour" title="Link permanent a aquest títol">¶</a></h2>
<div class="highlight-sh"><div class="highlight"><pre><span class="c">#!/bin/bash</span>
<span class="c"># ktour.sh</span>

<span class="c"># author: mendel cooper</span>
<span class="c"># reldate: 12 Jan 2009</span>
<span class="c"># license: public domain</span>
<span class="c"># (Not much sense GPLing something that&#39;s pretty much in the common</span>
<span class="c">#+ domain anyhow.)</span>

<span class="c">###################################################################</span>
<span class="c">#             The Knight&#39;s Tour, a classic problem.               #</span>
<span class="c">#             =====================================               #</span>
<span class="c">#  The knight must move onto every square of the chess board,     #</span>
<span class="c">#  but cannot revisit any square he has already visited.          #</span>
<span class="c">#                                                                 #</span>
<span class="c">#  And just why is Sir Knight unwelcome for a return visit?       #</span>
<span class="c">#  Could it be that he has a habit of partying into the wee hours #</span>
<span class="c">#+ of the morning?                                                #</span>
<span class="c">#  Possibly he leaves pizza crusts in the bed, empty beer bottles #</span>
<span class="c">#+ all over the floor, and clogs the plumbing. . . .              #</span>
<span class="c">#                                                                 #</span>
<span class="c">#  -------------------------------------------------------------  #</span>
<span class="c">#                                                                 #</span>
<span class="c">#  Usage: ktour.sh [start-square] [stupid]                        #</span>
<span class="c">#                                                                 #</span>
<span class="c">#  Note that start-square can be a square number                  #</span>
<span class="c">#+ in the range 0 - 63 ... or                                     #</span>
<span class="c">#  a square designator in conventional chess notation,            #</span>
<span class="c">#  such as a1, f5, h3, etc.                                       #</span>
<span class="c">#                                                                 #</span>
<span class="c">#  If start-square-number not supplied,                           #</span>
<span class="c">#+ then starts on a random square somewhere on the board.         #</span>
<span class="c">#                                                                 #</span>
<span class="c"># &quot;stupid&quot; as second parameter sets the stupid strategy.          #</span>
<span class="c">#                                                                 #</span>
<span class="c">#  Examples:                                                      #</span>
<span class="c">#  ktour.sh 23          starts on square #23 (h3)                 #</span>
<span class="c">#  ktour.sh g6 stupid   starts on square #46,                     #</span>
<span class="c">#                       using &quot;stupid&quot; (non-Warnsdorff) strategy. #</span>
<span class="c">###################################################################</span>

<span class="nv">DEBUG</span><span class="o">=</span>      <span class="c"># Set this to echo debugging info to stdout.</span>
<span class="nv">SUCCESS</span><span class="o">=</span>0
<span class="nv">FAIL</span><span class="o">=</span>99
<span class="nv">BADMOVE</span><span class="o">=</span>-999
<span class="nv">FAILURE</span><span class="o">=</span>1
<span class="nv">LINELEN</span><span class="o">=</span><span class="m">21</span>  <span class="c"># How many moves to display per line.</span>
<span class="c"># ---------------------------------------- #</span>
<span class="c"># Board array params</span>
<span class="nv">ROWS</span><span class="o">=</span><span class="m">8</span>   <span class="c"># 8 x 8 board.</span>
<span class="nv">COLS</span><span class="o">=</span>8
<span class="nb">let</span> <span class="s2">&quot;SQUARES = </span><span class="nv">$ROWS</span><span class="s2"> * </span><span class="nv">$COLS</span><span class="s2">&quot;</span>
<span class="nb">let</span> <span class="s2">&quot;MAX = </span><span class="nv">$SQUARES</span><span class="s2"> - 1&quot;</span>
<span class="nv">MIN</span><span class="o">=</span>0
<span class="c"># 64 squares on board, indexed from 0 to 63.</span>

<span class="nv">VISITED</span><span class="o">=</span>1
<span class="nv">UNVISITED</span><span class="o">=</span>-1
<span class="nv">UNVSYM</span><span class="o">=</span><span class="s2">&quot;##&quot;</span>
<span class="c"># ---------------------------------------- #</span>
<span class="c"># Global variables.</span>
<span class="nv">startpos</span><span class="o">=</span>    <span class="c"># Starting position (square #, 0 - 63).</span>
<span class="nv">currpos</span><span class="o">=</span>     <span class="c"># Current position.</span>
<span class="nv">movenum</span><span class="o">=</span>     <span class="c"># Move number.</span>
<span class="nv">CRITPOS</span><span class="o">=</span><span class="m">37</span>   <span class="c"># Have to patch for f5 starting position!</span>

<span class="nb">declare</span> -i board
<span class="c"># Use a one-dimensional array to simulate a two-dimensional one.</span>
<span class="c"># This can make life difficult and result in ugly kludges; see below.</span>
<span class="nb">declare</span> -i moves  <span class="c"># Offsets from current knight position.</span>


initialize_board <span class="o">()</span>
<span class="o">{</span>
  <span class="nb">local </span>idx

  <span class="k">for</span> idx in <span class="o">{</span>0..63<span class="o">}</span>
  <span class="k">do</span>
    board<span class="o">[</span><span class="nv">$idx</span><span class="o">]=</span><span class="nv">$UNVISITED</span>
  <span class="k">done</span>
<span class="o">}</span>



print_board <span class="o">()</span>
<span class="o">{</span>
  <span class="nb">local </span>idx

  <span class="nb">echo</span> <span class="s2">&quot;    _____________________________________&quot;</span>
  <span class="k">for</span> row in <span class="o">{</span>7..0<span class="o">}</span>               <span class="c">#  Reverse order of rows ...</span>
  <span class="k">do</span>                              <span class="c">#+ so it prints in chessboard order.</span>
    <span class="nb">let</span> <span class="s2">&quot;rownum = </span><span class="nv">$row</span><span class="s2"> + 1&quot;</span>       <span class="c">#  Start numbering rows at 1.</span>
    <span class="nb">echo</span> -n <span class="s2">&quot;</span><span class="nv">$rownum</span><span class="s2">  |&quot;</span>          <span class="c">#  Mark board edge with border and</span>
    <span class="k">for</span> column in <span class="o">{</span>0..7<span class="o">}</span>          <span class="c">#+ &quot;algebraic notation.&quot;</span>
    <span class="k">do</span>
      <span class="nb">let</span> <span class="s2">&quot;idx = </span><span class="nv">$ROWS</span><span class="s2">*</span><span class="nv">$row</span><span class="s2"> + </span><span class="nv">$column</span><span class="s2">&quot;</span>
      <span class="k">if</span> <span class="o">[</span> <span class="si">${</span><span class="nv">board</span><span class="p">[idx]</span><span class="si">}</span> -eq <span class="nv">$UNVISITED</span> <span class="o">]</span>
      <span class="k">then</span>
        <span class="nb">echo</span> -n <span class="s2">&quot;</span><span class="nv">$UNVSYM</span><span class="s2">   &quot;</span>      <span class="c">##</span>
      <span class="k">else</span>                        <span class="c"># Mark square with move number.</span>
        <span class="nb">printf</span> <span class="s2">&quot;%02d &quot;</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">board</span><span class="p">[idx]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span> <span class="nb">echo</span> -n <span class="s2">&quot;  &quot;</span>
      <span class="k">fi</span>
    <span class="k">done</span>
    <span class="nb">echo</span> -e -n <span class="s2">&quot;\b\b\b|&quot;</span>  <span class="c"># \b is a backspace.</span>
    <span class="nb">echo</span>                  <span class="c"># -e enables echoing escaped chars.</span>
  <span class="k">done</span>

  <span class="nb">echo</span> <span class="s2">&quot;    -------------------------------------&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot;     a    b    c    d    e    f    g    h&quot;</span>
<span class="o">}</span>



failure<span class="o">()</span>
<span class="o">{</span> <span class="c"># Whine, then bail out.</span>
  <span class="nb">echo</span>
<span class="nb">  </span>print_board
  <span class="nb">echo</span>
<span class="nb">  echo</span>    <span class="s2">&quot;   Waah!!! Ran out of squares to move to!&quot;</span>
  <span class="nb">echo</span> -n <span class="s2">&quot;   Knight&#39;s Tour attempt ended&quot;</span>
  <span class="nb">echo</span>    <span class="s2">&quot; on </span><span class="k">$(</span>to_algebraic <span class="nv">$currpos</span><span class="k">)</span><span class="s2"> [square #</span><span class="nv">$currpos</span><span class="s2">]&quot;</span>
  <span class="nb">echo</span>    <span class="s2">&quot;   after just </span><span class="nv">$movenum</span><span class="s2"> moves!&quot;</span>
  <span class="nb">echo</span>
<span class="nb">  exit</span> <span class="nv">$FAIL</span>
<span class="o">}</span>



xlat_coords <span class="o">()</span>   <span class="c">#  Translate x/y coordinates to board position</span>
<span class="o">{</span>                <span class="c">#+ (board-array element #).</span>
  <span class="c">#  For user input of starting board position as x/y coords.</span>
  <span class="c">#  This function not used in initial release of ktour.sh.</span>
  <span class="c">#  May be used in an updated version, for compatibility with</span>
  <span class="c">#+ standard implementation of the Knight&#39;s Tour in C, Python, etc.</span>
  <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> -o -z <span class="s2">&quot;</span><span class="nv">$2</span><span class="s2">&quot;</span> <span class="o">]</span>
  <span class="k">then</span>
    <span class="k">return</span> <span class="nv">$FAIL</span>
  <span class="k">fi</span>

  <span class="nb">local </span><span class="nv">xc</span><span class="o">=</span><span class="nv">$1</span>
  <span class="nb">local </span><span class="nv">yc</span><span class="o">=</span><span class="nv">$2</span>

  <span class="nb">let</span> <span class="s2">&quot;board_index = </span><span class="nv">$xc</span><span class="s2"> * </span><span class="nv">$ROWS</span><span class="s2"> + yc&quot;</span>

  <span class="k">if</span> <span class="o">[</span> <span class="nv">$board_index</span> -lt <span class="nv">$MIN</span> -o <span class="nv">$board_index</span> -gt <span class="nv">$MAX</span> <span class="o">]</span>
  <span class="k">then</span>
    <span class="k">return</span> <span class="nv">$FAIL</span>    <span class="c"># Strayed off the board!</span>
  <span class="k">else</span>
    <span class="k">return</span> <span class="nv">$board_index</span>
  <span class="k">fi</span>
<span class="o">}</span>



to_algebraic <span class="o">()</span>   <span class="c">#  Translate board position (board-array element #)</span>
<span class="o">{</span>                 <span class="c">#+ to standard algebraic notation used by chess players.</span>
  <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> <span class="o">]</span>
  <span class="k">then</span>
    <span class="k">return</span> <span class="nv">$FAIL</span>
  <span class="k">fi</span>

  <span class="nb">local </span><span class="nv">element_no</span><span class="o">=</span><span class="nv">$1</span>   <span class="c"># Numerical board position.</span>
  <span class="nb">local </span><span class="nv">col_arr</span><span class="o">=(</span> a b c d e f g h <span class="o">)</span>
  <span class="nb">local </span><span class="nv">row_arr</span><span class="o">=(</span> <span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">4</span> <span class="m">5</span> <span class="m">6</span> <span class="m">7</span> <span class="m">8</span> <span class="o">)</span>

  <span class="nb">let</span> <span class="s2">&quot;row_no = </span><span class="nv">$element_no</span><span class="s2"> / </span><span class="nv">$ROWS</span><span class="s2">&quot;</span>
  <span class="nb">let</span> <span class="s2">&quot;col_no = </span><span class="nv">$element_no</span><span class="s2"> % </span><span class="nv">$ROWS</span><span class="s2">&quot;</span>
  <span class="nv">t1</span><span class="o">=</span><span class="si">${</span><span class="nv">col_arr</span><span class="p">[col_no]</span><span class="si">}</span><span class="p">;</span> <span class="nv">t2</span><span class="o">=</span><span class="si">${</span><span class="nv">row_arr</span><span class="p">[row_no]</span><span class="si">}</span>
  <span class="nb">local </span><span class="nv">apos</span><span class="o">=</span><span class="nv">$t1$t2</span>   <span class="c"># Concatenate.</span>
  <span class="nb">echo</span> <span class="nv">$apos</span>
<span class="o">}</span>



from_algebraic <span class="o">()</span>   <span class="c">#  Translate standard algebraic chess notation</span>
<span class="o">{</span>                   <span class="c">#+ to numerical board position (board-array element #).</span>
                    <span class="c">#  Or recognize numerical input &amp; return it unchanged.</span>
  <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> <span class="o">]</span>
  <span class="k">then</span>
    <span class="k">return</span> <span class="nv">$FAIL</span>
  <span class="k">fi</span>   <span class="c"># If no command-line arg, then will default to random start pos.</span>

  <span class="nb">local </span>ix
  <span class="nb">local </span><span class="nv">ix_count</span><span class="o">=</span>0
  <span class="nb">local </span>b_index     <span class="c"># Board index [0-63]</span>
  <span class="nb">local </span><span class="nv">alpos</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>

  <span class="nv">arow</span><span class="o">=</span><span class="si">${</span><span class="nv">alpos</span><span class="p">:</span><span class="nv">0</span><span class="p">:</span><span class="nv">1</span><span class="si">}</span> <span class="c"># position = 0, length = 1</span>
  <span class="nv">acol</span><span class="o">=</span><span class="si">${</span><span class="nv">alpos</span><span class="p">:</span><span class="nv">1</span><span class="p">:</span><span class="nv">1</span><span class="si">}</span>

  <span class="k">if</span> <span class="o">[[</span> <span class="nv">$arow</span> <span class="o">=</span>~ <span class="o">[[</span>:digit:<span class="o">]]</span> <span class="o">]]</span>   <span class="c">#  Numerical input?</span>
  <span class="k">then</span>       <span class="c">#  POSIX char class</span>
    <span class="k">if</span> <span class="o">[[</span> <span class="nv">$acol</span> <span class="o">=</span>~ <span class="o">[[</span>:alpha:<span class="o">]]</span> <span class="o">]]</span> <span class="c"># Number followed by a letter? Illegal!</span>
      <span class="k">then</span> <span class="k">return</span> <span class="nv">$FAIL</span>
    <span class="k">else</span> <span class="k">if</span> <span class="o">[</span> <span class="nv">$alpos</span> -gt <span class="nv">$MAX</span> <span class="o">]</span>   <span class="c"># Off board?</span>
      <span class="k">then</span> <span class="k">return</span> <span class="nv">$FAIL</span>
    <span class="k">else</span> <span class="k">return</span> <span class="nv">$alpos</span>            <span class="c">#  Return digit(s) unchanged . . .</span>
      <span class="k">fi</span>                          <span class="c">#+ if within range.</span>
    <span class="k">fi</span>
  <span class="k">fi</span>

  <span class="k">if</span> <span class="o">[[</span> <span class="nv">$acol</span> -eq <span class="nv">$MIN</span> <span class="p">|</span><span class="nv">$acol</span> -gt <span class="nv">$ROWS</span> <span class="o">]]</span>
  <span class="k">then</span>        <span class="c"># Outside of range 1 - 8?</span>
    <span class="k">return</span> <span class="nv">$FAIL</span>
  <span class="k">fi</span>

  <span class="k">for</span> ix in a b c d e f g h
  <span class="k">do</span>  <span class="c"># Convert column letter to column number.</span>
   <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$arow</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="nv">$ix</span><span class="s2">&quot;</span> <span class="o">]</span>
   <span class="k">then</span>
     <span class="nb">break</span>
<span class="nb">   </span><span class="k">fi</span>
  <span class="o">((</span>ix_count++<span class="o">))</span>    <span class="c"># Find index count.</span>
  <span class="k">done</span>

  <span class="o">((</span>acol--<span class="o">))</span>        <span class="c"># Decrementing converts to zero-based array.</span>
  <span class="nb">let</span> <span class="s2">&quot;b_index = </span><span class="nv">$ix_count</span><span class="s2"> + </span><span class="nv">$acol</span><span class="s2"> * </span><span class="nv">$ROWS</span><span class="s2">&quot;</span>

  <span class="k">if</span> <span class="o">[</span> <span class="nv">$b_index</span> -gt <span class="nv">$MAX</span> <span class="o">]</span>   <span class="c"># Off board?</span>
  <span class="k">then</span>
    <span class="k">return</span> <span class="nv">$FAIL</span>
  <span class="k">fi</span>

  <span class="k">return</span> <span class="nv">$b_index</span>

<span class="o">}</span>


generate_moves <span class="o">()</span>   <span class="c">#  Calculate all valid knight moves,</span>
<span class="o">{</span>                   <span class="c">#+ relative to current position ($1),</span>
                    <span class="c">#+ and store in ${moves} array.</span>
  <span class="nb">local </span><span class="nv">kt_hop</span><span class="o">=</span><span class="m">1</span>    <span class="c">#  One square  :: short leg of knight move.</span>
  <span class="nb">local </span><span class="nv">kt_skip</span><span class="o">=</span><span class="m">2</span>   <span class="c">#  Two squares :: long leg  of knight move.</span>
  <span class="nb">local </span><span class="nv">valmov</span><span class="o">=</span><span class="m">0</span>    <span class="c">#  Valid moves.</span>
  <span class="nb">local </span>row_pos<span class="p">;</span> <span class="nb">let</span> <span class="s2">&quot;row_pos = </span><span class="nv">$1</span><span class="s2"> % </span><span class="nv">$COLS</span><span class="s2">&quot;</span>


  <span class="nb">let</span> <span class="s2">&quot;move1 = -</span><span class="nv">$kt_skip</span><span class="s2"> + </span><span class="nv">$ROWS</span><span class="s2">&quot;</span>           <span class="c"># 2 sideways to-the-left,  1 up</span>
    <span class="k">if</span> <span class="o">[[</span> <span class="sb">`</span>expr <span class="nv">$row_pos</span> - <span class="nv">$kt_skip</span><span class="sb">`</span> -lt <span class="nv">$MIN</span> <span class="o">]]</span>   <span class="c"># An ugly, ugly kludge!</span>
    <span class="k">then</span>                                           <span class="c"># Can&#39;t move off board.</span>
      <span class="nv">move1</span><span class="o">=</span><span class="nv">$BADMOVE</span>                               <span class="c"># Not even temporarily.</span>
    <span class="k">else</span>
      <span class="o">((</span>valmov++<span class="o">))</span>
    <span class="k">fi</span>
  <span class="nb">let</span> <span class="s2">&quot;move2 = -</span><span class="nv">$kt_hop</span><span class="s2"> + </span><span class="nv">$kt_skip</span><span class="s2"> * </span><span class="nv">$ROWS</span><span class="s2">&quot;</span> <span class="c"># 1 sideways to-the-left,  2 up</span>
    <span class="k">if</span> <span class="o">[[</span> <span class="sb">`</span>expr <span class="nv">$row_pos</span> - <span class="nv">$kt_hop</span><span class="sb">`</span> -lt <span class="nv">$MIN</span> <span class="o">]]</span>    <span class="c"># Kludge continued ...</span>
    <span class="k">then</span>
      <span class="nv">move2</span><span class="o">=</span><span class="nv">$BADMOVE</span>
    <span class="k">else</span>
      <span class="o">((</span>valmov++<span class="o">))</span>
    <span class="k">fi</span>
  <span class="nb">let</span> <span class="s2">&quot;move3 =  </span><span class="nv">$kt_hop</span><span class="s2"> + </span><span class="nv">$kt_skip</span><span class="s2"> * </span><span class="nv">$ROWS</span><span class="s2">&quot;</span> <span class="c"># 1 sideways to-the-right, 2 up</span>
    <span class="k">if</span> <span class="o">[[</span> <span class="sb">`</span>expr <span class="nv">$row_pos</span> + <span class="nv">$kt_hop</span><span class="sb">`</span> -ge <span class="nv">$COLS</span> <span class="o">]]</span>
    <span class="k">then</span>
      <span class="nv">move3</span><span class="o">=</span><span class="nv">$BADMOVE</span>
    <span class="k">else</span>
      <span class="o">((</span>valmov++<span class="o">))</span>
    <span class="k">fi</span>
  <span class="nb">let</span> <span class="s2">&quot;move4 =  </span><span class="nv">$kt_skip</span><span class="s2"> + </span><span class="nv">$ROWS</span><span class="s2">&quot;</span>           <span class="c"># 2 sideways to-the-right, 1 up</span>
    <span class="k">if</span> <span class="o">[[</span> <span class="sb">`</span>expr <span class="nv">$row_pos</span> + <span class="nv">$kt_skip</span><span class="sb">`</span> -ge <span class="nv">$COLS</span> <span class="o">]]</span>
    <span class="k">then</span>
      <span class="nv">move4</span><span class="o">=</span><span class="nv">$BADMOVE</span>
    <span class="k">else</span>
      <span class="o">((</span>valmov++<span class="o">))</span>
    <span class="k">fi</span>
  <span class="nb">let</span> <span class="s2">&quot;move5 =  </span><span class="nv">$kt_skip</span><span class="s2"> - </span><span class="nv">$ROWS</span><span class="s2">&quot;</span>           <span class="c"># 2 sideways to-the-right, 1 dn</span>
    <span class="k">if</span> <span class="o">[[</span> <span class="sb">`</span>expr <span class="nv">$row_pos</span> + <span class="nv">$kt_skip</span><span class="sb">`</span> -ge <span class="nv">$COLS</span> <span class="o">]]</span>
    <span class="k">then</span>
      <span class="nv">move5</span><span class="o">=</span><span class="nv">$BADMOVE</span>
    <span class="k">else</span>
      <span class="o">((</span>valmov++<span class="o">))</span>
    <span class="k">fi</span>
  <span class="nb">let</span> <span class="s2">&quot;move6 =  </span><span class="nv">$kt_hop</span><span class="s2"> - </span><span class="nv">$kt_skip</span><span class="s2"> * </span><span class="nv">$ROWS</span><span class="s2">&quot;</span> <span class="c"># 1 sideways to-the-right, 2 dn</span>
    <span class="k">if</span> <span class="o">[[</span> <span class="sb">`</span>expr <span class="nv">$row_pos</span> + <span class="nv">$kt_hop</span><span class="sb">`</span> -ge <span class="nv">$COLS</span> <span class="o">]]</span>
    <span class="k">then</span>
      <span class="nv">move6</span><span class="o">=</span><span class="nv">$BADMOVE</span>
    <span class="k">else</span>
      <span class="o">((</span>valmov++<span class="o">))</span>
    <span class="k">fi</span>
  <span class="nb">let</span> <span class="s2">&quot;move7 = -</span><span class="nv">$kt_hop</span><span class="s2"> - </span><span class="nv">$kt_skip</span><span class="s2"> * </span><span class="nv">$ROWS</span><span class="s2">&quot;</span> <span class="c"># 1 sideways to-the-left,  2 dn</span>
    <span class="k">if</span> <span class="o">[[</span> <span class="sb">`</span>expr <span class="nv">$row_pos</span> - <span class="nv">$kt_hop</span><span class="sb">`</span> -lt <span class="nv">$MIN</span> <span class="o">]]</span>
    <span class="k">then</span>
      <span class="nv">move7</span><span class="o">=</span><span class="nv">$BADMOVE</span>
    <span class="k">else</span>
      <span class="o">((</span>valmov++<span class="o">))</span>
    <span class="k">fi</span>
  <span class="nb">let</span> <span class="s2">&quot;move8 = -</span><span class="nv">$kt_skip</span><span class="s2"> - </span><span class="nv">$ROWS</span><span class="s2">&quot;</span>           <span class="c"># 2 sideways to-the-left,  1 dn</span>
    <span class="k">if</span> <span class="o">[[</span> <span class="sb">`</span>expr <span class="nv">$row_pos</span> - <span class="nv">$kt_skip</span><span class="sb">`</span> -lt <span class="nv">$MIN</span> <span class="o">]]</span>
    <span class="k">then</span>
      <span class="nv">move8</span><span class="o">=</span><span class="nv">$BADMOVE</span>
    <span class="k">else</span>
      <span class="o">((</span>valmov++<span class="o">))</span>
    <span class="k">fi</span>   <span class="c"># There must be a better way to do this.</span>

  <span class="nb">local </span><span class="nv">m</span><span class="o">=(</span> <span class="nv">$valmov</span> <span class="nv">$move1</span> <span class="nv">$move2</span> <span class="nv">$move3</span> <span class="nv">$move4</span> <span class="nv">$move5</span> <span class="nv">$move6</span> <span class="nv">$move7</span> <span class="nv">$move8</span> <span class="o">)</span>
  <span class="c"># ${moves[0]} = number of valid moves.</span>
  <span class="c"># ${moves[1]} ... ${moves[8]} = possible moves.</span>
  <span class="nb">echo</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">m</span><span class="p">[*]</span><span class="si">}</span><span class="s2">&quot;</span>    <span class="c"># Elements of array to stdout for capture in a var.</span>

<span class="o">}</span>



is_on_board <span class="o">()</span>  <span class="c"># Is position actually on the board?</span>
<span class="o">{</span>
  <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> -lt <span class="s2">&quot;</span><span class="nv">$MIN</span><span class="s2">&quot;</span> <span class="p">|</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> -gt <span class="s2">&quot;</span><span class="nv">$MAX</span><span class="s2">&quot;</span> <span class="o">]]</span>
  <span class="k">then</span>
    <span class="k">return</span> <span class="nv">$FAILURE</span>
  <span class="k">else</span>
    <span class="k">return</span> <span class="nv">$SUCCESS</span>
  <span class="k">fi</span>
<span class="o">}</span>



do_move <span class="o">()</span>      <span class="c"># Move the knight!</span>
<span class="o">{</span>
  <span class="nb">local </span><span class="nv">valid_moves</span><span class="o">=</span>0
  <span class="nb">local </span>aapos
  <span class="nv">currposl</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
  <span class="nv">lmin</span><span class="o">=</span><span class="nv">$ROWS</span>
  <span class="nv">iex</span><span class="o">=</span>0
  <span class="nv">squarel</span><span class="o">=</span>
  <span class="nv">mpm</span><span class="o">=</span>
  <span class="nv">mov</span><span class="o">=</span>
  <span class="nb">declare</span> -a p_moves

  <span class="c">########################## DECIDE-MOVE #############################</span>
  <span class="k">if</span> <span class="o">[</span> <span class="nv">$startpos</span> -ne <span class="nv">$CRITPOS</span> <span class="o">]</span>
  <span class="k">then</span>   <span class="c"># CRITPOS = square #37</span>
    decide_move
  <span class="k">else</span>                     <span class="c"># Needs a special patch for startpos=37 !!!</span>
    decide_move_patched    <span class="c"># Why this particular move and no other ???</span>
  <span class="k">fi</span>
  <span class="c">####################################################################</span>

  <span class="o">((</span> ++movenum <span class="o">))</span>          <span class="c"># Increment move count.</span>
  <span class="nb">let</span> <span class="s2">&quot;square = </span><span class="nv">$currposl</span><span class="s2"> + </span><span class="si">${</span><span class="nv">moves</span><span class="p">[iex]</span><span class="si">}</span><span class="s2">&quot;</span>

  <span class="c">##################    DEBUG    ###############</span>
  <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$DEBUG</span><span class="s2">&quot;</span> <span class="o">]</span>
    <span class="k">then</span> debug   <span class="c"># Echo debugging information.</span>
  <span class="k">fi</span>
  <span class="c">##############################################</span>

  <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;</span><span class="nv">$square</span><span class="s2">&quot;</span> -gt <span class="nv">$MAX</span> <span class="p">|</span><span class="s2">&quot;</span><span class="nv">$square</span><span class="s2">&quot;</span> -lt <span class="nv">$MIN</span> <span class="p">|</span>
        <span class="si">${</span><span class="nv">board</span><span class="p">[square]</span><span class="si">}</span> -ne <span class="nv">$UNVISITED</span> <span class="o">]]</span>
  <span class="k">then</span>
    <span class="o">((</span> --movenum <span class="o">))</span>              <span class="c">#  Decrement move count,</span>
    <span class="nb">echo</span> <span class="s2">&quot;RAN OUT OF SQUARES!!!&quot;</span> <span class="c">#+ since previous one was invalid.</span>
    <span class="k">return</span> <span class="nv">$FAIL</span>
  <span class="k">fi</span>

  board<span class="o">[</span>square<span class="o">]=</span><span class="nv">$movenum</span>
  <span class="nv">currpos</span><span class="o">=</span><span class="nv">$square</span>       <span class="c"># Update current position.</span>
  <span class="o">((</span>valid_moves++<span class="o">))</span><span class="p">;</span>    <span class="c"># moves[0]=$valid_moves</span>
  <span class="nv">aapos</span><span class="o">=</span><span class="k">$(</span>to_algebraic <span class="nv">$square</span><span class="k">)</span>
  <span class="nb">echo</span> -n <span class="s2">&quot;</span><span class="nv">$aapos</span><span class="s2"> &quot;</span>
  <span class="nb">test</span> <span class="k">$((</span> <span class="nv">$Moves</span> <span class="o">%</span> <span class="nv">$LINELEN</span> <span class="k">))</span> -eq <span class="m">0</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span>
  <span class="c"># Print LINELEN=21 moves per line. A valid tour shows 3 complete lines.</span>
  <span class="k">return</span> <span class="nv">$valid_moves</span>   <span class="c"># Found a square to move to!</span>
<span class="o">}</span>



do_move_stupid<span class="o">()</span>   <span class="c">#  Dingbat algorithm,</span>
<span class="o">{</span>                  <span class="c">#+ courtesy of script author, *not* Warnsdorff.</span>
  <span class="nb">local </span><span class="nv">valid_moves</span><span class="o">=</span>0
  <span class="nb">local </span>movloc
  <span class="nb">local </span>squareloc
  <span class="nb">local </span>aapos
  <span class="nb">local </span><span class="nv">cposloc</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>

  <span class="k">for</span> movloc in <span class="o">{</span>1..8<span class="o">}</span>
  <span class="k">do</span>       <span class="c"># Move to first-found unvisited square.</span>
    <span class="nb">let</span> <span class="s2">&quot;squareloc = </span><span class="nv">$cposloc</span><span class="s2"> + </span><span class="si">${</span><span class="nv">moves</span><span class="p">[movloc]</span><span class="si">}</span><span class="s2">&quot;</span>
    is_on_board <span class="nv">$squareloc</span>
    <span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> -eq <span class="nv">$SUCCESS</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">[</span> <span class="si">${</span><span class="nv">board</span><span class="p">[squareloc]</span><span class="si">}</span> -eq <span class="nv">$UNVISITED</span> <span class="o">]</span>
    <span class="k">then</span>   <span class="c"># Add conditions to above if-test to improve algorithm.</span>
      <span class="o">((</span> ++movenum <span class="o">))</span>
      board<span class="o">[</span>squareloc<span class="o">]=</span><span class="nv">$movenum</span>
      <span class="nv">currpos</span><span class="o">=</span><span class="nv">$squareloc</span>     <span class="c"># Update current position.</span>
      <span class="o">((</span>valid_moves++<span class="o">))</span><span class="p">;</span>     <span class="c"># moves[0]=$valid_moves</span>
      <span class="nv">aapos</span><span class="o">=</span><span class="k">$(</span>to_algebraic <span class="nv">$squareloc</span><span class="k">)</span>
      <span class="nb">echo</span> -n <span class="s2">&quot;</span><span class="nv">$aapos</span><span class="s2"> &quot;</span>
      <span class="nb">test</span> <span class="k">$((</span> <span class="nv">$Moves</span> <span class="o">%</span> <span class="nv">$LINELEN</span> <span class="k">))</span> -eq <span class="m">0</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span>   <span class="c"># Print 21 moves/line.</span>
      <span class="k">return</span> <span class="nv">$valid_moves</span>    <span class="c"># Found a square to move to!</span>
    <span class="k">fi</span>
  <span class="k">done</span>

  <span class="k">return</span> <span class="nv">$FAIL</span>
  <span class="c">#  If no square found in all 8 loop iterations,</span>
  <span class="c">#+ then Knight&#39;s Tour attempt ends in failure.</span>

  <span class="c">#  Dingbat algorithm will typically fail after about 30 - 40 moves,</span>
  <span class="c">#+ but executes _much_ faster than Warnsdorff&#39;s in do_move() function.</span>
<span class="o">}</span>



decide_move <span class="o">()</span>         <span class="c">#  Which move will we make?</span>
<span class="o">{</span>                      <span class="c">#  But, fails on startpos=37 !!!</span>
  <span class="k">for</span> mov in <span class="o">{</span>1..8<span class="o">}</span>
  <span class="k">do</span>
    <span class="nb">let</span> <span class="s2">&quot;squarel = </span><span class="nv">$currposl</span><span class="s2"> + </span><span class="si">${</span><span class="nv">moves</span><span class="p">[mov]</span><span class="si">}</span><span class="s2">&quot;</span>
    is_on_board <span class="nv">$squarel</span>
    <span class="k">if</span> <span class="o">[[</span> <span class="nv">$?</span> -eq <span class="nv">$SUCCESS</span> <span class="o">&amp;&amp;</span> <span class="si">${</span><span class="nv">board</span><span class="p">[squarel]</span><span class="si">}</span> -eq <span class="nv">$UNVISITED</span> <span class="o">]]</span>
    <span class="k">then</span>   <span class="c">#  Find accessible square with least possible future moves.</span>
           <span class="c">#  This is Warnsdorff&#39;s algorithm.</span>
           <span class="c">#  What happens is that the knight wanders toward the outer edge</span>
           <span class="c">#+ of the board, then pretty much spirals inward.</span>
           <span class="c">#  Given two or more possible moves with same value of</span>
           <span class="c">#+ least-possible-future-moves, this implementation chooses</span>
           <span class="c">#+ the _first_ of those moves.</span>
           <span class="c">#  This means that there is not necessarily a unique solution</span>
           <span class="c">#+ for any given starting position.</span>

      possible_moves <span class="nv">$squarel</span>
      <span class="nv">mpm</span><span class="o">=</span><span class="nv">$?</span>
      p_moves<span class="o">[</span>mov<span class="o">]=</span><span class="nv">$mpm</span>

      <span class="k">if</span> <span class="o">[</span> <span class="nv">$mpm</span> -lt <span class="nv">$lmin</span> <span class="o">]</span>  <span class="c"># If less than previous minimum ...</span>
      <span class="k">then</span> <span class="c">#     ^^</span>
        <span class="nv">lmin</span><span class="o">=</span><span class="nv">$mpm</span>            <span class="c"># Update minimum.</span>
        <span class="nv">iex</span><span class="o">=</span><span class="nv">$mov</span>             <span class="c"># Save index.</span>
      <span class="k">fi</span>

    <span class="k">fi</span>
  <span class="k">done</span>
<span class="o">}</span>



decide_move_patched <span class="o">()</span>         <span class="c">#  Decide which move to make,</span>
<span class="o">{</span>  <span class="c">#        ^^^^^^^            #+ but only if startpos=37 !!!</span>
  <span class="k">for</span> mov in <span class="o">{</span>1..8<span class="o">}</span>
  <span class="k">do</span>
    <span class="nb">let</span> <span class="s2">&quot;squarel = </span><span class="nv">$currposl</span><span class="s2"> + </span><span class="si">${</span><span class="nv">moves</span><span class="p">[mov]</span><span class="si">}</span><span class="s2">&quot;</span>
    is_on_board <span class="nv">$squarel</span>
    <span class="k">if</span> <span class="o">[[</span> <span class="nv">$?</span> -eq <span class="nv">$SUCCESS</span> <span class="o">&amp;&amp;</span> <span class="si">${</span><span class="nv">board</span><span class="p">[squarel]</span><span class="si">}</span> -eq <span class="nv">$UNVISITED</span> <span class="o">]]</span>
    <span class="k">then</span>
      possible_moves <span class="nv">$squarel</span>
      <span class="nv">mpm</span><span class="o">=</span><span class="nv">$?</span>
      p_moves<span class="o">[</span>mov<span class="o">]=</span><span class="nv">$mpm</span>

      <span class="k">if</span> <span class="o">[</span> <span class="nv">$mpm</span> -le <span class="nv">$lmin</span> <span class="o">]</span>  <span class="c"># If less-than-or equal to prev. minimum!</span>
      <span class="k">then</span> <span class="c">#     ^^</span>
        <span class="nv">lmin</span><span class="o">=</span><span class="nv">$mpm</span>
        <span class="nv">iex</span><span class="o">=</span><span class="nv">$mov</span>
      <span class="k">fi</span>

    <span class="k">fi</span>
  <span class="k">done</span>                       <span class="c"># There has to be a better way to do this.</span>
<span class="o">}</span>



possible_moves <span class="o">()</span>            <span class="c">#  Calculate number of possible moves,</span>
<span class="o">{</span>                            <span class="c">#+ given the current position.</span>

  <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> <span class="o">]</span>
  <span class="k">then</span>
    <span class="k">return</span> <span class="nv">$FAIL</span>
  <span class="k">fi</span>

  <span class="nb">local </span><span class="nv">curr_pos</span><span class="o">=</span><span class="nv">$1</span>
  <span class="nb">local </span><span class="nv">valid_movl</span><span class="o">=</span>0
  <span class="nb">local </span><span class="nv">icx</span><span class="o">=</span>0
  <span class="nb">local </span>movl
  <span class="nb">local </span>sq
  <span class="nb">declare</span> -a movesloc

  <span class="nv">movesloc</span><span class="o">=(</span> <span class="k">$(</span>generate_moves <span class="nv">$curr_pos</span><span class="k">)</span> <span class="o">)</span>

  <span class="k">for</span> movl in <span class="o">{</span>1..8<span class="o">}</span>
  <span class="k">do</span>
    <span class="nb">let</span> <span class="s2">&quot;sq = </span><span class="nv">$curr_pos</span><span class="s2"> + </span><span class="si">${</span><span class="nv">movesloc</span><span class="p">[movl]</span><span class="si">}</span><span class="s2">&quot;</span>
    is_on_board <span class="nv">$sq</span>
    <span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> -eq <span class="nv">$SUCCESS</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">[</span> <span class="si">${</span><span class="nv">board</span><span class="p">[sq]</span><span class="si">}</span> -eq <span class="nv">$UNVISITED</span> <span class="o">]</span>
    <span class="k">then</span>
      <span class="o">((</span>valid_movl++<span class="o">))</span><span class="p">;</span>
    <span class="k">fi</span>
  <span class="k">done</span>

  <span class="k">return</span> <span class="nv">$valid_movl</span>         <span class="c"># Found a square to move to!</span>
<span class="o">}</span>


strategy <span class="o">()</span>
<span class="o">{</span>
  <span class="nb">echo</span>

<span class="nb">  </span><span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;</span><span class="nv">$STUPID</span><span class="s2">&quot;</span> <span class="o">]</span>
  <span class="k">then</span>
    <span class="k">for</span> Moves in <span class="o">{</span>1..63<span class="o">}</span>
    <span class="k">do</span>
      <span class="nv">cposl</span><span class="o">=</span><span class="nv">$1</span>
      <span class="nv">moves</span><span class="o">=(</span> <span class="k">$(</span>generate_moves <span class="nv">$currpos</span><span class="k">)</span> <span class="o">)</span>
      do_move_stupid <span class="s2">&quot;</span><span class="nv">$currpos</span><span class="s2">&quot;</span>
      <span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> -eq <span class="nv">$FAIL</span> <span class="o">]</span>
      <span class="k">then</span>
        failure
      <span class="k">fi</span>
      <span class="k">done</span>
  <span class="k">fi</span>

  <span class="c">#  Don&#39;t need an &quot;else&quot; clause here,</span>
  <span class="c">#+ because Stupid Strategy will always fail and exit!</span>
  <span class="k">for</span> Moves in <span class="o">{</span>1..63<span class="o">}</span>
  <span class="k">do</span>
    <span class="nv">cposl</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nv">moves</span><span class="o">=(</span> <span class="k">$(</span>generate_moves <span class="nv">$currpos</span><span class="k">)</span> <span class="o">)</span>
    do_move <span class="s2">&quot;</span><span class="nv">$currpos</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> -eq <span class="nv">$FAIL</span> <span class="o">]</span>
    <span class="k">then</span>
      failure
    <span class="k">fi</span>

  <span class="k">done</span>
        <span class="c">#  Could have condensed above two do-loops into a single one,</span>
  <span class="nb">echo</span>  <span class="c">#+ but this would have slowed execution.</span>

  print_board
  <span class="nb">echo</span>
<span class="nb">  echo</span> <span class="s2">&quot;Knight&#39;s Tour ends on </span><span class="k">$(</span>to_algebraic <span class="nv">$currpos</span><span class="k">)</span><span class="s2"> [square #</span><span class="nv">$currpos</span><span class="s2">].&quot;</span>
  <span class="k">return</span> <span class="nv">$SUCCESS</span>
<span class="o">}</span>

debug <span class="o">()</span>
<span class="o">{</span>       <span class="c"># Enable this by setting DEBUG=1 near beginning of script.</span>
  <span class="nb">local </span>n

  <span class="nb">echo</span> <span class="s2">&quot;=================================&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot;  At move number  </span><span class="nv">$movenum</span><span class="s2">:&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot; *** possible moves = </span><span class="nv">$mpm</span><span class="s2"> ***&quot;</span>
<span class="c"># echo &quot;### square = $square ###&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot;lmin = </span><span class="nv">$lmin</span><span class="s2">&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">moves</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span>

  <span class="k">for</span> n in <span class="o">{</span>1..8<span class="o">}</span>
  <span class="k">do</span>
    <span class="nb">echo</span> -n <span class="s2">&quot;(</span><span class="nv">$n</span><span class="s2">):</span><span class="si">${</span><span class="nv">p_moves</span><span class="p">[n]</span><span class="si">}</span><span class="s2"> &quot;</span>
  <span class="k">done</span>

  <span class="nb">echo</span>
<span class="nb">  echo</span> <span class="s2">&quot;iex = </span><span class="nv">$iex</span><span class="s2"> :: moves[iex] = </span><span class="si">${</span><span class="nv">moves</span><span class="p">[iex]</span><span class="si">}</span><span class="s2">&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot;square = </span><span class="nv">$square</span><span class="s2">&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot;=================================&quot;</span>
  <span class="nb">echo</span>
<span class="o">}</span> <span class="c"># Gives pretty complete status after ea. move.</span>



<span class="c"># =============================================================== #</span>
<span class="c"># int main () {</span>
from_algebraic <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
<span class="nv">startpos</span><span class="o">=</span><span class="nv">$?</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$startpos</span><span class="s2">&quot;</span> -eq <span class="s2">&quot;</span><span class="nv">$FAIL</span><span class="s2">&quot;</span> <span class="o">]</span>          <span class="c"># Okay even if no $1.</span>
<span class="k">then</span>   <span class="c">#         ^^^^^^^^^^^              Okay even if input -lt 0.</span>
  <span class="nb">echo</span> <span class="s2">&quot;No starting square specified (or illegal input).&quot;</span>
  <span class="nb">let</span> <span class="s2">&quot;startpos = </span><span class="nv">$RANDOM</span><span class="s2"> % </span><span class="nv">$SQUARES</span><span class="s2">&quot;</span>   <span class="c"># 0 - 63 permissable range.</span>
<span class="k">fi</span>


<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$2</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;stupid&quot;</span> <span class="o">]</span>
<span class="k">then</span>
  <span class="nv">STUPID</span><span class="o">=</span>1
  <span class="nb">echo</span> -n <span class="s2">&quot;     ### Stupid Strategy ###&quot;</span>
<span class="k">else</span>
  <span class="nv">STUPID</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
  <span class="nb">echo</span> -n <span class="s2">&quot;  *** Warnsdorff&#39;s Algorithm ***&quot;</span>
<span class="k">fi</span>


initialize_board

<span class="nv">movenum</span><span class="o">=</span>0
board<span class="o">[</span>startpos<span class="o">]=</span><span class="nv">$movenum</span>   <span class="c"># Mark each board square with move number.</span>
<span class="nv">currpos</span><span class="o">=</span><span class="nv">$startpos</span>
<span class="nv">algpos</span><span class="o">=</span><span class="k">$(</span>to_algebraic <span class="nv">$startpos</span><span class="k">)</span>

<span class="nb">echo</span><span class="p">;</span> <span class="nb">echo</span> <span class="s2">&quot;Starting from </span><span class="nv">$algpos</span><span class="s2"> [square #</span><span class="nv">$startpos</span><span class="s2">] ...&quot;</span><span class="p">;</span> <span class="nb">echo</span>
<span class="nb">echo</span> -n <span class="s2">&quot;Moves:&quot;</span>

strategy <span class="s2">&quot;</span><span class="nv">$currpos</span><span class="s2">&quot;</span>

<span class="nb">echo</span>

<span class="nb">exit </span><span class="m">0</span>   <span class="c"># return 0;</span>

<span class="c"># }      # End of main() pseudo-function.</span>
<span class="c"># =============================================================== #</span>


<span class="c"># Exercises:</span>
<span class="c"># ---------</span>
<span class="c">#</span>
<span class="c"># 1) Extend this example to a 10 x 10 board or larger.</span>
<span class="c"># 2) Improve the &quot;stupid strategy&quot; by modifying the</span>
<span class="c">#    do_move_stupid function.</span>
<span class="c">#    Hint: Prevent straying into corner squares in early moves</span>
<span class="c">#          (the exact opposite of Warnsdorff&#39;s algorithm!).</span>
<span class="c"># 3) This script could stand considerable improvement and</span>
<span class="c">#    streamlining, especially in the poorly-written</span>
<span class="c">#    generate_moves() function</span>
<span class="c">#    and in the DECIDE-MOVE patch in the do_move() function.</span>
<span class="c">#    Must figure out why standard algorithm fails for startpos=37 ...</span>
<span class="c">#+   but _not_ on any other, including symmetrical startpos=26.</span>
<span class="c">#    Possibly, when calculating possible moves, counts the move back</span>
<span class="c">#+   to the originating square. If so, it might be a relatively easy fix.</span>
</pre></div>
</div>
</div>
<div class="section" id="exemple-46-magic-squares">
<h2>Exemple 46. Magic Squares<a class="headerlink" href="#exemple-46-magic-squares" title="Link permanent a aquest títol">¶</a></h2>
<div class="highlight-sh"><div class="highlight"><pre><span class="c">#!/bin/bash</span>
<span class="c"># msquare.sh</span>
<span class="c"># Magic Square generator (odd-order squares only!)</span>

<span class="c"># Author: mendel cooper</span>
<span class="c"># reldate: 19 Jan. 2009</span>
<span class="c"># License: Public Domain</span>
<span class="c"># A C-program by the very talented Kwon Young Shin inspired this script.</span>
<span class="c">#     http://user.chollian.net/~brainstm/MagicSquare.htm</span>

<span class="c"># Definition: A &quot;magic square&quot; is a two-dimensional array</span>
<span class="c">#             of integers in which all the rows, columns,</span>
<span class="c">#             and *long* diagonals add up to the same number.</span>
<span class="c">#             Being &quot;square,&quot; the array has the same number</span>
<span class="c">#             of rows and columns. That number is the &quot;order.&quot;</span>
<span class="c"># An example of a magic square of order 3 is:</span>
<span class="c">#   8  1  6</span>
<span class="c">#   3  5  7</span>
<span class="c">#   4  9  2</span>
<span class="c"># All the rows, columns, and the two long diagonals add up to 15.</span>


<span class="c"># Globals</span>
<span class="nv">EVEN</span><span class="o">=</span>2
<span class="nv">MAXSIZE</span><span class="o">=</span><span class="m">31</span>   <span class="c"># 31 rows x 31 cols.</span>
<span class="nv">E_usage</span><span class="o">=</span><span class="m">90</span>   <span class="c"># Invocation error.</span>
<span class="nv">dimension</span><span class="o">=</span>
<span class="nb">declare</span> -i square

usage_message <span class="o">()</span>
<span class="o">{</span>
  <span class="nb">echo</span> <span class="s2">&quot;Usage: </span><span class="nv">$0</span><span class="s2"> order&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot;   ... where \&quot;order\&quot; (square size) is an ODD integer&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot;       in the range 3 - 31.&quot;</span>
  <span class="c">#  Actually works for squares up to order 159,</span>
  <span class="c">#+ but large squares will not display pretty-printed in a term window.</span>
  <span class="c">#  Try increasing MAXSIZE, above.</span>
  <span class="nb">exit</span> <span class="nv">$E_usage</span>
<span class="o">}</span>


calculate <span class="o">()</span>       <span class="c"># Here&#39;s where the actual work gets done.</span>
<span class="o">{</span>
  <span class="nb">local </span>row col index dimadj j k <span class="nv">cell_val</span><span class="o">=</span>1
  <span class="nv">dimension</span><span class="o">=</span><span class="nv">$1</span>

  <span class="nb">let</span> <span class="s2">&quot;dimadj = </span><span class="nv">$dimension</span><span class="s2"> * 3&quot;</span><span class="p">;</span> <span class="nb">let</span> <span class="s2">&quot;dimadj /= 2&quot;</span>   <span class="c"># x 1.5, then truncate.</span>

  <span class="k">for</span> <span class="o">((</span><span class="nv">j</span><span class="o">=</span>0<span class="p">;</span> j &lt; dimension<span class="p">;</span> j++<span class="o">))</span>
  <span class="k">do</span>
    <span class="k">for</span> <span class="o">((</span><span class="nv">k</span><span class="o">=</span>0<span class="p">;</span> k &lt; dimension<span class="p">;</span> k++<span class="o">))</span>
    <span class="k">do</span>  <span class="c"># Calculate indices, then convert to 1-dim. array index.</span>
        <span class="c"># Bash doesn&#39;t support multidimensional arrays. Pity.</span>
      <span class="nb">let</span> <span class="s2">&quot;col = </span><span class="nv">$k</span><span class="s2"> - </span><span class="nv">$j</span><span class="s2"> + </span><span class="nv">$dimadj</span><span class="s2">&quot;</span><span class="p">;</span> <span class="nb">let</span> <span class="s2">&quot;col %= </span><span class="nv">$dimension</span><span class="s2">&quot;</span>
      <span class="nb">let</span> <span class="s2">&quot;row = </span><span class="nv">$j</span><span class="s2"> * 2 - </span><span class="nv">$k</span><span class="s2"> + </span><span class="nv">$dimension</span><span class="s2">&quot;</span><span class="p">;</span> <span class="nb">let</span> <span class="s2">&quot;row %= </span><span class="nv">$dimension</span><span class="s2">&quot;</span>
      <span class="nb">let</span> <span class="s2">&quot;index = </span><span class="nv">$row</span><span class="s2">*(</span><span class="nv">$dimension</span><span class="s2">) + </span><span class="nv">$col</span><span class="s2">&quot;</span>
      square<span class="o">[</span><span class="nv">$index</span><span class="o">]=</span>cell_val<span class="p">;</span> <span class="o">((</span>cell_val++<span class="o">))</span>
    <span class="k">done</span>
  <span class="k">done</span>
<span class="o">}</span>     <span class="c"># Plain math, visualization not required.</span>


print_square <span class="o">()</span>               <span class="c"># Output square, one row at a time.</span>
<span class="o">{</span>
  <span class="nb">local </span>row col idx d1
  <span class="nb">let</span> <span class="s2">&quot;d1 = </span><span class="nv">$dimension</span><span class="s2"> - 1&quot;</span>   <span class="c"># Adjust for zero-indexed array.</span>

  <span class="k">for</span> row in <span class="k">$(</span>seq <span class="m">0</span> <span class="nv">$d1</span><span class="k">)</span>
  <span class="k">do</span>

    <span class="k">for</span> col in <span class="k">$(</span>seq <span class="m">0</span> <span class="nv">$d1</span><span class="k">)</span>
    <span class="k">do</span>
      <span class="nb">let</span> <span class="s2">&quot;idx = </span><span class="nv">$row</span><span class="s2"> * </span><span class="nv">$dimension</span><span class="s2"> + </span><span class="nv">$col</span><span class="s2">&quot;</span>
      <span class="nb">printf</span> <span class="s2">&quot;%3d &quot;</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">square</span><span class="p">[idx]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span> <span class="nb">echo</span> -n <span class="s2">&quot;  &quot;</span>
    <span class="k">done</span>   <span class="c"># Displays up to 13th order neatly in 80-column term window.</span>

    <span class="nb">echo</span>   <span class="c"># Newline after each row.</span>
  <span class="k">done</span>
<span class="o">}</span>


<span class="c">#################################################</span>
<span class="k">if</span> <span class="o">[[</span> -z <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> <span class="o">]]</span> <span class="p">|</span><span class="o">[[</span> <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> -gt <span class="nv">$MAXSIZE</span> <span class="o">]]</span>
<span class="k">then</span>
  usage_message
<span class="k">fi</span>

<span class="nb">let</span> <span class="s2">&quot;test_even = </span><span class="nv">$1</span><span class="s2"> % </span><span class="nv">$EVEN</span><span class="s2">&quot;</span>
<span class="k">if</span> <span class="o">[</span> <span class="nv">$test_even</span> -eq <span class="m">0</span> <span class="o">]</span>
<span class="k">then</span>           <span class="c"># Can&#39;t handle even-order squares.</span>
  usage_message
<span class="k">fi</span>

calculate <span class="nv">$1</span>
print_square   <span class="c"># echo &quot;${square[@]}&quot;   # DEBUG</span>

<span class="nb">exit</span> <span class="nv">$?</span>
<span class="c">#################################################</span>


<span class="c"># Exercises:</span>
<span class="c"># ---------</span>
<span class="c"># 1) Add a function to calculate the sum of each row, column,</span>
<span class="c">#    and *long* diagonal. The sums must match.</span>
<span class="c">#    This is the &quot;magic constant&quot; of that particular order square.</span>
<span class="c"># 2) Have the print_square function auto-calculate how much space</span>
<span class="c">#    to allot between square elements for optimized display.</span>
<span class="c">#    This might require parameterizing the &quot;printf&quot; line.</span>
<span class="c"># 3) Add appropriate functions for generating magic squares</span>
<span class="c">#    with an *even* number of rows/columns.</span>
<span class="c">#    This is non-trivial(!).</span>
<span class="c">#    See the URL for Kwon Young Shin, above, for help.</span>
</pre></div>
</div>
</div>
<div class="section" id="exemple-47-fifteen-puzzle">
<h2>Exemple 47. Fifteen Puzzle<a class="headerlink" href="#exemple-47-fifteen-puzzle" title="Link permanent a aquest títol">¶</a></h2>
<div class="highlight-sh"><div class="highlight"><pre><span class="c">#!/bin/bash</span>
<span class="c"># fifteen.sh</span>

<span class="c"># Classic &quot;Fifteen Puzzle&quot;</span>
<span class="c"># Author: Antonio Macchi</span>
<span class="c"># Lightly edited and commented by ABS Guide author.</span>
<span class="c"># Used in ABS Guide with permission. (Thanks!)</span>

<span class="c">#  The invention of the Fifteen Puzzle is attributed to either</span>
<span class="c">#+ Sam Loyd or Noyes Palmer Chapman.</span>
<span class="c">#  The puzzle was wildly popular in the late 19th-century.</span>

<span class="c">#  Object: Rearrange the numbers so they read in order,</span>
<span class="c">#+ from 1 - 15:   ________________</span>
<span class="c"># 1   2   3   4</span>
<span class="c"># 5   6   7   8</span>
<span class="c"># 9  10  11  12</span>
<span class="c">#13  14  15</span>
<span class="c">#                 ----------------</span>


<span class="c">#######################</span>
<span class="c"># Constants           #</span>
  <span class="nv">SQUARES</span><span class="o">=</span><span class="m">16</span>          <span class="c">#</span>
  <span class="nv">FAIL</span><span class="o">=</span><span class="m">70</span>             <span class="c">#</span>
  <span class="nv">E_PREMATURE_EXIT</span><span class="o">=</span><span class="m">80</span> <span class="c">#</span>
<span class="c">#######################</span>


<span class="c">########</span>
<span class="c"># Data #</span>
<span class="c">########</span>

<span class="nv">Puzzle</span><span class="o">=(</span> <span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">4</span> <span class="m">5</span> <span class="m">6</span> <span class="m">7</span> <span class="m">8</span> <span class="m">9</span> <span class="m">10</span> <span class="m">11</span> <span class="m">12</span> <span class="m">13</span> <span class="m">14</span> <span class="m">15</span> <span class="s2">&quot; &quot;</span> <span class="o">)</span>


<span class="c">#############</span>
<span class="c"># Functions #</span>
<span class="c">#############</span>

<span class="k">function</span> swap
<span class="o">{</span>
  <span class="nb">local </span>tmp

  <span class="nv">tmp</span><span class="o">=</span><span class="si">${</span><span class="nv">Puzzle</span><span class="p">[</span><span class="nv">$1</span><span class="p">]</span><span class="si">}</span>
  Puzzle<span class="o">[</span><span class="nv">$1</span><span class="o">]=</span><span class="si">${</span><span class="nv">Puzzle</span><span class="p">[</span><span class="nv">$2</span><span class="p">]</span><span class="si">}</span>
  Puzzle<span class="o">[</span><span class="nv">$2</span><span class="o">]=</span><span class="nv">$tmp</span>
<span class="o">}</span>


<span class="k">function</span> Jumble
<span class="o">{</span> <span class="c"># Scramble the pieces at beginning of round.</span>
  <span class="nb">local </span>i pos1 pos2

  <span class="k">for</span> i in <span class="o">{</span>1..100<span class="o">}</span>
  <span class="k">do</span>
    <span class="nv">pos1</span><span class="o">=</span><span class="k">$((</span> <span class="nv">$RANDOM</span> <span class="o">%</span> <span class="nv">$SQUARES</span><span class="k">))</span>
    <span class="nv">pos2</span><span class="o">=</span><span class="k">$((</span> <span class="nv">$RANDOM</span> <span class="o">%</span> <span class="nv">$SQUARES</span> <span class="k">))</span>
    swap <span class="nv">$pos1</span> <span class="nv">$pos2</span>
  <span class="k">done</span>
<span class="o">}</span>


<span class="k">function</span> PrintPuzzle
<span class="o">{</span>
  <span class="nb">local </span>i1 i2 puzpos
  <span class="nv">puzpos</span><span class="o">=</span>0

  clear
  <span class="nb">echo</span> <span class="s2">&quot;Enter  quit  to exit.&quot;</span><span class="p">;</span> <span class="nb">echo</span>   <span class="c"># Better that than Ctl-C.</span>

  <span class="nb">echo</span> <span class="s2">&quot;,----.----.----.----.&quot;</span>   <span class="c"># Top border.</span>
  <span class="k">for</span> i1 in <span class="o">{</span>1..4<span class="o">}</span>
  <span class="k">do</span>
    <span class="k">for</span> i2 in <span class="o">{</span>1..4<span class="o">}</span>
    <span class="k">do</span>
      <span class="nb">printf</span> <span class="s2">&quot;%2s &quot;</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">Puzzle</span><span class="p">[</span><span class="nv">$puzpos</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
      <span class="o">((</span> puzpos++ <span class="o">))</span>
    <span class="k">done</span>
    <span class="nb">echo</span> <span class="s2">&quot;|&quot;</span>                     <span class="c"># Right-side border.</span>
    <span class="nb">test</span> <span class="nv">$i1</span> <span class="o">=</span> <span class="m">4</span> <span class="p">|</span><span class="nb">echo</span> <span class="s2">&quot;+----+----+----+----+&quot;</span>
  <span class="k">done</span>
  <span class="nb">echo</span> <span class="s2">&quot;&#39;----&#39;----&#39;----&#39;----&#39;&quot;</span>   <span class="c"># Bottom border.</span>
<span class="o">}</span>


<span class="k">function</span> GetNum
<span class="o">{</span> <span class="c"># Test for valid input.</span>
  <span class="nb">local </span>puznum garbage

  <span class="k">while</span> <span class="nb">true</span>
<span class="nb">  </span><span class="k">do</span>
      <span class="nb">echo</span> <span class="s2">&quot;Moves: </span><span class="nv">$moves</span><span class="s2">&quot;</span> <span class="c"># Also counts invalid moves.</span>
    <span class="nb">read</span> -p <span class="s2">&quot;Number to move: &quot;</span> puznum garbage
      <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$puznum</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;quit&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span> <span class="nb">echo</span><span class="p">;</span> <span class="nb">exit</span> <span class="nv">$E_PREMATURE_EXIT</span><span class="p">;</span> <span class="k">fi</span>
    <span class="nb">test</span> -z <span class="s2">&quot;</span><span class="nv">$puznum</span><span class="s2">&quot;</span> -o -n <span class="s2">&quot;</span><span class="si">${</span><span class="nv">puznum</span><span class="p">//[0-9]/</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">&amp;&amp;</span> <span class="k">continue</span>
    <span class="nb">test</span> <span class="nv">$puznum</span> -gt <span class="m">0</span> -a <span class="nv">$puznum</span> -lt <span class="nv">$SQUARES</span> <span class="o">&amp;&amp;</span> <span class="nb">break</span>
<span class="nb">  </span><span class="k">done</span>
  <span class="k">return</span> <span class="nv">$puznum</span>
<span class="o">}</span>


<span class="k">function</span> GetPosFromNum
<span class="o">{</span> <span class="c"># $1 = puzzle-number</span>
  <span class="nb">local </span>puzpos

  <span class="k">for</span> puzpos in <span class="o">{</span>0..15<span class="o">}</span>
  <span class="k">do</span>
    <span class="nb">test</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">Puzzle</span><span class="p">[</span><span class="nv">$puzpos</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> <span class="o">&amp;&amp;</span> <span class="nb">break</span>
<span class="nb">  </span><span class="k">done</span>
  <span class="k">return</span> <span class="nv">$puzpos</span>
<span class="o">}</span>


<span class="k">function</span> Move
<span class="o">{</span> <span class="c"># $1=Puzzle-pos</span>
  <span class="nb">test</span> <span class="nv">$1</span> -gt <span class="m">3</span> <span class="o">&amp;&amp;</span> <span class="nb">test</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">Puzzle</span><span class="p">[</span><span class="k">$((</span> <span class="nv">$1</span> <span class="o">-</span> <span class="m">4</span> <span class="k">))</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="se">\</span>
       <span class="o">&amp;&amp;</span> swap <span class="nv">$1</span> <span class="k">$((</span> <span class="nv">$1</span> <span class="o">-</span> <span class="m">4</span> <span class="k">))</span> <span class="o">&amp;&amp;</span> <span class="k">return</span> 0
  <span class="nb">test</span> <span class="k">$((</span> <span class="nv">$1</span><span class="o">%</span><span class="m">4</span> <span class="k">))</span> -ne <span class="m">3</span> <span class="o">&amp;&amp;</span> <span class="nb">test</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">Puzzle</span><span class="p">[</span><span class="k">$((</span> <span class="nv">$1</span> <span class="o">+</span> <span class="m">1</span> <span class="k">))</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="se">\</span>
       <span class="o">&amp;&amp;</span> swap <span class="nv">$1</span> <span class="k">$((</span> <span class="nv">$1</span> <span class="o">+</span> <span class="m">1</span> <span class="k">))</span> <span class="o">&amp;&amp;</span> <span class="k">return</span> 0
  <span class="nb">test</span> <span class="nv">$1</span> -lt <span class="m">12</span> <span class="o">&amp;&amp;</span> <span class="nb">test</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">Puzzle</span><span class="p">[</span><span class="k">$((</span> <span class="nv">$1</span> <span class="o">+</span> <span class="m">4</span> <span class="k">))</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="se">\</span>
       <span class="o">&amp;&amp;</span> swap <span class="nv">$1</span> <span class="k">$((</span> <span class="nv">$1</span> <span class="o">+</span> <span class="m">4</span> <span class="k">))</span> <span class="o">&amp;&amp;</span> <span class="k">return</span> 0
  <span class="nb">test</span> <span class="k">$((</span> <span class="nv">$1</span><span class="o">%</span><span class="m">4</span> <span class="k">))</span> -ne <span class="m">0</span> <span class="o">&amp;&amp;</span> <span class="nb">test</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">Puzzle</span><span class="p">[</span><span class="k">$((</span> <span class="nv">$1</span> <span class="o">-</span> <span class="m">1</span> <span class="k">))</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="o">&amp;&amp;</span><span class="se">\</span>
       swap <span class="nv">$1</span> <span class="k">$((</span> <span class="nv">$1</span> <span class="o">-</span> <span class="m">1</span> <span class="k">))</span> <span class="o">&amp;&amp;</span> <span class="k">return</span> 0
  <span class="k">return</span> 1
<span class="o">}</span>


<span class="k">function</span> Solved
<span class="o">{</span>
  <span class="nb">local </span>pos

  <span class="k">for</span> pos in <span class="o">{</span>0..14<span class="o">}</span>
  <span class="k">do</span>
    <span class="nb">test</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">Puzzle</span><span class="p">[</span><span class="nv">$pos</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="k">$((</span> <span class="nv">$pos</span> <span class="o">+</span> <span class="m">1</span> <span class="k">))</span> <span class="p">|</span><span class="k">return</span> <span class="nv">$FAIL</span>
    <span class="c"># Check whether number in each square = square number.</span>
  <span class="k">done</span>
  <span class="k">return</span> <span class="m">0</span>   <span class="c"># Successful solution.</span>
<span class="o">}</span>


<span class="c">################### MAIN () #######################{</span>
<span class="nv">moves</span><span class="o">=</span>0
Jumble

<span class="k">while</span> <span class="nb">true</span>   <span class="c"># Loop continuously until puzzle solved.</span>
<span class="k">do</span>
  <span class="nb">echo</span><span class="p">;</span> <span class="nb">echo</span>
<span class="nb">  </span>PrintPuzzle
  <span class="nb">echo</span>
<span class="nb">  </span><span class="k">while</span> <span class="nb">true</span>
<span class="nb">  </span><span class="k">do</span>
    GetNum
    <span class="nv">puznum</span><span class="o">=</span><span class="nv">$?</span>
    GetPosFromNum <span class="nv">$puznum</span>
    <span class="nv">puzpos</span><span class="o">=</span><span class="nv">$?</span>
    <span class="o">((</span>moves++<span class="o">))</span>
    Move <span class="nv">$puzpos</span> <span class="o">&amp;&amp;</span> <span class="nb">break</span>
<span class="nb">  </span><span class="k">done</span>
  Solved <span class="o">&amp;&amp;</span> <span class="nb">break</span>
<span class="k">done</span>

<span class="nb">echo</span><span class="p">;</span><span class="nb">echo</span>
PrintPuzzle
<span class="nb">echo</span><span class="p">;</span> <span class="nb">echo</span> <span class="s2">&quot;BRAVO!&quot;</span><span class="p">;</span> <span class="nb">echo</span>

<span class="nb">exit </span>0
<span class="c">###################################################}</span>

<span class="c">#  Exercise:</span>
<span class="c">#  --------</span>
<span class="c">#  Rewrite the script to display the letters A - O,</span>
<span class="c">#+ rather than the numbers 1 - 15.</span>
</pre></div>
</div>
</div>
<div class="section" id="exemple-48-the-towers-of-hanoi-graphic-version">
<h2>Exemple 48. <em>The Towers of Hanoi, graphic version</em><a class="headerlink" href="#exemple-48-the-towers-of-hanoi-graphic-version" title="Link permanent a aquest títol">¶</a></h2>
<div class="highlight-sh"><div class="highlight"><pre><span class="c">#! /bin/bash</span>
<span class="c"># The Towers Of Hanoi</span>
<span class="c"># Original script (hanoi.bash) copyright (C) 2000 Amit Singh.</span>
<span class="c"># All Rights Reserved.</span>
<span class="c"># http://hanoi.kernelthread.com</span>

<span class="c">#  hanoi2.bash</span>
<span class="c">#  Version 2.00: modded for ASCII-graphic display.</span>
<span class="c">#  Version 2.01: fixed no command-line param bug.</span>
<span class="c">#  Uses code contributed by Antonio Macchi,</span>
<span class="c">#+ with heavy editing by ABS Guide author.</span>
<span class="c">#  This variant falls under the original copyright, see above.</span>
<span class="c">#  Used in ABS Guide with Amit Singh&#39;s permission (thanks!).</span>


<span class="c">###   Variables &amp;&amp; sanity check   ###</span>

<span class="nv">E_NOPARAM</span><span class="o">=</span>86
<span class="nv">E_BADPARAM</span><span class="o">=</span><span class="m">87</span>            <span class="c"># Illegal no. of disks passed to script.</span>
<span class="nv">E_NOEXIT</span><span class="o">=</span>88

<span class="nv">DISKS</span><span class="o">=</span><span class="si">${</span><span class="nv">1</span><span class="k">:-</span><span class="nv">$E_NOPARAM</span><span class="si">}</span>   <span class="c"># Must specify how many disks.</span>
<span class="nv">Moves</span><span class="o">=</span>0

<span class="nv">MWIDTH</span><span class="o">=</span>7
<span class="nv">MARGIN</span><span class="o">=</span>2
<span class="c"># Arbitrary &quot;magic&quot; constants; work okay for relatively small # of disks.</span>
<span class="c"># BASEWIDTH=51   # Original code.</span>
<span class="nb">let</span> <span class="s2">&quot;basewidth = </span><span class="nv">$MWIDTH</span><span class="s2"> * </span><span class="nv">$DISKS</span><span class="s2"> + </span><span class="nv">$MARGIN</span><span class="s2">&quot;</span>       <span class="c"># &quot;Base&quot; beneath rods.</span>
<span class="c"># Above &quot;algorithm&quot; could likely stand improvement.</span>

<span class="c">###   Display variables   ###</span>
<span class="nb">let</span> <span class="s2">&quot;disks1 = </span><span class="nv">$DISKS</span><span class="s2"> - 1&quot;</span>
<span class="nb">let</span> <span class="s2">&quot;spaces1 = </span><span class="nv">$DISKS</span><span class="s2">&quot;</span>
<span class="nb">let</span> <span class="s2">&quot;spaces2 = 2 * </span><span class="nv">$DISKS</span><span class="s2">&quot;</span>

<span class="nb">let</span> <span class="s2">&quot;lastmove_t = </span><span class="nv">$DISKS</span><span class="s2"> - 1&quot;</span>                      <span class="c"># Final move?</span>


<span class="nb">declare</span> -a Rod1 Rod2 Rod3

<span class="c">###   #########################   ###</span>


<span class="k">function</span> repeat  <span class="o">{</span>  <span class="c"># $1=char $2=number of repetitions</span>
  <span class="nb">local </span>n           <span class="c"># Repeat-print a character.</span>

  <span class="k">for</span> <span class="o">((</span> <span class="nv">n</span><span class="o">=</span>0<span class="p">;</span> n&lt;<span class="nv">$2</span><span class="p">;</span> n++ <span class="o">))</span><span class="p">;</span> <span class="k">do</span>
    <span class="nb">echo</span> -n <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
  <span class="k">done</span>
<span class="o">}</span>

<span class="k">function</span> FromRod  <span class="o">{</span>
  <span class="nb">local </span>rod summit weight sequence

  <span class="k">while</span> <span class="nb">true</span><span class="p">;</span> <span class="k">do</span>
    <span class="nv">rod</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nb">test</span> <span class="si">${</span><span class="nv">rod</span><span class="p">/[^123]/</span><span class="si">}</span>.. <span class="k">continue</span>::

    <span class="nv">sequence</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="k">$(</span>seq <span class="m">0</span> <span class="nv">$disks1tac</span><span class="k">))</span>
    <span class="k">for</span> summit in <span class="nv">$sequence</span><span class="p">;</span> <span class="k">do</span>
      <span class="nb">eval </span><span class="nv">weight</span><span class="o">=</span><span class="se">\$</span><span class="o">{</span>Rod<span class="si">${</span><span class="nv">rod</span><span class="si">}</span><span class="o">[</span><span class="nv">$summit</span><span class="o">]}</span>
      <span class="nb">test</span> <span class="nv">$weight</span> -ne <span class="m">0</span> <span class="o">&amp;&amp;</span>
           <span class="o">{</span> <span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$rod</span><span class="s2"> </span><span class="nv">$summit</span><span class="s2"> </span><span class="nv">$weight</span><span class="s2">&quot;</span><span class="p">;</span> <span class="k">return</span><span class="p">;</span> <span class="o">}</span>
    <span class="k">done</span>
  <span class="k">done</span>
<span class="o">}</span>


<span class="k">function</span> ToRod  <span class="o">{</span> <span class="c"># $1=previous (FromRod) weight</span>
  <span class="nb">local </span>rod firstfree weight sequence

  <span class="k">while</span> <span class="nb">true</span><span class="p">;</span> <span class="k">do</span>
    <span class="nv">rod</span><span class="o">=</span><span class="nv">$2</span>
    <span class="nb">test</span> <span class="si">${</span><span class="nv">rod</span><span class="p">/[^123]</span><span class="si">}</span>.. <span class="k">continue</span>::

    <span class="nv">sequence</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="k">$(</span>seq <span class="m">0</span> <span class="nv">$disks1tac</span><span class="k">))</span>
    <span class="k">for</span> firstfree in <span class="nv">$sequence</span><span class="p">;</span> <span class="k">do</span>
      <span class="nb">eval </span><span class="nv">weight</span><span class="o">=</span><span class="se">\$</span><span class="o">{</span>Rod<span class="si">${</span><span class="nv">rod</span><span class="si">}</span><span class="o">[</span><span class="nv">$firstfree</span><span class="o">]}</span>
      <span class="nb">test</span> <span class="nv">$weight</span> -gt <span class="m">0</span> <span class="o">&amp;&amp;</span> <span class="o">{</span> <span class="o">((</span> firstfree++ <span class="o">))</span><span class="p">;</span> <span class="nb">break</span><span class="p">;</span> <span class="o">}</span>
    <span class="k">done</span>
    <span class="nb">test</span> <span class="nv">$weight</span> -gt <span class="nv">$1</span> -o <span class="nv">$firstfree</span> <span class="o">=</span> <span class="m">0</span> <span class="o">&amp;&amp;</span>
         <span class="o">{</span> <span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$rod</span><span class="s2"> </span><span class="nv">$firstfree</span><span class="s2">&quot;</span><span class="p">;</span> <span class="k">return</span><span class="p">;</span> <span class="o">}</span>
  <span class="k">done</span>
<span class="o">}</span>


<span class="k">function</span> PrintRods  <span class="o">{</span>
  <span class="nb">local </span>disk rod empty fill sp sequence


  repeat <span class="s2">&quot; &quot;</span> <span class="nv">$spaces1</span>
  <span class="nb">echo</span> -n <span class="s2">&quot;|&quot;</span>
  repeat <span class="s2">&quot; &quot;</span> <span class="nv">$spaces2</span>
  <span class="nb">echo</span> -n <span class="s2">&quot;|&quot;</span>
  repeat <span class="s2">&quot; &quot;</span> <span class="nv">$spaces2</span>
  <span class="nb">echo</span> <span class="s2">&quot;|&quot;</span>

  <span class="nv">sequence</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="k">$(</span>seq <span class="m">0</span> <span class="nv">$disks1tac</span><span class="k">))</span>
  <span class="k">for</span> disk in <span class="nv">$sequence</span><span class="p">;</span> <span class="k">do</span>
    <span class="k">for</span> rod in <span class="o">{</span>1..3<span class="o">}</span><span class="p">;</span> <span class="k">do</span>
      <span class="nb">eval </span><span class="nv">empty</span><span class="o">=</span><span class="k">$((</span> <span class="nv">$DISKS</span> <span class="o">-</span> <span class="o">(</span>Rod<span class="si">${</span><span class="nv">rod</span><span class="si">}</span><span class="o">[</span><span class="nv">$disk</span><span class="o">]</span> <span class="o">/</span> <span class="m">2</span><span class="o">)</span> <span class="k">))</span>
      <span class="nb">eval </span><span class="nv">fill</span><span class="o">=</span><span class="se">\$</span><span class="o">{</span>Rod<span class="si">${</span><span class="nv">rod</span><span class="si">}</span><span class="o">[</span><span class="nv">$disk</span><span class="o">]}</span>
      repeat <span class="s2">&quot; &quot;</span> <span class="nv">$empty</span>
      <span class="nb">test</span> <span class="nv">$fill</span> -gt <span class="m">0</span> <span class="o">&amp;&amp;</span> repeat <span class="s2">&quot;*&quot;</span> <span class="nv">$fill</span> <span class="p">|</span><span class="nb">echo</span> -n <span class="s2">&quot;|&quot;</span>
      repeat <span class="s2">&quot; &quot;</span> <span class="nv">$empty</span>
    <span class="k">done</span>
    <span class="nb">echo</span>
<span class="nb">  </span><span class="k">done</span>
  repeat <span class="s2">&quot;=&quot;</span> <span class="nv">$basewidth</span>   <span class="c"># Print &quot;base&quot; beneath rods.</span>
  <span class="nb">echo</span>
<span class="o">}</span>


display <span class="o">()</span>
<span class="o">{</span>
  <span class="nb">echo</span>
<span class="nb">  </span>PrintRods

  <span class="c"># Get rod-number, summit and weight</span>
  <span class="nv">first</span><span class="o">=(</span> <span class="sb">`</span>FromRod <span class="nv">$1</span><span class="sb">`</span> <span class="o">)</span>
  <span class="nb">eval </span>Rod<span class="si">${</span><span class="nv">first</span><span class="p">[0]</span><span class="si">}</span><span class="o">[</span><span class="si">${</span><span class="nv">first</span><span class="p">[1]</span><span class="si">}</span><span class="o">]=</span>0

  <span class="c"># Get rod-number and first-free position</span>
  <span class="nv">second</span><span class="o">=(</span> <span class="sb">`</span>ToRod <span class="si">${</span><span class="nv">first</span><span class="p">[2]</span><span class="si">}</span> <span class="nv">$2</span><span class="sb">`</span> <span class="o">)</span>
  <span class="nb">eval </span>Rod<span class="si">${</span><span class="nv">second</span><span class="p">[0]</span><span class="si">}</span><span class="o">[</span><span class="si">${</span><span class="nv">second</span><span class="p">[1]</span><span class="si">}</span><span class="o">]=</span><span class="si">${</span><span class="nv">first</span><span class="p">[2]</span><span class="si">}</span>


<span class="nb">echo</span><span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="nb">echo</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">Rod3</span><span class="p">[lastmove_t]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="m">1</span> <span class="o">]</span>
<span class="k">then</span>   <span class="c"># Last move? If yes, then display final position.</span>
    <span class="nb">echo</span> <span class="s2">&quot;+  Final Position: </span><span class="nv">$Moves</span><span class="s2"> moves&quot;</span><span class="p">;</span> <span class="nb">echo</span>
<span class="nb">    </span>PrintRods
  <span class="k">fi</span>
<span class="o">}</span>


<span class="c"># From here down, almost the same as original (hanoi.bash) script.</span>

dohanoi<span class="o">()</span> <span class="o">{</span>   <span class="c"># Recursive function.</span>
    <span class="k">case</span> <span class="nv">$1</span> in
    0<span class="o">)</span>
        <span class="p">;;</span>
    *<span class="o">)</span>
        dohanoi <span class="s2">&quot;</span><span class="k">$((</span><span class="nv">$1</span><span class="o">-</span><span class="m">1</span><span class="k">))</span><span class="s2">&quot;</span> <span class="nv">$2</span> <span class="nv">$4</span> <span class="nv">$3</span>
    <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$Moves</span><span class="s2">&quot;</span> -ne <span class="m">0</span> <span class="o">]</span>
        <span class="k">then</span>
      <span class="nb">echo</span> <span class="s2">&quot;+  Position after move </span><span class="nv">$Moves</span><span class="s2">&quot;</span>
        <span class="k">fi</span>
        <span class="o">((</span>Moves++<span class="o">))</span>
        <span class="nb">echo</span> -n <span class="s2">&quot;   Next move will be:  &quot;</span>
        <span class="nb">echo</span> <span class="nv">$2</span> <span class="s2">&quot;--&gt;&quot;</span> <span class="nv">$3</span>
          display <span class="nv">$2</span> <span class="nv">$3</span>
        dohanoi <span class="s2">&quot;</span><span class="k">$((</span><span class="nv">$1</span><span class="o">-</span><span class="m">1</span><span class="k">))</span><span class="s2">&quot;</span> <span class="nv">$4</span> <span class="nv">$3</span> <span class="nv">$2</span>
        <span class="p">;;</span>
    <span class="k">esac</span>
<span class="o">}</span>


setup_arrays <span class="o">()</span>
<span class="o">{</span>
  <span class="nb">local </span>dim n elem

  <span class="nb">let</span> <span class="s2">&quot;dim1 = </span><span class="nv">$1</span><span class="s2"> - 1&quot;</span>
  <span class="nv">elem</span><span class="o">=</span><span class="nv">$dim1</span>

  <span class="k">for</span> n in <span class="k">$(</span>seq <span class="m">0</span> <span class="nv">$dim1</span><span class="k">)</span>
  <span class="k">do</span>
   <span class="nb">let</span> <span class="s2">&quot;Rod1[</span><span class="nv">$elem</span><span class="s2">] = 2 * </span><span class="nv">$n</span><span class="s2"> + 1&quot;</span>
   Rod2<span class="o">[</span><span class="nv">$n</span><span class="o">]=</span>0
   Rod3<span class="o">[</span><span class="nv">$n</span><span class="o">]=</span>0
   <span class="o">((</span>elem--<span class="o">))</span>
  <span class="k">done</span>
<span class="o">}</span>


<span class="c">###   Main   ###</span>

setup_arrays <span class="nv">$DISKS</span>
<span class="nb">echo</span><span class="p">;</span> <span class="nb">echo</span> <span class="s2">&quot;+  Start Position&quot;</span>

<span class="k">case</span> <span class="nv">$# </span>in
    1<span class="o">)</span> <span class="k">case</span> <span class="k">$((</span><span class="nv">$1</span>&gt;0<span class="k">))</span> in     <span class="c"># Must have at least one disk.</span>
       1<span class="o">)</span>
           <span class="nv">disks</span><span class="o">=</span><span class="nv">$1</span>
           dohanoi <span class="nv">$1</span> <span class="m">1</span> <span class="m">3</span> 2
<span class="c">#          Total moves = 2^n - 1, where n = number of disks.</span>
       <span class="nb">echo</span>
<span class="nb">           exit </span>0<span class="p">;</span>
           <span class="p">;;</span>
       *<span class="o">)</span>
           <span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$0</span><span class="s2">: Illegal value for number of disks&quot;</span><span class="p">;</span>
           <span class="nb">exit</span> <span class="nv">$E_BADPARAM</span><span class="p">;</span>
           <span class="p">;;</span>
       <span class="k">esac</span>
    <span class="p">;;</span>
    *<span class="o">)</span>
       clear
       <span class="nb">echo</span> <span class="s2">&quot;usage: </span><span class="nv">$0</span><span class="s2"> N&quot;</span>
       <span class="nb">echo</span> <span class="s2">&quot;       Where \&quot;N\&quot; is the number of disks.&quot;</span>
       <span class="nb">exit</span> <span class="nv">$E_NOPARAM</span><span class="p">;</span>
       <span class="p">;;</span>
<span class="k">esac</span>

<span class="nb">exit</span> <span class="nv">$E_NOEXIT</span>   <span class="c"># Shouldn&#39;t exit here.</span>

<span class="c"># Note:</span>
<span class="c"># Redirect script output to a file, otherwise it scrolls off display.</span>
</pre></div>
</div>
</div>
<div class="section" id="exemple-49-the-towers-of-hanoi-alternate-graphic-version">
<h2>Exemple 49. <em>The Towers of Hanoi, alternate graphic version</em><a class="headerlink" href="#exemple-49-the-towers-of-hanoi-alternate-graphic-version" title="Link permanent a aquest títol">¶</a></h2>
<div class="highlight-sh"><div class="highlight"><pre><span class="c">#! /bin/bash</span>
<span class="c"># The Towers Of Hanoi</span>
<span class="c"># Original script (hanoi.bash) copyright (C) 2000 Amit Singh.</span>
<span class="c"># All Rights Reserved.</span>
<span class="c"># http://hanoi.kernelthread.com</span>

<span class="c">#  hanoi2.bash</span>
<span class="c">#  Version 2: modded for ASCII-graphic display.</span>
<span class="c">#  Uses code contributed by Antonio Macchi,</span>
<span class="c">#+ with heavy editing by ABS Guide author.</span>
<span class="c">#  This variant also falls under the original copyright, see above.</span>
<span class="c">#  Used in ABS Guide with Amit Singh&#39;s permission (thanks!).</span>


<span class="c">#   Variables   #</span>
<span class="nv">E_NOPARAM</span><span class="o">=</span>86
<span class="nv">E_BADPARAM</span><span class="o">=</span><span class="m">87</span>   <span class="c"># Illegal no. of disks passed to script.</span>
<span class="nv">E_NOEXIT</span><span class="o">=</span>88
<span class="nv">DELAY</span><span class="o">=</span><span class="m">2</span>         <span class="c"># Interval, in seconds, between moves. Change, if desired.</span>
<span class="nv">DISKS</span><span class="o">=</span><span class="nv">$1</span>
<span class="nv">Moves</span><span class="o">=</span>0

<span class="nv">MWIDTH</span><span class="o">=</span>7
<span class="nv">MARGIN</span><span class="o">=</span>2
<span class="c"># Arbitrary &quot;magic&quot; constants, work okay for relatively small # of disks.</span>
<span class="c"># BASEWIDTH=51   # Original code.</span>
<span class="nb">let</span> <span class="s2">&quot;basewidth = </span><span class="nv">$MWIDTH</span><span class="s2"> * </span><span class="nv">$DISKS</span><span class="s2"> + </span><span class="nv">$MARGIN</span><span class="s2">&quot;</span> <span class="c"># &quot;Base&quot; beneath rods.</span>
<span class="c"># Above &quot;algorithm&quot; could likely stand improvement.</span>

<span class="c"># Display variables.</span>
<span class="nb">let</span> <span class="s2">&quot;disks1 = </span><span class="nv">$DISKS</span><span class="s2"> - 1&quot;</span>
<span class="nb">let</span> <span class="s2">&quot;spaces1 = </span><span class="nv">$DISKS</span><span class="s2">&quot;</span>
<span class="nb">let</span> <span class="s2">&quot;spaces2 = 2 * </span><span class="nv">$DISKS</span><span class="s2">&quot;</span>

<span class="nb">let</span> <span class="s2">&quot;lastmove_t = </span><span class="nv">$DISKS</span><span class="s2"> - 1&quot;</span>                <span class="c"># Final move?</span>


<span class="nb">declare</span> -a Rod1 Rod2 Rod3

<span class="c">#################</span>


<span class="k">function</span> repeat  <span class="o">{</span>  <span class="c"># $1=char $2=number of repetitions</span>
  <span class="nb">local </span>n           <span class="c"># Repeat-print a character.</span>

  <span class="k">for</span> <span class="o">((</span> <span class="nv">n</span><span class="o">=</span>0<span class="p">;</span> n&lt;<span class="nv">$2</span><span class="p">;</span> n++ <span class="o">))</span><span class="p">;</span> <span class="k">do</span>
    <span class="nb">echo</span> -n <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
  <span class="k">done</span>
<span class="o">}</span>

<span class="k">function</span> FromRod  <span class="o">{</span>
  <span class="nb">local </span>rod summit weight sequence

  <span class="k">while</span> <span class="nb">true</span><span class="p">;</span> <span class="k">do</span>
    <span class="nv">rod</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nb">test</span> <span class="si">${</span><span class="nv">rod</span><span class="p">/[^123]/</span><span class="si">}</span>.. <span class="k">continue</span>::

    <span class="nv">sequence</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="k">$(</span>seq <span class="m">0</span> <span class="nv">$disks1tac</span><span class="k">))</span>
    <span class="k">for</span> summit in <span class="nv">$sequence</span><span class="p">;</span> <span class="k">do</span>
      <span class="nb">eval </span><span class="nv">weight</span><span class="o">=</span><span class="se">\$</span><span class="o">{</span>Rod<span class="si">${</span><span class="nv">rod</span><span class="si">}</span><span class="o">[</span><span class="nv">$summit</span><span class="o">]}</span>
      <span class="nb">test</span> <span class="nv">$weight</span> -ne <span class="m">0</span> <span class="o">&amp;&amp;</span>
           <span class="o">{</span> <span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$rod</span><span class="s2"> </span><span class="nv">$summit</span><span class="s2"> </span><span class="nv">$weight</span><span class="s2">&quot;</span><span class="p">;</span> <span class="k">return</span><span class="p">;</span> <span class="o">}</span>
    <span class="k">done</span>
  <span class="k">done</span>
<span class="o">}</span>


<span class="k">function</span> ToRod  <span class="o">{</span> <span class="c"># $1=previous (FromRod) weight</span>
  <span class="nb">local </span>rod firstfree weight sequence

  <span class="k">while</span> <span class="nb">true</span><span class="p">;</span> <span class="k">do</span>
    <span class="nv">rod</span><span class="o">=</span><span class="nv">$2</span>
    <span class="nb">test</span> <span class="si">${</span><span class="nv">rod</span><span class="p">/[^123]</span><span class="si">}</span>.. <span class="k">continue</span>::

    <span class="nv">sequence</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="k">$(</span>seq <span class="m">0</span> <span class="nv">$disks1tac</span><span class="k">))</span>
    <span class="k">for</span> firstfree in <span class="nv">$sequence</span><span class="p">;</span> <span class="k">do</span>
      <span class="nb">eval </span><span class="nv">weight</span><span class="o">=</span><span class="se">\$</span><span class="o">{</span>Rod<span class="si">${</span><span class="nv">rod</span><span class="si">}</span><span class="o">[</span><span class="nv">$firstfree</span><span class="o">]}</span>
      <span class="nb">test</span> <span class="nv">$weight</span> -gt <span class="m">0</span> <span class="o">&amp;&amp;</span> <span class="o">{</span> <span class="o">((</span> firstfree++ <span class="o">))</span><span class="p">;</span> <span class="nb">break</span><span class="p">;</span> <span class="o">}</span>
    <span class="k">done</span>
    <span class="nb">test</span> <span class="nv">$weight</span> -gt <span class="nv">$1</span> -o <span class="nv">$firstfree</span> <span class="o">=</span> <span class="m">0</span> <span class="o">&amp;&amp;</span>
         <span class="o">{</span> <span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$rod</span><span class="s2"> </span><span class="nv">$firstfree</span><span class="s2">&quot;</span><span class="p">;</span> <span class="k">return</span><span class="p">;</span> <span class="o">}</span>
  <span class="k">done</span>
<span class="o">}</span>


<span class="k">function</span> PrintRods  <span class="o">{</span>
  <span class="nb">local </span>disk rod empty fill sp sequence

  tput cup <span class="m">5</span> 0

  repeat <span class="s2">&quot; &quot;</span> <span class="nv">$spaces1</span>
  <span class="nb">echo</span> -n <span class="s2">&quot;|&quot;</span>
  repeat <span class="s2">&quot; &quot;</span> <span class="nv">$spaces2</span>
  <span class="nb">echo</span> -n <span class="s2">&quot;|&quot;</span>
  repeat <span class="s2">&quot; &quot;</span> <span class="nv">$spaces2</span>
  <span class="nb">echo</span> <span class="s2">&quot;|&quot;</span>

  <span class="nv">sequence</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="k">$(</span>seq <span class="m">0</span> <span class="nv">$disks1tac</span><span class="k">))</span>
  <span class="k">for</span> disk in <span class="nv">$sequence</span><span class="p">;</span> <span class="k">do</span>
    <span class="k">for</span> rod in <span class="o">{</span>1..3<span class="o">}</span><span class="p">;</span> <span class="k">do</span>
      <span class="nb">eval </span><span class="nv">empty</span><span class="o">=</span><span class="k">$((</span> <span class="nv">$DISKS</span> <span class="o">-</span> <span class="o">(</span>Rod<span class="si">${</span><span class="nv">rod</span><span class="si">}</span><span class="o">[</span><span class="nv">$disk</span><span class="o">]</span> <span class="o">/</span> <span class="m">2</span><span class="o">)</span> <span class="k">))</span>
      <span class="nb">eval </span><span class="nv">fill</span><span class="o">=</span><span class="se">\$</span><span class="o">{</span>Rod<span class="si">${</span><span class="nv">rod</span><span class="si">}</span><span class="o">[</span><span class="nv">$disk</span><span class="o">]}</span>
      repeat <span class="s2">&quot; &quot;</span> <span class="nv">$empty</span>
      <span class="nb">test</span> <span class="nv">$fill</span> -gt <span class="m">0</span> <span class="o">&amp;&amp;</span> repeat <span class="s2">&quot;*&quot;</span> <span class="nv">$fill</span> <span class="p">|</span><span class="nb">echo</span> -n <span class="s2">&quot;|&quot;</span>
      repeat <span class="s2">&quot; &quot;</span> <span class="nv">$empty</span>
    <span class="k">done</span>
    <span class="nb">echo</span>
<span class="nb">  </span><span class="k">done</span>
  repeat <span class="s2">&quot;=&quot;</span> <span class="nv">$basewidth</span>   <span class="c"># Print &quot;base&quot; beneath rods.</span>
  <span class="nb">echo</span>
<span class="o">}</span>


display <span class="o">()</span>
<span class="o">{</span>
  <span class="nb">echo</span>
<span class="nb">  </span>PrintRods

  <span class="c"># Get rod-number, summit and weight</span>
  <span class="nv">first</span><span class="o">=(</span> <span class="sb">`</span>FromRod <span class="nv">$1</span><span class="sb">`</span> <span class="o">)</span>
  <span class="nb">eval </span>Rod<span class="si">${</span><span class="nv">first</span><span class="p">[0]</span><span class="si">}</span><span class="o">[</span><span class="si">${</span><span class="nv">first</span><span class="p">[1]</span><span class="si">}</span><span class="o">]=</span>0

  <span class="c"># Get rod-number and first-free position</span>
  <span class="nv">second</span><span class="o">=(</span> <span class="sb">`</span>ToRod <span class="si">${</span><span class="nv">first</span><span class="p">[2]</span><span class="si">}</span> <span class="nv">$2</span><span class="sb">`</span> <span class="o">)</span>
  <span class="nb">eval </span>Rod<span class="si">${</span><span class="nv">second</span><span class="p">[0]</span><span class="si">}</span><span class="o">[</span><span class="si">${</span><span class="nv">second</span><span class="p">[1]</span><span class="si">}</span><span class="o">]=</span><span class="si">${</span><span class="nv">first</span><span class="p">[2]</span><span class="si">}</span>


  <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">Rod3</span><span class="p">[lastmove_t]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="m">1</span> <span class="o">]</span>
  <span class="k">then</span>   <span class="c"># Last move? If yes, then display final position.</span>
    tput cup <span class="m">0</span> 0
    <span class="nb">echo</span><span class="p">;</span> <span class="nb">echo</span> <span class="s2">&quot;+  Final Position: </span><span class="nv">$Moves</span><span class="s2"> moves&quot;</span>
    PrintRods
  <span class="k">fi</span>

  sleep <span class="nv">$DELAY</span>
<span class="o">}</span>

<span class="c"># From here down, almost the same as original (hanoi.bash) script.</span>

dohanoi<span class="o">()</span> <span class="o">{</span>   <span class="c"># Recursive function.</span>
    <span class="k">case</span> <span class="nv">$1</span> in
    0<span class="o">)</span>
        <span class="p">;;</span>
    *<span class="o">)</span>
        dohanoi <span class="s2">&quot;</span><span class="k">$((</span><span class="nv">$1</span><span class="o">-</span><span class="m">1</span><span class="k">))</span><span class="s2">&quot;</span> <span class="nv">$2</span> <span class="nv">$4</span> <span class="nv">$3</span>
    <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$Moves</span><span class="s2">&quot;</span> -ne <span class="m">0</span> <span class="o">]</span>
        <span class="k">then</span>
      tput cup <span class="m">0</span> 0
      <span class="nb">echo</span><span class="p">;</span> <span class="nb">echo</span> <span class="s2">&quot;+  Position after move </span><span class="nv">$Moves</span><span class="s2">&quot;</span>
        <span class="k">fi</span>
        <span class="o">((</span>Moves++<span class="o">))</span>
        <span class="nb">echo</span> -n <span class="s2">&quot;   Next move will be:  &quot;</span>
        <span class="nb">echo</span> <span class="nv">$2</span> <span class="s2">&quot;--&gt;&quot;</span> <span class="nv">$3</span>
        display <span class="nv">$2</span> <span class="nv">$3</span>
        dohanoi <span class="s2">&quot;</span><span class="k">$((</span><span class="nv">$1</span><span class="o">-</span><span class="m">1</span><span class="k">))</span><span class="s2">&quot;</span> <span class="nv">$4</span> <span class="nv">$3</span> <span class="nv">$2</span>
        <span class="p">;;</span>
    <span class="k">esac</span>
<span class="o">}</span>

setup_arrays <span class="o">()</span>
<span class="o">{</span>
  <span class="nb">local </span>dim n elem

  <span class="nb">let</span> <span class="s2">&quot;dim1 = </span><span class="nv">$1</span><span class="s2"> - 1&quot;</span>
  <span class="nv">elem</span><span class="o">=</span><span class="nv">$dim1</span>

  <span class="k">for</span> n in <span class="k">$(</span>seq <span class="m">0</span> <span class="nv">$dim1</span><span class="k">)</span>
  <span class="k">do</span>
   <span class="nb">let</span> <span class="s2">&quot;Rod1[</span><span class="nv">$elem</span><span class="s2">] = 2 * </span><span class="nv">$n</span><span class="s2"> + 1&quot;</span>
   Rod2<span class="o">[</span><span class="nv">$n</span><span class="o">]=</span>0
   Rod3<span class="o">[</span><span class="nv">$n</span><span class="o">]=</span>0
   <span class="o">((</span>elem--<span class="o">))</span>
  <span class="k">done</span>
<span class="o">}</span>


<span class="c">###   Main   ###</span>

<span class="nb">trap</span> <span class="s2">&quot;tput cnorm&quot;</span> 0
tput civis
clear

setup_arrays <span class="nv">$DISKS</span>

tput cup <span class="m">0</span> 0
<span class="nb">echo</span><span class="p">;</span> <span class="nb">echo</span> <span class="s2">&quot;+  Start Position&quot;</span>

<span class="k">case</span> <span class="nv">$# </span>in
    1<span class="o">)</span> <span class="k">case</span> <span class="k">$((</span><span class="nv">$1</span>&gt;0<span class="k">))</span> in     <span class="c"># Must have at least one disk.</span>
       1<span class="o">)</span>
           <span class="nv">disks</span><span class="o">=</span><span class="nv">$1</span>
           dohanoi <span class="nv">$1</span> <span class="m">1</span> <span class="m">3</span> 2
<span class="c">#          Total moves = 2^n - 1, where n = # of disks.</span>
       <span class="nb">echo</span>
<span class="nb">           exit </span>0<span class="p">;</span>
           <span class="p">;;</span>
       *<span class="o">)</span>
           <span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$0</span><span class="s2">: Illegal value for number of disks&quot;</span><span class="p">;</span>
           <span class="nb">exit</span> <span class="nv">$E_BADPARAM</span><span class="p">;</span>
           <span class="p">;;</span>
       <span class="k">esac</span>
    <span class="p">;;</span>
    *<span class="o">)</span>
       <span class="nb">echo</span> <span class="s2">&quot;usage: </span><span class="nv">$0</span><span class="s2"> N&quot;</span>
       <span class="nb">echo</span> <span class="s2">&quot;       Where \&quot;N\&quot; is the number of disks.&quot;</span>
       <span class="nb">exit</span> <span class="nv">$E_NOPARAM</span><span class="p">;</span>
       <span class="p">;;</span>
<span class="k">esac</span>

<span class="nb">exit</span> <span class="nv">$E_NOEXIT</span>   <span class="c"># Shouldn&#39;t exit here.</span>

<span class="c">#  Exercise:</span>
<span class="c">#  --------</span>
<span class="c">#  There is a minor bug in the script that causes the display of</span>
<span class="c">#+ the next-to-last move to be skipped.</span>
<span class="c">#+ Fix this.</span>
</pre></div>
</div>
</div>
<div class="section" id="exemple-50-an-alternate-version-of-the-getopt-simple-sh-script">
<h2>Exemple 50. An alternate version of the <a class="reference external" href="string-manipulation.html#GETOPTSIMPLE">getopt-simple.sh</a> script<a class="headerlink" href="#exemple-50-an-alternate-version-of-the-getopt-simple-sh-script" title="Link permanent a aquest títol">¶</a></h2>
<div class="highlight-sh"><div class="highlight"><pre><span class="c">#!/bin/bash</span>
<span class="c"># UseGetOpt.sh</span>

<span class="c"># Author: Peggy Russell &lt;prusselltechgroup@gmail.com&gt;</span>

UseGetOpt <span class="o">()</span> <span class="o">{</span>
  <span class="nb">declare </span>inputOptions
  <span class="nb">declare</span> -r <span class="nv">E_OPTERR</span><span class="o">=</span>85
  <span class="nb">declare</span> -r <span class="nv">ScriptName</span><span class="o">=</span><span class="si">${</span><span class="nv">0</span><span class="p">##*/</span><span class="si">}</span>
  <span class="nb">declare</span> -r <span class="nv">ShortOpts</span><span class="o">=</span><span class="s2">&quot;adf:hlt&quot;</span>
  <span class="nb">declare</span> -r <span class="nv">LongOpts</span><span class="o">=</span><span class="s2">&quot;aoption,debug,file:,help,log,test&quot;</span>

DoSomething <span class="o">()</span> <span class="o">{</span>
    <span class="nb">echo</span> <span class="s2">&quot;The function name is &#39;</span><span class="si">${</span><span class="nv">FUNCNAME</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
    <span class="c">#  Recall that $FUNCNAME is an internal variable</span>
    <span class="c">#+ holding the name of the function it is in.</span>
  <span class="o">}</span>

  <span class="nv">inputOptions</span><span class="o">=</span><span class="k">$(</span>getopt -o <span class="s2">&quot;</span><span class="si">${</span><span class="nv">ShortOpts</span><span class="si">}</span><span class="s2">&quot;</span> --long <span class="se">\</span>
              <span class="s2">&quot;</span><span class="si">${</span><span class="nv">LongOpts</span><span class="si">}</span><span class="s2">&quot;</span> --name <span class="s2">&quot;</span><span class="si">${</span><span class="nv">ScriptName</span><span class="si">}</span><span class="s2">&quot;</span> -- <span class="s2">&quot;</span><span class="si">${</span><span class="p">@</span><span class="si">}</span><span class="s2">&quot;</span><span class="k">)</span>

  <span class="k">if</span> <span class="o">[[</span> <span class="o">(</span><span class="nv">$?</span> -ne 0<span class="o">)</span> <span class="p">|</span><span class="o">(</span><span class="nv">$# </span>-eq 0<span class="o">)</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nb">echo</span> <span class="s2">&quot;Usage: </span><span class="si">${</span><span class="nv">ScriptName</span><span class="si">}</span><span class="s2"> [-dhlt] {OPTION...}&quot;</span>
    <span class="nb">exit</span> <span class="nv">$E_OPTERR</span>
  <span class="k">fi</span>

  <span class="nb">eval set</span> -- <span class="s2">&quot;</span><span class="si">${</span><span class="nv">inputOptions</span><span class="si">}</span><span class="s2">&quot;</span>

  <span class="c"># Only for educational purposes. Can be removed.</span>
  <span class="c">#-----------------------------------------------</span>
  <span class="nb">echo</span> <span class="s2">&quot;++ Test: Number of arguments: [</span><span class="nv">$#]</span><span class="s2">&quot;</span>
  <span class="nb">echo</span> <span class="s1">&#39;++ Test: Looping through &quot;$@&quot;&#39;</span>
  <span class="k">for</span> a in <span class="s2">&quot;</span><span class="nv">$@</span><span class="s2">&quot;</span><span class="p">;</span> <span class="k">do</span>
    <span class="nb">echo</span> <span class="s2">&quot;  ++ [</span><span class="nv">$a</span><span class="s2">]&quot;</span>
  <span class="k">done</span>
  <span class="c">#-----------------------------------------------</span>

  <span class="k">while</span> <span class="nb">true</span><span class="p">;</span> <span class="k">do</span>
    <span class="k">case</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">1</span><span class="si">}</span><span class="s2">&quot;</span> in
      --aoption-a<span class="o">)</span>  <span class="c"># Argument found.</span>
        <span class="nb">echo</span> <span class="s2">&quot;Option [</span><span class="nv">$1</span><span class="s2">]&quot;</span>
        <span class="p">;;</span>

      --debug-d<span class="o">)</span>    <span class="c"># Enable informational messages.</span>
        <span class="nb">echo</span> <span class="s2">&quot;Option [</span><span class="nv">$1</span><span class="s2">] Debugging enabled&quot;</span>
        <span class="p">;;</span>

      --file-f<span class="o">)</span>     <span class="c">#  Check for optional argument.</span>
        <span class="k">case</span> <span class="s2">&quot;</span><span class="nv">$2</span><span class="s2">&quot;</span> in   <span class="c">#+ Double colon is optional argument.</span>
          <span class="s2">&quot;&quot;</span><span class="o">)</span>          <span class="c">#  Not there.</span>
              <span class="nb">echo</span> <span class="s2">&quot;Option [</span><span class="nv">$1</span><span class="s2">] Use default&quot;</span>
              <span class="nb">shift</span>
              <span class="p">;;</span>

          *<span class="o">)</span> <span class="c"># Got it</span>
             <span class="nb">echo</span> <span class="s2">&quot;Option [</span><span class="nv">$1</span><span class="s2">] Using input [</span><span class="nv">$2</span><span class="s2">]&quot;</span>
             <span class="nb">shift</span>
             <span class="p">;;</span>

        <span class="k">esac</span>
        DoSomething
        <span class="p">;;</span>

      --log-l<span class="o">)</span> <span class="c"># Enable Logging.</span>
        <span class="nb">echo</span> <span class="s2">&quot;Option [</span><span class="nv">$1</span><span class="s2">] Logging enabled&quot;</span>
        <span class="p">;;</span>

      --test-t<span class="o">)</span> <span class="c"># Enable testing.</span>
        <span class="nb">echo</span> <span class="s2">&quot;Option [</span><span class="nv">$1</span><span class="s2">] Testing enabled&quot;</span>
        <span class="p">;;</span>

      --help-h<span class="o">)</span>
        <span class="nb">echo</span> <span class="s2">&quot;Option [</span><span class="nv">$1</span><span class="s2">] Display help&quot;</span>
        <span class="nb">break</span>
        <span class="p">;;</span>

      --<span class="o">)</span>   <span class="c"># Done! $# is argument number for &quot;--&quot;, $@ is &quot;--&quot;</span>
        <span class="nb">echo</span> <span class="s2">&quot;Option [</span><span class="nv">$1</span><span class="s2">] Dash Dash&quot;</span>
        <span class="nb">break</span>
        <span class="p">;;</span>

       *<span class="o">)</span>
        <span class="nb">echo</span> <span class="s2">&quot;Major internal error!&quot;</span>
        <span class="nb">exit </span>8
        <span class="p">;;</span>

    <span class="k">esac</span>
    <span class="nb">echo</span> <span class="s2">&quot;Number of arguments: [</span><span class="nv">$#]</span><span class="s2">&quot;</span>
    <span class="nb">shift</span>
<span class="nb">  </span><span class="k">done</span>

  <span class="nb">shift</span>
  <span class="c"># Only for educational purposes. Can be removed.</span>
  <span class="c">#----------------------------------------------------------------------</span>
  <span class="nb">echo</span> <span class="s2">&quot;++ Test: Number of arguments after \&quot;--\&quot; is [</span><span class="nv">$#]</span><span class="s2"> They are: [</span><span class="nv">$@</span><span class="s2">]&quot;</span>
  <span class="nb">echo</span> <span class="s1">&#39;++ Test: Looping through &quot;$@&quot;&#39;</span>
  <span class="k">for</span> a in <span class="s2">&quot;</span><span class="nv">$@</span><span class="s2">&quot;</span><span class="p">;</span> <span class="k">do</span>
    <span class="nb">echo</span> <span class="s2">&quot;  ++ [</span><span class="nv">$a</span><span class="s2">]&quot;</span>
  <span class="k">done</span>
  <span class="c">#----------------------------------------------------------------------</span>

<span class="o">}</span>

<span class="c">################################### M A I N ########################</span>
<span class="c">#  If you remove &quot;function UseGetOpt () {&quot; and corresponding &quot;}&quot;,</span>
<span class="c">#+ you can uncomment the &quot;exit 0&quot; line below, and invoke this script</span>
<span class="c">#+ with the various options from the command-line.</span>
<span class="c">#-------------------------------------------------------------------</span>
<span class="c"># exit 0</span>

<span class="nb">echo</span> <span class="s2">&quot;Test 1&quot;</span>
UseGetOpt -f myfile one <span class="s2">&quot;two three&quot;</span> four

<span class="nb">echo</span><span class="p">;</span><span class="nb">echo</span> <span class="s2">&quot;Test 2&quot;</span>
UseGetOpt -h

<span class="nb">echo</span><span class="p">;</span><span class="nb">echo</span> <span class="s2">&quot;Test 3 - Short Options&quot;</span>
UseGetOpt -adltf myfile  anotherfile

<span class="nb">echo</span><span class="p">;</span><span class="nb">echo</span> <span class="s2">&quot;Test 4 - Long Options&quot;</span>
UseGetOpt --aoption --debug --log --test --file myfile anotherfile

<span class="nb">exit</span>
</pre></div>
</div>
</div>
<div class="section" id="exemple-51-the-version-of-the-usegetopt-sh-example-used-in-the-tab-expansion-appendix">
<h2>Exemple 51. The version of the <em>UseGetOpt.sh</em> example used in the <a class="reference external" href="tabexpansion.html">Tab Expansion appendix</a><a class="headerlink" href="#exemple-51-the-version-of-the-usegetopt-sh-example-used-in-the-tab-expansion-appendix" title="Link permanent a aquest títol">¶</a></h2>
<div class="highlight-sh"><div class="highlight"><pre><span class="c">#!/bin/bash</span>

<span class="c">#  UseGetOpt-2.sh</span>
<span class="c">#  Modified version of the script for illustrating tab-expansion</span>
<span class="c">#+ of command-line options.</span>
<span class="c">#  See the &quot;Introduction to Tab Expansion&quot; appendix.</span>

<span class="c">#  Possible options: -a -d -f -l -t -h</span>
<span class="c">#+                   --aoption, --debug --file --log --test -- help --</span>

<span class="c">#  Author of original script: Peggy Russell &lt;prusselltechgroup@gmail.com&gt;</span>


<span class="c"># UseGetOpt () {</span>
  <span class="nb">declare </span>inputOptions
  <span class="nb">declare</span> -r <span class="nv">E_OPTERR</span><span class="o">=</span>85
  <span class="nb">declare</span> -r <span class="nv">ScriptName</span><span class="o">=</span><span class="si">${</span><span class="nv">0</span><span class="p">##*/</span><span class="si">}</span>
  <span class="nb">declare</span> -r <span class="nv">ShortOpts</span><span class="o">=</span><span class="s2">&quot;adf:hlt&quot;</span>
  <span class="nb">declare</span> -r <span class="nv">LongOpts</span><span class="o">=</span><span class="s2">&quot;aoption,debug,file:,help,log,test&quot;</span>

DoSomething <span class="o">()</span> <span class="o">{</span>
    <span class="nb">echo</span> <span class="s2">&quot;The function name is &#39;</span><span class="si">${</span><span class="nv">FUNCNAME</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
  <span class="o">}</span>

  <span class="nv">inputOptions</span><span class="o">=</span><span class="k">$(</span>getopt -o <span class="s2">&quot;</span><span class="si">${</span><span class="nv">ShortOpts</span><span class="si">}</span><span class="s2">&quot;</span> --long <span class="se">\</span>
              <span class="s2">&quot;</span><span class="si">${</span><span class="nv">LongOpts</span><span class="si">}</span><span class="s2">&quot;</span> --name <span class="s2">&quot;</span><span class="si">${</span><span class="nv">ScriptName</span><span class="si">}</span><span class="s2">&quot;</span> -- <span class="s2">&quot;</span><span class="si">${</span><span class="p">@</span><span class="si">}</span><span class="s2">&quot;</span><span class="k">)</span>

  <span class="k">if</span> <span class="o">[[</span> <span class="o">(</span><span class="nv">$?</span> -ne 0<span class="o">)</span> <span class="p">|</span><span class="o">(</span><span class="nv">$# </span>-eq 0<span class="o">)</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nb">echo</span> <span class="s2">&quot;Usage: </span><span class="si">${</span><span class="nv">ScriptName</span><span class="si">}</span><span class="s2"> [-dhlt] {OPTION...}&quot;</span>
    <span class="nb">exit</span> <span class="nv">$E_OPTERR</span>
  <span class="k">fi</span>

  <span class="nb">eval set</span> -- <span class="s2">&quot;</span><span class="si">${</span><span class="nv">inputOptions</span><span class="si">}</span><span class="s2">&quot;</span>


  <span class="k">while</span> <span class="nb">true</span><span class="p">;</span> <span class="k">do</span>
    <span class="k">case</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">1</span><span class="si">}</span><span class="s2">&quot;</span> in
      --aoption-a<span class="o">)</span>  <span class="c"># Argument found.</span>
        <span class="nb">echo</span> <span class="s2">&quot;Option [</span><span class="nv">$1</span><span class="s2">]&quot;</span>
        <span class="p">;;</span>

      --debug-d<span class="o">)</span>    <span class="c"># Enable informational messages.</span>
        <span class="nb">echo</span> <span class="s2">&quot;Option [</span><span class="nv">$1</span><span class="s2">] Debugging enabled&quot;</span>
        <span class="p">;;</span>

      --file-f<span class="o">)</span>     <span class="c">#  Check for optional argument.</span>
        <span class="k">case</span> <span class="s2">&quot;</span><span class="nv">$2</span><span class="s2">&quot;</span> in   <span class="c">#+ Double colon is optional argument.</span>
          <span class="s2">&quot;&quot;</span><span class="o">)</span>          <span class="c">#  Not there.</span>
              <span class="nb">echo</span> <span class="s2">&quot;Option [</span><span class="nv">$1</span><span class="s2">] Use default&quot;</span>
              <span class="nb">shift</span>
              <span class="p">;;</span>

          *<span class="o">)</span> <span class="c"># Got it</span>
             <span class="nb">echo</span> <span class="s2">&quot;Option [</span><span class="nv">$1</span><span class="s2">] Using input [</span><span class="nv">$2</span><span class="s2">]&quot;</span>
             <span class="nb">shift</span>
             <span class="p">;;</span>

        <span class="k">esac</span>
        DoSomething
        <span class="p">;;</span>

      --log-l<span class="o">)</span> <span class="c"># Enable Logging.</span>
        <span class="nb">echo</span> <span class="s2">&quot;Option [</span><span class="nv">$1</span><span class="s2">] Logging enabled&quot;</span>
        <span class="p">;;</span>

      --test-t<span class="o">)</span> <span class="c"># Enable testing.</span>
        <span class="nb">echo</span> <span class="s2">&quot;Option [</span><span class="nv">$1</span><span class="s2">] Testing enabled&quot;</span>
        <span class="p">;;</span>

      --help-h<span class="o">)</span>
        <span class="nb">echo</span> <span class="s2">&quot;Option [</span><span class="nv">$1</span><span class="s2">] Display help&quot;</span>
        <span class="nb">break</span>
        <span class="p">;;</span>

      --<span class="o">)</span>   <span class="c"># Done! $# is argument number for &quot;--&quot;, $@ is &quot;--&quot;</span>
        <span class="nb">echo</span> <span class="s2">&quot;Option [</span><span class="nv">$1</span><span class="s2">] Dash Dash&quot;</span>
        <span class="nb">break</span>
        <span class="p">;;</span>

       *<span class="o">)</span>
        <span class="nb">echo</span> <span class="s2">&quot;Major internal error!&quot;</span>
        <span class="nb">exit </span>8
        <span class="p">;;</span>

    <span class="k">esac</span>
    <span class="nb">echo</span> <span class="s2">&quot;Number of arguments: [</span><span class="nv">$#]</span><span class="s2">&quot;</span>
    <span class="nb">shift</span>
<span class="nb">  </span><span class="k">done</span>

  <span class="nb">shift</span>

<span class="c">#  }</span>

<span class="nb">exit</span>
</pre></div>
</div>
</div>
<div class="section" id="exemple-52-cycling-through-all-the-possible-color-backgrounds">
<h2>Exemple 52. Cycling through all the possible color backgrounds<a class="headerlink" href="#exemple-52-cycling-through-all-the-possible-color-backgrounds" title="Link permanent a aquest títol">¶</a></h2>
<div class="highlight-sh"><div class="highlight"><pre><span class="c">#!/bin/bash</span>

<span class="c"># show-all-colors.sh</span>
<span class="c"># Displays all 256 possible background colors, using ANSI escape sequences.</span>
<span class="c"># Author: Chetankumar Phulpagare</span>
<span class="c"># Used in ABS Guide with permission.</span>

<span class="nv">T1</span><span class="o">=</span>8
<span class="nv">T2</span><span class="o">=</span>6
<span class="nv">T3</span><span class="o">=</span>36
<span class="nv">offset</span><span class="o">=</span>0

<span class="k">for</span> num1 in <span class="o">{</span>0..7<span class="o">}</span>
<span class="k">do</span> <span class="o">{</span>
   <span class="k">for</span> num2 in <span class="o">{</span>0,1<span class="o">}</span>
       <span class="k">do</span> <span class="o">{</span>
          <span class="nv">shownum</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$offset</span><span class="s2"> + </span><span class="nv">$T1</span><span class="s2"> * </span><span class="si">${</span><span class="nv">num2</span><span class="si">}</span><span class="s2"> + </span><span class="nv">$num1</span><span class="s2">&quot;</span>bc<span class="sb">`</span>
          <span class="nb">echo</span> -en <span class="s2">&quot;\E[0;48;5;</span><span class="si">${</span><span class="nv">shownum</span><span class="si">}</span><span class="s2">m color </span><span class="si">${</span><span class="nv">shownum</span><span class="si">}</span><span class="s2"> \E[0m&quot;</span>
          <span class="o">}</span>
       <span class="k">done</span>
   <span class="nb">echo</span>
   <span class="o">}</span>
<span class="k">done</span>

<span class="nv">offset</span><span class="o">=</span>16
<span class="k">for</span> num1 in <span class="o">{</span>0..5<span class="o">}</span>
<span class="k">do</span> <span class="o">{</span>
   <span class="k">for</span> num2 in <span class="o">{</span>0..5<span class="o">}</span>
       <span class="k">do</span> <span class="o">{</span>
          <span class="k">for</span> num3 in <span class="o">{</span>0..5<span class="o">}</span>
              <span class="k">do</span> <span class="o">{</span>
                 <span class="nv">shownum</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$offset</span><span class="s2"> + </span><span class="nv">$T2</span><span class="s2"> * </span><span class="si">${</span><span class="nv">num3</span><span class="si">}</span><span class="s2"> \</span>
<span class="s2">                 + </span><span class="nv">$num2</span><span class="s2"> + </span><span class="nv">$T3</span><span class="s2"> * </span><span class="si">${</span><span class="nv">num1</span><span class="si">}</span><span class="s2">&quot;</span>bc<span class="sb">`</span>
                 <span class="nb">echo</span> -en <span class="s2">&quot;\E[0;48;5;</span><span class="si">${</span><span class="nv">shownum</span><span class="si">}</span><span class="s2">m color </span><span class="si">${</span><span class="nv">shownum</span><span class="si">}</span><span class="s2"> \E[0m&quot;</span>
                 <span class="o">}</span>
               <span class="k">done</span>
          <span class="nb">echo</span>
          <span class="o">}</span>
       <span class="k">done</span>
<span class="o">}</span>
<span class="k">done</span>

<span class="nv">offset</span><span class="o">=</span>232
<span class="k">for</span> num1 in <span class="o">{</span>0..23<span class="o">}</span>
<span class="k">do</span> <span class="o">{</span>
   <span class="nv">shownum</span><span class="o">=</span><span class="sb">`</span>expr <span class="nv">$offset</span> + <span class="nv">$num1</span><span class="sb">`</span>
   <span class="nb">echo</span> -en <span class="s2">&quot;\E[0;48;5;</span><span class="si">${</span><span class="nv">shownum</span><span class="si">}</span><span class="s2">m </span><span class="si">${</span><span class="nv">shownum</span><span class="si">}</span><span class="s2">\E[0m&quot;</span>
<span class="o">}</span>
<span class="k">done</span>

<span class="nb">echo</span>
</pre></div>
</div>
</div>
<div class="section" id="exemple-53-morse-code-practice">
<h2>Exemple 53. Morse Code Practice<a class="headerlink" href="#exemple-53-morse-code-practice" title="Link permanent a aquest títol">¶</a></h2>
<div class="highlight-sh"><div class="highlight"><pre><span class="c">#!/bin/bash</span>
<span class="c"># sam.sh, v. .01a</span>
<span class="c"># Still Another Morse (code training script)</span>
<span class="c"># With profuse apologies to Sam (F.B.) Morse.</span>
<span class="c"># Author: Mendel Cooper</span>
<span class="c"># License: GPL3</span>
<span class="c"># Reldate: 05/25/11</span>

<span class="c"># Morse code training script.</span>
<span class="c"># Converts arguments to audible dots and dashes.</span>
<span class="c"># Note: lowercase input only at this time.</span>



<span class="c"># Get the wav files from the source tarball:</span>
<span class="c"># http://bash.deta.in/abs-guide-latest.tar.bz2</span>
<span class="nv">DOT</span><span class="o">=</span><span class="s1">&#39;soundfiles/dot.wav&#39;</span>
<span class="nv">DASH</span><span class="o">=</span><span class="s1">&#39;soundfiles/dash.wav&#39;</span>
<span class="c"># Maybe move soundfiles to /usr/local/sounds?</span>

<span class="nv">LETTERSPACE</span><span class="o">=</span><span class="m">300000</span>  <span class="c"># Microseconds.</span>
<span class="nv">WORDSPACE</span><span class="o">=</span>980000
<span class="c"># Nice and slow, for beginners. Maybe 5 wpm?</span>

<span class="nv">EXIT_MSG</span><span class="o">=</span><span class="s2">&quot;May the Morse be with you!&quot;</span>
<span class="nv">E_NOARGS</span><span class="o">=</span><span class="m">75</span>         <span class="c"># No command-line args?</span>



<span class="nb">declare</span> -A morse    <span class="c"># Associative array!</span>
<span class="c"># ======================================= #</span>
morse<span class="o">[</span>a<span class="o">]=</span><span class="s2">&quot;dot; dash&quot;</span>
morse<span class="o">[</span>b<span class="o">]=</span><span class="s2">&quot;dash; dot; dot; dot&quot;</span>
morse<span class="o">[</span>c<span class="o">]=</span><span class="s2">&quot;dash; dot; dash; dot&quot;</span>
morse<span class="o">[</span>d<span class="o">]=</span><span class="s2">&quot;dash; dot; dot&quot;</span>
morse<span class="o">[</span>e<span class="o">]=</span><span class="s2">&quot;dot&quot;</span>
morse<span class="o">[</span>f<span class="o">]=</span><span class="s2">&quot;dot; dot; dash; dot&quot;</span>
morse<span class="o">[</span>g<span class="o">]=</span><span class="s2">&quot;dash; dash; dot&quot;</span>
morse<span class="o">[</span>h<span class="o">]=</span><span class="s2">&quot;dot; dot; dot; dot&quot;</span>
morse<span class="o">[</span>i<span class="o">]=</span><span class="s2">&quot;dot; dot;&quot;</span>
morse<span class="o">[</span>j<span class="o">]=</span><span class="s2">&quot;dot; dash; dash; dash&quot;</span>
morse<span class="o">[</span>k<span class="o">]=</span><span class="s2">&quot;dash; dot; dash&quot;</span>
morse<span class="o">[</span>l<span class="o">]=</span><span class="s2">&quot;dot; dash; dot; dot&quot;</span>
morse<span class="o">[</span>m<span class="o">]=</span><span class="s2">&quot;dash; dash&quot;</span>
morse<span class="o">[</span>n<span class="o">]=</span><span class="s2">&quot;dash; dot&quot;</span>
morse<span class="o">[</span>o<span class="o">]=</span><span class="s2">&quot;dash; dash; dash&quot;</span>
morse<span class="o">[</span>p<span class="o">]=</span><span class="s2">&quot;dot; dash; dash; dot&quot;</span>
morse<span class="o">[</span>q<span class="o">]=</span><span class="s2">&quot;dash; dash; dot; dash&quot;</span>
morse<span class="o">[</span>r<span class="o">]=</span><span class="s2">&quot;dot; dash; dot&quot;</span>
morse<span class="o">[</span>s<span class="o">]=</span><span class="s2">&quot;dot; dot; dot&quot;</span>
morse<span class="o">[</span>t<span class="o">]=</span><span class="s2">&quot;dash&quot;</span>
morse<span class="o">[</span>u<span class="o">]=</span><span class="s2">&quot;dot; dot; dash&quot;</span>
morse<span class="o">[</span>v<span class="o">]=</span><span class="s2">&quot;dot; dot; dot; dash&quot;</span>
morse<span class="o">[</span>w<span class="o">]=</span><span class="s2">&quot;dot; dash; dash&quot;</span>
morse<span class="o">[</span>x<span class="o">]=</span><span class="s2">&quot;dash; dot; dot; dash&quot;</span>
morse<span class="o">[</span>y<span class="o">]=</span><span class="s2">&quot;dash; dot; dash; dash&quot;</span>
morse<span class="o">[</span>z<span class="o">]=</span><span class="s2">&quot;dash; dash; dot; dot&quot;</span>
morse<span class="o">[</span>0<span class="o">]=</span><span class="s2">&quot;dash; dash; dash; dash; dash&quot;</span>
morse<span class="o">[</span>1<span class="o">]=</span><span class="s2">&quot;dot; dash; dash; dash; dash&quot;</span>
morse<span class="o">[</span>2<span class="o">]=</span><span class="s2">&quot;dot; dot; dash; dash; dash&quot;</span>
morse<span class="o">[</span>3<span class="o">]=</span><span class="s2">&quot;dot; dot; dot; dash; dash&quot;</span>
morse<span class="o">[</span>4<span class="o">]=</span><span class="s2">&quot;dot; dot; dot; dot; dash&quot;</span>
morse<span class="o">[</span>5<span class="o">]=</span><span class="s2">&quot;dot; dot; dot; dot; dot&quot;</span>
morse<span class="o">[</span>6<span class="o">]=</span><span class="s2">&quot;dash; dot; dot; dot; dot&quot;</span>
morse<span class="o">[</span>7<span class="o">]=</span><span class="s2">&quot;dash; dash; dot; dot; dot&quot;</span>
morse<span class="o">[</span>8<span class="o">]=</span><span class="s2">&quot;dash; dash; dash; dot; dot&quot;</span>
morse<span class="o">[</span>9<span class="o">]=</span><span class="s2">&quot;dash; dash; dash; dash; dot&quot;</span>
<span class="c"># The following must be escaped or quoted.</span>
morse<span class="o">[</span>?<span class="o">]=</span><span class="s2">&quot;dot; dot; dash; dash; dot; dot&quot;</span>
morse<span class="o">[</span>.<span class="o">]=</span><span class="s2">&quot;dot; dash; dot; dash; dot; dash&quot;</span>
morse<span class="o">[</span>,<span class="o">]=</span><span class="s2">&quot;dash; dash; dot; dot; dash; dash&quot;</span>
morse<span class="o">[</span>/<span class="o">]=</span><span class="s2">&quot;dash; dot; dot; dash; dot&quot;</span>
morse<span class="o">[</span><span class="se">\@</span><span class="o">]=</span><span class="s2">&quot;dot; dash; dash; dot; dash; dot&quot;</span>
<span class="c"># ======================================= #</span>

play_letter <span class="o">()</span>
<span class="o">{</span>
  <span class="nb">eval</span> <span class="si">${</span><span class="nv">morse</span><span class="p">[</span><span class="nv">$1</span><span class="p">]</span><span class="si">}</span>   <span class="c"># Play dots, dashes from appropriate sound files.</span>
  <span class="c"># Why is &#39;eval&#39; necessary here?</span>
  usleep <span class="nv">$LETTERSPACE</span> <span class="c"># Pause in between letters.</span>
<span class="o">}</span>

extract_letters <span class="o">()</span>
<span class="o">{</span>                     <span class="c"># Slice string apart, letter by letter.</span>
  <span class="nb">local </span><span class="nv">pos</span><span class="o">=</span><span class="m">0</span>         <span class="c"># Starting at left end of string.</span>
  <span class="nb">local </span><span class="nv">len</span><span class="o">=</span><span class="m">1</span>         <span class="c"># One letter at a time.</span>
  <span class="nv">strlen</span><span class="o">=</span><span class="si">${#</span><span class="nv">1</span><span class="si">}</span>

  <span class="k">while</span> <span class="o">[</span> <span class="nv">$pos</span> -lt <span class="nv">$strlen</span> <span class="o">]</span>
  <span class="k">do</span>
    <span class="nv">letter</span><span class="o">=</span><span class="si">${</span><span class="nv">1</span><span class="p">:</span><span class="nv">pos</span><span class="p">:</span><span class="nv">len</span><span class="si">}</span>
    <span class="c">#      ^^^^^^^^^^^^    See Chapter 10.1.</span>
    play_letter <span class="nv">$letter</span>
    <span class="nb">echo</span> -n <span class="s2">&quot;*&quot;</span>       <span class="c">#    Mark letter just played.</span>
    <span class="o">((</span>pos++<span class="o">))</span>
  <span class="k">done</span>
<span class="o">}</span>

<span class="c">######### Play the sounds ############</span>
dot<span class="o">()</span>  <span class="o">{</span> aplay <span class="s2">&quot;</span><span class="nv">$DOT</span><span class="s2">&quot;</span> 2<span class="p">&amp;</span>&gt;/dev/null<span class="p">;</span>  <span class="o">}</span>
dash<span class="o">()</span> <span class="o">{</span> aplay <span class="s2">&quot;</span><span class="nv">$DASH</span><span class="s2">&quot;</span> 2<span class="p">&amp;</span>&gt;/dev/null<span class="p">;</span> <span class="o">}</span>
<span class="c">######################################</span>

no_args <span class="o">()</span>
<span class="o">{</span>
    <span class="nb">declare</span> -a usage
    <span class="nv">usage</span><span class="o">=(</span> <span class="nv">$0</span> word1 word2 ... <span class="o">)</span>

    <span class="nb">echo</span> <span class="s2">&quot;Usage:&quot;</span><span class="p">;</span> <span class="nb">echo</span>
<span class="nb">    echo</span> <span class="si">${</span><span class="nv">usage</span><span class="p">[*]</span><span class="si">}</span>
    <span class="k">for</span> index in <span class="m">0</span> <span class="m">1</span> <span class="m">2</span> 3
    <span class="k">do</span>
      extract_letters <span class="si">${</span><span class="nv">usage</span><span class="p">[index]</span><span class="si">}</span>
      usleep <span class="nv">$WORDSPACE</span>
      <span class="nb">echo</span> -n <span class="s2">&quot; &quot;</span>     <span class="c"># Print space between words.</span>
    <span class="k">done</span>
<span class="c">#   echo &quot;Usage: $0 word1 word2 ... &quot;</span>
    <span class="nb">echo</span><span class="p">;</span> <span class="nb">echo</span>
<span class="o">}</span>


<span class="c"># int main()</span>
<span class="c"># {</span>

clear                 <span class="c"># Clear the terminal screen.</span>
<span class="nb">echo</span> <span class="s2">&quot;            SAM&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;Still Another Morse code trainer&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;    Author: Mendel Cooper&quot;</span>
<span class="nb">echo</span><span class="p">;</span> <span class="nb">echo</span><span class="p">;</span>

<span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> <span class="o">]</span>
<span class="k">then</span>
  no_args
  <span class="nb">echo</span><span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$EXIT_MSG</span><span class="s2">&quot;</span><span class="p">;</span> <span class="nb">echo</span>
<span class="nb">  exit</span> <span class="nv">$E_NOARGS</span>
<span class="k">fi</span>

<span class="nb">echo</span><span class="p">;</span> <span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$*</span><span class="s2">&quot;</span>       <span class="c"># Print text that will be played.</span>

<span class="k">until</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> <span class="o">]</span>
<span class="k">do</span>
  extract_letters <span class="nv">$1</span>
  <span class="nb">shift</span>           <span class="c"># On to next word.</span>
  usleep <span class="nv">$WORDSPACE</span>
  <span class="nb">echo</span> -n <span class="s2">&quot; &quot;</span>     <span class="c"># Print space between words.</span>
<span class="k">done</span>

<span class="nb">echo</span><span class="p">;</span> <span class="nb">echo</span><span class="p">;</span> <span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$EXIT_MSG</span><span class="s2">&quot;</span><span class="p">;</span> <span class="nb">echo</span>

<span class="nb">exit </span>0
<span class="c"># }</span>

<span class="c">#  Exercises:</span>
<span class="c">#  ---------</span>
<span class="c">#  1) Have the script accept either lowercase or uppercase words</span>
<span class="c">#+    as arguments. Hint: Use &#39;tr&#39; . . .</span>
<span class="c">#  2) Have the script optionally accept input from a text file.</span>
</pre></div>
</div>
</div>
<div class="section" id="exemple-54-base64-encoding-decoding">
<h2>Exemple 54. Base64 encoding/decoding<a class="headerlink" href="#exemple-54-base64-encoding-decoding" title="Link permanent a aquest títol">¶</a></h2>
<div class="highlight-sh"><div class="highlight"><pre><span class="c">#!/bin/bash</span>
<span class="c"># base64.sh: Bash implementation of Base64 encoding and decoding.</span>
<span class="c">#</span>
<span class="c"># Copyright (c) 2011 vladz &lt;vladz@devzero.fr&gt;</span>
<span class="c"># Used in ABSG with permission (thanks!).</span>
<span class="c">#</span>
<span class="c">#  Encode or decode original Base64 (and also Base64url)</span>
<span class="c">#+ from STDIN to STDOUT.</span>
<span class="c">#</span>
<span class="c">#    Usage:</span>
<span class="c">#</span>
<span class="c">#    Encode</span>
<span class="c">#    $ ./base64.sh &lt; binary-file &gt; binary-file.base64</span>
<span class="c">#    Decode</span>
<span class="c">#    $ ./base64.sh -d &lt; binary-file.base64 &gt; binary-file</span>
<span class="c">#</span>
<span class="c"># Reference:</span>
<span class="c">#</span>
<span class="c">#    [1]  RFC4648 - &quot;The Base16, Base32, and Base64 Data Encodings&quot;</span>
<span class="c">#         http://tools.ietf.org/html/rfc4648#section-5</span>


<span class="c"># The base64_charset[] array contains entire base64 charset,</span>
<span class="c"># and additionally the character &quot;=&quot; ...</span>
<span class="nv">base64_charset</span><span class="o">=(</span> <span class="o">{</span>A..Z<span class="o">}</span> <span class="o">{</span>a..z<span class="o">}</span> <span class="o">{</span>0..9<span class="o">}</span> + / <span class="o">=</span> <span class="o">)</span>
                <span class="c"># Nice illustration of brace expansion.</span>

<span class="c">#  Uncomment the ### line below to use base64url encoding instead of</span>
<span class="c">#+ original base64.</span>
<span class="c">### base64_charset=( {A..Z} {a..z} {0..9} - _ = )</span>

<span class="c">#  Output text width when encoding</span>
<span class="c">#+ (64 characters, just like openssl output).</span>
<span class="nv">text_width</span><span class="o">=</span>64

<span class="k">function</span> display_base64_char <span class="o">{</span>
<span class="c">#  Convert a 6-bit number (between 0 and 63) into its corresponding values</span>
<span class="c">#+ in Base64, then display the result with the specified text width.</span>
  <span class="nb">printf</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">base64_charset</span><span class="p">[</span><span class="nv">$1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span> <span class="o">((</span> width++ <span class="o">))</span>
  <span class="o">((</span> width % <span class="nv">text_width</span> <span class="o">==</span> <span class="m">0</span> <span class="o">))</span> <span class="o">&amp;&amp;</span> <span class="nb">printf</span> <span class="s2">&quot;\n&quot;</span>
<span class="o">}</span>

<span class="k">function</span> encode_base64 <span class="o">{</span>
<span class="c"># Encode three 8-bit hexadecimal codes into four 6-bit numbers.</span>
  <span class="c">#    We need two local int array variables:</span>
  <span class="c">#    c8[]: to store the codes of the 8-bit characters to encode</span>
  <span class="c">#    c6[]: to store the corresponding encoded values on 6-bit</span>
  <span class="nb">declare</span> -a -i c8 c6

  <span class="c">#  Convert hexadecimal to decimal.</span>
  <span class="nv">c8</span><span class="o">=(</span> <span class="k">$(</span><span class="nb">printf</span> <span class="s2">&quot;ibase=16; </span><span class="si">${</span><span class="nv">1</span><span class="p">:</span><span class="nv">0</span><span class="p">:</span><span class="nv">2</span><span class="si">}</span><span class="s2">\n</span><span class="si">${</span><span class="nv">1</span><span class="p">:</span><span class="nv">2</span><span class="p">:</span><span class="nv">2</span><span class="si">}</span><span class="s2">\n</span><span class="si">${</span><span class="nv">1</span><span class="p">:</span><span class="nv">4</span><span class="p">:</span><span class="nv">2</span><span class="si">}</span><span class="s2">\n&quot;</span>bc<span class="k">)</span> <span class="o">)</span>

  <span class="c">#  Let&#39;s play with bitwise operators</span>
  <span class="c">#+ (3x8-bit into 4x6-bits conversion).</span>
  <span class="o">((</span> c6<span class="o">[</span>0<span class="o">]</span> <span class="o">=</span> c8<span class="o">[</span>0<span class="o">]</span> &gt;&gt; <span class="m">2</span> <span class="o">))</span>
  <span class="o">((</span> c6<span class="o">[</span>1<span class="o">]</span> <span class="o">=</span> <span class="o">((</span>c8<span class="o">[</span>0<span class="o">]</span> <span class="p">&amp;</span>  3<span class="o">)</span> <span class="s">&lt;&lt; 4)(c8[1] &gt;&gt; 4</span><span class="o">)</span> <span class="o">))</span>

  <span class="c"># The following operations depend on the c8 element number.</span>
  <span class="k">case</span> <span class="si">${#</span><span class="nv">c8</span><span class="p">[*]</span><span class="si">}</span> in
    3<span class="o">)</span> <span class="o">((</span> c6<span class="o">[</span>2<span class="o">]</span> <span class="o">=</span> <span class="o">((</span>c8<span class="o">[</span>1<span class="o">]</span> <span class="p">&amp;</span> 15<span class="o">)</span> <span class="s">&lt;&lt; 2)(c8[2</span><span class="o">]</span> &gt;&gt; 6<span class="o">)</span> <span class="o">))</span>
       <span class="o">((</span> c6<span class="o">[</span>3<span class="o">]</span> <span class="o">=</span> c8<span class="o">[</span>2<span class="o">]</span> <span class="p">&amp;</span> <span class="m">63</span> <span class="o">))</span> <span class="p">;;</span>
    2<span class="o">)</span> <span class="o">((</span> c6<span class="o">[</span>2<span class="o">]</span> <span class="o">=</span> <span class="o">(</span>c8<span class="o">[</span>1<span class="o">]</span> <span class="p">&amp;</span> 15<span class="o">)</span> <span class="s">&lt;&lt; 2 ))</span>
<span class="s">       (( c6[3] = 64 )) ;;</span>
<span class="s">    1) (( c6[2</span><span class="o">]</span> <span class="o">=</span> c6<span class="o">[</span>3<span class="o">]</span> <span class="o">=</span> <span class="m">64</span> <span class="o">))</span> <span class="p">;;</span>
  <span class="k">esac</span>

  <span class="k">for</span> char in <span class="si">${</span><span class="nv">c6</span><span class="p">[@]</span><span class="si">}</span><span class="p">;</span> <span class="k">do</span>
    display_base64_char <span class="si">${</span><span class="nv">char</span><span class="si">}</span>
  <span class="k">done</span>
<span class="o">}</span>

<span class="k">function</span> decode_base64 <span class="o">{</span>
<span class="c"># Decode four base64 characters into three hexadecimal ASCII characters.</span>
  <span class="c">#  c8[]: to store the codes of the 8-bit characters</span>
  <span class="c">#  c6[]: to store the corresponding Base64 values on 6-bit</span>
  <span class="nb">declare</span> -a -i c8 c6

  <span class="c"># Find decimal value corresponding to the current base64 character.</span>
  <span class="k">for</span> current_char in <span class="si">${</span><span class="nv">1</span><span class="p">:</span><span class="nv">0</span><span class="p">:</span><span class="nv">1</span><span class="si">}</span> <span class="si">${</span><span class="nv">1</span><span class="p">:</span><span class="nv">1</span><span class="p">:</span><span class="nv">1</span><span class="si">}</span> <span class="si">${</span><span class="nv">1</span><span class="p">:</span><span class="nv">2</span><span class="p">:</span><span class="nv">1</span><span class="si">}</span> <span class="si">${</span><span class="nv">1</span><span class="p">:</span><span class="nv">3</span><span class="p">:</span><span class="nv">1</span><span class="si">}</span><span class="p">;</span> <span class="k">do</span>
     <span class="o">[</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">current_char</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;=&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">break</span>

<span class="nb">     </span><span class="nv">position</span><span class="o">=</span>0
     <span class="k">while</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">current_char</span><span class="si">}</span><span class="s2">&quot;</span> !<span class="o">=</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">base64_charset</span><span class="p">[</span><span class="si">${</span><span class="nv">position</span><span class="si">}</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">do</span>
        <span class="o">((</span> position++ <span class="o">))</span>
     <span class="k">done</span>

     <span class="nv">c6</span><span class="o">=(</span> <span class="si">${</span><span class="nv">c6</span><span class="p">[*]</span><span class="si">}</span> <span class="si">${</span><span class="nv">position</span><span class="si">}</span> <span class="o">)</span>
  <span class="k">done</span>

  <span class="c">#  Let&#39;s play with bitwise operators</span>
  <span class="c">#+ (4x8-bit into 3x6-bits conversion).</span>
  <span class="o">((</span> c8<span class="o">[</span>0<span class="o">]</span> <span class="o">=</span> <span class="o">(</span>c6<span class="o">[</span>0<span class="o">]</span> <span class="s">&lt;&lt; 2)(c6[1] &gt;&gt; 4) ))</span>

<span class="s">  # The next operations depends on the c6 elements number.</span>
<span class="s">  case ${#c6[*]} in</span>
<span class="s">    3) (( c8[1] = ( (c6[1] &amp; 15) &lt;&lt; 4)(c6[2</span><span class="o">]</span> &gt;&gt; 2<span class="o">)</span> <span class="o">))</span>
       <span class="o">((</span> c8<span class="o">[</span>2<span class="o">]</span> <span class="o">=</span> <span class="o">(</span>c6<span class="o">[</span>2<span class="o">]</span> <span class="p">&amp;</span> 3<span class="o">)</span> <span class="s">&lt;&lt; 6 )); unset c8[2] ;;</span>
<span class="s">    4) (( c8[1] = ( (c6</span><span class="o">[</span>1<span class="o">]</span> <span class="p">&amp;</span> 15<span class="o">)</span> <span class="s">&lt;&lt; 4)(c6[2] &gt;&gt; 2) ))</span>
<span class="s">       (( c8[2] = ( (c6[2] &amp;  3) &lt;&lt; 6) c6[3] )) ;;</span>
<span class="s">  esac</span>

<span class="s">  for char in ${c8[*]}; do</span>
<span class="s">     printf &quot;\x$(printf &quot;%x&quot; ${char})&quot;</span>
<span class="s">  done</span>
<span class="s">}</span>


<span class="s"># main ()</span>

<span class="s">if [ &quot;$1&quot; = &quot;-d&quot; ]; then   # decode</span>

<span class="s">  # Reformat STDIN in pseudo 4</span>x6-bit groups.
  <span class="nv">content</span><span class="o">=</span><span class="k">$(</span>cat -tr -d <span class="s2">&quot;\n&quot;</span> <span class="p">|</span> sed -r <span class="s2">&quot;s/(.{4})/\1 /g&quot;</span><span class="k">)</span>

  <span class="k">for</span> chars in <span class="si">${</span><span class="nv">content</span><span class="si">}</span><span class="p">;</span> <span class="k">do</span> decode_base64 <span class="si">${</span><span class="nv">chars</span><span class="si">}</span><span class="p">;</span> <span class="k">done</span>

<span class="k">else</span>
  <span class="c"># Make a hexdump of stdin and reformat in 3-byte groups.</span>
  <span class="nv">content</span><span class="o">=</span><span class="k">$(</span>cat -xxd -ps -u <span class="p">|</span> sed -r <span class="s2">&quot;s/(\w{6})/\1 /g&quot;</span>
            tr -d <span class="s2">&quot;\n&quot;</span><span class="k">)</span>

  <span class="k">for</span> chars in <span class="si">${</span><span class="nv">content</span><span class="si">}</span><span class="p">;</span> <span class="k">do</span> encode_base64 <span class="si">${</span><span class="nv">chars</span><span class="si">}</span><span class="p">;</span> <span class="k">done</span>

  <span class="nb">echo</span>

<span class="k">fi</span>
</pre></div>
</div>
</div>
<div class="section" id="exemple-55-inserting-text-in-a-file-using-sed">
<h2>Exemple 55. Inserting text in a file using <em>sed</em><a class="headerlink" href="#exemple-55-inserting-text-in-a-file-using-sed" title="Link permanent a aquest títol">¶</a></h2>
<div class="highlight-sh"><div class="highlight"><pre><span class="c">#!/bin/bash</span>
<span class="c">#  Prepends a string at a specified line</span>
<span class="c">#+ in files with names ending in &quot;sample&quot;</span>
<span class="c">#+ in the current working directory.</span>
<span class="c">#  000000000000000000000000000000000000</span>
<span class="c">#  This script overwrites files!</span>
<span class="c">#  Be careful running it in a directory</span>
<span class="c">#+ where you have important files!!!</span>
<span class="c">#  000000000000000000000000000000000000</span>

<span class="c">#  Create a couple of files to operate on ...</span>
<span class="c">#  01sample</span>
<span class="c">#  02sample</span>
<span class="c">#  ... etc.</span>
<span class="c">#  These files must not be empty, else the prepend will not work.</span>

<span class="nv">lineno</span><span class="o">=</span><span class="m">1</span>            <span class="c"># Append at line 1 (prepend).</span>
<span class="nv">filespec</span><span class="o">=</span><span class="s2">&quot;*sample&quot;</span>  <span class="c"># Filename pattern to operate on.</span>

<span class="nv">string</span><span class="o">=</span><span class="k">$(</span>whoami<span class="k">)</span>    <span class="c"># Will set your username as string to insert.</span>
                    <span class="c"># It could just as easily be any other string.</span>

<span class="k">for</span> file in <span class="nv">$filespec</span> <span class="c"># Specify which files to alter.</span>
<span class="k">do</span> <span class="c">#        ^^^^^^^^^</span>
 sed -i <span class="s2">&quot;&quot;</span><span class="nv">$lineno</span><span class="s2">&quot;i &quot;</span><span class="nv">$string</span><span class="s2">&quot;&quot;</span> <span class="nv">$file</span>
<span class="c">#    ^^ -i option edits files in-place.</span>
<span class="c">#                 ^ Insert (i) command.</span>
 <span class="nb">echo</span> <span class="s2">&quot;&quot;</span><span class="nv">$file</span><span class="s2">&quot; altered!&quot;</span>
<span class="k">done</span>

<span class="nb">echo</span> <span class="s2">&quot;Warning: files possibly clobbered!&quot;</span>

<span class="nb">exit </span>0

<span class="c"># Exercise:</span>
<span class="c"># Add error checking to this script.</span>
<span class="c"># It needs it badly.</span>
</pre></div>
</div>
</div>
<div class="section" id="exemple-56-the-gronsfeld-cipher">
<h2>Exemple 56. The Gronsfeld Cipher<a class="headerlink" href="#exemple-56-the-gronsfeld-cipher" title="Link permanent a aquest títol">¶</a></h2>
<div class="highlight-sh"><div class="highlight"><pre><span class="c">#!/bin/bash</span>
<span class="c"># gronsfeld.bash</span>

<span class="c"># License: GPL3</span>
<span class="c"># Reldate 06/23/11</span>

<span class="c">#  This is an implementation of the Gronsfeld Cipher.</span>
<span class="c">#  It&#39;s essentially a stripped-down variant of the</span>
<span class="c">#+ polyalphabetic Vigenère Tableau, but with only 10 alphabets.</span>
<span class="c">#  The classic Gronsfeld has a numeric sequence as the key word,</span>
<span class="c">#+ but here we substitute a letter string, for ease of use.</span>
<span class="c">#  Allegedly, this cipher was invented by the eponymous Count Gronsfeld</span>
<span class="c">#+ in the 17th Century. It was at one time considered to be unbreakable.</span>
<span class="c">#  Note that this is ###not### a secure cipher by modern standards.</span>

<span class="c">#  Global Variables  #</span>
<span class="nv">Enc_suffix</span><span class="o">=</span><span class="s2">&quot;29379&quot;</span>   <span class="c">#  Encrypted text output with this 5-digit suffix.</span>
                     <span class="c">#  This functions as a decryption flag,</span>
                     <span class="c">#+ and when used to generate passwords adds security.</span>
<span class="nv">Default_key</span><span class="o">=</span><span class="s2">&quot;gronsfeldk&quot;</span>
                     <span class="c">#  The script uses this if key not entered below</span>
                     <span class="c">#  (at &quot;Keychain&quot;).</span>
                     <span class="c">#  Change the above two values frequently</span>
                     <span class="c">#+ for added security.</span>

<span class="nv">GROUPLEN</span><span class="o">=</span><span class="m">5</span>           <span class="c">#  Output in groups of 5 letters, per tradition.</span>
<span class="nv">alpha1</span><span class="o">=(</span> abcdefghijklmnopqrstuvwxyz <span class="o">)</span>
<span class="nv">alpha2</span><span class="o">=(</span> <span class="o">{</span>A..Z<span class="o">}</span> <span class="o">)</span>    <span class="c">#  Output in all caps, per tradition.</span>
                     <span class="c">#  Use   alpha2=( {a..z} )   for password generator.</span>
<span class="nv">wraplen</span><span class="o">=</span><span class="m">26</span>           <span class="c">#  Wrap around if past end of alphabet.</span>
<span class="nv">dflag</span><span class="o">=</span>               <span class="c">#  Decrypt flag (set if $Enc_suffix present).</span>
<span class="nv">E_NOARGS</span><span class="o">=</span><span class="m">76</span>          <span class="c">#  Missing command-line args?</span>
<span class="nv">DEBUG</span><span class="o">=</span><span class="m">77</span>             <span class="c">#  Debugging flag.</span>
<span class="nb">declare</span> -a offsets   <span class="c">#  This array holds the numeric shift values for</span>
                     <span class="c">#+ encryption/decryption.</span>

<span class="c">########Keychain#########</span>
<span class="nv">key</span><span class="o">=</span>  <span class="c">### Put key here!!!</span>
      <span class="c"># 10 characters!</span>
<span class="c">#########################</span>



<span class="c"># Function</span>
: <span class="o">()</span>
<span class="o">{</span> <span class="c"># Encrypt or decrypt, depending on whether $dflag is set.</span>
  <span class="c"># Why &quot;: ()&quot; as a function name? Just to prove that it can be done.</span>

  <span class="nb">local </span>idx keydx mlen off1 shft
  <span class="nb">local </span><span class="nv">plaintext</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
  <span class="nb">local </span><span class="nv">mlen</span><span class="o">=</span><span class="si">${#</span><span class="nv">plaintext</span><span class="si">}</span>

<span class="k">for</span> <span class="o">((</span> <span class="nv">idx</span><span class="o">=</span>0<span class="p">;</span> idx&lt;<span class="nv">$mlen</span><span class="p">;</span> idx++ <span class="o">))</span>
<span class="k">do</span>
  <span class="nb">let</span> <span class="s2">&quot;keydx = </span><span class="nv">$idx</span><span class="s2"> % </span><span class="nv">$keylen</span><span class="s2">&quot;</span>
  <span class="nv">shft</span><span class="o">=</span><span class="si">${</span><span class="nv">offsets</span><span class="p">[keydx]</span><span class="si">}</span>

  <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;</span><span class="nv">$dflag</span><span class="s2">&quot;</span> <span class="o">]</span>
  <span class="k">then</span>                  <span class="c"># Decrypt!</span>
    <span class="nb">let</span> <span class="s2">&quot;off1 = </span><span class="k">$(</span>expr index <span class="s2">&quot;</span><span class="si">${</span><span class="nv">alpha1</span><span class="p">[*]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="si">${</span><span class="nv">plaintext</span><span class="p">:</span><span class="nv">idx</span><span class="p">:</span><span class="nv">1</span><span class="si">}</span><span class="k">)</span><span class="s2"> - </span><span class="nv">$shft</span><span class="s2">&quot;</span>
    <span class="c"># Shift backward to decrypt.</span>
  <span class="k">else</span>                  <span class="c"># Encrypt!</span>
    <span class="nb">let</span> <span class="s2">&quot;off1 = </span><span class="k">$(</span>expr index <span class="s2">&quot;</span><span class="si">${</span><span class="nv">alpha1</span><span class="p">[*]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="si">${</span><span class="nv">plaintext</span><span class="p">:</span><span class="nv">idx</span><span class="p">:</span><span class="nv">1</span><span class="si">}</span><span class="k">)</span><span class="s2"> + </span><span class="nv">$shft</span><span class="s2">&quot;</span>
    <span class="c"># Shift forward to encrypt.</span>
    <span class="nb">test</span> <span class="k">$((</span> <span class="nv">$idx</span> <span class="o">%</span> <span class="nv">$GROUPLEN</span><span class="k">))</span> <span class="o">=</span> <span class="m">0</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> -n <span class="s2">&quot; &quot;</span>  <span class="c"># Groups of 5 letters.</span>
    <span class="c">#  Comment out above line for output as a string without whitespace,</span>
    <span class="c">#+ for example, if using the script as a password generator.</span>
  <span class="k">fi</span>

  <span class="o">((</span>off1--<span class="o">))</span>   <span class="c"># Normalize. Why is this necessary?</span>

      <span class="k">if</span> <span class="o">[</span> <span class="nv">$off1</span> -lt <span class="m">0</span> <span class="o">]</span>
      <span class="k">then</span>     <span class="c"># Catch negative indices.</span>
        <span class="nb">let</span> <span class="s2">&quot;off1 += </span><span class="nv">$wraplen</span><span class="s2">&quot;</span>
      <span class="k">fi</span>

  <span class="o">((</span>off1 %<span class="o">=</span> <span class="nv">$wraplen</span><span class="o">))</span>   <span class="c"># Wrap around if past end of alphabet.</span>

  <span class="nb">echo</span> -n <span class="s2">&quot;</span><span class="si">${</span><span class="nv">alpha2</span><span class="p">[off1]</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="k">done</span>

  <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$dflag</span><span class="s2">&quot;</span> <span class="o">]</span>
  <span class="k">then</span>
    <span class="nb">echo</span> <span class="s2">&quot; </span><span class="nv">$Enc_suffix</span><span class="s2">&quot;</span>
<span class="c">#   echo &quot;$Enc_suffix&quot;  # For password generator.</span>
  <span class="k">else</span>
    <span class="nb">echo</span>
<span class="nb">  </span><span class="k">fi</span>
<span class="o">}</span> <span class="c"># End encrypt/decrypt function.</span>



<span class="c"># int main () {</span>

<span class="c"># Check for command-line args.</span>
<span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> <span class="o">]</span>
<span class="k">then</span>
   <span class="nb">echo</span> <span class="s2">&quot;Usage: </span><span class="nv">$0</span><span class="s2"> TEXT TO ENCODE/DECODE&quot;</span>
   <span class="nb">exit</span> <span class="nv">$E_NOARGS</span>
<span class="k">fi</span>

<span class="k">if</span> <span class="o">[</span> <span class="si">${</span><span class="p">!#</span><span class="si">}</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="nv">$Enc_suffix</span><span class="s2">&quot;</span> <span class="o">]</span>
<span class="c">#    ^^^^^ Final command-line arg.</span>
<span class="k">then</span>
  <span class="nv">dflag</span><span class="o">=</span>ON
  <span class="nb">echo</span> -n <span class="s2">&quot;+&quot;</span>           <span class="c"># Flag decrypted text with a &quot;+&quot; for easy ID.</span>
<span class="k">fi</span>

<span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$key</span><span class="s2">&quot;</span> <span class="o">]</span>
<span class="k">then</span>
  <span class="nv">key</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$Default_key</span><span class="s2">&quot;</span>    <span class="c"># &quot;gronsfeldk&quot; per above.</span>
<span class="k">fi</span>

<span class="nv">keylen</span><span class="o">=</span><span class="si">${#</span><span class="nv">key</span><span class="si">}</span>

<span class="k">for</span> <span class="o">((</span> <span class="nv">idx</span><span class="o">=</span>0<span class="p">;</span> idx&lt;<span class="nv">$keylen</span><span class="p">;</span> idx++ <span class="o">))</span>
<span class="k">do</span>  <span class="c"># Calculate shift values for encryption/decryption.</span>
  offsets<span class="o">[</span>idx<span class="o">]=</span><span class="k">$(</span>expr index <span class="s2">&quot;</span><span class="si">${</span><span class="nv">alpha1</span><span class="p">[*]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="si">${</span><span class="nv">key</span><span class="p">:</span><span class="nv">idx</span><span class="p">:</span><span class="nv">1</span><span class="si">}</span><span class="k">)</span>   <span class="c"># Normalize.</span>
  <span class="o">((</span>offsets<span class="o">[</span>idx<span class="o">]</span>--<span class="o">))</span>  <span class="c">#  Necessary because &quot;expr index&quot; starts at 1,</span>
                      <span class="c">#+ whereas array count starts at 0.</span>
  <span class="c"># Generate array of numerical offsets corresponding to the key.</span>
  <span class="c"># There are simpler ways to accomplish this.</span>
<span class="k">done</span>

<span class="nv">args</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$*</span><span class="s2">&quot;</span>sed -e <span class="s1">&#39;s/ //g&#39;</span> <span class="p">|</span> tr A-Z a-z <span class="p">|</span> sed -e <span class="s1">&#39;s/[0-9]//g&#39;</span><span class="k">)</span>
<span class="c"># Remove whitespace and digits from command-line args.</span>
<span class="c"># Can modify to also remove punctuation characters, if desired.</span>

         <span class="c"># Debug:</span>
         <span class="c"># echo &quot;$args&quot;; exit $DEBUG</span>

: <span class="s2">&quot;</span><span class="nv">$args</span><span class="s2">&quot;</span>               <span class="c"># Call the function named &quot;:&quot;.</span>
<span class="c"># : is a null operator, except . . . when it&#39;s a function name!</span>

<span class="nb">exit</span> <span class="nv">$?</span>    <span class="c"># } End-of-script</span>


<span class="c">#   **************************************************************   #</span>
<span class="c">#   This script can function as a  password generator,</span>
<span class="c">#+  with several minor mods, see above.</span>
<span class="c">#   That would allow an easy-to-remember password, even the word</span>
<span class="c">#+ &quot;password&quot; itself, which encrypts to vrgfotvo29379</span>
<span class="c">#+  a fairly secure password not susceptible to a dictionary attack.</span>
<span class="c">#   Or, you could use your own name (surely that&#39;s easy to remember!).</span>
<span class="c">#   For example, Bozo Bozeman encrypts to hfnbttdppkt29379.</span>
<span class="c">#   **************************************************************   #</span>
</pre></div>
</div>
</div>
<div class="section" id="exemple-57-bingo-number-generator">
<h2>Exemple 57. Bingo Number Generator<a class="headerlink" href="#exemple-57-bingo-number-generator" title="Link permanent a aquest títol">¶</a></h2>
<div class="highlight-sh"><div class="highlight"><pre>   <span class="c">#!/bin/bash</span>
   <span class="c"># bingo.sh</span>
   <span class="c"># Bingo number generator</span>
   <span class="c"># Reldate 20Aug12, License: Public Domain</span>

   <span class="c">#######################################################################</span>
   <span class="c"># This script generates bingo numbers.</span>
   <span class="c"># Hitting a key generates a new number.</span>
   <span class="c"># Hitting &#39;q&#39; terminates the script.</span>
   <span class="c"># In a given run of the script, there will be no duplicate numbers.</span>
   <span class="c"># When the script terminates, it prints a log of the numbers generated.</span>
   <span class="c">#######################################################################</span>

   <span class="nv">MIN</span><span class="o">=</span><span class="m">1</span>       <span class="c"># Lowest allowable bingo number.</span>
   <span class="nv">MAX</span><span class="o">=</span><span class="m">75</span>      <span class="c"># Highest allowable bingo number.</span>
   <span class="nv">COLS</span><span class="o">=</span><span class="m">15</span>     <span class="c"># Numbers in each column (B I N G O).</span>
   <span class="nv">SINGLE_DIGIT_MAX</span><span class="o">=</span>9

   <span class="nb">declare</span> -a Numbers
   <span class="nv">Prefix</span><span class="o">=(</span>B I N G O<span class="o">)</span>

   initialize_Numbers <span class="o">()</span>
   <span class="o">{</span>  <span class="c"># Zero them out to start.</span>
      <span class="c"># They&#39;ll be incremented if chosen.</span>
      <span class="nb">local </span><span class="nv">index</span><span class="o">=</span>0
      <span class="k">until</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$index</span><span class="s2">&quot;</span> -gt <span class="nv">$MAX</span> <span class="o">]</span>
      <span class="k">do</span>
        Numbers<span class="o">[</span>index<span class="o">]=</span>0
        <span class="o">((</span>index++<span class="o">))</span>
      <span class="k">done</span>

      Numbers<span class="o">[</span>0<span class="o">]=</span><span class="m">1</span>   <span class="c"># Flag zero, so it won&#39;t be selected.</span>
   <span class="o">}</span>


   generate_number <span class="o">()</span>
   <span class="o">{</span>
      <span class="nb">local </span>number

      <span class="k">while</span> <span class="o">[</span> <span class="m">1</span> <span class="o">]</span>
      <span class="k">do</span>
        <span class="nb">let</span> <span class="s2">&quot;number = </span><span class="k">$(</span>expr <span class="nv">$RANDOM</span> % <span class="nv">$MAX</span><span class="k">)</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="o">[</span> <span class="si">${</span><span class="nv">Numbers</span><span class="p">[number]</span><span class="si">}</span> -eq <span class="m">0</span> <span class="o">]</span>    <span class="c"># Number not yet called.</span>
        <span class="k">then</span>
          <span class="nb">let</span> <span class="s2">&quot;Numbers[number]+=1&quot;</span>         <span class="c"># Flag it in the array.</span>
          <span class="nb">break</span>                            <span class="c"># And terminate loop.</span>
        <span class="k">fi</span>   <span class="c"># Else if already called, loop and generate another number.</span>
      <span class="k">done</span>
      <span class="c"># Exercise: Rewrite this more elegantly as an until-loop.</span>

      <span class="k">return</span> <span class="nv">$number</span>
   <span class="o">}</span>


   print_numbers_called <span class="o">()</span>
   <span class="o">{</span>   <span class="c"># Print out the called number log in neat columns.</span>
       <span class="c"># echo ${Numbers[@]}</span>

   <span class="nb">local </span><span class="nv">pre2</span><span class="o">=</span><span class="m">0</span>                <span class="c">#  Prefix a zero, so columns will align</span>
                               <span class="c">#+ on single-digit numbers.</span>

   <span class="nb">echo</span> <span class="s2">&quot;Number Stats&quot;</span>

   <span class="k">for</span> <span class="o">((</span> <span class="nv">index</span><span class="o">=</span>1<span class="p">;</span> index&lt;<span class="o">=</span>MAX<span class="p">;</span> index++<span class="o">))</span>
   <span class="k">do</span>
     <span class="nv">count</span><span class="o">=</span><span class="si">${</span><span class="nv">Numbers</span><span class="p">[index]</span><span class="si">}</span>
     <span class="nb">let</span> <span class="s2">&quot;t = </span><span class="nv">$index</span><span class="s2"> - 1&quot;</span>      <span class="c"># Normalize, since array begins with index 0.</span>
     <span class="nb">let</span> <span class="s2">&quot;column = </span><span class="k">$(</span>expr <span class="nv">$t</span> / <span class="nv">$COLS</span><span class="k">)</span><span class="s2">&quot;</span>
     <span class="nv">pre</span><span class="o">=</span><span class="si">${</span><span class="nv">Prefix</span><span class="p">[column]</span><span class="si">}</span>
   <span class="c"># echo -n &quot;${Prefix[column]} &quot;</span>

   <span class="k">if</span> <span class="o">[</span> <span class="k">$(</span>expr <span class="nv">$t</span> % <span class="nv">$COLS</span><span class="k">)</span> -eq <span class="m">0</span> <span class="o">]</span>
   <span class="k">then</span>
     <span class="nb">echo</span>   <span class="c"># Newline at end of row.</span>
   <span class="k">fi</span>

     <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$index</span><span class="s2">&quot;</span> -gt <span class="nv">$SINGLE_DIGIT_MAX</span> <span class="o">]</span>  <span class="c"># Check for single-digit number.</span>
     <span class="k">then</span>
       <span class="nb">echo</span> -n <span class="s2">&quot;</span><span class="nv">$pre$index</span><span class="s2">#</span><span class="nv">$count</span><span class="s2"> &quot;</span>
     <span class="k">else</span>    <span class="c"># Prefix a zero.</span>
       <span class="nb">echo</span> -n <span class="s2">&quot;</span><span class="nv">$pre$pre2$index</span><span class="s2">#</span><span class="nv">$count</span><span class="s2"> &quot;</span>
     <span class="k">fi</span>

   <span class="k">done</span>
   <span class="o">}</span>



   <span class="c"># main () {</span>
   <span class="nv">RANDOM</span><span class="o">=</span><span class="nv">$$</span>   <span class="c"># Seed random number generator.</span>

   initialize_Numbers   <span class="c"># Zero out the number tracking array.</span>

   clear
   <span class="nb">echo</span> <span class="s2">&quot;Bingo Number Caller&quot;</span><span class="p">;</span> <span class="nb">echo</span>

<span class="nb">   </span><span class="k">while</span> <span class="o">[[</span> <span class="s2">&quot;</span><span class="nv">$key</span><span class="s2">&quot;</span> !<span class="o">=</span> <span class="s2">&quot;q&quot;</span> <span class="o">]]</span>   <span class="c"># Main loop.</span>
   <span class="k">do</span>
     <span class="nb">read</span> -s -n1 -p <span class="s2">&quot;Hit a key for the next number [q to exit] &quot;</span> key
     <span class="c"># Usually &#39;q&#39; exits, but not always.</span>
     <span class="c"># Can always hit Ctl-C if q fails.</span>
     <span class="nb">echo</span>

<span class="nb">     </span>generate_number<span class="p">;</span> <span class="nv">new_number</span><span class="o">=</span><span class="nv">$?</span>

     <span class="nb">let</span> <span class="s2">&quot;column = </span><span class="k">$(</span>expr <span class="nv">$new_number</span> / <span class="nv">$COLS</span><span class="k">)</span><span class="s2">&quot;</span>
     <span class="nb">echo</span> -n <span class="s2">&quot;</span><span class="si">${</span><span class="nv">Prefix</span><span class="p">[column]</span><span class="si">}</span><span class="s2"> &quot;</span>   <span class="c"># B-I-N-G-O</span>

     <span class="nb">echo</span> <span class="nv">$new_number</span>
   <span class="k">done</span>

   <span class="nb">echo</span><span class="p">;</span> <span class="nb">echo</span>

   <span class="c"># Game over ...</span>
   print_numbers_called
   <span class="nb">echo</span><span class="p">;</span> <span class="nb">echo</span> <span class="s2">&quot;[#0 = not called . . . #1 = called]&quot;</span>

   <span class="nb">echo</span>

<span class="nb">   exit </span>0
   <span class="c"># }</span>


   <span class="c"># Certainly, this script could stand some improvement.</span>
   <span class="c">#See also the author&#39;s Instructable:</span>
   <span class="c">#www.instructables.com/id/Binguino-An-Arduino-based-Bingo-Number-Generato/</span>




To end this section, a review of the basics . . . and more.
</pre></div>
</div>
</div>
<div class="section" id="exemple-58-basics-reviewed">
<h2>Exemple 58. Basics Reviewed<a class="headerlink" href="#exemple-58-basics-reviewed" title="Link permanent a aquest títol">¶</a></h2>
<div class="highlight-sh"><div class="highlight"><pre><span class="c">#!/bin/bash</span>
<span class="c"># basics-reviewed.bash</span>

<span class="c"># File extension == *.bash == specific to Bash</span>

<span class="c">#   Copyright (c) Michael S. Zick, 2003; All rights reserved.</span>
<span class="c">#   License: Use in any form, for any purpose.</span>
<span class="c">#   Revision: $ID$</span>
<span class="c">#</span>
<span class="c">#              Edited for layout by M.C.</span>
<span class="c">#   (author of the &quot;Advanced Bash Scripting Guide&quot;)</span>
<span class="c">#   Fixes and updates (04/08) by Cliff Bamford.</span>


<span class="c">#  This script tested under Bash versions 2.04, 2.05a and 2.05b.</span>
<span class="c">#  It may not work with earlier versions.</span>
<span class="c">#  This demonstration script generates one --intentional--</span>
<span class="c">#+ &quot;command not found&quot; error message. See line 436.</span>

<span class="c">#  The current Bash maintainer, Chet Ramey, has fixed the items noted</span>
<span class="c">#+ for later versions of Bash.</span>



        <span class="c">###-------------------------------------------###</span>
        <span class="c">###  Pipe the output of this script to &#39;more&#39; ###</span>
        <span class="c">###+ else it will scroll off the page.        ###</span>
        <span class="c">###                                           ###</span>
        <span class="c">###  You may also redirect its output         ###</span>
        <span class="c">###+ to a file for examination.               ###</span>
        <span class="c">###-------------------------------------------###</span>



<span class="c">#  Most of the following points are described at length in</span>
<span class="c">#+ the text of the foregoing &quot;Advanced Bash Scripting Guide.&quot;</span>
<span class="c">#  This demonstration script is mostly just a reorganized presentation.</span>
<span class="c">#      -- msz</span>

<span class="c"># Variables are not typed unless otherwise specified.</span>

<span class="c">#  Variables are named. Names must contain a non-digit.</span>
<span class="c">#  File descriptor names (as in, for example: 2&gt;&amp;1)</span>
<span class="c">#+ contain ONLY digits.</span>

<span class="c"># Parameters and Bash array elements are numbered.</span>
<span class="c"># (Parameters are very similar to Bash arrays.)</span>

<span class="c"># A variable name may be undefined (null reference).</span>
<span class="nb">unset </span>VarNull

<span class="c"># A variable name may be defined but empty (null contents).</span>
<span class="nv">VarEmpty</span><span class="o">=</span><span class="s1">&#39;&#39;</span>                         <span class="c"># Two, adjacent, single quotes.</span>

<span class="c"># A variable name may be defined and non-empty.</span>
<span class="nv">VarSomething</span><span class="o">=</span><span class="s1">&#39;Literal&#39;</span>

<span class="c"># A variable may contain:</span>
<span class="c">#   * A whole number as a signed 32-bit (or larger) integer</span>
<span class="c">#   * A string</span>
<span class="c"># A variable may also be an array.</span>

<span class="c">#  A string may contain embedded blanks and may be treated</span>
<span class="c">#+ as if it where a function name with optional arguments.</span>

<span class="c">#  The names of variables and the names of functions</span>
<span class="c">#+ are in different namespaces.</span>


<span class="c">#  A variable may be defined as a Bash array either explicitly or</span>
<span class="c">#+ implicitly by the syntax of the assignment statement.</span>
<span class="c">#  Explicit:</span>
<span class="nb">declare</span> -a ArrayVar



<span class="c"># The echo command is a builtin.</span>
<span class="nb">echo</span> <span class="nv">$VarSomething</span>

<span class="c"># The printf command is a builtin.</span>
<span class="c"># Translate %s as: String-Format</span>
<span class="nb">printf</span> %s <span class="nv">$VarSomething</span>         <span class="c"># No linebreak specified, none output.</span>
<span class="nb">echo</span>                            <span class="c"># Default, only linebreak output.</span>




<span class="c"># The Bash parser word breaks on whitespace.</span>
<span class="c"># Whitespace, or the lack of it is significant.</span>
<span class="c"># (This holds true in general; there are, of course, exceptions.)</span>




<span class="c"># Translate the DOLLAR_SIGN character as: Content-Of.</span>

<span class="c"># Extended-Syntax way of writing Content-Of:</span>
<span class="nb">echo</span> <span class="si">${</span><span class="nv">VarSomething</span><span class="si">}</span>

<span class="c">#  The ${ ... } Extended-Syntax allows more than just the variable</span>
<span class="c">#+ name to be specified.</span>
<span class="c">#  In general, $VarSomething can always be written as: ${VarSomething}.</span>

<span class="c"># Call this script with arguments to see the following in action.</span>



<span class="c">#  Outside of double-quotes, the special characters @ and *</span>
<span class="c">#+ specify identical behavior.</span>
<span class="c">#  May be pronounced as: All-Elements-Of.</span>

<span class="c">#  Without specification of a name, they refer to the</span>
<span class="c">#+ pre-defined parameter Bash-Array.</span>



<span class="c"># Glob-Pattern references</span>
<span class="nb">echo</span> <span class="nv">$*</span>                         <span class="c"># All parameters to script or function</span>
<span class="nb">echo</span> <span class="si">${</span><span class="p">*</span><span class="si">}</span>                       <span class="c"># Same</span>

<span class="c"># Bash disables filename expansion for Glob-Patterns.</span>
<span class="c"># Only character matching is active.</span>


<span class="c"># All-Elements-Of references</span>
<span class="nb">echo</span> <span class="nv">$@</span>                         <span class="c"># Same as above</span>
<span class="nb">echo</span> <span class="si">${</span><span class="p">@</span><span class="si">}</span>                       <span class="c"># Same as above</span>




<span class="c">#  Within double-quotes, the behavior of Glob-Pattern references</span>
<span class="c">#+ depends on the setting of IFS (Input Field Separator).</span>
<span class="c">#  Within double-quotes, All-Elements-Of references behave the same.</span>


<span class="c">#  Specifying only the name of a variable holding a string refers</span>
<span class="c">#+ to all elements (characters) of a string.</span>


<span class="c">#  To specify an element (character) of a string,</span>
<span class="c">#+ the Extended-Syntax reference notation (see below) MAY be used.</span>




<span class="c">#  Specifying only the name of a Bash array references</span>
<span class="c">#+ the subscript zero element,</span>
<span class="c">#+ NOT the FIRST DEFINED nor the FIRST WITH CONTENTS element.</span>

<span class="c">#  Additional qualification is needed to reference other elements,</span>
<span class="c">#+ which means that the reference MUST be written in Extended-Syntax.</span>
<span class="c">#  The general form is: ${name[subscript]}.</span>

<span class="c">#  The string forms may also be used: ${name:subscript}</span>
<span class="c">#+ for Bash-Arrays when referencing the subscript zero element.</span>


<span class="c"># Bash-Arrays are implemented internally as linked lists,</span>
<span class="c">#+ not as a fixed area of storage as in some programming languages.</span>


<span class="c">#   Characteristics of Bash arrays (Bash-Arrays):</span>
<span class="c">#   --------------------------------------------</span>

<span class="c">#   If not otherwise specified, Bash-Array subscripts begin with</span>
<span class="c">#+  subscript number zero. Literally: [0]</span>
<span class="c">#   This is called zero-based indexing.</span>
<span class="c">###</span>
<span class="c">#   If not otherwise specified, Bash-Arrays are subscript packed</span>
<span class="c">#+  (sequential subscripts without subscript gaps).</span>
<span class="c">###</span>
<span class="c">#   Negative subscripts are not allowed.</span>
<span class="c">###</span>
<span class="c">#   Elements of a Bash-Array need not all be of the same type.</span>
<span class="c">###</span>
<span class="c">#   Elements of a Bash-Array may be undefined (null reference).</span>
<span class="c">#       That is, a Bash-Array may be &quot;subscript sparse.&quot;</span>
<span class="c">###</span>
<span class="c">#   Elements of a Bash-Array may be defined and empty (null contents).</span>
<span class="c">###</span>
<span class="c">#   Elements of a Bash-Array may contain:</span>
<span class="c">#     * A whole number as a signed 32-bit (or larger) integer</span>
<span class="c">#     * A string</span>
<span class="c">#     * A string formated so that it appears to be a function name</span>
<span class="c">#     + with optional arguments</span>
<span class="c">###</span>
<span class="c">#   Defined elements of a Bash-Array may be undefined (unset).</span>
<span class="c">#       That is, a subscript packed Bash-Array may be changed</span>
<span class="c">#   +   into a subscript sparse Bash-Array.</span>
<span class="c">###</span>
<span class="c">#   Elements may be added to a Bash-Array by defining an element</span>
<span class="c">#+  not previously defined.</span>
<span class="c">###</span>
<span class="c"># For these reasons, I have been calling them &quot;Bash-Arrays&quot;.</span>
<span class="c"># I&#39;ll return to the generic term &quot;array&quot; from now on.</span>
<span class="c">#     -- msz</span>


<span class="nb">echo</span> <span class="s2">&quot;=========================================================&quot;</span>

<span class="c">#  Lines 202 - 334 supplied by Cliff Bamford. (Thanks!)</span>
<span class="c">#  Demo --- Interaction with Arrays, quoting, IFS, echo, * and @   ---</span>
<span class="c">#+ all affect how things work</span>

ArrayVar<span class="o">[</span>0<span class="o">]=</span><span class="s1">&#39;zero&#39;</span>                    <span class="c"># 0 normal</span>
ArrayVar<span class="o">[</span>1<span class="o">]=</span>one                       <span class="c"># 1 unquoted literal</span>
ArrayVar<span class="o">[</span>2<span class="o">]=</span><span class="s1">&#39;two&#39;</span>                     <span class="c"># 2 normal</span>
ArrayVar<span class="o">[</span>3<span class="o">]=</span><span class="s1">&#39;three&#39;</span>                   <span class="c"># 3 normal</span>
ArrayVar<span class="o">[</span>4<span class="o">]=</span><span class="s1">&#39;I am four&#39;</span>               <span class="c"># 4 normal with spaces</span>
ArrayVar<span class="o">[</span>5<span class="o">]=</span><span class="s1">&#39;five&#39;</span>                    <span class="c"># 5 normal</span>
<span class="nb">unset </span>ArrayVar<span class="o">[</span>6<span class="o">]</span>                     <span class="c"># 6 undefined</span>
ArrayValue<span class="o">[</span>7<span class="o">]=</span><span class="s1">&#39;seven&#39;</span>                 <span class="c"># 7 normal</span>
ArrayValue<span class="o">[</span>8<span class="o">]=</span><span class="s1">&#39;&#39;</span>                      <span class="c"># 8 defined but empty</span>
ArrayValue<span class="o">[</span>9<span class="o">]=</span><span class="s1">&#39;nine&#39;</span>                  <span class="c"># 9 normal</span>


<span class="nb">echo</span> <span class="s1">&#39;--- Here is the array we are using for this test&#39;</span>
<span class="nb">echo</span>
<span class="nb">echo</span> <span class="s2">&quot;ArrayVar[0]=&#39;zero&#39;             # 0 normal&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;ArrayVar[1]=one                # 1 unquoted literal&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;ArrayVar[2]=&#39;two&#39;              # 2 normal&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;ArrayVar[3]=&#39;three&#39;            # 3 normal&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;ArrayVar[4]=&#39;I am four&#39;        # 4 normal with spaces&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;ArrayVar[5]=&#39;five&#39;             # 5 normal&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;unset ArrayVar[6]              # 6 undefined&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;ArrayValue[7]=&#39;seven&#39;          # 7 normal&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;ArrayValue[8]=&#39;&#39;               # 8 defined but empty&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;ArrayValue[9]=&#39;nine&#39;           # 9 normal&quot;</span>
<span class="nb">echo</span>


<span class="nb">echo</span>
<span class="nb">echo</span> <span class="s1">&#39;---Case0: No double-quotes, Default IFS of space,tab,newline ---&#39;</span>
<span class="nv">IFS</span><span class="o">=</span><span class="s1">$&#39;\x20&#39;$&#39;\x09&#39;$&#39;\x0A&#39;</span>            <span class="c"># In exactly this order.</span>
<span class="nb">echo</span> <span class="s1">&#39;Here is: printf %q {${ArrayVar[*]}&#39;</span>
<span class="nb">printf</span> %q <span class="si">${</span><span class="nv">ArrayVar</span><span class="p">[*]</span><span class="si">}</span>
<span class="nb">echo</span>
<span class="nb">echo</span> <span class="s1">&#39;Here is: printf %q {${ArrayVar[@]}&#39;</span>
<span class="nb">printf</span> %q <span class="si">${</span><span class="nv">ArrayVar</span><span class="p">[@]</span><span class="si">}</span>
<span class="nb">echo</span>
<span class="nb">echo</span> <span class="s1">&#39;Here is: echo ${ArrayVar[*]}&#39;</span>
<span class="nb">echo</span>  <span class="si">${</span><span class="nv">ArrayVar</span><span class="p">[@]</span><span class="si">}</span>
<span class="nb">echo</span> <span class="s1">&#39;Here is: echo {${ArrayVar[@]}&#39;</span>
<span class="nb">echo</span> <span class="si">${</span><span class="nv">ArrayVar</span><span class="p">[@]</span><span class="si">}</span>

<span class="nb">echo</span>
<span class="nb">echo</span> <span class="s1">&#39;---Case1: Within double-quotes - Default IFS of space-tab-</span>
<span class="s1">newline ---&#39;</span>
<span class="nv">IFS</span><span class="o">=</span><span class="s1">$&#39;\x20&#39;$&#39;\x09&#39;$&#39;\x0A&#39;</span>       <span class="c">#  These three bytes,</span>
<span class="nb">echo</span> <span class="s1">&#39;Here is: printf %q &quot;{${ArrayVar[*]}&quot;&#39;</span>
<span class="nb">printf</span> %q <span class="s2">&quot;</span><span class="si">${</span><span class="nv">ArrayVar</span><span class="p">[*]</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="nb">echo</span>
<span class="nb">echo</span> <span class="s1">&#39;Here is: printf %q &quot;{${ArrayVar[@]}&quot;&#39;</span>
<span class="nb">printf</span> %q <span class="s2">&quot;</span><span class="si">${</span><span class="nv">ArrayVar</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="nb">echo</span>
<span class="nb">echo</span> <span class="s1">&#39;Here is: echo &quot;${ArrayVar[*]}&quot;&#39;</span>
<span class="nb">echo</span>  <span class="s2">&quot;</span><span class="si">${</span><span class="nv">ArrayVar</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="nb">echo</span> <span class="s1">&#39;Here is: echo &quot;{${ArrayVar[@]}&quot;&#39;</span>
<span class="nb">echo</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">ArrayVar</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="nb">echo</span>
<span class="nb">echo</span> <span class="s1">&#39;---Case2: Within double-quotes - IFS is q&#39;</span>
<span class="nv">IFS</span><span class="o">=</span><span class="s1">&#39;q&#39;</span>
<span class="nb">echo</span> <span class="s1">&#39;Here is: printf %q &quot;{${ArrayVar[*]}&quot;&#39;</span>
<span class="nb">printf</span> %q <span class="s2">&quot;</span><span class="si">${</span><span class="nv">ArrayVar</span><span class="p">[*]</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="nb">echo</span>
<span class="nb">echo</span> <span class="s1">&#39;Here is: printf %q &quot;{${ArrayVar[@]}&quot;&#39;</span>
<span class="nb">printf</span> %q <span class="s2">&quot;</span><span class="si">${</span><span class="nv">ArrayVar</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="nb">echo</span>
<span class="nb">echo</span> <span class="s1">&#39;Here is: echo &quot;${ArrayVar[*]}&quot;&#39;</span>
<span class="nb">echo</span>  <span class="s2">&quot;</span><span class="si">${</span><span class="nv">ArrayVar</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="nb">echo</span> <span class="s1">&#39;Here is: echo &quot;{${ArrayVar[@]}&quot;&#39;</span>
<span class="nb">echo</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">ArrayVar</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="nb">echo</span>
<span class="nb">echo</span> <span class="s1">&#39;---Case3: Within double-quotes - IFS is ^&#39;</span>
<span class="nv">IFS</span><span class="o">=</span><span class="s1">&#39;^&#39;</span>
<span class="nb">echo</span> <span class="s1">&#39;Here is: printf %q &quot;{${ArrayVar[*]}&quot;&#39;</span>
<span class="nb">printf</span> %q <span class="s2">&quot;</span><span class="si">${</span><span class="nv">ArrayVar</span><span class="p">[*]</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="nb">echo</span>
<span class="nb">echo</span> <span class="s1">&#39;Here is: printf %q &quot;{${ArrayVar[@]}&quot;&#39;</span>
<span class="nb">printf</span> %q <span class="s2">&quot;</span><span class="si">${</span><span class="nv">ArrayVar</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="nb">echo</span>
<span class="nb">echo</span> <span class="s1">&#39;Here is: echo &quot;${ArrayVar[*]}&quot;&#39;</span>
<span class="nb">echo</span>  <span class="s2">&quot;</span><span class="si">${</span><span class="nv">ArrayVar</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="nb">echo</span> <span class="s1">&#39;Here is: echo &quot;{${ArrayVar[@]}&quot;&#39;</span>
<span class="nb">echo</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">ArrayVar</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="nb">echo</span>
<span class="nb">echo</span> <span class="s1">&#39;---Case4: Within double-quotes - IFS is ^ followed by</span>
<span class="s1">space,tab,newline&#39;</span>
<span class="nv">IFS</span><span class="o">=</span><span class="s1">$&#39;^&#39;$&#39;\x20&#39;$&#39;\x09&#39;$&#39;\x0A&#39;</span>       <span class="c"># ^ + space tab newline</span>
<span class="nb">echo</span> <span class="s1">&#39;Here is: printf %q &quot;{${ArrayVar[*]}&quot;&#39;</span>
<span class="nb">printf</span> %q <span class="s2">&quot;</span><span class="si">${</span><span class="nv">ArrayVar</span><span class="p">[*]</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="nb">echo</span>
<span class="nb">echo</span> <span class="s1">&#39;Here is: printf %q &quot;{${ArrayVar[@]}&quot;&#39;</span>
<span class="nb">printf</span> %q <span class="s2">&quot;</span><span class="si">${</span><span class="nv">ArrayVar</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="nb">echo</span>
<span class="nb">echo</span> <span class="s1">&#39;Here is: echo &quot;${ArrayVar[*]}&quot;&#39;</span>
<span class="nb">echo</span>  <span class="s2">&quot;</span><span class="si">${</span><span class="nv">ArrayVar</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="nb">echo</span> <span class="s1">&#39;Here is: echo &quot;{${ArrayVar[@]}&quot;&#39;</span>
<span class="nb">echo</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">ArrayVar</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="nb">echo</span>
<span class="nb">echo</span> <span class="s1">&#39;---Case6: Within double-quotes - IFS set and empty &#39;</span>
<span class="nv">IFS</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
<span class="nb">echo</span> <span class="s1">&#39;Here is: printf %q &quot;{${ArrayVar[*]}&quot;&#39;</span>
<span class="nb">printf</span> %q <span class="s2">&quot;</span><span class="si">${</span><span class="nv">ArrayVar</span><span class="p">[*]</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="nb">echo</span>
<span class="nb">echo</span> <span class="s1">&#39;Here is: printf %q &quot;{${ArrayVar[@]}&quot;&#39;</span>
<span class="nb">printf</span> %q <span class="s2">&quot;</span><span class="si">${</span><span class="nv">ArrayVar</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="nb">echo</span>
<span class="nb">echo</span> <span class="s1">&#39;Here is: echo &quot;${ArrayVar[*]}&quot;&#39;</span>
<span class="nb">echo</span>  <span class="s2">&quot;</span><span class="si">${</span><span class="nv">ArrayVar</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="nb">echo</span> <span class="s1">&#39;Here is: echo &quot;{${ArrayVar[@]}&quot;&#39;</span>
<span class="nb">echo</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">ArrayVar</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="nb">echo</span>
<span class="nb">echo</span> <span class="s1">&#39;---Case7: Within double-quotes - IFS is unset&#39;</span>
<span class="nb">unset </span>IFS
<span class="nb">echo</span> <span class="s1">&#39;Here is: printf %q &quot;{${ArrayVar[*]}&quot;&#39;</span>
<span class="nb">printf</span> %q <span class="s2">&quot;</span><span class="si">${</span><span class="nv">ArrayVar</span><span class="p">[*]</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="nb">echo</span>
<span class="nb">echo</span> <span class="s1">&#39;Here is: printf %q &quot;{${ArrayVar[@]}&quot;&#39;</span>
<span class="nb">printf</span> %q <span class="s2">&quot;</span><span class="si">${</span><span class="nv">ArrayVar</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="nb">echo</span>
<span class="nb">echo</span> <span class="s1">&#39;Here is: echo &quot;${ArrayVar[*]}&quot;&#39;</span>
<span class="nb">echo</span>  <span class="s2">&quot;</span><span class="si">${</span><span class="nv">ArrayVar</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="nb">echo</span> <span class="s1">&#39;Here is: echo &quot;{${ArrayVar[@]}&quot;&#39;</span>
<span class="nb">echo</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">ArrayVar</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="nb">echo</span>
<span class="nb">echo</span> <span class="s1">&#39;---End of Cases---&#39;</span>
<span class="nb">echo</span> <span class="s2">&quot;=========================================================&quot;</span><span class="p">;</span> <span class="nb">echo</span>



<span class="c"># Put IFS back to the default.</span>
<span class="c"># Default is exactly these three bytes.</span>
<span class="nv">IFS</span><span class="o">=</span><span class="s1">$&#39;\x20&#39;$&#39;\x09&#39;$&#39;\x0A&#39;</span>           <span class="c"># In exactly this order.</span>

<span class="c"># Interpretation of the above outputs:</span>
<span class="c">#   A Glob-Pattern is I/O; the setting of IFS matters.</span>
<span class="c">###</span>
<span class="c">#   An All-Elements-Of does not consider IFS settings.</span>
<span class="c">###</span>
<span class="c">#   Note the different output using the echo command and the</span>
<span class="c">#+  quoted format operator of the printf command.</span>


<span class="c">#  Recall:</span>
<span class="c">#   Parameters are similar to arrays and have the similar behaviors.</span>
<span class="c">###</span>
<span class="c">#  The above examples demonstrate the possible variations.</span>
<span class="c">#  To retain the shape of a sparse array, additional script</span>
<span class="c">#+ programming is required.</span>
<span class="c">###</span>
<span class="c">#  The source code of Bash has a routine to output the</span>
<span class="c">#+ [subscript]=value   array assignment format.</span>
<span class="c">#  As of version 2.05b, that routine is not used,</span>
<span class="c">#+ but that might change in future releases.</span>



<span class="c"># The length of a string, measured in non-null elements (characters):</span>
<span class="nb">echo</span>
<span class="nb">echo</span> <span class="s1">&#39;- - Non-quoted references - -&#39;</span>
<span class="nb">echo</span> <span class="s1">&#39;Non-Null character count: &#39;</span><span class="si">${#</span><span class="nv">VarSomething</span><span class="si">}</span><span class="s1">&#39; characters.&#39;</span>

<span class="c"># test=&#39;Lit&#39;$&#39;\x00&#39;&#39;eral&#39;           # $&#39;\x00&#39; is a null character.</span>
<span class="c"># echo ${#test}                     # See that?</span>



<span class="c">#  The length of an array, measured in defined elements,</span>
<span class="c">#+ including null content elements.</span>
<span class="nb">echo</span>
<span class="nb">echo</span> <span class="s1">&#39;Defined content count: &#39;</span><span class="si">${#</span><span class="nv">ArrayVar</span><span class="p">[@]</span><span class="si">}</span><span class="s1">&#39; elements.&#39;</span>
<span class="c"># That is NOT the maximum subscript (4).</span>
<span class="c"># That is NOT the range of the subscripts (1 . . 4 inclusive).</span>
<span class="c"># It IS the length of the linked list.</span>
<span class="c">###</span>
<span class="c">#  Both the maximum subscript and the range of the subscripts may</span>
<span class="c">#+ be found with additional script programming.</span>

<span class="c"># The length of a string, measured in non-null elements (characters):</span>
<span class="nb">echo</span>
<span class="nb">echo</span> <span class="s1">&#39;- - Quoted, Glob-Pattern references - -&#39;</span>
<span class="nb">echo</span> <span class="s1">&#39;Non-Null character count: &#39;</span><span class="s2">&quot;</span><span class="si">${#</span><span class="nv">VarSomething</span><span class="si">}</span><span class="s2">&quot;</span><span class="s1">&#39; characters.&#39;</span>

<span class="c">#  The length of an array, measured in defined elements,</span>
<span class="c">#+ including null-content elements.</span>
<span class="nb">echo</span>
<span class="nb">echo</span> <span class="s1">&#39;Defined element count: &#39;</span><span class="s2">&quot;</span><span class="si">${#</span><span class="nv">ArrayVar</span><span class="p">[*]</span><span class="si">}</span><span class="s2">&quot;</span><span class="s1">&#39; elements.&#39;</span>

<span class="c">#  Interpretation: Substitution does not effect the ${# ... } operation.</span>
<span class="c">#  Suggestion:</span>
<span class="c">#  Always use the All-Elements-Of character</span>
<span class="c">#+ if that is what is intended (independence from IFS).</span>



<span class="c">#  Define a simple function.</span>
<span class="c">#  I include an underscore in the name</span>
<span class="c">#+ to make it distinctive in the examples below.</span>
<span class="c">###</span>
<span class="c">#  Bash separates variable names and function names</span>
<span class="c">#+ in different namespaces.</span>
<span class="c">#  The Mark-One eyeball isn&#39;t that advanced.</span>
<span class="c">###</span>
_simple<span class="o">()</span> <span class="o">{</span>
    <span class="nb">echo</span> -n <span class="s1">&#39;SimpleFunc&#39;</span><span class="nv">$@</span>          <span class="c">#  Newlines are swallowed in</span>
<span class="o">}</span>                                   <span class="c">#+ result returned in any case.</span>


<span class="c"># The ( ... ) notation invokes a command or function.</span>
<span class="c"># The $( ... ) notation is pronounced: Result-Of.</span>


<span class="c"># Invoke the function _simple</span>
<span class="nb">echo</span>
<span class="nb">echo</span> <span class="s1">&#39;- - Output of function _simple - -&#39;</span>
_simple                             <span class="c"># Try passing arguments.</span>
<span class="nb">echo</span>
<span class="c"># or</span>
<span class="o">(</span>_simple<span class="o">)</span>                           <span class="c"># Try passing arguments.</span>
<span class="nb">echo</span>

<span class="nb">echo</span> <span class="s1">&#39;- Is there a variable of that name? -&#39;</span>
<span class="nb">echo</span> <span class="nv">$_simple</span> not defined           <span class="c"># No variable by that name.</span>

<span class="c"># Invoke the result of function _simple (Error msg intended)</span>

<span class="c">###</span>
<span class="k">$(</span>_simple<span class="k">)</span>                          <span class="c"># Gives an error message:</span>
<span class="c">#                          line 436: SimpleFunc: command not found</span>
<span class="c">#                          ---------------------------------------</span>

<span class="nb">echo</span>
<span class="c">###</span>

<span class="c">#  The first word of the result of function _simple</span>
<span class="c">#+ is neither a valid Bash command nor the name of a defined function.</span>
<span class="c">###</span>
<span class="c"># This demonstrates that the output of _simple is subject to evaluation.</span>
<span class="c">###</span>
<span class="c"># Interpretation:</span>
<span class="c">#   A function can be used to generate in-line Bash commands.</span>


<span class="c"># A simple function where the first word of result IS a bash command:</span>
<span class="c">###</span>
_print<span class="o">()</span> <span class="o">{</span>
    <span class="nb">echo</span> -n <span class="s1">&#39;printf %q &#39;</span><span class="nv">$@</span>
<span class="o">}</span>

<span class="nb">echo</span> <span class="s1">&#39;- - Outputs of function _print - -&#39;</span>
_print parm1 parm2                  <span class="c"># An Output NOT A Command.</span>
<span class="nb">echo</span>

<span class="k">$(</span>_print parm1 parm2<span class="k">)</span>               <span class="c">#  Executes: printf %q parm1 parm2</span>
                                    <span class="c">#  See above IFS examples for the</span>
                                    <span class="c">#+ various possibilities.</span>
<span class="nb">echo</span>

<span class="k">$(</span>_print <span class="nv">$VarSomething</span><span class="k">)</span>             <span class="c"># The predictable result.</span>
<span class="nb">echo</span>



<span class="c"># Function variables</span>
<span class="c"># ------------------</span>

<span class="nb">echo</span>
<span class="nb">echo</span> <span class="s1">&#39;- - Function variables - -&#39;</span>
<span class="c"># A variable may represent a signed integer, a string or an array.</span>
<span class="c"># A string may be used like a function name with optional arguments.</span>

<span class="c"># set -vx                           #  Enable if desired</span>
<span class="nb">declare</span> -f funcVar                  <span class="c">#+ in namespace of functions</span>

<span class="nv">funcVar</span><span class="o">=</span>_print                      <span class="c"># Contains name of function.</span>
<span class="nv">$funcVar</span> parm1                      <span class="c"># Same as _print at this point.</span>
<span class="nb">echo</span>

<span class="nv">funcVar</span><span class="o">=</span><span class="k">$(</span>_print <span class="k">)</span>                  <span class="c"># Contains result of function.</span>
<span class="nv">$funcVar</span>                            <span class="c"># No input, No output.</span>
<span class="nv">$funcVar</span> <span class="nv">$VarSomething</span>              <span class="c"># The predictable result.</span>
<span class="nb">echo</span>

<span class="nv">funcVar</span><span class="o">=</span><span class="k">$(</span>_print <span class="nv">$VarSomething</span><span class="k">)</span>     <span class="c">#  $VarSomething replaced HERE.</span>
<span class="nv">$funcVar</span>                            <span class="c">#  The expansion is part of the</span>
<span class="nb">echo</span>                                <span class="c">#+ variable contents.</span>

<span class="nv">funcVar</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>_print <span class="nv">$VarSomething</span><span class="k">)</span><span class="s2">&quot;</span>   <span class="c">#  $VarSomething replaced HERE.</span>
<span class="nv">$funcVar</span>                            <span class="c">#  The expansion is part of the</span>
<span class="nb">echo</span>                                <span class="c">#+ variable contents.</span>

<span class="c">#  The difference between the unquoted and the double-quoted versions</span>
<span class="c">#+ above can be seen in the &quot;protect_literal.sh&quot; example.</span>
<span class="c">#  The first case above is processed as two, unquoted, Bash-Words.</span>
<span class="c">#  The second case above is processed as one, quoted, Bash-Word.</span>




<span class="c"># Delayed replacement</span>
<span class="c"># -------------------</span>

<span class="nb">echo</span>
<span class="nb">echo</span> <span class="s1">&#39;- - Delayed replacement - -&#39;</span>
<span class="nv">funcVar</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>_print <span class="s1">&#39;$VarSomething&#39;</span><span class="k">)</span><span class="s2">&quot;</span> <span class="c"># No replacement, single Bash-Word.</span>
<span class="nb">eval</span> <span class="nv">$funcVar</span>                       <span class="c"># $VarSomething replaced HERE.</span>
<span class="nb">echo</span>

<span class="nv">VarSomething</span><span class="o">=</span><span class="s1">&#39;NewThing&#39;</span>
<span class="nb">eval</span> <span class="nv">$funcVar</span>                       <span class="c"># $VarSomething replaced HERE.</span>
<span class="nb">echo</span>

<span class="c"># Restore the original setting trashed above.</span>
<span class="nv">VarSomething</span><span class="o">=</span>Literal

<span class="c">#  There are a pair of functions demonstrated in the</span>
<span class="c">#+ &quot;protect_literal.sh&quot; and &quot;unprotect_literal.sh&quot; examples.</span>
<span class="c">#  These are general purpose functions for delayed replacement literals</span>
<span class="c">#+ containing variables.</span>





<span class="c"># REVIEW:</span>
<span class="c"># ------</span>

<span class="c">#  A string can be considered a Classic-Array of elements (characters).</span>
<span class="c">#  A string operation applies to all elements (characters) of the string</span>
<span class="c">#+ (in concept, anyway).</span>
<span class="c">###</span>
<span class="c">#  The notation: ${array_name[@]} represents all elements of the</span>
<span class="c">#+ Bash-Array: array_name.</span>
<span class="c">###</span>
<span class="c">#  The Extended-Syntax string operations can be applied to all</span>
<span class="c">#+ elements of an array.</span>
<span class="c">###</span>
<span class="c">#  This may be thought of as a For-Each operation on a vector of strings.</span>
<span class="c">###</span>
<span class="c">#  Parameters are similar to an array.</span>
<span class="c">#  The initialization of a parameter array for a script</span>
<span class="c">#+ and a parameter array for a function only differ</span>
<span class="c">#+ in the initialization of ${0}, which never changes its setting.</span>
<span class="c">###</span>
<span class="c">#  Subscript zero of the script&#39;s parameter array contains</span>
<span class="c">#+ the name of the script.</span>
<span class="c">###</span>
<span class="c">#  Subscript zero of a function&#39;s parameter array DOES NOT contain</span>
<span class="c">#+ the name of the function.</span>
<span class="c">#  The name of the current function is accessed by the $FUNCNAME variable.</span>
<span class="c">###</span>
<span class="c">#  A quick, review list follows (quick, not short).</span>

<span class="nb">echo</span>
<span class="nb">echo</span> <span class="s1">&#39;- - Test (but not change) - -&#39;</span>
<span class="nb">echo</span> <span class="s1">&#39;- null reference -&#39;</span>
<span class="nb">echo</span> -n <span class="si">${</span><span class="nv">VarNull</span><span class="p">-</span><span class="s1">&#39;NotSet&#39;</span><span class="si">}</span><span class="s1">&#39; &#39;</span>          <span class="c"># NotSet</span>
<span class="nb">echo</span> <span class="si">${</span><span class="nv">VarNull</span><span class="si">}</span>                         <span class="c"># NewLine only</span>
<span class="nb">echo</span> -n <span class="si">${</span><span class="nv">VarNull</span><span class="k">:-</span><span class="s1">&#39;NotSet&#39;</span><span class="si">}</span><span class="s1">&#39; &#39;</span>         <span class="c"># NotSet</span>
<span class="nb">echo</span> <span class="si">${</span><span class="nv">VarNull</span><span class="si">}</span>                         <span class="c"># Newline only</span>

<span class="nb">echo</span> <span class="s1">&#39;- null contents -&#39;</span>
<span class="nb">echo</span> -n <span class="si">${</span><span class="nv">VarEmpty</span><span class="p">-</span><span class="s1">&#39;Empty&#39;</span><span class="si">}</span><span class="s1">&#39; &#39;</span>          <span class="c"># Only the space</span>
<span class="nb">echo</span> <span class="si">${</span><span class="nv">VarEmpty</span><span class="si">}</span>                        <span class="c"># Newline only</span>
<span class="nb">echo</span> -n <span class="si">${</span><span class="nv">VarEmpty</span><span class="k">:-</span><span class="s1">&#39;Empty&#39;</span><span class="si">}</span><span class="s1">&#39; &#39;</span>         <span class="c"># Empty</span>
<span class="nb">echo</span> <span class="si">${</span><span class="nv">VarEmpty</span><span class="si">}</span>                        <span class="c"># Newline only</span>

<span class="nb">echo</span> <span class="s1">&#39;- contents -&#39;</span>
<span class="nb">echo</span> <span class="si">${</span><span class="nv">VarSomething</span><span class="p">-</span><span class="s1">&#39;Content&#39;</span><span class="si">}</span>          <span class="c"># Literal</span>
<span class="nb">echo</span> <span class="si">${</span><span class="nv">VarSomething</span><span class="k">:-</span><span class="s1">&#39;Content&#39;</span><span class="si">}</span>         <span class="c"># Literal</span>

<span class="nb">echo</span> <span class="s1">&#39;- Sparse Array -&#39;</span>
<span class="nb">echo</span> <span class="si">${</span><span class="nv">ArrayVar</span><span class="p">[@]-</span><span class="s1">&#39;not set&#39;</span><span class="si">}</span>

<span class="c"># ASCII-Art time</span>
<span class="c"># State     Y==yes, N==no</span>
<span class="c">#           -       :-</span>
<span class="c"># Unset     Y       Y       ${# ... } == 0</span>
<span class="c"># Empty     N       Y       ${# ... } == 0</span>
<span class="c"># Contents  N       N       ${# ... } &gt; 0</span>

<span class="c">#  Either the first and/or the second part of the tests</span>
<span class="c">#+ may be a command or a function invocation string.</span>
<span class="nb">echo</span>
<span class="nb">echo</span> <span class="s1">&#39;- - Test 1 for undefined - -&#39;</span>
<span class="nb">declare</span> -i t
_decT<span class="o">()</span> <span class="o">{</span>
    <span class="nv">t</span><span class="o">=</span><span class="nv">$t</span>-1
<span class="o">}</span>

<span class="c"># Null reference, set: t == -1</span>
<span class="nv">t</span><span class="o">=</span><span class="si">${#</span><span class="nv">VarNull</span><span class="si">}</span>                           <span class="c"># Results in zero.</span>
<span class="si">${</span><span class="nv">VarNull</span><span class="p">- _decT </span><span class="si">}</span>                      <span class="c"># Function executes, t now -1.</span>
<span class="nb">echo</span> <span class="nv">$t</span>

<span class="c"># Null contents, set: t == 0</span>
<span class="nv">t</span><span class="o">=</span><span class="si">${#</span><span class="nv">VarEmpty</span><span class="si">}</span>                          <span class="c"># Results in zero.</span>
<span class="si">${</span><span class="nv">VarEmpty</span><span class="p">- _decT </span><span class="si">}</span>                     <span class="c"># _decT function NOT executed.</span>
<span class="nb">echo</span> <span class="nv">$t</span>

<span class="c"># Contents, set: t == number of non-null characters</span>
<span class="nv">VarSomething</span><span class="o">=</span><span class="s1">&#39;_simple&#39;</span>                  <span class="c"># Set to valid function name.</span>
<span class="nv">t</span><span class="o">=</span><span class="si">${#</span><span class="nv">VarSomething</span><span class="si">}</span>                      <span class="c"># non-zero length</span>
<span class="si">${</span><span class="nv">VarSomething</span><span class="p">- _decT </span><span class="si">}</span>                 <span class="c"># Function _simple executed.</span>
<span class="nb">echo</span> <span class="nv">$t</span>                                 <span class="c"># Note the Append-To action.</span>

<span class="c"># Exercise: clean up that example.</span>
<span class="nb">unset </span>t
<span class="nb">unset </span>_decT
<span class="nv">VarSomething</span><span class="o">=</span>Literal

<span class="nb">echo</span>
<span class="nb">echo</span> <span class="s1">&#39;- - Test and Change - -&#39;</span>
<span class="nb">echo</span> <span class="s1">&#39;- Assignment if null reference -&#39;</span>
<span class="nb">echo</span> -n <span class="si">${</span><span class="nv">VarNull</span><span class="p">=</span><span class="s1">&#39;NotSet&#39;</span><span class="si">}</span><span class="s1">&#39; &#39;</span>          <span class="c"># NotSet NotSet</span>
<span class="nb">echo</span> <span class="si">${</span><span class="nv">VarNull</span><span class="si">}</span>
<span class="nb">unset </span>VarNull

<span class="nb">echo</span> <span class="s1">&#39;- Assignment if null reference -&#39;</span>
<span class="nb">echo</span> -n <span class="si">${</span><span class="nv">VarNull</span><span class="p">:=</span><span class="s1">&#39;NotSet&#39;</span><span class="si">}</span><span class="s1">&#39; &#39;</span>         <span class="c"># NotSet NotSet</span>
<span class="nb">echo</span> <span class="si">${</span><span class="nv">VarNull</span><span class="si">}</span>
<span class="nb">unset </span>VarNull

<span class="nb">echo</span> <span class="s1">&#39;- No assignment if null contents -&#39;</span>
<span class="nb">echo</span> -n <span class="si">${</span><span class="nv">VarEmpty</span><span class="p">=</span><span class="s1">&#39;Empty&#39;</span><span class="si">}</span><span class="s1">&#39; &#39;</span>          <span class="c"># Space only</span>
<span class="nb">echo</span> <span class="si">${</span><span class="nv">VarEmpty</span><span class="si">}</span>
<span class="nv">VarEmpty</span><span class="o">=</span><span class="s1">&#39;&#39;</span>

<span class="nb">echo</span> <span class="s1">&#39;- Assignment if null contents -&#39;</span>
<span class="nb">echo</span> -n <span class="si">${</span><span class="nv">VarEmpty</span><span class="p">:=</span><span class="s1">&#39;Empty&#39;</span><span class="si">}</span><span class="s1">&#39; &#39;</span>         <span class="c"># Empty Empty</span>
<span class="nb">echo</span> <span class="si">${</span><span class="nv">VarEmpty</span><span class="si">}</span>
<span class="nv">VarEmpty</span><span class="o">=</span><span class="s1">&#39;&#39;</span>

<span class="nb">echo</span> <span class="s1">&#39;- No change if already has contents -&#39;</span>
<span class="nb">echo</span> <span class="si">${</span><span class="nv">VarSomething</span><span class="p">=</span><span class="s1">&#39;Content&#39;</span><span class="si">}</span>          <span class="c"># Literal</span>
<span class="nb">echo</span> <span class="si">${</span><span class="nv">VarSomething</span><span class="p">:=</span><span class="s1">&#39;Content&#39;</span><span class="si">}</span>         <span class="c"># Literal</span>


<span class="c"># &quot;Subscript sparse&quot; Bash-Arrays</span>
<span class="c">###</span>
<span class="c">#  Bash-Arrays are subscript packed, beginning with</span>
<span class="c">#+ subscript zero unless otherwise specified.</span>
<span class="c">###</span>
<span class="c">#  The initialization of ArrayVar was one way</span>
<span class="c">#+ to &quot;otherwise specify&quot;.  Here is the other way:</span>
<span class="c">###</span>
<span class="nb">echo</span>
<span class="nb">declare</span> -a ArraySparse
<span class="nv">ArraySparse</span><span class="o">=(</span> <span class="o">[</span>1<span class="o">]=</span>one <span class="o">[</span>2<span class="o">]=</span><span class="s1">&#39;&#39;</span> <span class="o">[</span>4<span class="o">]=</span><span class="s1">&#39;four&#39;</span> <span class="o">)</span>
<span class="c"># [0]=null reference, [2]=null content, [3]=null reference</span>

<span class="nb">echo</span> <span class="s1">&#39;- - Array-Sparse List - -&#39;</span>
<span class="c"># Within double-quotes, default IFS, Glob-Pattern</span>

<span class="nv">IFS</span><span class="o">=</span><span class="s1">$&#39;\x20&#39;$&#39;\x09&#39;$&#39;\x0A&#39;</span>
<span class="nb">printf</span> %q <span class="s2">&quot;</span><span class="si">${</span><span class="nv">ArraySparse</span><span class="p">[*]</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="nb">echo</span>

<span class="c">#  Note that the output does not distinguish between &quot;null content&quot;</span>
<span class="c">#+ and &quot;null reference&quot;.</span>
<span class="c">#  Both print as escaped whitespace.</span>
<span class="c">###</span>
<span class="c">#  Note also that the output does NOT contain escaped whitespace</span>
<span class="c">#+ for the &quot;null reference(s)&quot; prior to the first defined element.</span>
<span class="c">###</span>
<span class="c"># This behavior of 2.04, 2.05a and 2.05b has been reported</span>
<span class="c">#+ and may change in a future version of Bash.</span>

<span class="c">#  To output a sparse array and maintain the [subscript]=value</span>
<span class="c">#+ relationship without change requires a bit of programming.</span>
<span class="c">#  One possible code fragment:</span>
<span class="c">###</span>
<span class="c"># local l=${#ArraySparse[@]}        # Count of defined elements</span>
<span class="c"># local f=0                         # Count of found subscripts</span>
<span class="c"># local i=0                         # Subscript to test</span>
<span class="o">(</span>                                   <span class="c"># Anonymous in-line function</span>
    <span class="k">for</span> <span class="o">((</span> <span class="nv">l</span><span class="o">=</span><span class="si">${#</span><span class="nv">ArraySparse</span><span class="p">[@]</span><span class="si">}</span>, <span class="nv">f</span> <span class="o">=</span> 0, <span class="nv">i</span> <span class="o">=</span> <span class="m">0</span> <span class="p">;</span> f &lt; l <span class="p">;</span> i++ <span class="o">))</span>
    <span class="k">do</span>
        <span class="c"># &#39;if defined then...&#39;</span>
        <span class="si">${</span><span class="nv">ArraySparse</span><span class="p">[</span><span class="nv">$i</span><span class="p">]+ eval echo </span><span class="s1">&#39;\ [&#39;</span><span class="nv">$i</span><span class="s1">&#39;]=&#39;</span><span class="si">${</span><span class="nv">ArraySparse</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span><span class="si">}</span><span class="p"> ; (( f++ )) </span><span class="si">}</span>
    <span class="k">done</span>
<span class="o">)</span>

<span class="c"># The reader coming upon the above code fragment cold</span>
<span class="c">#+ might want to review &quot;command lists&quot; and &quot;multiple commands on a line&quot;</span>
<span class="c">#+ in the text of the foregoing &quot;Advanced Bash Scripting Guide.&quot;</span>
<span class="c">###</span>
<span class="c">#  Note:</span>
<span class="c">#  The &quot;read -a array_name&quot; version of the &quot;read&quot; command</span>
<span class="c">#+ begins filling array_name at subscript zero.</span>
<span class="c">#  ArraySparse does not define a value at subscript zero.</span>
<span class="c">###</span>
<span class="c">#  The user needing to read/write a sparse array to either</span>
<span class="c">#+ external storage or a communications socket must invent</span>
<span class="c">#+ a read/write code pair suitable for their purpose.</span>
<span class="c">###</span>
<span class="c"># Exercise: clean it up.</span>

<span class="nb">unset </span>ArraySparse

<span class="nb">echo</span>
<span class="nb">echo</span> <span class="s1">&#39;- - Conditional alternate (But not change)- -&#39;</span>
<span class="nb">echo</span> <span class="s1">&#39;- No alternate if null reference -&#39;</span>
<span class="nb">echo</span> -n <span class="si">${</span><span class="nv">VarNull</span><span class="p">+</span><span class="s1">&#39;NotSet&#39;</span><span class="si">}</span><span class="s1">&#39; &#39;</span>
<span class="nb">echo</span> <span class="si">${</span><span class="nv">VarNull</span><span class="si">}</span>
<span class="nb">unset </span>VarNull

<span class="nb">echo</span> <span class="s1">&#39;- No alternate if null reference -&#39;</span>
<span class="nb">echo</span> -n <span class="si">${</span><span class="nv">VarNull</span><span class="p">:+</span><span class="s1">&#39;NotSet&#39;</span><span class="si">}</span><span class="s1">&#39; &#39;</span>
<span class="nb">echo</span> <span class="si">${</span><span class="nv">VarNull</span><span class="si">}</span>
<span class="nb">unset </span>VarNull

<span class="nb">echo</span> <span class="s1">&#39;- Alternate if null contents -&#39;</span>
<span class="nb">echo</span> -n <span class="si">${</span><span class="nv">VarEmpty</span><span class="p">+</span><span class="s1">&#39;Empty&#39;</span><span class="si">}</span><span class="s1">&#39; &#39;</span>              <span class="c"># Empty</span>
<span class="nb">echo</span> <span class="si">${</span><span class="nv">VarEmpty</span><span class="si">}</span>
<span class="nv">VarEmpty</span><span class="o">=</span><span class="s1">&#39;&#39;</span>

<span class="nb">echo</span> <span class="s1">&#39;- No alternate if null contents -&#39;</span>
<span class="nb">echo</span> -n <span class="si">${</span><span class="nv">VarEmpty</span><span class="p">:+</span><span class="s1">&#39;Empty&#39;</span><span class="si">}</span><span class="s1">&#39; &#39;</span>             <span class="c"># Space only</span>
<span class="nb">echo</span> <span class="si">${</span><span class="nv">VarEmpty</span><span class="si">}</span>
<span class="nv">VarEmpty</span><span class="o">=</span><span class="s1">&#39;&#39;</span>

<span class="nb">echo</span> <span class="s1">&#39;- Alternate if already has contents -&#39;</span>

<span class="c"># Alternate literal</span>
<span class="nb">echo</span> -n <span class="si">${</span><span class="nv">VarSomething</span><span class="p">+</span><span class="s1">&#39;Content&#39;</span><span class="si">}</span><span class="s1">&#39; &#39;</span>        <span class="c"># Content Literal</span>
<span class="nb">echo</span> <span class="si">${</span><span class="nv">VarSomething</span><span class="si">}</span>

<span class="c"># Invoke function</span>
<span class="nb">echo</span> -n <span class="si">${</span><span class="nv">VarSomething</span><span class="p">:+ </span><span class="k">$(</span>_simple<span class="k">)</span><span class="p"> </span><span class="si">}</span><span class="s1">&#39; &#39;</span>    <span class="c"># SimpleFunc Literal</span>
<span class="nb">echo</span> <span class="si">${</span><span class="nv">VarSomething</span><span class="si">}</span>
<span class="nb">echo</span>

<span class="nb">echo</span> <span class="s1">&#39;- - Sparse Array - -&#39;</span>
<span class="nb">echo</span> <span class="si">${</span><span class="nv">ArrayVar</span><span class="p">[@]+</span><span class="s1">&#39;Empty&#39;</span><span class="si">}</span>                 <span class="c"># An array of &#39;Empty&#39;(ies)</span>
<span class="nb">echo</span>

<span class="nb">echo</span> <span class="s1">&#39;- - Test 2 for undefined - -&#39;</span>

<span class="nb">declare</span> -i t
_incT<span class="o">()</span> <span class="o">{</span>
    <span class="nv">t</span><span class="o">=</span><span class="nv">$t</span>+1
<span class="o">}</span>

<span class="c">#  Note:</span>
<span class="c">#  This is the same test used in the sparse array</span>
<span class="c">#+ listing code fragment.</span>

<span class="c"># Null reference, set: t == -1</span>
<span class="nv">t</span><span class="o">=</span><span class="si">${#</span><span class="nv">VarNull</span><span class="si">}</span>-1                     <span class="c"># Results in minus-one.</span>
<span class="si">${</span><span class="nv">VarNull</span><span class="p">+ _incT </span><span class="si">}</span>                  <span class="c"># Does not execute.</span>
<span class="nb">echo</span> <span class="nv">$t</span><span class="s1">&#39; Null reference&#39;</span>

<span class="c"># Null contents, set: t == 0</span>
<span class="nv">t</span><span class="o">=</span><span class="si">${#</span><span class="nv">VarEmpty</span><span class="si">}</span>-1                    <span class="c"># Results in minus-one.</span>
<span class="si">${</span><span class="nv">VarEmpty</span><span class="p">+ _incT </span><span class="si">}</span>                 <span class="c"># Executes.</span>
<span class="nb">echo</span> <span class="nv">$t</span><span class="s1">&#39;  Null content&#39;</span>

<span class="c"># Contents, set: t == (number of non-null characters)</span>
<span class="nv">t</span><span class="o">=</span><span class="si">${#</span><span class="nv">VarSomething</span><span class="si">}</span>-1                <span class="c"># non-null length minus-one</span>
<span class="si">${</span><span class="nv">VarSomething</span><span class="p">+ _incT </span><span class="si">}</span>             <span class="c"># Executes.</span>
<span class="nb">echo</span> <span class="nv">$t</span><span class="s1">&#39;  Contents&#39;</span>

<span class="c"># Exercise: clean up that example.</span>
<span class="nb">unset </span>t
<span class="nb">unset </span>_incT

<span class="c"># ${name?err_msg} ${name:?err_msg}</span>
<span class="c">#  These follow the same rules but always exit afterwards</span>
<span class="c">#+ if an action is specified following the question mark.</span>
<span class="c">#  The action following the question mark may be a literal</span>
<span class="c">#+ or a function result.</span>
<span class="c">###</span>
<span class="c">#  ${name?} ${name:?} are test-only, the return can be tested.</span>




<span class="c"># Element operations</span>
<span class="c"># ------------------</span>

<span class="nb">echo</span>
<span class="nb">echo</span> <span class="s1">&#39;- - Trailing sub-element selection - -&#39;</span>

<span class="c">#  Strings, Arrays and Positional parameters</span>

<span class="c">#  Call this script with multiple arguments</span>
<span class="c">#+ to see the parameter selections.</span>

<span class="nb">echo</span> <span class="s1">&#39;- All -&#39;</span>
<span class="nb">echo</span> <span class="si">${</span><span class="nv">VarSomething</span><span class="p">:</span><span class="nv">0</span><span class="si">}</span>              <span class="c"># all non-null characters</span>
<span class="nb">echo</span> <span class="si">${</span><span class="nv">ArrayVar</span><span class="p">[@]:</span><span class="nv">0</span><span class="si">}</span>               <span class="c"># all elements with content</span>
<span class="nb">echo</span> <span class="si">${</span><span class="p">@:</span><span class="nv">0</span><span class="si">}</span>                         <span class="c"># all parameters with content;</span>
                                    <span class="c"># ignoring parameter[0]</span>

<span class="nb">echo</span>
<span class="nb">echo</span> <span class="s1">&#39;- All after -&#39;</span>
<span class="nb">echo</span> <span class="si">${</span><span class="nv">VarSomething</span><span class="p">:</span><span class="nv">1</span><span class="si">}</span>              <span class="c"># all non-null after character[0]</span>
<span class="nb">echo</span> <span class="si">${</span><span class="nv">ArrayVar</span><span class="p">[@]:</span><span class="nv">1</span><span class="si">}</span>               <span class="c"># all after element[0] with content</span>
<span class="nb">echo</span> <span class="si">${</span><span class="p">@:</span><span class="nv">2</span><span class="si">}</span>                         <span class="c"># all after param[1] with content</span>

<span class="nb">echo</span>
<span class="nb">echo</span> <span class="s1">&#39;- Range after -&#39;</span>
<span class="nb">echo</span> <span class="si">${</span><span class="nv">VarSomething</span><span class="p">:</span><span class="nv">4</span><span class="p">:</span><span class="nv">3</span><span class="si">}</span>            <span class="c"># ral</span>
                                    <span class="c"># Three characters after</span>
                                    <span class="c"># character[3]</span>

<span class="nb">echo</span> <span class="s1">&#39;- Sparse array gotch -&#39;</span>
<span class="nb">echo</span> <span class="si">${</span><span class="nv">ArrayVar</span><span class="p">[@]:</span><span class="nv">1</span><span class="p">:</span><span class="nv">2</span><span class="si">}</span>     <span class="c">#  four - The only element with content.</span>
                            <span class="c">#  Two elements after (if that many exist).</span>
                            <span class="c">#  the FIRST WITH CONTENTS</span>
                            <span class="c">#+ (the FIRST WITH  CONTENTS is being</span>
                            <span class="c">#+ considered as if it</span>
                            <span class="c">#+ were subscript zero).</span>
<span class="c">#  Executed as if Bash considers ONLY array elements with CONTENT</span>
<span class="c">#  printf %q &quot;${ArrayVar[@]:0:3}&quot;    # Try this one</span>

<span class="c">#  In versions 2.04, 2.05a and 2.05b,</span>
<span class="c">#+ Bash does not handle sparse arrays as expected using this notation.</span>
<span class="c">#</span>
<span class="c">#  The current Bash maintainer, Chet Ramey, has corrected this.</span>


<span class="nb">echo</span> <span class="s1">&#39;- Non-sparse array -&#39;</span>
<span class="nb">echo</span> <span class="si">${</span><span class="p">@:</span><span class="nv">2</span><span class="p">:</span><span class="nv">2</span><span class="si">}</span>               <span class="c"># Two parameters following parameter[1]</span>

<span class="c"># New victims for string vector examples:</span>
<span class="nv">stringZ</span><span class="o">=</span>abcABC123ABCabc
<span class="nv">arrayZ</span><span class="o">=(</span> abcabc ABCABC <span class="m">123123</span> ABCABC abcabc <span class="o">)</span>
<span class="nv">sparseZ</span><span class="o">=(</span> <span class="o">[</span>1<span class="o">]=</span><span class="s1">&#39;abcabc&#39;</span> <span class="o">[</span>3<span class="o">]=</span><span class="s1">&#39;ABCABC&#39;</span> <span class="o">[</span>4<span class="o">]=</span><span class="s1">&#39;&#39;</span> <span class="o">[</span>5<span class="o">]=</span><span class="s1">&#39;123123&#39;</span> <span class="o">)</span>

<span class="nb">echo</span>
<span class="nb">echo</span> <span class="s1">&#39; - - Victim string - -&#39;</span><span class="nv">$stringZ</span><span class="s1">&#39;- - &#39;</span>
<span class="nb">echo</span> <span class="s1">&#39; - - Victim array - -&#39;</span><span class="si">${</span><span class="nv">arrayZ</span><span class="p">[@]</span><span class="si">}</span><span class="s1">&#39;- - &#39;</span>
<span class="nb">echo</span> <span class="s1">&#39; - - Sparse array - -&#39;</span><span class="si">${</span><span class="nv">sparseZ</span><span class="p">[@]</span><span class="si">}</span><span class="s1">&#39;- - &#39;</span>
<span class="nb">echo</span> <span class="s1">&#39; - [0]==null ref, [2]==null ref, [4]==null content - &#39;</span>
<span class="nb">echo</span> <span class="s1">&#39; - [1]=abcabc [3]=ABCABC [5]=123123 - &#39;</span>
<span class="nb">echo</span> <span class="s1">&#39; - non-null-reference count: &#39;</span><span class="si">${#</span><span class="nv">sparseZ</span><span class="p">[@]</span><span class="si">}</span><span class="s1">&#39; elements&#39;</span>

<span class="nb">echo</span>
<span class="nb">echo</span> <span class="s1">&#39;- - Prefix sub-element removal - -&#39;</span>
<span class="nb">echo</span> <span class="s1">&#39;- - Glob-Pattern match must include the first character. - -&#39;</span>
<span class="nb">echo</span> <span class="s1">&#39;- - Glob-Pattern may be a literal or a function result. - -&#39;</span>
<span class="nb">echo</span>


<span class="c"># Function returning a simple, Literal, Glob-Pattern</span>
_abc<span class="o">()</span> <span class="o">{</span>
    <span class="nb">echo</span> -n <span class="s1">&#39;abc&#39;</span>
<span class="o">}</span>

<span class="nb">echo</span> <span class="s1">&#39;- Shortest prefix -&#39;</span>
<span class="nb">echo</span> <span class="si">${</span><span class="nv">stringZ</span><span class="p">#123</span><span class="si">}</span>                 <span class="c"># Unchanged (not a prefix).</span>
<span class="nb">echo</span> <span class="si">${</span><span class="nv">stringZ</span><span class="p">#</span><span class="k">$(</span>_abc<span class="k">)</span><span class="si">}</span>             <span class="c"># ABC123ABCabc</span>
<span class="nb">echo</span> <span class="si">${</span><span class="nv">arrayZ</span><span class="p">[@]#abc</span><span class="si">}</span>               <span class="c"># Applied to each element.</span>

<span class="c"># echo ${sparseZ[@]#abc}            # Version-2.05b core dumps.</span>
<span class="c"># Has since been fixed by Chet Ramey.</span>

<span class="c"># The -it would be nice- First-Subscript-Of</span>
<span class="c"># echo ${#sparseZ[@]#*}             # This is NOT valid Bash.</span>

<span class="nb">echo</span>
<span class="nb">echo</span> <span class="s1">&#39;- Longest prefix -&#39;</span>
<span class="nb">echo</span> <span class="si">${</span><span class="nv">stringZ</span><span class="p">##1*3</span><span class="si">}</span>                <span class="c"># Unchanged (not a prefix)</span>
<span class="nb">echo</span> <span class="si">${</span><span class="nv">stringZ</span><span class="p">##a*C</span><span class="si">}</span>                <span class="c"># abc</span>
<span class="nb">echo</span> <span class="si">${</span><span class="nv">arrayZ</span><span class="p">[@]##a*c</span><span class="si">}</span>              <span class="c"># ABCABC 123123 ABCABC</span>

<span class="c"># echo ${sparseZ[@]##a*c}           # Version-2.05b core dumps.</span>
<span class="c"># Has since been fixed by Chet Ramey.</span>

<span class="nb">echo</span>
<span class="nb">echo</span> <span class="s1">&#39;- - Suffix sub-element removal - -&#39;</span>
<span class="nb">echo</span> <span class="s1">&#39;- - Glob-Pattern match must include the last character. - -&#39;</span>
<span class="nb">echo</span> <span class="s1">&#39;- - Glob-Pattern may be a literal or a function result. - -&#39;</span>
<span class="nb">echo</span>
<span class="nb">echo</span> <span class="s1">&#39;- Shortest suffix -&#39;</span>
<span class="nb">echo</span> <span class="si">${</span><span class="nv">stringZ</span><span class="p">%1*3</span><span class="si">}</span>                 <span class="c"># Unchanged (not a suffix).</span>
<span class="nb">echo</span> <span class="si">${</span><span class="nv">stringZ</span><span class="p">%</span><span class="k">$(</span>_abc<span class="k">)</span><span class="si">}</span>             <span class="c"># abcABC123ABC</span>
<span class="nb">echo</span> <span class="si">${</span><span class="nv">arrayZ</span><span class="p">[@]%abc</span><span class="si">}</span>               <span class="c"># Applied to each element.</span>

<span class="c"># echo ${sparseZ[@]%abc}            # Version-2.05b core dumps.</span>
<span class="c"># Has since been fixed by Chet Ramey.</span>

<span class="c"># The -it would be nice- Last-Subscript-Of</span>
<span class="c"># echo ${#sparseZ[@]%*}             # This is NOT valid Bash.</span>

<span class="nb">echo</span>
<span class="nb">echo</span> <span class="s1">&#39;- Longest suffix -&#39;</span>
<span class="nb">echo</span> <span class="si">${</span><span class="nv">stringZ</span><span class="p">%%1*3</span><span class="si">}</span>                <span class="c"># Unchanged (not a suffix)</span>
<span class="nb">echo</span> <span class="si">${</span><span class="nv">stringZ</span><span class="p">%%b*c</span><span class="si">}</span>                <span class="c"># a</span>
<span class="nb">echo</span> <span class="si">${</span><span class="nv">arrayZ</span><span class="p">[@]%%b*c</span><span class="si">}</span>              <span class="c"># a ABCABC 123123 ABCABC a</span>

<span class="c"># echo ${sparseZ[@]%%b*c}           # Version-2.05b core dumps.</span>
<span class="c"># Has since been fixed by Chet Ramey.</span>

<span class="nb">echo</span>
<span class="nb">echo</span> <span class="s1">&#39;- - Sub-element replacement - -&#39;</span>
<span class="nb">echo</span> <span class="s1">&#39;- - Sub-element at any location in string. - -&#39;</span>
<span class="nb">echo</span> <span class="s1">&#39;- - First specification is a Glob-Pattern - -&#39;</span>
<span class="nb">echo</span> <span class="s1">&#39;- - Glob-Pattern may be a literal or Glob-Pattern function result. - -&#39;</span>
<span class="nb">echo</span> <span class="s1">&#39;- - Second specification may be a literal or function result. - -&#39;</span>
<span class="nb">echo</span> <span class="s1">&#39;- - Second specification may be unspecified. Pronounce that&#39;</span>
<span class="nb">echo</span> <span class="s1">&#39;    as: Replace-With-Nothing (Delete) - -&#39;</span>
<span class="nb">echo</span>



<span class="c"># Function returning a simple, Literal, Glob-Pattern</span>
_123<span class="o">()</span> <span class="o">{</span>
    <span class="nb">echo</span> -n <span class="s1">&#39;123&#39;</span>
<span class="o">}</span>

<span class="nb">echo</span> <span class="s1">&#39;- Replace first occurrence -&#39;</span>
<span class="nb">echo</span> <span class="si">${</span><span class="nv">stringZ</span><span class="p">/</span><span class="k">$(</span>_123<span class="k">)</span><span class="p">/999</span><span class="si">}</span>         <span class="c"># Changed (123 is a component).</span>
<span class="nb">echo</span> <span class="si">${</span><span class="nv">stringZ</span><span class="p">/ABC/xyz</span><span class="si">}</span>             <span class="c"># xyzABC123ABCabc</span>
<span class="nb">echo</span> <span class="si">${</span><span class="nv">arrayZ</span><span class="p">[@]/ABC/xyz</span><span class="si">}</span>           <span class="c"># Applied to each element.</span>
<span class="nb">echo</span> <span class="si">${</span><span class="nv">sparseZ</span><span class="p">[@]/ABC/xyz</span><span class="si">}</span>          <span class="c"># Works as expected.</span>

<span class="nb">echo</span>
<span class="nb">echo</span> <span class="s1">&#39;- Delete first occurrence -&#39;</span>
<span class="nb">echo</span> <span class="si">${</span><span class="nv">stringZ</span><span class="p">/</span><span class="k">$(</span>_123<span class="k">)</span><span class="p">/</span><span class="si">}</span>
<span class="nb">echo</span> <span class="si">${</span><span class="nv">stringZ</span><span class="p">/ABC/</span><span class="si">}</span>
<span class="nb">echo</span> <span class="si">${</span><span class="nv">arrayZ</span><span class="p">[@]/ABC/</span><span class="si">}</span>
<span class="nb">echo</span> <span class="si">${</span><span class="nv">sparseZ</span><span class="p">[@]/ABC/</span><span class="si">}</span>

<span class="c">#  The replacement need not be a literal,</span>
<span class="c">#+ since the result of a function invocation is allowed.</span>
<span class="c">#  This is general to all forms of replacement.</span>
<span class="nb">echo</span>
<span class="nb">echo</span> <span class="s1">&#39;- Replace first occurrence with Result-Of -&#39;</span>
<span class="nb">echo</span> <span class="si">${</span><span class="nv">stringZ</span><span class="p">/</span><span class="k">$(</span>_123<span class="k">)</span><span class="p">/</span><span class="k">$(</span>_simple<span class="k">)</span><span class="si">}</span>  <span class="c"># Works as expected.</span>
<span class="nb">echo</span> <span class="si">${</span><span class="nv">arrayZ</span><span class="p">[@]/ca/</span><span class="k">$(</span>_simple<span class="k">)</span><span class="si">}</span>     <span class="c"># Applied to each element.</span>
<span class="nb">echo</span> <span class="si">${</span><span class="nv">sparseZ</span><span class="p">[@]/ca/</span><span class="k">$(</span>_simple<span class="k">)</span><span class="si">}</span>    <span class="c"># Works as expected.</span>

<span class="nb">echo</span>
<span class="nb">echo</span> <span class="s1">&#39;- Replace all occurrences -&#39;</span>
<span class="nb">echo</span> <span class="si">${</span><span class="nv">stringZ</span><span class="p">//[b2]/X</span><span class="si">}</span>             <span class="c"># X-out b&#39;s and 2&#39;s</span>
<span class="nb">echo</span> <span class="si">${</span><span class="nv">stringZ</span><span class="p">//abc/xyz</span><span class="si">}</span>            <span class="c"># xyzABC123ABCxyz</span>
<span class="nb">echo</span> <span class="si">${</span><span class="nv">arrayZ</span><span class="p">[@]//abc/xyz</span><span class="si">}</span>          <span class="c"># Applied to each element.</span>
<span class="nb">echo</span> <span class="si">${</span><span class="nv">sparseZ</span><span class="p">[@]//abc/xyz</span><span class="si">}</span>         <span class="c"># Works as expected.</span>

<span class="nb">echo</span>
<span class="nb">echo</span> <span class="s1">&#39;- Delete all occurrences -&#39;</span>
<span class="nb">echo</span> <span class="si">${</span><span class="nv">stringZ</span><span class="p">//[b2]/</span><span class="si">}</span>
<span class="nb">echo</span> <span class="si">${</span><span class="nv">stringZ</span><span class="p">//abc/</span><span class="si">}</span>
<span class="nb">echo</span> <span class="si">${</span><span class="nv">arrayZ</span><span class="p">[@]//abc/</span><span class="si">}</span>
<span class="nb">echo</span> <span class="si">${</span><span class="nv">sparseZ</span><span class="p">[@]//abc/</span><span class="si">}</span>

<span class="nb">echo</span>
<span class="nb">echo</span> <span class="s1">&#39;- - Prefix sub-element replacement - -&#39;</span>
<span class="nb">echo</span> <span class="s1">&#39;- - Match must include the first character. - -&#39;</span>
<span class="nb">echo</span>

<span class="nb">echo</span> <span class="s1">&#39;- Replace prefix occurrences -&#39;</span>
<span class="nb">echo</span> <span class="si">${</span><span class="nv">stringZ</span><span class="p">/#[b2]/X</span><span class="si">}</span>             <span class="c"># Unchanged (neither is a prefix).</span>
<span class="nb">echo</span> <span class="si">${</span><span class="nv">stringZ</span><span class="p">/#</span><span class="k">$(</span>_abc<span class="k">)</span><span class="p">/XYZ</span><span class="si">}</span>        <span class="c"># XYZABC123ABCabc</span>
<span class="nb">echo</span> <span class="si">${</span><span class="nv">arrayZ</span><span class="p">[@]/#abc/XYZ</span><span class="si">}</span>          <span class="c"># Applied to each element.</span>
<span class="nb">echo</span> <span class="si">${</span><span class="nv">sparseZ</span><span class="p">[@]/#abc/XYZ</span><span class="si">}</span>         <span class="c"># Works as expected.</span>

<span class="nb">echo</span>
<span class="nb">echo</span> <span class="s1">&#39;- Delete prefix occurrences -&#39;</span>
<span class="nb">echo</span> <span class="si">${</span><span class="nv">stringZ</span><span class="p">/#[b2]/</span><span class="si">}</span>
<span class="nb">echo</span> <span class="si">${</span><span class="nv">stringZ</span><span class="p">/#</span><span class="k">$(</span>_abc<span class="k">)</span><span class="p">/</span><span class="si">}</span>
<span class="nb">echo</span> <span class="si">${</span><span class="nv">arrayZ</span><span class="p">[@]/#abc/</span><span class="si">}</span>
<span class="nb">echo</span> <span class="si">${</span><span class="nv">sparseZ</span><span class="p">[@]/#abc/</span><span class="si">}</span>

<span class="nb">echo</span>
<span class="nb">echo</span> <span class="s1">&#39;- - Suffix sub-element replacement - -&#39;</span>
<span class="nb">echo</span> <span class="s1">&#39;- - Match must include the last character. - -&#39;</span>
<span class="nb">echo</span>

<span class="nb">echo</span> <span class="s1">&#39;- Replace suffix occurrences -&#39;</span>
<span class="nb">echo</span> <span class="si">${</span><span class="nv">stringZ</span><span class="p">/%[b2]/X</span><span class="si">}</span>             <span class="c"># Unchanged (neither is a suffix).</span>
<span class="nb">echo</span> <span class="si">${</span><span class="nv">stringZ</span><span class="p">/%</span><span class="k">$(</span>_abc<span class="k">)</span><span class="p">/XYZ</span><span class="si">}</span>        <span class="c"># abcABC123ABCXYZ</span>
<span class="nb">echo</span> <span class="si">${</span><span class="nv">arrayZ</span><span class="p">[@]/%abc/XYZ</span><span class="si">}</span>          <span class="c"># Applied to each element.</span>
<span class="nb">echo</span> <span class="si">${</span><span class="nv">sparseZ</span><span class="p">[@]/%abc/XYZ</span><span class="si">}</span>         <span class="c"># Works as expected.</span>

<span class="nb">echo</span>
<span class="nb">echo</span> <span class="s1">&#39;- Delete suffix occurrences -&#39;</span>
<span class="nb">echo</span> <span class="si">${</span><span class="nv">stringZ</span><span class="p">/%[b2]/</span><span class="si">}</span>
<span class="nb">echo</span> <span class="si">${</span><span class="nv">stringZ</span><span class="p">/%</span><span class="k">$(</span>_abc<span class="k">)</span><span class="p">/</span><span class="si">}</span>
<span class="nb">echo</span> <span class="si">${</span><span class="nv">arrayZ</span><span class="p">[@]/%abc/</span><span class="si">}</span>
<span class="nb">echo</span> <span class="si">${</span><span class="nv">sparseZ</span><span class="p">[@]/%abc/</span><span class="si">}</span>

<span class="nb">echo</span>
<span class="nb">echo</span> <span class="s1">&#39;- - Special cases of null Glob-Pattern - -&#39;</span>
<span class="nb">echo</span>

<span class="nb">echo</span> <span class="s1">&#39;- Prefix all -&#39;</span>
<span class="c"># null substring pattern means &#39;prefix&#39;</span>
<span class="nb">echo</span> <span class="si">${</span><span class="nv">stringZ</span><span class="p">/#/NEW</span><span class="si">}</span>               <span class="c"># NEWabcABC123ABCabc</span>
<span class="nb">echo</span> <span class="si">${</span><span class="nv">arrayZ</span><span class="p">[@]/#/NEW</span><span class="si">}</span>             <span class="c"># Applied to each element.</span>
<span class="nb">echo</span> <span class="si">${</span><span class="nv">sparseZ</span><span class="p">[@]/#/NEW</span><span class="si">}</span>            <span class="c"># Applied to null-content also.</span>
                                    <span class="c"># That seems reasonable.</span>

<span class="nb">echo</span>
<span class="nb">echo</span> <span class="s1">&#39;- Suffix all -&#39;</span>
<span class="c"># null substring pattern means &#39;suffix&#39;</span>
<span class="nb">echo</span> <span class="si">${</span><span class="nv">stringZ</span><span class="p">/%/NEW</span><span class="si">}</span>               <span class="c"># abcABC123ABCabcNEW</span>
<span class="nb">echo</span> <span class="si">${</span><span class="nv">arrayZ</span><span class="p">[@]/%/NEW</span><span class="si">}</span>             <span class="c"># Applied to each element.</span>
<span class="nb">echo</span> <span class="si">${</span><span class="nv">sparseZ</span><span class="p">[@]/%/NEW</span><span class="si">}</span>            <span class="c"># Applied to null-content also.</span>
                                    <span class="c"># That seems reasonable.</span>

<span class="nb">echo</span>
<span class="nb">echo</span> <span class="s1">&#39;- - Special case For-Each Glob-Pattern - -&#39;</span>
<span class="nb">echo</span> <span class="s1">&#39;- - - - This is a nice-to-have dream - - - -&#39;</span>
<span class="nb">echo</span>

_GenFunc<span class="o">()</span> <span class="o">{</span>
    <span class="nb">echo</span> -n <span class="si">${</span><span class="nv">0</span><span class="si">}</span>                    <span class="c"># Illustration only.</span>
    <span class="c"># Actually, that would be an arbitrary computation.</span>
<span class="o">}</span>

<span class="c"># All occurrences, matching the AnyThing pattern.</span>
<span class="c"># Currently //*/ does not match null-content nor null-reference.</span>
<span class="c"># /#/ and /%/ does match null-content but not null-reference.</span>
<span class="nb">echo</span> <span class="si">${</span><span class="nv">sparseZ</span><span class="p">[@]//*/</span><span class="k">$(</span>_GenFunc<span class="k">)</span><span class="si">}</span>


<span class="c">#  A possible syntax would be to make</span>
<span class="c">#+ the parameter notation used within this construct mean:</span>
<span class="c">#   ${1} - The full element</span>
<span class="c">#   ${2} - The prefix, if any, to the matched sub-element</span>
<span class="c">#   ${3} - The matched sub-element</span>
<span class="c">#   ${4} - The suffix, if any, to the matched sub-element</span>
<span class="c">#</span>
<span class="c"># echo ${sparseZ[@]//*/$(_GenFunc ${3})}   # Same as ${1} here.</span>
<span class="c"># Perhaps it will be implemented in a future version of Bash.</span>


<span class="nb">exit </span>0
</pre></div>
</div>
</div>
<div class="section" id="exemple-59-testing-execution-times-of-various-commands">
<h2>Exemple 59. Testing execution times of various commands<a class="headerlink" href="#exemple-59-testing-execution-times-of-various-commands" title="Link permanent a aquest títol">¶</a></h2>
<div class="highlight-sh"><div class="highlight"><pre><span class="c">#!/bin/bash</span>
<span class="c">#  test-execution-time.sh</span>
<span class="c">#  Example by Erik Brandsberg, for testing execution time</span>
<span class="c">#+ of certain operations.</span>
<span class="c">#  Referenced in the &quot;Optimizations&quot; section of &quot;Miscellany&quot; chapter.</span>

<span class="nv">count</span><span class="o">=</span>50000
<span class="nb">echo</span> <span class="s2">&quot;Math tests&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;Math via \$(( ))&quot;</span>
<span class="nb">time </span><span class="k">for</span> <span class="o">((</span> <span class="nv">i</span><span class="o">=</span>0<span class="p">;</span> i&lt; <span class="nv">$count</span><span class="p">;</span> i++<span class="o">))</span>
<span class="k">do</span>
  <span class="nv">result</span><span class="o">=</span><span class="k">$((</span> <span class="nv">$i</span><span class="o">%</span><span class="m">2</span> <span class="k">))</span>
<span class="k">done</span>

<span class="nb">echo</span> <span class="s2">&quot;Math via *expr*:&quot;</span>
<span class="nb">time </span><span class="k">for</span> <span class="o">((</span> <span class="nv">i</span><span class="o">=</span>0<span class="p">;</span> i&lt; <span class="nv">$count</span><span class="p">;</span> i++<span class="o">))</span>
<span class="k">do</span>
  <span class="nv">result</span><span class="o">=</span><span class="sb">`</span>expr <span class="s2">&quot;</span><span class="nv">$i</span><span class="s2">%2&quot;</span><span class="sb">`</span>
<span class="k">done</span>

<span class="nb">echo</span> <span class="s2">&quot;Math via *let*:&quot;</span>
<span class="nb">time </span><span class="k">for</span> <span class="o">((</span> <span class="nv">i</span><span class="o">=</span>0<span class="p">;</span> i&lt; <span class="nv">$count</span><span class="p">;</span> i++<span class="o">))</span>
<span class="k">do</span>
  <span class="nb">let </span><span class="nv">result</span><span class="o">=</span><span class="nv">$i</span>%2
<span class="k">done</span>

<span class="nb">echo</span>
<span class="nb">echo</span> <span class="s2">&quot;Conditional testing tests&quot;</span>

<span class="nb">echo</span> <span class="s2">&quot;Test via case:&quot;</span>
<span class="nb">time </span><span class="k">for</span> <span class="o">((</span> <span class="nv">i</span><span class="o">=</span>0<span class="p">;</span> i&lt; <span class="nv">$count</span><span class="p">;</span> i++<span class="o">))</span>
<span class="k">do</span>
  <span class="k">case</span> <span class="k">$((</span> <span class="nv">$i</span><span class="o">%</span><span class="m">2</span> <span class="k">))</span> in
    0<span class="o">)</span> : <span class="p">;;</span>
    1<span class="o">)</span> : <span class="p">;;</span>
  <span class="k">esac</span>
<span class="k">done</span>

<span class="nb">echo</span> <span class="s2">&quot;Test with if [], no quotes:&quot;</span>
<span class="nb">time </span><span class="k">for</span> <span class="o">((</span> <span class="nv">i</span><span class="o">=</span>0<span class="p">;</span> i&lt; <span class="nv">$count</span><span class="p">;</span> i++<span class="o">))</span>
<span class="k">do</span>
  <span class="k">if</span> <span class="o">[</span> <span class="k">$((</span> <span class="nv">$i</span><span class="o">%</span><span class="m">2</span> <span class="k">))</span> <span class="o">=</span> <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
     :
  <span class="k">else</span>
     :
  <span class="k">fi</span>
<span class="k">done</span>

<span class="nb">echo</span> <span class="s2">&quot;Test with if [], quotes:&quot;</span>
<span class="nb">time </span><span class="k">for</span> <span class="o">((</span> <span class="nv">i</span><span class="o">=</span>0<span class="p">;</span> i&lt; <span class="nv">$count</span><span class="p">;</span> i++<span class="o">))</span>
<span class="k">do</span>
  <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="k">$((</span> <span class="nv">$i</span><span class="o">%</span><span class="m">2</span> <span class="k">))</span><span class="s2">&quot;</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
     :
  <span class="k">else</span>
     :
  <span class="k">fi</span>
<span class="k">done</span>

<span class="nb">echo</span> <span class="s2">&quot;Test with if [], using -eq:&quot;</span>
<span class="nb">time </span><span class="k">for</span> <span class="o">((</span> <span class="nv">i</span><span class="o">=</span>0<span class="p">;</span> i&lt; <span class="nv">$count</span><span class="p">;</span> i++<span class="o">))</span>
<span class="k">do</span>
  <span class="k">if</span> <span class="o">[</span> <span class="k">$((</span> <span class="nv">$i</span><span class="o">%</span><span class="m">2</span> <span class="k">))</span> -eq <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
     :
  <span class="k">else</span>
     :
  <span class="k">fi</span>
<span class="k">done</span>

<span class="nb">exit</span> <span class="nv">$?</span>
</pre></div>
</div>
</div>
<div class="section" id="exemple-60-associative-arrays-vs-conventional-arrays-execution-times">
<h2>Exemple 60. Associative arrays vs. conventional arrays (execution times)<a class="headerlink" href="#exemple-60-associative-arrays-vs-conventional-arrays-execution-times" title="Link permanent a aquest títol">¶</a></h2>
<div class="highlight-sh"><div class="highlight"><pre><span class="c">#!/bin/bash</span>
<span class="c">#  assoc-arr-test.sh</span>
<span class="c">#  Benchmark test script to compare execution times of</span>
<span class="c">#  numeric-indexed array vs. associative array.</span>
<span class="c">#     Thank you, Erik Brandsberg.</span>

<span class="nv">count</span><span class="o">=</span><span class="m">100000</span>       <span class="c"># May take a while for some of the tests below.</span>
<span class="nb">declare </span>simple     <span class="c"># Can change to 20000, if desired.</span>
<span class="nb">declare</span> -a array1
<span class="nb">declare</span> -A array2
<span class="nb">declare</span> -a array3
<span class="nb">declare</span> -A array4

<span class="nb">echo</span> <span class="s2">&quot;===Assignment tests===&quot;</span>
<span class="nb">echo</span>

<span class="nb">echo</span> <span class="s2">&quot;Assigning a simple variable:&quot;</span>
<span class="c"># References $i twice to equalize lookup times.</span>
<span class="nb">time </span><span class="k">for</span> <span class="o">((</span> <span class="nv">i</span><span class="o">=</span>0<span class="p">;</span> i&lt; <span class="nv">$count</span><span class="p">;</span> i++<span class="o">))</span><span class="p">;</span> <span class="k">do</span>
        <span class="nv">simple</span><span class="o">=</span><span class="nv">$i$i</span>
<span class="k">done</span>

<span class="nb">echo</span> <span class="s2">&quot;---&quot;</span>

<span class="nb">echo</span> <span class="s2">&quot;Assigning a numeric index array entry:&quot;</span>
<span class="nb">time </span><span class="k">for</span> <span class="o">((</span> <span class="nv">i</span><span class="o">=</span>0<span class="p">;</span> i&lt; <span class="nv">$count</span><span class="p">;</span> i++<span class="o">))</span><span class="p">;</span> <span class="k">do</span>
        array1<span class="o">[</span><span class="nv">$i</span><span class="o">]=</span><span class="nv">$i</span>
<span class="k">done</span>

<span class="nb">echo</span> <span class="s2">&quot;---&quot;</span>

<span class="nb">echo</span> <span class="s2">&quot;Overwriting a numeric index array entry:&quot;</span>
<span class="nb">time </span><span class="k">for</span> <span class="o">((</span> <span class="nv">i</span><span class="o">=</span>0<span class="p">;</span> i&lt; <span class="nv">$count</span><span class="p">;</span> i++<span class="o">))</span><span class="p">;</span> <span class="k">do</span>
        array1<span class="o">[</span><span class="nv">$i</span><span class="o">]=</span><span class="nv">$i</span>
<span class="k">done</span>

<span class="nb">echo</span> <span class="s2">&quot;---&quot;</span>

<span class="nb">echo</span> <span class="s2">&quot;Linear reading of numeric index array:&quot;</span>
<span class="nb">time </span><span class="k">for</span> <span class="o">((</span> <span class="nv">i</span><span class="o">=</span>0<span class="p">;</span> i&lt; <span class="nv">$count</span><span class="p">;</span> i++<span class="o">))</span><span class="p">;</span> <span class="k">do</span>
        <span class="nv">simple</span><span class="o">=</span>array1<span class="o">[</span><span class="nv">$i</span><span class="o">]</span>
<span class="k">done</span>

<span class="nb">echo</span> <span class="s2">&quot;---&quot;</span>

<span class="nb">echo</span> <span class="s2">&quot;Assigning an associative array entry:&quot;</span>
<span class="nb">time </span><span class="k">for</span> <span class="o">((</span> <span class="nv">i</span><span class="o">=</span>0<span class="p">;</span> i&lt; <span class="nv">$count</span><span class="p">;</span> i++<span class="o">))</span><span class="p">;</span> <span class="k">do</span>
        array2<span class="o">[</span><span class="nv">$i</span><span class="o">]=</span><span class="nv">$i</span>
<span class="k">done</span>

<span class="nb">echo</span> <span class="s2">&quot;---&quot;</span>

<span class="nb">echo</span> <span class="s2">&quot;Overwriting an associative array entry:&quot;</span>
<span class="nb">time </span><span class="k">for</span> <span class="o">((</span> <span class="nv">i</span><span class="o">=</span>0<span class="p">;</span> i&lt; <span class="nv">$count</span><span class="p">;</span> i++<span class="o">))</span><span class="p">;</span> <span class="k">do</span>
        array2<span class="o">[</span><span class="nv">$i</span><span class="o">]=</span><span class="nv">$i</span>
<span class="k">done</span>

<span class="nb">echo</span> <span class="s2">&quot;---&quot;</span>

<span class="nb">echo</span> <span class="s2">&quot;Linear reading an associative array entry:&quot;</span>
<span class="nb">time </span><span class="k">for</span> <span class="o">((</span> <span class="nv">i</span><span class="o">=</span>0<span class="p">;</span> i&lt; <span class="nv">$count</span><span class="p">;</span> i++<span class="o">))</span><span class="p">;</span> <span class="k">do</span>
        <span class="nv">simple</span><span class="o">=</span>array2<span class="o">[</span><span class="nv">$i</span><span class="o">]</span>
<span class="k">done</span>

<span class="nb">echo</span> <span class="s2">&quot;---&quot;</span>

<span class="nb">echo</span> <span class="s2">&quot;Assigning a random number to a simple variable:&quot;</span>
<span class="nb">time </span><span class="k">for</span> <span class="o">((</span> <span class="nv">i</span><span class="o">=</span>0<span class="p">;</span> i&lt; <span class="nv">$count</span><span class="p">;</span> i++<span class="o">))</span><span class="p">;</span> <span class="k">do</span>
        <span class="nv">simple</span><span class="o">=</span><span class="nv">$RANDOM</span>
<span class="k">done</span>

<span class="nb">echo</span> <span class="s2">&quot;---&quot;</span>

<span class="nb">echo</span> <span class="s2">&quot;Assign a sparse numeric index array entry randomly into 64k cells:&quot;</span>
<span class="nb">time </span><span class="k">for</span> <span class="o">((</span> <span class="nv">i</span><span class="o">=</span>0<span class="p">;</span> i&lt; <span class="nv">$count</span><span class="p">;</span> i++<span class="o">))</span><span class="p">;</span> <span class="k">do</span>
        array3<span class="o">[</span><span class="nv">$RANDOM</span><span class="o">]=</span><span class="nv">$i</span>
<span class="k">done</span>

<span class="nb">echo</span> <span class="s2">&quot;---&quot;</span>

<span class="nb">echo</span> <span class="s2">&quot;Reading sparse numeric index array entry:&quot;</span>
<span class="nb">time </span><span class="k">for</span> value in <span class="s2">&quot;</span><span class="si">${</span><span class="nv">array3</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span>i<span class="p">;</span> <span class="k">do</span>
        <span class="nv">simple</span><span class="o">=</span><span class="nv">$value</span>
<span class="k">done</span>

<span class="nb">echo</span> <span class="s2">&quot;---&quot;</span>

<span class="nb">echo</span> <span class="s2">&quot;Assigning a sparse associative array entry randomly into 64k cells:&quot;</span>
<span class="nb">time </span><span class="k">for</span> <span class="o">((</span> <span class="nv">i</span><span class="o">=</span>0<span class="p">;</span> i&lt; <span class="nv">$count</span><span class="p">;</span> i++<span class="o">))</span><span class="p">;</span> <span class="k">do</span>
        array4<span class="o">[</span><span class="nv">$RANDOM</span><span class="o">]=</span><span class="nv">$i</span>
<span class="k">done</span>

<span class="nb">echo</span> <span class="s2">&quot;---&quot;</span>

<span class="nb">echo</span> <span class="s2">&quot;Reading sparse associative index array entry:&quot;</span>
<span class="nb">time </span><span class="k">for</span> value in <span class="s2">&quot;</span><span class="si">${</span><span class="nv">array4</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span> <span class="k">do</span>
        <span class="nv">simple</span><span class="o">=</span><span class="nv">$value</span>
<span class="k">done</span>

<span class="nb">exit</span> <span class="nv">$?</span>
</pre></div>
</div>
</div>
</div>


          </div>
          <footer>
  <hr/>

  

  <div role="contentinfo">
    <p>
    </p>
  </div>
      Pàgina generada amb <a href="http://sphinx-doc.org/">Sphinx</a> amb una lleugera
                                     variació del tema<a
                                     href="https://github.com/snide/sphinx_rtd_theme">
                                         sphinx-rtd-theme </a>.

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'10 març de 2014',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>
      <script type="text/javascript" src="_static/translations.js"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>